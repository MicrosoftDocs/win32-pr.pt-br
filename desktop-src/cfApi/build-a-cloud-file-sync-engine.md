---
description: Saiba como criar um mecanismo de sincronização de arquivos de nuvem que usa arquivos de espaço reservado usando a API de arquivos de nuvem.
title: Criar um mecanismo de sincronização de nuvem que dê suporte a arquivos de espaço reservado
ms.topic: article
ms.date: 11/12/2020
ms.openlocfilehash: 4f1330285d0c8ef0359639f2be84162f8bc2ef3b
ms.sourcegitcommit: 3bdf30edb314e0fcd17dc4ddbc70e4ec7d3596e6
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 02/10/2021
ms.locfileid: "104557186"
---
# <a name="build-a-cloud-sync-engine-that-supports-placeholder-files"></a><span data-ttu-id="bef5a-103">Criar um mecanismo de sincronização de nuvem que dê suporte a arquivos de espaço reservado</span><span class="sxs-lookup"><span data-stu-id="bef5a-103">Build a Cloud Sync Engine that Supports Placeholder Files</span></span>

<span data-ttu-id="bef5a-104">Um mecanismo de sincronização é um serviço que sincroniza arquivos, normalmente entre um host remoto e um cliente local.</span><span class="sxs-lookup"><span data-stu-id="bef5a-104">A sync engine is a service that syncs files, typically between a remote host and a local client.</span></span> <span data-ttu-id="bef5a-105">Os mecanismos de sincronização no Windows geralmente apresentam esses arquivos ao usuário por meio do sistema de arquivos do Windows e do explorador de arquivos.</span><span class="sxs-lookup"><span data-stu-id="bef5a-105">Sync engines on Windows often present those files to the user through the Windows file system and File Explorer.</span></span> <span data-ttu-id="bef5a-106">Antes do Windows 10, versão 1709, o suporte ao mecanismo de sincronização no Windows era limitado a superfícies ad hoc independentes de cenário, como o painel de navegação do explorador de arquivos, a bandeja do sistema do Windows e (para aplicativos mais técnicos) drivers de filtro do sistema de arquivos.</span><span class="sxs-lookup"><span data-stu-id="bef5a-106">Before Windows 10, version 1709, sync engine support in Windows was limited to scenario-agnostic ad-hoc surfaces, such as File Explorer’s navigation pane, the Windows system tray, and (for more technical applications) file system filter drivers.</span></span>

<span data-ttu-id="bef5a-107">O Windows 10 versão 1709 (também chamado de atualização de criadores de outono) introduziu a *API de arquivos de nuvem*.</span><span class="sxs-lookup"><span data-stu-id="bef5a-107">Windows 10 version 1709 (also called the Fall Creators Update) introduced the *cloud files API*.</span></span> <span data-ttu-id="bef5a-108">Essa API é uma nova plataforma que formalizes o suporte a mecanismos de sincronização.</span><span class="sxs-lookup"><span data-stu-id="bef5a-108">This API is a new platform that formalizes support for sync engines.</span></span> <span data-ttu-id="bef5a-109">A API de arquivos de nuvem fornece suporte para mecanismos de sincronização de uma maneira que oferece muitos benefícios novos para desenvolvedores e usuários finais.</span><span class="sxs-lookup"><span data-stu-id="bef5a-109">The cloud files API provides support for sync engines in a way that offers many new benefits to developers and end users.</span></span>

<span data-ttu-id="bef5a-110">A API de arquivos de nuvem contém as seguintes APIs nativas do Win32 e as APIs do Windows Runtime (WinRT):</span><span class="sxs-lookup"><span data-stu-id="bef5a-110">The cloud files API contains the following native Win32 APIs and Windows Runtime (WinRT) APIs:</span></span>

* <span data-ttu-id="bef5a-111">[API de filtro de nuvem](cloud-filter-reference.md): essa API Win32 nativa fornece a funcionalidade no limite entre o modo de usuário e o sistema de arquivos.</span><span class="sxs-lookup"><span data-stu-id="bef5a-111">[Cloud Filter API](cloud-filter-reference.md): This native Win32 API provides functionality at the boundary between the user mode and the file system.</span></span> <span data-ttu-id="bef5a-112">Essa API manipula a criação e o gerenciamento de diretórios e arquivos de espaço reservado.</span><span class="sxs-lookup"><span data-stu-id="bef5a-112">This API handles the creation and management of placeholder files and directories.</span></span>
* <span data-ttu-id="bef5a-113">[Namespace do Windows. Storage. Provider](/uwp/api/windows.storage.provider): essa API do WinRT permite que os aplicativos configurem o provedor de armazenamento em nuvem e registrem a raiz de sincronização com o sistema operacional.</span><span class="sxs-lookup"><span data-stu-id="bef5a-113">[Windows.Storage.Provider namespace](/uwp/api/windows.storage.provider): This WinRT API enables applications to configure the cloud storage provider and register the sync root with the operating system.</span></span>

> [!NOTE]
> <span data-ttu-id="bef5a-114">Atualmente, a API de arquivos de nuvem não dá suporte à implementação de mecanismos de sincronização de nuvem em aplicativos UWP.</span><span class="sxs-lookup"><span data-stu-id="bef5a-114">The cloud files API does not currently support implementing cloud sync engines in UWP apps.</span></span> <span data-ttu-id="bef5a-115">Os mecanismos de sincronização de nuvem devem ser implementados em aplicativos da área de trabalho.</span><span class="sxs-lookup"><span data-stu-id="bef5a-115">Cloud sync engines must be implemented in desktop apps.</span></span>

## <a name="supported-features"></a><span data-ttu-id="bef5a-116">Recursos compatíveis</span><span class="sxs-lookup"><span data-stu-id="bef5a-116">Supported features</span></span>

<span data-ttu-id="bef5a-117">A API de arquivos de nuvem fornece os seguintes recursos para a criação de mecanismos de sincronização de nuvem.</span><span class="sxs-lookup"><span data-stu-id="bef5a-117">The cloud files API provides the following features for building cloud sync engines.</span></span>

### <a name="placeholder-files"></a><span data-ttu-id="bef5a-118">Arquivos de espaço reservado</span><span class="sxs-lookup"><span data-stu-id="bef5a-118">Placeholder files</span></span>

* <span data-ttu-id="bef5a-119">Os mecanismos de sincronização podem criar arquivos de espaço reservado que consomem apenas 1 KB de armazenamento para o cabeçalho do sistema de arquivos e que hidratar automaticamente em arquivos completos em condições de uso normal.</span><span class="sxs-lookup"><span data-stu-id="bef5a-119">Sync engines can create placeholder files that consume only 1 KB of storage for the filesystem header, and that automatically hydrate into full files under normal use conditions.</span></span> <span data-ttu-id="bef5a-120">Os arquivos de espaço reservado apresentam arquivos típicos para aplicativos e usuários finais no Shell do Windows.</span><span class="sxs-lookup"><span data-stu-id="bef5a-120">Placeholder files present as typical files to apps and to end users in the Windows Shell.</span></span>
* <span data-ttu-id="bef5a-121">Os arquivos de espaço reservado são integrados verticalmente do kernel do Windows até o Shell do Windows, e a compatibilidade de aplicativos com arquivos de espaço reservado geralmente não é um problema.</span><span class="sxs-lookup"><span data-stu-id="bef5a-121">Placeholder files are vertically integrated from the Windows kernel up to the Windows Shell, and app compatibility with placeholder files is generally a non-issue.</span></span> <span data-ttu-id="bef5a-122">Se você usar APIs do sistema de arquivos, o prompt de comando ou um aplicativo da área de trabalho ou UWP para acessar um arquivo de espaço reservado, o arquivo será hidratar sem alterações de código adicionais e esse aplicativo poderá usar o arquivo normalmente.</span><span class="sxs-lookup"><span data-stu-id="bef5a-122">Whether you use file system APIs, the Command Prompt, or a desktop or a UWP app to access a placeholder file, the file will hydrate without additional code changes and that app can use the file normally.</span></span>
* <span data-ttu-id="bef5a-123">Os arquivos podem existir em três Estados:</span><span class="sxs-lookup"><span data-stu-id="bef5a-123">Files can exist in three states:</span></span>
  * <span data-ttu-id="bef5a-124">**Arquivo de espaço reservado**: uma representação vazia do arquivo e estará disponível somente se o serviço de sincronização estiver disponível.</span><span class="sxs-lookup"><span data-stu-id="bef5a-124">**Placeholder file**: An empty representation of the file and only available if the sync service is available.</span></span>
  * <span data-ttu-id="bef5a-125">**Arquivo completo**: o arquivo foi alimentado implicitamente e poderia ser dealimentado pelo sistema se for necessário espaço.</span><span class="sxs-lookup"><span data-stu-id="bef5a-125">**Full file**: The file has been hydrated implicitly and could be dehydrated by the system if space is needed.</span></span>
  * <span data-ttu-id="bef5a-126">**Arquivo completo fixado**: o arquivo foi alimentado explicitamente pelo usuário por meio do explorador de arquivos e tem a garantia de estar disponível offline.</span><span class="sxs-lookup"><span data-stu-id="bef5a-126">**Pinned full file**: The file has been hydrated explicitly by the user through File Explorer and is guaranteed to be available offline.</span></span>

<span data-ttu-id="bef5a-127">A imagem a seguir demonstra como os Estados de arquivo completo de espaço reservado, completo e fixado são mostrados no explorador de arquivos.</span><span class="sxs-lookup"><span data-stu-id="bef5a-127">The following image demonstrates how the placeholder, full, and pinned full file states are shown in File Explorer.</span></span>

  ![Exemplo de três Estados de arquivo no explorador de arquivos](images/cloud-file-states-file-explorer.png)

### <a name="standardized-sync-root-registration"></a><span data-ttu-id="bef5a-129">Registro de raiz de sincronização padronizado</span><span class="sxs-lookup"><span data-stu-id="bef5a-129">Standardized sync root registration</span></span>

* <span data-ttu-id="bef5a-130">O registro de uma raiz de sincronização é simples e padronizado.</span><span class="sxs-lookup"><span data-stu-id="bef5a-130">Registering a sync root is straightforward and standardized.</span></span> <span data-ttu-id="bef5a-131">Isso inclui a criação de um nó com marca no painel de navegação do explorador de arquivos, conforme mostrado na captura de tela a seguir.</span><span class="sxs-lookup"><span data-stu-id="bef5a-131">This includes creation of a branded node in the navigation pane of File Explorer, as shown in the following screenshot.</span></span> <span data-ttu-id="bef5a-132">As raízes podem ser criadas como entradas individuais de nível superior ou como filhos de um agrupamento pai.</span><span class="sxs-lookup"><span data-stu-id="bef5a-132">Roots can be created either as individual top-level entries, or as children of a parent grouping.</span></span>

  ![Exemplo de uma entrada de raiz de sincronização no explorador de arquivos](images/register-sync-root-file-explorer.png)

### <a name="shell-integration"></a><span data-ttu-id="bef5a-134">Integração com o Shell</span><span class="sxs-lookup"><span data-stu-id="bef5a-134">Shell integration</span></span>

* <span data-ttu-id="bef5a-135">Ícones de Estado:</span><span class="sxs-lookup"><span data-stu-id="bef5a-135">State icons:</span></span>
  * <span data-ttu-id="bef5a-136">A API de arquivos de nuvem fornece ícones de estado de hidratação padronizados e automáticos mostrados no explorador de arquivos e na área de trabalho do Windows.</span><span class="sxs-lookup"><span data-stu-id="bef5a-136">The cloud files API provides standardized, automatic hydration state icons shown in File Explorer and on the Windows desktop.</span></span>
  * <span data-ttu-id="bef5a-137">Além dos ícones de estado padrão do Windows usados para o estado hidratação, você pode fornecer ícones de estado personalizado para propriedades adicionais específicas do serviço.</span><span class="sxs-lookup"><span data-stu-id="bef5a-137">In addition to the standard Windows state icons used for hydration state, you can provide custom state icons for additional service-specific properties.</span></span>
  * <span data-ttu-id="bef5a-138">Substitui as extensões do Shell de sobreposição de ícone herdado.</span><span class="sxs-lookup"><span data-stu-id="bef5a-138">Replaces legacy icon overlay Shell extensions.</span></span>
* <span data-ttu-id="bef5a-139">Indicação de progresso:</span><span class="sxs-lookup"><span data-stu-id="bef5a-139">Progress indication:</span></span>
  * <span data-ttu-id="bef5a-140">Abrir um arquivo de espaço reservado que leva mais de alguns segundos para hidratar mostrará o hidratação Progress.</span><span class="sxs-lookup"><span data-stu-id="bef5a-140">Opening a placeholder file that takes more than a few seconds to hydrate will show hydration progress.</span></span> <span data-ttu-id="bef5a-141">O andamento é mostrado em alguns locais, dependendo do contexto:</span><span class="sxs-lookup"><span data-stu-id="bef5a-141">Progress is shown in a few locations depending on context:</span></span>
    * <span data-ttu-id="bef5a-142">Em uma janela de diálogo do mecanismo de cópia.</span><span class="sxs-lookup"><span data-stu-id="bef5a-142">In a copy engine dialog window.</span></span>
    * <span data-ttu-id="bef5a-143">O andamento em linha é mostrado ao lado do arquivo no explorador de arquivos.</span><span class="sxs-lookup"><span data-stu-id="bef5a-143">Inline progress is shown next to the file in File Explorer.</span></span>
    * <span data-ttu-id="bef5a-144">Se o arquivo não estiver aberto na instrução específica do usuário, uma notificação do sistema será mostrada para informar o usuário e fornecer uma maneira de controlar a atividade de hidratação indesejada.</span><span class="sxs-lookup"><span data-stu-id="bef5a-144">If the file is not opened at the user’s specific instruction, a toast notification is shown to inform the user and provide a way to control unintended hydration activity.</span></span>
* <span data-ttu-id="bef5a-145">Miniaturas e metadados:</span><span class="sxs-lookup"><span data-stu-id="bef5a-145">Thumbnails and metadata:</span></span>
  * <span data-ttu-id="bef5a-146">Os arquivos de espaço reservado podem ter miniaturas avançadas fornecidas pelo serviço e metadados de arquivo estendidos para fornecer ao usuário uma experiência de Gerenciador de arquivos sem interrupções.</span><span class="sxs-lookup"><span data-stu-id="bef5a-146">Placeholder files can have rich service-provided thumbnails and extended file metadata to provide the user with a seamless File Explorer experience.</span></span>
* <span data-ttu-id="bef5a-147">Painel de navegação do explorador de arquivos:</span><span class="sxs-lookup"><span data-stu-id="bef5a-147">File Explorer navigation pane:</span></span>
  * <span data-ttu-id="bef5a-148">O registro de uma raiz de sincronização com a API de arquivos de nuvem faz com que a raiz de sincronização (com um ícone e um nome personalizado) apareça no painel de navegação do explorador de arquivos.</span><span class="sxs-lookup"><span data-stu-id="bef5a-148">Registering a sync root with the cloud files API causes that sync root (with an icon and custom name) to appear in File Explorer’s navigation pane.</span></span>
* <span data-ttu-id="bef5a-149">Menus de contexto do explorador de arquivos:</span><span class="sxs-lookup"><span data-stu-id="bef5a-149">File Explorer context menus:</span></span>
  * <span data-ttu-id="bef5a-150">O registro de uma raiz de sincronização com a API de arquivos de nuvem fornece automaticamente vários verbos (entradas de menu) no menu de contexto do explorador de arquivos que permite ao usuário controlar o estado hidratação de seu arquivo.</span><span class="sxs-lookup"><span data-stu-id="bef5a-150">Registering a sync root with the cloud files API automatically provides several verbs (menu entries) in File Explorer’s context menu that let the user control the hydration state of their file.</span></span>
  * <span data-ttu-id="bef5a-151">Verbos adicionais podem ser adicionados a esta seção do menu de contexto usando APIs compatíveis com a ponte de desktop.</span><span class="sxs-lookup"><span data-stu-id="bef5a-151">Additional verbs can be added to this section of the context menu using Desktop Bridge-compatible APIs.</span></span>
* <span data-ttu-id="bef5a-152">Controle de usuário do arquivo hidratação:</span><span class="sxs-lookup"><span data-stu-id="bef5a-152">User control of file hydration:</span></span>
  * <span data-ttu-id="bef5a-153">Os usuários estão sempre no controle do arquivo hidratação, mesmo quando os arquivos não são alimentados explicitamente pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="bef5a-153">Users are always in control of file hydration, even when the files are not hydrated explicitly by the user.</span></span> <span data-ttu-id="bef5a-154">Um sistema de notificação interativo é mostrado para hidratação em segundo plano para alertar o usuário e fornecer opções.</span><span class="sxs-lookup"><span data-stu-id="bef5a-154">An interactive toast is shown for background hydration to alert the user and provide options.</span></span> <span data-ttu-id="bef5a-155">A imagem a seguir demonstra uma notificação do sistema para um arquivo HYDRATING.</span><span class="sxs-lookup"><span data-stu-id="bef5a-155">The following image demonstrates a toast notification for a hydrating file.</span></span>
    <span data-ttu-id="bef5a-156">![Exemplo de um sistema de notificação interativo mostrado para o arquivo de segundo plano hidratação](images/file-hydration-interactive-toast.png)</span><span class="sxs-lookup"><span data-stu-id="bef5a-156">![Example of an interactive toast shown for background file hydration](images/file-hydration-interactive-toast.png)</span></span>
  * <span data-ttu-id="bef5a-157">Se um usuário bloquear um aplicativo de arquivos HYDRATING por meio de um sistema de notificação interativo, ele poderá desbloquear o aplicativo na página de **downloads de arquivo automático** em **configurações**.</span><span class="sxs-lookup"><span data-stu-id="bef5a-157">If a user blocks an app from hydrating files through an interactive toast, they can unblock the app in the **Automatic file downloads** page in **Settings**.</span></span>
    <span data-ttu-id="bef5a-158">![Captura de tela da configuração de downloads de arquivo automático](images/allow-automatic-file-downloads-setting.png)</span><span class="sxs-lookup"><span data-stu-id="bef5a-158">![Screenshot of the automatic file downloads setting](images/allow-automatic-file-downloads-setting.png)</span></span>
* <span data-ttu-id="bef5a-159">Conectando operações do mecanismo de cópia (com suporte no Windows 10 Insider Preview versão 19624 e versões posteriores):</span><span class="sxs-lookup"><span data-stu-id="bef5a-159">Hooking copy engine operations (supported in Windows 10 Insider Preview Build 19624 and later versions):</span></span>
  * <span data-ttu-id="bef5a-160">Os provedores de armazenamento em nuvem podem registrar um gancho de cópia do Shell para monitorar operações de arquivo em sua raiz de sincronização.</span><span class="sxs-lookup"><span data-stu-id="bef5a-160">Cloud storage providers can register a shell copy hook for monitoring file operations within their sync root.</span></span>
  * <span data-ttu-id="bef5a-161">O provedor registra seu gancho de cópia definindo o valor do registro **CopyHook** sob sua chave de registro raiz de sincronização para um CLSID de seu objeto de servidor local com.</span><span class="sxs-lookup"><span data-stu-id="bef5a-161">The provider registers their copy hook by setting the **CopyHook** registry value under their sync root registry key to a the CLSID of their COM local server object.</span></span> <span data-ttu-id="bef5a-162">Esse objeto de servidor local implementa a interface [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) .</span><span class="sxs-lookup"><span data-stu-id="bef5a-162">This local server object implements the [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) interface.</span></span>

### <a name="desktop-bridge"></a><span data-ttu-id="bef5a-163">Ponte de Desktop</span><span class="sxs-lookup"><span data-stu-id="bef5a-163">Desktop Bridge</span></span>

* <span data-ttu-id="bef5a-164">Os mecanismos de sincronização usando as APIs de arquivos de nuvem são projetados para usar a [ponte de desktop](/windows/uwp/porting/desktop-to-uwp-root) como um requisito de implementação.</span><span class="sxs-lookup"><span data-stu-id="bef5a-164">Sync engines using the cloud files APIs are designed to use the [Desktop Bridge](/windows/uwp/porting/desktop-to-uwp-root) as an implementation requirement.</span></span>

## <a name="cloud-mirror-sample"></a><span data-ttu-id="bef5a-165">Exemplo de espelho de nuvem</span><span class="sxs-lookup"><span data-stu-id="bef5a-165">Cloud Mirror sample</span></span>

<span data-ttu-id="bef5a-166">O [exemplo de espelho de nuvem](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) ilustra como criar uma solução que usa a API de arquivos de nuvem.</span><span class="sxs-lookup"><span data-stu-id="bef5a-166">The [Cloud Mirror sample](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) illustrates how to build a solution that uses the cloud files API.</span></span> <span data-ttu-id="bef5a-167">Ele não se destina a ser usado como código de produção.</span><span class="sxs-lookup"><span data-stu-id="bef5a-167">It is not intended to be used as production code.</span></span> <span data-ttu-id="bef5a-168">Ele não tem um tratamento de erros robusto e é escrito para ser o mais facilmente compreendido possível.</span><span class="sxs-lookup"><span data-stu-id="bef5a-168">It lacks robust error handling and it is written to be as easily understood as possible.</span></span> <span data-ttu-id="bef5a-169">Ele é chamado de espelho de nuvem porque simplesmente espelha uma pasta local em seu disco local.</span><span class="sxs-lookup"><span data-stu-id="bef5a-169">It's called Cloud Mirror because it simply mirrors a local folder on your local disk.</span></span> <span data-ttu-id="bef5a-170">Você especifica uma pasta de servidor que deve representar o servidor de arquivos de nuvem e uma pasta de cliente que é destinada a especificar o caminho raiz de sincronização.</span><span class="sxs-lookup"><span data-stu-id="bef5a-170">You specify a server folder that is meant to represent your cloud file server and a client folder that is meant to specify the sync root path.</span></span> <span data-ttu-id="bef5a-171">Um nó de nível superior aparece no painel de navegação no explorador de arquivos chamado **TestStorageProviderDisplayName**, e esse nó é mapeado para a pasta de cliente especificada.</span><span class="sxs-lookup"><span data-stu-id="bef5a-171">A top-level node appears in the navigation pane in File Explorer called **TestStorageProviderDisplayName**, and this node maps to the specified client folder.</span></span>

<span data-ttu-id="bef5a-172">Quando se trata de sincronização, essas são as coisas que um provedor de sincronização de arquivos de nuvem totalmente desenvolvido deve implementar:</span><span class="sxs-lookup"><span data-stu-id="bef5a-172">When it comes to syncing, these are the things that a fully-developed cloud files sync provider must implement:</span></span>

* <span data-ttu-id="bef5a-173">Quando o arquivo raiz de sincronização é apenas um espaço reservado, o serviço é responsável por copiar o conteúdo do arquivo para hidratação.</span><span class="sxs-lookup"><span data-stu-id="bef5a-173">When the sync root file is just a placeholder, the service is responsible for copying down the contents of the file for hydration.</span></span> <span data-ttu-id="bef5a-174">Isso é implementado no exemplo.</span><span class="sxs-lookup"><span data-stu-id="bef5a-174">This is implemented in the sample.</span></span>
* <span data-ttu-id="bef5a-175">Quando o arquivo raiz de sincronização é um arquivo completo e o conteúdo do arquivo no serviço de nuvem é alterado, o serviço é responsável por notificar o cliente de sincronização local da alteração e o cliente de sincronização local deve lidar com as mesclagens de acordo com suas próprias especificações.</span><span class="sxs-lookup"><span data-stu-id="bef5a-175">When the sync root file is a full file and the contents of the file in the cloud service change, the service is responsible of notifying the local sync client of the change and the local sync client must handle merges according to their own specifications.</span></span> <span data-ttu-id="bef5a-176">Isso não é implementado no exemplo.</span><span class="sxs-lookup"><span data-stu-id="bef5a-176">This is not implemented in the sample.</span></span>
* <span data-ttu-id="bef5a-177">Quando o arquivo raiz de sincronização é um arquivo completo e o conteúdo do arquivo no caminho raiz de sincronização (o cliente local) é alterado, o cliente de sincronização local deve notificar o serviço de nuvem e lidar com as mesclagens de acordo com suas próprias especificações.</span><span class="sxs-lookup"><span data-stu-id="bef5a-177">When the sync root file is a full file and the contents of the file in the sync root path (the local client) change, the local sync client must notify the cloud service and handle merges according to their own specifications.</span></span> <span data-ttu-id="bef5a-178">A notificação de alteração de arquivo local é implementada no exemplo, mas não faz nada.</span><span class="sxs-lookup"><span data-stu-id="bef5a-178">The local file change notification is implemented in the sample, but it does not do anything.</span></span>

### <a name="use-the-sample"></a><span data-ttu-id="bef5a-179">Usar o exemplo</span><span class="sxs-lookup"><span data-stu-id="bef5a-179">Use the sample</span></span>

1. <span data-ttu-id="bef5a-180">Crie duas pastas na unidade de disco rígido local.</span><span class="sxs-lookup"><span data-stu-id="bef5a-180">Create two folders on your local hard drive.</span></span> <span data-ttu-id="bef5a-181">Um deles funcionará como o servidor e o outro como o cliente.</span><span class="sxs-lookup"><span data-stu-id="bef5a-181">One of them will act as the server and the other as the client.</span></span>
2. <span data-ttu-id="bef5a-182">Adicione alguns arquivos à pasta do servidor.</span><span class="sxs-lookup"><span data-stu-id="bef5a-182">Add some files to the server folder.</span></span> <span data-ttu-id="bef5a-183">Verifique se a pasta do cliente está vazia.</span><span class="sxs-lookup"><span data-stu-id="bef5a-183">Make sure the client folder is empty.</span></span>
3. <span data-ttu-id="bef5a-184">Abra o exemplo de espelho de nuvem no Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="bef5a-184">Open the Cloud Mirror sample in Visual Studio.</span></span> <span data-ttu-id="bef5a-185">Defina o projeto **CloudMirrorPackage** como seu projeto de inicialização e, em seguida, compile e execute o exemplo.</span><span class="sxs-lookup"><span data-stu-id="bef5a-185">Set the **CloudMirrorPackage** project as your startup project and then build and run the sample.</span></span> <span data-ttu-id="bef5a-186">Quando solicitado pelo exemplo, insira os dois caminhos para as pastas servidor e cliente.</span><span class="sxs-lookup"><span data-stu-id="bef5a-186">When prompted by the sample, enter the two paths to your server and client folders.</span></span> <span data-ttu-id="bef5a-187">Depois disso, você verá uma janela do console com informações de diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="bef5a-187">After this you will see a console window with diagnostic information.</span></span>
4. <span data-ttu-id="bef5a-188">Abra o explorador de arquivos e confirme se você vê o nó **TestStorageProviderDisplayName** e os espaços reservados para todos os arquivos que você copiou para a pasta do servidor.</span><span class="sxs-lookup"><span data-stu-id="bef5a-188">Open File Explorer and confirm that you see the **TestStorageProviderDisplayName** node and the placeholders for all the files that you copied into the server folder.</span></span> <span data-ttu-id="bef5a-189">Para simular um aplicativo que tenta abrir arquivos sem usar o seletor, copie várias imagens para a pasta do servidor.</span><span class="sxs-lookup"><span data-stu-id="bef5a-189">To simulate an application that tries to open files without using the picker, copy several images to the server folder.</span></span> <span data-ttu-id="bef5a-190">Clique duas vezes em um deles na pasta raiz de sincronização e confirme se ele hidratam.</span><span class="sxs-lookup"><span data-stu-id="bef5a-190">Double-click one of them in your sync root folder and confirm that it hydrates.</span></span> <span data-ttu-id="bef5a-191">Em seguida, abra o aplicativo fotos.</span><span class="sxs-lookup"><span data-stu-id="bef5a-191">Then, open the Photos app.</span></span> <span data-ttu-id="bef5a-192">O aplicativo carregará previamente os arquivos adjacentes em segundo plano para torná-lo mais provável que o usuário não experimente atrasos ao examinar as outras imagens.</span><span class="sxs-lookup"><span data-stu-id="bef5a-192">The app will pre-load adjacent files in the background to make it more likely the user does not experience delays when looking through the other pictures.</span></span> <span data-ttu-id="bef5a-193">Você pode observar que o DEHYDRATION de fundo acontece por meio de torradeiras ou no explorador de arquivos.</span><span class="sxs-lookup"><span data-stu-id="bef5a-193">You can observe the background dehydration happen via toasts or in File Explorer.</span></span>
5. <span data-ttu-id="bef5a-194">Clique com o botão direito do mouse em um arquivo no explorador de arquivos para abrir um menu de contexto e confirme que você vê o item de menu **TestCommand** .</span><span class="sxs-lookup"><span data-stu-id="bef5a-194">Right-click a file in File Explorer to bring up a context menu, and confirm that you see the **TestCommand** menu item.</span></span> <span data-ttu-id="bef5a-195">Clicar nesse item de menu exibirá uma caixa de mensagem.</span><span class="sxs-lookup"><span data-stu-id="bef5a-195">Clicking this menu item will display a message box.</span></span>
6. <span data-ttu-id="bef5a-196">Para parar o exemplo, defina foco para a saída do console e pressione **Ctrl-C**.</span><span class="sxs-lookup"><span data-stu-id="bef5a-196">To stop the sample, set focus to the console output and press **Ctrl-C**.</span></span> <span data-ttu-id="bef5a-197">Isso limpará o registro de raiz de sincronização para que o provedor seja desinstalado.</span><span class="sxs-lookup"><span data-stu-id="bef5a-197">This will cleanup the sync root registration so that the provider is uninstalled.</span></span> <span data-ttu-id="bef5a-198">Se o exemplo falhar, será possível que a raiz de sincronização permaneça registrada.</span><span class="sxs-lookup"><span data-stu-id="bef5a-198">If the sample crashes, it’s possible that the sync root will remain registered.</span></span> <span data-ttu-id="bef5a-199">Isso fará com que o explorador de arquivos seja reiniciado sempre que você clicar em qualquer coisa, e você receberá uma solicitação para os locais falsos do cliente e do servidor.</span><span class="sxs-lookup"><span data-stu-id="bef5a-199">This will cause File Explorer to relaunch every time you click on anything, and you would get prompted for the fake client and server locations.</span></span> <span data-ttu-id="bef5a-200">Se isso ocorrer, desinstale o aplicativo de exemplo **CloudMirrorPackage** do seu computador.</span><span class="sxs-lookup"><span data-stu-id="bef5a-200">If this occurs, uninstall the **CloudMirrorPackage** sample application from your computer.</span></span>

### <a name="sample-architecture"></a><span data-ttu-id="bef5a-201">Arquitetura de exemplo</span><span class="sxs-lookup"><span data-stu-id="bef5a-201">Sample architecture</span></span>

<span data-ttu-id="bef5a-202">O exemplo é deliberadamente simples.</span><span class="sxs-lookup"><span data-stu-id="bef5a-202">The sample is deliberately simple.</span></span> <span data-ttu-id="bef5a-203">Ele usa classes estáticas para torná-la desnecessária para passar ponteiros de instância.</span><span class="sxs-lookup"><span data-stu-id="bef5a-203">It uses static classes to make it unnecessary to pass instance pointers.</span></span> <span data-ttu-id="bef5a-204">Aqui estão as principais classes no exemplo:</span><span class="sxs-lookup"><span data-stu-id="bef5a-204">Here are the main classes in the sample:</span></span>

* <span data-ttu-id="bef5a-205">**FakeCloudProvider**: essa classe de nível superior controla as seguintes classes de trabalho:</span><span class="sxs-lookup"><span data-stu-id="bef5a-205">**FakeCloudProvider**: This top-level class controls the following worker classes:</span></span>
  * <span data-ttu-id="bef5a-206">**CloudProviderRegistrar**: registra as informações de raiz de sincronização com o Shell do Windows.</span><span class="sxs-lookup"><span data-stu-id="bef5a-206">**CloudProviderRegistrar**: Registers the sync root information with the Windows Shell.</span></span>
  * <span data-ttu-id="bef5a-207">**Espaços reservados**: gera os arquivos de espaço reservado no caminho raiz de sincronização.</span><span class="sxs-lookup"><span data-stu-id="bef5a-207">**Placeholders**: Generates the placeholder files in the sync root path.</span></span>
  * <span data-ttu-id="bef5a-208">**Shellservices**: constrói os provedores de shell do Windows para o menu de contexto, miniaturas e outros serviços.</span><span class="sxs-lookup"><span data-stu-id="bef5a-208">**ShellServices**: Constructs the Windows Shell providers for the context menu, thumbnails, and other services.</span></span>
  * <span data-ttu-id="bef5a-209">**CloudProviderSyncRootWatcher**: cria uma instância de um DirectoryWatcher para monitorar as alterações no caminho raiz da sincronização e agir em alterações.</span><span class="sxs-lookup"><span data-stu-id="bef5a-209">**CloudProviderSyncRootWatcher**: Instantiates a DirectoryWatcher to monitor changes to the sync root path and act on changes.</span></span>
  * <span data-ttu-id="bef5a-210">**FileCopierWithProgress**: copia os arquivos da pasta do servidor para a pasta do cliente lentamente em partes para simular o download deles de um servidor em nuvem real.</span><span class="sxs-lookup"><span data-stu-id="bef5a-210">**FileCopierWithProgress**: Copies files from the server folder to the client folder slowly in chunks to simulate downloading them from a real cloud server.</span></span> <span data-ttu-id="bef5a-211">Fornece a indicação de progresso para que as notificações e a interface do usuário do explorador de arquivos mostrem algo informativo.</span><span class="sxs-lookup"><span data-stu-id="bef5a-211">Provides progress indication so that toasts and File Explorer UI shows the user something informative.</span></span>

<span data-ttu-id="bef5a-212">Além das classes acima, o exemplo também fornece várias classes auxiliares para solicitar ao usuário pastas e alguns utilitários.</span><span class="sxs-lookup"><span data-stu-id="bef5a-212">In addition to the classes above, the sample also provides several helper classes to prompt the user for folders and some utilities.</span></span> <span data-ttu-id="bef5a-213">**TestExplorerCommandHandler**, **CustomStateProvider**, **thumbnailprovider** e **UriSource** são exemplos de provedores de serviço do Shell.</span><span class="sxs-lookup"><span data-stu-id="bef5a-213">The **TestExplorerCommandHandler**, **CustomStateProvider**, **ThumbnailProvider**, and **UriSource** are all examples of Shell service providers.</span></span>

## <a name="cloud-files-api-architecture"></a><span data-ttu-id="bef5a-214">Arquitetura de API de arquivos de nuvem</span><span class="sxs-lookup"><span data-stu-id="bef5a-214">Cloud files API architecture</span></span>

<span data-ttu-id="bef5a-215">No núcleo da pilha de armazenamento na API de arquivos de nuvem está um driver de minifiltro do sistema de arquivos chamado cldflt.sys.</span><span class="sxs-lookup"><span data-stu-id="bef5a-215">At the core of the storage stack in the cloud files API is a file system minifilter driver called cldflt.sys.</span></span> <span data-ttu-id="bef5a-216">Esse driver atua como um proxy entre os aplicativos do usuário e seu mecanismo de sincronização.</span><span class="sxs-lookup"><span data-stu-id="bef5a-216">This driver acts as a proxy between the user’s applications and your sync engine.</span></span> <span data-ttu-id="bef5a-217">Seu mecanismo de sincronização sabe como baixar e carregar os dados sob demanda, enquanto é responsabilidade de cldflt.sys trabalhar com o Shell para apresentar arquivos como se os dados de nuvem estivessem disponíveis localmente.</span><span class="sxs-lookup"><span data-stu-id="bef5a-217">Your sync engine knows how to download and upload the data on demand while it is responsibility of cldflt.sys to work with the Shell to present files as if the cloud data were locally available.</span></span>

<span data-ttu-id="bef5a-218">O Cldflt.sys atualmente dá suporte apenas a volumes NTFS, pois depende de alguns recursos exclusivos do NTFS.</span><span class="sxs-lookup"><span data-stu-id="bef5a-218">Cldflt.sys currently only supports NTFS volumes because it depends on some features unique to NTFS.</span></span>

<span data-ttu-id="bef5a-219">Há muitos drivers do minifiltro do sistema de arquivos em um sistema e eles podem estar ativos em um determinado volume ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="bef5a-219">There are many file system minifilter drivers in a system and they can be active on a given volume at the same time.</span></span> <span data-ttu-id="bef5a-220">Os drivers que são mais interessantes para a API de arquivos de nuvem são os filtros do sistema de arquivos antivírus.</span><span class="sxs-lookup"><span data-stu-id="bef5a-220">The drivers that are of most interest to the cloud files API are the anti-virus file system filters.</span></span>

<span data-ttu-id="bef5a-221">Os drivers do minifiltro do sistema de arquivos são gerenciados e têm suporte em um componente especial do modo kernel chamado Gerenciador de filtros.</span><span class="sxs-lookup"><span data-stu-id="bef5a-221">File system minifilter drivers are managed and supported by a special kernel-mode component called the filter manager.</span></span> <span data-ttu-id="bef5a-222">Entre muitas outras tarefas, o Gerenciador de filtros facilita a comunicação não filtrada entre filtros e componentes de modo de usuário por meio de uma construção conhecida como porta de mensagem de filtro.</span><span class="sxs-lookup"><span data-stu-id="bef5a-222">Among many other duties, the filter manager facilitates unfiltered communication between filters and user mode components via a construct known as filter message port.</span></span>

## <a name="hydration-policies"></a><span data-ttu-id="bef5a-223">Políticas de hidratação</span><span class="sxs-lookup"><span data-stu-id="bef5a-223">Hydration Policies</span></span>

<span data-ttu-id="bef5a-224">O Windows dá suporte a uma variedade de [políticas de hidratação primárias](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) e modificadores de [política de hidratação secundários](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) .</span><span class="sxs-lookup"><span data-stu-id="bef5a-224">Windows supports a variety of [primary hydration policies](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) and [secondary hydration policy](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) modifiers.</span></span> <span data-ttu-id="bef5a-225">As políticas de hidratação primárias têm esta ordem:</span><span class="sxs-lookup"><span data-stu-id="bef5a-225">Primary hydration policies have this order:</span></span>

  <span data-ttu-id="bef5a-226">**Sempre completo > completo > progressivo > parcial**</span><span class="sxs-lookup"><span data-stu-id="bef5a-226">**Always full > Full > Progressive > Partial**</span></span>

<span data-ttu-id="bef5a-227">Os aplicativos e os mecanismos de sincronização podem definir sua política de hidratação primária preferencial.</span><span class="sxs-lookup"><span data-stu-id="bef5a-227">Both applications and sync engines can define their preferred primary hydration policy.</span></span> <span data-ttu-id="bef5a-228">Se não for especificado, a política de hidratação padrão será progressiva para aplicativos e mecanismos de sincronização.</span><span class="sxs-lookup"><span data-stu-id="bef5a-228">If not specified, the default hydration policy is progressive for both applications and sync engines.</span></span>

<span data-ttu-id="bef5a-229">A política de hidratação de um arquivo de nuvem é determinada na hora de abertura do arquivo por esta fórmula:</span><span class="sxs-lookup"><span data-stu-id="bef5a-229">The hydration policy of a cloud file is determined at the file open time by this formula:</span></span>

  ```File hydration policy = max(app hydration policy, provider hydration policy)```

<span data-ttu-id="bef5a-230">Por exemplo, digamos que o usuário esteja tentando abrir um arquivo PDF armazenado na unidade de nuvem da Fabrikam usando o Visualizador de PDF da Contoso, que não especifica uma política de hidratação preferida.</span><span class="sxs-lookup"><span data-stu-id="bef5a-230">For example, let’s say the user is trying to open a PDF file stored on Fabrikam Cloud Drive using Contoso PDF Viewer, which doesn’t specify a preferred hydration policy.</span></span> <span data-ttu-id="bef5a-231">A política de hidratação de aplicativo é, portanto, hidratação progressiva, neste caso, por padrão.</span><span class="sxs-lookup"><span data-stu-id="bef5a-231">The application hydration policy is therefore progressive hydration, in this case by default.</span></span> <span data-ttu-id="bef5a-232">No entanto, como a unidade de nuvem da Fabrikam é um mecanismo de sincronização hidratação completo, a política de hidratação final no arquivo torna-se hidratação completa, o que fará com que o arquivo seja totalmente alimentado no primeiro acesso.</span><span class="sxs-lookup"><span data-stu-id="bef5a-232">However, because Fabrikam Cloud Drive is a full hydration sync engine, the final hydration policy on the file becomes full hydration, which will result in the file being fully hydrated on first access.</span></span> <span data-ttu-id="bef5a-233">O mesmo resultado ocorre nos casos em que o mecanismo de sincronização dá suporte a hidratação progressivos, mas a preferência do aplicativo é hidratação completa.</span><span class="sxs-lookup"><span data-stu-id="bef5a-233">The same outcome happens in cases where the sync engine supports progressive hydration, but the app’s preference is full hydration.</span></span>

<span data-ttu-id="bef5a-234">Observe que a política de hidratação de arquivo não pode ser alterada depois que o arquivo é aberto.</span><span class="sxs-lookup"><span data-stu-id="bef5a-234">Note that the file hydration policy cannot be changed after the file is opened.</span></span>

## <a name="compatibility-with-applications-that-use-reparse-points"></a><span data-ttu-id="bef5a-235">Compatibilidade com aplicativos que usam pontos de nova análise</span><span class="sxs-lookup"><span data-stu-id="bef5a-235">Compatibility with applications that use reparse points</span></span>

<span data-ttu-id="bef5a-236">A API de arquivos de nuvem implementa o sistema de espaço reservado usando [pontos de nova análise](/windows/desktop/FileIO/reparse-points).</span><span class="sxs-lookup"><span data-stu-id="bef5a-236">The cloud files API implements the placeholder system using [reparse points](/windows/desktop/FileIO/reparse-points).</span></span> <span data-ttu-id="bef5a-237">Um equívoco comum sobre pontos de nova análise é que eles são os mesmos links simbólicos.</span><span class="sxs-lookup"><span data-stu-id="bef5a-237">A common misconception about reparse points is that they are the same as symbolic links.</span></span> <span data-ttu-id="bef5a-238">Esse equívoco é ocasionalmente refletido em implementações de aplicativo e, como resultado, muitos aplicativos existentes têm erros de ocorrência ao encontrar qualquer ponto de nova análise.</span><span class="sxs-lookup"><span data-stu-id="bef5a-238">This misconception is occasionally reflected in application implementations, and as a result, many existing applications hit errors when encountering any reparse point.</span></span>

<span data-ttu-id="bef5a-239">Para atenuar esse problema de compatibilidade, a API de arquivos de nuvem sempre oculta seus pontos de nova análise de todos os aplicativos, exceto para mecanismos de sincronização e processos cuja imagem principal reside em **% systemroot%**.</span><span class="sxs-lookup"><span data-stu-id="bef5a-239">To mitigate this compatibility issue, the cloud files API always hides its reparse points from all applications except for sync engines and processes whose main image resides under **%systemroot%**.</span></span> <span data-ttu-id="bef5a-240">Os aplicativos que entendem os pontos de nova análise corretamente podem forçar a plataforma a expor os pontos de nova análise da API de arquivos de nuvem usando [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) ou [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span><span class="sxs-lookup"><span data-stu-id="bef5a-240">Applications that understand reparse points correctly can force the platform to expose cloud files API reparse points using [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) or [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span></span>