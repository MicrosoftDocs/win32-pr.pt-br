---
description: O Hyper-V usa o Serviço de Cópias de Sombra de Volume (VSS) para fazer backup e restaurar máquinas virtuais.
ms.assetid: 94C67F22-658D-49DD-9588-6BB4FCF7ADA9
title: Fazendo backup e restaurando máquinas virtuais
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6f9cf6d5b80a4c7392fb38e893a4fafad3f90435
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "105759886"
---
# <a name="backing-up-and-restoring-virtual-machines"></a><span data-ttu-id="3ad6c-103">Fazendo backup e restaurando máquinas virtuais</span><span class="sxs-lookup"><span data-stu-id="3ad6c-103">Backing up and restoring virtual machines</span></span>

<span data-ttu-id="3ad6c-104">O Hyper-V usa o Serviço de Cópias de Sombra de Volume (VSS) para fazer backup e restaurar máquinas virtuais.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-104">Hyper-V uses the Volume Shadow Copy Service (VSS) to backup and restore virtual machines.</span></span> <span data-ttu-id="3ad6c-105">Se os serviços de integração de backup (instantâneo de volume) estiverem instalados no sistema operacional convidado, um solicitante VSS será instalado que permitirá que gravadores VSS no sistema operacional convidado participem do backup da máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-105">If the backup (volume snapshot) integration services are installed in the guest operating system, a VSS requester is installed that will allow VSS writers in the guest operating system to participate in the backup of the virtual machine.</span></span> <span data-ttu-id="3ad6c-106">Para obter detalhes, consulte as seguintes seções:</span><span class="sxs-lookup"><span data-stu-id="3ad6c-106">For details, see the following sections:</span></span>

-   [<span data-ttu-id="3ad6c-107">Fazendo backup das máquinas virtuais</span><span class="sxs-lookup"><span data-stu-id="3ad6c-107">Backing up the virtual machines</span></span>](#backing-up-the-virtual-machines)
-   [<span data-ttu-id="3ad6c-108">Restaurando as máquinas virtuais</span><span class="sxs-lookup"><span data-stu-id="3ad6c-108">Restoring the virtual machines</span></span>](#restoring-the-virtual-machines)
-   [<span data-ttu-id="3ad6c-109">Clustering de failover e VSS do Hyper-V</span><span class="sxs-lookup"><span data-stu-id="3ad6c-109">Failover clustering and Hyper-V VSS</span></span>](#failover-clustering-and-hyper-v-vss)
-   [<span data-ttu-id="3ad6c-110">Detalhes sobre o gravador VSS do Hyper-V</span><span class="sxs-lookup"><span data-stu-id="3ad6c-110">Details on the Hyper-V VSS Writer</span></span>](#details-on-the-hyper-v-vss-writer)
-   [<span data-ttu-id="3ad6c-111">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="3ad6c-111">Related topics</span></span>](#related-topics)

## <a name="backing-up-the-virtual-machines"></a><span data-ttu-id="3ad6c-112">Fazendo backup das máquinas virtuais</span><span class="sxs-lookup"><span data-stu-id="3ad6c-112">Backing up the virtual machines</span></span>

<span data-ttu-id="3ad6c-113">O Hyper-V usa um dos dois mecanismos para fazer backup de cada máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-113">Hyper-V uses one of two mechanisms to back up each virtual machine.</span></span> <span data-ttu-id="3ad6c-114">O mecanismo de backup padrão é chamado de método "estado salvo", em que a máquina virtual é colocada em um estado salvo durante o processamento do evento PrepareForSnapshot, os instantâneos são tirados dos volumes apropriados e a máquina virtual é retornada ao estado anterior durante o processamento do evento de instantâneo.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-114">The default backup mechanism is called the "Saved State" method, where the virtual machine is put into a saved state during the processing of the PrepareForSnapshot event, snapshots are taken of the appropriate volumes, and the virtual machine is returned to the previous state during the processing of the PostSnapshot event.</span></span>

<span data-ttu-id="3ad6c-115">O outro mecanismo de backup é chamado de "instantâneo de VM filho", que usa o VSS dentro da máquina virtual filho para participar do backup.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-115">The other backup mechanism is called the "Child VM Snapshot" method, which uses VSS inside the child virtual machine to participate in the backup.</span></span> <span data-ttu-id="3ad6c-116">Para que o método "instantâneo de VM filho" tenha suporte, todas as condições a seguir devem ser atendidas:</span><span class="sxs-lookup"><span data-stu-id="3ad6c-116">For the "Child VM Snapshot" method to be supported, all of the following conditions must be met:</span></span>

-   <span data-ttu-id="3ad6c-117">O serviço de integração de backup (instantâneo de volume) está instalado e em execução na máquina virtual filho.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-117">Backup (volume snapshot) Integration Service is installed and running in the child virtual machine.</span></span> <span data-ttu-id="3ad6c-118">O nome do serviço é "solicitante de cópia de sombra de volume do Hyper-V".</span><span class="sxs-lookup"><span data-stu-id="3ad6c-118">The service name is "Hyper-V Volume Shadow Copy Requestor".</span></span>
-   <span data-ttu-id="3ad6c-119">A máquina virtual filho deve estar no estado executando.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-119">The child virtual machine must be in the running state.</span></span>
-   <span data-ttu-id="3ad6c-120">O local do arquivo de instantâneo para a máquina virtual é definido para ser o mesmo volume no sistema operacional do host que os arquivos VHD da máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-120">The Snapshot File Location for the virtual machine is set to be the same volume in the host operating system as the VHD files for the virtual machine.</span></span>
-   <span data-ttu-id="3ad6c-121">Todos os volumes na máquina virtual filho são discos básicos e não há discos dinâmicos.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-121">All volumes on the child virtual machine are basic disks and there are no dynamic disks.</span></span>
-   <span data-ttu-id="3ad6c-122">Todos os discos na máquina virtual filho devem usar um sistema de arquivos que ofereça suporte a instantâneos (por exemplo, NTFS).</span><span class="sxs-lookup"><span data-stu-id="3ad6c-122">All disks on the child virtual machine must use a file system that supports snapshots (for example, NTFS).</span></span>

<span data-ttu-id="3ad6c-123">Em geral, o processo de backup de máquinas virtuais é o mesmo descrito em [visão geral do processamento de um backup no VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="3ad6c-123">In general, the process for backing up virtual machines is the same as described in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="3ad6c-124">O comportamento exclusivo ocorre quando o gravador VSS do Hyper-V (parte do serviço de gerenciamento de máquinas virtuais do Hyper-V) processa o evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-124">The unique behavior happens when the Hyper-V VSS writer (part of the "Hyper-V Virtual Machine Management" service) processes the PrepareForSnapshot event.</span></span> <span data-ttu-id="3ad6c-125">Se o backup foi feito usando o método "instantâneo de VM filho", há processamento adicional feito, mas não é visível para a máquina virtual filho.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-125">If the backup was done using the "Child VM Snapshot" method, there is additional processing done but it is not visible to the child virtual machine.</span></span>

<span data-ttu-id="3ad6c-126">O procedimento a seguir descreve como fazer backup de máquinas virtuais.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-126">The following procedure describes how to back up virtual machines.</span></span>

<span data-ttu-id="3ad6c-127">**Para fazer backup de máquinas virtuais**</span><span class="sxs-lookup"><span data-stu-id="3ad6c-127">**To back up virtual machines**</span></span>

1.  <span data-ttu-id="3ad6c-128">Para cada máquina virtual nos metadados do gravador, se o método "estado salvo" for usado, a máquina virtual será colocada em um estado salvo.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-128">For each virtual machine in the writer metadata, if the "Saved State" method is used, the virtual machine is put into a saved state.</span></span> <span data-ttu-id="3ad6c-129">Para máquinas virtuais usando o método "instantâneo de VM filho", o serviço do solicitante de cópias de sombra de volume do Hyper-V na máquina virtual filho processa o backup conforme detalhado em [visão geral do processamento de um backup no VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="3ad6c-129">For virtual machines using the "Child VM Snapshot" method, the Hyper-V Volume Shadow Copy Requestor Service in the child virtual machine processes the backup as detailed in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="3ad6c-130">Todos os eventos do VSS na máquina virtual filho ocorrem durante o processamento do sistema operacional do host do evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-130">All VSS events on the child virtual machine occur during the host operating system processing of the PrepareForSnapshot event.</span></span>
2.  <span data-ttu-id="3ad6c-131">Depois que todas as máquinas virtuais tiverem sido colocadas no estado salvo ou tiverem instantâneos tirados, o gravador VSS do Hyper-V retornará do evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-131">After all virtual machines have either been put in the saved state or had snapshots taken, the Hyper-V VSS writer returns from the PrepareForSnapshot event.</span></span> <span data-ttu-id="3ad6c-132">Nenhum processamento é feito pelo gravador VSS do Hyper-V durante os eventos Freeze e descongelar.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-132">No processing is done by the Hyper-V VSS writer during the Freeze and Thaw events.</span></span>
3.  <span data-ttu-id="3ad6c-133">Quando o gravador VSS do Hyper-V processa o evento de pós-instantâneo, as máquinas virtuais cujo backup foi feito usando o método "estado salvo" e foram colocadas em um estado salvo pelo gravador VSS do Hyper-V são retornadas para o estado em que estavam antes do início do backup.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-133">When the Hyper-V VSS writer processes the PostSnapshot event, virtual machines that were backed up using the "Saved State" method and were put into a saved state by the Hyper-V VSS writer are returned to the state they were in before the backup started.</span></span> <span data-ttu-id="3ad6c-134">Para as máquinas virtuais cujo backup foi feito usando o método "instantâneo de VM filho", a imagem de host dos arquivos VHD que tiveram os instantâneos obtidos é revertida para o instantâneo obtido durante o processamento do evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-134">For the virtual machines that were backed up using the "Child VM Snapshot" method, the host image of the VHD files that had the snapshots taken are rolled back to the snapshot taken during the processing of the PrepareForSnapshot event.</span></span> <span data-ttu-id="3ad6c-135">Esse processamento é feito independentemente dos gravadores VSS nas máquinas virtuais filhas, de modo que os instantâneos tirados devem ser recuperáveis automaticamente.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-135">This processing is done independently of the VSS writers on the child virtual machines so the snapshots taken must be auto-recoverable.</span></span> <span data-ttu-id="3ad6c-136">(Não é possível definir a **\_ \_ \_ \_ AutoRecuperação do atributo de VOLSNAP do VSS** no contexto.)</span><span class="sxs-lookup"><span data-stu-id="3ad6c-136">(**VSS\_VOLSNAP\_ATTR\_NO\_AUTORECOVERY** is not set in the context.)</span></span>

<span data-ttu-id="3ad6c-137">Não há suporte para backups parciais.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-137">Partial backups are not supported.</span></span> <span data-ttu-id="3ad6c-138">Se alguma máquina virtual falhar ao criar um instantâneo, não será feito backup de máquinas virtuais.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-138">If any virtual machine fails to create a snapshot, no virtual machines will be backed up.</span></span>

> [!Note]  
> <span data-ttu-id="3ad6c-139">Os discos de passagem e iSCSI não são visíveis para o sistema operacional do host e, portanto, não são submetidos a backup pelo gravador VSS do Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-139">Pass-through and iSCSI disks are not visible to the host operating system and therefore not backed up by the Hyper-V VSS writer.</span></span> <span data-ttu-id="3ad6c-140">Os backups desses volumes devem ser inteiramente executados na máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-140">Backups of these volumes must be done entirely on the virtual machine.</span></span>

 

## <a name="restoring-the-virtual-machines"></a><span data-ttu-id="3ad6c-141">Restaurando as máquinas virtuais</span><span class="sxs-lookup"><span data-stu-id="3ad6c-141">Restoring the virtual machines</span></span>

<span data-ttu-id="3ad6c-142">A restauração das máquinas virtuais é feita inteiramente pelo sistema operacional do host; os gravadores VSS nas máquinas virtuais filhas não estão envolvidos.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-142">Restoring the virtual machines is done entirely by the host operating system; the VSS writers on the child virtual machines are not involved.</span></span>

<span data-ttu-id="3ad6c-143">O procedimento a seguir descreve como restaurar máquinas virtuais.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-143">The following procedure describes how to restore virtual machines.</span></span>

<span data-ttu-id="3ad6c-144">**Para restaurar máquinas virtuais**</span><span class="sxs-lookup"><span data-stu-id="3ad6c-144">**To restore virtual machines**</span></span>

1.  <span data-ttu-id="3ad6c-145">Durante o processamento do evento de prerestore, o gravador VSS do Hyper-V desliga e exclui todas as máquinas virtuais que estão prestes a ser restauradas.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-145">During the processing of the PreRestore event, the Hyper-V VSS writer turns off and deletes any virtual machines that are about to be restored.</span></span>
2.  <span data-ttu-id="3ad6c-146">Depois que todos os gravadores VSS tiverem processado o evento prerestore, os arquivos serão restaurados.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-146">After all VSS writers have processed the PreRestore event, the files are restored.</span></span>
3.  <span data-ttu-id="3ad6c-147">Durante o processamento do evento de restauração, o gravador VSS do Hyper-V chama o método [**IVssComponent:: GetFileRestoreStatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) .</span><span class="sxs-lookup"><span data-stu-id="3ad6c-147">During the processing of the PostRestore event, the Hyper-V VSS writer calls the [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) method.</span></span> <span data-ttu-id="3ad6c-148">Se o retorno não for **VSS \_ RS \_**, o gravador VSS do Hyper-V chamará o método [**SetWriterFailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) e retornará **false** do método [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) .</span><span class="sxs-lookup"><span data-stu-id="3ad6c-148">If the return is not **VSS\_RS\_ALL**, then the Hyper-V VSS writer calls the [**SetWriterFailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) method and returns **False** from the [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) method.</span></span>
4.  <span data-ttu-id="3ad6c-149">Para cada máquina virtual que foi restaurada, o gravador VSS do Hyper-V registra a máquina virtual com o serviço de gerenciamento do Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-149">For each virtual machine that was restored, the Hyper-V VSS writer registers the virtual machine with the Hyper-V management service.</span></span> <span data-ttu-id="3ad6c-150">Se a máquina virtual for restaurada para um local não padrão, um link simbólico será criado no local padrão vinculando a esse local.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-150">If the virtual machine is restored to a nondefault location, a symbolic link is created in the default location linking to that location.</span></span>
5.  <span data-ttu-id="3ad6c-151">Para cada VHD que foi restaurado, o local é comparado com aquele especificado para essa máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-151">For each VHD that was restored, the location is compared with the one specified for that virtual machine.</span></span> <span data-ttu-id="3ad6c-152">Se o local for diferente, a configuração será atualizada com o local apropriado.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-152">If the location is different, then the configuration is updated with the proper location.</span></span>
6.  <span data-ttu-id="3ad6c-153">A configuração de rede está atualizada.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-153">The network configuration is updated.</span></span> <span data-ttu-id="3ad6c-154">Se os comutadores virtuais aos quais a máquina virtual estava conectada quando foi feito o backup ainda forem encerrados, novas portas serão criadas e conectadas à máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-154">If the virtual switches that the virtual machine was connected to when it was backed up still exit, new ports are created and connected to the virtual machine.</span></span>

## <a name="failover-clustering-and-hyper-v-vss"></a><span data-ttu-id="3ad6c-155">Clustering de failover e VSS do Hyper-V</span><span class="sxs-lookup"><span data-stu-id="3ad6c-155">Failover clustering and Hyper-V VSS</span></span>

<span data-ttu-id="3ad6c-156">O gravador VSS do Hyper-V não dá nenhuma consideração às máquinas virtuais que fazem parte de um cluster de failover.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-156">The Hyper-V VSS writer does not give any consideration to virtual machines that are part of a failover cluster.</span></span> <span data-ttu-id="3ad6c-157">Durante os backups do método "estado salvo" e todas as restaurações, a máquina virtual seria colocada no estado salvo ou totalmente excluída.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-157">During both the "Saved State" method backups and all restores, the virtual machine would be put into the saved state or deleted entirely.</span></span> <span data-ttu-id="3ad6c-158">Isso seria visto como uma falha pelo serviço de clustering e faz com que os aplicativos nesses nós fossem failover para outros nós.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-158">This would be seen as a failure by the clustering service and cause the applications on those nodes to be failed over to other nodes.</span></span> <span data-ttu-id="3ad6c-159">Para evitar isso durante os backups de "estado salvo", o estado da máquina virtual deve ser salvo usando o serviço de clustering.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-159">To avoid this during "Saved State" backups, the virtual machine state must be saved using the clustering service.</span></span> <span data-ttu-id="3ad6c-160">Para evitar isso durante uma restauração, os recursos na máquina virtual precisariam ser colocados offline.</span><span class="sxs-lookup"><span data-stu-id="3ad6c-160">To avoid this during a restore, the resources on the virtual machine would need to be taken offline.</span></span>

## <a name="details-on-the-hyper-v-vss-writer"></a><span data-ttu-id="3ad6c-161">Detalhes sobre o gravador VSS do Hyper-V</span><span class="sxs-lookup"><span data-stu-id="3ad6c-161">Details on the Hyper-V VSS Writer</span></span>

<span data-ttu-id="3ad6c-162">Nome do gravador: gravador VSS do Microsoft Hyper-V</span><span class="sxs-lookup"><span data-stu-id="3ad6c-162">Writer Name: Microsoft Hyper-V VSS Writer</span></span>

<span data-ttu-id="3ad6c-163">ID do gravador: 66841cd4-6ded-4f4b-8f17-fd23f8ddc3de</span><span class="sxs-lookup"><span data-stu-id="3ad6c-163">Writer ID: 66841cd4-6ded-4f4b-8f17-fd23f8ddc3de</span></span>

## <a name="related-topics"></a><span data-ttu-id="3ad6c-164">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="3ad6c-164">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="3ad6c-165">Visão geral do processamento de um backup no VSS</span><span class="sxs-lookup"><span data-stu-id="3ad6c-165">Overview of Processing a Backup Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss)
</dt> <dt>

[<span data-ttu-id="3ad6c-166">Visão geral do processamento de uma restauração no VSS</span><span class="sxs-lookup"><span data-stu-id="3ad6c-166">Overview of Processing a Restore Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-restore-under-vss)
</dt> </dl>

 

 
