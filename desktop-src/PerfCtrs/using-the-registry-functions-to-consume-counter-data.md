---
description: Você pode usar as funções de registro para coletar dados de desempenho.
ms.assetid: feac7b8d-1dee-462c-89dc-bec1ba045da2
title: Usando as funções de registro para consumir dados de contador
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: ce2a4ba9992510cb296b037cfd98965410c48939
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "105758929"
---
# <a name="using-the-registry-functions-to-consume-counter-data"></a><span data-ttu-id="ff1a1-103">Usando as funções de registro para consumir dados de contador</span><span class="sxs-lookup"><span data-stu-id="ff1a1-103">Using the Registry Functions to Consume Counter Data</span></span>

<span data-ttu-id="ff1a1-104">Use as [funções de registro](/windows/desktop/SysInfo/registry-functions) para coletar dados de desempenho da `HKEY_PERFORMANCE_DATA` chave do registro especial.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-104">Use the [registry functions](/windows/desktop/SysInfo/registry-functions) to collect performance data from the special `HKEY_PERFORMANCE_DATA` registry key.</span></span>

<span data-ttu-id="ff1a1-105">Os dados de desempenho não são realmente armazenados no registro.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-105">Performance data is not actually stored in the registry.</span></span> <span data-ttu-id="ff1a1-106">Chamar as funções de registro faz com que o sistema colete os dados do provedor de dados de desempenho apropriado.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-106">Calling the registry functions causes the system to collect the data from the appropriate performance data provider.</span></span>

> [!Note]
> <span data-ttu-id="ff1a1-107">Normalmente, você não deve usar as funções de registro para consumir dados do contador.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-107">You should not normally use the registry functions to consume counter data.</span></span> <span data-ttu-id="ff1a1-108">Em vez disso, você deve [usar as funções de PDH (auxiliar de dados de desempenho)](using-the-pdh-functions-to-consume-counter-data.md).</span><span class="sxs-lookup"><span data-stu-id="ff1a1-108">Instead, you should [use the Performance Data Helper (PDH) functions](using-the-pdh-functions-to-consume-counter-data.md).</span></span> <span data-ttu-id="ff1a1-109">As funções de PDH são mais fáceis de usar e evitam muitos problemas de desempenho e confiabilidade que podem ocorrer por meio do uso incorreto das funções de registro.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-109">The PDH functions are easier to use and avoid many performance and reliability problems that can occur through incorrect use of the registry functions.</span></span>

> [!Note]
> <span data-ttu-id="ff1a1-110">Você não poderá usar as funções de registro se estiver escrevendo aplicativos do Windows OneCore.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-110">You cannot use the registry functions if you are writing Windows OneCore apps.</span></span> <span data-ttu-id="ff1a1-111">Em vez disso, use as [funções de consumidor do PerfLib v2](using-the-perflib-functions-to-consume-counter-data.md).</span><span class="sxs-lookup"><span data-stu-id="ff1a1-111">Instead, use [PerfLib V2 Consumer functions](using-the-perflib-functions-to-consume-counter-data.md).</span></span>

<span data-ttu-id="ff1a1-112">As funções de registro são a API de nível baixo para coletar dados de **provedores v1**.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-112">The registry functions are the low-level API for collecting data from **V1 providers**.</span></span> <span data-ttu-id="ff1a1-113">As funções de registro também dão suporte à coleta de dados de **provedores v2** por meio de uma camada de conversão que chama as [funções de consumidor v2](using-the-perflib-functions-to-consume-counter-data.md).</span><span class="sxs-lookup"><span data-stu-id="ff1a1-113">The registry functions also support collecting data from **V2 providers** via a translation layer that calls into the [V2 Consumer functions](using-the-perflib-functions-to-consume-counter-data.md).</span></span>

<span data-ttu-id="ff1a1-114">Para obter dados de desempenho do sistema local, chame a função [**RegQueryValueEx**](/windows/win32/api/winreg/nf-winreg-regqueryvalueexw) .</span><span class="sxs-lookup"><span data-stu-id="ff1a1-114">To obtain performance data from the local system, call the [**RegQueryValueEx**](/windows/win32/api/winreg/nf-winreg-regqueryvalueexw) function.</span></span> <span data-ttu-id="ff1a1-115">Use `HKEY_PERFORMANCE_DATA` como a chave.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-115">Use `HKEY_PERFORMANCE_DATA` as the key.</span></span> <span data-ttu-id="ff1a1-116">A primeira chamada abre a chave.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-116">The first call opens the key.</span></span> <span data-ttu-id="ff1a1-117">Você não precisa abrir a chave explicitamente primeiro.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-117">You do not need to explicitly open the key first.</span></span>

<span data-ttu-id="ff1a1-118">Para obter dados de desempenho de um sistema remoto, chame a função [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistryw) .</span><span class="sxs-lookup"><span data-stu-id="ff1a1-118">To obtain performance data from a remote system, call the [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistryw) function.</span></span> <span data-ttu-id="ff1a1-119">Use o nome do computador do sistema remoto e use `HKEY_PERFORMANCE_DATA` como a chave.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-119">Use the computer name of the remote system and use `HKEY_PERFORMANCE_DATA` as the key.</span></span> <span data-ttu-id="ff1a1-120">Essa chamada recupera uma chave que representa os dados de desempenho para o sistema remoto.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-120">This call retrieves a key representing the performance data for the remote system.</span></span> <span data-ttu-id="ff1a1-121">Use essa chave em vez `HKEY_PERFORMANCE_DATA` da chave para recuperar os dados.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-121">Use this key rather than `HKEY_PERFORMANCE_DATA` key to retrieve the data.</span></span>

<span data-ttu-id="ff1a1-122">Certifique-se de usar a função [**falha RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) para fechar o identificador para a chave quando terminar de obter os dados de desempenho.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-122">Be sure to use the [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) function to close the handle to the key when you are finished obtaining the performance data.</span></span> <span data-ttu-id="ff1a1-123">Isso é importante para os casos local e remoto:</span><span class="sxs-lookup"><span data-stu-id="ff1a1-123">This is important for both the local and remote cases:</span></span>

- <span data-ttu-id="ff1a1-124">`RegCloseKey(HKEY_PERFORMANCE_DATA)` na verdade, não fecha um identificador de registro, mas apaga todos os dados armazenados em cache e libera as DLLs de desempenho carregadas.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-124">`RegCloseKey(HKEY_PERFORMANCE_DATA)` does not actually close a registry handle, but it clears all cached data and frees the loaded performance DLLs.</span></span>
- <span data-ttu-id="ff1a1-125">`RegCloseKey(hkeyRemotePerformanceData)` Fecha o identificador para o registro do computador remoto.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-125">`RegCloseKey(hkeyRemotePerformanceData)` closes the handle to the remote machine's registry.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="ff1a1-126">Não chame `RegCloseKey(HKEY_PERFORMANCE_DATA)` durante `DLL_PROCESS_DETACH` .</span><span class="sxs-lookup"><span data-stu-id="ff1a1-126">Do not call `RegCloseKey(HKEY_PERFORMANCE_DATA)` during `DLL_PROCESS_DETACH`.</span></span>

<span data-ttu-id="ff1a1-127">Use o `lpValueName` parâmetro da função [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) para indicar as informações a serem recuperadas.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-127">You use the `lpValueName` parameter of the [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) function to indicate the information to retrieve.</span></span> <span data-ttu-id="ff1a1-128">A tabela a seguir lista os valores que você pode especificar para `lpValueName` .</span><span class="sxs-lookup"><span data-stu-id="ff1a1-128">The following table lists the values you can specify for `lpValueName`.</span></span> <span data-ttu-id="ff1a1-129">Observe que as cadeias de caracteres de valor não diferenciam maiúsculas de minúsculas.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-129">Note that the value strings are not case-sensitive.</span></span>

|<span data-ttu-id="ff1a1-130">Valor</span><span class="sxs-lookup"><span data-stu-id="ff1a1-130">Value</span></span>|<span data-ttu-id="ff1a1-131">Descrição</span><span class="sxs-lookup"><span data-stu-id="ff1a1-131">Description</span></span>
|-----|-----------
|`Global`| <span data-ttu-id="ff1a1-132">Recupera dados de desempenho para todos os objetos de desempenho registrados no computador, exceto aqueles incluídos na `Costly` categoria.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-132">Retrieves performance data for all performance objects registered on the computer except for those included in the `Costly` category.</span></span>
|`OLD_Global`| <span data-ttu-id="ff1a1-133">**Windows Vista e posterior:** Recupera dados de desempenho para todos os objetos de desempenho **v1** registrados no computador, exceto aqueles incluídos na `Costly` categoria.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-133">**Windows Vista and later:** Retrieves performance data for all **V1** performance objects registered on the computer except for those included in the `Costly` category.</span></span> <span data-ttu-id="ff1a1-134">Use isso em vez de `Global` para evitar a coleta de dados de provedor v2 desnecessários quando você sabe que os dados de interesse vêm de um provedor v1.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-134">Use this instead of `Global` to avoid collecting unnecessary V2 provider data when you know that the data of interest comes from a V1 provider.</span></span>
|`n1 n2 ...`| <span data-ttu-id="ff1a1-135">Recupera dados de desempenho para um ou mais objetos de desempenho.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-135">Retrieves performance data for one or more performance objects.</span></span> <span data-ttu-id="ff1a1-136">Especifique o índice decimal associado a cada objeto que você deseja recuperar em uma lista separada por espaços.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-136">Specify the decimal index associated with each object that you want to retrieve in a space-separated list.</span></span> <span data-ttu-id="ff1a1-137">Por exemplo, se você quiser recuperar objetos de sistema e memória e tiver determinado que os índices das cadeias de caracteres de nome correspondentes são 2 e 4, especifique a cadeia de caracteres `"2 4"` .</span><span class="sxs-lookup"><span data-stu-id="ff1a1-137">For example, if you want to retrieve System and Memory objects and you have determined that the indexes of the corresponding name strings are 2 and 4, specify the string `"2 4"`.</span></span> <span data-ttu-id="ff1a1-138">Observe que a consulta pode retornar um número diferente de objetos que você solicitou.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-138">Note that the query can return a different number of objects than you requested.</span></span> <span data-ttu-id="ff1a1-139">Isso pode acontecer se o objeto especificado não estiver disponível, se o objeto especificado depender de outro tipo de objeto ou se um provedor retornar dados que não foram solicitados diretamente.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-139">This can happen if the specified object is unavailable, if the specified object depends on another object type, or if a provider otherwise returns data that was not directly requested.</span></span> <span data-ttu-id="ff1a1-140">Por exemplo, os threads dependem de processos, portanto, se você solicitar dados do `Thread` objeto, os resultados incluirão dados do `Process` objeto.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-140">For example, threads depend on processes, so if you request data from the `Thread` object, the results will include data from the `Process` object.</span></span>
|`Counter n`| <span data-ttu-id="ff1a1-141">Recupera cadeias de caracteres de nome para o identificador de idioma especificado, por exemplo, inglês para `Counter 9` .</span><span class="sxs-lookup"><span data-stu-id="ff1a1-141">Retrieves name strings for the specified language identifier, e.g. English for `Counter 9`.</span></span> <span data-ttu-id="ff1a1-142">Use as cadeias de caracteres de nome retornadas para localizar o índice correspondente a um determinado nome ou para localizar o nome correspondente a um determinado índice.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-142">Use the returned name strings to find the index corresponding to a given name or to find the name corresponding to a given index.</span></span> <span data-ttu-id="ff1a1-143">Consulte [recuperando nomes de contadores e texto de ajuda](retrieving-counter-names-and-help-text.md) para obter detalhes.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-143">See [Retrieving Counter Names and Help Text](retrieving-counter-names-and-help-text.md) for details.</span></span> <span data-ttu-id="ff1a1-144">Observe que a lista retornada inclui nomes de objeto (CounterSet) e nomes de contadores – não há uma maneira simples de determinar se um nome é um nome de objeto ou um nome de contador.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-144">Note that the returned list includes both object (counterset) names and counter names -- there is no simple way to determine whether a name is an object name or a counter name.</span></span>
|`Help n`| <span data-ttu-id="ff1a1-145">Recupera cadeias de caracteres de ajuda para o identificador de idioma especificado, por exemplo, inglês para `Help 9` .</span><span class="sxs-lookup"><span data-stu-id="ff1a1-145">Retrieves help strings for the specified language identifier, e.g. English for `Help 9`.</span></span> <span data-ttu-id="ff1a1-146">Use as cadeias de caracteres de ajuda retornadas para localizar descrições correspondentes aos índices de objeto (CounterSet) ou de ajuda do contador.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-146">Use the returned help strings to find descriptions corresponding to object (counterset) or counter help indexes.</span></span> <span data-ttu-id="ff1a1-147">Consulte [recuperando nomes de contadores e texto de ajuda](retrieving-counter-names-and-help-text.md) para obter detalhes.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-147">See [Retrieving Counter Names and Help Text](retrieving-counter-names-and-help-text.md) for details.</span></span>
|`Costly`| <span data-ttu-id="ff1a1-148">**Preterido:** Recupera dados de desempenho para tipos de objetos cujos dados são caros para coletar em termos de tempo de processador ou uso de memória.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-148">**Deprecated:** Retrieves performance data for object types whose data is expensive to collect in terms of processor time or memory usage.</span></span> <span data-ttu-id="ff1a1-149">Essa coleção pode levar vários minutos em um computador muito carregado.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-149">This collection may take several minutes on a heavily-loaded machine.</span></span> <span data-ttu-id="ff1a1-150">Você deve executar a coleção em um thread de trabalho se seu aplicativo precisar responder ao usuário durante essa coleta de dados.</span><span class="sxs-lookup"><span data-stu-id="ff1a1-150">You should perform the collection on a worker thread if your application needs to respond to the user during this data collection.</span></span>

<span data-ttu-id="ff1a1-151">Para obter detalhes sobre o formato dos dados de desempenho que o registro retorna, consulte [formato de dados de desempenho](performance-data-format.md).</span><span class="sxs-lookup"><span data-stu-id="ff1a1-151">For details on the format of the performance data that the registry returns, see [Performance Data Format](performance-data-format.md).</span></span>

<span data-ttu-id="ff1a1-152">Para obter um exemplo que obtém os nomes e as descrições dos contadores registrados no computador, consulte [recuperando nomes de contadores e texto de ajuda](retrieving-counter-names-and-help-text.md).</span><span class="sxs-lookup"><span data-stu-id="ff1a1-152">For an example that gets the names and descriptions of the registered counters on the computer, see [Retrieving Counter Names and Help Text](retrieving-counter-names-and-help-text.md).</span></span>

<span data-ttu-id="ff1a1-153">Para obter um exemplo que acessa os componentes dos dados de desempenho, consulte [exibindo nomes de objeto, instância e contador](displaying-object-instance-and-counter-names.md).</span><span class="sxs-lookup"><span data-stu-id="ff1a1-153">For an example that accesses the components of the performance data, see [Displaying Object, Instance, and Counter Names](displaying-object-instance-and-counter-names.md).</span></span>

<span data-ttu-id="ff1a1-154">Para obter um exemplo que recupera, computa e imprime valores de contadores, consulte [recuperando dados de contador](retrieving-counter-data.md) e [calculando valores de contador](calculating-counter-values.md).</span><span class="sxs-lookup"><span data-stu-id="ff1a1-154">For an example that retrieves, computes, and prints counter values, see [Retrieving Counter Data](retrieving-counter-data.md) and [Calculating Counter Values](calculating-counter-values.md).</span></span>
