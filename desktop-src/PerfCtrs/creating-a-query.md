---
description: Para criar uma nova consulta que coleta dados de desempenho de um arquivo de origem ou de log em tempo real, chame a função PdhOpenQuery. A função retorna um identificador para a consulta que você usa em chamadas de função PDH subsequentes.
ms.assetid: 6fd4716e-b163-47a3-b0cb-5f9599f8681f
title: Criando uma consulta
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a9d50ec52966529a3476a6d375606ba3d0b538b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104091637"
---
# <a name="creating-a-query"></a><span data-ttu-id="ce8fa-104">Criando uma consulta</span><span class="sxs-lookup"><span data-stu-id="ce8fa-104">Creating a Query</span></span>

<span data-ttu-id="ce8fa-105">Para criar uma nova consulta que coleta dados de desempenho de um arquivo de origem ou de log em tempo real, chame a função [**PdhOpenQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhopenquerya) .</span><span class="sxs-lookup"><span data-stu-id="ce8fa-105">To create a new query that collects performance data from a real-time source or log file, call the [**PdhOpenQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhopenquerya) function.</span></span> <span data-ttu-id="ce8fa-106">A função retorna um identificador para a consulta que você usa em chamadas de função PDH subsequentes.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-106">The function returns a handle to the query that you use in subsequent PDH function calls.</span></span>

<span data-ttu-id="ce8fa-107">Depois de criar a consulta, chame a função [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) para cada contador que você deseja adicionar à consulta.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-107">After creating the query, call the [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) function for each counter that you want to add to the query.</span></span> <span data-ttu-id="ce8fa-108">Você pode usar um dos métodos a seguir para fornecer o caminho do contador totalmente qualificado.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-108">You can use one of the following methods to provide the fully qualified counter path.</span></span>

-   <span data-ttu-id="ce8fa-109">Defina o caminho do contador como uma cadeia de caracteres estática.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-109">Define the counter path as a static string.</span></span> <span data-ttu-id="ce8fa-110">Use esse método se você sempre monitorar o mesmo contador e se estiver familiarizado com a sintaxe correta de um caminho de contador.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-110">Use this method if you always monitor the same counter, and if you are familiar with the correct syntax of a counter path.</span></span> <span data-ttu-id="ce8fa-111">Para obter informações sobre a sintaxe correta usada para especificar um contador, consulte [especificando um caminho de contador](specifying-a-counter-path.md).</span><span class="sxs-lookup"><span data-stu-id="ce8fa-111">For information on the correct syntax used to specify a counter, see [Specifying a Counter Path](specifying-a-counter-path.md).</span></span>
-   <span data-ttu-id="ce8fa-112">Inicialize uma estrutura de [**\_ elementos do \_ caminho \_ do contador PDH**](/windows/desktop/api/Pdh/ns-pdh-pdh_counter_path_elements_a) com os nomes do computador, objeto, contador e instância.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-112">Initialize a [**PDH\_COUNTER\_PATH\_ELEMENTS**](/windows/desktop/api/Pdh/ns-pdh-pdh_counter_path_elements_a) structure with the names of the computer, object, counter, and instance.</span></span> <span data-ttu-id="ce8fa-113">Passe essa estrutura para [**PdhMakeCounterPath**](/windows/desktop/api/Pdh/nf-pdh-pdhmakecounterpatha) , que retornará um caminho de contador para os elementos especificados.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-113">Pass this structure to [**PdhMakeCounterPath**](/windows/desktop/api/Pdh/nf-pdh-pdhmakecounterpatha) which will return a counter path for the specified elements.</span></span>
-   <span data-ttu-id="ce8fa-114">Especifique um caminho de contador que contenha caracteres curinga e chame [**PdhExpandWildCardPath**](/windows/desktop/api/Pdh/nf-pdh-pdhexpandwildcardpatha) para obter uma lista de nomes de contadores que correspondem aos caracteres curinga no caminho.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-114">Specify a counter path that contains wildcard characters and call [**PdhExpandWildCardPath**](/windows/desktop/api/Pdh/nf-pdh-pdhexpandwildcardpatha) to get a list of counter names that match the wildcard characters in the path.</span></span> <span data-ttu-id="ce8fa-115">Examine a lista de nomes de contadores e adicione à consulta os contadores desejados nesta lista.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-115">Scan through the list of counter names and add to the query the counters that you want from this list.</span></span>
-   <span data-ttu-id="ce8fa-116">Chame a função [**PdhBrowseCounters**](/windows/desktop/api/Pdh/nf-pdh-pdhbrowsecountersa) para exibir uma caixa de diálogo que permite ao usuário procurar e Selecionar contadores de desempenho.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-116">Call the [**PdhBrowseCounters**](/windows/desktop/api/Pdh/nf-pdh-pdhbrowsecountersa) function to display a dialog box that lets the user browse and select performance counters.</span></span> <span data-ttu-id="ce8fa-117">Para obter mais informações, consulte [procurar contadores](browsing-counters.md).</span><span class="sxs-lookup"><span data-stu-id="ce8fa-117">For more information, see [Browsing Counters](browsing-counters.md).</span></span>

<span data-ttu-id="ce8fa-118">Observe que, se uma instância do contador for especificada e não existir, o [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) não relatará uma condição de erro.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-118">Note that if a counter instance is specified that does not exist, [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) does not report an error condition.</span></span> <span data-ttu-id="ce8fa-119">Em vez disso, retorna o êxito do erro \_ .</span><span class="sxs-lookup"><span data-stu-id="ce8fa-119">Instead, it returns ERROR\_SUCCESS.</span></span> <span data-ttu-id="ce8fa-120">O motivo para esse comportamento é que ele não é conhecido se uma instância de contador não existente tiver sido especificada ou uma que existirá, mas ainda não tiver sido criada.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-120">The reason for this behavior is that it is not known if a nonexistent counter instance has been specified or one that will exist but has not yet been created.</span></span>

<span data-ttu-id="ce8fa-121">A instância do contador ausente será relatada por [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata), [**PdhGetRawCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetrawcountervalue)ou [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue).</span><span class="sxs-lookup"><span data-stu-id="ce8fa-121">The missing counter instance will be reported by either [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata), [**PdhGetRawCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetrawcountervalue), or [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue).</span></span> <span data-ttu-id="ce8fa-122">Ao chamar **PdhCollectQueryData** para apenas uma instância do contador, e a instância do contador ainda não existir, supõe-se que a instância do contador não exista e a função retorna PDH \_ sem \_ dados.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-122">When calling **PdhCollectQueryData** for one counter instance only, and the counter instance still does not exist, it is assumed that the counter instance will not exist and the function returns PDH\_NO\_DATA.</span></span> <span data-ttu-id="ce8fa-123">No entanto, se mais de um contador for consultado, **PdhCollectQueryData** poderá ainda retornar \_ um êxito de erro mesmo que uma das instâncias do contador ainda não exista.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-123">However, if more than one counter is queried, **PdhCollectQueryData** may still return ERROR\_SUCCESS even if one of the counter instances does not yet exist.</span></span> <span data-ttu-id="ce8fa-124">Nesse caso, chame **PdhGetRawCounterValue** ou **PdhGetFormattedCounterValue** para cada uma das instâncias de contador de interesse.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-124">In this case, call **PdhGetRawCounterValue** or **PdhGetFormattedCounterValue** for each of the counter instances of interest.</span></span> <span data-ttu-id="ce8fa-125">Se a instância não existir ao chamar **PdhGetRawCounterValue**, a função retornará êxito de erro \_ e definirá o membro **CStatus** do [**\_ \_ contador bruto de PDH**](/windows/desktop/api/Pdh/ns-pdh-pdh_raw_counter) para o status de PDH \_ \_ sem \_ instância.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-125">If the instance does not exist when calling **PdhGetRawCounterValue**, the function returns ERROR\_SUCCESS and sets the **CStatus** member of [**PDH\_RAW\_COUNTER**](/windows/desktop/api/Pdh/ns-pdh-pdh_raw_counter) to PDH\_STATUS\_NO\_INSTANCE.</span></span> <span data-ttu-id="ce8fa-126">Se a instância não existir ao chamar **PdhGetFormattedCounterValue**, a função retornará \_ dados inválidos \_ da PDH e definirá o membro **CStatus** do [**\_ \_ metavalor PDH fmt**](/windows/desktop/api/Pdh/ns-pdh-pdh_fmt_countervalue) para PDH \_ CStatus \_ nenhuma \_ instância.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-126">If the instance does not exist when calling **PdhGetFormattedCounterValue**, the function returns PDH\_INVALID\_DATA and sets the **CStatus** member of the [**PDH\_FMT\_COUNTERVALUE**](/windows/desktop/api/Pdh/ns-pdh-pdh_fmt_countervalue) to PDH\_CSTATUS\_NO\_INSTANCE.</span></span>

<span data-ttu-id="ce8fa-127">Observe que o caminho do contador especificado na função [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) deve ser localizado.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-127">Note that the counter path specified in the [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) function must be localized.</span></span> <span data-ttu-id="ce8fa-128">A função [**PdhAddEnglishCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddenglishcountera) fornece uma maneira neutra de localidade para adicionar contadores de desempenho à consulta.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-128">The [**PdhAddEnglishCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddenglishcountera) function provides a locale-neutral way to add performance counters to the query.</span></span> <span data-ttu-id="ce8fa-129">Essa função é a maneira recomendada para adicionar contadores neutros à localidade a uma consulta.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-129">This function is the recommended way to add locale-neutral counters to a query.</span></span>

<span data-ttu-id="ce8fa-130">Para remover um contador de uma consulta, chame a função [**PdhRemoveCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhremovecounter) .</span><span class="sxs-lookup"><span data-stu-id="ce8fa-130">To remove a counter from a query, call the [**PdhRemoveCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhremovecounter) function.</span></span>

<span data-ttu-id="ce8fa-131">Depois de concluir a coleta de dados de uma consulta, chame a função [**PdhCloseQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhclosequery) para fechar a consulta e liberar todos os recursos de sistema alocados.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-131">After you finish collecting data for a query, call the [**PdhCloseQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhclosequery) function to close the query and release all allocated system resources.</span></span> <span data-ttu-id="ce8fa-132">**PdhCloseQuery** fecha todos os identificadores de contador associados à consulta.</span><span class="sxs-lookup"><span data-stu-id="ce8fa-132">**PdhCloseQuery** closes all counter handles associated with the query.</span></span>

 

 



