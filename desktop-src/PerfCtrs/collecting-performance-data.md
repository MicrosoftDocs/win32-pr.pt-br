---
description: Depois de criar uma consulta e adicionar contadores a ela, chame a função PdhCollectQueryData para recuperar os dados brutos atuais de todos os contadores na consulta.
ms.assetid: 2534d387-a280-4716-9a9d-3e42f40e2f92
title: Coletando dados de desempenho
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e99bd2c0e22553245e87d3844694051c88c57895
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104296753"
---
# <a name="collecting-performance-data"></a><span data-ttu-id="b13c2-103">Coletando dados de desempenho</span><span class="sxs-lookup"><span data-stu-id="b13c2-103">Collecting Performance Data</span></span>

<span data-ttu-id="b13c2-104">Depois de [criar uma consulta](creating-a-query.md) e adicionar contadores a ela, chame a função [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) para recuperar os dados brutos atuais de todos os contadores na consulta.</span><span class="sxs-lookup"><span data-stu-id="b13c2-104">After [creating a query](creating-a-query.md) and adding counters to it, call the [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) function to retrieve the current raw data for all counters in the query.</span></span>

<span data-ttu-id="b13c2-105">Muitos contadores, como contadores de taxa, exigem dois exemplos de dados para calcular um valor de dados formatado.</span><span class="sxs-lookup"><span data-stu-id="b13c2-105">Many counters, such as rate counters, require two data samples to calculate a formatted data value.</span></span> <span data-ttu-id="b13c2-106">A PDH mantém dados para o exemplo atual e o exemplo coletado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="b13c2-106">PDH maintains data for the current sample and the previously collected sample.</span></span> <span data-ttu-id="b13c2-107">O procedimento a seguir descreve como coletar valores de contador que exigem dois exemplos para calcular um valor de exibição.</span><span class="sxs-lookup"><span data-stu-id="b13c2-107">The following procedure describes how to collect counter values that require two samples to calculate a displayable value.</span></span>

<span data-ttu-id="b13c2-108">**Para coletar valores de contador que exigem dois exemplos para calcular um valor de exibição**</span><span class="sxs-lookup"><span data-stu-id="b13c2-108">**To collect counter values that require two samples to calculate a displayable value**</span></span>

1.  <span data-ttu-id="b13c2-109">Chame [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) para coletar a primeira amostra.</span><span class="sxs-lookup"><span data-stu-id="b13c2-109">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) to collect the first sample.</span></span>
2.  <span data-ttu-id="b13c2-110">Chame a função [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) para aguardar um mínimo de um segundo entre coleções.</span><span class="sxs-lookup"><span data-stu-id="b13c2-110">Call the [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) function to wait a minimum of one second between collections.</span></span>
3.  <span data-ttu-id="b13c2-111">Chame [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) novamente para coletar a segunda amostra.</span><span class="sxs-lookup"><span data-stu-id="b13c2-111">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) again to collect the second sample.</span></span>
4.  <span data-ttu-id="b13c2-112">Chame a função [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) para calcular um valor de exibição.</span><span class="sxs-lookup"><span data-stu-id="b13c2-112">Call the [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) function to calculate a displayable value.</span></span>
5.  <span data-ttu-id="b13c2-113">Repita as etapas de 2 a 4.</span><span class="sxs-lookup"><span data-stu-id="b13c2-113">Repeat steps 2 through 4.</span></span>

<span data-ttu-id="b13c2-114">Como uma alternativa para implementar um período de espera por conta própria, você pode chamar a função [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) , que cria um thread de tempo que aguarda um período de tempo especificado, coleta o exemplo e dispara um evento definido pelo aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b13c2-114">As an alternative to implementing a wait period yourself, you can call the [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) function, which creates a timing thread that waits a specified amount of time, collects the sample, and then triggers an application-defined event.</span></span>

<span data-ttu-id="b13c2-115">Se você quiser consultar dados de desempenho de um arquivo de log, também poderá definir um intervalo de tempo.</span><span class="sxs-lookup"><span data-stu-id="b13c2-115">If you want to query performance data from a log file, you can also define a time range.</span></span> <span data-ttu-id="b13c2-116">O intervalo de tempo limita a consulta a esses exemplos que foram coletados dentro do intervalo de tempo (cada exemplo contém um carimbo de data/hora para quando ele foi coletado).</span><span class="sxs-lookup"><span data-stu-id="b13c2-116">The time range limits the query to those samples that were collected within the time range (each sample contains a time stamp for when it was collected).</span></span> <span data-ttu-id="b13c2-117">Para obter mais informações sobre como definir e recuperar intervalos de tempo, consulte [definindo um intervalo de tempo para uma consulta](setting-a-time-range-for-a-query.md).</span><span class="sxs-lookup"><span data-stu-id="b13c2-117">For more information on how to set and retrieve time ranges, see [Setting a Time Range for a Query](setting-a-time-range-for-a-query.md).</span></span>

<span data-ttu-id="b13c2-118">Se você quiser coletar dados de desempenho e gravá-los em um arquivo de log, chame a função [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) em vez de chamar [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata).</span><span class="sxs-lookup"><span data-stu-id="b13c2-118">If you want to collect performance data and write it to a log file, you would call the [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) function instead of calling [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata).</span></span> <span data-ttu-id="b13c2-119">Para obter detalhes, consulte [trabalhando com arquivos de log](working-with-log-files.md) e [gravando dados de desempenho em um arquivo de log](writing-performance-data-to-a-log-file.md).</span><span class="sxs-lookup"><span data-stu-id="b13c2-119">For details, see [Working with Log Files](working-with-log-files.md) and [Writing Performance Data to a Log File](writing-performance-data-to-a-log-file.md).</span></span>

<span data-ttu-id="b13c2-120">Para obter detalhes sobre como calcular um valor de amostra exibível, consulte [exibindo dados de desempenho](displaying-performance-data.md).</span><span class="sxs-lookup"><span data-stu-id="b13c2-120">For details on calculating a displayable sample value, see [Displaying Performance Data](displaying-performance-data.md).</span></span>

## <a name="understanding-multiple-processor-counters"></a><span data-ttu-id="b13c2-121">Compreendendo vários contadores de processador</span><span class="sxs-lookup"><span data-stu-id="b13c2-121">Understanding Multiple Processor Counters</span></span>

<span data-ttu-id="b13c2-122">Alguns contadores de desempenho foram projetados para sistemas de processador único e podem não ser precisos para computadores com vários processadores.</span><span class="sxs-lookup"><span data-stu-id="b13c2-122">Some performance counters were designed for single processor systems and might not be accurate for multiprocessor computers.</span></span> <span data-ttu-id="b13c2-123">Por exemplo, um processo é limitado a 100% de um único processador; no entanto, seus threads podem usar vários processadores, totalizando mais de 100%.</span><span class="sxs-lookup"><span data-stu-id="b13c2-123">For example, a process is limited to 100 percent of a single processor; however, its threads can use several processors, totaling more than 100 percent.</span></span>

<span data-ttu-id="b13c2-124">O \\ valor do contador "processador ( \_ total) \\ % tempo do processador" é o uso médio de todos os processadores.</span><span class="sxs-lookup"><span data-stu-id="b13c2-124">The "\\Processor(\_Total)\\% Processor Time" counter value is the average usage of all processors.</span></span> <span data-ttu-id="b13c2-125">Por exemplo, se você tiver dois processadores, um a 100 por cento e outro em 0%, este contador relatará 50%.</span><span class="sxs-lookup"><span data-stu-id="b13c2-125">For example, if you have two processors, one at 100 percent and another at 0 percent, this counter will report 50 percent.</span></span> <span data-ttu-id="b13c2-126">Portanto, o intervalo é de 0 a 100.</span><span class="sxs-lookup"><span data-stu-id="b13c2-126">So the range is from 0 through 100.</span></span>

<span data-ttu-id="b13c2-127">O \\ valor do contador "processar (X) \\ % tempo de processamento" é a soma do uso do processador por todos os threads do processo X. Por exemplo, em um computador com dois processadores, se um processo tiver dois threads, um que ocupa 75% de uma CPU e o outro, com 80% de outra CPU, esse contador relatará 155%.</span><span class="sxs-lookup"><span data-stu-id="b13c2-127">The "\\Process(X)\\% Process Time" counter value is the sum of the processor usage by all threads of process X. For example, in a computer with two processors, if a process has two threads, one taking up 75 percent of a CPU and the other taking 80 percent of another CPU, this counter will report 155 percent.</span></span> <span data-ttu-id="b13c2-128">O intervalo para esse contador é de 0 a 100 \* ProcessorCount.</span><span class="sxs-lookup"><span data-stu-id="b13c2-128">The range for this counter is from 0 through 100 \* ProcessorCount.</span></span>

<span data-ttu-id="b13c2-129">\* \* Windows Server 2003 e Windows XP: \* \*</span><span class="sxs-lookup"><span data-stu-id="b13c2-129">\*\*Windows Server 2003 and Windows XP:  \*\*</span></span>

<span data-ttu-id="b13c2-130">Você pode receber valores fora do intervalo de valores esperado para uso da CPU.</span><span class="sxs-lookup"><span data-stu-id="b13c2-130">You can receive values outside the expected range of values for CPU usage.</span></span> <span data-ttu-id="b13c2-131">Para calcular a porcentagem de uso da CPU, a PDH precisa de dois exemplos (cada um com um valor bruto e um carimbo de data/hora).</span><span class="sxs-lookup"><span data-stu-id="b13c2-131">To calculate the percentage of CPU usage, PDH needs two samples (each with a raw value and a time stamp).</span></span> <span data-ttu-id="b13c2-132">Como a PDH usa apenas o nome da instância para corresponder aos processos, às vezes ele pode usar dois exemplos de processos diferentes.</span><span class="sxs-lookup"><span data-stu-id="b13c2-132">Because PDH uses only the instance name to match the processes, it can sometimes use two samples from different processes.</span></span> <span data-ttu-id="b13c2-133">Por exemplo, se três processos estiverem sendo amostrados e um processo for encerrado após o terceiro exemplo, outro processo será movido para o slot vagado por esse processo encerrado.</span><span class="sxs-lookup"><span data-stu-id="b13c2-133">For example, if three processes are being sampled and one process is terminated after the third sample, another process will move to the slot vacated by that terminated process.</span></span> <span data-ttu-id="b13c2-134">Como resultado, um contador formatado fornecerá um valor incorreto quando você formatar o quarto exemplo, pois ele está usando o terceiro exemplo do processo encerrado e o quarto exemplo do processo que foi movido para o slot do processo encerrado.</span><span class="sxs-lookup"><span data-stu-id="b13c2-134">As a result, a formatted counter will provide an incorrect value when you format the fourth sample, because it’s using the third sample from the terminated process and the fourth sample from the process that moved into the terminated process's slot.</span></span>

<span data-ttu-id="b13c2-135">A tabela a seguir mostra como isso pode ocorrer se um processo for encerrado enquanto os dados estão sendo coletados.</span><span class="sxs-lookup"><span data-stu-id="b13c2-135">The following table shows how this can occur if a process is terminated while data is being collected.</span></span> <span data-ttu-id="b13c2-136">A tabela mostra cinco exemplos de valor de contador para três instâncias do processo X. Os exemplos são coletados em intervalos de um segundo.</span><span class="sxs-lookup"><span data-stu-id="b13c2-136">The table shows five counter value samples for three instances of process X. The samples are collected in one second intervals.</span></span> <span data-ttu-id="b13c2-137">Depois que o terceiro exemplo for coletado, o processo X no slot 1 será encerrado.</span><span class="sxs-lookup"><span data-stu-id="b13c2-137">After the third sample is collected, process X in slot 1 is terminated.</span></span> <span data-ttu-id="b13c2-138">Quando o processo X no slot 1 é encerrado, o processo X no slot 2 muda para o slot 1.</span><span class="sxs-lookup"><span data-stu-id="b13c2-138">When process X in slot 1 is terminated, process X in slot 2 moves to slot 1.</span></span> <span data-ttu-id="b13c2-139">Quando você coleta a quarta amostra para o processo X no slot 2, o primeiro valor é agora 20 em vez de 1.000, e o segundo valor é 1.500.</span><span class="sxs-lookup"><span data-stu-id="b13c2-139">When you collect the fourth sample for process X in slot 2, the first value is now 20 instead of 1,000, and the second value is 1,500.</span></span> <span data-ttu-id="b13c2-140">Ao Formatar o valor do contador, você obtém 1.480 milissegundos em vez dos 500 milissegundos esperados.</span><span class="sxs-lookup"><span data-stu-id="b13c2-140">When you format the counter value, you get 1,480 milliseconds instead of the expected 500 milliseconds.</span></span> <span data-ttu-id="b13c2-141">Ao Formatar o quinto valor de exemplo, você deve obter o valor esperado.</span><span class="sxs-lookup"><span data-stu-id="b13c2-141">When you format the fifth sample value, you should get the expected value.</span></span>

| <span data-ttu-id="b13c2-142">Amostra</span><span class="sxs-lookup"><span data-stu-id="b13c2-142">Sample</span></span>   | <span data-ttu-id="b13c2-143">Slot 0 para o processo X</span><span class="sxs-lookup"><span data-stu-id="b13c2-143">Slot 0 for process X</span></span> | <span data-ttu-id="b13c2-144">Slot 1 para o processo X</span><span class="sxs-lookup"><span data-stu-id="b13c2-144">Slot 1 for process X</span></span>           | <span data-ttu-id="b13c2-145">Slot 2 para o processo X</span><span class="sxs-lookup"><span data-stu-id="b13c2-145">Slot 2 for process X</span></span>                     |
|----------|----------------------|--------------------------------|------------------------------------------|
| <span data-ttu-id="b13c2-146">Exemplo 1</span><span class="sxs-lookup"><span data-stu-id="b13c2-146">Sample 1</span></span> | <span data-ttu-id="b13c2-147">0</span><span class="sxs-lookup"><span data-stu-id="b13c2-147">0</span></span>                    | <span data-ttu-id="b13c2-148">0</span><span class="sxs-lookup"><span data-stu-id="b13c2-148">0</span></span>                              | <span data-ttu-id="b13c2-149">0</span><span class="sxs-lookup"><span data-stu-id="b13c2-149">0</span></span>                                        |
| <span data-ttu-id="b13c2-150">Exemplo 2</span><span class="sxs-lookup"><span data-stu-id="b13c2-150">Sample 2</span></span> | <span data-ttu-id="b13c2-151">20</span><span class="sxs-lookup"><span data-stu-id="b13c2-151">20</span></span>                   | <span data-ttu-id="b13c2-152">10</span><span class="sxs-lookup"><span data-stu-id="b13c2-152">10</span></span>                             | <span data-ttu-id="b13c2-153">500</span><span class="sxs-lookup"><span data-stu-id="b13c2-153">500</span></span>                                      |
| <span data-ttu-id="b13c2-154">Exemplo 3</span><span class="sxs-lookup"><span data-stu-id="b13c2-154">Sample 3</span></span> | <span data-ttu-id="b13c2-155">40</span><span class="sxs-lookup"><span data-stu-id="b13c2-155">40</span></span>                   | <span data-ttu-id="b13c2-156">20</span><span class="sxs-lookup"><span data-stu-id="b13c2-156">20</span></span>                             | <span data-ttu-id="b13c2-157">1,000</span><span class="sxs-lookup"><span data-stu-id="b13c2-157">1,000</span></span>                                    |
| <span data-ttu-id="b13c2-158">Exemplo 4</span><span class="sxs-lookup"><span data-stu-id="b13c2-158">Sample 4</span></span> | <span data-ttu-id="b13c2-159">60</span><span class="sxs-lookup"><span data-stu-id="b13c2-159">60</span></span>                   | <span data-ttu-id="b13c2-160">1.500 (do slot anterior 2)</span><span class="sxs-lookup"><span data-stu-id="b13c2-160">1,500 (from the former slot 2)</span></span> | <span data-ttu-id="b13c2-161">Não aplicável.</span><span class="sxs-lookup"><span data-stu-id="b13c2-161">Not applicable.</span></span> <span data-ttu-id="b13c2-162">Coletado agora no slot 1.</span><span class="sxs-lookup"><span data-stu-id="b13c2-162">Now collected in slot 1.</span></span> |
| <span data-ttu-id="b13c2-163">Exemplo 5</span><span class="sxs-lookup"><span data-stu-id="b13c2-163">Sample 5</span></span> | <span data-ttu-id="b13c2-164">80</span><span class="sxs-lookup"><span data-stu-id="b13c2-164">80</span></span>                   | <span data-ttu-id="b13c2-165">2\.000</span><span class="sxs-lookup"><span data-stu-id="b13c2-165">2,000</span></span>                          | <span data-ttu-id="b13c2-166">Não aplicável.</span><span class="sxs-lookup"><span data-stu-id="b13c2-166">Not applicable.</span></span> <span data-ttu-id="b13c2-167">Coletado agora no slot 1.</span><span class="sxs-lookup"><span data-stu-id="b13c2-167">Now collected in slot 1.</span></span> |



 

 

 
