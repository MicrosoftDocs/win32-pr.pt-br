---
description: Com a versão 2,0, os contadores de desempenho alteraram a arquitetura para simplificar o processo de fornecimento de dados do contador aos consumidores.
ms.assetid: 37f75b15-3f52-4259-a6d9-5a1a14f88379
title: Fornecendo dados de contador usando a versão 2,0
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: 67976c8a0b6c77582ed8c50c2e5cf753c77fcf6b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "105754613"
---
# <a name="providing-counter-data-using-version-20"></a><span data-ttu-id="679a3-103">Fornecendo dados de contador usando a versão 2,0</span><span class="sxs-lookup"><span data-stu-id="679a3-103">Providing Counter Data Using Version 2.0</span></span>

<span data-ttu-id="679a3-104">Os provedores de dados de desempenho modernos usam um manifesto para definir os dados do contador e usam as APIs do provedor do contador de desempenho para gerenciar dados no contexto do provedor.</span><span class="sxs-lookup"><span data-stu-id="679a3-104">Modern performance data providers use a manifest to define the counter data and use performance counter provider APIs to manage data within the context of the provider.</span></span> <span data-ttu-id="679a3-105">Provedores implementados usando um manifesto e APIs de provedor de contador de desempenho geralmente são chamados de **provedores v2**.</span><span class="sxs-lookup"><span data-stu-id="679a3-105">Providers implemented using a manifest and performance counter provider APIs are often called **V2 providers**.</span></span> <span data-ttu-id="679a3-106">O Windows dá suporte a provedores v2 de modo de usuário no Windows Vista ou em provedores v2 de modo kernel no Windows 7 ou posterior.</span><span class="sxs-lookup"><span data-stu-id="679a3-106">Windows supports user-mode V2 providers on Windows Vista or later and kernel-mode V2 providers on Windows 7 or later.</span></span>

<span data-ttu-id="679a3-107">Esta página descreve os provedores v2 de modo de usuário.</span><span class="sxs-lookup"><span data-stu-id="679a3-107">This page describes user-mode V2 providers.</span></span> <span data-ttu-id="679a3-108">Para obter informações sobre provedores v2 de modo kernel, consulte [monitoramento de desempenho do modo kernel](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span><span class="sxs-lookup"><span data-stu-id="679a3-108">For information about kernel-mode V2 providers, see [Kernel Mode Performance Monitoring](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span></span>

<span data-ttu-id="679a3-109">Em tempo de execução, os provedores v2 funcionam da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="679a3-109">At runtime, V2 providers work as follows:</span></span>

- <span data-ttu-id="679a3-110">O processo do provedor se registra no sistema do contador de desempenho do Windows chamando PerfStartProvider e PerfSetCounterSetInfo.</span><span class="sxs-lookup"><span data-stu-id="679a3-110">The provider process registers itself with the Windows Performance Counter system by calling PerfStartProvider and PerfSetCounterSetInfo.</span></span> <span data-ttu-id="679a3-111">O provedor, opcionalmente, fornece uma função de retorno de chamada que será notificada sobre solicitações do consumidor.</span><span class="sxs-lookup"><span data-stu-id="679a3-111">The provider optionally provides a callback function that will be notified about consumer requests.</span></span>
- <span data-ttu-id="679a3-112">O processo do provedor adiciona ou remove instâncias conforme apropriado usando PerfCreateInstance e PerfDeleteInstance.</span><span class="sxs-lookup"><span data-stu-id="679a3-112">The provider process adds or removes instances as appropriate using PerfCreateInstance and PerfDeleteInstance.</span></span> <span data-ttu-id="679a3-113">O provedor atualiza valores de contador quando eles mudam usando as APIs Perfset \* \* _.</span><span class="sxs-lookup"><span data-stu-id="679a3-113">The provider updates counter values when they change using PerfSet\*\*_ APIs.</span></span>
- <span data-ttu-id="679a3-114">Um consumidor faz uma solicitação de dados de um CounterSet.</span><span class="sxs-lookup"><span data-stu-id="679a3-114">A consumer makes a request for data from a counterset.</span></span> <span data-ttu-id="679a3-115">O sistema verifica se o chamador tem permissões para coletar os dados.</span><span class="sxs-lookup"><span data-stu-id="679a3-115">The system verifies that the caller has permissions to collect the data.</span></span> <span data-ttu-id="679a3-116">Em seguida, o sistema usa um thread de trabalho em execução no processo do provedor para lidar com a solicitação, invocando a função de retorno de chamada do provedor, se apropriado.</span><span class="sxs-lookup"><span data-stu-id="679a3-116">The system then uses a worker thread running in the provider process to handle the request, invoking the provider's callback function if appropriate.</span></span> <span data-ttu-id="679a3-117">O thread de trabalho copia os dados coletados em um buffer gerenciado pelo sistema, e o sistema retorna os dados para o consumidor.</span><span class="sxs-lookup"><span data-stu-id="679a3-117">The worker thread copies the collected data into a system-managed buffer, and the system then returns the data to the consumer.</span></span>

## <a name="steps-to-creating-a-provider"></a><span data-ttu-id="679a3-118">Etapas para criar um provedor</span><span class="sxs-lookup"><span data-stu-id="679a3-118">Steps to creating a provider</span></span>

1. <span data-ttu-id="679a3-119">Escreva um manifesto que defina os dados do contador que seu provedor fornecerá.</span><span class="sxs-lookup"><span data-stu-id="679a3-119">Write a manifest that defines the counter data that your provider will provide.</span></span> <span data-ttu-id="679a3-120">Para obter detalhes sobre como gravar o manifesto, consulte [esquema de contadores de desempenho](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="679a3-120">For details on writing the manifest, see [Performance Counters Schema](performance-counters-schema.md).</span></span>
2. <span data-ttu-id="679a3-121">Use [ctrpp](ctrpp.md) para gerar o código de modelo que você inclui em seu provedor.</span><span class="sxs-lookup"><span data-stu-id="679a3-121">Use [CTRPP](ctrpp.md) to generate the template code that you include in your provider.</span></span> <span data-ttu-id="679a3-122">O código do modelo inclui as estruturas que definem os conjuntos de contadores, as funções [_ *getinitialize* \*](counterinitialize.md) e [**procleanup**](countercleanup.md) e as cadeias de caracteres de recurso.</span><span class="sxs-lookup"><span data-stu-id="679a3-122">The template code includes the structures that define the counter sets, the [_ *CounterInitialize*\*](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions, and the resource strings.</span></span>

   <span data-ttu-id="679a3-123">Seu provedor deve chamar as funções de [**reinicialização**](counterinitialize.md) e de [**contralimpeza**](countercleanup.md) .</span><span class="sxs-lookup"><span data-stu-id="679a3-123">Your provider must call the [**CounterInitialize**](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions.</span></span> <span data-ttu-id="679a3-124">A **Metainicialização** chama a função [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) para registrar o provedor e também chama a função [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) para inicializar o conjunto de contadores.</span><span class="sxs-lookup"><span data-stu-id="679a3-124">The **CounterInitialize** calls the [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) function to register the provider and also calls the [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) function to initialize the counter set.</span></span> <span data-ttu-id="679a3-125">A **metalimpeza** chama a função [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) para remover o registro do provedor.</span><span class="sxs-lookup"><span data-stu-id="679a3-125">The **CounterCleanup** calls the [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) function to remove the provider's registration.</span></span>

3. <span data-ttu-id="679a3-126">Inclua o código de modelo da etapa anterior em seu projeto e conclua seu provedor.</span><span class="sxs-lookup"><span data-stu-id="679a3-126">Include the template code from the previous step in your project and complete your provider.</span></span>

   <span data-ttu-id="679a3-127">Para concluir o provedor, você precisa chamar a função [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) para cada instância do conjunto de contadores que você fornecer.</span><span class="sxs-lookup"><span data-stu-id="679a3-127">To complete the provider, you need to call the [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) function for each instance of the counter set that you provide.</span></span>

   <span data-ttu-id="679a3-128">Para definir os valores do contador, chame uma das seguintes funções:</span><span class="sxs-lookup"><span data-stu-id="679a3-128">To set the counter values, call one of the following functions:</span></span>

   - [<span data-ttu-id="679a3-129">**PerfSetULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="679a3-129">**PerfSetULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulongcountervalue)
   - [<span data-ttu-id="679a3-130">**PerfSetULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="679a3-130">**PerfSetULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulonglongcountervalue)
   - [<span data-ttu-id="679a3-131">**PerfSetCounterRefValue**</span><span class="sxs-lookup"><span data-stu-id="679a3-131">**PerfSetCounterRefValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue)

   <span data-ttu-id="679a3-132">O benefício de usar o [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) é que você não precisa fazer uma chamada de função para definir ou atualizar o valor do contador, basta atualizar sua variável de contador local (a variável para a qual os pontos de referência) e os contadores de desempenho usam o ponteiro para acessar o valor do contador.</span><span class="sxs-lookup"><span data-stu-id="679a3-132">The benefit of using [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) is that you do not have to make a function call to set or update the counter value, you simply update your local counter variable (the variable to which the reference points) and Performance Counters uses the pointer to access the counter value.</span></span>

   <span data-ttu-id="679a3-133">Se você não usar [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), poderá usar as seguintes funções para incrementar ou decrementar o valor do contador:</span><span class="sxs-lookup"><span data-stu-id="679a3-133">If you do not use [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), you can use the following functions to increment or decrement the counter value:</span></span>

   - [<span data-ttu-id="679a3-134">**PerfDecrementULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="679a3-134">**PerfDecrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulongcountervalue)
   - [<span data-ttu-id="679a3-135">**PerfDecrementULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="679a3-135">**PerfDecrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulonglongcountervalue)
   - [<span data-ttu-id="679a3-136">**PerfIncrementULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="679a3-136">**PerfIncrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulongcountervalue)
   - [<span data-ttu-id="679a3-137">**PerfIncrementULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="679a3-137">**PerfIncrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulonglongcountervalue)

   <span data-ttu-id="679a3-138">Antes de o provedor sair, ele deve chamar o [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) para cada instância do conjunto de contadores que ele criou.</span><span class="sxs-lookup"><span data-stu-id="679a3-138">Before the provider exits, it must call the [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) for each counter set instance that it created.</span></span>

   <span data-ttu-id="679a3-139">Se você especificou o atributo de **retorno de chamada** no elemento [**Provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) em seu manifesto ou usou o argumento **-NotificationCallback** ao chamar [ctrpp](ctrpp.md), deverá implementar a função de retorno de chamada [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) .</span><span class="sxs-lookup"><span data-stu-id="679a3-139">If you specified the **callback** attribute in the [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) element in your manifest or used the **-NotificationCallback** argument when calling [CTRPP](ctrpp.md), you must implement the [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) callback function.</span></span> <span data-ttu-id="679a3-140">Você passa a função de retorno de chamada para fazer a [**inicialização**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="679a3-140">You pass the callback function to [**CounterInitialize**](counterinitialize.md).</span></span>

   <span data-ttu-id="679a3-141">Se você usou o **-MemoryRoutines** ao chamar [ctrpp](ctrpp.md), você deve implementar as funções de retorno de chamada [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) e [*freememory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) .</span><span class="sxs-lookup"><span data-stu-id="679a3-141">If you used the **-MemoryRoutines** when calling [CTRPP](ctrpp.md), you must implement the [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) and [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) callback functions.</span></span> <span data-ttu-id="679a3-142">Você passa as funções de retorno de chamada para fazer a [**inicialização**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="679a3-142">You pass the callback functions to [**CounterInitialize**](counterinitialize.md).</span></span>

4. <span data-ttu-id="679a3-143">Ao instalar seu provedor, use a ferramenta LodCtr para gravar o nome do arquivo binário que contém as cadeias de caracteres de recursos localizadas e as IDs de recurso no registro.</span><span class="sxs-lookup"><span data-stu-id="679a3-143">When installing your provider, use the LodCtr tool to write the name of the binary file that contains the localized resource strings and resource IDs to the registry.</span></span> <span data-ttu-id="679a3-144">Para obter detalhes sobre como usar LodCtr, consulte [esquema de contadores de desempenho](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="679a3-144">For details on using LodCtr, see [Performance Counters Schema](performance-counters-schema.md).</span></span>

5. <span data-ttu-id="679a3-145">Ao desinstalar seu provedor, use a ferramenta UnlodCtr para remover as informações do provedor do registro.</span><span class="sxs-lookup"><span data-stu-id="679a3-145">When uninstalling your provider, use the UnlodCtr tool to remove your provider's information from the registry.</span></span>
