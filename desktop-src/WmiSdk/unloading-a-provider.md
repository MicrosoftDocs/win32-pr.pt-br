---
description: Depois que o WMI é concluído com um provedor, ele descarrega o provedor da memória.
ms.assetid: 6116769f-3402-42b3-835d-9bdb0fc27ce0
ms.tgt_platform: multiple
title: Descarregando um provedor
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 123d8c4f6b9d9155cdc22dc435635466956bdb0a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104505665"
---
# <a name="unloading-a-provider"></a><span data-ttu-id="b470b-103">Descarregando um provedor</span><span class="sxs-lookup"><span data-stu-id="b470b-103">Unloading a Provider</span></span>

<span data-ttu-id="b470b-104">Depois que o WMI é concluído com um provedor, ele descarrega o provedor da memória.</span><span class="sxs-lookup"><span data-stu-id="b470b-104">After WMI is finished with a provider, it unloads the provider from memory.</span></span> <span data-ttu-id="b470b-105">O principal motivo pelo qual o WMI descarrega um provedor é conservar os recursos do sistema.</span><span class="sxs-lookup"><span data-stu-id="b470b-105">The primary reason WMI unloads a provider is to conserve system resources.</span></span> <span data-ttu-id="b470b-106">Portanto, você deve adicionar código que permita que o WMI descarregue seu provedor de maneira eficiente.</span><span class="sxs-lookup"><span data-stu-id="b470b-106">Therefore, you must add code that allows WMI to unload your provider in an efficient manner.</span></span> <span data-ttu-id="b470b-107">Ele leva em qualquer lugar do intervalo especificado no controle de cache para duas vezes esse intervalo para que o WMI descarregue um provedor.</span><span class="sxs-lookup"><span data-stu-id="b470b-107">It takes anywhere from the interval specified in the cache control to twice that interval for WMI to unload a provider.</span></span>

<span data-ttu-id="b470b-108">O WMI descarrega um provedor de uma das seguintes maneiras:</span><span class="sxs-lookup"><span data-stu-id="b470b-108">WMI unloads a provider in one of the following ways:</span></span>

-   <span data-ttu-id="b470b-109">Descarregar um provedor depois que o provedor concluir as tarefas fornecidas a ele.</span><span class="sxs-lookup"><span data-stu-id="b470b-109">Unload a provider after the provider finishes the tasks given to it.</span></span>
-   <span data-ttu-id="b470b-110">Descarregar rapidamente todos os provedores quando o usuário desligar o sistema.</span><span class="sxs-lookup"><span data-stu-id="b470b-110">Quickly unload all providers when the user shuts down the system.</span></span> <span data-ttu-id="b470b-111">Observe que o WMI descarrega provedores em processo quando o serviço WMI é desligado da linha de comando.</span><span class="sxs-lookup"><span data-stu-id="b470b-111">Note that WMI unloads in-process providers when the WMI service is shut down from the command line.</span></span>

<span data-ttu-id="b470b-112">Embora o primeiro cenário seja mais comum, você deve escrever seu provedor para ambas as possibilidades.</span><span class="sxs-lookup"><span data-stu-id="b470b-112">While the first scenario is more common, you must write your provider for both possibilities.</span></span>

<span data-ttu-id="b470b-113">As seções a seguir são discutidas neste tópico:</span><span class="sxs-lookup"><span data-stu-id="b470b-113">The following sections are discussed in this topic:</span></span>

-   [<span data-ttu-id="b470b-114">Descarregando um provedor ocioso</span><span class="sxs-lookup"><span data-stu-id="b470b-114">Unloading an Idle Provider</span></span>](#unloading-an-idle-provider)
-   [<span data-ttu-id="b470b-115">Acessando o tempo ocioso de um provedor</span><span class="sxs-lookup"><span data-stu-id="b470b-115">Accessing the Idle Time for a Provider</span></span>](#accessing-the-idle-time-for-a-provider)
-   [<span data-ttu-id="b470b-116">Descarregando um provedor que também é um cliente WMI</span><span class="sxs-lookup"><span data-stu-id="b470b-116">Unloading a Provider That Is Also a WMI Client</span></span>](#unloading-a-provider-that-is-also-a-wmi-client)
-   [<span data-ttu-id="b470b-117">Descarregando um provedor durante o desligamento</span><span class="sxs-lookup"><span data-stu-id="b470b-117">Unloading a Provider During Shutdown</span></span>](#unloading-a-provider-during-shutdown)
-   [<span data-ttu-id="b470b-118">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="b470b-118">Related topics</span></span>](#related-topics)

## <a name="unloading-an-idle-provider"></a><span data-ttu-id="b470b-119">Descarregando um provedor ocioso</span><span class="sxs-lookup"><span data-stu-id="b470b-119">Unloading an Idle Provider</span></span>

<span data-ttu-id="b470b-120">O WMI executa as seguintes ações quando descarrega um provedor ocioso:</span><span class="sxs-lookup"><span data-stu-id="b470b-120">WMI performs the following actions when it unloads an idle provider:</span></span>

-   <span data-ttu-id="b470b-121">Determina se o provedor está ocioso.</span><span class="sxs-lookup"><span data-stu-id="b470b-121">Determines if the provider is idle.</span></span>

    <span data-ttu-id="b470b-122">O WMI usa a propriedade **ClearAfter** para determinar por quanto tempo um provedor pode permanecer ocioso antes de descarregar esse provedor.</span><span class="sxs-lookup"><span data-stu-id="b470b-122">WMI uses the **ClearAfter** property to determine how long a provider may stay idle before unloading that provider.</span></span> <span data-ttu-id="b470b-123">Para obter mais informações, consulte [acessando o tempo ocioso de um provedor](#accessing-the-idle-time-for-a-provider).</span><span class="sxs-lookup"><span data-stu-id="b470b-123">For more information, see [Accessing the Idle Time for a Provider](#accessing-the-idle-time-for-a-provider).</span></span>

-   <span data-ttu-id="b470b-124">Chama o método [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) do provedor.</span><span class="sxs-lookup"><span data-stu-id="b470b-124">Calls the [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) method of the provider.</span></span>

    <span data-ttu-id="b470b-125">Se o provedor era um provedor puro, o [**lançamento**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) remove completamente o provedor da memória ativa.</span><span class="sxs-lookup"><span data-stu-id="b470b-125">If the provider was a pure provider, then [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) completely removes the provider from active memory.</span></span> <span data-ttu-id="b470b-126">No entanto, um provedor não puro pode continuar a ser executado após a **liberação** de chamadas do WMI.</span><span class="sxs-lookup"><span data-stu-id="b470b-126">However, a nonpure provider may continue to run after WMI calls **Release**.</span></span>

## <a name="accessing-the-idle-time-for-a-provider"></a><span data-ttu-id="b470b-127">Acessando o tempo ocioso de um provedor</span><span class="sxs-lookup"><span data-stu-id="b470b-127">Accessing the Idle Time for a Provider</span></span>

<span data-ttu-id="b470b-128">A quantidade mínima de tempo que um provedor permanece ativo é determinada pela propriedade **ClearAfter** .</span><span class="sxs-lookup"><span data-stu-id="b470b-128">The minimum amount of time a provider remains active is determined by the **ClearAfter** property.</span></span> <span data-ttu-id="b470b-129">Você pode encontrar **ClearAfter** em instâncias de classes derivadas do [**\_ \_ CacheControl**](--cachecontrol.md) da classe do sistema WMI no \\ namespace raiz.</span><span class="sxs-lookup"><span data-stu-id="b470b-129">You can find **ClearAfter** in instances of classes derived from the WMI system class [**\_\_CacheControl**](--cachecontrol.md) in the \\root namespace.</span></span>

<span data-ttu-id="b470b-130">A lista a seguir descreve as classes que são derivadas de [**\_ \_ CacheControl**](--cachecontrol.md), que controla o descarregamento do provedor:</span><span class="sxs-lookup"><span data-stu-id="b470b-130">The following list describes the classes that are derived from [**\_\_CacheControl**](--cachecontrol.md), which controls provider unloading:</span></span>

-   [<span data-ttu-id="b470b-131">**\_\_EventConsumerProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="b470b-131">**\_\_EventConsumerProviderCacheControl**</span></span>](--eventconsumerprovidercachecontrol.md)
-   [<span data-ttu-id="b470b-132">**\_\_EventProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="b470b-132">**\_\_EventProviderCacheControl**</span></span>](--eventprovidercachecontrol.md)
-   [<span data-ttu-id="b470b-133">**\_\_EventSinkCacheControl**</span><span class="sxs-lookup"><span data-stu-id="b470b-133">**\_\_EventSinkCacheControl**</span></span>](--eventsinkcachecontrol.md)
-   [<span data-ttu-id="b470b-134">**\_\_ObjectProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="b470b-134">**\_\_ObjectProviderCacheControl**</span></span>](--objectprovidercachecontrol.md)
-   [<span data-ttu-id="b470b-135">**\_\_PropertyProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="b470b-135">**\_\_PropertyProviderCacheControl**</span></span>](--propertyprovidercachecontrol.md)

<span data-ttu-id="b470b-136">Você pode alterar a quantidade mínima de tempo que o WMI permite que um provedor permaneça inativo editando a propriedade **ClearAfter** na instância de controle de cache para um tipo específico de provedor.</span><span class="sxs-lookup"><span data-stu-id="b470b-136">You can change the minimum amount of time that WMI allows a provider to remain inactive by editing the **ClearAfter** property in the cache control instance for a specific type of provider.</span></span> <span data-ttu-id="b470b-137">Por exemplo, para limitar a quantidade de tempo que um provedor de propriedade pode permanecer ocioso, edite a propriedade **ClearAfter** de uma instância [**\_ \_ PropertyProviderCacheControl**](--propertyprovidercachecontrol.md) no \\ namespace raiz.</span><span class="sxs-lookup"><span data-stu-id="b470b-137">For example, to limit the amount of time a property provider can remain idle, you would edit the **ClearAfter** property of a [**\_\_PropertyProviderCacheControl**](--propertyprovidercachecontrol.md) instance in the \\root namespace.</span></span>

## <a name="unloading-a-provider-that-is-also-a-wmi-client"></a><span data-ttu-id="b470b-138">Descarregando um provedor que também é um cliente WMI</span><span class="sxs-lookup"><span data-stu-id="b470b-138">Unloading a Provider That Is Also a WMI Client</span></span>

<span data-ttu-id="b470b-139">Seu provedor pode precisar permanecer um cliente do WMI depois de concluir as funções de provedor que ele foi chamado para executar.</span><span class="sxs-lookup"><span data-stu-id="b470b-139">Your provider may need to remain a client of WMI after it has completed the provider functions it was called to perform.</span></span> <span data-ttu-id="b470b-140">Por exemplo, um provedor de push pode precisar emitir consultas para o WMI.</span><span class="sxs-lookup"><span data-stu-id="b470b-140">For example, a push provider may need to issue queries to WMI.</span></span> <span data-ttu-id="b470b-141">Para obter mais informações, consulte [determinando o status de Push ou pull](determining-push-or-pull-status.md).</span><span class="sxs-lookup"><span data-stu-id="b470b-141">For more information, see [Determining Push or Pull Status](determining-push-or-pull-status.md).</span></span> <span data-ttu-id="b470b-142">Nesse caso, a propriedade **pura** da instância [**\_ \_ Win32Provider**](--win32provider.md) que representa o provedor deve ser definida como **true**.</span><span class="sxs-lookup"><span data-stu-id="b470b-142">In this case, the **Pure** property of the [**\_\_Win32Provider**](--win32provider.md) instance that represents the provider should be set to **TRUE**.</span></span> <span data-ttu-id="b470b-143">Se a propriedade **pura** for definida como **false**, o provedor se prepara para descarregar chamando [**IUnknown:: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) em todos os pontos de interface pendentes quando o WMI chama o método Release de sua interface primária.</span><span class="sxs-lookup"><span data-stu-id="b470b-143">If the **Pure** property is set to **FALSE**, the provider prepares to unload by calling [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) on all outstanding interface points when WMI calls the Release method of its primary interface.</span></span> <span data-ttu-id="b470b-144">Para obter mais informações, consulte a seção comentários em [**\_ \_ Win32Provider**](--win32provider.md).</span><span class="sxs-lookup"><span data-stu-id="b470b-144">For more information, see the Remarks section in [**\_\_Win32Provider**](--win32provider.md).</span></span>

<span data-ttu-id="b470b-145">O procedimento a seguir descreve como implementar um método de liberação para a interface primária do seu provedor.</span><span class="sxs-lookup"><span data-stu-id="b470b-145">The following procedure describes how to implement a release method for the primary interface of your provider.</span></span>

<span data-ttu-id="b470b-146">**Para descarregar um provedor**</span><span class="sxs-lookup"><span data-stu-id="b470b-146">**To unload a provider**</span></span>

1.  <span data-ttu-id="b470b-147">Libere todos os ponteiros de interface mantidos no WMI quando o WMI chama o método [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) da interface primária do seu provedor.</span><span class="sxs-lookup"><span data-stu-id="b470b-147">Release all interface pointers held against WMI when WMI calls the [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) method of the primary interface of your provider.</span></span>

    <span data-ttu-id="b470b-148">Normalmente, um provedor contém ponteiros para as interfaces [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) e [**IWbemContext**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemcontext) fornecidas em [**IWbemProviderInit:: Initialize**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemproviderinit-initialize).</span><span class="sxs-lookup"><span data-stu-id="b470b-148">Typically, a provider holds pointers to the [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) and [**IWbemContext**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemcontext) interfaces supplied in [**IWbemProviderInit::Initialize**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemproviderinit-initialize).</span></span>

2.  <span data-ttu-id="b470b-149">Se a propriedade **pura** na instância do [**\_ \_ Win32Provider**](--win32provider.md) associada for definida como **false**, o provedor poderá fazer a transição para a função do aplicativo cliente após a [**liberação**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release)de chamadas WMI.</span><span class="sxs-lookup"><span data-stu-id="b470b-149">If the **Pure** property in the associated [**\_\_Win32Provider**](--win32provider.md) instance is set to **FALSE**, the provider can transition to the role of client application after WMI calls [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span></span> <span data-ttu-id="b470b-150">No entanto, o WMI não pode descarregar um provedor que esteja operando como um sistema cliente, o que aumenta a sobrecarga do sistema.</span><span class="sxs-lookup"><span data-stu-id="b470b-150">However, WMI cannot unload a provider that is operating as a client system, which increases the system overhead.</span></span>

    <span data-ttu-id="b470b-151">Um provedor com **puro** definido como **true** existe somente para solicitações de serviço.</span><span class="sxs-lookup"><span data-stu-id="b470b-151">A provider with **Pure** set to **TRUE** exists only to service requests.</span></span> <span data-ttu-id="b470b-152">Portanto, esse tipo de provedor não pode assumir a função de um aplicativo cliente e o WMI pode descarregá-lo.</span><span class="sxs-lookup"><span data-stu-id="b470b-152">Therefore, this type of provider cannot take on the role of a client application and WMI can unload it.</span></span>

## <a name="unloading-a-provider-during-shutdown"></a><span data-ttu-id="b470b-153">Descarregando um provedor durante o desligamento</span><span class="sxs-lookup"><span data-stu-id="b470b-153">Unloading a Provider During Shutdown</span></span>

<span data-ttu-id="b470b-154">Em circunstâncias normais, o uso das diretrizes no [descarregamento de um provedor que também é um cliente WMI](#unloading-a-provider-that-is-also-a-wmi-client) permite que o WMI descarregue seu provedor corretamente.</span><span class="sxs-lookup"><span data-stu-id="b470b-154">Under normal circumstances, using the guidelines in [Unloading a Provider That is Also a WMI Client](#unloading-a-provider-that-is-also-a-wmi-client) allows WMI to unload your provider properly.</span></span> <span data-ttu-id="b470b-155">No entanto, você pode se deparar com situações em que o WMI não consegue instigar os procedimentos normais de descarregamento, como quando o usuário opta por desligar o sistema.</span><span class="sxs-lookup"><span data-stu-id="b470b-155">However, you may run into situations where WMI is unable to instigate the normal unloading procedures, such as when the user chooses to shut the system down.</span></span> <span data-ttu-id="b470b-156">Usando um modelo de transação de armazenamento de dados, além de implementar uma boa estratégia de limpeza, você pode garantir que seu provedor seja descarregado corretamente.</span><span class="sxs-lookup"><span data-stu-id="b470b-156">By using a transaction model of data storage, in addition to implementing a good cleanup strategy, you can ensure that your provider is properly unloaded.</span></span>

<span data-ttu-id="b470b-157">O usuário pode parar o WMI a qualquer momento.</span><span class="sxs-lookup"><span data-stu-id="b470b-157">The user may stop WMI at any time.</span></span> <span data-ttu-id="b470b-158">Nessa situação, o WMI não descarrega nenhum provedor ou chama o ponto de entrada do [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow) em qualquer fornecedor em processo.</span><span class="sxs-lookup"><span data-stu-id="b470b-158">In such a situation, WMI does not unload any providers or call the [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow) entry point on any in-process provider.</span></span> <span data-ttu-id="b470b-159">Além disso, se um provedor em processo estiver no meio de uma chamada de método no momento do desligamento, o WMI poderá encerrar o thread em execução no meio da chamada.</span><span class="sxs-lookup"><span data-stu-id="b470b-159">Moreover, if an in-process provider is in the middle of a method call at the time of the shutdown, WMI can possibly terminate the executing thread in the middle of the call.</span></span> <span data-ttu-id="b470b-160">Nessa circunstância, o WMI não chama rotinas que normalmente lidam com a limpeza, como um destruidor de objeto.</span><span class="sxs-lookup"><span data-stu-id="b470b-160">In this circumstance, WMI does not call routines that normally handle cleanup, such as an object destructor.</span></span> <span data-ttu-id="b470b-161">No máximo, o WMI chamará somente [**DllMain**](/windows/desktop/Dlls/dllmain) .</span><span class="sxs-lookup"><span data-stu-id="b470b-161">At most, WMI will call [**DllMain**](/windows/desktop/Dlls/dllmain) only.</span></span>

<span data-ttu-id="b470b-162">Quando o sistema operacional desliga o WMI, o sistema libera automaticamente toda a memória alocada para um provedor em processo.</span><span class="sxs-lookup"><span data-stu-id="b470b-162">When the operating system shuts down WMI, the system automatically releases all memory allocated to an in-process provider.</span></span> <span data-ttu-id="b470b-163">O sistema operacional também fecha a maioria dos recursos mantidos pelo provedor, como identificadores de arquivos, identificadores de janela e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="b470b-163">The operating system also closes most resources held by the provider, such as file handles, window handles, and so on.</span></span> <span data-ttu-id="b470b-164">O provedor não precisa executar nenhuma ação específica para fazer isso acontecer.</span><span class="sxs-lookup"><span data-stu-id="b470b-164">The provider does not need to take any specific action to make this happen.</span></span>

<span data-ttu-id="b470b-165">Como o WMI pode ser desligado no meio de uma chamada, um provedor não deve deixar as fontes de dados em um estado inconsistente.</span><span class="sxs-lookup"><span data-stu-id="b470b-165">Because WMI may shut down in the middle of a call, a provider should not leave data sources in an inconsistent state.</span></span> <span data-ttu-id="b470b-166">Deixar seus dados em um estado inconsistente não é um problema para provedores somente leitura.</span><span class="sxs-lookup"><span data-stu-id="b470b-166">Leaving your data in an inconsistent state is not a problem for read-only providers.</span></span> <span data-ttu-id="b470b-167">No entanto, os provedores com recursos de gravação podem querer implementar algum tipo de modelo de transação para permitir uma reversão segura após um encerramento abrupta.</span><span class="sxs-lookup"><span data-stu-id="b470b-167">However, providers with write capabilities may want to implement some sort of transaction model to allow a safe rollback after an abrupt termination.</span></span>

<span data-ttu-id="b470b-168">Embora o sistema operacional possa liberar alguns recursos gerais do sistema, o sistema não libera automaticamente todos os recursos.</span><span class="sxs-lookup"><span data-stu-id="b470b-168">While the operating system may release some general system resources, the system does not automatically release all resources.</span></span> <span data-ttu-id="b470b-169">Por exemplo, o sistema operacional pode não liberar um soquete ou uma conexão de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="b470b-169">For example, the operating system may not release a socket or a database connection.</span></span> <span data-ttu-id="b470b-170">Em vez disso, o provedor pode precisar limpar manualmente esses recursos.</span><span class="sxs-lookup"><span data-stu-id="b470b-170">Instead, the provider may need to manually clean up such resources.</span></span> <span data-ttu-id="b470b-171">Para evitar esses problemas, você pode implementar seu provedor fora do processo ou pode adicionar o código de limpeza.</span><span class="sxs-lookup"><span data-stu-id="b470b-171">To avoid these problems, you can either implement your provider out-of-process, or you can add cleanup code.</span></span>

<span data-ttu-id="b470b-172">A solução mais simples é implementar seu provedor fora do processo.</span><span class="sxs-lookup"><span data-stu-id="b470b-172">The simplest solution is to implement your provider out-of-process.</span></span> <span data-ttu-id="b470b-173">Um provedor fora do processo não é eliminado quando o WMI é desligado, embora o WMI libere o provedor após um tempo limite de COM.</span><span class="sxs-lookup"><span data-stu-id="b470b-173">An out-of-process provider is not killed when WMI shuts down, although WMI will release the provider after a COM timeout.</span></span> <span data-ttu-id="b470b-174">Provedores para os quais os problemas de robustez de limpeza e término são mais importantes do que o desempenho pode estar fora do processo.</span><span class="sxs-lookup"><span data-stu-id="b470b-174">Providers for whom cleanup and termination robustness issues are more important than performance may be out-of-process.</span></span>

<span data-ttu-id="b470b-175">Se for necessário posicionar o código de limpeza em seu provedor, você terá duas opções.</span><span class="sxs-lookup"><span data-stu-id="b470b-175">If you must place cleanup code in your provider, you have two options.</span></span> <span data-ttu-id="b470b-176">Um lugar para executar esse tipo de limpeza é [**DllMain**](/windows/desktop/Dlls/dllmain), a função do ponto de entrada de dll que o sistema operacional chama ao descarregar a dll.</span><span class="sxs-lookup"><span data-stu-id="b470b-176">One place to perform this sort of cleanup is [**DllMain**](/windows/desktop/Dlls/dllmain), the DLL entry point function the operating system calls when unloading the DLL.</span></span> <span data-ttu-id="b470b-177">O código de limpeza pode ser adicionado diretamente ao **DllMain**, executando-o em resposta à **\_ \_ desanexação do processo de dll**.</span><span class="sxs-lookup"><span data-stu-id="b470b-177">Cleanup code can be added directly into **DllMain**, executing it in response to **DLL\_PROCESS\_DETACH**.</span></span> <span data-ttu-id="b470b-178">A implementação do código de limpeza no **DllMain** pode ser um pouco difícil de organizar, especialmente em ambientes de programação como MFC ou ATL.</span><span class="sxs-lookup"><span data-stu-id="b470b-178">Implementing cleanup code in **DllMain** can be somewhat difficult to arrange, especially in programming environments such as MFC or ATL.</span></span> <span data-ttu-id="b470b-179">Para obter mais informações, consulte o artigo Q148791 da base de dados de conhecimento Microsoft, "*como fornecer seu próprio DllMain em uma DLL regular do MFC".*</span><span class="sxs-lookup"><span data-stu-id="b470b-179">For more information, see the Microsoft Knowledge Base article Q148791, "*How to Provide Your Own DllMain in an MFC Regular DLL.*"</span></span> <span data-ttu-id="b470b-180">(Esse recurso pode não estar disponível em alguns idiomas e países ou regiões.)</span><span class="sxs-lookup"><span data-stu-id="b470b-180">(This resource may not be available in some languages and countries or regions.)</span></span>

<span data-ttu-id="b470b-181">Como alternativa, você também pode posicionar o código de limpeza no destruidor de uma classe global.</span><span class="sxs-lookup"><span data-stu-id="b470b-181">Alternately, you could also place the cleanup code in the destructor of a global class.</span></span> <span data-ttu-id="b470b-182">Para obter mais informações, consulte Descarregando um provedor.</span><span class="sxs-lookup"><span data-stu-id="b470b-182">For more information, see Unloading a Provider.</span></span> <span data-ttu-id="b470b-183">O sistema operacional Windows não aloca objetos globais no heap.</span><span class="sxs-lookup"><span data-stu-id="b470b-183">The Windows operating system does not allocate global objects on the heap.</span></span> <span data-ttu-id="b470b-184">Em vez disso, o sistema operacional chama os destruidores durante o descarregamento da DLL.</span><span class="sxs-lookup"><span data-stu-id="b470b-184">Instead, the operating system calls the destructors during DLL unload.</span></span>

<span data-ttu-id="b470b-185">Veja a seguir um procedimento de limpeza simples que pode ser ajustado dentro de um objeto global para WMI.</span><span class="sxs-lookup"><span data-stu-id="b470b-185">The following is a simple cleanup procedure that could fit inside a global object for WMI.</span></span>


```C++
class CMyCleanup
{
    ~CMyCleanup()
    {
        CloseHandle(m_hOpenFile);
        CloseDatabaseConnection(g_hDatabase);
    }
} g_Cleanup;
```



<span data-ttu-id="b470b-186">Há muitas restrições quanto ao que pode ser feito no código de limpeza com qualquer uma das abordagens.</span><span class="sxs-lookup"><span data-stu-id="b470b-186">There are many restrictions as to what can be done in the cleanup code with either approach.</span></span> <span data-ttu-id="b470b-187">Por exemplo, nem threads nem quaisquer DLLs que não estejam vinculadas implicitamente podem ser acessados de qualquer forma.</span><span class="sxs-lookup"><span data-stu-id="b470b-187">For example, neither threads nor any DLLs that are not implicitly linked may be accessed in any way.</span></span> <span data-ttu-id="b470b-188">Além disso, você não pode fazer chamadas COM em nenhuma circunstância.</span><span class="sxs-lookup"><span data-stu-id="b470b-188">Further, you cannot make COM calls under any circumstances.</span></span>

## <a name="related-topics"></a><span data-ttu-id="b470b-189">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="b470b-189">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="b470b-190">Configurando descritores de segurança namepace</span><span class="sxs-lookup"><span data-stu-id="b470b-190">Setting Namepace Security Descriptors</span></span>](setting-namespace-security-descriptors.md)
</dt> <dt>

[<span data-ttu-id="b470b-191">Protegendo seu provedor</span><span class="sxs-lookup"><span data-stu-id="b470b-191">Securing Your Provider</span></span>](securing-your-provider.md)
</dt> <dt>

[<span data-ttu-id="b470b-192">Desenvolvendo um provedor WMI</span><span class="sxs-lookup"><span data-stu-id="b470b-192">Developing a WMI Provider</span></span>](developing-a-wmi-provider.md)
</dt> </dl>

 

 
