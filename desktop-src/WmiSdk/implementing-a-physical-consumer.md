---
description: Um consumidor físico é um objeto COM que implementa a interface IWbemUnboundObjectSink.
ms.assetid: 497457dc-61ca-4527-89fd-2af0383de5e9
ms.tgt_platform: multiple
title: Implementando um consumidor físico
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: af0a9530ed7a98ce19b3b39f2f5a1fe52f3b0631
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "105814431"
---
# <a name="implementing-a-physical-consumer"></a><span data-ttu-id="1bf0f-103">Implementando um consumidor físico</span><span class="sxs-lookup"><span data-stu-id="1bf0f-103">Implementing a Physical Consumer</span></span>

<span data-ttu-id="1bf0f-104">Um consumidor físico é um objeto COM que implementa a interface [**IWbemUnboundObjectSink**](/windows/desktop/api/Wbemprov/nn-wbemprov-iwbemunboundobjectsink) .</span><span class="sxs-lookup"><span data-stu-id="1bf0f-104">A physical consumer is a COM object that implements the [**IWbemUnboundObjectSink**](/windows/desktop/api/Wbemprov/nn-wbemprov-iwbemunboundobjectsink) interface.</span></span> <span data-ttu-id="1bf0f-105">O WMI carrega seu consumidor físico e passa eventos por meio de **IWbemUnboundObjectSink** em resposta a um ou mais eventos, conforme definido pelo consumidor lógico associado.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-105">WMI loads your physical consumer and passes events through **IWbemUnboundObjectSink** in response to one or more events, as defined by the associated logical consumer.</span></span> <span data-ttu-id="1bf0f-106">Os consumidores permanentes têm requisitos de segurança especiais.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-106">Permanent consumers have special security requirements.</span></span> <span data-ttu-id="1bf0f-107">Para obter mais informações, consulte [SECURING WMI Events](securing-wmi-events.md).</span><span class="sxs-lookup"><span data-stu-id="1bf0f-107">For more information, see [Securing WMI Events](securing-wmi-events.md).</span></span>

<span data-ttu-id="1bf0f-108">O procedimento a seguir descreve como implementar um consumidor físico para um consumidor de evento permanente.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-108">The following procedure describes how to implement a physical consumer for a permanent event consumer.</span></span>

<span data-ttu-id="1bf0f-109">**Para implementar um consumidor físico para um consumidor de evento permanente**</span><span class="sxs-lookup"><span data-stu-id="1bf0f-109">**To implement a physical consumer for a permanent event consumer**</span></span>

1.  <span data-ttu-id="1bf0f-110">Crie um objeto COM.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-110">Create a COM object.</span></span>

    <span data-ttu-id="1bf0f-111">Você deve implementar um consumidor físico como um servidor local ou remoto usando o protocolo COM.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-111">You must implement a physical consumer as a local or remote server using the COM protocol.</span></span>

2.  <span data-ttu-id="1bf0f-112">Determine se você deseja dar suporte à notificação de eventos síncrona ou assíncrona.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-112">Determine if you want to support synchronous or asynchronous event notification.</span></span>

    <span data-ttu-id="1bf0f-113">Com a notificação de eventos assíncronos, o thread de envio não está relacionado ao thread de recebimento.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-113">With asynchronous event notification, the sending thread is unrelated to the receiving thread.</span></span> <span data-ttu-id="1bf0f-114">Portanto, nem o WMI nem o provedor de eventos são bloqueados enquanto o WMI entrega uma notificação para qualquer consumidor registrado para receber o evento.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-114">Therefore, neither WMI nor the event provider gets blocked while WMI delivers a notification to any consumer registered to receive the event.</span></span> <span data-ttu-id="1bf0f-115">A desvantagem da entrega assíncrona é que uma alternância de contexto ocorre entre a hora em que o provedor produz o evento e a hora em que o consumidor recebe o evento.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-115">The disadvantage to asynchronous delivery is that a context switch occurs between the time the provider produces the event and the time the consumer receives the event.</span></span> <span data-ttu-id="1bf0f-116">Para obter mais informações sobre como trabalhar de forma assíncrona, consulte o tópico [fundamentos do com](../com/guide.md) na seção com do SDK (Software Development Kit) do Microsoft Windows.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-116">For more information about working asynchronously, see the [COM Fundamentals](../com/guide.md) topic in the COM section of the Microsoft Windows Software Development Kit (SDK).</span></span> <span data-ttu-id="1bf0f-117">Para obter mais informações sobre alternâncias de contexto, consulte o tópico [alternâncias de contexto](../procthread/context-switches.md) na seção DLLs, processos e threads do SDK do Windows.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-117">For more information about context switches, see the [Context Switches](../procthread/context-switches.md) topic in the DLLs, Processes, and Threads section of the Windows SDK.</span></span>

    > [!Note]  
    > <span data-ttu-id="1bf0f-118">Como o retorno de chamada para o coletor pode não ser retornado no mesmo nível de autenticação que o cliente requer, é recomendável que você use semisynchronous em vez de comunicação assíncrona.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-118">Because the callback to the sink might not be returned at the same authentication level as the client requires, it is recommended that you use semisynchronous instead of asynchronous communication.</span></span> <span data-ttu-id="1bf0f-119">Para obter mais informações, consulte [chamando um método](calling-a-method.md).</span><span class="sxs-lookup"><span data-stu-id="1bf0f-119">For more information, see [Calling a Method](calling-a-method.md).</span></span>

     

    <span data-ttu-id="1bf0f-120">Com a notificação síncrona, o WMI entrega a notificação no mesmo thread que o provedor de eventos usou para entregar o evento ao WMI.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-120">With synchronous notification, WMI delivers the notification on the same thread that the event provider used to deliver the event to WMI.</span></span> <span data-ttu-id="1bf0f-121">Nesse caso, quando um provedor de eventos envia uma notificação, o provedor de eventos é bloqueado pelo WMI até que o WMI forneça a notificação.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-121">In this case, when an event provider sends a notification, the event provider is blocked by WMI until WMI delivers the notification.</span></span> <span data-ttu-id="1bf0f-122">Somente se o seu consumidor for extremamente rápido e puder processar um evento em 100 microssegundos ou menos, você considerará o suporte à notificação síncrona.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-122">Only if your consumer is extremely fast and can process an event in 100 microseconds or less should you consider supporting synchronous notification.</span></span> <span data-ttu-id="1bf0f-123">Os consumidores síncronos que levam muito tempo para processar eventos podem prejudicar seriamente a entrega de eventos a todos os outros consumidores.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-123">Synchronous consumers that take too long to process events can seriously slow the delivery of events to all other consumers.</span></span> <span data-ttu-id="1bf0f-124">Além disso, eles podem bloquear inadvertidamente o provedor.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-124">Furthermore, they can inadvertently block the provider.</span></span> <span data-ttu-id="1bf0f-125">Para obter mais informações, consulte [associando um filtro de eventos a um consumidor lógico](binding-an-event-filter-with-a-logical-consumer.md).</span><span class="sxs-lookup"><span data-stu-id="1bf0f-125">For more information, see [Binding an Event Filter with a Logical Consumer](binding-an-event-filter-with-a-logical-consumer.md).</span></span>

3.  <span data-ttu-id="1bf0f-126">Implemente a função [**IWbemUnboundObjectSink:: IndicateToConsumer**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemunboundobjectsink-indicatetoconsumer) .</span><span class="sxs-lookup"><span data-stu-id="1bf0f-126">Implement the [**IWbemUnboundObjectSink::IndicateToConsumer**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemunboundobjectsink-indicatetoconsumer) function.</span></span>

    <span data-ttu-id="1bf0f-127">O WMI usa a função [**IndicateToConsumer**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemunboundobjectsink-indicatetoconsumer) para passar os ponteiros e eventos necessários para o consumidor físico para comunicações síncronas e assíncronas.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-127">WMI uses the [**IndicateToConsumer**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemunboundobjectsink-indicatetoconsumer) function to pass the necessary pointers and events to your physical consumer for both synchronous and asynchronous communications.</span></span> <span data-ttu-id="1bf0f-128">Sua implementação de **IndicateToConsumer** deve conter todo o código necessário para responder a um evento.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-128">Your implementation of **IndicateToConsumer** should contain all of the necessary code to respond to an event.</span></span>

    <span data-ttu-id="1bf0f-129">Ao contrário de um consumidor de evento temporário, você não precisa chamar a interface [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) para entrar em contato com o WMI.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-129">Unlike a temporary event consumer, you do not need to call the [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) interface to contact WMI.</span></span> <span data-ttu-id="1bf0f-130">Em vez disso, o WMI localiza um ponteiro para o consumidor por meio do provedor de consumidor de eventos.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-130">Instead, WMI locates a pointer to your consumer through the event consumer provider.</span></span> <span data-ttu-id="1bf0f-131">Para obter mais informações, consulte [escrevendo um provedor de consumidor de eventos](writing-an-event-consumer-provider.md).</span><span class="sxs-lookup"><span data-stu-id="1bf0f-131">For more information, see [Writing an Event Consumer Provider](writing-an-event-consumer-provider.md).</span></span>

    <span data-ttu-id="1bf0f-132">No entanto, se você quiser chamar novamente o WMI, use as interfaces [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) e [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) .</span><span class="sxs-lookup"><span data-stu-id="1bf0f-132">However, if you wish to call back into WMI, use the [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) and [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) interfaces.</span></span> <span data-ttu-id="1bf0f-133">O método tradicional para se conectar ao WMI é durante o processo de inicialização do seu objeto COM.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-133">The traditional method for connecting to WMI is during the initialization process of your COM object.</span></span> <span data-ttu-id="1bf0f-134">Para obter mais informações, consulte [criando um aplicativo ou script WMI](creating-a-wmi-application-or-script.md).</span><span class="sxs-lookup"><span data-stu-id="1bf0f-134">For more information, see [Creating a WMI Application or Script](creating-a-wmi-application-or-script.md).</span></span>

    <span data-ttu-id="1bf0f-135">Se você implementar o consumidor físico como um servidor COM em processo e se conectar ao WMI separadamente do processo de inicialização, deverá usar o identificador de classe **\_ WbemAdministrativeLocator do CLSID** para acessar a interface [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) na chamada para [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance).</span><span class="sxs-lookup"><span data-stu-id="1bf0f-135">If you implement your physical consumer as an in-process COM server and connect to WMI separately from the initialization process, you must use the **CLSID\_WbemAdministrativeLocator** class identifier to access the [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) interface in the call to [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance).</span></span>

    <span data-ttu-id="1bf0f-136">O exemplo a seguir mostra como usar o identificador de classe **\_ WbemAdministrativeLocator do CLSID** para acessar a interface [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) .</span><span class="sxs-lookup"><span data-stu-id="1bf0f-136">The following example shows how to use the **CLSID\_WbemAdministrativeLocator** class identifier to access the [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) interface.</span></span>

    ```C++
    IWbemLocator *pLoc = 0;

    DWORD dwRes = CoCreateInstance(CLSID_WbemAdministrativeLocator, 0, 
        CLSCTX_INPROC_SERVER, IID_IWbemLocator, (LPVOID *) &pLoc);
    ```

    

    <span data-ttu-id="1bf0f-137">A interface [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) Obtém o ponteiro de namespace inicial para o WMI em um computador host específico.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-137">The [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) interface obtains the initial namespace pointer to WMI on a particular host computer.</span></span> <span data-ttu-id="1bf0f-138">A falha ao usar o identificador **\_ WbemAdministrativeLocator do CLSID** na chamada [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) resulta em um erro de "acesso negado".</span><span class="sxs-lookup"><span data-stu-id="1bf0f-138">Failure to use the **CLSID\_WbemAdministrativeLocator** identifier in the [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) call results in an "access denied" error.</span></span>

    <span data-ttu-id="1bf0f-139">Em circunstâncias usuais, o WMI fornece eventos assíncronos para o cliente, um de cada vez.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-139">Under usual circumstances, WMI delivers asynchronous events to the client one at a time.</span></span> <span data-ttu-id="1bf0f-140">No entanto, se um cliente não puder receber notificações de evento assíncrono tão rápido quanto os eventos chegarem, o WMI começará a enviar eventos em lote automaticamente em uma única chamada.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-140">However, if a client cannot receive asynchronous event notifications as fast as the events arrive, WMI starts to automatically batch events into a single call.</span></span> <span data-ttu-id="1bf0f-141">O envio em lote automático ajuda se os tempos de ida e volta são um problema, como geralmente é o caso em cenários de alta taxa de transferência.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-141">Automatic batching helps if the round-trip times are a problem, as is often the case in high-throughput scenarios.</span></span> <span data-ttu-id="1bf0f-142">No entanto, o envio em lote não melhora o desempenho do sistema se o cliente ou a largura de banda da rede estiverem em falha.</span><span class="sxs-lookup"><span data-stu-id="1bf0f-142">However, batching does not improve system performance if the client or the network bandwidth are at fault.</span></span>

 

 
