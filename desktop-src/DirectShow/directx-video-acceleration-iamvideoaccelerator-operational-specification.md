---
description: Especificação operacional do IAMVideoAccelerator de aceleração de vídeo DirectX
ms.assetid: 25ee05d5-8554-4739-9122-e3c0255bf965
title: Especificação operacional do IAMVideoAccelerator de aceleração de vídeo DirectX
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3360e18e91197f2a15a36fb112f0419b6382e915
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/06/2021
ms.locfileid: "103919710"
---
# <a name="directx-video-acceleration-iamvideoaccelerator-operational-specification"></a>Especificação operacional do IAMVideoAccelerator de aceleração de vídeo DirectX

O mecanismo preciso de operação é o seguinte:

1.  Cada perfil de modo restrito definido neste documento tem um GUID VA do DirectX associado, que pode ser suportado por um pino de entrada downstream [**IPin:: QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) e [**IPin:: ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) e listado em [**IAMVideoAccelerator:: GetVideoAcceleratorGUIDs**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getvideoacceleratorguids).
2.  Da mesma forma, cada tipo de protocolo de criptografia para uso com DirectX VA deve ter um GUID de tipo de protocolo de criptografia associado, que pode ser suportado por um pino de entrada downstream [**IPin:: QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) e [**IPin:: ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) e listado em **IAMVideoAccelerator:: GetVideoAcceleratorGUIDs**. O GUID de "sem criptografia" DXVA \_ noencrypt não deve ser enviado nesta lista, pois o suporte para ele é necessário e, portanto, implícito.
3.  Depois de chamar [**IPin:: ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) para tentar uma conexão com o pino de entrada downstream, o [**IAMVideoAcceleratorNotify:: GetCreateVideoAcceleratorData**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getcreatevideoacceleratordata) do decodificador deve retornar um ponteiro para uma estrutura de dados de conexão de DXVA \_ que contém as informações do modo de conexão para a conexão. [**IAMVideoAccelerator:: GetCompBufferInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getcompbufferinfo) deve ser chamado com \* pdwNumTypesCompBuffers = 16 e deve retornar informações de buffer compactadas com base na Convenção de que o número de tipo de cada buffer (conforme definido na seção 3,4 da especificação do DirectX VA) pode ser usado diretamente como o índice de base zero na matriz de estruturas de dados **AMVACompBufferInfo** que é retornada. Isso requer que, para qualquer tipo de buffer que não seja usado (incluindo o tipo de buffer 0, como não há nenhum uso definido desse tipo de buffer), o driver de acelerador fornecerá estruturas de dados AMVACompBufferInfo com alguma forma de valores de parâmetro "fictícios" (como dwNumCompBuffers = 0, dwWidthToCreate = 0, dwHeightToCreate = 0 e dwBytesToAllocate = 0).
4.  As indicações de função DXVA e os buffers de dados associados são enviados usando [**IAMVideoAccelerator:: execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute). A função DXVA é indicada no parâmetro dwFunction da chamada. As únicas funções de DXVA que são relevantes para a inicialização são a DXVA \_ ConfigQueryOrReplyFunc e a DXVA \_ EncryptProtocolFunc.
    -   Se dwFunction contiver um DXVA \_ ConfigQueryOrReplyFunc, o ponteiro lpPrivateInputData para passar dados para o acelerador nessa chamada deverá apontar para uma estrutura de dados de configuração, o ponteiro lpPrivateOutputData para receber informações do acelerador deve apontar para uma área em que uma estrutura de dados de configuração alternativa ou duplicada pode ser colocada, o ponteiro pamvaBufferInfo para uma matriz de AMVABUFFERINFO deve ser **nulo** e dwNumBuffers deve ser zero. O HRESULT retornado contém a \_ indicação s OK ou s \_ false ou \_ falha ou \_ INVALIDARG ou alguma outra indicação de erro HRESULT no caso de um problema grave na execução do protocolo (como um parâmetro de configuração inválido). Todas as chamadas para **IAMVideoAccelerator:: execute** para todos os usos de DXVA \_ ConfigQueryOrReplyFunc devem preceder todas as outras chamadas para **IAMVideoAccelerator:: execute**.
    -   Se dwFunction contiver um DXVA \_ EncryptProtocolFunc, o ponteiro lpPrivateInputData para passar dados para o acelerador nessa chamada deverá apontar para uma estrutura de dados de protocolo de criptografia que comece com o DXVA \_ EncryptProtocolHeader, o ponteiro lpPrivateOutputData para receber informações do acelerador deve apontar para uma área em que os dados a serem retornados (como um certificado) pelo protocolo de criptografia (que começará com o DXVA \_ EncryptProtocolHeader) podem ser colocados, o ponteiro pamvaBufferInfo para uma matriz de AMVABUFFERINFO deve ser **nulo** e dwNumBuffers deve ser zero. O HRESULT retornado contém S \_ OK, desde que o protocolo de criptografia esteja funcionando normalmente e contenha e \_ falhe ou e \_ INVALIDARG ou alguma outra indicação de erro HRESULT no caso de um problema grave na execução do protocolo.

        Após a inicialização da operação no modo anterior, a operação real do decodificador continua da seguinte maneira:

5.  **IAMVideoAccelerator:: BeginFrame** deve ser chamado antes de enviar qualquer bDXVA \_ Func com parâmetros de buffer compactados que causam gravações em uma superfície de destino descompactada. A finalidade de [**IAMVideoAccelerator:: BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) no DirectX VA é associar as superfícies de destino a valores de índice e notificar o driver de acelerador de vídeo da intenção de iniciar a gravação de uma superfície para que o driver possa responder com uma indicação de se a superfície está pronta para ser substituída. A estrutura **AMVABeginFrameInfo** passada em **IAMVideoAccelerator:: BeginFrame** deve conter um ponteiro pInputData para o parâmetro single Word wBeginPictureIndex que corresponde ao índice de quadro passado em **IAMVideoAccelerator:: BeginFrame** (e dwSizeInputData deve ser 2). Este é o índice a ser usado em um buffer compactado para gravar uma gravação na superfície (por exemplo, para ser usado como wDecodedPictureIndex, wDeblockedPictureIndex, wBlendedDestinationIndex ou wPicResampleDestPicIndex). Cada chamada para **IAMVideoAccelerator:: BeginFrame** deve ser emparelhada com uma chamada correspondente para [**IAMVideoAccelerator:: endframe**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) conforme descrito abaixo. Por exemplo, se uma imagem compactada for decodificada e alfa combinada usando a mesclagem de buffer de front-end para buffer com uma imagem gráfica, haveria uma chamada para **IAMVideoAccelerator:: BeginFrame** antes de decodificar a imagem compactada em uma superfície especificada em wDecodedPictureIndex, em seguida, uma chamada para **IAMVideoAccelerator:: endframe** depois de passar todos os buffers compactados usados para decodificar a imagem e, em seguida, uma segunda chamada para **IAMVideoAccelerator:: BeginFrame** antes de fazer o comando da combinação de mistura alfa da origem gráfica com a imagem decodificada em uma superfície especificada em wBlendedDestinationIndex e depois uma segunda chamada para **IAMVideoAccelerator:: endframe** após a operação de combinação O ponteiro pOutputData em AMVABeginFrameInfo deve ser **nulo** (e dwSizeOutputData deve ser "0"). O HRESULT retornado por **IAMVideoAccelerator:: BeginFrame** deve ser:
    -   S \_ OK se a superfície não compactada estiver disponível e pronta para uso.
    -   E \_ pendente se a superfície descompactada ainda não estiver disponível para uso, mas será disponibilizada em breve (se a superfície não compactada estiver sendo lida para exibição e a leitura/exibição da superfície ainda não tiver sido concluída).
    -   E \_ Fail ou \_ INVALIDARG alguma outra indicação de erro somente se um erro de protocolo ou formato de dados for detectado (como um valor incorreto de dwSizeInputData ou um POutputData não **nulo** ).
6.  As indicações de função DXVA e os buffers de dados associados são enviados usando **IAMVideoAccelerator:: execute**. Mais de um \_ valor de Func bDXVA pode ser indicado na mesma chamada para [**IAMVideoAccelerator:: execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute). Os \_ valores de Func bDXVA devem ser incluídos no parâmetro dwFunction da chamada, com o primeiro comando Function nos oito MSBs, o próximo comando nos próximos oito bits e assim por diante, com quaisquer bits restantes preenchidos com zeros. O valor 0xFF para bDXVA \_ Func indica que o \_ Func bDXVA é estendido para dois ou quatro bytes. Se o segundo byte também for 0xFF, isso indica que bDXVA \_ Func é estendido para quatro bytes. Se os quatro bits superiores do terceiro byte forem 0xF ou 0x0, isso indica que bDXVA \_ Func contém um DXVA \_ CONFIGQUERYORREPLYFUNC ou DXVA \_ EncryptProtocolFunc. Comandos de vários bytes não devem indicar continuação após o final do dwFunction. É necessário tomar cuidado com o decodificador para garantir que nenhuma dependência sequencial esteja presente entre diferentes \_ valores de Func bDXVA especificados na mesma chamada para **IAMVideoAccelerator:: execute** e que todas as possíveis condições de corrida (como entre a decodificação de imagem e a mesclagem de subimagem, entre o carregamento de subimagem e a mesclagem de subimagem e assim por diante) são impedidas por chamadas apropriadas para **IAMVideoAccelerator:: BeginFrame** e [**IAMVideoAccelerator:: QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) antes de chamadas subsequentes para **IAMVideoAccelerator:: execute**.
    -   Se dwFunction contiver um DXVA \_ ConfigQueryOrReplyFunc, o ponteiro lpPrivateInputData para passar dados para o acelerador nessa chamada deverá apontar para uma estrutura de dados de configuração, o ponteiro lpPrivateOutputData para receber informações do acelerador deve apontar para uma área em que uma estrutura de dados de configuração alternativa ou duplicada pode ser colocada, o ponteiro pamvaBufferInfo para uma matriz de AMVABUFFERINFO deve ser **nulo** e dwNumBuffers deve ser zero. O HRESULT retornado contém a \_ indicação s OK ou s \_ false em resposta à consulta, ou e \_ falha ou e \_ INVALIDARG alguma outra indicação de erro HRESULT no caso de um problema grave na execução do protocolo (como um parâmetro invalid.configuração). Todas as chamadas para **IAMVideoAccelerator:: execute** para todos os usos de DXVA \_ ConfigQueryOrReplyFunc devem preceder todas as outras chamadas para **IAMVideoAccelerator:: execute**.
    -   Se dwFunction contiver um DXVA \_ EncryptProtocolFunc, o ponteiro lpPrivateInputData para passar dados para o acelerador nessa chamada deverá apontar para uma estrutura de dados de protocolo de criptografia que comece com o DXVA \_ EncryptProtocolHeader, o ponteiro lpPrivateOutputData para receber informações do acelerador deve apontar para uma área em que os dados a serem retornados (como um certificado) pelo protocolo de criptografia (que começará com o DXVA \_ EncryptProtocolHeader) podem ser colocados, o ponteiro pamvaBufferInfo para uma matriz de AMVABUFFERINFO deve ser **nulo** e dwNumBuffers deve ser zero. O HRESULT retornado contém S \_ OK, desde que o protocolo de criptografia esteja funcionando normalmente e contenha e \_ falhe ou e \_ INVALIDARG ou alguma outra indicação de erro HRESULT no caso de um problema grave na execução do protocolo.
    -   Se dwFunction não contiver um DXVA \_ ConfigQueryOrReplyFunc ou DXVA \_ EncryptProtocolFunc, o ponteiro lpPrivateInputData para passar dados para o acelerador deverá apontar para uma lista de descrição do buffer. As quatro primeiras entradas na estrutura da lista de descrição do buffer para cada buffer (dwTypeIndex, dwBufferIndex, dwDataOffset e dwDataSize) devem ser iguais àquelas na estrutura de dados AMVABUFFERINFO para o mesmo buffer. Se bDXVA \_ Func for igual a "1" for especificado em dwFunction e bPicReadbackRequests for "1", o ponteiro lpPrivateOutputData para receber informações do acelerador deve apontar para uma área de memória persistente (por exemplo, heap) a ser preenchida com os dados de macrobloco de leitura do acelerador (esses dados não são garantidos até **IAMVideoAccelerator:: QueryRenderStatus** para gravar nos mesmos parâmetros de imagem. o buffer indica S \_ OK, conforme descrito no item 10 abaixo). Caso contrário, o ponteiro lpPrivateOutputData para receber informações do acelerador deve apontar para um único DWORD a ser definido como um dos seguintes valores de indicação (particularmente útil para relatar erros fragmentado na operação VLD fora do host).

        | Valor | Descrição                                     |
        |-------|-------------------------------------------------|
        | 0     | Execução OK.                                   |
        | 1     | Foi encontrado um problema secundário no formato de dados.       |
        | 2     | Foi encontrado um problema significativo no formato de dados. |
        | 3     | Foi encontrado um problema grave no formato de dados.      |
        | 4     | Outro problema grave encontrado.               |

        

         

        Se qualquer tipo de problema "grave" for indicado, o decodificador de software deverá parar de operar a (s) função (ões), a menos que a ação corretiva possa ser tomada. Esses dados retornados do acelerador não devem ser lidos pelo host até que a renderização do buffer para a imagem seja concluída, pois pode ser testada por [**IAMVideoAccelerator:: QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus). O HRESULT retornado contém S \_ OK, desde que a operação de interface esteja funcionando normalmente e possa retornar e \_ falhar ou \_ INVALIDARG ou alguma outra indicação de erro HRESULT no caso de um problema grave.

7.  O buffer de parâmetros de decodificação de imagem deve estar entre os primeiros buffers enviados para a decodificação de cada imagem ao usar [**IAMVideoAccelerator:: execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute) com bDXVA \_ Func igual a "1", e todos os buffers para decodificar uma imagem em um fragmentado devem ser enviados antes de qualquer buffer para decodificar imagens subsequentes. Se um buffer de comando de controle macrobloco for enviado, um buffer de dados de diferença residual correspondente deverá ser enviado (contendo dados para o mesmo macroblocos) com a mesma chamada **IAMVideoAccelerator:: execute** .
8.  [**IAMVideoAccelerator:: endframe**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) deve ser chamado depois que todos os buffers compactados tiverem sido enviados que causarão a criação do conteúdo de saída em uma superfície descompactada especificada (um resultado de operações especificadas para WDecodedPictureIndex, WDeblockedPictureIndex, WBlendedDestinationIndex ou wPicResampleDestPicIndex). A finalidade dessa chamada para **IAMVideoAccelerator:: endframe** é notificar o hardware acelerador de vídeo que todos os dados necessários para a operação especificada foram enviados. O ponteiro para dados para enviar downstream por meio de **IAMVideoAccelerator:: endframe** deve apontar para uma única palavra wEndPictureIndex que contém o índice do quadro que está terminando. Esse parâmetro deve corresponder ao valor de wBeginPictureIndex especificado na chamada anterior para [**IAMVideoAccelerator:: BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) antes do envio dos buffers compactados relevantes. Subsequentemente para uma chamada para **IAMVideoAccelerator:: endframe**, a superfície não compactada com o índice wEndPictureIndex não será encontrada nas WDecodedPictureIndex, WDeblockedPictureIndex, WBlendedDestinationIndex ou wPicResampleDestPicIndex de qualquer imagem até que outra chamada para **IAMVideoAccelerator:: BeginFrame** seja emitida para anunciar que isso ocorrerá e um s \_ OK tenha sido retornado como resultado. No entanto, esse índice de superfície de destino pode ocorrer em comandos de acesso de leitura subsequentes, como wForwardRefPictureIndex, wBackwardRefPictureIndex, wPicResampleSourcePicIndex ou bRefPicSelect \[ i \] . O HRESULT retornado por **IAMVideoAccelerator:: endframe** deve ser S \_ OK, a menos que haja algum tipo de formato de dados ou erro de protocolo; nesse caso, ele pode ser e \_ Fail ou \_ INVALIDARG ou alguma outra indicação de erro.
9.  No caso da decodificação baseada em campo (por exemplo, em MPEG-2 fragmentado), não haverá um mapeamento um-para-um de imagens funcionais no fragmentado para superfícies descompactadas na interface do acelerador. Ao decodificar imagens de campo em um fragmentado MPEG-2, haverá duas "imagens" decodificadas para produzir uma superfície não compactada de saída completa. Na definição de interface do DirectX VA, cada quadro corresponde a cada uso de wDecodedPictureIndex, wDeblockedPictureIndex, wBlendedDestinationIndex ou wPicResampleDestPicIndex. Portanto, dois pares de chamadas para **IAMVideoAccelerator:: BeginFrame** e **IAMVideoAccelerator:: endframe** são necessários para a decodificação de imagens de campo em superfícies não compactadas de saída.
10. Uma chamada para [**IAMVideoAccelerator:: QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) com dwFlags igual a zero que ocorre em algum momento após uma chamada para **IAMVideoAccelerator:: endframe** com um wEndPictureIndex específico e verifica o status de um buffer que foi enviado que continha o WEndPictureIndex em WDecodedPictureIndex, WDeblockedPictureIndex, wBlendedDestinationIndex ou WPicResampleDestPicIndex retornará uma \_ indicação S ok se todas as operações para gravar os dados na superfície descompactada forem concluídas e retornarão e serão \_ pendentes se a operação ainda não tiver sido concluída. E \_ Fail ou \_ INVALIDARG ou alguma outra indicação de erro pode ser retornada no caso de um erro de protocolo.

## <a name="related-topics"></a>Tópicos relacionados

<dl> <dt>

[Mapeando a aceleração de vídeo DirectX para IAMVideoAccelerator](mapping-directx-video-acceleration-to-iamvideoaccelerator.md)
</dt> </dl>

 

 



