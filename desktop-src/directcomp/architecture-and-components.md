---
title: Arquitetura e componentes
description: Este tópico descreve os componentes que compõem o Microsoft DirectComposition.
ms.assetid: 7C79B330-41EA-4BA0-9103-BB5A0C3D4CE2
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fb2de495aa170560b1e7082cacf1893a8c94905a
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/20/2020
ms.locfileid: "104007982"
---
# <a name="architecture-and-components"></a><span data-ttu-id="afbc6-103">Arquitetura e componentes</span><span class="sxs-lookup"><span data-stu-id="afbc6-103">Architecture and components</span></span>

> [!NOTE]
> <span data-ttu-id="afbc6-104">Para aplicativos no Windows 10, é recomendável usar APIs do Windows. UI. composição em vez de DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="afbc6-104">For apps on Windows 10, we recommend using Windows.UI.Composition APIs instead of DirectComposition.</span></span> <span data-ttu-id="afbc6-105">Para obter mais informações, consulte [modernizar seu aplicativo de área de trabalho usando a camada Visual](/windows/uwp/composition/visual-layer-in-desktop-apps).</span><span class="sxs-lookup"><span data-stu-id="afbc6-105">For more info, see [Modernize your desktop app using the Visual layer](/windows/uwp/composition/visual-layer-in-desktop-apps).</span></span>

<span data-ttu-id="afbc6-106">Este tópico descreve os componentes que compõem o Microsoft DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="afbc6-106">This topic describes the components that make up Microsoft DirectComposition.</span></span> <span data-ttu-id="afbc6-107">Ele consiste nas seções a seguir.</span><span class="sxs-lookup"><span data-stu-id="afbc6-107">It consists of the following sections.</span></span>

-   [<span data-ttu-id="afbc6-108">Componentes de software</span><span class="sxs-lookup"><span data-stu-id="afbc6-108">Software components</span></span>](#software-components)
-   [<span data-ttu-id="afbc6-109">Biblioteca de aplicativos</span><span class="sxs-lookup"><span data-stu-id="afbc6-109">Application library</span></span>](#application-library)
-   [<span data-ttu-id="afbc6-110">Mecanismo de composição</span><span class="sxs-lookup"><span data-stu-id="afbc6-110">Composition engine</span></span>](#composition-engine)
-   [<span data-ttu-id="afbc6-111">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="afbc6-111">Related topics</span></span>](#related-topics)

## <a name="software-components"></a><span data-ttu-id="afbc6-112">Componentes de software</span><span class="sxs-lookup"><span data-stu-id="afbc6-112">Software components</span></span>

<span data-ttu-id="afbc6-113">O DirectComposition consiste nos principais componentes de software a seguir.</span><span class="sxs-lookup"><span data-stu-id="afbc6-113">DirectComposition consists of the following main software components.</span></span>

-   <span data-ttu-id="afbc6-114">Uma biblioteca de aplicativos no modo de usuário (dcomp.dll) que implementa a API pública baseada em Component Object Model (COM).</span><span class="sxs-lookup"><span data-stu-id="afbc6-114">A user-mode application library (dcomp.dll) that implements the Component Object Model (COM)-based public API.</span></span>
-   <span data-ttu-id="afbc6-115">Um mecanismo de composição de modo de usuário (dwmcore.dll) hospedado no processo de Gerenciador de Janelas da Área de Trabalho (DWM) (dwm.exe) e executa a composição real da área de trabalho.</span><span class="sxs-lookup"><span data-stu-id="afbc6-115">A user-mode composition engine (dwmcore.dll) that is hosted in the Desktop Window Manager (DWM) process (dwm.exe), and performs the actual desktop composition.</span></span>
-   <span data-ttu-id="afbc6-116">Um banco de dados de objetos no modo kernel (parte do win32k.sys) que realiza marshaling de comandos do aplicativo para o mecanismo de composição.</span><span class="sxs-lookup"><span data-stu-id="afbc6-116">A kernel-mode object database (part of win32k.sys) that marshals commands from the application to the composition engine.</span></span>

<span data-ttu-id="afbc6-117">Uma única instância do mecanismo de composição manipula as árvores de composição DirectComposition para todos os aplicativos e a árvore de composição do DWM, que representa a área de trabalho inteira.</span><span class="sxs-lookup"><span data-stu-id="afbc6-117">A single instance of the composition engine handles the DirectComposition composition trees for all applications and the DWM composition tree, which represents the entire desktop.</span></span> <span data-ttu-id="afbc6-118">Tanto o banco de dados de objetos do modo kernel quanto o mecanismo de composição do modo de usuário são instanciados uma vez por sessão, de modo que um computador Terminal Server com vários usuários tenha várias instâncias de ambos os componentes.</span><span class="sxs-lookup"><span data-stu-id="afbc6-118">Both the kernel-mode object database and the user-mode composition engine are instantiated once per session, so a Terminal Server machine with multiple users has multiple instances of both of those components.</span></span>

<span data-ttu-id="afbc6-119">O diagrama a seguir mostra os principais componentes do DirectComposition e como eles se relacionam uns com os outros.</span><span class="sxs-lookup"><span data-stu-id="afbc6-119">The following diagram shows the main DirectComposition components and how they relate to one another.</span></span>

![arquitetura de nível superior do directcomposition](images/directcomposition-top-level-architecture.png)

## <a name="application-library"></a><span data-ttu-id="afbc6-121">Biblioteca de aplicativos</span><span class="sxs-lookup"><span data-stu-id="afbc6-121">Application library</span></span>

<span data-ttu-id="afbc6-122">A biblioteca de aplicativos DirectComposition é uma API pública baseada em com com um único ponto de entrada simples que é exportado de dcomp.dll e retorna um ponteiro de interface para um objeto de dispositivo.</span><span class="sxs-lookup"><span data-stu-id="afbc6-122">The DirectComposition application library is a public COM-based API with a single flat entry-point that is exported from dcomp.dll and returns an interface pointer to a device object.</span></span> <span data-ttu-id="afbc6-123">O objeto de dispositivo, por sua vez, tem métodos para criar todos os outros objetos, cada um dos quais é representado por um ponteiro de interface.</span><span class="sxs-lookup"><span data-stu-id="afbc6-123">The device object, in turn, has methods for creating all other objects, each of which is represented by an interface pointer.</span></span> <span data-ttu-id="afbc6-124">Todas as interfaces DirectComposition herdam de e implementam totalmente a interface [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) .</span><span class="sxs-lookup"><span data-stu-id="afbc6-124">All DirectComposition interfaces inherit from and fully implement the [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) interface.</span></span> <span data-ttu-id="afbc6-125">Todos os métodos que aceitam interfaces DirectComposition verificam se a interface é implementada dentro de dcomp.dll ou se ela é implementada por outro componente.</span><span class="sxs-lookup"><span data-stu-id="afbc6-125">All methods that accept DirectComposition interfaces check whether the interface is implemented inside of dcomp.dll or whether it is implemented by another component.</span></span> <span data-ttu-id="afbc6-126">Como DirectComposition não é extensível, os métodos que usam interfaces como parâmetros retornam E \_ INVALIDARG se as interfaces não estiverem implementadas no dcomp.dll.</span><span class="sxs-lookup"><span data-stu-id="afbc6-126">Because DirectComposition is not extensible, methods that take interfaces as parameters return E\_INVALIDARG if the interfaces are not implemented in dcomp.dll.</span></span> <span data-ttu-id="afbc6-127">A API não requer nenhum privilégio especial; Ele pode ser chamado por processos em execução no nível mais baixo de acesso.</span><span class="sxs-lookup"><span data-stu-id="afbc6-127">The API requires no special privileges; it can be called by processes running at the lowest level of access.</span></span> <span data-ttu-id="afbc6-128">No entanto, como a API não opera na sessão 0, ela não é adequada para serviços.</span><span class="sxs-lookup"><span data-stu-id="afbc6-128">However, because the API does not operate in session 0, it is not suitable for services.</span></span> <span data-ttu-id="afbc6-129">Nesses aspectos, a API DirectComposition é semelhante a outras APIs do Microsoft DirectX, principalmente Direct2D, Microsoft Direct3D e Microsoft DirectWrite.</span><span class="sxs-lookup"><span data-stu-id="afbc6-129">In these respects, the DirectComposition API is similar to other Microsoft DirectX APIs, most notably Direct2D, Microsoft Direct3D, and Microsoft DirectWrite.</span></span>

<span data-ttu-id="afbc6-130">Como o mecanismo de composição é projetado exclusivamente para execução assíncrona, as propriedades de objeto na API DirectComposition são somente gravação.</span><span class="sxs-lookup"><span data-stu-id="afbc6-130">Because the composition engine is designed exclusively for asynchronous execution, object properties in the DirectComposition API are write-only.</span></span> <span data-ttu-id="afbc6-131">Todas as propriedades têm métodos setter, mas não métodos getter.</span><span class="sxs-lookup"><span data-stu-id="afbc6-131">All properties have setter methods, but not getter methods.</span></span> <span data-ttu-id="afbc6-132">A leitura de propriedades não faz uso intensivo de recursos, mas também pode ser imprecisa, pois qualquer valor retornado pelo mecanismo de composição pode se tornar imediatamente inválido.</span><span class="sxs-lookup"><span data-stu-id="afbc6-132">Reading properties is not only resource intensive, but can also be inaccurate because any value that the composition engine returns can immediately become invalid.</span></span> <span data-ttu-id="afbc6-133">Isso pode acontecer se, por exemplo, uma animação independente estiver associada à propriedade que está sendo lida.</span><span class="sxs-lookup"><span data-stu-id="afbc6-133">This can happen if, for example, an independent animation is bound to the property that is being read.</span></span>

<span data-ttu-id="afbc6-134">A API é thread-safe.</span><span class="sxs-lookup"><span data-stu-id="afbc6-134">The API is thread-safe.</span></span> <span data-ttu-id="afbc6-135">Um aplicativo pode chamar qualquer método de qualquer thread a qualquer momento.</span><span class="sxs-lookup"><span data-stu-id="afbc6-135">An application can call any method from any thread at any time.</span></span> <span data-ttu-id="afbc6-136">No entanto, como muitos métodos de API devem ser chamados em uma determinada sequência, sem qualquer sincronização, um aplicativo pode ter um comportamento imprevisível dependendo de como os threads se intercalam.</span><span class="sxs-lookup"><span data-stu-id="afbc6-136">However, because many API methods must be called in a particular sequence, without any synchronization an application can experience unpredictable behavior depending on how the threads interleave.</span></span> <span data-ttu-id="afbc6-137">Por exemplo, se dois threads alterarem a mesma Propriedade do mesmo objeto para valores diferentes ao mesmo tempo, o aplicativo não poderá prever qual dos dois valores será o valor final da propriedade.</span><span class="sxs-lookup"><span data-stu-id="afbc6-137">For example, if two threads change the same property of the same object to different values at the same time, the application cannot predict which of the two values will be the final value of the property.</span></span> <span data-ttu-id="afbc6-138">Da mesma forma, se dois threads chamarem [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) no mesmo dispositivo, nenhum thread terá um comportamento verdadeiramente transacional porque uma chamada para **Commit** em um thread enviará o lote de todos os comandos emitidos por ambos os threads, não apenas aquele que chamou **Commit**.</span><span class="sxs-lookup"><span data-stu-id="afbc6-138">Similarly, if two threads call [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) on the same device, neither thread gets truly transactional behavior because a call to **Commit** on one thread will submit the batch of all commands issued by both threads, not just the one that called **Commit**.</span></span>

<span data-ttu-id="afbc6-139">O sistema mantém todo o estado interno por objeto de dispositivo.</span><span class="sxs-lookup"><span data-stu-id="afbc6-139">The system maintains all internal state per device object.</span></span> <span data-ttu-id="afbc6-140">Se um aplicativo criar dois ou mais objetos de dispositivo DirectComposition, o aplicativo poderá manter lotes independentes e outro estado entre os dois.</span><span class="sxs-lookup"><span data-stu-id="afbc6-140">If an application creates two or more DirectComposition device objects, the application can maintain independent batches and other state between the two.</span></span>

<span data-ttu-id="afbc6-141">Todos os objetos DirectComposition têm afinidade de objeto de dispositivo; os objetos criados por um determinado objeto de dispositivo podem ser usados somente com esse objeto de dispositivo e podem ser associados somente a outros objetos criados pelo mesmo objeto de dispositivo.</span><span class="sxs-lookup"><span data-stu-id="afbc6-141">All DirectComposition objects have device object affinity; objects created by a particular device object can be used only with that device object, and can be associated only with other objects created by the same device object.</span></span> <span data-ttu-id="afbc6-142">Em outras palavras, cada objeto de dispositivo é uma ilha de funcionalidade separada.</span><span class="sxs-lookup"><span data-stu-id="afbc6-142">In other words, each device object is a separate disjoint island of functionality.</span></span> <span data-ttu-id="afbc6-143">A única exceção é a classe Visual, que permite a criação de árvores visuais em que um visual pode pertencer a um objeto de dispositivo diferente do seu pai.</span><span class="sxs-lookup"><span data-stu-id="afbc6-143">The one exception is the visual class, which permits the building of visual trees where a visual can belong to a different device object than its parent.</span></span> <span data-ttu-id="afbc6-144">Isso permite cenários em que um aplicativo e um controle podem gerenciar uma única árvore de composição sem também precisar compartilhar um único objeto de dispositivo DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="afbc6-144">This enables scenarios where an application and a control can manage a single composition tree without also needing to share a single DirectComposition device object.</span></span>

## <a name="composition-engine"></a><span data-ttu-id="afbc6-145">Mecanismo de composição</span><span class="sxs-lookup"><span data-stu-id="afbc6-145">Composition engine</span></span>

<span data-ttu-id="afbc6-146">O mecanismo de composição DirectComposition é executado em um processo dedicado, separado de qualquer processo de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="afbc6-146">The DirectComposition composition engine runs on a dedicated process, separate from any application process.</span></span> <span data-ttu-id="afbc6-147">Um único processo de composição, dwm.exe, dá suporte a todos os aplicativos em uma sessão.</span><span class="sxs-lookup"><span data-stu-id="afbc6-147">A single composition process, dwm.exe, supports every application in a session.</span></span> <span data-ttu-id="afbc6-148">Cada aplicativo pode criar duas árvores visuais para cada janela que ela possui.</span><span class="sxs-lookup"><span data-stu-id="afbc6-148">Each application can create two visual trees for each window that it owns.</span></span> <span data-ttu-id="afbc6-149">Todas as árvores são realmente implementadas como subárvores de uma árvore visual maior que também abrange as estruturas de composição do DWM.</span><span class="sxs-lookup"><span data-stu-id="afbc6-149">All of the trees are actually implemented as subtrees of a larger visual tree that also encompasses the composition structures of DWM.</span></span> <span data-ttu-id="afbc6-150">O DWM constrói uma árvore visual grande para cada área de trabalho em uma sessão.</span><span class="sxs-lookup"><span data-stu-id="afbc6-150">The DWM constructs one large visual tree for each desktop in a session.</span></span> <span data-ttu-id="afbc6-151">Estas são as principais vantagens dessa arquitetura:</span><span class="sxs-lookup"><span data-stu-id="afbc6-151">Here are the key advantages to this architecture:</span></span>

-   <span data-ttu-id="afbc6-152">O mecanismo de composição tem acesso a todos os bitmaps de aplicativo e árvores visuais, o que permite a dioperabilidade e composição de janelas entre processos.</span><span class="sxs-lookup"><span data-stu-id="afbc6-152">The composition engine has access to all application bitmaps and visual trees, which enables cross-process window interoperability and composition.</span></span>
-   <span data-ttu-id="afbc6-153">O mecanismo de composição é executado em um processo de sistema confiável que é separado de qualquer processo de aplicativo, permitindo que os aplicativos que têm direitos de acesso sejam muito baixos para compor com segurança o conteúdo protegido.</span><span class="sxs-lookup"><span data-stu-id="afbc6-153">The composition engine runs in a trusted system process that is separate from any application process, enabling applications that have low access rights to securely compose protected content.</span></span>
-   <span data-ttu-id="afbc6-154">O mecanismo de composição pode detectar quando uma janela específica é totalmente obstruído e evitar desperdiçar recursos de CPU e unidade de processamento gráfico (GPU) para a janela.</span><span class="sxs-lookup"><span data-stu-id="afbc6-154">The composition engine can detect when a particular window is fully occluded and avoid wasting CPU and graphics processing unit (GPU) resources composing for the window.</span></span>
-   <span data-ttu-id="afbc6-155">O mecanismo de composição pode compor diretamente para o buffer de fundo da tela, evitando a necessidade de uma cópia extra necessária para mecanismos de composição por processo.</span><span class="sxs-lookup"><span data-stu-id="afbc6-155">The composition engine can compose directly to the screen back buffer, avoiding the need for an extra copy that is required for per-process composition engines.</span></span>
-   <span data-ttu-id="afbc6-156">Todos os aplicativos compartilham um único dispositivo Direct3D para composição, o que oferece economia de memória considerável</span><span class="sxs-lookup"><span data-stu-id="afbc6-156">All applications share a single Direct3D device for composition, which offers considerable memory savings</span></span>

<span data-ttu-id="afbc6-157">A árvore visual é uma estrutura retida.</span><span class="sxs-lookup"><span data-stu-id="afbc6-157">The visual tree is a retained structure.</span></span> <span data-ttu-id="afbc6-158">A API DirectComposition expõe métodos para editar a estrutura em lotes de alterações processadas atomicamente.</span><span class="sxs-lookup"><span data-stu-id="afbc6-158">The DirectComposition API exposes methods to edit the structure in batches of changes that are processed atomically.</span></span> <span data-ttu-id="afbc6-159">O objeto raiz na API DirectComposition é o objeto de dispositivo, que serve como o alocador para todos os outros objetos DirectComposition e contém um método chamado [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).</span><span class="sxs-lookup"><span data-stu-id="afbc6-159">The root object in the DirectComposition API is the device object, which serves as the factory for all other DirectComposition objects and contains a method called [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).</span></span> <span data-ttu-id="afbc6-160">O mecanismo de composição não reflete as alterações que o aplicativo faz na árvore visual até que o aplicativo chame **Commit**; nesse ponto todas as alterações desde a última **confirmação** são processadas como uma única transação.</span><span class="sxs-lookup"><span data-stu-id="afbc6-160">The composition engine does not reflect any changes that the application makes to the visual tree until the application calls **Commit**, at which point all changes since the last **Commit** are processed as a single transaction.</span></span>

<span data-ttu-id="afbc6-161">O requisito para chamar [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) é semelhante ao conceito de um "frame", exceto que, como o mecanismo de composição é executado de forma assíncrona, ele pode apresentar vários quadros diferentes entre chamadas para **Commit**.</span><span class="sxs-lookup"><span data-stu-id="afbc6-161">The requirement to call [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) is similar to the concept of a "frame" except that, because the composition engine runs asynchronously, it can present several different frames between calls to **Commit**.</span></span> <span data-ttu-id="afbc6-162">No DirectComposition, um *quadro* é uma única iteração do mecanismo de composição e o intervalo gasto por um aplicativo entre duas chamadas a serem **confirmadas** é chamado de *lote*.</span><span class="sxs-lookup"><span data-stu-id="afbc6-162">In DirectComposition, a *frame* is a single iteration of the composition engine, and the interval spent by an application between two calls to **Commit** is called a *batch*.</span></span>

<span data-ttu-id="afbc6-163">O DirectComposition batche todas as chamadas de aplicativo para a API DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="afbc6-163">DirectComposition batches all application calls to the DirectComposition API.</span></span> <span data-ttu-id="afbc6-164">O banco de dados de objeto de kernel, que é implementado no driver de sessão de win32k.sys, armazena todas as informações de estado associadas às chamadas à API.</span><span class="sxs-lookup"><span data-stu-id="afbc6-164">The kernel object database, which is implemented in the win32k.sys session driver, stores all state information that is associated with the API calls.</span></span>

<span data-ttu-id="afbc6-165">O mecanismo de composição produz um quadro para cada vertical em branco na exibição.</span><span class="sxs-lookup"><span data-stu-id="afbc6-165">The composition engine produces one frame for each vertical blank in the display.</span></span> <span data-ttu-id="afbc6-166">O quadro é iniciado em um vertical em branco e tem como alvo a vertical subseqüente em branco.</span><span class="sxs-lookup"><span data-stu-id="afbc6-166">The frame is started at a vertical blank and targets the subsequent vertical blank.</span></span> <span data-ttu-id="afbc6-167">Quando o quadro é iniciado, o mecanismo de composição pega todos os lotes pendentes e inclui seus comandos nesse quadro.</span><span class="sxs-lookup"><span data-stu-id="afbc6-167">When the frame starts, the composition engine picks up all pending batches and includes their commands in that frame.</span></span> <span data-ttu-id="afbc6-168">Os lotes são colocados em uma fila pendente quando o aplicativo chama [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit)e a fila pendente é liberada atomicamente no início do quadro.</span><span class="sxs-lookup"><span data-stu-id="afbc6-168">Batches are placed in a pending queue when the application calls [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit), and the pending queue is flushed atomically at the beginning of the frame.</span></span> <span data-ttu-id="afbc6-169">Portanto, há um único ponto no tempo que marca o início de um quadro.</span><span class="sxs-lookup"><span data-stu-id="afbc6-169">Therefore, there is a single point in time that marks the beginning of a frame.</span></span> <span data-ttu-id="afbc6-170">Todos os lotes enviados antes desse ponto são incluídos no quadro, enquanto os lotes enviados após devem aguardar até que o próximo quadro seja processado.</span><span class="sxs-lookup"><span data-stu-id="afbc6-170">Any batches submitted before this point are included in the frame, while any batches submitted after must wait until the next frame to be processed.</span></span> <span data-ttu-id="afbc6-171">O loop de composição completo é o seguinte:</span><span class="sxs-lookup"><span data-stu-id="afbc6-171">The full composition loop is as follows:</span></span>

1.  <span data-ttu-id="afbc6-172">Estimar o tempo da próxima vertical em branco.</span><span class="sxs-lookup"><span data-stu-id="afbc6-172">Estimate the time of the next vertical blank.</span></span>
2.  <span data-ttu-id="afbc6-173">Recupere todos os lotes pendentes.</span><span class="sxs-lookup"><span data-stu-id="afbc6-173">Retrieve all pending batches.</span></span>
3.  <span data-ttu-id="afbc6-174">Processar os lotes recuperados.</span><span class="sxs-lookup"><span data-stu-id="afbc6-174">Process the retrieved batches.</span></span>
4.  <span data-ttu-id="afbc6-175">Atualize todas as animações usando o tempo estimado na etapa 1.</span><span class="sxs-lookup"><span data-stu-id="afbc6-175">Update all animations using the time estimated in step 1.</span></span>
5.  <span data-ttu-id="afbc6-176">Determine as regiões da tela que precisam ser recompostas.</span><span class="sxs-lookup"><span data-stu-id="afbc6-176">Determine the regions of the screen that need to be re-composed.</span></span>
6.  <span data-ttu-id="afbc6-177">Recrie as regiões sujas.</span><span class="sxs-lookup"><span data-stu-id="afbc6-177">Re-compose the dirty regions.</span></span>
7.  <span data-ttu-id="afbc6-178">Apresente o quadro invertendo os buffers traseiros e frontais para cada tela.</span><span class="sxs-lookup"><span data-stu-id="afbc6-178">Present the frame by flipping the back and front buffers for each screen.</span></span>
8.  <span data-ttu-id="afbc6-179">Se nada tiver sido composto e apresentado nas etapas 6 e 7, aguarde até que um lote seja confirmado.</span><span class="sxs-lookup"><span data-stu-id="afbc6-179">If nothing was composed and presented in steps 6 and 7, wait for a batch to be committed.</span></span>
9.  <span data-ttu-id="afbc6-180">Aguarde a próxima vertical em branco.</span><span class="sxs-lookup"><span data-stu-id="afbc6-180">Wait for the next vertical blank.</span></span>

<span data-ttu-id="afbc6-181">Se houver vários monitores anexados a um único adaptador de vídeo, o mecanismo de composição usará a vertical em branco do monitor primário para orientar o loop de composição e definir os tempos de amostragem da animação.</span><span class="sxs-lookup"><span data-stu-id="afbc6-181">If there are multiple monitors attached to a single video adapter, the composition engine uses the vertical blank of the primary monitor to drive the composition loop and set the animation sampling times.</span></span> <span data-ttu-id="afbc6-182">Cada monitor é representado por uma cadeia de inversão de tela inteira separada; o mecanismo de composição repete as etapas 6 e 7 para cada monitor, em um modo Round Robin, usando um único dispositivo Direct3D.</span><span class="sxs-lookup"><span data-stu-id="afbc6-182">Each monitor is represented by a separate full-screen flip chain; the composition engine repeats steps 6 and 7 for each monitor, in a round-robin fashion, using a single Direct3D device.</span></span> <span data-ttu-id="afbc6-183">Se também houver vários adaptadores de vídeo, o mecanismo de composição usará um dispositivo Direct3D separado para cada adaptador de vídeo nas etapas 6 e 7.</span><span class="sxs-lookup"><span data-stu-id="afbc6-183">If there are also multiple video adapters, the composition engine uses a separate Direct3D device for each video adapter in steps 6 and 7.</span></span>

<span data-ttu-id="afbc6-184">Os quadros de composição são agendados para sempre começarem em uma vertical em branco, como mostra a ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="afbc6-184">Composition frames are scheduled to always start at a vertical blank, as the following illustration shows.</span></span>

![agendamento de quadro de composição](images/composition-frame-scheduling.png)

<span data-ttu-id="afbc6-186">Se o mecanismo de composição não tiver nenhum trabalho a ser feito porque a árvore de composição não foi alterada, o thread de composição será suspenso enquanto aguarda um novo lote.</span><span class="sxs-lookup"><span data-stu-id="afbc6-186">If the composition engine has no work to do because the composition tree has not changed, the composition thread sleeps while waiting for a new batch.</span></span> <span data-ttu-id="afbc6-187">Quando um novo lote é enviado, o thread de composição é ativado, mas imediatamente volta para o estado de suspensão até que a próxima vertical fique em branco.</span><span class="sxs-lookup"><span data-stu-id="afbc6-187">When a new batch is submitted, the composition thread wakes up but immediately goes back to sleep until the next vertical blank.</span></span> <span data-ttu-id="afbc6-188">Esse comportamento garante tempos de início e de término previsíveis de quadros para aplicativos e para o mecanismo de composição.</span><span class="sxs-lookup"><span data-stu-id="afbc6-188">This behavior ensures predictable frame start and end times for applications and for the composition engine.</span></span>

<span data-ttu-id="afbc6-189">O mecanismo de composição publica as horas de apresentação do quadro e a taxa de quadros atual.</span><span class="sxs-lookup"><span data-stu-id="afbc6-189">The composition engine publishes the frame presentation times and the current frame rate.</span></span> <span data-ttu-id="afbc6-190">A publicação dessas informações permite que os aplicativos estimem o tempo de apresentação de seus próprios lotes, o que, por sua vez, permite que as animações sejam sincronizadas.</span><span class="sxs-lookup"><span data-stu-id="afbc6-190">Publishing this information enables applications to estimate the presentation time for their own batches, which in turns enables animations to be synchronized.</span></span> <span data-ttu-id="afbc6-191">Em particular, um aplicativo pode usar uma combinação de estatísticas de quadro do mecanismo de composição e um modelo histórico de quanto tempo seu thread de interface do usuário leva para produzir um lote, para determinar o período de amostragem para suas próprias animações.</span><span class="sxs-lookup"><span data-stu-id="afbc6-191">In particular, an application can use a combination of frame statistics from the composition engine, and a historical model of how long its UI thread takes to produce a batch, to determine the sampling time for its own animations.</span></span>

<span data-ttu-id="afbc6-192">Por exemplo, no início do lote do aplicativo mostrado na ilustração anterior, o aplicativo pode consultar o mecanismo de composição para determinar o tempo de apresentação exato do próximo quadro.</span><span class="sxs-lookup"><span data-stu-id="afbc6-192">For example, at the beginning of the application batch shown in the previous illustration, the application can query the composition engine to determine the exact presentation time of the next frame.</span></span> <span data-ttu-id="afbc6-193">O aplicativo pode usar a hora atual, juntamente com informações sobre os lotes anteriores que ele produziu, para determinar se o aplicativo pode concluir o lote atual antes da próxima vertical em branco.</span><span class="sxs-lookup"><span data-stu-id="afbc6-193">The application can then use the current time, along with information about previous batches that it has produced, to determine whether the application can complete the current batch before the next vertical blank.</span></span> <span data-ttu-id="afbc6-194">Portanto, o aplicativo usa o tempo de apresentação do quadro como o tempo de amostragem para suas próprias animações.</span><span class="sxs-lookup"><span data-stu-id="afbc6-194">Therefore, the application uses the frame presentation time as the sampling time for its own animations.</span></span> <span data-ttu-id="afbc6-195">Se o aplicativo determinar que é improvável que você conclua seu trabalho na vertical atual em branco, o aplicativo poderá usar o período de quadro subsequente como o tempo de amostragem, usando as informações de taxa de quadros retornadas pelo mecanismo de composição para calcular esse tempo.</span><span class="sxs-lookup"><span data-stu-id="afbc6-195">If the application determines that it is unlikely to complete its work in the current vertical blank, the application can use the subsequent frame time as the sampling time instead, using the frame rate information returned by the composition engine to compute that time.</span></span>

## <a name="related-topics"></a><span data-ttu-id="afbc6-196">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="afbc6-196">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="afbc6-197">Conceitos de DirectComposition</span><span class="sxs-lookup"><span data-stu-id="afbc6-197">DirectComposition Concepts</span></span>](directcomposition-concepts.md)
</dt> </dl>

 

 