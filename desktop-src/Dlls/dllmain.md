---
description: Um ponto de entrada opcional em uma DLL (biblioteca de vínculo dinâmico). Quando o sistema inicia ou termina um processo ou thread, ele chama a função de ponto de entrada para cada DLL carregada usando o primeiro thread do processo.
ms.assetid: 0c3e3083-9297-4626-b2a7-0062d1c2cf9e
title: Ponto de entrada DllMain (Process. h)
ms.topic: reference
ms.date: 07/22/2020
topic_type:
- APIRef
- kbSyntax
api_name:
- DllMain
api_type:
- UserDefined
api_location:
- process.h
ms.openlocfilehash: ee182fd54f11909e54e98f827904f1da5e46f557
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "105753490"
---
# <a name="dllmain-entry-point"></a><span data-ttu-id="af55b-104">Ponto de entrada DllMain</span><span class="sxs-lookup"><span data-stu-id="af55b-104">DllMain entry point</span></span>

<span data-ttu-id="af55b-105">Um ponto de entrada opcional em uma DLL (biblioteca de vínculo dinâmico).</span><span class="sxs-lookup"><span data-stu-id="af55b-105">An optional entry point into a dynamic-link library (DLL).</span></span> <span data-ttu-id="af55b-106">Quando o sistema inicia ou termina um processo ou thread, ele chama a função de ponto de entrada para cada DLL carregada usando o primeiro thread do processo.</span><span class="sxs-lookup"><span data-stu-id="af55b-106">When the system starts or terminates a process or thread, it calls the entry-point function for each loaded DLL using the first thread of the process.</span></span> <span data-ttu-id="af55b-107">O sistema também chama a função de ponto de entrada para uma DLL quando ela é carregada ou descarregada usando as funções [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) e [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) .</span><span class="sxs-lookup"><span data-stu-id="af55b-107">The system also calls the entry-point function for a DLL when it is loaded or unloaded using the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) and [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) functions.</span></span>

## <a name="example"></a><span data-ttu-id="af55b-108">Exemplo</span><span class="sxs-lookup"><span data-stu-id="af55b-108">Example</span></span>

```cpp
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

<span data-ttu-id="af55b-109">Este é um exemplo da [função Entry-Point da biblioteca de vínculo dinâmico](dynamic-link-library-entry-point-function.md).</span><span class="sxs-lookup"><span data-stu-id="af55b-109">This is an example from the [Dynamic-Link Library Entry-Point Function](dynamic-link-library-entry-point-function.md).</span></span>


> [!WARNING]
> <span data-ttu-id="af55b-110">Há limites significativos no que você pode fazer com segurança em um ponto de entrada de DLL.</span><span class="sxs-lookup"><span data-stu-id="af55b-110">There are significant limits on what you can safely do in a DLL entry point.</span></span> <span data-ttu-id="af55b-111">Consulte [práticas recomendadas gerais](dynamic-link-library-best-practices.md) para APIs específicas do Windows que não são seguras para chamar em DllMain.</span><span class="sxs-lookup"><span data-stu-id="af55b-111">See [General Best Practices](dynamic-link-library-best-practices.md) for specific Windows APIs that are unsafe to call in DllMain.</span></span> <span data-ttu-id="af55b-112">Se você precisar de qualquer coisa, exceto a inicialização mais simples, faça isso em uma função de inicialização para a DLL.</span><span class="sxs-lookup"><span data-stu-id="af55b-112">If you need anything but the simplest initialization then do that in an initialization function for the DLL.</span></span> <span data-ttu-id="af55b-113">Você pode exigir que os aplicativos chamem a função de inicialização após a execução de DllMain e antes de chamar qualquer outra função na DLL.</span><span class="sxs-lookup"><span data-stu-id="af55b-113">You can require applications to call the initialization function after DllMain has run and before they call any other functions in the DLL.</span></span>

 

## <a name="syntax"></a><span data-ttu-id="af55b-114">Sintaxe</span><span class="sxs-lookup"><span data-stu-id="af55b-114">Syntax</span></span>


```C++
BOOL WINAPI DllMain(
  _In_ HINSTANCE hinstDLL,
  _In_ DWORD     fdwReason,
  _In_ LPVOID    lpvReserved
);
```



## <a name="parameters"></a><span data-ttu-id="af55b-115">Parâmetros</span><span class="sxs-lookup"><span data-stu-id="af55b-115">Parameters</span></span>

<dl> <dt>

<span data-ttu-id="af55b-116">*hInstDll* \[ no\]</span><span class="sxs-lookup"><span data-stu-id="af55b-116">*hinstDLL* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="af55b-117">Um identificador para o módulo de DLL.</span><span class="sxs-lookup"><span data-stu-id="af55b-117">A handle to the DLL module.</span></span> <span data-ttu-id="af55b-118">O valor é o endereço base da DLL.</span><span class="sxs-lookup"><span data-stu-id="af55b-118">The value is the base address of the DLL.</span></span> <span data-ttu-id="af55b-119">O **HINSTANCE** de uma DLL é o mesmo que o **HMODULE** da dll, portanto, o *hInstDll* pode ser usado em chamadas para funções que exigem um identificador de módulo.</span><span class="sxs-lookup"><span data-stu-id="af55b-119">The **HINSTANCE** of a DLL is the same as the **HMODULE** of the DLL, so *hinstDLL* can be used in calls to functions that require a module handle.</span></span>

</dd> <dt>

<span data-ttu-id="af55b-120">*fdwReason* \[ no\]</span><span class="sxs-lookup"><span data-stu-id="af55b-120">*fdwReason* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="af55b-121">O código de motivo que indica por que a função de ponto de entrada de DLL está sendo chamada.</span><span class="sxs-lookup"><span data-stu-id="af55b-121">The reason code that indicates why the DLL entry-point function is being called.</span></span> <span data-ttu-id="af55b-122">Esse parâmetro pode usar um dos valores a seguir.</span><span class="sxs-lookup"><span data-stu-id="af55b-122">This parameter can be one of the following values.</span></span>



| <span data-ttu-id="af55b-123">Valor</span><span class="sxs-lookup"><span data-stu-id="af55b-123">Value</span></span>                                                                                                                                                                                                                                | <span data-ttu-id="af55b-124">Significado</span><span class="sxs-lookup"><span data-stu-id="af55b-124">Meaning</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="DLL_PROCESS_ATTACH"></span><span id="dll_process_attach"></span><dl> <span data-ttu-id="af55b-125"><dt>**Dll \_ PROCESSO \_ anexado**</dt> <dt>1</dt></span><span class="sxs-lookup"><span data-stu-id="af55b-125"><dt>**DLL\_PROCESS\_ATTACH**</dt> <dt>1</dt></span></span> </dl> | <span data-ttu-id="af55b-126">A DLL está sendo carregada no espaço de endereço virtual do processo atual como resultado do processo que está sendo iniciado ou como resultado de uma chamada para [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya).</span><span class="sxs-lookup"><span data-stu-id="af55b-126">The DLL is being loaded into the virtual address space of the current process as a result of the process starting up or as a result of a call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya).</span></span> <span data-ttu-id="af55b-127">As DLLs podem usar essa oportunidade para inicializar qualquer dado de instância ou para usar a função [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) para alocar um índice de armazenamento local de thread (TLS).</span><span class="sxs-lookup"><span data-stu-id="af55b-127">DLLs can use this opportunity to initialize any instance data or to use the [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) function to allocate a thread local storage (TLS) index.</span></span><br/> <span data-ttu-id="af55b-128">O parâmetro *lpReserved* indica se a dll está sendo carregada de forma estática ou dinâmica.</span><span class="sxs-lookup"><span data-stu-id="af55b-128">The *lpReserved* parameter indicates whether the DLL is being loaded statically or dynamically.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span id="DLL_PROCESS_DETACH"></span><span id="dll_process_detach"></span><dl> <span data-ttu-id="af55b-129"><dt>**Dll \_ PROCESSO \_ desanexar**</dt> <dt>0</dt></span><span class="sxs-lookup"><span data-stu-id="af55b-129"><dt>**DLL\_PROCESS\_DETACH**</dt> <dt>0</dt></span></span> </dl> | <span data-ttu-id="af55b-130">A DLL está sendo descarregada do espaço de endereço virtual do processo de chamada porque foi carregada sem êxito ou a contagem de referência atingiu zero (os processos foram encerrados ou chamados [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) uma vez para cada vez que ele chamou [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="af55b-130">The DLL is being unloaded from the virtual address space of the calling process because it was loaded unsuccessfully or the reference count has reached zero (the processes has either terminated or called [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) one time for each time it called [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span><br/> <span data-ttu-id="af55b-131">O parâmetro *lpReserved* indica se a dll está sendo descarregada como resultado de uma chamada [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) , uma falha ao carregar ou processar o encerramento.</span><span class="sxs-lookup"><span data-stu-id="af55b-131">The *lpReserved* parameter indicates whether the DLL is being unloaded as a result of a [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) call, a failure to load, or process termination.</span></span><br/> <span data-ttu-id="af55b-132">A DLL pode usar essa oportunidade para chamar a função [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) para liberar quaisquer índices TLS alocados usando [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) e para liberar quaisquer dados locais de thread.</span><span class="sxs-lookup"><span data-stu-id="af55b-132">The DLL can use this opportunity to call the [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) function to free any TLS indices allocated by using [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) and to free any thread local data.</span></span><br/> <span data-ttu-id="af55b-133">Observe que o thread que recebe a notificação de **\_ \_ desanexação do processo de dll** não é necessariamente o mesmo thread que recebeu a notificação de **\_ \_ anexação do processo de dll** .</span><span class="sxs-lookup"><span data-stu-id="af55b-133">Note that the thread that receives the **DLL\_PROCESS\_DETACH** notification is not necessarily the same thread that received the **DLL\_PROCESS\_ATTACH** notification.</span></span><br/> |
| <span id="DLL_THREAD_ATTACH"></span><span id="dll_thread_attach"></span><dl> <span data-ttu-id="af55b-134"><dt>**Dll \_ \_Anexação de thread**</dt> <dt>2</dt></span><span class="sxs-lookup"><span data-stu-id="af55b-134"><dt>**DLL\_THREAD\_ATTACH**</dt> <dt>2</dt></span></span> </dl>    | <span data-ttu-id="af55b-135">O processo atual está criando um novo thread.</span><span class="sxs-lookup"><span data-stu-id="af55b-135">The current process is creating a new thread.</span></span> <span data-ttu-id="af55b-136">Quando isso ocorre, o sistema chama a função de ponto de entrada de todas as DLLs atualmente anexadas ao processo.</span><span class="sxs-lookup"><span data-stu-id="af55b-136">When this occurs, the system calls the entry-point function of all DLLs currently attached to the process.</span></span> <span data-ttu-id="af55b-137">A chamada é feita no contexto do novo thread.</span><span class="sxs-lookup"><span data-stu-id="af55b-137">The call is made in the context of the new thread.</span></span> <span data-ttu-id="af55b-138">As DLLs podem usar essa oportunidade para inicializar um slot TLS para o thread.</span><span class="sxs-lookup"><span data-stu-id="af55b-138">DLLs can use this opportunity to initialize a TLS slot for the thread.</span></span> <span data-ttu-id="af55b-139">Um thread que chama a função de ponto de entrada de DLL com a **\_ \_ anexação de processo de dll** não chama a função de ponto de entrada de dll com **\_ \_ anexação de thread de dll**.</span><span class="sxs-lookup"><span data-stu-id="af55b-139">A thread calling the DLL entry-point function with **DLL\_PROCESS\_ATTACH** does not call the DLL entry-point function with **DLL\_THREAD\_ATTACH**.</span></span> <br/> <span data-ttu-id="af55b-140">Observe que a função de ponto de entrada de uma DLL é chamada com esse valor somente por threads criados depois que a DLL é carregada pelo processo.</span><span class="sxs-lookup"><span data-stu-id="af55b-140">Note that a DLL's entry-point function is called with this value only by threads created after the DLL is loaded by the process.</span></span> <span data-ttu-id="af55b-141">Quando uma DLL é carregada usando [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), os threads existentes não chamam a função de ponto de entrada da DLL carregada recentemente.</span><span class="sxs-lookup"><span data-stu-id="af55b-141">When a DLL is loaded using [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), existing threads do not call the entry-point function of the newly loaded DLL.</span></span><br/>                                                                                                                                                                       |
| <span id="DLL_THREAD_DETACH"></span><span id="dll_thread_detach"></span><dl> <span data-ttu-id="af55b-142"><dt>**Dll \_ \_Desanexação de thread**</dt> <dt>3</dt></span><span class="sxs-lookup"><span data-stu-id="af55b-142"><dt>**DLL\_THREAD\_DETACH**</dt> <dt>3</dt></span></span> </dl>    | <span data-ttu-id="af55b-143">Um thread está sendo fechado corretamente.</span><span class="sxs-lookup"><span data-stu-id="af55b-143">A thread is exiting cleanly.</span></span> <span data-ttu-id="af55b-144">Se a DLL tiver armazenado um ponteiro para a memória alocada em um slot TLS, ela deverá usar essa oportunidade para liberar a memória.</span><span class="sxs-lookup"><span data-stu-id="af55b-144">If the DLL has stored a pointer to allocated memory in a TLS slot, it should use this opportunity to free the memory.</span></span> <span data-ttu-id="af55b-145">O sistema chama a função de ponto de entrada de todas as DLLs carregadas atualmente com esse valor.</span><span class="sxs-lookup"><span data-stu-id="af55b-145">The system calls the entry-point function of all currently loaded DLLs with this value.</span></span> <span data-ttu-id="af55b-146">A chamada é feita no contexto do thread existente.</span><span class="sxs-lookup"><span data-stu-id="af55b-146">The call is made in the context of the exiting thread.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |



 

</dd> <dt>

<span data-ttu-id="af55b-147">*lpvReserved* \[ no\]</span><span class="sxs-lookup"><span data-stu-id="af55b-147">*lpvReserved* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="af55b-148">Se *fdwReason* for **o \_ processo \_ de dll Attach**, *lpvReserved* será **nulo** para cargas dinâmicas e não nulo para cargas estáticas.</span><span class="sxs-lookup"><span data-stu-id="af55b-148">If *fdwReason* is **DLL\_PROCESS\_ATTACH**, *lpvReserved* is **NULL** for dynamic loads and non-NULL for static loads.</span></span>

<span data-ttu-id="af55b-149">Se *fdwReason* for **o \_ processo \_ de dll Detach**, *lpvReserved* será **nulo** se [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) tiver sido chamado ou o carregamento da DLL tiver falhado e não **nulo** se o processo estiver sendo encerrado.</span><span class="sxs-lookup"><span data-stu-id="af55b-149">If *fdwReason* is **DLL\_PROCESS\_DETACH**, *lpvReserved* is **NULL** if [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) has been called or the DLL load failed and non-**NULL** if the process is terminating.</span></span>

</dd> </dl>

## <a name="return-value"></a><span data-ttu-id="af55b-150">Retornar valor</span><span class="sxs-lookup"><span data-stu-id="af55b-150">Return value</span></span>

<span data-ttu-id="af55b-151">Quando o sistema chamar a função **DllMain** com o valor de **\_ \_ anexação do processo de dll** , a função retornará **true** se for bem-sucedida ou **false** se a inicialização falhar.</span><span class="sxs-lookup"><span data-stu-id="af55b-151">When the system calls the **DllMain** function with the **DLL\_PROCESS\_ATTACH** value, the function returns **TRUE** if it succeeds or **FALSE** if initialization fails.</span></span> <span data-ttu-id="af55b-152">Se o valor de retorno for **false** quando **DllMain** for chamado porque o processo usa a função [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) , **LoadLibrary** retornará NULL.</span><span class="sxs-lookup"><span data-stu-id="af55b-152">If the return value is **FALSE** when **DllMain** is called because the process uses the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) function, **LoadLibrary** returns NULL.</span></span> <span data-ttu-id="af55b-153">(O sistema chama imediatamente sua função de ponto de entrada com o **processo de dll \_ \_ desanexar** e descarrega a dll.) Se o valor de retorno for **falso** quando **DllMain** for chamado durante a inicialização do processo, o processo será encerrado com um erro.</span><span class="sxs-lookup"><span data-stu-id="af55b-153">(The system immediately calls your entry-point function with **DLL\_PROCESS\_DETACH** and unloads the DLL.) If the return value is **FALSE** when **DllMain** is called during process initialization, the process terminates with an error.</span></span> <span data-ttu-id="af55b-154">Para obter informações de erro estendidas, chame [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).</span><span class="sxs-lookup"><span data-stu-id="af55b-154">To get extended error information, call [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).</span></span>

<span data-ttu-id="af55b-155">Quando o sistema chama a função **DllMain** com qualquer valor diferente de **dll \_ processo \_ Attach**, o valor de retorno é ignorado.</span><span class="sxs-lookup"><span data-stu-id="af55b-155">When the system calls the **DllMain** function with any value other than **DLL\_PROCESS\_ATTACH**, the return value is ignored.</span></span>

## <a name="remarks"></a><span data-ttu-id="af55b-156">Comentários</span><span class="sxs-lookup"><span data-stu-id="af55b-156">Remarks</span></span>

<span data-ttu-id="af55b-157">**DllMain** é um espaço reservado para o nome da função definida pela biblioteca.</span><span class="sxs-lookup"><span data-stu-id="af55b-157">**DllMain** is a placeholder for the library-defined function name.</span></span> <span data-ttu-id="af55b-158">Você deve especificar o nome real que você usa ao compilar sua DLL.</span><span class="sxs-lookup"><span data-stu-id="af55b-158">You must specify the actual name you use when you build your DLL.</span></span> <span data-ttu-id="af55b-159">Para obter mais informações, consulte a documentação incluída com suas ferramentas de desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="af55b-159">For more information, see the documentation included with your development tools.</span></span>

<span data-ttu-id="af55b-160">Durante a inicialização do processo inicial ou após uma chamada para [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), o sistema verifica a lista de DLLs carregadas para o processo.</span><span class="sxs-lookup"><span data-stu-id="af55b-160">During initial process startup or after a call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), the system scans the list of loaded DLLs for the process.</span></span> <span data-ttu-id="af55b-161">Para cada DLL que ainda não foi chamada com o valor **de \_ \_ anexação do processo de dll** , o sistema chama a função de ponto de entrada da dll.</span><span class="sxs-lookup"><span data-stu-id="af55b-161">For each DLL that has not already been called with the **DLL\_PROCESS\_ATTACH** value, the system calls the DLL's entry-point function.</span></span> <span data-ttu-id="af55b-162">Essa chamada é feita no contexto do thread que fez com que o espaço de endereço do processo fosse alterado, como o thread principal do processo ou o thread que chamou **LoadLibrary**.</span><span class="sxs-lookup"><span data-stu-id="af55b-162">This call is made in the context of the thread that caused the process address space to change, such as the primary thread of the process or the thread that called **LoadLibrary**.</span></span> <span data-ttu-id="af55b-163">O acesso ao ponto de entrada é serializado pelo sistema de acordo com todo o processo.</span><span class="sxs-lookup"><span data-stu-id="af55b-163">Access to the entry point is serialized by the system on a process-wide basis.</span></span> <span data-ttu-id="af55b-164">Os threads em *DllMain* mantêm o bloqueio do carregador, portanto, nenhuma dll adicional pode ser carregada ou inicializada dinamicamente.</span><span class="sxs-lookup"><span data-stu-id="af55b-164">Threads in *DllMain* hold the loader lock so no additional DLLs can be dynamically loaded or initialized.</span></span>

<span data-ttu-id="af55b-165">Se a função de ponto de entrada da DLL retornar FALSE após uma notificação de **\_ \_ anexo de processo de dll** , ela receberá uma notificação de **\_ \_ desanexação de processo de dll** e a dll será descarregada imediatamente.</span><span class="sxs-lookup"><span data-stu-id="af55b-165">If the DLL's entry-point function returns FALSE following a **DLL\_PROCESS\_ATTACH** notification, it receives a **DLL\_PROCESS\_DETACH** notification and the DLL is unloaded immediately.</span></span> <span data-ttu-id="af55b-166">No entanto, se o código de **\_ \_ anexo de processo de dll** lançar uma exceção, a função de ponto de entrada não receberá a notificação de **\_ \_ desanexação do processo de dll** .</span><span class="sxs-lookup"><span data-stu-id="af55b-166">However, if the **DLL\_PROCESS\_ATTACH** code throws an exception, the entry-point function will not receive the **DLL\_PROCESS\_DETACH** notification.</span></span>

<span data-ttu-id="af55b-167">Há casos em que a função de ponto de entrada é chamada para um thread de terminação, mesmo que a função de ponto de entrada nunca tenha sido chamada com **\_ \_ anexação de thread de dll** para o thread:</span><span class="sxs-lookup"><span data-stu-id="af55b-167">There are cases in which the entry-point function is called for a terminating thread even if the entry-point function was never called with **DLL\_THREAD\_ATTACH** for the thread:</span></span>

-   <span data-ttu-id="af55b-168">O thread era o thread inicial no processo, portanto, o sistema chamou a função de ponto de entrada com o valor de **\_ \_ anexação do processo de dll** .</span><span class="sxs-lookup"><span data-stu-id="af55b-168">The thread was the initial thread in the process, so the system called the entry-point function with the **DLL\_PROCESS\_ATTACH** value.</span></span>
-   <span data-ttu-id="af55b-169">O thread já estava em execução quando uma chamada para a função [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) foi feita, portanto, o sistema nunca chamou a função de ponto de entrada para ele.</span><span class="sxs-lookup"><span data-stu-id="af55b-169">The thread was already running when a call to the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) function was made, so the system never called the entry-point function for it.</span></span>

<span data-ttu-id="af55b-170">Quando uma DLL é descarregada de um processo como resultado de uma carga malsucedida da DLL, do encerramento do processo ou de uma chamada para [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), o sistema não chama a função de ponto de entrada da dll com o valor de **\_ \_ desanexação de thread de dll** para os threads individuais do processo.</span><span class="sxs-lookup"><span data-stu-id="af55b-170">When a DLL is unloaded from a process as a result of an unsuccessful load of the DLL, termination of the process, or a call to [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), the system does not call the DLL's entry-point function with the **DLL\_THREAD\_DETACH** value for the individual threads of the process.</span></span> <span data-ttu-id="af55b-171">A DLL só é enviada a uma notificação de **\_ \_ desanexação de processo de dll** .</span><span class="sxs-lookup"><span data-stu-id="af55b-171">The DLL is only sent a **DLL\_PROCESS\_DETACH** notification.</span></span> <span data-ttu-id="af55b-172">As DLLs podem aproveitar essa oportunidade para limpar todos os recursos de todos os threads conhecidos da DLL.</span><span class="sxs-lookup"><span data-stu-id="af55b-172">DLLs can take this opportunity to clean up all resources for all threads known to the DLL.</span></span>

<span data-ttu-id="af55b-173">Ao manipular **a \_ \_ desanexação do processo de DLL**, uma DLL deve liberar recursos como a memória heap somente se a dll estiver sendo descarregada dinamicamente (o parâmetro *lpReserved* é **nulo**).</span><span class="sxs-lookup"><span data-stu-id="af55b-173">When handling **DLL\_PROCESS\_DETACH**, a DLL should free resources such as heap memory only if the DLL is being unloaded dynamically (the *lpReserved* parameter is **NULL**).</span></span> <span data-ttu-id="af55b-174">Se o processo estiver sendo encerrado (o parâmetro *lpvReserved* é não **nulo**), todos os threads no processo, exceto o thread atual, já foram encerrados ou foram encerrados explicitamente por uma chamada para a função [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) , o que pode deixar alguns recursos de processo, como heaps em um estado inconsistente.</span><span class="sxs-lookup"><span data-stu-id="af55b-174">If the process is terminating (the *lpvReserved* parameter is non-**NULL**), all threads in the process except the current thread either have exited already or have been explicitly terminated by a call to the [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) function, which might leave some process resources such as heaps in an inconsistent state.</span></span> <span data-ttu-id="af55b-175">Nesse caso, não é seguro para a DLL limpar os recursos.</span><span class="sxs-lookup"><span data-stu-id="af55b-175">In this case, it is not safe for the DLL to clean up the resources.</span></span> <span data-ttu-id="af55b-176">Em vez disso, a DLL deve permitir que o sistema operacional recupere a memória.</span><span class="sxs-lookup"><span data-stu-id="af55b-176">Instead, the DLL should allow the operating system to reclaim the memory.</span></span>

<span data-ttu-id="af55b-177">Se você encerrar um processo chamando [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) ou [**TerminateJobObject**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject), as DLLs desse processo não receberão notificações de **\_ \_ desanexação do processo de dll** .</span><span class="sxs-lookup"><span data-stu-id="af55b-177">If you terminate a process by calling [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) or [**TerminateJobObject**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject), the DLLs of that process do not receive **DLL\_PROCESS\_DETACH** notifications.</span></span> <span data-ttu-id="af55b-178">Se você encerrar um thread chamando [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), as DLLs desse thread não receberão notificações de **\_ \_ desanexação de thread de dll** .</span><span class="sxs-lookup"><span data-stu-id="af55b-178">If you terminate a thread by calling [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), the DLLs of that thread do not receive **DLL\_THREAD\_DETACH** notifications.</span></span>

<span data-ttu-id="af55b-179">A função de ponto de entrada deve executar apenas tarefas simples de inicialização ou demissão.</span><span class="sxs-lookup"><span data-stu-id="af55b-179">The entry-point function should perform only simple initialization or termination tasks.</span></span> <span data-ttu-id="af55b-180">Ele não deve chamar a função [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) ou [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (ou uma função que chama essas funções), pois isso pode criar loops de dependência na ordem de carregamento da dll.</span><span class="sxs-lookup"><span data-stu-id="af55b-180">It must not call the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function (or a function that calls these functions), because this may create dependency loops in the DLL load order.</span></span> <span data-ttu-id="af55b-181">Isso pode resultar na utilização de uma DLL antes que o sistema tenha executado seu código de inicialização.</span><span class="sxs-lookup"><span data-stu-id="af55b-181">This can result in a DLL being used before the system has executed its initialization code.</span></span> <span data-ttu-id="af55b-182">Da mesma forma, a função de ponto de entrada não deve chamar a função [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (ou uma função que chama **FreeLibrary**) durante o encerramento do processo, porque isso pode resultar em uma DLL sendo usada depois que o sistema tiver executado seu código de encerramento.</span><span class="sxs-lookup"><span data-stu-id="af55b-182">Similarly, the entry-point function must not call the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function (or a function that calls **FreeLibrary**) during process termination, because this can result in a DLL being used after the system has executed its termination code.</span></span>

<span data-ttu-id="af55b-183">Como Kernel32.dll é garantido que seja carregado no espaço de endereço do processo quando a função de ponto de entrada é chamada, a chamada de funções no Kernel32.dll não resulta na DLL que está sendo usada antes de seu código de inicialização ser executado.</span><span class="sxs-lookup"><span data-stu-id="af55b-183">Because Kernel32.dll is guaranteed to be loaded in the process address space when the entry-point function is called, calling functions in Kernel32.dll does not result in the DLL being used before its initialization code has been executed.</span></span> <span data-ttu-id="af55b-184">Portanto, a função de ponto de entrada pode chamar funções em Kernel32.dll que não carregam outras DLLs.</span><span class="sxs-lookup"><span data-stu-id="af55b-184">Therefore, the entry-point function can call functions in Kernel32.dll that do not load other DLLs.</span></span> <span data-ttu-id="af55b-185">Por exemplo, *DllMain* pode criar [objetos de sincronização](/windows/desktop/Sync/synchronization-objects) , como seções críticas e mutexes, e usar TLS.</span><span class="sxs-lookup"><span data-stu-id="af55b-185">For example, *DllMain* can create [synchronization objects](/windows/desktop/Sync/synchronization-objects) such as critical sections and mutexes, and use TLS.</span></span> <span data-ttu-id="af55b-186">Infelizmente, não há uma lista abrangente de funções seguras no Kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="af55b-186">Unfortunately, there is not a comprehensive list of safe functions in Kernel32.dll.</span></span>

<span data-ttu-id="af55b-187">Chamar funções que exigem DLLs diferentes de Kernel32.dll pode resultar em problemas que são difíceis de diagnosticar.</span><span class="sxs-lookup"><span data-stu-id="af55b-187">Calling functions that require DLLs other than Kernel32.dll may result in problems that are difficult to diagnose.</span></span> <span data-ttu-id="af55b-188">Por exemplo, a chamada a funções de usuário, Shell e COM pode causar erros de violação de acesso, pois algumas funções carregam outros componentes do sistema.</span><span class="sxs-lookup"><span data-stu-id="af55b-188">For example, calling User, Shell, and COM functions can cause access violation errors, because some functions load other system components.</span></span> <span data-ttu-id="af55b-189">Por outro lado, chamar funções como essas durante o encerramento pode causar erros de violação de acesso porque o componente correspondente pode já ter sido descarregado ou não inicializado.</span><span class="sxs-lookup"><span data-stu-id="af55b-189">Conversely, calling functions such as these during termination can cause access violation errors because the corresponding component may already have been unloaded or uninitialized.</span></span>

<span data-ttu-id="af55b-190">Como as notificações de DLL são serializadas, as funções de ponto de entrada não devem tentar se comunicar com outros threads ou processos.</span><span class="sxs-lookup"><span data-stu-id="af55b-190">Because DLL notifications are serialized, entry-point functions should not attempt to communicate with other threads or processes.</span></span> <span data-ttu-id="af55b-191">Os deadlocks podem ocorrer como resultado.</span><span class="sxs-lookup"><span data-stu-id="af55b-191">Deadlocks may occur as a result.</span></span>

<span data-ttu-id="af55b-192">Para obter informações sobre as práticas recomendadas ao gravar uma DLL, consulte https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices .</span><span class="sxs-lookup"><span data-stu-id="af55b-192">For information on best practices when writing a DLL, see https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices.</span></span>

<span data-ttu-id="af55b-193">Se sua DLL estiver vinculada à biblioteca de tempo de execução C (CRT), o ponto de entrada fornecido pelo CRT chamará os construtores e destruidores para objetos C++ global e estático.</span><span class="sxs-lookup"><span data-stu-id="af55b-193">If your DLL is linked with the C run-time library (CRT), the entry point provided by the CRT calls the constructors and destructors for global and static C++ objects.</span></span> <span data-ttu-id="af55b-194">Portanto, essas restrições para *DllMain* também se aplicam a construtores e destruidores e a qualquer código que seja chamado a partir deles.</span><span class="sxs-lookup"><span data-stu-id="af55b-194">Therefore, these restrictions for *DllMain* also apply to constructors and destructors and any code that is called from them.</span></span>

<span data-ttu-id="af55b-195">Considere chamar [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) ao receber **a \_ \_ anexação do processo de dll**, a menos que sua dll esteja vinculada a CRT (biblioteca de tempo de execução) estática C.</span><span class="sxs-lookup"><span data-stu-id="af55b-195">Consider calling [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) when receiving **DLL\_PROCESS\_ATTACH**, unless your DLL is linked with static C run-time library (CRT).</span></span>


## <a name="requirements"></a><span data-ttu-id="af55b-196">Requisitos</span><span class="sxs-lookup"><span data-stu-id="af55b-196">Requirements</span></span>



| <span data-ttu-id="af55b-197">Requisito</span><span class="sxs-lookup"><span data-stu-id="af55b-197">Requirement</span></span> | <span data-ttu-id="af55b-198">Valor</span><span class="sxs-lookup"><span data-stu-id="af55b-198">Value</span></span> |
|-------------------------------------|--------------------------------------------------------------------------------------|
| <span data-ttu-id="af55b-199">Cliente mínimo com suporte</span><span class="sxs-lookup"><span data-stu-id="af55b-199">Minimum supported client</span></span><br/> | <span data-ttu-id="af55b-200">\[Somente aplicativos da área de trabalho do Windows XP\]</span><span class="sxs-lookup"><span data-stu-id="af55b-200">Windows XP \[desktop apps only\]</span></span><br/>                                          |
| <span data-ttu-id="af55b-201">Servidor mínimo com suporte</span><span class="sxs-lookup"><span data-stu-id="af55b-201">Minimum supported server</span></span><br/> | <span data-ttu-id="af55b-202">\[Somente aplicativos da área de trabalho do Windows Server 2003\]</span><span class="sxs-lookup"><span data-stu-id="af55b-202">Windows Server 2003 \[desktop apps only\]</span></span><br/>                                 |
| <span data-ttu-id="af55b-203">parâmetro</span><span class="sxs-lookup"><span data-stu-id="af55b-203">Header</span></span><br/>                   | <dl> <span data-ttu-id="af55b-204"><dt>Process. h</dt></span><span class="sxs-lookup"><span data-stu-id="af55b-204"><dt>Process.h</dt></span></span> </dl> |



## <a name="see-also"></a><span data-ttu-id="af55b-205">Confira também</span><span class="sxs-lookup"><span data-stu-id="af55b-205">See also</span></span>

<dl> <dt>

[<span data-ttu-id="af55b-206">Função de Entry-Point de biblioteca de vínculo dinâmico</span><span class="sxs-lookup"><span data-stu-id="af55b-206">Dynamic-Link Library Entry-Point Function</span></span>](dynamic-link-library-entry-point-function.md)
</dt> <dt>

[<span data-ttu-id="af55b-207">Funções da biblioteca de vínculo dinâmico</span><span class="sxs-lookup"><span data-stu-id="af55b-207">Dynamic-Link Library Functions</span></span>](dynamic-link-library-functions.md)
</dt> <dt>

[<span data-ttu-id="af55b-208">**FreeLibrary**</span><span class="sxs-lookup"><span data-stu-id="af55b-208">**FreeLibrary**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary)
</dt> <dt>

[<span data-ttu-id="af55b-209">**GetModuleFileName**</span><span class="sxs-lookup"><span data-stu-id="af55b-209">**GetModuleFileName**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamea)
</dt> <dt>

[<span data-ttu-id="af55b-210">**LoadLibrary**</span><span class="sxs-lookup"><span data-stu-id="af55b-210">**LoadLibrary**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)
</dt> <dt>

[<span data-ttu-id="af55b-211">**TlsAlloc**</span><span class="sxs-lookup"><span data-stu-id="af55b-211">**TlsAlloc**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc)
</dt> <dt>

[<span data-ttu-id="af55b-212">**TlsFree**</span><span class="sxs-lookup"><span data-stu-id="af55b-212">**TlsFree**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree)
</dt> <dt>

[<span data-ttu-id="af55b-213">**DisableThreadLibraryCalls**</span><span class="sxs-lookup"><span data-stu-id="af55b-213">**DisableThreadLibraryCalls**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls)





</dt> </dl>
