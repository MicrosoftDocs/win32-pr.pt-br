---
description: Uma DLL pode, opcionalmente, especificar uma função de ponto de entrada.
ms.assetid: ec035fc6-0a6f-4e52-a4cc-8d7a25a94366
title: Dynamic-Link Entry-Point função de biblioteca
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b62bff557bfa2aa792b420e8fe1856bbe0726921
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103647718"
---
# <a name="dynamic-link-library-entry-point-function"></a><span data-ttu-id="a8328-103">Dynamic-Link Entry-Point função de biblioteca</span><span class="sxs-lookup"><span data-stu-id="a8328-103">Dynamic-Link Library Entry-Point Function</span></span>

<span data-ttu-id="a8328-104">Uma DLL pode, opcionalmente, especificar uma função de ponto de entrada.</span><span class="sxs-lookup"><span data-stu-id="a8328-104">A DLL can optionally specify an entry-point function.</span></span> <span data-ttu-id="a8328-105">Se estiver presente, o sistema chamará a função de ponto de entrada sempre que um processo ou thread carregar ou descarregar a DLL.</span><span class="sxs-lookup"><span data-stu-id="a8328-105">If present, the system calls the entry-point function whenever a process or thread loads or unloads the DLL.</span></span> <span data-ttu-id="a8328-106">Ele pode ser usado para executar tarefas simples de inicialização e limpeza.</span><span class="sxs-lookup"><span data-stu-id="a8328-106">It can be used to perform simple initialization and cleanup tasks.</span></span> <span data-ttu-id="a8328-107">Por exemplo, ele pode configurar o armazenamento local do thread quando um novo thread é criado e limpá-lo quando o thread for encerrado.</span><span class="sxs-lookup"><span data-stu-id="a8328-107">For example, it can set up thread local storage when a new thread is created, and clean it up when the thread is terminated.</span></span>

<span data-ttu-id="a8328-108">Se você estiver vinculando sua DLL com a biblioteca de tempo de execução C, ela poderá fornecer uma função de ponto de entrada para você e permitir que você forneça uma função de inicialização separada.</span><span class="sxs-lookup"><span data-stu-id="a8328-108">If you are linking your DLL with the C run-time library, it may provide an entry-point function for you, and allow you to provide a separate initialization function.</span></span> <span data-ttu-id="a8328-109">Verifique a documentação da biblioteca de tempo de execução para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="a8328-109">Check the documentation for your run-time library for more information.</span></span>

<span data-ttu-id="a8328-110">Se você estiver fornecendo seu próprio ponto de entrada, consulte a função [**DllMain**](dllmain.md) .</span><span class="sxs-lookup"><span data-stu-id="a8328-110">If you are providing your own entry-point, see the [**DllMain**](dllmain.md) function.</span></span> <span data-ttu-id="a8328-111">O nome **DllMain** é um espaço reservado para uma função definida pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="a8328-111">The name **DllMain** is a placeholder for a user-defined function.</span></span> <span data-ttu-id="a8328-112">Você deve especificar o nome real que você usa ao compilar sua DLL.</span><span class="sxs-lookup"><span data-stu-id="a8328-112">You must specify the actual name you use when you build your DLL.</span></span> <span data-ttu-id="a8328-113">Para obter mais informações, consulte a documentação incluída com suas ferramentas de desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="a8328-113">For more information, see the documentation included with your development tools.</span></span>

## <a name="calling-the-entry-point-function"></a><span data-ttu-id="a8328-114">Chamando a função Entry-Point</span><span class="sxs-lookup"><span data-stu-id="a8328-114">Calling the Entry-Point Function</span></span>

<span data-ttu-id="a8328-115">O sistema chama a função de ponto de entrada sempre que um dos seguintes eventos ocorre:</span><span class="sxs-lookup"><span data-stu-id="a8328-115">The system calls the entry-point function whenever any one of the following events occurs:</span></span>

-   <span data-ttu-id="a8328-116">Um processo carrega a DLL.</span><span class="sxs-lookup"><span data-stu-id="a8328-116">A process loads the DLL.</span></span> <span data-ttu-id="a8328-117">Para processos que usam vinculação dinâmica em tempo de carregamento, a DLL é carregada durante a inicialização do processo.</span><span class="sxs-lookup"><span data-stu-id="a8328-117">For processes using load-time dynamic linking, the DLL is loaded during process initialization.</span></span> <span data-ttu-id="a8328-118">Para processos que usam vinculação em tempo de execução, a DLL é carregada antes de [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) ou [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) retornar.</span><span class="sxs-lookup"><span data-stu-id="a8328-118">For processes using run-time linking, the DLL is loaded before [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) returns.</span></span>
-   <span data-ttu-id="a8328-119">Um processo descarrega a DLL.</span><span class="sxs-lookup"><span data-stu-id="a8328-119">A process unloads the DLL.</span></span> <span data-ttu-id="a8328-120">A DLL é descarregada quando o processo termina ou chama a função [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) e a contagem de referência se torna zero.</span><span class="sxs-lookup"><span data-stu-id="a8328-120">The DLL is unloaded when the process terminates or calls the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function and the reference count becomes zero.</span></span> <span data-ttu-id="a8328-121">Se o processo for encerrado como resultado da função [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) ou [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) , o sistema não chamará a função de ponto de entrada de dll.</span><span class="sxs-lookup"><span data-stu-id="a8328-121">If the process terminates as a result of the [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) or [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) function, the system does not call the DLL entry-point function.</span></span>
-   <span data-ttu-id="a8328-122">Um novo thread é criado em um processo que carregou a DLL.</span><span class="sxs-lookup"><span data-stu-id="a8328-122">A new thread is created in a process that has loaded the DLL.</span></span> <span data-ttu-id="a8328-123">Você pode usar a função [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) para desabilitar a notificação quando os threads são criados.</span><span class="sxs-lookup"><span data-stu-id="a8328-123">You can use the [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) function to disable notification when threads are created.</span></span>
-   <span data-ttu-id="a8328-124">Um thread de um processo que carregou a DLL é encerrado normalmente, não usando [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) ou [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span><span class="sxs-lookup"><span data-stu-id="a8328-124">A thread of a process that has loaded the DLL terminates normally, not using [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) or [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span></span> <span data-ttu-id="a8328-125">Quando um processo descarrega a DLL, a função de ponto de entrada é chamada apenas uma vez para todo o processo, em vez de uma vez para cada thread existente do processo.</span><span class="sxs-lookup"><span data-stu-id="a8328-125">When a process unloads the DLL, the entry-point function is called only once for the entire process, rather than once for each existing thread of the process.</span></span> <span data-ttu-id="a8328-126">Você pode usar o [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) para desabilitar a notificação quando os threads forem encerrados.</span><span class="sxs-lookup"><span data-stu-id="a8328-126">You can use [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) to disable notification when threads are terminated.</span></span>

<span data-ttu-id="a8328-127">Somente um thread por vez pode chamar a função de ponto de entrada.</span><span class="sxs-lookup"><span data-stu-id="a8328-127">Only one thread at a time can call the entry-point function.</span></span>

<span data-ttu-id="a8328-128">O sistema chama a função de ponto de entrada no contexto do processo ou thread que fez com que a função fosse chamada.</span><span class="sxs-lookup"><span data-stu-id="a8328-128">The system calls the entry-point function in the context of the process or thread that caused the function to be called.</span></span> <span data-ttu-id="a8328-129">Isso permite que uma DLL Use sua função de ponto de entrada para alocar memória no espaço de endereço virtual do processo de chamada ou para abrir identificadores acessíveis para o processo.</span><span class="sxs-lookup"><span data-stu-id="a8328-129">This allows a DLL to use its entry-point function for allocating memory in the virtual address space of the calling process or to open handles accessible to the process.</span></span> <span data-ttu-id="a8328-130">A função de ponto de entrada também pode alocar memória privada para um novo thread usando o armazenamento local de threads (TLS).</span><span class="sxs-lookup"><span data-stu-id="a8328-130">The entry-point function can also allocate memory that is private to a new thread by using thread local storage (TLS).</span></span> <span data-ttu-id="a8328-131">Para obter mais informações sobre o armazenamento local de thread, consulte [armazenamento local de thread](/windows/desktop/ProcThread/thread-local-storage).</span><span class="sxs-lookup"><span data-stu-id="a8328-131">For more information about thread local storage, see [Thread Local Storage](/windows/desktop/ProcThread/thread-local-storage).</span></span>

## <a name="entry-point-function-definition"></a><span data-ttu-id="a8328-132">Definição de função Entry-Point</span><span class="sxs-lookup"><span data-stu-id="a8328-132">Entry-Point Function Definition</span></span>

<span data-ttu-id="a8328-133">A função de ponto de entrada de DLL deve ser declarada com a Convenção de chamada de chamada padrão.</span><span class="sxs-lookup"><span data-stu-id="a8328-133">The DLL entry-point function must be declared with the standard-call calling convention.</span></span> <span data-ttu-id="a8328-134">Se o ponto de entrada da DLL não for declarado corretamente, a DLL não será carregada e o sistema exibirá uma mensagem indicando que o ponto de entrada da DLL deve ser declarado com Winapi tenha.</span><span class="sxs-lookup"><span data-stu-id="a8328-134">If the DLL entry point is not declared correctly, the DLL is not loaded, and the system displays a message indicating that the DLL entry point must be declared with WINAPI.</span></span>

<span data-ttu-id="a8328-135">No corpo da função, você pode lidar com qualquer combinação dos seguintes cenários em que o ponto de entrada de DLL foi chamado:</span><span class="sxs-lookup"><span data-stu-id="a8328-135">In the body of the function, you may handle any combination of the following scenarios in which the DLL entry point has been called:</span></span>

-   <span data-ttu-id="a8328-136">Um processo carrega a DLL (**\_ \_ anexar processo de dll**).</span><span class="sxs-lookup"><span data-stu-id="a8328-136">A process loads the DLL (**DLL\_PROCESS\_ATTACH**).</span></span>
-   <span data-ttu-id="a8328-137">O processo atual cria um novo thread (**\_ \_ anexação de thread de dll**).</span><span class="sxs-lookup"><span data-stu-id="a8328-137">The current process creates a new thread (**DLL\_THREAD\_ATTACH**).</span></span>
-   <span data-ttu-id="a8328-138">Um thread é encerrado normalmente **( \_ \_ desanexar thread de dll**).</span><span class="sxs-lookup"><span data-stu-id="a8328-138">A thread exits normally (**DLL\_THREAD\_DETACH**).</span></span>
-   <span data-ttu-id="a8328-139">Um processo descarrega a DLL (**\_ \_ desanexar processo de dll**).</span><span class="sxs-lookup"><span data-stu-id="a8328-139">A process unloads the DLL (**DLL\_PROCESS\_DETACH**).</span></span>

<span data-ttu-id="a8328-140">A função de ponto de entrada deve executar apenas tarefas de inicialização simples.</span><span class="sxs-lookup"><span data-stu-id="a8328-140">The entry-point function should perform only simple initialization tasks.</span></span> <span data-ttu-id="a8328-141">Ele não deve chamar a função [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) ou [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (ou uma função que chama essas funções), pois isso pode criar loops de dependência na ordem de carregamento da dll.</span><span class="sxs-lookup"><span data-stu-id="a8328-141">It must not call the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function (or a function that calls these functions), because this may create dependency loops in the DLL load order.</span></span> <span data-ttu-id="a8328-142">Isso pode resultar na utilização de uma DLL antes que o sistema tenha executado seu código de inicialização.</span><span class="sxs-lookup"><span data-stu-id="a8328-142">This can result in a DLL being used before the system has executed its initialization code.</span></span> <span data-ttu-id="a8328-143">Da mesma forma, a função de ponto de entrada não deve chamar a função [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (ou uma função que chama **FreeLibrary**) durante o encerramento do processo, porque isso pode resultar em uma DLL sendo usada depois que o sistema tiver executado seu código de encerramento.</span><span class="sxs-lookup"><span data-stu-id="a8328-143">Similarly, the entry-point function must not call the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function (or a function that calls **FreeLibrary**) during process termination, because this can result in a DLL being used after the system has executed its termination code.</span></span>

<span data-ttu-id="a8328-144">Como Kernel32.dll é garantido que seja carregado no espaço de endereço do processo quando a função de ponto de entrada é chamada, a chamada de funções no Kernel32.dll não resulta na DLL que está sendo usada antes de seu código de inicialização ser executado.</span><span class="sxs-lookup"><span data-stu-id="a8328-144">Because Kernel32.dll is guaranteed to be loaded in the process address space when the entry-point function is called, calling functions in Kernel32.dll does not result in the DLL being used before its initialization code has been executed.</span></span> <span data-ttu-id="a8328-145">Portanto, a função de ponto de entrada pode criar [objetos de sincronização](/windows/desktop/Sync/synchronization-objects) , como seções críticas e mutexes, e usar TLS, pois essas funções estão localizadas em Kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="a8328-145">Therefore, the entry-point function can create [synchronization objects](/windows/desktop/Sync/synchronization-objects) such as critical sections and mutexes, and use TLS, because these functions are located in Kernel32.dll.</span></span> <span data-ttu-id="a8328-146">Não é seguro chamar as funções de registro, por exemplo, porque elas estão localizadas em Advapi32.dll.</span><span class="sxs-lookup"><span data-stu-id="a8328-146">It is not safe to call the registry functions, for example, because they are located in Advapi32.dll.</span></span>

<span data-ttu-id="a8328-147">Chamar outras funções pode resultar em problemas que são difíceis de diagnosticar.</span><span class="sxs-lookup"><span data-stu-id="a8328-147">Calling other functions may result in problems that are difficult to diagnose.</span></span> <span data-ttu-id="a8328-148">Por exemplo, chamar o usuário, o Shell e as funções COM pode causar erros de violação de acesso, porque algumas funções em suas DLLs chamam [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) para carregar outros componentes do sistema.</span><span class="sxs-lookup"><span data-stu-id="a8328-148">For example, calling User, Shell, and COM functions can cause access violation errors, because some functions in their DLLs call [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) to load other system components.</span></span> <span data-ttu-id="a8328-149">Por outro lado, chamar essas funções durante o encerramento pode causar erros de violação de acesso porque o componente correspondente pode já ter sido descarregado ou não inicializado.</span><span class="sxs-lookup"><span data-stu-id="a8328-149">Conversely, calling those functions during termination can cause access violation errors because the corresponding component may already have been unloaded or uninitialized.</span></span>

<span data-ttu-id="a8328-150">O exemplo a seguir demonstra como estruturar a função de ponto de entrada de DLL.</span><span class="sxs-lookup"><span data-stu-id="a8328-150">The following example demonstrates how to structure the DLL entry-point function.</span></span>

``` syntax
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

## <a name="entry-point-function-return-value"></a><span data-ttu-id="a8328-151">Entry-Point valor de retorno da função</span><span class="sxs-lookup"><span data-stu-id="a8328-151">Entry-Point Function Return Value</span></span>

<span data-ttu-id="a8328-152">Quando uma função de ponto de entrada de DLL é chamada porque um processo está sendo carregado, a função retorna **true** para indicar êxito.</span><span class="sxs-lookup"><span data-stu-id="a8328-152">When a DLL entry-point function is called because a process is loading, the function returns **TRUE** to indicate success.</span></span> <span data-ttu-id="a8328-153">Para processos que usam vinculação de tempo de carga, um valor de retorno **false** faz com que a inicialização do processo falhe e o processo seja encerrado.</span><span class="sxs-lookup"><span data-stu-id="a8328-153">For processes using load-time linking, a return value of **FALSE** causes the process initialization to fail and the process terminates.</span></span> <span data-ttu-id="a8328-154">Para processos que usam vinculação em tempo de execução, um valor de retorno FALSE faz com que a função [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) ou [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) retorne **NULL**, indicando falha.</span><span class="sxs-lookup"><span data-stu-id="a8328-154">For processes using run-time linking, a return value of FALSE causes the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function to return **NULL**, indicating failure.</span></span> <span data-ttu-id="a8328-155">(O sistema chama imediatamente sua função de ponto de entrada com o **processo de dll \_ \_ desanexar** e descarrega a dll.) O valor de retorno da função de ponto de entrada é desconsiderado quando a função é chamada por qualquer outro motivo.</span><span class="sxs-lookup"><span data-stu-id="a8328-155">(The system immediately calls your entry-point function with **DLL\_PROCESS\_DETACH** and unloads the DLL.) The return value of the entry-point function is disregarded when the function is called for any other reason.</span></span>

 

 
