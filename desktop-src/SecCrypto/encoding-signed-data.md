---
description: Descreve o procedimento para codificar uma mensagem assinada.
ms.assetid: 40d1c417-6d88-4421-920f-8b40d88d28ce
title: Codificando dados assinados
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: be4a542fe0890a6ee9d51ebc1a5ee6b98bab4242
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104170921"
---
# <a name="encoding-signed-data"></a><span data-ttu-id="f230d-103">Codificando dados assinados</span><span class="sxs-lookup"><span data-stu-id="f230d-103">Encoding Signed Data</span></span>

<span data-ttu-id="f230d-104">Os [*dados assinados*](../secgloss/s-gly.md) consistem no conteúdo de qualquer tipo e [*hashes*](../secgloss/h-gly.md) de mensagens criptografadas do conteúdo por zero ou mais assinantes.</span><span class="sxs-lookup"><span data-stu-id="f230d-104">[*Signed data*](../secgloss/s-gly.md) consists of content of any type and encrypted message [*hashes*](../secgloss/h-gly.md) of the content by zero or more signers.</span></span> <span data-ttu-id="f230d-105">O hash resultante pode confirmar que a mensagem original não foi modificada desde a assinatura e que as pessoas ou entidades em particular assinaram os dados.</span><span class="sxs-lookup"><span data-stu-id="f230d-105">The resulting hash can confirm that the original message has not been modified since signing and that particular persons or entities signed the data.</span></span>

<span data-ttu-id="f230d-106">A ilustração a seguir descreve o procedimento para codificar uma mensagem assinada.</span><span class="sxs-lookup"><span data-stu-id="f230d-106">The following illustration depicts the procedure for encoding a signed message.</span></span> <span data-ttu-id="f230d-107">A lista após a ilustração descreve as etapas.</span><span class="sxs-lookup"><span data-stu-id="f230d-107">The list following the illustration describes the steps.</span></span>

<span data-ttu-id="f230d-108">Uma mensagem pode ter vários assinantes, algoritmos de hash e certificados.</span><span class="sxs-lookup"><span data-stu-id="f230d-108">A message may have multiple signers, hashing algorithms, and certificates.</span></span> <span data-ttu-id="f230d-109">Embora a ilustração mostre somente certificados, [*CRLs*](../secgloss/c-gly.md)e [*CTLs*](../secgloss/c-gly.md) podem usar o mesmo processo.</span><span class="sxs-lookup"><span data-stu-id="f230d-109">While the illustration shows only certificates, [*CRLs*](../secgloss/c-gly.md), and [*CTLs*](../secgloss/c-gly.md) can use the same process.</span></span> <span data-ttu-id="f230d-110">Elas se ajustarão à ilustração sempre que os certificados forem mostrados.</span><span class="sxs-lookup"><span data-stu-id="f230d-110">They would fit into the illustration wherever certificates are shown.</span></span>

![Codificando uma mensagem assinada](images/signmsg2.png)

<span data-ttu-id="f230d-112">O processo geral de codificação de [*dados assinados*](../secgloss/s-gly.md) é o seguinte.</span><span class="sxs-lookup"><span data-stu-id="f230d-112">The general process for encoding [*Signed data*](../secgloss/s-gly.md) is as follows.</span></span>

<span data-ttu-id="f230d-113">**Para codificar dados assinados**</span><span class="sxs-lookup"><span data-stu-id="f230d-113">**To encode signed data**</span></span>

1.  <span data-ttu-id="f230d-114">Os dados são criados (se necessário) e um ponteiro para ele é recuperado.</span><span class="sxs-lookup"><span data-stu-id="f230d-114">The data is created (if necessary), and a pointer to it is retrieved.</span></span>
2.  <span data-ttu-id="f230d-115">Um [*repositório de certificados*](../secgloss/c-gly.md) é aberto que contém o certificado do signatário.</span><span class="sxs-lookup"><span data-stu-id="f230d-115">A [*certificate store*](../secgloss/c-gly.md) is opened that contains the signer's certificate.</span></span>
3.  <span data-ttu-id="f230d-116">A chave privada para o certificado é recuperada.</span><span class="sxs-lookup"><span data-stu-id="f230d-116">The private key for the certificate is retrieved.</span></span> <span data-ttu-id="f230d-117">Há duas propriedades que devem ser definidas no certificado antes de usá-lo.</span><span class="sxs-lookup"><span data-stu-id="f230d-117">There are two properties that must be set on the certificate before using it.</span></span> <span data-ttu-id="f230d-118">Uma é usada para vincular um certificado a um CSP específico e, dentro desse CSP, a um contêiner de [*chave*](../secgloss/k-gly.md)privada específico.</span><span class="sxs-lookup"><span data-stu-id="f230d-118">One is used to tie a certificate to a particular CSP and, within that CSP, to a particular private [*key container*](../secgloss/k-gly.md).</span></span> <span data-ttu-id="f230d-119">O outro é usado para indicar qual algoritmo de hash deve ser usado quando uma operação de [*hash*](../secgloss/h-gly.md) é chamada.</span><span class="sxs-lookup"><span data-stu-id="f230d-119">The other is used to indicate which hashing algorithm is to be used when a [*hash*](../secgloss/h-gly.md) operation is called.</span></span> <span data-ttu-id="f230d-120">Essas necessidades só precisam ser definidas uma vez.</span><span class="sxs-lookup"><span data-stu-id="f230d-120">These need only be set once.</span></span>
4.  <span data-ttu-id="f230d-121">A propriedade de um certificado determina o algoritmo de hash.</span><span class="sxs-lookup"><span data-stu-id="f230d-121">A certificate's property determines the hash algorithm.</span></span>
5.  <span data-ttu-id="f230d-122">Um hash dos dados é criado enviando os dados por meio da função de hash.</span><span class="sxs-lookup"><span data-stu-id="f230d-122">A hash of the data is created by sending the data through the hashing function.</span></span>
6.  <span data-ttu-id="f230d-123">A assinatura é criada criptografando-se o hash usando a chave privada, obtida por meio de uma propriedade no certificado.</span><span class="sxs-lookup"><span data-stu-id="f230d-123">The signature is created by encrypting the hash using the private key, obtained through a property on the certificate.</span></span>
7.  <span data-ttu-id="f230d-124">Os dados a seguir estão incluídos na mensagem assinada concluída:</span><span class="sxs-lookup"><span data-stu-id="f230d-124">The following data is included in the finished, signed message:</span></span>
    -   <span data-ttu-id="f230d-125">Os dados originais a serem assinados</span><span class="sxs-lookup"><span data-stu-id="f230d-125">The original data to be signed</span></span>
    -   <span data-ttu-id="f230d-126">Os algoritmos de hash</span><span class="sxs-lookup"><span data-stu-id="f230d-126">The hash algorithms</span></span>
    -   <span data-ttu-id="f230d-127">As assinaturas</span><span class="sxs-lookup"><span data-stu-id="f230d-127">The signatures</span></span>
    -   <span data-ttu-id="f230d-128">As estruturas de informações do Assinante, que incluem o identificador de signatário (emissor do certificado e número de série)</span><span class="sxs-lookup"><span data-stu-id="f230d-128">The signer info structures, which includes the signer identifier (certificate issuer and serial number)</span></span>
    -   <span data-ttu-id="f230d-129">Os certificados do signatário (opcional)</span><span class="sxs-lookup"><span data-stu-id="f230d-129">The signer's certificates (optional)</span></span>

<span data-ttu-id="f230d-130">Este procedimento ilustra um caso simples.</span><span class="sxs-lookup"><span data-stu-id="f230d-130">This procedure illustrates a simple case.</span></span> <span data-ttu-id="f230d-131">Casos mais complexos envolvem atributos autenticados incluídos na mensagem.</span><span class="sxs-lookup"><span data-stu-id="f230d-131">More complex cases involve authenticated attributes included in the message.</span></span> <span data-ttu-id="f230d-132">Quando o tipo de conteúdo é qualquer coisa, exceto uma cadeia de caracteres de **byte** , ou há pelo menos um atributo autenticado junto com qualquer tipo de dados, há dois atributos autenticados padrão necessários: o tipo de conteúdo (dados) e o hash do conteúdo.</span><span class="sxs-lookup"><span data-stu-id="f230d-132">When the content type is anything but a **BYTE** string, or there is at least one authenticated attribute along with any data type, there are two standard authenticated attributes required: the content (data) type, and the hash of the content.</span></span> <span data-ttu-id="f230d-133">Sob essas circunstâncias, a [*CryptoAPI*](../secgloss/c-gly.md) fornece automaticamente esses dois atributos necessários.</span><span class="sxs-lookup"><span data-stu-id="f230d-133">Under these circumstances, the [*CryptoAPI*](../secgloss/c-gly.md) automatically provides these two required attributes.</span></span> <span data-ttu-id="f230d-134">As funções da mensagem de nível baixo aplicam hash aos atributos autenticados, criptografam o hash com a chave privada e fornecem isso como a assinatura.</span><span class="sxs-lookup"><span data-stu-id="f230d-134">The low-level message functions hash the authenticated attributes, encrypt the hash with the private key, and provide this as the signature.</span></span>

<span data-ttu-id="f230d-135">Use as funções de mensagem de baixo nível para realizar as tarefas listadas, usando o procedimento a seguir.</span><span class="sxs-lookup"><span data-stu-id="f230d-135">Use the low-level message functions to accomplish the tasks just listed, by using the following procedure.</span></span>

<span data-ttu-id="f230d-136">**Para codificar uma mensagem assinada**</span><span class="sxs-lookup"><span data-stu-id="f230d-136">**To encode a signed message**</span></span>

1.  <span data-ttu-id="f230d-137">Crie ou recupere o conteúdo.</span><span class="sxs-lookup"><span data-stu-id="f230d-137">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="f230d-138">Obter um provedor criptográfico.</span><span class="sxs-lookup"><span data-stu-id="f230d-138">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="f230d-139">Obtenha os certificados de signatário.</span><span class="sxs-lookup"><span data-stu-id="f230d-139">Get the signer certificates.</span></span>
4.  <span data-ttu-id="f230d-140">Inicialize a estrutura de [**\_ informações de \_ codificação \_ do signatário CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="f230d-140">Initialize the [**CMSG\_SIGNER\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) structure.</span></span>
5.  <span data-ttu-id="f230d-141">Inicialize a estrutura de [**\_ \_ \_ informações de codificação assinada do CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="f230d-141">Initialize the [**CMSG\_SIGNED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) structure.</span></span>
6.  <span data-ttu-id="f230d-142">Chame [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) para obter o tamanho do blob de mensagens codificadas.</span><span class="sxs-lookup"><span data-stu-id="f230d-142">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="f230d-143">Aloque memória para ele.</span><span class="sxs-lookup"><span data-stu-id="f230d-143">Allocate memory for it.</span></span>
7.  <span data-ttu-id="f230d-144">Chame [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passando CMSG \_ assinado para *dwMsgType* e um ponteiro para [**CMSG \_ informações de \_ codificação \_ assinadas**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) para *pvMsgEncodeInfo* para obter um identificador para a mensagem aberta.</span><span class="sxs-lookup"><span data-stu-id="f230d-144">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_SIGNED for *dwMsgType* and a pointer to [**CMSG\_SIGNED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) for *pvMsgEncodeInfo* to get a handle to the opened message.</span></span>
8.  <span data-ttu-id="f230d-145">Chame [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passando o identificador recuperado na etapa 7 e um ponteiro para os dados que serão assinados e codificados.</span><span class="sxs-lookup"><span data-stu-id="f230d-145">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 7, and a pointer to the data that is to be signed and encoded.</span></span> <span data-ttu-id="f230d-146">Essa função pode ser chamada quantas vezes forem necessárias para concluir o processo de codificação.</span><span class="sxs-lookup"><span data-stu-id="f230d-146">This function can be called as many times as necessary to complete the encoding process.</span></span>
9.  <span data-ttu-id="f230d-147">Chame [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passando o identificador recuperado na etapa 7 e os tipos de parâmetro apropriados para acessar os dados desejados e codificados.</span><span class="sxs-lookup"><span data-stu-id="f230d-147">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 7 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="f230d-148">Por exemplo, passe \_ o parâmetro de conteúdo CMSG \_ para obter um ponteiro para toda a mensagem [*PKCS \# 7*](../secgloss/p-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="f230d-148">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire [*PKCS \#7*](../secgloss/p-gly.md) message.</span></span>

    <span data-ttu-id="f230d-149">Se o resultado dessa codificação for ser usado como os [*dados internos*](../secgloss/i-gly.md) para outra mensagem codificada, como uma mensagem envelopada, o \_ parâmetro CMSG Bare \_ Content \_ param deverá ser passado.</span><span class="sxs-lookup"><span data-stu-id="f230d-149">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="f230d-150">Para ver um exemplo que mostra isso, consulte [código alternativo para codificar uma mensagem envelopada](alternate-code-for-encoding-an-enveloped-message.md).</span><span class="sxs-lookup"><span data-stu-id="f230d-150">For an example showing this, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

10. <span data-ttu-id="f230d-151">Feche a mensagem chamando [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="f230d-151">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="f230d-152">O resultado desse procedimento é uma mensagem codificada que contém os dados originais, o hash criptografado desses dados (assinatura) e as informações do signatário.</span><span class="sxs-lookup"><span data-stu-id="f230d-152">The result of this procedure is an encoded message that contains the original data, the encrypted hash of that data (signature), and the signer information.</span></span> <span data-ttu-id="f230d-153">Também há um ponteiro para o BLOB desejado e codificado.</span><span class="sxs-lookup"><span data-stu-id="f230d-153">There is also a pointer to the desired, encoded BLOB.</span></span>

<span data-ttu-id="f230d-154">Para obter detalhes de codificação C, consulte [exemplo c programa: assinatura, codificação, decodificação e verificação de uma mensagem](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span><span class="sxs-lookup"><span data-stu-id="f230d-154">For C coding details, see [Example C Program: Signing, Encoding, Decoding, and Verifying a Message](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span></span>

 

 
