---
description: A sintaxe da mensagem criptográfica pode ser usada para codificar mensagens envelopadas.
ms.assetid: f35aacda-6827-42e9-b7ac-58dc007fc697
title: Codificando dados Envelopos
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53dc20fc7483ba1ef364d8b59824d26bd14d458d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104559199"
---
# <a name="encoding-enveloped-data"></a><span data-ttu-id="0d802-103">Codificando dados Envelopos</span><span class="sxs-lookup"><span data-stu-id="0d802-103">Encoding Enveloped Data</span></span>

<span data-ttu-id="0d802-104">Os dados de envelope consistem no conteúdo criptografado de qualquer tipo e chaves de sessão de criptografia de conteúdo criptografado para um ou mais destinatários.</span><span class="sxs-lookup"><span data-stu-id="0d802-104">Enveloped data consists of encrypted content of any type and encrypted content-encryption session keys for one or more recipients.</span></span> <span data-ttu-id="0d802-105">As mensagens envelopadas mantêm o conteúdo do segredo da mensagem e permitem que apenas pessoas ou entidades especificadas recuperem o conteúdo.</span><span class="sxs-lookup"><span data-stu-id="0d802-105">Enveloped messages keep the contents of the message secret and allow only specified persons or entities to retrieve the contents.</span></span>

<span data-ttu-id="0d802-106">A sintaxe de mensagem de criptografia (CMS) pode ser usada para codificar mensagens envelopadas.</span><span class="sxs-lookup"><span data-stu-id="0d802-106">Cryptographic message syntax (CMS) can be used to encode enveloped messages.</span></span> <span data-ttu-id="0d802-107">O CMS dá suporte a três técnicas de gerenciamento de chaves: transporte de chave, contrato de chave e chaves de criptografia de chave simétrica distribuídas anteriormente (KEK).</span><span class="sxs-lookup"><span data-stu-id="0d802-107">CMS supports three key management techniques: key transport, key agreement, and previously distributed symmetric key-encryption keys (KEK).</span></span> <span data-ttu-id="0d802-108">Os KEK simétricos distribuídos anteriormente também são conhecidos como distribuição de chaves de lista de endereçamento.</span><span class="sxs-lookup"><span data-stu-id="0d802-108">Previously distributed symmetric KEK are also known as mailing list key distribution.</span></span>

<span data-ttu-id="0d802-109">Em cada uma dessas três técnicas, uma única chave de sessão é gerada para criptografar a mensagem envelopada.</span><span class="sxs-lookup"><span data-stu-id="0d802-109">In each of these three techniques, a single session key is generated to encrypt the enveloped message.</span></span> <span data-ttu-id="0d802-110">Os problemas de gerenciamento de chaves lidam com o modo como a chave de sessão é criptografada pelo remetente e descriptografada por um receptor.</span><span class="sxs-lookup"><span data-stu-id="0d802-110">Key management issues deal with the way that session key is encrypted by the sender and decrypted by a receiver.</span></span> <span data-ttu-id="0d802-111">Uma única mensagem criptografada pode ser distribuída para muitos destinatários usando uma combinação das técnicas de gerenciamento de chaves.</span><span class="sxs-lookup"><span data-stu-id="0d802-111">A single encrypted message can be distributed to many recipients using a mixture of the key management techniques.</span></span>

<span data-ttu-id="0d802-112">O gerenciamento de chaves de transporte de chave usa a chave pública do destinatário pretendido para criptografar a chave de sessão.</span><span class="sxs-lookup"><span data-stu-id="0d802-112">Key transport key management uses an intended receiver's public key to encrypt the session key.</span></span> <span data-ttu-id="0d802-113">O destinatário descriptografa a chave de sessão usando a chave privada associada à chave pública que foi usada para criptografar.</span><span class="sxs-lookup"><span data-stu-id="0d802-113">The receiver decrypts the session key using the private key associated with the public key that was used to encrypt.</span></span> <span data-ttu-id="0d802-114">Em seguida, o receptor usa a chave de sessão descriptografada para descriptografar os dados de envelope.</span><span class="sxs-lookup"><span data-stu-id="0d802-114">The receiver then uses the decrypted session key to decrypt the enveloped data.</span></span> <span data-ttu-id="0d802-115">Quando o transporte de chave é usado, o receptor não confirmou informações sobre a identidade do remetente.</span><span class="sxs-lookup"><span data-stu-id="0d802-115">When key transport is used, the receiver has not confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="0d802-116">No gerenciamento de contrato de chave, uma chave privada temporária, efêmera Diffie-Hellman é gerada e usada para criptografar a chave de sessão.</span><span class="sxs-lookup"><span data-stu-id="0d802-116">In key agreement management, a temporary, ephemeral Diffie-Hellman private key is generated and used to encrypt the session key.</span></span> <span data-ttu-id="0d802-117">A chave pública correspondente à chave privada efêmera é incluída como parte das informações de destinatário da mensagem.</span><span class="sxs-lookup"><span data-stu-id="0d802-117">The public key corresponding to the ephemeral private key is included as part of the message's recipient information.</span></span> <span data-ttu-id="0d802-118">O destinatário descriptografa a chave de sessão usando a chave efêmera recebida e usa essa chave de sessão descriptografada para descriptografar a mensagem envelopada.</span><span class="sxs-lookup"><span data-stu-id="0d802-118">The recipient decrypts the session key using the received ephemeral key and uses this decrypted session key to decrypt the enveloped message.</span></span> <span data-ttu-id="0d802-119">Usando o contrato de chave efêmera em conjunto com a chave privada do receptor, o receptor da mensagem confirmava informações sobre a identidade do remetente.</span><span class="sxs-lookup"><span data-stu-id="0d802-119">Using ephemeral key agreement in conjunction with the receiver's private key, the message receiver does have confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="0d802-120">Para o gerenciamento de chaves usando [*chaves simétricas*](../secgloss/s-gly.md)distribuídas anteriormente, cada mensagem inclui a chave de criptografia de conteúdo que foi criptografada com uma chave de criptografia de chave distribuída anteriormente.</span><span class="sxs-lookup"><span data-stu-id="0d802-120">For key management using previously distributed [*symmetric keys*](../secgloss/s-gly.md), each message includes the content-encryption key that has been encrypted with a previously distributed key-encryption key.</span></span> <span data-ttu-id="0d802-121">Os receptores usam a chave de criptografia de chave distribuída anteriormente para descriptografar a chave de criptografia de conteúdo e, em seguida, usam a chave de criptografia de conteúdo descriptografada para descriptografar a mensagem envelopada.</span><span class="sxs-lookup"><span data-stu-id="0d802-121">Receivers use the previously distributed key-encryption key to decrypt the content encryption key, then use the decrypted content-encryption key to decrypt the enveloped message.</span></span>

<span data-ttu-id="0d802-122">Uma sequência de eventos típica de CMS para codificação de dados envelopes, é mostrada na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="0d802-122">A typical CMS sequence of events for encoding enveloped data, is shown in the following illustration.</span></span>

![codificando dados envelopos](images/envelmsg.png)

-   <span data-ttu-id="0d802-124">Um ponteiro para a mensagem de [*texto não criptografado*](../secgloss/p-gly.md) é recuperado.</span><span class="sxs-lookup"><span data-stu-id="0d802-124">A pointer to the [*plaintext*](../secgloss/p-gly.md) message is retrieved.</span></span>
-   <span data-ttu-id="0d802-125">Uma chave simétrica ([*sessão*](../secgloss/s-gly.md)) é gerada.</span><span class="sxs-lookup"><span data-stu-id="0d802-125">A symmetric ([*session*](../secgloss/s-gly.md)) key is generated.</span></span>
-   <span data-ttu-id="0d802-126">A [*chave simétrica*](../secgloss/s-gly.md) e o algoritmo de criptografia especificado são usados para criptografar os dados da mensagem.</span><span class="sxs-lookup"><span data-stu-id="0d802-126">The [*symmetric key*](../secgloss/s-gly.md) and specified encryption algorithm are used to encrypt the message data.</span></span>
-   <span data-ttu-id="0d802-127">Um [*repositório de certificados*](../secgloss/c-gly.md) é aberto.</span><span class="sxs-lookup"><span data-stu-id="0d802-127">A [*certificate store*](../secgloss/c-gly.md) is opened.</span></span>
-   <span data-ttu-id="0d802-128">O certificado do destinatário é recuperado do repositório.</span><span class="sxs-lookup"><span data-stu-id="0d802-128">The recipient's certificate is retrieved from the store.</span></span>
-   <span data-ttu-id="0d802-129">A [*chave pública*](../secgloss/p-gly.md) é recuperada do certificado do destinatário.</span><span class="sxs-lookup"><span data-stu-id="0d802-129">The [*public key*](../secgloss/p-gly.md) is retrieved from the recipient's certificate.</span></span>
-   <span data-ttu-id="0d802-130">Usando a chave pública do destinatário, a chave simétrica é criptografada.</span><span class="sxs-lookup"><span data-stu-id="0d802-130">Using the recipient's public key, the symmetric key is encrypted.</span></span>
-   <span data-ttu-id="0d802-131">Do certificado do destinatário, a ID do destinatário é recuperada.</span><span class="sxs-lookup"><span data-stu-id="0d802-131">From the recipient's certificate, the recipient's ID is retrieved.</span></span>
-   <span data-ttu-id="0d802-132">As informações a seguir estão incluídas na mensagem digitalmente envelopada: o algoritmo de criptografia de dados, os dados criptografados, a chave simétrica criptografada e a estrutura de informações do destinatário.</span><span class="sxs-lookup"><span data-stu-id="0d802-132">The following information is included in the digitally enveloped message: the data encryption algorithm, the encrypted data, the encrypted symmetric key, and the recipient information structure.</span></span>

<span data-ttu-id="0d802-133">Para usar funções de mensagens de nível baixo para realizar as tarefas típicas listadas, use o procedimento a seguir.</span><span class="sxs-lookup"><span data-stu-id="0d802-133">To use low-level message functions to accomplish the typical tasks just listed, use the following procedure.</span></span>

<span data-ttu-id="0d802-134">**Para codificar uma mensagem envelopada**</span><span class="sxs-lookup"><span data-stu-id="0d802-134">**To encode an enveloped message**</span></span>

1.  <span data-ttu-id="0d802-135">Crie ou recupere o conteúdo.</span><span class="sxs-lookup"><span data-stu-id="0d802-135">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="0d802-136">Obter um provedor criptográfico.</span><span class="sxs-lookup"><span data-stu-id="0d802-136">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="0d802-137">Obter um certificado de destinatário.</span><span class="sxs-lookup"><span data-stu-id="0d802-137">Get a recipient certificate.</span></span>
4.  <span data-ttu-id="0d802-138">Inicialize a estrutura de [**\_ \_ \_ informações de codificação envelopada do CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="0d802-138">Initialize the [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) structure.</span></span>
5.  <span data-ttu-id="0d802-139">Chame [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) para obter o tamanho do blob de mensagens codificadas.</span><span class="sxs-lookup"><span data-stu-id="0d802-139">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="0d802-140">Aloque memória para ele.</span><span class="sxs-lookup"><span data-stu-id="0d802-140">Allocate memory for it.</span></span>
6.  <span data-ttu-id="0d802-141">Chame [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passando CMSG \_ envelopeed para *dwMsgType* e um ponteiro para [**CMSG \_ \_ \_ informações de codificação envelopadas**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) para *pvMsgEncodeInfo*.</span><span class="sxs-lookup"><span data-stu-id="0d802-141">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_ENVELOPED for *dwMsgType* and a pointer to [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) for *pvMsgEncodeInfo*.</span></span> <span data-ttu-id="0d802-142">Como resultado dessa chamada, você receberá um identificador para a mensagem aberta.</span><span class="sxs-lookup"><span data-stu-id="0d802-142">As a result of this call, you will get a handle to the opened message.</span></span>
7.  <span data-ttu-id="0d802-143">Chame [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passando o identificador recuperado na etapa 6 e um ponteiro para os dados que serão criptografados, envelopos e codificados.</span><span class="sxs-lookup"><span data-stu-id="0d802-143">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 6 and a pointer to the data that is to be encrypted, enveloped, and encoded.</span></span> <span data-ttu-id="0d802-144">Essa função pode ser chamada quantas vezes forem necessárias para concluir o processo de codificação.</span><span class="sxs-lookup"><span data-stu-id="0d802-144">This function can be called as many times as necessary to complete the encoding process.</span></span>
8.  <span data-ttu-id="0d802-145">Chame [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passando o identificador recuperado na etapa 6 e os tipos de parâmetro apropriados para acessar os dados desejados e codificados.</span><span class="sxs-lookup"><span data-stu-id="0d802-145">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 6 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="0d802-146">Por exemplo, passe \_ o parâmetro de conteúdo CMSG \_ para obter um ponteiro para toda a \# mensagem PKCS 7.</span><span class="sxs-lookup"><span data-stu-id="0d802-146">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire PKCS \#7 message.</span></span>

    <span data-ttu-id="0d802-147">Se o resultado dessa codificação for ser usado como os [*dados internos*](../secgloss/i-gly.md) para outra mensagem codificada, como uma mensagem envelopada, o \_ parâmetro CMSG Bare \_ Content \_ param deverá ser passado.</span><span class="sxs-lookup"><span data-stu-id="0d802-147">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="0d802-148">Para obter um exemplo, consulte [código alternativo para codificar uma mensagem envelopada](alternate-code-for-encoding-an-enveloped-message.md).</span><span class="sxs-lookup"><span data-stu-id="0d802-148">For an example, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

9.  <span data-ttu-id="0d802-149">Feche a mensagem chamando [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="0d802-149">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="0d802-150">O resultado desse procedimento é uma mensagem codificada que contém os dados criptografados, a [*chave simétrica*](../secgloss/s-gly.md) que é criptografada com as chaves públicas do destinatário e as estruturas de dados de informações de destinatário.</span><span class="sxs-lookup"><span data-stu-id="0d802-150">The result of this procedure is an encoded message that contains the encrypted data, the [*symmetric key*](../secgloss/s-gly.md) that is encrypted with the recipient's public keys, and the recipient information data structures.</span></span> <span data-ttu-id="0d802-151">A combinação de conteúdo criptografado e uma chave simétrica criptografada para um destinatário é um [*envelope digital*](../secgloss/d-gly.md) para esse destinatário.</span><span class="sxs-lookup"><span data-stu-id="0d802-151">The combination of encrypted content and an encrypted symmetric key for a recipient is a [*digital envelope*](../secgloss/d-gly.md) for that recipient.</span></span> <span data-ttu-id="0d802-152">Qualquer tipo de conteúdo pode ser envelopado para vários destinatários.</span><span class="sxs-lookup"><span data-stu-id="0d802-152">Any type of content can be enveloped for multiple recipients.</span></span>

## <a name="related-topics"></a><span data-ttu-id="0d802-153">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="0d802-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="0d802-154">Programa C de exemplo: codificando uma mensagem envelopada e assinada</span><span class="sxs-lookup"><span data-stu-id="0d802-154">Example C Program: Encoding an Enveloped, Signed Message</span></span>](example-c-program-encoding-an-enveloped-signed-message.md)
</dt> </dl>

 

 
