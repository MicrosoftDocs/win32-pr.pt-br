---
description: Várias funções fornecem serviços para gerenciar um estado de repositório de certificados.
ms.assetid: bae3d693-31b3-4c1d-9a8f-0dafa8bb6897
title: Gerenciando um estado de repositório de certificados
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53d66e40817f0f92f48e8841455998eff4dbffd6
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/05/2021
ms.locfileid: "103930232"
---
# <a name="managing-a-certificate-store-state"></a><span data-ttu-id="71823-103">Gerenciando um estado de repositório de certificados</span><span class="sxs-lookup"><span data-stu-id="71823-103">Managing a Certificate Store State</span></span>

<span data-ttu-id="71823-104">Várias funções fornecem serviços para gerenciar um [](../secgloss/c-gly.md) [*estado*](../secgloss/s-gly.md)de repositório de certificados.</span><span class="sxs-lookup"><span data-stu-id="71823-104">Several functions provide services for managing a [*certificate store*](../secgloss/c-gly.md) [*state*](../secgloss/s-gly.md).</span></span>

<span data-ttu-id="71823-105">Para obter acesso a certificados, o repositório de certificados no qual eles são armazenados deve ser aberto por meio de uma chamada para [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) ou [**CertOpenSystemStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea).</span><span class="sxs-lookup"><span data-stu-id="71823-105">To gain access to certificates, the certificate store in which they are stored must be opened through a call to [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) or [**CertOpenSystemStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea).</span></span>

<span data-ttu-id="71823-106">Geralmente, um repositório de certificados é aberto na memória armazenada em cache.</span><span class="sxs-lookup"><span data-stu-id="71823-106">Usually a certificate store is opened in cached memory.</span></span> <span data-ttu-id="71823-107">Pode ser um novo repositório ou seu conteúdo pode ser carregado do Registro local, do registro em um computador remoto, de um arquivo de disco, de uma \# mensagem PKCS 7 ou de alguma outra fonte.</span><span class="sxs-lookup"><span data-stu-id="71823-107">It can be a new store or its contents can be loaded from the local registry, the registry on a remote computer, a disk file, a PKCS \#7 message, or some other source.</span></span>

<span data-ttu-id="71823-108">As funções de repositório de certificados CryptoAPI também permitem que um armazenamento mantenha certificados fora da memória armazenada em cache, por exemplo, um banco de dados externo de certificados, como o fornecido pelo banco de dados do Microsoft Certificate Server.</span><span class="sxs-lookup"><span data-stu-id="71823-108">CryptoAPI certificate store functions also allow a store to maintain certificates outside cached memory in, for example, an external database of certificates such as the one provided by the Microsoft Certificate Server Database.</span></span>

<span data-ttu-id="71823-109">Um dos parâmetros da função [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) , *lpszStoreProvider,* determina o tipo de armazenamento aberto e o provedor usado para abrir esse armazenamento.</span><span class="sxs-lookup"><span data-stu-id="71823-109">One of the parameters of the [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) function, *lpszStoreProvider,* determines the type of store opened and the provider used to open that store.</span></span> <span data-ttu-id="71823-110">Para obter exemplos de como abrir armazenamentos de certificados usando vários provedores, consulte o [código C de exemplo para abrir repositórios de certificados](example-c-code-for-opening-certificate-stores.md).</span><span class="sxs-lookup"><span data-stu-id="71823-110">For examples of opening certificate stores using various providers, see [Example C Code for Opening Certificate Stores](example-c-code-for-opening-certificate-stores.md).</span></span>

<span data-ttu-id="71823-111">[**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) fecha um repositório de certificados.</span><span class="sxs-lookup"><span data-stu-id="71823-111">[**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) closes a certificate store.</span></span> <span data-ttu-id="71823-112">Quando um repositório de certificados é fechado, cada um dos contextos de certificado nesse repositório tem sua [*contagem de referência*](../secgloss/r-gly.md) reduzida em um.</span><span class="sxs-lookup"><span data-stu-id="71823-112">When a certificate store is closed, each of the certificate contexts in that store has its [*reference count*](../secgloss/r-gly.md) reduced by one.</span></span> <span data-ttu-id="71823-113">A memória é liberada para certificados cuja contagem de referência vai para zero.</span><span class="sxs-lookup"><span data-stu-id="71823-113">Memory is freed for certificates whose reference count goes to zero.</span></span>

<span data-ttu-id="71823-114">A configuração \_ \_ \_ do sinalizador de forçar repositório de fechamento de certificado \_ com [**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) fecha o repositório de certificados e libera memória para todos os seus contextos de certificado, independentemente de sua contagem de referência.</span><span class="sxs-lookup"><span data-stu-id="71823-114">Setting CERT\_CLOSE\_STORE\_FORCE\_FLAG with [**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) closes the certificate store and frees memory for all of its certificate contexts regardless of their reference count.</span></span> <span data-ttu-id="71823-115">Em alguns casos, como em programas multissegmentados, isso não pode ser desejável.</span><span class="sxs-lookup"><span data-stu-id="71823-115">In some cases, such as in multithreaded programs, this cannot be desirable.</span></span> <span data-ttu-id="71823-116">Se \_ \_ \_ \_ o sinalizador de verificação do repositório fechar o certificado estiver definido, o repositório será fechado, mas um valor de aviso será retornado pela função se a memória ainda estiver alocada para certificados cujas contagens de referência não foram reduzidas para zero.</span><span class="sxs-lookup"><span data-stu-id="71823-116">If CERT\_CLOSE\_STORE\_CHECK\_FLAG is set, the store is closed, but a warning value is returned by the function if memory is still allocated for certificates whose reference counts have not been reduced to zero.</span></span> <span data-ttu-id="71823-117">Se a contagem de referência de um certificado for maior que zero, uma duplicata desse contexto de certificado não foi liberada.</span><span class="sxs-lookup"><span data-stu-id="71823-117">If a certificate's reference count is greater than zero, a duplicate of that certificate context has not been freed.</span></span> <span data-ttu-id="71823-118">Use [**CertFreeCertificateContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext), [**CertFreeCRLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext)e [**CertFreeCTLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) para liberar quaisquer certificados deixados abertos.</span><span class="sxs-lookup"><span data-stu-id="71823-118">Use [**CertFreeCertificateContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext), [**CertFreeCRLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext), and [**CertFreeCTLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) to free any certificates left open.</span></span>

> [!Note]
> <span data-ttu-id="71823-119">Um [*contexto de certificado*](../secgloss/c-gly.md) é uma estrutura do tipo de [**\_ contexto**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context) de certificado que tem, entre outros membros, um ponteiro para o [*blob de certificado*](../secgloss/c-gly.md) codificado e um ponteiro para uma estrutura de [**\_ informações de certificado**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info) .</span><span class="sxs-lookup"><span data-stu-id="71823-119">A [*certificate context*](../secgloss/c-gly.md) is a structure of type [**CERT\_CONTEXT**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context) that has, among other members, a pointer to the encoded [*certificate BLOB*](../secgloss/c-gly.md) and a pointer to a [**CERT\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info) structure.</span></span> <span data-ttu-id="71823-120">A estrutura de **\_ informações de certificado** contém os dados de certificado mais significativos.</span><span class="sxs-lookup"><span data-stu-id="71823-120">The **CERT\_INFO** structure contains the most significant certificate data.</span></span> <span data-ttu-id="71823-121">Para obter mais informações sobre [*certificados*](../secgloss/c-gly.md), CRL ( [*lista de certificados revogados*](../secgloss/c-gly.md) ) e estruturas de contexto de CTL ( [*lista de certificados confiáveis*](../secgloss/c-gly.md) ), consulte [codificar e decodificar um contexto de certificado](encoding-and-decoding-a-certificate-context.md).</span><span class="sxs-lookup"><span data-stu-id="71823-121">For more information about [*certificate*](../secgloss/c-gly.md), [*certificate revocation list*](../secgloss/c-gly.md) (CRL), and [*certificate trust list*](../secgloss/c-gly.md) (CTL) context structures, see [Encoding and Decoding a Certificate Context](encoding-and-decoding-a-certificate-context.md).</span></span>
> 
> <span data-ttu-id="71823-122">Cada contexto de certificado também contém uma [*contagem de referência*](../secgloss/r-gly.md) indicando o número de cópias do endereço do contexto que foram atribuídas.</span><span class="sxs-lookup"><span data-stu-id="71823-122">Each certificate context also contains a [*reference count*](../secgloss/r-gly.md) indicating the number of copies of the context's address that have been assigned.</span></span> <span data-ttu-id="71823-123">Cada vez que um contexto de certificado é duplicado de qualquer forma, sua contagem de referência é incrementada em um.</span><span class="sxs-lookup"><span data-stu-id="71823-123">Each time a certificate context is duplicated in any way, its reference count is incremented by one.</span></span> <span data-ttu-id="71823-124">Cada vez que um ponteiro para um contexto de certificado é liberado, a contagem de referência no contexto de certificado é decrementada por um.</span><span class="sxs-lookup"><span data-stu-id="71823-124">Each time a pointer to a certificate context is freed, the reference count in the certificate context is decremented by one.</span></span> <span data-ttu-id="71823-125">Quando a contagem de referência em um contexto de certificado chega a zero, a memória que contém o contexto é desalocada.</span><span class="sxs-lookup"><span data-stu-id="71823-125">When the reference count on a certificate context reaches zero, the memory holding the context is de-allocated.</span></span> <span data-ttu-id="71823-126">A memória alocada para um contexto de certificado também é desalocada quando esse contexto está em um repositório e o repositório é fechado usando o sinalizador de força de armazenamento de fechamento de certificado \_ \_ \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="71823-126">Memory allocated for a certificate context is also de-allocated when that context is in a store and the store is closed using CERT\_CLOSE\_STORE\_FORCE\_FLAG.</span></span> <span data-ttu-id="71823-127">Se a memória de um contexto for desalocada e os ponteiros para esse contexto ainda estiverem em uso, esses ponteiros não serão mais válidos.</span><span class="sxs-lookup"><span data-stu-id="71823-127">If the memory for a context is de-allocated and pointers to that context are still in use, those pointers are no longer valid.</span></span>

 

<span data-ttu-id="71823-128">[**CertDuplicateStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) aumenta a [*contagem de referência*](../secgloss/r-gly.md) na loja.</span><span class="sxs-lookup"><span data-stu-id="71823-128">[**CertDuplicateStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) increases the [*reference count*](../secgloss/r-gly.md) on the store.</span></span>

<span data-ttu-id="71823-129">[**CertSaveStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) salva o conteúdo de um repositório em um arquivo de disco ou um local de memória, e</span><span class="sxs-lookup"><span data-stu-id="71823-129">[**CertSaveStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) saves the contents of a store to a disk file or a memory location, and</span></span>

<span data-ttu-id="71823-130">O [**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) gerencia um repositório enquanto ele está aberto.</span><span class="sxs-lookup"><span data-stu-id="71823-130">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) manages a store while it is open.</span></span> <span data-ttu-id="71823-131">Um aplicativo com um armazenamento aberto pode ser notificado quando o estado persistente desse armazenamento tiver sido alterado por algum outro processo.</span><span class="sxs-lookup"><span data-stu-id="71823-131">An application with an open store can be notified when the persisted state of that store has changed by some other process.</span></span> <span data-ttu-id="71823-132">Isso pode acontecer se novos certificados fossem copiados para o repositório do computador local de um computador de controle de domínio.</span><span class="sxs-lookup"><span data-stu-id="71823-132">This could happen if new certificates were copied to the local computer store from a domain control computer.</span></span>

<span data-ttu-id="71823-133">Quando as alterações são descobertas, o armazenamento em cache pode sincronizar novamente seu armazenamento armazenado em cache para corresponder ao estado persistente do repositório.</span><span class="sxs-lookup"><span data-stu-id="71823-133">When changes are discovered, the cached store can re-synchronize its cached store to match the persisted state of the store.</span></span> <span data-ttu-id="71823-134">O [**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) também dá suporte a um processo que copia as alterações de armazenamento em cache para o armazenamento permanente quando essas alterações no armazenamento em cache não são salvas automaticamente.</span><span class="sxs-lookup"><span data-stu-id="71823-134">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) also supports a process that copies cached store changes to permanent storage when these changes in the cached store are not automatically saved.</span></span>

<span data-ttu-id="71823-135">Os contextos de certificado semelhantes ao repositório de certificados podem ter propriedades estendidas.</span><span class="sxs-lookup"><span data-stu-id="71823-135">Certificate store-like certificate contexts can have extended properties.</span></span> <span data-ttu-id="71823-136">[**CertSetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) adiciona propriedades estendidas a um repositório de certificados.</span><span class="sxs-lookup"><span data-stu-id="71823-136">[**CertSetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) adds extended properties to a certificate store.</span></span> <span data-ttu-id="71823-137">[**CertGetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) recupera todas as propriedades definidas em um repositório de certificados.</span><span class="sxs-lookup"><span data-stu-id="71823-137">[**CertGetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) retrieves any properties set on a certificate store.</span></span> <span data-ttu-id="71823-138">Atualmente, a única propriedade de repositório de certificados predefinida é o nome localizado de um repositório.</span><span class="sxs-lookup"><span data-stu-id="71823-138">Currently, the only predefined certificate store property is a store's localized name.</span></span>

 

 
