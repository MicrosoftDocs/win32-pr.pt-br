---
description: Mostra como as funções de backup de serviços de certificados podem ser usadas para restaurar e recuperar um banco de dados de serviços de certificados e seus arquivos associados.
ms.assetid: f4914f45-629d-4f24-8328-d7f27e8a0062
title: Restaurando serviços de certificados a partir do backup
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8f5adf46d802194909397a3b70483b3cf43bb409
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "105779352"
---
# <a name="restoring-certificate-services-from-backup"></a><span data-ttu-id="bcea7-103">Restaurando serviços de certificados a partir do backup</span><span class="sxs-lookup"><span data-stu-id="bcea7-103">Restoring Certificate Services from Backup</span></span>

<span data-ttu-id="bcea7-104">O cenário a seguir mostra como as funções de backup de serviços de certificados podem ser usadas para restaurar e recuperar um banco de dados de serviços de certificados e seus arquivos associados.</span><span class="sxs-lookup"><span data-stu-id="bcea7-104">The following scenario shows how the Certificate Services backup functions can be used to restore and recover a Certificate Services database and its associated files.</span></span> <span data-ttu-id="bcea7-105">O processo de restauração envolve a gravação dos arquivos contidos em um conjunto de backup em disco.</span><span class="sxs-lookup"><span data-stu-id="bcea7-105">The restoration process involves writing the files contained in a backup set to disk.</span></span> <span data-ttu-id="bcea7-106">Você pode restaurar vários conjuntos de backup (um backup completo, mais zero ou mais backups incrementais), mas todas as restaurações devem ser concluídas antes de iniciar o processo de recuperação.</span><span class="sxs-lookup"><span data-stu-id="bcea7-106">You may restore multiple backup sets (one full backup plus zero or more incremental backups), but all restores must be complete prior to beginning the recovery process.</span></span> <span data-ttu-id="bcea7-107">O processo de recuperação envolve a reprodução dos serviços de certificados para garantir a consistência do arquivo de log e do banco de dados, garantindo assim a integridade do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="bcea7-107">The recovery process involves Certificate Services replaying log files to ensure database and log file consistency, thereby ensuring database integrity.</span></span> <span data-ttu-id="bcea7-108">O cenário ilustra as chamadas de função para restaurar os conjuntos de backup e informar os serviços de certificados dos parâmetros de recuperação.</span><span class="sxs-lookup"><span data-stu-id="bcea7-108">The scenario illustrates the function calls to restore the backup sets and inform Certificate Services of the recovery parameters.</span></span>

<span data-ttu-id="bcea7-109">Um backup completo existente do banco de dados de serviços de certificados deve existir antes da implementação desse cenário.</span><span class="sxs-lookup"><span data-stu-id="bcea7-109">An existing full backup of the Certificate Services database must exist before implementing this scenario.</span></span>

1.  <span data-ttu-id="bcea7-110">Carregue a biblioteca de Certadm.dll na memória (chamando [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="bcea7-110">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="bcea7-111">Recupere o endereço de cada uma das funções necessárias no Certadm.dll (por meio de [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span><span class="sxs-lookup"><span data-stu-id="bcea7-111">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="bcea7-112">Use esses endereços ao chamar as funções nas etapas restantes.</span><span class="sxs-lookup"><span data-stu-id="bcea7-112">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="bcea7-113">Chame [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) para determinar se os serviços de certificados estão online.</span><span class="sxs-lookup"><span data-stu-id="bcea7-113">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="bcea7-114">Se os serviços de certificados estiverem em execução, desligue-os antes de continuar.</span><span class="sxs-lookup"><span data-stu-id="bcea7-114">If Certificate Services is running, shut it down before proceeding.</span></span> <span data-ttu-id="bcea7-115">Os serviços de certificados não devem estar online para que as operações de restauração tenham êxito.</span><span class="sxs-lookup"><span data-stu-id="bcea7-115">Certificate Services must not be online for the restore operations to be successful.</span></span>
4.  <span data-ttu-id="bcea7-116">Chame [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) para iniciar uma sessão de restauração.</span><span class="sxs-lookup"><span data-stu-id="bcea7-116">Call [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) to begin a restore session.</span></span> <span data-ttu-id="bcea7-117">O identificador de contexto de backup dos serviços de certificados resultantes será usado por várias das outras funções.</span><span class="sxs-lookup"><span data-stu-id="bcea7-117">The resulting Certificate Services backup context handle will be used by several of the other functions.</span></span>
5.  <span data-ttu-id="bcea7-118">Determine o caminho para o local do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="bcea7-118">Determine the path for the database location.</span></span> <span data-ttu-id="bcea7-119">Durante um cenário de backup, esse valor teria sido disponibilizado de uma chamada para [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); Esse valor deve ter sido armazenado como parte do backup.</span><span class="sxs-lookup"><span data-stu-id="bcea7-119">During a backup scenario, this value would have been available from a call to [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); this value should have been stored as part of the backup.</span></span>
6.  <span data-ttu-id="bcea7-120">Crie um mapa de restauração especificando o nome do banco de dados restaurado.</span><span class="sxs-lookup"><span data-stu-id="bcea7-120">Create a restore map specifying the name of the restored database.</span></span> <span data-ttu-id="bcea7-121">Uma estrutura de mapeamento de restauração do banco de dados dos serviços de certificado (CSEDB \_ RSTMAPW) é usada para especificar um mapa de restauração.</span><span class="sxs-lookup"><span data-stu-id="bcea7-121">A Certificate Services database restore map structure (CSEDB\_RSTMAPW) is used to specify a restore map.</span></span> <span data-ttu-id="bcea7-122">Defina o \_ membro **PWSZDATABASENAME** do CSEDB RSTMAPW e o \_ membro **RSTMAPW** do CSEDB pwszNewDatabaseName para o local do banco de dados determinado na etapa 5.</span><span class="sxs-lookup"><span data-stu-id="bcea7-122">Set the CSEDB\_RSTMAPW's **pwszDatabaseName** member and the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the database location determined in step 5.</span></span> <span data-ttu-id="bcea7-123">Opcionalmente, se o banco de dados restaurado tiver um nome diferente do banco de dados de backup, defina o \_ membro **PWSZNEWDATABASENAME** do CSEDB RSTMAPW como o novo nome do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="bcea7-123">Optionally, if the restored database is to have a different name than the backup database, set the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the new database name.</span></span>
7.  <span data-ttu-id="bcea7-124">Se você quiser garantir que as modificações feitas no banco de dados após a execução do backup não sejam reaplicadas após a conclusão da restauração do banco de dados (como parte da recuperação do banco de dados executada durante a próxima inicialização dos serviços de certificado), exclua os arquivos do banco de dados ativo do servidor de destino e dos diretórios de log.</span><span class="sxs-lookup"><span data-stu-id="bcea7-124">If you want to ensure that modifications made to the database after the backup was performed are not reapplied after database restore is complete (as part of database recovery performed during the next Certificate Services startup), delete files from the target server's active database and log directories.</span></span>
8.  <span data-ttu-id="bcea7-125">Copie os arquivos contidos no backup completo para o banco de dados ativo do servidor de destino e os diretórios de log.</span><span class="sxs-lookup"><span data-stu-id="bcea7-125">Copy the files contained in the full backup to the target server's active database and log directories.</span></span>
9.  <span data-ttu-id="bcea7-126">Chame [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) para registrar uma operação de restauração para o backup completo.</span><span class="sxs-lookup"><span data-stu-id="bcea7-126">Call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) to register a restore operation for the full backup.</span></span> <span data-ttu-id="bcea7-127">**CertSrvRestoreRegister** usa o mapa de restauração especificado na etapa 6.</span><span class="sxs-lookup"><span data-stu-id="bcea7-127">**CertSrvRestoreRegister** uses the restore map specified in step 6.</span></span> <span data-ttu-id="bcea7-128">**CertSrvRestoreRegister** também especifica o local do banco de dados e dos logs de backup.</span><span class="sxs-lookup"><span data-stu-id="bcea7-128">**CertSrvRestoreRegister** also specifies the location of the backup database and logs.</span></span> <span data-ttu-id="bcea7-129">Chamar **CertSrvRestoreRegister** forçará os serviços de certificados a tentarem uma operação de restauração na próxima vez em que for iniciado.</span><span class="sxs-lookup"><span data-stu-id="bcea7-129">Calling **CertSrvRestoreRegister** will force Certificate Services to attempt a restore operation the next time it is started.</span></span> <span data-ttu-id="bcea7-130">Ele também impede que os serviços de certificados processem solicitações de certificado até que a restauração seja concluída.</span><span class="sxs-lookup"><span data-stu-id="bcea7-130">It also prevents Certificate Services from processing Certificate Requests until the restoration is complete.</span></span>
10. <span data-ttu-id="bcea7-131">Chame [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), concluindo assim a atividade de registro iniciada na etapa 8.</span><span class="sxs-lookup"><span data-stu-id="bcea7-131">Call [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), thereby finishing the registration activity that started in step 8.</span></span> <span data-ttu-id="bcea7-132">Observe que o registro de uma operação de restauração é uma instrução para que os serviços de certificados sejam seguidos quando ele é iniciado; a recuperação real ocorrerá somente depois que os serviços de certificados forem iniciados.</span><span class="sxs-lookup"><span data-stu-id="bcea7-132">Note that the registration of a restore operation is an instruction for Certificate Services to follow when it is started; the actual recovery will take place only after Certificate Services is started.</span></span>
11. <span data-ttu-id="bcea7-133">Para cada backup incremental a ser restaurado, copie os arquivos contidos no backup incremental para o diretório de log ativo do servidor de destino e, em seguida, chame [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), seguido por uma chamada para [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span><span class="sxs-lookup"><span data-stu-id="bcea7-133">For each incremental backup to be restored, copy the files contained in the incremental backup to the target server's active log directory, then call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), followed by a call to [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span></span> <span data-ttu-id="bcea7-134">O registro dos backups incrementais para restauração pode ocorrer em qualquer ordem, mas somente o conjunto de arquivos para um backup incremental deve ser copiado para o servidor antes de cada chamada para **CertSrvRestoreRegister**.</span><span class="sxs-lookup"><span data-stu-id="bcea7-134">The registration of the incremental backups for restoration can occur in any order, but only the set of files for one incremental backup should be copied to the server before each call to **CertSrvRestoreRegister**.</span></span>
12. <span data-ttu-id="bcea7-135">Copie os arquivos dinâmicos dos serviços de certificados para o servidor de destino.</span><span class="sxs-lookup"><span data-stu-id="bcea7-135">Copy the Certificate Services dynamic files to the target server.</span></span> <span data-ttu-id="bcea7-136">Os arquivos dinâmicos seriam identificados durante o backup quando [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) foi chamado.</span><span class="sxs-lookup"><span data-stu-id="bcea7-136">The dynamic files would have been identified during the backup when [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) was called.</span></span> <span data-ttu-id="bcea7-137">Pode ser necessário parar o serviço de publicação de World Wide Web para permitir a substituição dos arquivos dinâmicos.</span><span class="sxs-lookup"><span data-stu-id="bcea7-137">It may be necessary to stop the World Wide Web Publishing Service to allow overwriting the dynamic files.</span></span>
13. <span data-ttu-id="bcea7-138">Chame [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) para encerrar a sessão de restauração.</span><span class="sxs-lookup"><span data-stu-id="bcea7-138">Call [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) to end the restore session.</span></span>
14. <span data-ttu-id="bcea7-139">Inicie o aplicativo de serviços de certificados manualmente (ou aguarde a próxima reinicialização para que ele seja iniciado automaticamente).</span><span class="sxs-lookup"><span data-stu-id="bcea7-139">Start the Certificate Services application manually (or wait until the next restart for it to start automatically).</span></span> <span data-ttu-id="bcea7-140">Quando os serviços de certificados são iniciados, ele determinará se uma operação de restauração foi registrada; se uma operação de restauração tiver sido registrada, os serviços de certificados iniciarão a recuperação.</span><span class="sxs-lookup"><span data-stu-id="bcea7-140">When Certificate Services starts, it will determine whether a restore operation has been registered; if a restore operation has been registered, Certificate Services will begin the recovery.</span></span> <span data-ttu-id="bcea7-141">Os serviços de certificados não processarão nenhuma solicitação de certificado até que a operação de recuperação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="bcea7-141">Certificate Services will not process any certificate requests until the recovery operation is completed.</span></span>

> [!Note]  
> <span data-ttu-id="bcea7-142">Quando uma recuperação é concluída, é importante que você faça um novo backup completo do banco de dados dos serviços de certificados.</span><span class="sxs-lookup"><span data-stu-id="bcea7-142">When a recovery is complete, it is important that you make a new full backup of the Certificate Services database.</span></span> <span data-ttu-id="bcea7-143">Isso é necessário para truncar os arquivos de log restaurados e estabelecer um conjunto de backup básico para restaurações futuras.</span><span class="sxs-lookup"><span data-stu-id="bcea7-143">This is necessary to truncate the restored log files and to establish a base backup set for future restores.</span></span> <span data-ttu-id="bcea7-144">Os backups executados após uma restauração não podem ser misturados com backups (completos ou incrementais) feitos antes da restauração; ou seja, depois que um banco de dados de serviços de certificados for restaurado e progredido para um estado subsequente, você não poderá usar os backups de pré-restauração para restaurar o banco de dados para esse estado subsequente.</span><span class="sxs-lookup"><span data-stu-id="bcea7-144">Backups performed after a restore cannot be mixed with backups (full or incremental) taken before the restore; that is, after a certificate services database is restored and has progressed to a subsequent state, you cannot use the pre-restoration backups to restore the database to that subsequent state.</span></span>

 

 

 
