---
description: Como você pode usar as funções de backup dos serviços de certificados para fazer backup de um banco de dados de serviços de certificados e de seus arquivos associados.
ms.assetid: f5c9c9f9-5211-4151-b8e0-3351d462c71b
title: Fazendo backup dos serviços de certificados
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d1be929fcf3bd9b8b9655b48758a97d19af7abc7
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103837283"
---
# <a name="backing-up-certificate-services"></a><span data-ttu-id="a747b-103">Fazendo backup dos serviços de certificados</span><span class="sxs-lookup"><span data-stu-id="a747b-103">Backing Up Certificate Services</span></span>

<span data-ttu-id="a747b-104">Veja a seguir um cenário que mostra como você pode usar as funções de backup dos serviços de certificados para fazer backup de um banco de dados de serviços de certificados e de seus arquivos associados.</span><span class="sxs-lookup"><span data-stu-id="a747b-104">The following is a scenario showing how you can use the Certificate Services backup functions to back up a Certificate Services database and its associated files.</span></span>

1.  <span data-ttu-id="a747b-105">Carregue a biblioteca de Certadm.dll na memória (chamando [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="a747b-105">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="a747b-106">Recupere o endereço de cada uma das funções necessárias no Certadm.dll (por meio de [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span><span class="sxs-lookup"><span data-stu-id="a747b-106">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="a747b-107">Use esses endereços ao chamar as funções nas etapas restantes.</span><span class="sxs-lookup"><span data-stu-id="a747b-107">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="a747b-108">Chame [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) para determinar se os serviços de certificados estão online.</span><span class="sxs-lookup"><span data-stu-id="a747b-108">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="a747b-109">Os serviços de certificados devem estar online para que as operações de backup sejam bem-sucedidas.</span><span class="sxs-lookup"><span data-stu-id="a747b-109">Certificate Services must be online for the backup operations to be successful.</span></span>
4.  <span data-ttu-id="a747b-110">Chame [**CertSrvBackupPrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuppreparew) para iniciar uma sessão de backup.</span><span class="sxs-lookup"><span data-stu-id="a747b-110">Call [**CertSrvBackupPrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuppreparew) to start a backup session.</span></span> <span data-ttu-id="a747b-111">O identificador de contexto de backup dos serviços de certificados resultantes será usado por muitas das outras funções de backup.</span><span class="sxs-lookup"><span data-stu-id="a747b-111">The resulting Certificate Services backup context handle will be used by many of the other backup functions.</span></span>
5.  <span data-ttu-id="a747b-112">Chame [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw) para determinar o mapa de restauração.</span><span class="sxs-lookup"><span data-stu-id="a747b-112">Call [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw) to determine the restore map.</span></span> <span data-ttu-id="a747b-113">O mapa de restauração contém os caminhos a serem usados durante a restauração do backup.</span><span class="sxs-lookup"><span data-stu-id="a747b-113">The restore map contains the paths to be used when restoring the backup.</span></span> <span data-ttu-id="a747b-114">Salve as informações recuperadas por **CertSrvRestoreGetDatabaseLocations** em um local específico do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a747b-114">Save the information retrieved by **CertSrvRestoreGetDatabaseLocations** to an application-specific location.</span></span>
6.  <span data-ttu-id="a747b-115">Chame [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) para determinar os nomes dos arquivos de banco de dados para backup.</span><span class="sxs-lookup"><span data-stu-id="a747b-115">Call [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) to determine the names of the database files to backup.</span></span> <span data-ttu-id="a747b-116">Para cada um desses arquivos, execute as etapas 7 a 9.</span><span class="sxs-lookup"><span data-stu-id="a747b-116">For each of these files, execute steps 7 through 9.</span></span>
7.  <span data-ttu-id="a747b-117">Chame [**CertSrvBackupOpenFile**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupopenfilew) para abrir o arquivo para backup.</span><span class="sxs-lookup"><span data-stu-id="a747b-117">Call [**CertSrvBackupOpenFile**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupopenfilew) to open the file for backup.</span></span>
8.  <span data-ttu-id="a747b-118">Chame [**CertSrvBackupRead**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupread) para ler uma parte de bytes do arquivo e, em seguida, chame uma rotina específica do aplicativo para armazenar os bytes em um meio de backup.</span><span class="sxs-lookup"><span data-stu-id="a747b-118">Call [**CertSrvBackupRead**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupread) to read a portion of bytes from the file, then call an application-specific routine to store the bytes on a backup medium.</span></span> <span data-ttu-id="a747b-119">Repita essa etapa até que todos os bytes no arquivo sejam submetidos a backup.</span><span class="sxs-lookup"><span data-stu-id="a747b-119">Repeat this step until all of the bytes in the file are backed up.</span></span>
9.  <span data-ttu-id="a747b-120">Chame [**CertSrvBackupClose**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupclose) para fechar o arquivo.</span><span class="sxs-lookup"><span data-stu-id="a747b-120">Call [**CertSrvBackupClose**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupclose) to close the file.</span></span>
10. <span data-ttu-id="a747b-121">Chame [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) para determinar os nomes dos arquivos de log para backup.</span><span class="sxs-lookup"><span data-stu-id="a747b-121">Call [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) to determine the names of the log files to backup.</span></span> <span data-ttu-id="a747b-122">Para cada um desses arquivos, execute as etapas 7 a 9.</span><span class="sxs-lookup"><span data-stu-id="a747b-122">For each of these files, execute steps 7 through 9.</span></span>
11. <span data-ttu-id="a747b-123">Chame [**CertSrvBackupTruncateLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuptruncatelogs) para truncar os arquivos de log que foram copiados em backup nas etapas 6 e 10.</span><span class="sxs-lookup"><span data-stu-id="a747b-123">Call [**CertSrvBackupTruncateLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuptruncatelogs) to truncate the log files which were backed up in steps 6 and 10.</span></span> <span data-ttu-id="a747b-124">Esta etapa é opcional; no entanto, chame **CertSrvBackupTruncateLogs** somente se todos os arquivos retornados por [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) e [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) tiverem sido submetidos a backup (caso contrário, a operação de restauração falhará).</span><span class="sxs-lookup"><span data-stu-id="a747b-124">This step is optional; however, call **CertSrvBackupTruncateLogs** only if all files returned by [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) and [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) have been backed up (otherwise, the restore operation will fail).</span></span> <span data-ttu-id="a747b-125">Consulte a página de referência do **CertSrvBackupTruncateLogs** para obter detalhes.</span><span class="sxs-lookup"><span data-stu-id="a747b-125">Consult the **CertSrvBackupTruncateLogs** reference page for details.</span></span>
12. <span data-ttu-id="a747b-126">Chame [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) para determinar os nomes dos arquivos que não são de banco de dados para backup.</span><span class="sxs-lookup"><span data-stu-id="a747b-126">Call [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) to determine the names of the non-database files to backup.</span></span> <span data-ttu-id="a747b-127">Esses arquivos são identificados apenas pela função e devem ser submetidos a backup por outros meios.</span><span class="sxs-lookup"><span data-stu-id="a747b-127">These files are only identified by the function, and must be backed up by some other means.</span></span>
13. <span data-ttu-id="a747b-128">Faça backup dos arquivos dinâmicos identificados na etapa 12, usando rotinas separadas de Certadm.dll.</span><span class="sxs-lookup"><span data-stu-id="a747b-128">Backup the dynamic files identified in step 12, using routines separate from Certadm.dll.</span></span>
14. <span data-ttu-id="a747b-129">Chame [**CertSrvBackupEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupend) para encerrar a sessão de backup.</span><span class="sxs-lookup"><span data-stu-id="a747b-129">Call [**CertSrvBackupEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupend) to end the backup session.</span></span>
15. <span data-ttu-id="a747b-130">Chame [**CertSrvBackupFree**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupfree) conforme necessário para liberar buffers alocados por determinadas funções de backup dos serviços de certificados.</span><span class="sxs-lookup"><span data-stu-id="a747b-130">Call [**CertSrvBackupFree**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupfree) as needed to release buffers allocated by certain Certificate Services backup functions.</span></span> <span data-ttu-id="a747b-131">Chamadas para [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw), [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw)e [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) alocarão buffers que podem ser liberados por uma chamada para **CertSrvBackupFree**.</span><span class="sxs-lookup"><span data-stu-id="a747b-131">Calls to [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw), [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw), and [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) will allocate buffers that can be freed by a call to **CertSrvBackupFree**.</span></span>
16. <span data-ttu-id="a747b-132">Libere os recursos de Certadm.dll chamando [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary).</span><span class="sxs-lookup"><span data-stu-id="a747b-132">Release the Certadm.dll resources by calling [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary).</span></span>

<span data-ttu-id="a747b-133">Para obter informações sobre os privilégios necessários para fazer backup do banco de dados dos serviços de certificados e dos arquivos associados, consulte [definindo os privilégios de backup e restauração](setting-the-backup-and-restore-privileges.md).</span><span class="sxs-lookup"><span data-stu-id="a747b-133">For information about the privileges required to back up the Certificate Services database and associated files, see [Setting the Backup and Restore Privileges](setting-the-backup-and-restore-privileges.md).</span></span>

 

 
