---
description: Suporte a DXVA 2,0 no Media Foundation
ms.assetid: d7330370-adb3-4c6a-962a-7b46c344500c
title: Suporte a DXVA 2,0 no Media Foundation
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ce144c24a1aeeda6281ddb423757f3e339903440
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/03/2021
ms.locfileid: "105756112"
---
# <a name="supporting-dxva-20-in-media-foundation"></a><span data-ttu-id="e0951-103">Suporte a DXVA 2,0 no Media Foundation</span><span class="sxs-lookup"><span data-stu-id="e0951-103">Supporting DXVA 2.0 in Media Foundation</span></span>

<span data-ttu-id="e0951-104">Este tópico descreve como dar suporte a DXVA (DirectX Video Acceleration) 2,0 em uma Media Foundation transformação (MFT) usando o Microsoft Direct3D 9 especificamente, ele descreve a comunicação entre o decodificador e o processador de vídeo, que é mediado pelo carregador de topologia.</span><span class="sxs-lookup"><span data-stu-id="e0951-104">This topic describes how to support DirectX Video Acceleration (DXVA) 2.0 in a Media Foundation transform (MFT) using Microsoft Direct3D 9 Specifically, it describes the communication between the decoder and the video renderer, which is mediated by the topology loader.</span></span> <span data-ttu-id="e0951-105">Este tópico não descreve como implementar a decodificação de DXVA.</span><span class="sxs-lookup"><span data-stu-id="e0951-105">This topic does not describe how to implement DXVA decoding.</span></span>

<span data-ttu-id="e0951-106">No restante deste tópico, o termo *decodificador* refere-se ao MFT do decodificador, que recebe vídeo compactado e gera vídeo descompactado.</span><span class="sxs-lookup"><span data-stu-id="e0951-106">In the remainder of this topic, the term *decoder* refers to the decoder MFT, which receives compressed video and outputs uncompressed video.</span></span> <span data-ttu-id="e0951-107">O termo *dispositivo decodificador* refere-se a um acelerador de vídeo de hardware implementado pelo driver de gráficos.</span><span class="sxs-lookup"><span data-stu-id="e0951-107">The term *decoder device* refers to a hardware video accelerator implemented by the graphics driver.</span></span>

> [!TIP]
> <span data-ttu-id="e0951-108">Para obter informações sobre a decodificação de vídeo do Microsoft Direct3D 11, consulte [dando suporte à decodificação de vídeo do Direct3D 11 em Media Foundation](supporting-direct3d-11-video-decoding-in-media-foundation.md).</span><span class="sxs-lookup"><span data-stu-id="e0951-108">For info on Microsoft Direct3D 11 video decoding see, [Supporting Direct3D 11 Video Decoding in Media Foundation](supporting-direct3d-11-video-decoding-in-media-foundation.md).</span></span>

 

> [!Note]  
> <span data-ttu-id="e0951-109">Os aplicativos da Windows Store devem usar o Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="e0951-109">Windows Store apps must use Direct3D 11.</span></span>

 

<span data-ttu-id="e0951-110">Aqui estão as etapas básicas que um decodificador deve executar para dar suporte a DXVA 2,0 no Media Foundation:</span><span class="sxs-lookup"><span data-stu-id="e0951-110">Here are the basic steps that a decoder must perform to support DXVA 2.0 in Media Foundation:</span></span>

1.  <span data-ttu-id="e0951-111">Abra um identificador para o dispositivo Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="e0951-111">Open a handle to the Direct3D 9 device.</span></span>
2.  <span data-ttu-id="e0951-112">Localize uma configuração de decodificador DXVA.</span><span class="sxs-lookup"><span data-stu-id="e0951-112">Find a DXVA decoder configuration.</span></span>
3.  <span data-ttu-id="e0951-113">Aloque buffers descompactados.</span><span class="sxs-lookup"><span data-stu-id="e0951-113">Allocate uncompressed Buffers.</span></span>
4.  <span data-ttu-id="e0951-114">Decodificar quadros.</span><span class="sxs-lookup"><span data-stu-id="e0951-114">Decode frames.</span></span>

<span data-ttu-id="e0951-115">Essas etapas são descritas mais detalhadamente no restante deste tópico.</span><span class="sxs-lookup"><span data-stu-id="e0951-115">These steps are described in more detail in the remainder of this topic.</span></span>

## <a name="opening-a-direct3d-device-handle"></a><span data-ttu-id="e0951-116">Abrindo um identificador de dispositivo Direct3D</span><span class="sxs-lookup"><span data-stu-id="e0951-116">Opening a Direct3D Device Handle</span></span>

<span data-ttu-id="e0951-117">O MFT usa o Microsoft Direct3D Device Manager para obter um identificador para o dispositivo Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="e0951-117">The MFT uses the Microsoft Direct3D device manager to get a handle to the Direct3D 9 device.</span></span> <span data-ttu-id="e0951-118">Para abrir o identificador do dispositivo, execute as seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="e0951-118">To open the device handle, perform the following steps:</span></span>

1.  <span data-ttu-id="e0951-119">Expor o atributo de [ \_ \_ \_ reconhecimento de D3D SA do MF](mf-sa-d3d-aware-attribute.md) com o valor **true**.</span><span class="sxs-lookup"><span data-stu-id="e0951-119">Expose the [MF\_SA\_D3D\_AWARE](mf-sa-d3d-aware-attribute.md) attribute with the value **TRUE**.</span></span> <span data-ttu-id="e0951-120">O carregador de topologia consulta esse atributo chamando [**IMFTransform:: GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span><span class="sxs-lookup"><span data-stu-id="e0951-120">The topology loader queries this attribute by calling [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span></span> <span data-ttu-id="e0951-121">Definir o atributo como **true** notifica o carregador de topologia que o MFT dá suporte a DXVA.</span><span class="sxs-lookup"><span data-stu-id="e0951-121">Setting the attribute to **TRUE** notifies the topology loader that the MFT supports DXVA.</span></span>
2.  <span data-ttu-id="e0951-122">Quando a negociação de formato começa, o carregador de topologia chama [**IMFTransform::P rocessmessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) com a mensagem [**MFT do conjunto de mensagens do \_ \_ \_ \_ Gerenciador de D3D**](mft-message-set-d3d-manager.md) .</span><span class="sxs-lookup"><span data-stu-id="e0951-122">When format negotiation begins, the topology loader calls [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message.</span></span> <span data-ttu-id="e0951-123">O parâmetro *ulParam* é um ponteiro **IUnknown** para o Gerenciador de dispositivos Direct3D do processador de vídeo.</span><span class="sxs-lookup"><span data-stu-id="e0951-123">The *ulParam* parameter is an **IUnknown** pointer to the video renderer's Direct3D device manager.</span></span> <span data-ttu-id="e0951-124">Consulte este ponteiro para a interface [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="e0951-124">Query this pointer for the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span>
3.  <span data-ttu-id="e0951-125">Chame [**IDirect3DDeviceManager9:: OpenDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-opendevicehandle) para obter um identificador para o dispositivo Direct3D do renderizador.</span><span class="sxs-lookup"><span data-stu-id="e0951-125">Call [**IDirect3DDeviceManager9::OpenDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-opendevicehandle) to get a handle to the renderer's Direct3D device.</span></span>
4.  <span data-ttu-id="e0951-126">Chame [**IDirect3DDeviceManager9:: GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) e passe o identificador do dispositivo.</span><span class="sxs-lookup"><span data-stu-id="e0951-126">Call [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) and pass in the device handle.</span></span> <span data-ttu-id="e0951-127">Esse método retorna um ponteiro para a interface [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) .</span><span class="sxs-lookup"><span data-stu-id="e0951-127">This method returns a pointer to the [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) interface.</span></span>
5.  <span data-ttu-id="e0951-128">Armazene os ponteiros e o identificador do dispositivo em cache.</span><span class="sxs-lookup"><span data-stu-id="e0951-128">Cache the pointers and the device handle.</span></span>

## <a name="finding-a-decoder-configuration"></a><span data-ttu-id="e0951-129">Encontrando uma configuração de decodificador</span><span class="sxs-lookup"><span data-stu-id="e0951-129">Finding a Decoder Configuration</span></span>

<span data-ttu-id="e0951-130">O MFT deve encontrar uma configuração compatível para o dispositivo de decodificador DXVA.</span><span class="sxs-lookup"><span data-stu-id="e0951-130">The MFT must find a compatible configuration for the DXVA decoder device.</span></span> <span data-ttu-id="e0951-131">Execute as seguintes etapas dentro do método [**IMFTransform:: SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) , depois de validar o tipo de entrada:</span><span class="sxs-lookup"><span data-stu-id="e0951-131">Perform the following steps inside the [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) method, after validating the input type:</span></span>

1.  <span data-ttu-id="e0951-132">Chame [**IDirectXVideoDecoderService:: GetDecoderDeviceGuids**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderdeviceguids).</span><span class="sxs-lookup"><span data-stu-id="e0951-132">Call [**IDirectXVideoDecoderService::GetDecoderDeviceGuids**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderdeviceguids).</span></span> <span data-ttu-id="e0951-133">Esse método retorna uma matriz de GUIDs de dispositivo do decodificador.</span><span class="sxs-lookup"><span data-stu-id="e0951-133">This method returns an array of decoder device GUIDs.</span></span>
2.  <span data-ttu-id="e0951-134">Faça um loop através da matriz de GUIDs do decodificador para localizar os que o decodificador suporta.</span><span class="sxs-lookup"><span data-stu-id="e0951-134">Loop through the array of decoder GUIDs to find the ones that the decoder supports.</span></span> <span data-ttu-id="e0951-135">Por exemplo, para um decodificador MPEG-2, você procurará **DXVA2 \_ ModeMPEG2 \_ MOCOMP**, **DXVA2 \_ ModeMPEG2 \_ IDCT** ou **DXVA2 \_ ModeMPEG2 \_** VLD.</span><span class="sxs-lookup"><span data-stu-id="e0951-135">For example, for an MPEG-2 decoder, you would look for **DXVA2\_ModeMPEG2\_MOCOMP**, **DXVA2\_ModeMPEG2\_IDCT**, or **DXVA2\_ModeMPEG2\_VLD**.</span></span>

3.  <span data-ttu-id="e0951-136">Quando você encontrar um GUID de dispositivo de decodificador candidato, passe o GUID para o método [**IDirectXVideoDecoderService:: GetDecoderRenderTargets**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderrendertargets) .</span><span class="sxs-lookup"><span data-stu-id="e0951-136">When you find a candidate decoder device GUID, pass the GUID to the [**IDirectXVideoDecoderService::GetDecoderRenderTargets**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderrendertargets) method.</span></span> <span data-ttu-id="e0951-137">Esse método retorna uma matriz de formatos de destino de renderização, especificados como valores de **D3DFORMAT** .</span><span class="sxs-lookup"><span data-stu-id="e0951-137">This method returns an array of render target formats, specified as **D3DFORMAT** values.</span></span>
4.  <span data-ttu-id="e0951-138">Faça um loop pelos formatos de destino de renderização e procure por um formato com suporte pelo decodificador.</span><span class="sxs-lookup"><span data-stu-id="e0951-138">Loop through the render target formats and look for a format supported by the decoder.</span></span>
5.  <span data-ttu-id="e0951-139">Chame [**IDirectXVideoDecoderService:: GetDecoderConfigurations**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderconfigurations).</span><span class="sxs-lookup"><span data-stu-id="e0951-139">Call [**IDirectXVideoDecoderService::GetDecoderConfigurations**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderconfigurations).</span></span> <span data-ttu-id="e0951-140">Passe o mesmo GUID do dispositivo decodificador, junto com uma estrutura [**DXVA2 \_ VideoDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) que descreve o formato de saída proposto.</span><span class="sxs-lookup"><span data-stu-id="e0951-140">Pass in the same decoder device GUID, along with a [**DXVA2\_VideoDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) structure that describes the proposed output format.</span></span> <span data-ttu-id="e0951-141">O método retorna uma matriz de estruturas [**DXVA2 \_ ConfigPictureDecode**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_configpicturedecode) .</span><span class="sxs-lookup"><span data-stu-id="e0951-141">The method returns an array of [**DXVA2\_ConfigPictureDecode**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_configpicturedecode) structures.</span></span> <span data-ttu-id="e0951-142">Cada estrutura descreve uma configuração possível para o dispositivo decodificador.</span><span class="sxs-lookup"><span data-stu-id="e0951-142">Each structure describes one possible configuration for the decoder device.</span></span> <span data-ttu-id="e0951-143">Procure uma configuração que o decodificador dê suporte.</span><span class="sxs-lookup"><span data-stu-id="e0951-143">Look for a configuration that the decoder supports.</span></span>
6.  <span data-ttu-id="e0951-144">Armazene o formato de destino de renderização e a configuração.</span><span class="sxs-lookup"><span data-stu-id="e0951-144">Store the render target format and configuration.</span></span>

<span data-ttu-id="e0951-145">No método [**IMFTransform:: GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) , retorne um formato de vídeo descompactado, com base no formato de destino de renderização proposto.</span><span class="sxs-lookup"><span data-stu-id="e0951-145">In the [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) method, return an uncompressed video format, based on the proposed render target format.</span></span>

<span data-ttu-id="e0951-146">No método [**IMFTransform:: SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) , verifique o tipo de mídia em relação ao formato de destino de renderização.</span><span class="sxs-lookup"><span data-stu-id="e0951-146">In the [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) method, check the media type against the render target format.</span></span>

### <a name="fallback-to-software-decoding"></a><span data-ttu-id="e0951-147">Fallback para decodificação de software</span><span class="sxs-lookup"><span data-stu-id="e0951-147">Fallback to Software Decoding</span></span>

<span data-ttu-id="e0951-148">Se o MFT não puder encontrar uma configuração de DXVA (por exemplo, se o driver de gráficos não tiver os recursos corretos), ele deverá retornar o código de erro **MF \_ e o \_ \_ \_ tipo de D3D sem suporte** dos métodos [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) e [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) .</span><span class="sxs-lookup"><span data-stu-id="e0951-148">If the MFT cannot find a DXVA configuration (for example, if the graphics driver does not have the right capabilities), it should return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE** from the [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) and [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) methods.</span></span> <span data-ttu-id="e0951-149">O carregador de topologia responderá enviando a mensagem [**MFT do conjunto de mensagens do \_ \_ \_ \_ Gerenciador de D3D**](mft-message-set-d3d-manager.md) com o valor **NULL** para o parâmetro *ulParam* .</span><span class="sxs-lookup"><span data-stu-id="e0951-149">The topology loader will respond by sending the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message with the value **NULL** for the *ulParam* parameter.</span></span> <span data-ttu-id="e0951-150">O MFT deve liberar seu ponteiro para a interface [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="e0951-150">The MFT should release its pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="e0951-151">O carregador de topologia renegociará o tipo de mídia e o MFT poderá usar a decodificação de software.</span><span class="sxs-lookup"><span data-stu-id="e0951-151">The topology loader will then renegotiate the media type, and the MFT can use software decoding.</span></span>

## <a name="allocating-uncompressed-buffers"></a><span data-ttu-id="e0951-152">Alocando buffers descompactados</span><span class="sxs-lookup"><span data-stu-id="e0951-152">Allocating Uncompressed Buffers</span></span>

<span data-ttu-id="e0951-153">No DXVA 2,0, o decodificador é responsável por alocar superfícies do Direct3D para usar como buffers de vídeo não compactados.</span><span class="sxs-lookup"><span data-stu-id="e0951-153">In DXVA 2.0, the decoder is responsible for allocating Direct3D surfaces to use as uncompressed video buffers.</span></span> <span data-ttu-id="e0951-154">O decodificador deve alocar 3 superfícies para o EVR usar para desentrelaçar.</span><span class="sxs-lookup"><span data-stu-id="e0951-154">The decoder should allocate 3 surfaces for the EVR to use for deinterlacing.</span></span> <span data-ttu-id="e0951-155">Esse número é fixo, porque Media Foundation não fornece uma maneira para o EVR especificar quantas superfícies o driver gráfico requer para desentrelaçar.</span><span class="sxs-lookup"><span data-stu-id="e0951-155">This number is fixed, because Media Foundation does not provide a way for the EVR to specify how many surfaces the graphics driver requires for deinterlacing.</span></span> <span data-ttu-id="e0951-156">Três superfícies devem ser suficientes para qualquer driver.</span><span class="sxs-lookup"><span data-stu-id="e0951-156">Three surfaces should be sufficient for any driver.</span></span>

<span data-ttu-id="e0951-157">No método [**IMFTransform:: GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) , defina o **fluxo de saída do MFT fornece um sinalizador de \_ \_ \_ \_ exemplos** na estrutura de informações do [**fluxo de saída do MFT \_ \_ \_**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_stream_info) .</span><span class="sxs-lookup"><span data-stu-id="e0951-157">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag in the [**MFT\_OUTPUT\_STREAM\_INFO**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_stream_info) structure.</span></span> <span data-ttu-id="e0951-158">Esse sinalizador notifica a sessão de mídia de que a MFT aloca seus próprios exemplos de saída.</span><span class="sxs-lookup"><span data-stu-id="e0951-158">This flag notifies the Media Session that the MFT allocates its own output samples.</span></span>

<span data-ttu-id="e0951-159">Para criar as superfícies, chame [**IDirectXVideoAccelerationService:: CreateSurface**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoaccelerationservice-createsurface).</span><span class="sxs-lookup"><span data-stu-id="e0951-159">To create the surfaces, call [**IDirectXVideoAccelerationService::CreateSurface**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoaccelerationservice-createsurface).</span></span> <span data-ttu-id="e0951-160">(A interface [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) herda esse método de [**IDirectXVideoAccelerationService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoaccelerationservice).) Você pode fazer isso em [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype), depois de localizar o formato de destino de renderização.</span><span class="sxs-lookup"><span data-stu-id="e0951-160">(The [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) interface inherits this method from [**IDirectXVideoAccelerationService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoaccelerationservice).) You can do this in [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype), after finding the render target format.</span></span>

<span data-ttu-id="e0951-161">Para cada superfície, chame [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) para criar um exemplo de mídia para manter a superfície.</span><span class="sxs-lookup"><span data-stu-id="e0951-161">For each surface, call [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) to create a media sample to hold the surface.</span></span> <span data-ttu-id="e0951-162">O método retorna um ponteiro para a interface [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) .</span><span class="sxs-lookup"><span data-stu-id="e0951-162">The method returns a pointer to the [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) interface.</span></span>

## <a name="decoding"></a><span data-ttu-id="e0951-163">Decodificação</span><span class="sxs-lookup"><span data-stu-id="e0951-163">Decoding</span></span>

<span data-ttu-id="e0951-164">Para criar o dispositivo decodificador, chame [**IDirectXVideoDecoderService:: CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="e0951-164">To create the decoder device, call [**IDirectXVideoDecoderService::CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span></span> <span data-ttu-id="e0951-165">O método retorna um ponteiro para a interface [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) do dispositivo decodificador.</span><span class="sxs-lookup"><span data-stu-id="e0951-165">The method returns a pointer to the [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) interface of the decoder device.</span></span>

<span data-ttu-id="e0951-166">A decodificação deve ocorrer dentro do método [**IMFTransform::P rocessoutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) .</span><span class="sxs-lookup"><span data-stu-id="e0951-166">Decoding should occur inside the [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) method.</span></span> <span data-ttu-id="e0951-167">Em cada quadro, chame [**IDirect3DDeviceManager9:: TestDevice**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-testdevice) para testar o identificador do dispositivo.</span><span class="sxs-lookup"><span data-stu-id="e0951-167">On each frame, call [**IDirect3DDeviceManager9::TestDevice**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-testdevice) to test the device handle.</span></span> <span data-ttu-id="e0951-168">Se o dispositivo tiver sido alterado, o método **retornará \_ DXVA2 \_ E \_ novo \_ dispositivo de vídeo**.</span><span class="sxs-lookup"><span data-stu-id="e0951-168">If the device has changed, the method returns **DXVA2\_E\_NEW\_VIDEO\_DEVICE**.</span></span> <span data-ttu-id="e0951-169">Se isso ocorrer, faça o seguinte:</span><span class="sxs-lookup"><span data-stu-id="e0951-169">If this occurs, do the following:</span></span>

1.  <span data-ttu-id="e0951-170">Feche o identificador do dispositivo chamando [**IDirect3DDeviceManager9:: CloseDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-closedevicehandle).</span><span class="sxs-lookup"><span data-stu-id="e0951-170">Close the device handle by calling [**IDirect3DDeviceManager9::CloseDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-closedevicehandle).</span></span>
2.  <span data-ttu-id="e0951-171">Libere os ponteiros [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) e [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) .</span><span class="sxs-lookup"><span data-stu-id="e0951-171">Release the [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) and [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) pointers.</span></span>
3.  <span data-ttu-id="e0951-172">Abra um novo identificador de dispositivo.</span><span class="sxs-lookup"><span data-stu-id="e0951-172">Open a new device handle.</span></span>
4.  <span data-ttu-id="e0951-173">Negocie uma nova configuração de decodificador, conforme descrito em "encontrando uma configuração de decodificador" anteriormente nesta página.</span><span class="sxs-lookup"><span data-stu-id="e0951-173">Negotiate a new decoder configuration, as described in "Finding a Decoder Configuration" earlier on this page.</span></span>
5.  <span data-ttu-id="e0951-174">Crie um novo dispositivo de decodificador.</span><span class="sxs-lookup"><span data-stu-id="e0951-174">Create a new decoder device.</span></span>

<span data-ttu-id="e0951-175">Supondo que o identificador do dispositivo seja válido, o processo de decodificação funciona da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="e0951-175">Assuming that the device handle is valid, the decoding process works as follows:</span></span>

1.  <span data-ttu-id="e0951-176">Obtenha uma superfície disponível que não esteja em uso no momento.</span><span class="sxs-lookup"><span data-stu-id="e0951-176">Get an available surface that is not currently in use.</span></span> <span data-ttu-id="e0951-177">(Inicialmente, todas as superfícies estão disponíveis.)</span><span class="sxs-lookup"><span data-stu-id="e0951-177">(Initially all of the surfaces are available.)</span></span>
2.  <span data-ttu-id="e0951-178">Consulte o exemplo de mídia para a interface [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) .</span><span class="sxs-lookup"><span data-stu-id="e0951-178">Query the media sample for the [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) interface.</span></span>
3.  <span data-ttu-id="e0951-179">Chame [**IMFTrackedSample:: Setalocador**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) e forneça um ponteiro para a interface [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) , implementado pelo decodificador.</span><span class="sxs-lookup"><span data-stu-id="e0951-179">Call [**IMFTrackedSample::SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) and provide a pointer to the [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) interface, implemented by the decoder.</span></span> <span data-ttu-id="e0951-180">Quando o processador de vídeo libera o exemplo, o retorno de chamada do decodificador será invocado.</span><span class="sxs-lookup"><span data-stu-id="e0951-180">When the video renderer releases the sample, the decoder's callback will be invoked.</span></span>
4.  <span data-ttu-id="e0951-181">Chame [**IDirectXVideoDecoder:: BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe).</span><span class="sxs-lookup"><span data-stu-id="e0951-181">Call [**IDirectXVideoDecoder::BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe).</span></span>
5.  <span data-ttu-id="e0951-182">Faça o seguinte uma ou mais vezes:</span><span class="sxs-lookup"><span data-stu-id="e0951-182">Do the following one or more times:</span></span>
    1.  <span data-ttu-id="e0951-183">Chame [**IDirectXVideoDecoder:: GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) para obter um buffer de decodificador de DXVA.</span><span class="sxs-lookup"><span data-stu-id="e0951-183">Call [**IDirectXVideoDecoder::GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) to get a DXVA decoder buffer.</span></span>
    2.  <span data-ttu-id="e0951-184">Preencha o buffer.</span><span class="sxs-lookup"><span data-stu-id="e0951-184">Fill the buffer.</span></span>
    3.  <span data-ttu-id="e0951-185">Chame [**IDirectXVideoDecoder:: ReleaseBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-releasebuffer).</span><span class="sxs-lookup"><span data-stu-id="e0951-185">Call [**IDirectXVideoDecoder::ReleaseBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-releasebuffer).</span></span>
    4.  <span data-ttu-id="e0951-186">Chame [**IDirectXVideoDecoder:: execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) para executar as operações de decodificação no quadro.</span><span class="sxs-lookup"><span data-stu-id="e0951-186">Call [**IDirectXVideoDecoder::Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) to perform the decoding operations on the frame.</span></span>

<span data-ttu-id="e0951-187">O DXVA 2,0 usa as mesmas estruturas de dados que a DXVA 1,0 para operações de decodificação.</span><span class="sxs-lookup"><span data-stu-id="e0951-187">DXVA 2.0 uses the same data structures as DXVA 1.0 for decoding operations.</span></span> <span data-ttu-id="e0951-188">Para o conjunto original de perfis de DXVA (para H. 261, H. 263 e MPEG-2), essas estruturas de dados são descritas na [especificação DXVA 1,0](/windows-hardware/drivers/display/directx-video-acceleration).</span><span class="sxs-lookup"><span data-stu-id="e0951-188">For the original set of DXVA profiles (for H.261, H.263, and MPEG-2), these data structures are described in the [DXVA 1.0 specification](/windows-hardware/drivers/display/directx-video-acceleration).</span></span>

<span data-ttu-id="e0951-189">Em cada par de [](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe) / chamadas de [**execução**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) BeginFrame, você pode chamar [**GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) várias vezes, mas apenas uma vez para cada tipo de buffer de DXVA.</span><span class="sxs-lookup"><span data-stu-id="e0951-189">Within each pair of [**BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe)/[**Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) calls, you may call [**GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) multiple times, but only once for each type of DXVA buffer.</span></span> <span data-ttu-id="e0951-190">Se você chamá-lo duas vezes com o mesmo tipo de buffer, os dados serão substituídos.</span><span class="sxs-lookup"><span data-stu-id="e0951-190">If you call it twice with the same buffer type, you will overwrite the data.</span></span>

<span data-ttu-id="e0951-191">Use o retorno de chamada do método [**Setalocador**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) (etapa 3) para controlar quais exemplos estão disponíveis no momento e quais estão em uso.</span><span class="sxs-lookup"><span data-stu-id="e0951-191">Use the callback from the [**SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) method (step 3) to keep track of which samples are currently available and which are in use.</span></span>

## <a name="related-topics"></a><span data-ttu-id="e0951-192">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="e0951-192">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="e0951-193">Aceleração de vídeo do DirectX 2,0</span><span class="sxs-lookup"><span data-stu-id="e0951-193">DirectX Video Acceleration 2.0</span></span>](directx-video-acceleration-2-0.md)
</dt> <dt>

[<span data-ttu-id="e0951-194">Transformações de Media Foundation</span><span class="sxs-lookup"><span data-stu-id="e0951-194">Media Foundation Transforms</span></span>](media-foundation-transforms.md)
</dt> </dl>

 

 
