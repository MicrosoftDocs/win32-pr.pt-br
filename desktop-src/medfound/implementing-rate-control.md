---
description: Este tópico descreve como os objetos de pipeline personalizados podem dar suporte a taxas de reprodução de variáveis, incluindo reprodução reversa. Para obter informações sobre como usar o controle de taxa de um aplicativo, consulte controle de taxa.
ms.assetid: 077678db-ca5a-423b-9430-93497113d639
title: Implementando o controle de taxa
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f5fd78cbbb95316a0d4ed12a50c9d3aa8954fe8a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104011406"
---
# <a name="implementing-rate-control"></a><span data-ttu-id="3282f-104">Implementando o controle de taxa</span><span class="sxs-lookup"><span data-stu-id="3282f-104">Implementing Rate Control</span></span>

<span data-ttu-id="3282f-105">Este tópico descreve como os objetos de pipeline personalizados podem dar suporte a taxas de reprodução de variáveis, incluindo reprodução reversa.</span><span class="sxs-lookup"><span data-stu-id="3282f-105">This topic describes how custom pipeline objects can support variable playback rates, including reverse playback.</span></span> <span data-ttu-id="3282f-106">Para obter informações sobre como usar o controle de taxa de um aplicativo, consulte [controle de taxa](rate-control.md).</span><span class="sxs-lookup"><span data-stu-id="3282f-106">For information about using rate control from an application, see [Rate Control](rate-control.md).</span></span>

<span data-ttu-id="3282f-107">Este tópico contém as seguintes seções:</span><span class="sxs-lookup"><span data-stu-id="3282f-107">This topic contains the following sections:</span></span>

-   [<span data-ttu-id="3282f-108">Fontes de mídia</span><span class="sxs-lookup"><span data-stu-id="3282f-108">Media Sources</span></span>](#media-sources)
-   [<span data-ttu-id="3282f-109">Transformações de Media Foundation</span><span class="sxs-lookup"><span data-stu-id="3282f-109">Media Foundation Transforms</span></span>](#media-foundation-transforms)
    -   [<span data-ttu-id="3282f-110">Reprodução reversa</span><span class="sxs-lookup"><span data-stu-id="3282f-110">Reverse Playback</span></span>](#reverse-playback)
-   [<span data-ttu-id="3282f-111">Coletores de mídia</span><span class="sxs-lookup"><span data-stu-id="3282f-111">Media Sinks</span></span>](#media-sinks)
-   [<span data-ttu-id="3282f-112">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="3282f-112">Related topics</span></span>](#related-topics)

<span data-ttu-id="3282f-113">Se você estiver escrevendo um objeto de pipeline de Microsoft Media Foundation (uma origem de mídia, uma transformação ou um coletor de mídia), talvez seja necessário dar suporte a taxas de reprodução de variáveis.</span><span class="sxs-lookup"><span data-stu-id="3282f-113">If you are writing a Microsoft Media Foundation pipeline object (a media source, transform, or media sink), you might need to support variable playback rates.</span></span> <span data-ttu-id="3282f-114">Para fazer isso, implemente as seguintes interfaces:</span><span class="sxs-lookup"><span data-stu-id="3282f-114">To do so, implement the following interfaces:</span></span>

1.  <span data-ttu-id="3282f-115">Implemente a interface [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) .</span><span class="sxs-lookup"><span data-stu-id="3282f-115">Implement the [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) interface.</span></span>
2.  <span data-ttu-id="3282f-116">Suporte ao serviço de **\_ \_ controle \_ de taxa de MF** .</span><span class="sxs-lookup"><span data-stu-id="3282f-116">Support the **MF\_RATE\_CONTROL\_SERVICE** service.</span></span> <span data-ttu-id="3282f-117">(Consulte [interfaces de serviço](service-interfaces.md).)</span><span class="sxs-lookup"><span data-stu-id="3282f-117">(See [Service Interfaces](service-interfaces.md).)</span></span>
3.  <span data-ttu-id="3282f-118">Implemente a interface [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) , que obtém as taxas de reprodução com suporte do objeto.</span><span class="sxs-lookup"><span data-stu-id="3282f-118">Implement the [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) interface, which gets the playback rates supported by the object.</span></span>
4.  <span data-ttu-id="3282f-119">Implemente a interface [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol) , que Obtém ou define a taxa de reprodução.</span><span class="sxs-lookup"><span data-stu-id="3282f-119">Implement the [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol) interface, which gets or sets the playback rate.</span></span>

## <a name="media-sources"></a><span data-ttu-id="3282f-120">Fontes de mídia</span><span class="sxs-lookup"><span data-stu-id="3282f-120">Media Sources</span></span>

<span data-ttu-id="3282f-121">Se uma fonte de mídia der suporte ao controle de taxa, ela deverá implementar [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) e [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span><span class="sxs-lookup"><span data-stu-id="3282f-121">If a media source supports rate control, it should implement both [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) and [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span></span> <span data-ttu-id="3282f-122">Caso contrário, a sessão de mídia informa que a taxa mínima e máxima de reprodução é 1,0, independentemente de quais outros componentes estão no pipeline.</span><span class="sxs-lookup"><span data-stu-id="3282f-122">Otherwise, the Media Session reports that the minimum and maximum playback rate is 1.0, regardless of what other components are in the pipeline.</span></span>

<span data-ttu-id="3282f-123">A taxa de reprodução não afeta os tempos de apresentação dos exemplos, portanto, a origem da mídia não deve ajustar seus carimbos de data/hora.</span><span class="sxs-lookup"><span data-stu-id="3282f-123">The playback rate does not affect the presentation times of the samples, so the media source should not adjust its time stamps.</span></span> <span data-ttu-id="3282f-124">Em vez disso, o relógio de apresentação é executado em uma velocidade mais rápida ou mais lenta.</span><span class="sxs-lookup"><span data-stu-id="3282f-124">Instead, the presentation clock runs at a faster or slower speed.</span></span> <span data-ttu-id="3282f-125">Para reprodução reversa, a origem fornece amostras na ordem inversa, com carimbos de data/hora decrescentes.</span><span class="sxs-lookup"><span data-stu-id="3282f-125">For reverse playback, the source delivers samples in reverse order, with decreasing time stamps.</span></span>

<span data-ttu-id="3282f-126">O parâmetro *fThin* do método [**IMFRateControl:: SetRate**](/windows/desktop/api/mfidl/nf-mfidl-imfratecontrol-setrate) indica se a origem da mídia deve *esfinar* o conteúdo.</span><span class="sxs-lookup"><span data-stu-id="3282f-126">The *fThin* parameter of the [**IMFRateControl::SetRate**](/windows/desktop/api/mfidl/nf-mfidl-imfratecontrol-setrate) method indicates whether media source should *thin* the content.</span></span> <span data-ttu-id="3282f-127">O finamento se aplica principalmente a fluxos de vídeo.</span><span class="sxs-lookup"><span data-stu-id="3282f-127">Thinning applies primarily to video streams.</span></span> <span data-ttu-id="3282f-128">No modo fino, a origem descarta os quadros Delta e entrega apenas os quadros-chave.</span><span class="sxs-lookup"><span data-stu-id="3282f-128">In thinned mode, the source drops delta frames and deliver only key frames.</span></span> <span data-ttu-id="3282f-129">Em taxas de reprodução muito altas, a origem pode ignorar alguns quadros-chave (por exemplo, entregar todos os outros quadros-chave).</span><span class="sxs-lookup"><span data-stu-id="3282f-129">At very high playback rates, the source might skip some key frames (for example, deliver every other key frame).</span></span>

<span data-ttu-id="3282f-130">A origem não precisa descartar amostras de áudio no modo fino.</span><span class="sxs-lookup"><span data-stu-id="3282f-130">The source does not have to drop audio samples in thinned mode.</span></span> <span data-ttu-id="3282f-131">No entanto, em taxas de reprodução muito altas, a origem pode não ser capaz de ler os dados com rapidez nough para preencher as solicitações de exemplo do pipeline.</span><span class="sxs-lookup"><span data-stu-id="3282f-131">At very high playback rates, however, the source might not be able to read data fast nough to fill the pipeline's sample requests.</span></span> <span data-ttu-id="3282f-132">Nesse caso, a origem pode precisar remover alguns dados de áudio.</span><span class="sxs-lookup"><span data-stu-id="3282f-132">In that case, the source might need to drop some audio data.</span></span> <span data-ttu-id="3282f-133">Nesse caso, ele deve tentar entregar amostras de áudio que estão próximas no tempo para os exemplos de vídeo (supondo que a origem tenha os dois tipos de fluxo).</span><span class="sxs-lookup"><span data-stu-id="3282f-133">If so, it should attempt to deliver audio samples that are close in time to the video samples (assuming that the source has both types of stream).</span></span>

<span data-ttu-id="3282f-134">Quando um fluxo faz a transição entre o modo fino e não fino, ele envia um evento [MEStreamThinMode](mestreamthinmode.md) .</span><span class="sxs-lookup"><span data-stu-id="3282f-134">When a stream transitions between thinned and non-thinned mode, it sends an [MEStreamThinMode](mestreamthinmode.md) event.</span></span>

<span data-ttu-id="3282f-135">Quando a origem da mídia conclui uma chamada para [**SetRate**](/windows/desktop/api/mfidl/nf-mfidl-imfratecontrol-setrate), ela envia o evento [MESourceRateChanged](mesourceratechanged.md) .</span><span class="sxs-lookup"><span data-stu-id="3282f-135">When the media source completes a call to [**SetRate**](/windows/desktop/api/mfidl/nf-mfidl-imfratecontrol-setrate), it sends the [MESourceRateChanged](mesourceratechanged.md) event.</span></span>

<span data-ttu-id="3282f-136">Durante a reprodução reversa:</span><span class="sxs-lookup"><span data-stu-id="3282f-136">During reverse playback:</span></span>

-   <span data-ttu-id="3282f-137">A origem da mídia fornece amostras na ordem inversa, sem ajustar os carimbos de data/hora.</span><span class="sxs-lookup"><span data-stu-id="3282f-137">The media source delivers samples in reverse order, without adjusting the time stamps.</span></span>
-   <span data-ttu-id="3282f-138">Carimbos de data/hora em um fluxo devem diminuir de forma monotônico.</span><span class="sxs-lookup"><span data-stu-id="3282f-138">Time stamps within a stream should monotonically decrease.</span></span>
-   <span data-ttu-id="3282f-139">O início do conteúdo é considerado o fim do fluxo.</span><span class="sxs-lookup"><span data-stu-id="3282f-139">The beginning of the content is considered the end of the stream.</span></span> <span data-ttu-id="3282f-140">Depois que cada fluxo de mídia entrega o primeiro exemplo no fluxo (ou seja, o tempo de apresentação = 0), ele envia o evento [MEEndOfStream](meendofstream.md) .</span><span class="sxs-lookup"><span data-stu-id="3282f-140">After each media stream delivers the first sample in the stream (that is, presentation time = 0), it sends the [MEEndOfStream](meendofstream.md) event.</span></span>

## <a name="media-foundation-transforms"></a><span data-ttu-id="3282f-141">Transformações de Media Foundation</span><span class="sxs-lookup"><span data-stu-id="3282f-141">Media Foundation Transforms</span></span>

<span data-ttu-id="3282f-142">Em geral, uma Media Foundation de transformação (MFT) não precisa de suporte explícito para o controle de taxa, a menos que a MFT implemente a reprodução reversa não-finada.</span><span class="sxs-lookup"><span data-stu-id="3282f-142">In general, a Media Foundation transform (MFT) does not need explicit support for rate control, unless the MFT implements non-thinned reverse playback.</span></span>

<span data-ttu-id="3282f-143">Se uma MFT não implementar a interface [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) , a sessão de mídia assumirá o seguinte:</span><span class="sxs-lookup"><span data-stu-id="3282f-143">If an MFT does not implement the [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) interface, the Media Session assumes the following:</span></span>

-   <span data-ttu-id="3282f-144">A MFT dá suporte a taxas de reprodução de arbitrário para reprodução de encaminhamento, finas e não finas.</span><span class="sxs-lookup"><span data-stu-id="3282f-144">The MFT supports arbitary playback rates for forward playback, both thinned and non-thinned.</span></span>
-   <span data-ttu-id="3282f-145">O MFT dá suporte à reprodução revertida fina, mas não oferece suporte à reprodução reversa não-finada.</span><span class="sxs-lookup"><span data-stu-id="3282f-145">The MFT supports thinned reverse playback, but does not support non-thinned reverse playback.</span></span>

<span data-ttu-id="3282f-146">Se uma dessas condições não for verdadeira, o MFT deverá implementar [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) e [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span><span class="sxs-lookup"><span data-stu-id="3282f-146">If either of these conditions is not true, the MFT should implement [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) and [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span></span>

### <a name="reverse-playback"></a><span data-ttu-id="3282f-147">Reprodução reversa</span><span class="sxs-lookup"><span data-stu-id="3282f-147">Reverse Playback</span></span>

<span data-ttu-id="3282f-148">A sessão de mídia pode ser revertida mesmo que uma ou mais transformações no pipeline não ofereçam suporte explicitamente à reprodução inversa.</span><span class="sxs-lookup"><span data-stu-id="3282f-148">The Media Session can play in reverse even if one or more transforms in the pipeline do not explicitly support reverse playback.</span></span>

<span data-ttu-id="3282f-149">Se uma MFT não expõe a interface [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) , a sessão de mídia usa o *finamento* para reprodução reversa, da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="3282f-149">If an MFT does not expose the [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) interface, the Media Session uses *thinning* for reverse playback, as follows:</span></span>

-   <span data-ttu-id="3282f-150">A sessão de mídia envia quadros-chave para o MFT da maneira usual, chamando [**IMFTransform::P rocessinput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput).</span><span class="sxs-lookup"><span data-stu-id="3282f-150">The Media Session sends key frames to the MFT in the usual way, by calling [**IMFTransform::ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput).</span></span>

-   <span data-ttu-id="3282f-151">A sessão de mídia descarta os quadros Delta e os substitui pelos eventos [MEStreamTick](mestreamtick.md) .</span><span class="sxs-lookup"><span data-stu-id="3282f-151">The Media Session drops delta frames and replaces them with [MEStreamTick](mestreamtick.md) events.</span></span>

-   <span data-ttu-id="3282f-152">Entre cada exemplo, a sessão de mídia libera o MFT para evitar erros causados pelo fato de que os carimbos de data/hora estão diminuindo.</span><span class="sxs-lookup"><span data-stu-id="3282f-152">Between each sample, the Media Session flushes the MFT, to avoid any errors caused by the fact that the time stamps are decreasing.</span></span>

<span data-ttu-id="3282f-153">Um exemplo é considerado um quadro-chave se ele tiver o atributo [MFSampleExtension \_ CleanPoint](mfsampleextension-cleanpoint-attribute.md) definido como **true** e será considerado um quadro Delta se esse atributo for **false** ou não estiver definido.</span><span class="sxs-lookup"><span data-stu-id="3282f-153">A sample is considered a key frame if it has the [MFSampleExtension\_CleanPoint](mfsampleextension-cleanpoint-attribute.md) attribute set to **TRUE**, and is considered a delta frame if this attribute is **FALSE** or not set.</span></span>

<span data-ttu-id="3282f-154">Se o MFT implementar [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport), a sessão de mídia usará essa interface para descobrir se o MFT dá suporte à reprodução reversa não-finada.</span><span class="sxs-lookup"><span data-stu-id="3282f-154">If the MFT implements [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport), the Media Session uses this interface to discover whether the MFT supports non-thinned reverse playback.</span></span> <span data-ttu-id="3282f-155">Se o MFT der suporte à reprodução inversa não-finada, a sessão de mídia entregará todos os exemplos, na ordem inversa, sem descartar amostras ou liberar o MFT.</span><span class="sxs-lookup"><span data-stu-id="3282f-155">If the MFT supports non-thinned reverse playback, the Media Session delivers all of the samples, in reverse order, without dropping samples or flushing the MFT.</span></span>

<span data-ttu-id="3282f-156">Se uma MFT oferecer suporte à reprodução inversa não fina, ela deverá implementar a interface [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol) .</span><span class="sxs-lookup"><span data-stu-id="3282f-156">If an MFT supports non-thinned reverse playback, it should implement the [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol) interface.</span></span> <span data-ttu-id="3282f-157">A sessão de mídia usará essa interface para notificar o MFT quando ocorrer a reprodução reversa.</span><span class="sxs-lookup"><span data-stu-id="3282f-157">The Media Session will use this interface to notify the MFT when reverse playback occurs.</span></span> <span data-ttu-id="3282f-158">Nesse ponto, o MFT deve estar preparado para os carimbos de data/hora a serem reduzidos e para que os quadros Delta cheguem em ordem inversa.</span><span class="sxs-lookup"><span data-stu-id="3282f-158">At that point, the MFT must be prepared for the time stamps to decrease and for delta frames to arrive in reverse order.</span></span> <span data-ttu-id="3282f-159">Um decodificador normalmente precisará armazenar amostras em buffer até que tenha recebido um grupo inteiro de imagens (GOP) e, em seguida, decodificar toda a GOP e gerar os quadros decodificados na ordem correta (inversa).</span><span class="sxs-lookup"><span data-stu-id="3282f-159">A decoder will typically need to buffer samples until it has received an entire group of pictures (GOP), then decode the entire GOP and output the decoded frames in the correct (reverse) order.</span></span>

## <a name="media-sinks"></a><span data-ttu-id="3282f-160">Coletores de mídia</span><span class="sxs-lookup"><span data-stu-id="3282f-160">Media Sinks</span></span>

<span data-ttu-id="3282f-161">Se um coletor de mídia for sem *taxa*, a sessão de mídia assumirá que o coletor de mídia pode lidar com qualquer taxa de reprodução.</span><span class="sxs-lookup"><span data-stu-id="3282f-161">If a media sink is *rateless*, the Media Session assumes that media sink can handle any playback rate.</span></span> <span data-ttu-id="3282f-162">O coletor de mídia não precisa implementar [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport).</span><span class="sxs-lookup"><span data-stu-id="3282f-162">The media sink does not need to implement [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport).</span></span> <span data-ttu-id="3282f-163">(Um coletor de mídia sem tarifas retorna o MEDIASINK \_ Sinalizador sem taxa do método [**IMFMediaSink:: getcaracterísticas**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasink-getcharacteristics) .)</span><span class="sxs-lookup"><span data-stu-id="3282f-163">(A rateless media sink returns the MEDIASINK\_RATELESS flag from the [**IMFMediaSink::GetCharacteristics**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasink-getcharacteristics) method.)</span></span>

<span data-ttu-id="3282f-164">Caso contrário, um coletor de mídia deve implementar [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) se puder lidar com as taxas de reprodução diferentes de 1,0.</span><span class="sxs-lookup"><span data-stu-id="3282f-164">Otherwise, a media sink should implement [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) if it can handle playback rates other than 1.0.</span></span>

<span data-ttu-id="3282f-165">Os coletores de mídia não devem implementar [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span><span class="sxs-lookup"><span data-stu-id="3282f-165">Media sinks should not implement [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span></span> <span data-ttu-id="3282f-166">Quando a taxa de reprodução é alterada, o relógio da apresentação chama o método [**IMFClockStateSink:: OnClockSetRate**](/windows/desktop/api/mfidl/nf-mfidl-imfclockstatesink-onclocksetrate) do coletor de mídia.</span><span class="sxs-lookup"><span data-stu-id="3282f-166">When the playback rate changes, the presentation clock calls the media sink's [**IMFClockStateSink::OnClockSetRate**](/windows/desktop/api/mfidl/nf-mfidl-imfclockstatesink-onclocksetrate) method.</span></span>

## <a name="related-topics"></a><span data-ttu-id="3282f-167">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="3282f-167">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="3282f-168">Controle de taxa</span><span class="sxs-lookup"><span data-stu-id="3282f-168">Rate Control</span></span>](rate-control.md)
</dt> <dt>

[<span data-ttu-id="3282f-169">Busca, avanço rápido e reprodução reversa</span><span class="sxs-lookup"><span data-stu-id="3282f-169">Seeking, Fast Forward, and Reverse Play</span></span>](seeking--fast-forward--and-reverse-play.md)
</dt> </dl>

 

 



