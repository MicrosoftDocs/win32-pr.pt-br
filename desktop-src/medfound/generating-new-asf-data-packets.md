---
description: Gerando novos pacotes de dados ASF
ms.assetid: 7afa9694-c965-40e2-8549-e32ff48def2a
title: Gerando novos pacotes de dados ASF
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 78f3432ecf34c58247a1533adb202b75f59d770c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104457212"
---
# <a name="generating-new-asf-data-packets"></a><span data-ttu-id="ed89c-103">Gerando novos pacotes de dados ASF</span><span class="sxs-lookup"><span data-stu-id="ed89c-103">Generating New ASF Data Packets</span></span>

<span data-ttu-id="ed89c-104">O *multiplexador* de ASF é um componente de camada WMContainer que funciona com o [objeto de dados ASF](asf-file-structure.md) e dá a um aplicativo a capacidade de gerar pacotes de dados ASF para um fluxo que corresponde aos requisitos definidos no objeto ContentInfo.</span><span class="sxs-lookup"><span data-stu-id="ed89c-104">The ASF *multiplexer* is a WMContainer layer component that works with the [ASF Data Object](asf-file-structure.md) and gives an application the ability to generate ASF data packets for a stream that match the requirements defined in the ContentInfo object.</span></span>

<span data-ttu-id="ed89c-105">O multiplexador tem uma entrada e uma saída.</span><span class="sxs-lookup"><span data-stu-id="ed89c-105">The multiplexer has one input and one output.</span></span> <span data-ttu-id="ed89c-106">Ele recebe um exemplo de fluxo que contém dados de mídia digital e produz um ou mais pacotes de dados que podem ser gravados em um contêiner ASF.</span><span class="sxs-lookup"><span data-stu-id="ed89c-106">It receives a stream sample that contains digital media data and produces one or more data packet that can be written to an ASF container.</span></span>

<span data-ttu-id="ed89c-107">A lista a seguir resume o processo de geração de pacotes de dados ASF:</span><span class="sxs-lookup"><span data-stu-id="ed89c-107">The following list summarizes the process of generating ASF data packets:</span></span>

1.  <span data-ttu-id="ed89c-108">Passe os dados de entrada para o multiplexador em [**IMFASFMultiplexer::P rocesssample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="ed89c-108">Pass input data to the multiplexer in [**IMFASFMultiplexer::ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span>
2.  <span data-ttu-id="ed89c-109">Colete os pacotes de dados chamando [**IMFASFMultiplexer:: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) em um loop até que todos os pacotes completos tenham sido recuperados.</span><span class="sxs-lookup"><span data-stu-id="ed89c-109">Collect the data packets by calling [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop until all the complete packets have been retrieved.</span></span>
3.  <span data-ttu-id="ed89c-110">Depois que os dados de entrada são convertidos em pacotes completos, pode haver alguns dados pendentes no Multiplexador, que não foi recuperado pelo [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span><span class="sxs-lookup"><span data-stu-id="ed89c-110">After the input data has been converted into complete packets there might be some pending data in the multiplexer, which was not retrieved by [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span></span> <span data-ttu-id="ed89c-111">Chame [**IMFASFMultiplexer:: flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) para reunir os exemplos pendentes e coletá-los do Multiplexador chamando **GetNextPacket** novamente.</span><span class="sxs-lookup"><span data-stu-id="ed89c-111">Call [**IMFASFMultiplexer::Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) to packetize the pending samples and collect them from the multiplexer by calling **GetNextPacket** again.</span></span>
4.  <span data-ttu-id="ed89c-112">Atualize os objetos de cabeçalho ASF associados chamando [**IMFASFMultiplexer:: End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) para refletir as alterações feitas pelo multiplexador durante a geração de pacotes de dados.</span><span class="sxs-lookup"><span data-stu-id="ed89c-112">Update the associated ASF Header Objects by calling [**IMFASFMultiplexer::End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) to reflect changes made by the multiplexer during data packet generation.</span></span>

<span data-ttu-id="ed89c-113">O diagrama a seguir ilustra a geração de pacotes de dados para um arquivo ASF por meio do Multiplexador.</span><span class="sxs-lookup"><span data-stu-id="ed89c-113">The following diagram illustrates data packet generation for an ASF file through the multiplexer.</span></span>

![diagrama mostrando a geração de pacotes de dados para um arquivo ASF](images/packet.gif)

## <a name="asf-data-packet-creation"></a><span data-ttu-id="ed89c-115">Criação de pacote de dados ASF</span><span class="sxs-lookup"><span data-stu-id="ed89c-115">ASF Data Packet Creation</span></span>

<span data-ttu-id="ed89c-116">Depois de criar e inicializar o multiplexador conforme descrito em [criando o objeto multiplexador](creating-the-multiplexer-object.md), chame [**IMFASFMultiplexer::P rocesssample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) para passar dados de entrada para o multiplexador para processamento em pacotes de dados.</span><span class="sxs-lookup"><span data-stu-id="ed89c-116">After creating and initializing the multiplexer as described in [Creating the Multiplexer Object](creating-the-multiplexer-object.md), call [**IMFASFMultiplexer::ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) to pass input data to the multiplexer for processing into data packets.</span></span> <span data-ttu-id="ed89c-117">A entrada especificada deve estar em um exemplo de mídia (interface [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) ) que pode ter um ou mais buffers de mídia (interface [**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) ) que contém os dados de um fluxo.</span><span class="sxs-lookup"><span data-stu-id="ed89c-117">The specified input must be in a media sample ([**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) interface) that can have one or more media buffers ([**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) interface) containing the data for a stream.</span></span> <span data-ttu-id="ed89c-118">No caso de transcodificação de ASF para ASF, o exemplo de mídia de entrada pode ser gerado a partir do divisor que cria amostras de fluxo em pacotes.</span><span class="sxs-lookup"><span data-stu-id="ed89c-118">In case of ASF-to-ASF transcoding, the input media sample can be generated from the splitter that creates packetized stream samples.</span></span> <span data-ttu-id="ed89c-119">Para obter mais informações, consulte [divisor de ASF](asf-splitter.md).</span><span class="sxs-lookup"><span data-stu-id="ed89c-119">For more information, see [ASF Splitter](asf-splitter.md).</span></span>

<span data-ttu-id="ed89c-120">Antes de chamar [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample), certifique-se de que o carimbo de data/hora do exemplo de mídia de entrada seja um horário de apresentação válido; caso contrário, **ProcessSample** falhará e retornará o \_ código de carimbo de \_ \_ data/hora MF e no Sample \_ .</span><span class="sxs-lookup"><span data-stu-id="ed89c-120">Before calling [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample), make sure that the time stamp of the input media sample is a valid presentation time; otherwise **ProcessSample** fails and returns the MF\_E\_NO\_SAMPLE\_TIMESTAMP code.</span></span>

<span data-ttu-id="ed89c-121">O multiplexador pode aceitar entrada como amostras de mídia compactadas ou descompactadas por meio do [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="ed89c-121">The multiplexer can accept input as compressed or uncompressed media samples through [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span> <span data-ttu-id="ed89c-122">O multiplexador atribui horas de envio a esses exemplos, dependendo do uso de largura de banda do fluxo.</span><span class="sxs-lookup"><span data-stu-id="ed89c-122">The multiplexer assigns send times to these samples depending on the bandwidth usage of the stream.</span></span> <span data-ttu-id="ed89c-123">Durante esse processo, o multiplexador verifica os parâmetros de Bucket vazado (taxa de bits e utilização da janela de buffer) e pode rejeitar amostras que não aderem a esses valores.</span><span class="sxs-lookup"><span data-stu-id="ed89c-123">During this process, the multiplexer checks the leaky bucket parameters (bit rate and buffer window utilization) and can reject samples that do not adhere to those values.</span></span> <span data-ttu-id="ed89c-124">O exemplo de mídia de entrada pode falhar a verificação de largura de banda por qualquer um dos seguintes motivos:</span><span class="sxs-lookup"><span data-stu-id="ed89c-124">The input media sample can fail the bandwidth check for either of the following reasons:</span></span>

-   <span data-ttu-id="ed89c-125">Se o exemplo de mídia de entrada chegou atrasado porque a hora de envio da última atribuição é maior do que o carimbo de data/hora neste exemplo de mídia.</span><span class="sxs-lookup"><span data-stu-id="ed89c-125">If the input media sample arrived late because the last-assigned send time is greater than the time stamp on this media sample.</span></span> <span data-ttu-id="ed89c-126">[**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) falhará e retornará o código de erro de **\_ \_ \_ exemplo MF e tardia** .</span><span class="sxs-lookup"><span data-stu-id="ed89c-126">[**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) fails and returns the **MF\_E\_LATE\_SAMPLE** error code.</span></span>
-   <span data-ttu-id="ed89c-127">Se o carimbo de data/hora no exemplo de mídia de entrada for anterior à hora de envio atribuída (isso indica estouro de buffer).</span><span class="sxs-lookup"><span data-stu-id="ed89c-127">If the time stamp on the input media sample is earlier than the assigned send time (this indicates buffer overflow).</span></span> <span data-ttu-id="ed89c-128">O multiplexador pode ignorar essa situação se ela estiver configurada para ajustar a taxa de bits definindo o sinalizador do **MFASF \_ multiplexador \_ AutoAjuste de \_ taxa** de bit durante a inicialização do Multiplexador.</span><span class="sxs-lookup"><span data-stu-id="ed89c-128">The multiplexer can ignore this situation if it is configured to adjust the bit rate by setting the **MFASF\_MULTIPLEXER\_AUTOADJUST\_BITRATE** flag during multiplexer initialization.</span></span> <span data-ttu-id="ed89c-129">Para obter mais informações, consulte "inicialização do Multiplexador e configurações de Bucket de vazamentos" em [criando o objeto multiplexador](creating-the-multiplexer-object.md).</span><span class="sxs-lookup"><span data-stu-id="ed89c-129">For more information, see "Multiplexer Initialization and Leaky Bucket Settings" in [Creating the Multiplexer Object](creating-the-multiplexer-object.md).</span></span> <span data-ttu-id="ed89c-130">Se esse sinalizador não estiver definido e o multiplexador encontrar saturação de largura de banda, [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) falhará e retornará o código de erro de **saturação da largura de \_ \_ banda \_ e MF** .</span><span class="sxs-lookup"><span data-stu-id="ed89c-130">If this flag is not set and the multiplexer encounters bandwidth overrun, [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) fails and returns the **MF\_E\_BANDWIDTH\_OVERRUN** error code.</span></span>

<span data-ttu-id="ed89c-131">Depois que o multiplexador atribui a hora de envio, o exemplo de mídia de entrada é adicionado à *janela de envio*— uma lista de amostras de mídia de entrada ordenada por horas de envio e pronta para ser processada em pacotes de dados.</span><span class="sxs-lookup"><span data-stu-id="ed89c-131">After the multiplexer assigns the send time, the input media sample is added to the *send window*—a list of input media samples ordered by send times and ready to be processed into data packets.</span></span> <span data-ttu-id="ed89c-132">Durante a construção do pacote de dados, o exemplo de mídia de entrada é analisado e os dados relevantes são gravados em um pacote de dados como carga.</span><span class="sxs-lookup"><span data-stu-id="ed89c-132">During data packet construction, the input media sample is parsed and relevant data is written to a data packet as payload.</span></span> <span data-ttu-id="ed89c-133">Um pacote de dados completo pode conter dados de um ou mais exemplos de mídia de entrada.</span><span class="sxs-lookup"><span data-stu-id="ed89c-133">A complete data packet can contain data from one or more input media samples.</span></span>

<span data-ttu-id="ed89c-134">Quando novas amostras de mídia de entrada chegam na janela enviar, elas são adicionadas a uma fila até que haja amostras de mídia suficientes para formar um pacote completo.</span><span class="sxs-lookup"><span data-stu-id="ed89c-134">When new input media samples arrive in the send window, they are added to a queue until there are enough media samples to form one complete packet.</span></span> <span data-ttu-id="ed89c-135">Os dados nos buffers de mídia contidos no exemplo de mídia de entrada não são copiados para o pacote de dados gerado.</span><span class="sxs-lookup"><span data-stu-id="ed89c-135">The data in media buffers contained by the input media sample are not copied to the generated data packet.</span></span> <span data-ttu-id="ed89c-136">O pacote de dados armazena referências aos buffers de mídia de entrada até que o exemplo de mídia de entrada tenha sido totalmente em pacote e o pacote completo tenha sido coletado do Multiplexador.</span><span class="sxs-lookup"><span data-stu-id="ed89c-136">The data packet hold references to the input media buffers until the input media sample has been fully packetized and the complete packet have been collected from the multiplexer.</span></span>

<span data-ttu-id="ed89c-137">Quando um pacote de dados completo está disponível, ele pode ser recuperado chamando [**IMFASFMultiplexer:: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span><span class="sxs-lookup"><span data-stu-id="ed89c-137">When a complete data packet is available, it can be retrieved by calling [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span></span> <span data-ttu-id="ed89c-138">Se você chamar [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) enquanto houver pacotes completos prontos para recuperação, ele falhará e retornará o código de erro **MF \_ e não \_ aceitar** .</span><span class="sxs-lookup"><span data-stu-id="ed89c-138">If you call [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) while there are complete packets ready for retrieval, it fails and returns the **MF\_E\_NOTACCEPTING** error code.</span></span> <span data-ttu-id="ed89c-139">Isso indica que o multiplexador não pode aceitar mais entrada e você deve chamar **GetNextPacket** para recuperar os pacotes em espera.</span><span class="sxs-lookup"><span data-stu-id="ed89c-139">This indicates that the multiplexer cannot accept more input and you must call **GetNextPacket** to retrieve the waiting packets.</span></span> <span data-ttu-id="ed89c-140">Idealmente, cada chamada **ProcessSample** deve ser seguida por uma ou mais chamadas **GetNextPacket** para obter os pacotes de dados completos.</span><span class="sxs-lookup"><span data-stu-id="ed89c-140">Ideally, every **ProcessSample** call should be followed by one or more **GetNextPacket** calls to get the complete data packets.</span></span> <span data-ttu-id="ed89c-141">Pode levar mais de um exemplo de mídia de entrada para criar um pacote de dados completo.</span><span class="sxs-lookup"><span data-stu-id="ed89c-141">It may take more than one input media sample to create a complete data packet.</span></span> <span data-ttu-id="ed89c-142">Por outro lado, os dados em um exemplo de mídia de entrada podem abranger vários pacotes.</span><span class="sxs-lookup"><span data-stu-id="ed89c-142">Conversely, data in one input media sample might span multiple packets.</span></span> <span data-ttu-id="ed89c-143">Portanto, nem todas as chamadas para **ProcessSample** produzirão exemplos de mídia de saída.</span><span class="sxs-lookup"><span data-stu-id="ed89c-143">Therefore, not all calls to **ProcessSample** will yield output media samples.</span></span>

<span data-ttu-id="ed89c-144">Se o exemplo de mídia de entrada contiver um quadro-chave indicado pelo atributo [**MFSampleExtension \_ CleanPoint**](mfsampleextension-cleanpoint-attribute.md) , o multiplexador copiará o atributo para o pacote.</span><span class="sxs-lookup"><span data-stu-id="ed89c-144">If the input media sample contains a key frame indicated by the [**MFSampleExtension\_CleanPoint**](mfsampleextension-cleanpoint-attribute.md) attribute, the multiplexer copies the attribute to the packet.</span></span>

## <a name="getting-asf-data-packets"></a><span data-ttu-id="ed89c-145">Obtendo pacotes de dados ASF</span><span class="sxs-lookup"><span data-stu-id="ed89c-145">Getting ASF Data Packets</span></span>

<span data-ttu-id="ed89c-146">Para coletar exemplos de mídia de saída para um pacote de dados completo gerado pelo Multiplexador, chame [**IMFASFMultiplexer:: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) em um loop até que não haja mais exemplos de mídia de saída restantes para o pacote.</span><span class="sxs-lookup"><span data-stu-id="ed89c-146">To collect the output media samples for a complete data packet generated by the multiplexer, call [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop until there are no more output media samples left for the packet.</span></span> <span data-ttu-id="ed89c-147">O seguinte lista os casos de êxito:</span><span class="sxs-lookup"><span data-stu-id="ed89c-147">The following lists the success cases:</span></span>

-   <span data-ttu-id="ed89c-148">Se houver um pacote de dados completo disponível, o [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) receberá o sinalizador **\_ \_ \_ incompleto de sinalizadores de status do ASF** no parâmetro *pdwStatusFlags* ; o parâmetro *ppIPacket* receberá um ponteiro para o primeiro pacote de dados.</span><span class="sxs-lookup"><span data-stu-id="ed89c-148">If there is a complete data packet available, [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) receives the **ASF\_STATUS\_FLAGS\_INCOMPLETE** flag in the *pdwStatusFlags* parameter; the *ppIPacket* parameter receives a pointer to the first data packet.</span></span> <span data-ttu-id="ed89c-149">Você deve chamar esse método desde que ele receba esse sinalizador.</span><span class="sxs-lookup"><span data-stu-id="ed89c-149">You must call this method as long it receives this flag.</span></span> <span data-ttu-id="ed89c-150">Com cada iteração, *ppIPacket* aponta para o próximo pacote na fila.</span><span class="sxs-lookup"><span data-stu-id="ed89c-150">With every iteration, *ppIPacket* points to the next packet in the queue.</span></span>
-   <span data-ttu-id="ed89c-151">Se houver apenas um pacote de dados, *ppIPacket* apontará para ele e o sinalizador **status do ASF \_ \_ sinalizadores \_ incompletos** não será recebido em *pdwStatusFlags*.</span><span class="sxs-lookup"><span data-stu-id="ed89c-151">If there is only one data packet, *ppIPacket* points to it and the **ASF\_STATUS\_FLAGS\_INCOMPLETE** flag is not received in *pdwStatusFlags*.</span></span>
-   <span data-ttu-id="ed89c-152">O [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) pode ser bem sucedido sem gerar nenhum pacote de dados se o multiplexador ainda estiver no processo de pacotes e adição de pacotes de dados.</span><span class="sxs-lookup"><span data-stu-id="ed89c-152">[**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) can succeed without yielding any data packets if the multiplexer is still in the process of packetizing and adding data packets.</span></span> <span data-ttu-id="ed89c-153">Nesse caso, *ppIPacket* aponta para **NULL**.</span><span class="sxs-lookup"><span data-stu-id="ed89c-153">In this case, *ppIPacket* points to **NULL**.</span></span> <span data-ttu-id="ed89c-154">Para continuar, você deve fornecer o multiplexador com mais amostras de mídia de entrada chamando [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="ed89c-154">To proceed, you must provide the multiplexer with more input media samples by calling [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span>

<span data-ttu-id="ed89c-155">O código de exemplo a seguir mostra uma função que gera pacotes de dados usando o multiplexador.</span><span class="sxs-lookup"><span data-stu-id="ed89c-155">The following example code shows a function that generates data packets by using the multiplexer.</span></span> <span data-ttu-id="ed89c-156">O conteúdo do pacote de dados gerado será gravado no fluxo de bytes de dados alocado pelo chamador.</span><span class="sxs-lookup"><span data-stu-id="ed89c-156">The generated data packet contents will be written to the data byte stream allocated by the caller.</span></span>


```C++
//-------------------------------------------------------------------
// GenerateASFDataPackets
// 
// Gets data packets from the mux. This function is called after 
// calling IMFASFMultiplexer::ProcessSample. 
//-------------------------------------------------------------------

HRESULT GenerateASFDataPackets( 
    IMFASFMultiplexer *pMux, 
    IMFByteStream *pDataStream
    )
{
    HRESULT hr = S_OK;

    IMFSample *pOutputSample = NULL;
    IMFMediaBuffer *pDataPacketBuffer = NULL;

    DWORD dwMuxStatus = ASF_STATUSFLAGS_INCOMPLETE;

    while (dwMuxStatus & ASF_STATUSFLAGS_INCOMPLETE)
    {
        hr = pMux->GetNextPacket(&dwMuxStatus, &pOutputSample);

        if (FAILED(hr))
        {
            break;
        }

        if (pOutputSample)
        {
            //Convert to contiguous buffer
            hr = pOutputSample->ConvertToContiguousBuffer(&pDataPacketBuffer);
            
            if (FAILED(hr))
            {
                break;
            }

            //Write buffer to byte stream
            hr = WriteBufferToByteStream(pDataStream, pDataPacketBuffer, NULL);

            if (FAILED(hr))
            {
                break;
            }
        }

        SafeRelease(&pDataPacketBuffer);
        SafeRelease(&pOutputSample);
    }

    SafeRelease(&pOutputSample);
    SafeRelease(&pDataPacketBuffer);
    return hr;
}
```



<span data-ttu-id="ed89c-157">A `WriteBufferToByteStream` função é mostrada no tópico [**IMFByteStream:: Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).</span><span class="sxs-lookup"><span data-stu-id="ed89c-157">The `WriteBufferToByteStream` function is shown in the topic [**IMFByteStream::Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).</span></span>

<span data-ttu-id="ed89c-158">Para ver um aplicativo completo que usa este exemplo de código, consulte [tutorial: copiando fluxos ASF de um arquivo para outro](tutorial--copying-asf-streams-from-one-file-to-another.md).</span><span class="sxs-lookup"><span data-stu-id="ed89c-158">To see a complete application that uses this code example, see [Tutorial: Copying ASF Streams from One File to Another](tutorial--copying-asf-streams-from-one-file-to-another.md).</span></span>

## <a name="post-packet-generation-calls"></a><span data-ttu-id="ed89c-159">Postar chamadas de Packet-Generation</span><span class="sxs-lookup"><span data-stu-id="ed89c-159">Post Packet-Generation Calls</span></span>

<span data-ttu-id="ed89c-160">Para certificar-se de que não há nenhum pacote de dados completo aguardando no Multiplexador, chame [**IMFASFMultiplexer:: flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush).</span><span class="sxs-lookup"><span data-stu-id="ed89c-160">To make sure that there are no complete data packets waiting in the multiplexer, call [**IMFASFMultiplexer::Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush).</span></span> <span data-ttu-id="ed89c-161">Isso força o multiplexador a fazer o pacote de todos os exemplos de mídia em andamento.</span><span class="sxs-lookup"><span data-stu-id="ed89c-161">This forces the multiplexer to packetize all the media samples that are in progress.</span></span> <span data-ttu-id="ed89c-162">O aplicativo pode coletar esses pacotes na forma de amostras de mídia por meio de **GetNextPacket** em um loop até que não haja mais nenhum pacote restante a ser recuperado.</span><span class="sxs-lookup"><span data-stu-id="ed89c-162">The application can collect these packets in form of media samples through **GetNextPacket** in a loop until there are no more packets left to be retrieved.</span></span>

<span data-ttu-id="ed89c-163">Depois que todas as amostras de mídia forem geradas, chame [**IMFASFMultiplexer:: End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) para atualizar o objeto de cabeçalho ASF que está associado a esses pacotes de dados.</span><span class="sxs-lookup"><span data-stu-id="ed89c-163">After all the media samples are generated, call [**IMFASFMultiplexer::End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) to update the ASF Header Object that is associated with these data packets.</span></span> <span data-ttu-id="ed89c-164">O objeto de cabeçalho é especificado passando o objeto ContentInfo que foi usado para inicializar o multiplexador.</span><span class="sxs-lookup"><span data-stu-id="ed89c-164">The Header Object is specified by passing the ContentInfo object that was used to initialize the multiplexer.</span></span> <span data-ttu-id="ed89c-165">Essa chamada atualiza vários objetos de cabeçalho para refletir as alterações feitas pelo multiplexador durante a geração de pacotes de dados.</span><span class="sxs-lookup"><span data-stu-id="ed89c-165">This call updates various Header Objects to reflect changes made by the multiplexer during data packet generation.</span></span> <span data-ttu-id="ed89c-166">Essas informações incluem contagem de pacotes, duração de envio, duração da reprodução e números de fluxo de todos os fluxos.</span><span class="sxs-lookup"><span data-stu-id="ed89c-166">This information includes packet count, send duration, play duration, and stream numbers of all the streams.</span></span> <span data-ttu-id="ed89c-167">O tamanho geral do cabeçalho também é atualizado.</span><span class="sxs-lookup"><span data-stu-id="ed89c-167">The overall header size is also updated.</span></span>

<span data-ttu-id="ed89c-168">Você deve garantir que [**end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) seja chamado depois que todos os pacotes de dados forem recuperados.</span><span class="sxs-lookup"><span data-stu-id="ed89c-168">You must ensure that [**End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) is called after all the data packets have been retrieved.</span></span> <span data-ttu-id="ed89c-169">Se houver algum pacote aguardando no Multiplexador, o **fim** falhará e retornará o código de erro **MF \_ E \_ flush \_ necessário** .</span><span class="sxs-lookup"><span data-stu-id="ed89c-169">If there are any packets waiting in the multiplexer, **End** will fail and return the **MF\_E\_FLUSH\_NEEDED** error code.</span></span> <span data-ttu-id="ed89c-170">Nesse caso, obtenha o pacote em espera chamando [**flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) e [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) em um loop.</span><span class="sxs-lookup"><span data-stu-id="ed89c-170">In this case, get the waiting packet by calling [**Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) and [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop.</span></span>

> [!Note]  
> <span data-ttu-id="ed89c-171">Para a codificação de VBR, depois de chamar **end**, você deve definir as estatísticas de codificação nas propriedades de codificação do objeto ContentInfo.</span><span class="sxs-lookup"><span data-stu-id="ed89c-171">For VBR encoding, after calling **End**, you must set the encoding statistics in the ContentInfo object's encoding properties.</span></span> <span data-ttu-id="ed89c-172">Para obter informações sobre esse processo, consulte "Configurando o objeto ContentInfo com as configurações do codificador" em [definindo propriedades no objeto ContentInfo](setting-properties-in-the-contentinfo-object.md).</span><span class="sxs-lookup"><span data-stu-id="ed89c-172">For information about this process, see "Configuring the ContentInfo Object with Encoder Settings" in [Setting Properties in the ContentInfo Object](setting-properties-in-the-contentinfo-object.md).</span></span> <span data-ttu-id="ed89c-173">A lista a seguir mostra as propriedades específicas a serem definidas:</span><span class="sxs-lookup"><span data-stu-id="ed89c-173">The following list shows the specific properties to set:</span></span>
>
> -   <span data-ttu-id="ed89c-174">[**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md) é a taxa de bits média do conteúdo da VBR.</span><span class="sxs-lookup"><span data-stu-id="ed89c-174">[**MFPKEY\_RAVG**](mfpkey-ravgproperty.md) is the average bit rate of the VBR content.</span></span>
> -   <span data-ttu-id="ed89c-175">[**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md) é a janela de buffer para a taxa média de bits.</span><span class="sxs-lookup"><span data-stu-id="ed89c-175">[**MFPKEY\_BAVG**](mfpkey-bavgproperty.md) is the buffer window for the average bit rate.</span></span>
> -   <span data-ttu-id="ed89c-176">[**MFPKEY \_ RMAX**](mfpkey-rmaxproperty.md) é a taxa de bits de pico do conteúdo da VBR.</span><span class="sxs-lookup"><span data-stu-id="ed89c-176">[**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md) is the peak bit rate of the VBR content.</span></span>
> -   <span data-ttu-id="ed89c-177">[**MFPKEY \_ BMAX**](mfpkey-bmaxproperty.md) é a janela de buffer de pico.</span><span class="sxs-lookup"><span data-stu-id="ed89c-177">[**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) is the peak buffer window.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="ed89c-178">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="ed89c-178">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="ed89c-179">Multiplexador ASF</span><span class="sxs-lookup"><span data-stu-id="ed89c-179">ASF Multiplexer</span></span>](asf-multiplexer.md)
</dt> <dt>

[<span data-ttu-id="ed89c-180">Tutorial: copiando fluxos ASF de um arquivo para outro</span><span class="sxs-lookup"><span data-stu-id="ed89c-180">Tutorial: Copying ASF Streams from One File to Another</span></span>](tutorial--copying-asf-streams-from-one-file-to-another.md)
</dt> <dt>

[<span data-ttu-id="ed89c-181">Tutorial: gravando um arquivo WMA usando a codificação de CBR</span><span class="sxs-lookup"><span data-stu-id="ed89c-181">Tutorial: Writing a WMA File by Using CBR Encoding</span></span>](tutorial--writing-a-wma-file-by-using-cbr-encoding.md)
</dt> </dl>

 

 



