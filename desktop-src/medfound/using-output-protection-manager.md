---
description: 'Saiba mais sobre: usando o Gerenciador de proteção de saída'
ms.assetid: 01edc17e-e71c-4772-a03c-09c9a2b8400f
title: Usando o Gerenciador de proteção de saída
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 57bf4def3b0575dd706ae5f0c62924b6f1375a05
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "105795470"
---
# <a name="using-output-protection-manager"></a><span data-ttu-id="670f9-103">Usando o Gerenciador de proteção de saída</span><span class="sxs-lookup"><span data-stu-id="670f9-103">Using Output Protection Manager</span></span>

<span data-ttu-id="670f9-104">Este tópico descreve como usar o OPM (Gerenciador de proteção de saída) para proteger o conteúdo de vídeo conforme ele viaja em um conector físico para um dispositivo de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-104">This topic describes how to use Output Protection Manager (OPM) to protect video content as it travels over a physical connector to a display device.</span></span> <span data-ttu-id="670f9-105">Este tópico contém as seguintes seções:</span><span class="sxs-lookup"><span data-stu-id="670f9-105">This topic contains the following sections:</span></span>

-   [<span data-ttu-id="670f9-106">Saídas de vídeo</span><span class="sxs-lookup"><span data-stu-id="670f9-106">Video Outputs</span></span>](#video-outputs)
-   [<span data-ttu-id="670f9-107">Inicializando uma sessão OPM</span><span class="sxs-lookup"><span data-stu-id="670f9-107">Initializing an OPM Session</span></span>](#initializing-an-opm-session)
-   [<span data-ttu-id="670f9-108">Enviando solicitações de status OPM</span><span class="sxs-lookup"><span data-stu-id="670f9-108">Sending OPM Status Requests</span></span>](#sending-opm-status-requests)
-   [<span data-ttu-id="670f9-109">Enviando comandos OPM</span><span class="sxs-lookup"><span data-stu-id="670f9-109">Sending OPM Commands</span></span>](#sending-opm-commands)
-   [<span data-ttu-id="670f9-110">Manipulando uma saída de vídeo desabilitada</span><span class="sxs-lookup"><span data-stu-id="670f9-110">Handling a Disabled Video Output</span></span>](#sending-opm-commands)
-   [<span data-ttu-id="670f9-111">Usando o HDCP para proteger o conteúdo</span><span class="sxs-lookup"><span data-stu-id="670f9-111">Using HDCP to Protect Content</span></span>](#using-hdcp-to-protect-content)

<span data-ttu-id="670f9-112">O conteúdo de vídeo Premium geralmente é criptografado para protegê-lo contra duplicação não autorizada.</span><span class="sxs-lookup"><span data-stu-id="670f9-112">Premium video content is usually encrypted to protect it from unauthorized duplication.</span></span> <span data-ttu-id="670f9-113">É claro que o vídeo deve ser descriptografado antes de ser exibido.</span><span class="sxs-lookup"><span data-stu-id="670f9-113">Of course, the video must be decrypted before it is displayed.</span></span> <span data-ttu-id="670f9-114">Os quadros descriptografados e descompactados devem viajar por um conector físico para o dispositivo de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-114">The decrypted, uncompressed frames must then travel across a physical connector to the display device.</span></span> <span data-ttu-id="670f9-115">Os provedores de conteúdo podem exigir que os quadros de vídeo sejam protegidos neste ponto, à medida que viajam pelo conector físico.</span><span class="sxs-lookup"><span data-stu-id="670f9-115">Content providers may require the video frames to be protected at this point, as they travel across the physical connector.</span></span>

<span data-ttu-id="670f9-116">Existem vários mecanismos de proteção para essa finalidade, incluindo High-Bandwidth Proteção de Conteúdo Digital (HDCP) e Proteção de Conteúdo de DisplayPort (DPCP) para saídas digitais; e sistema de gerenciamento de geração de cópia – analógico (CGMS-A) para saídas analógicas.</span><span class="sxs-lookup"><span data-stu-id="670f9-116">Various protection mechanisms exist for this purpose, including High-Bandwidth Digital Content Protection (HDCP) and DisplayPort Content Protection (DPCP) for digital outputs; and Copy Generation Management System - Analog (CGMS-A) for analog outputs.</span></span> <span data-ttu-id="670f9-117">Em geral, esses mecanismos envolvem criptografar ou embaralhar o sinal antes que ele vá para a tela.</span><span class="sxs-lookup"><span data-stu-id="670f9-117">Generally, these mechanisms involve encrypting or scrambling the signal befores it goes to the display.</span></span>

<span data-ttu-id="670f9-118">OPM permite que um aplicativo aplique mecanismos de proteção de conteúdo na saída de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-118">OPM enables an application to enforce content protection mechanisms on the video output.</span></span> <span data-ttu-id="670f9-119">Usando OPM, o aplicativo envia comandos e solicitações de status para o driver de gráficos por meio de um canal confiável e seguro.</span><span class="sxs-lookup"><span data-stu-id="670f9-119">Using OPM, the application sends commands and status requests to the graphics driver through a trusted, secure channel.</span></span> <span data-ttu-id="670f9-120">OPM permite que um aplicativo:</span><span class="sxs-lookup"><span data-stu-id="670f9-120">OPM enables an application to:</span></span>

-   <span data-ttu-id="670f9-121">Verifique se um driver de gráficos foi assinado pela Microsoft.</span><span class="sxs-lookup"><span data-stu-id="670f9-121">Verify that a graphics driver has been signed by Microsoft.</span></span>
-   <span data-ttu-id="670f9-122">Configure um canal de comunicação confiável com o driver.</span><span class="sxs-lookup"><span data-stu-id="670f9-122">Set up a trusted communication channel with the driver.</span></span>
-   <span data-ttu-id="670f9-123">Impor mecanismos de proteção de conteúdo na saída física.</span><span class="sxs-lookup"><span data-stu-id="670f9-123">Enforce content protection mechanisms on the physical output.</span></span>

<span data-ttu-id="670f9-124">OPM substitui a Border de proteção de saída certificada (COPP) e usa uma API semelhante.</span><span class="sxs-lookup"><span data-stu-id="670f9-124">OPM replaces Certified Output Protection Protcol (COPP) and uses a similar API.</span></span> <span data-ttu-id="670f9-125">Para compatibilidade com versões anteriores, a interface OPM pode emular a interface COPP.</span><span class="sxs-lookup"><span data-stu-id="670f9-125">For backward compatibility, the OPM interface can emulate the COPP interface.</span></span> <span data-ttu-id="670f9-126">As diferenças entre OPM e COPP incluem o seguinte:</span><span class="sxs-lookup"><span data-stu-id="670f9-126">Differences between OPM and COPP include the following:</span></span>

-   <span data-ttu-id="670f9-127">OPM usa certificados X. 509, enquanto COPP usa um formato de certificado proprietário.</span><span class="sxs-lookup"><span data-stu-id="670f9-127">OPM uses X.509 certificates, while COPP uses a proprietary certificate format.</span></span>
-   <span data-ttu-id="670f9-128">OPM dá suporte a repetidores de HDCP.</span><span class="sxs-lookup"><span data-stu-id="670f9-128">OPM supports HDCP repeaters.</span></span>
-   <span data-ttu-id="670f9-129">Os aplicativos que usam OPM não precisam analisar SRMs (mensagens de renovação do sistema HDCP).</span><span class="sxs-lookup"><span data-stu-id="670f9-129">Applications that use OPM do not have to parse HDCP system renewability messages (SRMs).</span></span>
-   <span data-ttu-id="670f9-130">Os OPM podem ser usados quando a exibição de gráficos estiver usando o modo de clonagem.</span><span class="sxs-lookup"><span data-stu-id="670f9-130">OPM can be used when the graphics display is using clone mode.</span></span> <span data-ttu-id="670f9-131">A COPP não oferece suporte ao modo de clonagem.</span><span class="sxs-lookup"><span data-stu-id="670f9-131">COPP does not support clone mode.</span></span>

<span data-ttu-id="670f9-132">Se seu aplicativo usar o caminho de mídia protegido (PMP) para reproduzir conteúdo de vídeo, você não precisará usar a API OPM, pois o PMP faz todas as chamadas OPM necessárias.</span><span class="sxs-lookup"><span data-stu-id="670f9-132">If your application uses the protected media path (PMP) to play video content, you do not have to use the OPM API, because the PMP makes all of the required OPM calls.</span></span> <span data-ttu-id="670f9-133">A API OPM está disponível para aplicativos que não usam o PMP.</span><span class="sxs-lookup"><span data-stu-id="670f9-133">The OPM API is available for applications that do not use the PMP.</span></span>

<span data-ttu-id="670f9-134">O OPM está disponível no Windows Vista e versões posteriores, mas a API não foi feita em público até o Windows 7.</span><span class="sxs-lookup"><span data-stu-id="670f9-134">OPM is available in Windows Vista and later, but the API was not made public until Windows 7.</span></span> <span data-ttu-id="670f9-135">Para usar o OPM em um aplicativo, você deve ter os cabeçalhos e os arquivos de biblioteca do SDK do Windows 7.</span><span class="sxs-lookup"><span data-stu-id="670f9-135">To use OPM in an application, you must have the headers and library files from the Windows 7 SDK.</span></span> <span data-ttu-id="670f9-136">Você não precisa redistribuir nenhuma dll para usar o OPM no Windows Vista ou no Windows Server 2008.</span><span class="sxs-lookup"><span data-stu-id="670f9-136">You do not have to redistribute any DLLs to use OPM in Windows Vista or Windows Server 2008.</span></span>

## <a name="video-outputs"></a><span data-ttu-id="670f9-137">Saídas de vídeo</span><span class="sxs-lookup"><span data-stu-id="670f9-137">Video Outputs</span></span>

<span data-ttu-id="670f9-138">Um adaptador gráfico pode ter mais de uma saída física, cada uma com seus próprios recursos.</span><span class="sxs-lookup"><span data-stu-id="670f9-138">A graphics adapter can have more than one physical output, each with its own capabilities.</span></span> <span data-ttu-id="670f9-139">Antes que um aplicativo Reproduza conteúdo protegido, ele deve definir os mecanismos de proteção apropriados em cada saída de vídeo associada à placa gráfica que exibirá o vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-139">Before an application plays protected content, it must set the appropriate protection mechanisms on every video output associated with the graphics card that will display the video.</span></span> <span data-ttu-id="670f9-140">Quais mecanismos de proteção serão aplicados dependerão das regras de uso do conteúdo.</span><span class="sxs-lookup"><span data-stu-id="670f9-140">Which protection mechanisms to apply will depend on the usage rules for the content.</span></span>

<span data-ttu-id="670f9-141">Cada saída de vídeo é representada por uma instância da interface [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) .</span><span class="sxs-lookup"><span data-stu-id="670f9-141">Each video output is represented by an instance of the [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) interface.</span></span> <span data-ttu-id="670f9-142">Você pode usar um dispositivo Direct3D ou identificadores de monitor para obter as saídas de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-142">You can use a Direct3D device or monitor handles to get the video outputs.</span></span>

<span data-ttu-id="670f9-143">Usando um dispositivo Direct3D:</span><span class="sxs-lookup"><span data-stu-id="670f9-143">Using a Direct3D device:</span></span>

1.  <span data-ttu-id="670f9-144">Obtenha o ponteiro **IDirect3DDevice9** para o dispositivo Direct3D que seu aplicativo usará para criar superfícies para manter os quadros de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-144">Get the **IDirect3DDevice9** pointer for the Direct3D device that your application will use to create surfaces to hold the video frames.</span></span>
2.  <span data-ttu-id="670f9-145">Chame a função [**OPMGetVideoOutputsFromIDirect3DDevice9Object**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromidirect3ddevice9object) .</span><span class="sxs-lookup"><span data-stu-id="670f9-145">Call the [**OPMGetVideoOutputsFromIDirect3DDevice9Object**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromidirect3ddevice9object) function.</span></span> <span data-ttu-id="670f9-146">Essa função aloca uma matriz de ponteiros [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) , uma para cada saída.</span><span class="sxs-lookup"><span data-stu-id="670f9-146">This function allocates an array of [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) pointers, one for each output.</span></span>

<span data-ttu-id="670f9-147">Usando identificadores de monitor:</span><span class="sxs-lookup"><span data-stu-id="670f9-147">Using monitor handles:</span></span>

1.  <span data-ttu-id="670f9-148">Chame **EnumDisplayMonitors** para obter os identificadores de **HMONITOR** que correspondem à janela de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-148">Call **EnumDisplayMonitors** to get the **HMONITOR** handles that correspond to the video window.</span></span> <span data-ttu-id="670f9-149">Vários monitores podem ser associados à mesma janela, portanto, você pode obter vários identificadores de **HMONITOR** .</span><span class="sxs-lookup"><span data-stu-id="670f9-149">Several monitors can be associated with the same window, so you might get several **HMONITOR** handles.</span></span>
2.  <span data-ttu-id="670f9-150">Para cada identificador de monitor, chame [**OPMGetVideoOutputsFromHMONITOR**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromhmonitor).</span><span class="sxs-lookup"><span data-stu-id="670f9-150">For each monitor handle, call [**OPMGetVideoOutputsFromHMONITOR**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromhmonitor).</span></span> <span data-ttu-id="670f9-151">Essa função aloca uma matriz de ponteiros [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) , uma para cada saída.</span><span class="sxs-lookup"><span data-stu-id="670f9-151">This function allocates an array of [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) pointers, one for each output.</span></span>

## <a name="initializing-an-opm-session"></a><span data-ttu-id="670f9-152">Inicializando uma sessão OPM</span><span class="sxs-lookup"><span data-stu-id="670f9-152">Initializing an OPM Session</span></span>

<span data-ttu-id="670f9-153">Antes que o aplicativo envie comandos OPM ou solicitações de status, ele deve verificar se a saída do vídeo é confiável e estabelecer uma chave de sessão.</span><span class="sxs-lookup"><span data-stu-id="670f9-153">Before the application sends OPM commands or status requests, it must verify that the video output is trusted and establish a session key.</span></span> <span data-ttu-id="670f9-154">A chave de sessão é usada para assinar os dados trocados entre o aplicativo e o driver de gráficos.</span><span class="sxs-lookup"><span data-stu-id="670f9-154">The session key is used to sign the data that is exchanged between the application and the graphics driver.</span></span>

<span data-ttu-id="670f9-155">A API OPM define um handshake que estabelece confiança e define a chave de sessão.</span><span class="sxs-lookup"><span data-stu-id="670f9-155">The OPM API defines a handshake that establishes trust and sets the session key.</span></span> <span data-ttu-id="670f9-156">Você deve executar esse handshake para cada instância da interface [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) , da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="670f9-156">You must perform this handshake for each instance of the [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) interface, as follows:</span></span>

1.  <span data-ttu-id="670f9-157">Chame [**IOPMVideoOutput:: StartInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-startinitialization).</span><span class="sxs-lookup"><span data-stu-id="670f9-157">Call [**IOPMVideoOutput::StartInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-startinitialization).</span></span> <span data-ttu-id="670f9-158">Esse método recupera duas partes de dados:</span><span class="sxs-lookup"><span data-stu-id="670f9-158">This method retrieves two pieces of data:</span></span>
    -   <span data-ttu-id="670f9-159">Um número aleatório, gerado pelo driver.</span><span class="sxs-lookup"><span data-stu-id="670f9-159">A random number, generated by the driver.</span></span> <span data-ttu-id="670f9-160">Você usará esse número para concluir o handshake.</span><span class="sxs-lookup"><span data-stu-id="670f9-160">You will use this number to complete the handshake.</span></span>
    -   <span data-ttu-id="670f9-161">A cadeia de certificados X. 509 do driver.</span><span class="sxs-lookup"><span data-stu-id="670f9-161">The driver's X.509 certificate chain.</span></span>
2.  <span data-ttu-id="670f9-162">Verifique se a cadeia de certificados foi assinada pela Microsoft.</span><span class="sxs-lookup"><span data-stu-id="670f9-162">Verify that the certificate chain has been signed by Microsoft.</span></span>
    > [!Note]  
    > <span data-ttu-id="670f9-163">A revogação de certificado está fora do escopo de OPM.</span><span class="sxs-lookup"><span data-stu-id="670f9-163">Certificate revocation is outside the scope of OPM.</span></span>

     

3.  <span data-ttu-id="670f9-164">Obtenha a chave pública do driver da cadeia de certificados.</span><span class="sxs-lookup"><span data-stu-id="670f9-164">Get the driver's public key from the certificate chain.</span></span>
4.  <span data-ttu-id="670f9-165">Gere uma chave de sessão AES de 128 bits.</span><span class="sxs-lookup"><span data-stu-id="670f9-165">Generate a 128-bit AES session key.</span></span>
5.  <span data-ttu-id="670f9-166">Gere dois números aleatórios de 32 bits:</span><span class="sxs-lookup"><span data-stu-id="670f9-166">Generate two random 32-bit numbers:</span></span>

    -   <span data-ttu-id="670f9-167">O número de sequência inicial para solicitações de status OPM.</span><span class="sxs-lookup"><span data-stu-id="670f9-167">The starting sequence number for OPM status requests.</span></span>
    -   <span data-ttu-id="670f9-168">O número de sequência inicial para comandos OPM.</span><span class="sxs-lookup"><span data-stu-id="670f9-168">The starting sequence number for OPM commands.</span></span>

    <span data-ttu-id="670f9-169">Esses números devem ser gerados usando um gerador de números pseudo aleatórios criptograficamente seguro, como **CryptGenRandom**.</span><span class="sxs-lookup"><span data-stu-id="670f9-169">These numbers must be generated using a cryptographically secure pseudo-random number generator, such as **CryptGenRandom**.</span></span>

6.  <span data-ttu-id="670f9-170">Copie o número aleatório do driver (obtido na etapa 1), a chave de sessão e os dois números de sequência em uma estrutura de [**\_ \_ \_ parâmetros de inicialização criptografada em OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) , conforme descrito em [**IOPMVideoOutput:: FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span><span class="sxs-lookup"><span data-stu-id="670f9-170">Copy the driver's random number (obtained in step 1), the session key, and the two sequence numbers into an [**OPM\_ENCRYPTED\_INITIALIZATION\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) structure, as described in [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span></span>
7.  <span data-ttu-id="670f9-171">Criptografe a estrutura de [**\_ parâmetros de \_ inicialização \_ de OPM ENCRYPTED**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) com RSAES-OAEP, usando a chave pública do driver, que é encontrada no certificado do driver.</span><span class="sxs-lookup"><span data-stu-id="670f9-171">Encrypt the [**OPM\_ENCRYPTED\_INITIALIZATION\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) structure with RSAES-OAEP, using the driver's public key, which is found in the driver's certificate.</span></span>
8.  <span data-ttu-id="670f9-172">Chame [**IOPMVideoOutput:: FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span><span class="sxs-lookup"><span data-stu-id="670f9-172">Call [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span></span>

## <a name="sending-opm-status-requests"></a><span data-ttu-id="670f9-173">Enviando solicitações de status OPM</span><span class="sxs-lookup"><span data-stu-id="670f9-173">Sending OPM Status Requests</span></span>

<span data-ttu-id="670f9-174">As solicitações de status OPM retornam informações sobre a saída de vídeo, como o tipo de conector físico e o nível de proteção atual.</span><span class="sxs-lookup"><span data-stu-id="670f9-174">OPM status requests return information about the video output, such as the type of physical connector and the current protection level.</span></span> <span data-ttu-id="670f9-175">Para obter uma lista de tipos de solicitação, consulte [solicitações de status OPM](opm-status-requests.md).</span><span class="sxs-lookup"><span data-stu-id="670f9-175">For a list of request types, see [OPM Status Requests](opm-status-requests.md).</span></span>

<span data-ttu-id="670f9-176">Para enviar uma solicitação de status, execute as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="670f9-176">To send a status request, perform the following steps.</span></span>

1.  <span data-ttu-id="670f9-177">Inicialize uma estrutura de [**\_ \_ \_ parâmetros obter informações de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) , conforme mostrado na tabela a seguir.</span><span class="sxs-lookup"><span data-stu-id="670f9-177">Initialize an [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure as shown in the following table.</span></span>

    | <span data-ttu-id="670f9-178">Membro</span><span class="sxs-lookup"><span data-stu-id="670f9-178">Member</span></span>               | <span data-ttu-id="670f9-179">DESCRIÇÃO</span><span class="sxs-lookup"><span data-stu-id="670f9-179">Description</span></span>                                                                                                                                                                                                                                                                                                                                                                 |
    |----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | <span data-ttu-id="670f9-180">**omac**</span><span class="sxs-lookup"><span data-stu-id="670f9-180">**omac**</span></span>             | <span data-ttu-id="670f9-181">Ignore este campo por enquanto.</span><span class="sxs-lookup"><span data-stu-id="670f9-181">Skip this field for now.</span></span>                                                                                                                                                                                                                                                                                                                                                    |
    | <span data-ttu-id="670f9-182">**rnRandomNumber**</span><span class="sxs-lookup"><span data-stu-id="670f9-182">**rnRandomNumber**</span></span>   | <span data-ttu-id="670f9-183">Um número aleatório de 128 bits segura criptograficamente seguro.</span><span class="sxs-lookup"><span data-stu-id="670f9-183">A cryptographically secure 128-bit random number.</span></span> <span data-ttu-id="670f9-184">Sempre que você fizer uma solicitação de status, sempre gere um novo número aleatório, mesmo se você estiver fazendo a mesma solicitação.</span><span class="sxs-lookup"><span data-stu-id="670f9-184">Whenever you make a status request, always generate a new random number, even if you are making the same request.</span></span> <span data-ttu-id="670f9-185">Armazene o número em uma variável, pois será necessário consultá-lo mais tarde.</span><span class="sxs-lookup"><span data-stu-id="670f9-185">Store the number in a variable, because you will need to refer to it later.</span></span>                                                                                                                             |
    | <span data-ttu-id="670f9-186">**guidInformation**</span><span class="sxs-lookup"><span data-stu-id="670f9-186">**guidInformation**</span></span>  | <span data-ttu-id="670f9-187">Um GUID que identifica a solicitação de status.</span><span class="sxs-lookup"><span data-stu-id="670f9-187">A GUID that identifies the status request.</span></span> <span data-ttu-id="670f9-188">Para obter uma lista de solicitações de status, consulte [solicitações de status OPM](opm-status-requests.md).</span><span class="sxs-lookup"><span data-stu-id="670f9-188">For a list of status requests, see [OPM Status Requests](opm-status-requests.md).</span></span>                                                                                                                                                                                                                                               |
    | <span data-ttu-id="670f9-189">**ulSequenceNumber**</span><span class="sxs-lookup"><span data-stu-id="670f9-189">**ulSequenceNumber**</span></span> | <span data-ttu-id="670f9-190">O número de sequência.</span><span class="sxs-lookup"><span data-stu-id="670f9-190">The sequence number.</span></span> <span data-ttu-id="670f9-191">Para a primeira solicitação de status, use o número de sequência inicial que você especificou no método [**IOPMVideoOutput:: FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) (etapa 5 da [inicialização de uma sessão OPM](#initializing-an-opm-session).) Cada vez que você fizer outra solicitação de status, aumente esse número em 1.</span><span class="sxs-lookup"><span data-stu-id="670f9-191">For the first status request, use the starting sequence number that you specified in the [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) method (step 5 of [Initializing an OPM Session](#initializing-an-opm-session).) Each time you make another status request, increment this number by 1.</span></span> |
    | <span data-ttu-id="670f9-192">**abParameters**</span><span class="sxs-lookup"><span data-stu-id="670f9-192">**abParameters**</span></span>     | <span data-ttu-id="670f9-193">Uma matriz de bytes que contém dados de entrada adicionais para a solicitação.</span><span class="sxs-lookup"><span data-stu-id="670f9-193">A byte array that contains additional input data for the request.</span></span> <span data-ttu-id="670f9-194">O formato dos dados de entrada é listado no tópico de referência para cada solicitação de status.</span><span class="sxs-lookup"><span data-stu-id="670f9-194">The format of the input data is listed in the reference topic for each status request.</span></span>                                                                                                                                                                                                                    |
    | <span data-ttu-id="670f9-195">**cbParametersSize**</span><span class="sxs-lookup"><span data-stu-id="670f9-195">**cbParametersSize**</span></span> | <span data-ttu-id="670f9-196">O tamanho dos dados válidos na matriz **abParameters** .</span><span class="sxs-lookup"><span data-stu-id="670f9-196">The size of the valid data in the **abParameters** array.</span></span> <span data-ttu-id="670f9-197">O conteúdo do restante da matriz é indefinido.</span><span class="sxs-lookup"><span data-stu-id="670f9-197">The contents of the rest of the array are undefined.</span></span>                                                                                                                                                                                                                                                              |

    

     

2.  <span data-ttu-id="670f9-198">Calcule o OMAC-1 do CBC de chave para calcular um hash para o bloco de dados que aparece após o membro **OMAC** e, em seguida, defina o membro **OMAC** com esse valor.</span><span class="sxs-lookup"><span data-stu-id="670f9-198">Calculate the one-key CBC MAC (OMAC-1) to calculate a hash for the block of data that appears after the **omac** member, and then set the **omac** member to this value.</span></span> <span data-ttu-id="670f9-199">Consulte [código de exemplo OPM](opm-example-code.md).</span><span class="sxs-lookup"><span data-stu-id="670f9-199">See [OPM Example Code](opm-example-code.md).</span></span>
3.  <span data-ttu-id="670f9-200">Chame o método [**IOPMVideoOutput:: GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) .</span><span class="sxs-lookup"><span data-stu-id="670f9-200">Call the [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method.</span></span> <span data-ttu-id="670f9-201">Passe um ponteiro para a estrutura [**de \_ \_ \_ parâmetros Get Info de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) e um ponteiro para uma estrutura de [**\_ \_ informações solicitada em OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) .</span><span class="sxs-lookup"><span data-stu-id="670f9-201">Pass in a pointer to the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure and a pointer to an [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure.</span></span> <span data-ttu-id="670f9-202">A resposta do driver é gravada na estrutura de **\_ \_ informações de OPM solicitado** .</span><span class="sxs-lookup"><span data-stu-id="670f9-202">The driver's response is written to the **OPM\_REQUESTED\_INFORMATION** structure.</span></span>
    -   <span data-ttu-id="670f9-203">O membro **OMAC** dessa estrutura contém um OMAC computado para os dados que seguem esse membro.</span><span class="sxs-lookup"><span data-stu-id="670f9-203">The **omac** member of this structure contains an OMAC computed for the data that follows this member.</span></span>
    -   <span data-ttu-id="670f9-204">O membro **abRequestedInformation** é uma matriz de bytes que contém os dados de saída para a resposta.</span><span class="sxs-lookup"><span data-stu-id="670f9-204">The **abRequestedInformation** member is a byte array that contains output data for the response.</span></span> <span data-ttu-id="670f9-205">O formato dos dados de saída é listado no tópico de referência para cada solicitação de status.</span><span class="sxs-lookup"><span data-stu-id="670f9-205">The format of the output data is listed in the reference topic for each status request.</span></span>
4.  <span data-ttu-id="670f9-206">Calcule um OMAC para a estrutura de [**\_ \_ informações de OPM solicitado**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) , não incluindo o membro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="670f9-206">Calculate an OMAC for the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure, not including the **omac** member.</span></span> <span data-ttu-id="670f9-207">Verifique se OMAC corresponde ao valor no membro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="670f9-207">Verify that the OMAC matches the value in the **omac** member.</span></span>
5.  <span data-ttu-id="670f9-208">Verifique se o membro **cbRequestedInformationSize** da estrutura [**de \_ \_ informações requeridas de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) fornece o tamanho correto para os dados de saída.</span><span class="sxs-lookup"><span data-stu-id="670f9-208">Make sure the **cbRequestedInformationSize** member of the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure gives the correct size for the output data.</span></span> <span data-ttu-id="670f9-209">Por exemplo, os dados de saída para a consulta de [**tipo de conector do OPM \_ \_ \_ Get**](opm-get-connector-type.md) são uma estrutura de [**\_ \_ informações padrão OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) , portanto, o valor de **cbRequestedInformationSize** deve ser `sizeof(OPM_STANDARD_INFORMATION)` .</span><span class="sxs-lookup"><span data-stu-id="670f9-209">For example, the output data for the [**OPM\_GET\_CONNECTOR\_TYPE**](opm-get-connector-type.md) query is an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure, so the value of **cbRequestedInformationSize** should be `sizeof(OPM_STANDARD_INFORMATION)`.</span></span>
6.  <span data-ttu-id="670f9-210">Converta o membro **abRequestedInformation** da estrutura de [**informações de OPM \_ solicitada \_**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) na estrutura de dados de saída correta.</span><span class="sxs-lookup"><span data-stu-id="670f9-210">Cast the **abRequestedInformation** member of the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure to the correct output data structure.</span></span> <span data-ttu-id="670f9-211">Por exemplo, se a solicitação de status [**for \_ \_ \_ tipo de conector de obtenção de OPM**](opm-get-connector-type.md), converta **abRequestedInformation** em uma estrutura de [**\_ \_ informações padrão OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="670f9-211">For example, if the status request is [**OPM\_GET\_CONNECTOR\_TYPE**](opm-get-connector-type.md), cast **abRequestedInformation** to an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span>
7.  <span data-ttu-id="670f9-212">Verifique se o membro **rnRandomNumber** da estrutura de dados de saída corresponde ao valor de **rnRandomNumber** da etapa 1.</span><span class="sxs-lookup"><span data-stu-id="670f9-212">Make sure the **rnRandomNumber** member of the output data structure matches the value of **rnRandomNumber** from step 1.</span></span>
8.  <span data-ttu-id="670f9-213">Verifique o membro **ulStatusFlags** da estrutura de dados de saída, conforme descrito em [lidando com uma saída de vídeo desabilitada](#handling-a-disabled-video-output).</span><span class="sxs-lookup"><span data-stu-id="670f9-213">Check the **ulStatusFlags** member of the output data structure, as described in [Handling a Disabled Video Output](#handling-a-disabled-video-output).</span></span>

<span data-ttu-id="670f9-214">Se qualquer uma das verificações nas etapas 5 a 8 falhar, o aplicativo deverá parar de mostrar o conteúdo protegido.</span><span class="sxs-lookup"><span data-stu-id="670f9-214">If any of the checks in steps 5–8 fails, the application must stop showing protected content.</span></span>

## <a name="sending-opm-commands"></a><span data-ttu-id="670f9-215">Enviando comandos OPM</span><span class="sxs-lookup"><span data-stu-id="670f9-215">Sending OPM Commands</span></span>

<span data-ttu-id="670f9-216">Os comandos OPM são usados para definir o nível de proteção e outras configurações na saída de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-216">OPM commands are used to set the protection level and other settings on the video output.</span></span> <span data-ttu-id="670f9-217">O envio de um comando OPM é semelhante ao envio de uma solicitação de status, exceto que não há dados de resposta do driver.</span><span class="sxs-lookup"><span data-stu-id="670f9-217">Sending an OPM command is similar to sending a status request, except there is no response data from the driver.</span></span> <span data-ttu-id="670f9-218">Para obter uma lista de comandos, consulte [comandos OPM](opm-commands.md).</span><span class="sxs-lookup"><span data-stu-id="670f9-218">For a list of commands, see [OPM Commands](opm-commands.md).</span></span>

<span data-ttu-id="670f9-219">Para enviar um comando OPM, execute as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="670f9-219">To send an OPM command, perform the following steps.</span></span>

1.  <span data-ttu-id="670f9-220">Preencha uma estrutura [**de \_ configuração de \_ parâmetros de OPM**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) , conforme mostrado na tabela a seguir.</span><span class="sxs-lookup"><span data-stu-id="670f9-220">Fill in an [**OPM\_CONFIGURE\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) structure as shown in the following table.</span></span>

    | <span data-ttu-id="670f9-221">Membro</span><span class="sxs-lookup"><span data-stu-id="670f9-221">Member</span></span>                | <span data-ttu-id="670f9-222">DESCRIÇÃO</span><span class="sxs-lookup"><span data-stu-id="670f9-222">Description</span></span>                                                                                                                                                                                                                                                                                                                                                   |
    |-----------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | <span data-ttu-id="670f9-223">**omac**</span><span class="sxs-lookup"><span data-stu-id="670f9-223">**omac**</span></span>              | <span data-ttu-id="670f9-224">Ignore este campo por enquanto.</span><span class="sxs-lookup"><span data-stu-id="670f9-224">Skip this field for now.</span></span>                                                                                                                                                                                                                                                                                                                                      |
    | <span data-ttu-id="670f9-225">**guidSetting**</span><span class="sxs-lookup"><span data-stu-id="670f9-225">**guidSetting**</span></span>       | <span data-ttu-id="670f9-226">Um GUID que identifica o comando.</span><span class="sxs-lookup"><span data-stu-id="670f9-226">A GUID that identifies the command.</span></span> <span data-ttu-id="670f9-227">Para obter uma lista de comandos, consulte [comandos OPM](opm-commands.md).</span><span class="sxs-lookup"><span data-stu-id="670f9-227">For a list of commands, see [OPM Commands](opm-commands.md).</span></span>                                                                                                                                                                                                                                                             |
    | <span data-ttu-id="670f9-228">**ulSequenceNumber**</span><span class="sxs-lookup"><span data-stu-id="670f9-228">**ulSequenceNumber**</span></span>  | <span data-ttu-id="670f9-229">O número de sequência.</span><span class="sxs-lookup"><span data-stu-id="670f9-229">The sequence number.</span></span> <span data-ttu-id="670f9-230">Para o primeiro comando, use o número de sequência inicial que você especificou no método [**IOPMVideoOutput:: FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) (etapa 5 de [inicialização de uma sessão OPM](#initializing-an-opm-session).) Cada vez que você enviar outro comando, aumente esse número em 1.</span><span class="sxs-lookup"><span data-stu-id="670f9-230">For the first command, use the starting sequence number that you specified in the [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) method (step 5 of [Initializing an OPM Session](#initializing-an-opm-session).) Each time you send another command, increment this number by 1.</span></span> |
    | <span data-ttu-id="670f9-231">**abParameters**</span><span class="sxs-lookup"><span data-stu-id="670f9-231">**abParameters**</span></span>      | <span data-ttu-id="670f9-232">Uma matriz de bytes que contém dados de entrada adicionais para o comando.</span><span class="sxs-lookup"><span data-stu-id="670f9-232">A byte array that contains additional input data for the command.</span></span> <span data-ttu-id="670f9-233">O formato dos dados de entrada é listado no tópico de referência para cada comando.</span><span class="sxs-lookup"><span data-stu-id="670f9-233">The format of the input data is listed in the reference topic for each command.</span></span>                                                                                                                                                                                                             |
    | <span data-ttu-id="670f9-234">**cbSettingDataSize**</span><span class="sxs-lookup"><span data-stu-id="670f9-234">**cbSettingDataSize**</span></span> | <span data-ttu-id="670f9-235">O tamanho dos dados válidos na matriz **abParameters** .</span><span class="sxs-lookup"><span data-stu-id="670f9-235">The size of the valid data in the **abParameters** array.</span></span> <span data-ttu-id="670f9-236">O conteúdo do restante da matriz é indefinido.</span><span class="sxs-lookup"><span data-stu-id="670f9-236">The contents of the rest of the array are undefined.</span></span>                                                                                                                                                                                                                                                |

    

     

2.  <span data-ttu-id="670f9-237">Calcule um OMAC para o bloco de dados que aparece após o membro **OMAC** e, em seguida, defina o membro **OMAC** como esse valor.</span><span class="sxs-lookup"><span data-stu-id="670f9-237">Calculate an OMAC for the block of data that appears after the **omac** member, and then set the **omac** member to this value.</span></span>
3.  <span data-ttu-id="670f9-238">Chame [**IOPMVideoOutput:: Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure).</span><span class="sxs-lookup"><span data-stu-id="670f9-238">Call [**IOPMVideoOutput::Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure).</span></span>

<span data-ttu-id="670f9-239">Para a maioria dos comandos, há uma solicitação de status correspondente que retorna o status do comando.</span><span class="sxs-lookup"><span data-stu-id="670f9-239">For most commands, there is a corresponding status request that returns the status of the command.</span></span> <span data-ttu-id="670f9-240">Por exemplo, o comando de [**\_ Configurar \_ \_ nível de proteção OPM**](opm-set-protection-level.md) define o nível de proteção e o comando [**OPM \_ obter \_ \_ \_ nível de proteção virtual**](opm-get-virtual-protection-level.md) Obtém o nível de proteção atual.</span><span class="sxs-lookup"><span data-stu-id="670f9-240">For example, the [**OPM\_SET\_PROTECTION\_LEVEL**](opm-set-protection-level.md) command sets the protection level, and the [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) command gets the current protection level.</span></span>

## <a name="handling-a-disabled-video-output"></a><span data-ttu-id="670f9-241">Manipulando uma saída de vídeo desabilitada</span><span class="sxs-lookup"><span data-stu-id="670f9-241">Handling a Disabled Video Output</span></span>

<span data-ttu-id="670f9-242">Uma saída de vídeo pode ser desativada a qualquer momento para evitar o uso não autorizado de conteúdo de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-242">A video output might disable itself at any time to prevent the unauthorized use of video content.</span></span> <span data-ttu-id="670f9-243">Isso pode ocorrer porque um mecanismo de proteção para de funcionar, pois o driver detecta violação ou porque a tela foi desconectada do conector físico.</span><span class="sxs-lookup"><span data-stu-id="670f9-243">This might occur because a protection mechanism stops working, because the driver detects tampering, or because the display was disconnected from the physical connector.</span></span> <span data-ttu-id="670f9-244">Enquanto uma saída de vídeo está desabilitada, nenhum quadro de vídeo é exibido.</span><span class="sxs-lookup"><span data-stu-id="670f9-244">While a video output is disabled, no video frames are displayed.</span></span>

<span data-ttu-id="670f9-245">Enquanto a proteção de conteúdo está habilitada, um aplicativo deve periodicamente (pelo menos uma vez a cada 2 segundos) para executar as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="670f9-245">While content protection is enabled, an application should periodically (at least once every 2 seconds) perform the following steps.</span></span>

1.  <span data-ttu-id="670f9-246">Chame [**IOPMVideoOutput:: GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) para enviar a solicitação de status do [**OPM \_ obter \_ \_ \_ nível de proteção real**](opm-get-actual-protection-level.md) ou [**OPM \_ obter \_ \_ \_ nível de proteção virtual**](opm-get-virtual-protection-level.md) .</span><span class="sxs-lookup"><span data-stu-id="670f9-246">Call [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) to send either the [**OPM\_GET\_ACTUAL\_PROTECTION\_LEVEL**](opm-get-actual-protection-level.md) or [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) status request.</span></span> <span data-ttu-id="670f9-247">Os dados de retorno de ambos os comandos são uma estrutura de [**\_ \_ informações de OPM padrão**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="670f9-247">The return data for both commands is an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span>
2.  <span data-ttu-id="670f9-248">Verifique o membro **ulInformation** da estrutura [**de \_ \_ informações padrão OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="670f9-248">Check the **ulInformation** member of the [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="670f9-249">Esse membro contém um sinalizador que indica se a proteção de conteúdo ainda está habilitada.</span><span class="sxs-lookup"><span data-stu-id="670f9-249">This member contains a flag indicating whether content protection is still enabled.</span></span> <span data-ttu-id="670f9-250">Se a proteção de conteúdo estiver desativada, pare de executar o vídeo imediatamente.</span><span class="sxs-lookup"><span data-stu-id="670f9-250">If content protection is off, stop playing the video immediately.</span></span>
3.  <span data-ttu-id="670f9-251">Se a proteção de conteúdo estiver ativada, verifique o membro **ulStatusFlags** da estrutura de [**\_ \_ informações padrão OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="670f9-251">If content protection is on, check the **ulStatusFlags** member of the [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="670f9-252">Se nenhum sinalizador for definido, a saída de vídeo estará funcionando corretamente.</span><span class="sxs-lookup"><span data-stu-id="670f9-252">If no flags are set, the video output is working correctly.</span></span> <span data-ttu-id="670f9-253">Caso contrário, a saída de vídeo será desabilitada.</span><span class="sxs-lookup"><span data-stu-id="670f9-253">Otherwise, the video output is disabled.</span></span>

<span data-ttu-id="670f9-254">Os sinalizadores a seguir são definidos para **ulStatusFlags**.</span><span class="sxs-lookup"><span data-stu-id="670f9-254">The following flags are defined for **ulStatusFlags**.</span></span>



<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th><span data-ttu-id="670f9-255">Sinalizador</span><span class="sxs-lookup"><span data-stu-id="670f9-255">Flag</span></span></th>
<th><span data-ttu-id="670f9-256">Descrição</span><span class="sxs-lookup"><span data-stu-id="670f9-256">Description</span></span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span data-ttu-id="670f9-257"><strong>OPM_STATUS_LINK_LOST</strong></span><span class="sxs-lookup"><span data-stu-id="670f9-257"><strong>OPM_STATUS_LINK_LOST</strong></span></span></td>
<td><span data-ttu-id="670f9-258">A proteção de saída parou de funcionar por algum motivo; por exemplo, o dispositivo de vídeo pode ser desconectado do conntector.</span><span class="sxs-lookup"><span data-stu-id="670f9-258">Output protection stopped working for some reason; for example, the display device might be unplugged from the conntector.</span></span> <span data-ttu-id="670f9-259">Pare a reprodução e desative todos os mecanismos de proteção de saída.</span><span class="sxs-lookup"><span data-stu-id="670f9-259">Stop playback and turn off all output protection mechanisms.</span></span></td>
</tr>
<tr class="even">
<td><span data-ttu-id="670f9-260"><strong>OPM_STATUS_RENEGOTIATION_REQUIRED</strong></span><span class="sxs-lookup"><span data-stu-id="670f9-260"><strong>OPM_STATUS_RENEGOTIATION_REQUIRED</strong></span></span></td>
<td><span data-ttu-id="670f9-261">O aplicativo deve restabelecer a sessão OPM.</span><span class="sxs-lookup"><span data-stu-id="670f9-261">The application must reestablish the OPM session.</span></span> <span data-ttu-id="670f9-262">Responda da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="670f9-262">Respond as follows:</span></span>
<ol>
<li><span data-ttu-id="670f9-263">Pare a reprodução.</span><span class="sxs-lookup"><span data-stu-id="670f9-263">Stop playback.</span></span></li>
<li><span data-ttu-id="670f9-264">Desative todos os mecanismos de proteção.</span><span class="sxs-lookup"><span data-stu-id="670f9-264">Turn off all protection mechanisms.</span></span></li>
<li><span data-ttu-id="670f9-265">Libere a interface <a href="/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput"><strong>IOPMVideoOutput</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="670f9-265">Release the <a href="/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput"><strong>IOPMVideoOutput</strong></a> interface.</span></span></li>
<li><span data-ttu-id="670f9-266">Recrie todas as superfícies de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-266">Recreate all video surfaces.</span></span></li>
<li><span data-ttu-id="670f9-267">Crie um novo objeto OPM e tente restabelecer a proteção de conteúdo.</span><span class="sxs-lookup"><span data-stu-id="670f9-267">Create a new OPM object and attempt to reestablish content protection.</span></span> <span data-ttu-id="670f9-268">Se isso falhar, exiba uma mensagem de erro para o usuário.</span><span class="sxs-lookup"><span data-stu-id="670f9-268">If this fails, display an error message to the user.</span></span> <span data-ttu-id="670f9-269">Não reproduza mais conteúdo de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-269">Do not play any more video content.</span></span></li>
</ol></td>
</tr>
<tr class="odd">
<td><span data-ttu-id="670f9-270"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span><span class="sxs-lookup"><span data-stu-id="670f9-270"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span></span></td>
<td><span data-ttu-id="670f9-271">Esse sinalizador se aplica somente quando HDCP é usado e indica a presença de um dispositivo HDCP revogado.</span><span class="sxs-lookup"><span data-stu-id="670f9-271">This flag applies only when HDCP is used, and indicates the presence of a revoked HDCP device.</span></span> <span data-ttu-id="670f9-272">Pare a reprodução e desative todos os mecanismos de proteção nesta saída de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-272">Stop playback and turn off all protection mechanisms on this video output.</span></span> <span data-ttu-id="670f9-273">Quando esse sinalizador é definido, o sinalizador de <strong>OPM_STATUS_LINK_LOST</strong> também é definido.</span><span class="sxs-lookup"><span data-stu-id="670f9-273">When this flag is set, the <strong>OPM_STATUS_LINK_LOST</strong> flag is also set.</span></span></td>
</tr>
<tr class="even">
<td><span data-ttu-id="670f9-274"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span><span class="sxs-lookup"><span data-stu-id="670f9-274"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span></span></td>
<td><span data-ttu-id="670f9-275">O driver detectou violação.</span><span class="sxs-lookup"><span data-stu-id="670f9-275">The driver has detected tampering.</span></span> <span data-ttu-id="670f9-276">Pare a reprodução e não reproduza mais vídeo usando esta saída de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-276">Stop playback, and do not play any more video using this video output.</span></span> <span data-ttu-id="670f9-277">Também é uma boa ideia parar de usar qualquer outra saída de vídeo, pois o sistema pode estar comprometido.</span><span class="sxs-lookup"><span data-stu-id="670f9-277">It is also a good idea to stop using any other video outputs, because the system might be compromised.</span></span></td>
</tr>
</tbody>
</table>



 

## <a name="using-hdcp-to-protect-content"></a><span data-ttu-id="670f9-278">Usando o HDCP para proteger o conteúdo</span><span class="sxs-lookup"><span data-stu-id="670f9-278">Using HDCP to Protect Content</span></span>

<span data-ttu-id="670f9-279">Esta seção descreve como habilitar a proteção de saída de HDCP usando OPM.</span><span class="sxs-lookup"><span data-stu-id="670f9-279">This section describes how to enable HDCP output protection using OPM.</span></span> <span data-ttu-id="670f9-280">Aqui está uma descrição geral das etapas que o aplicativo deve executar.</span><span class="sxs-lookup"><span data-stu-id="670f9-280">Here is a general outline of the steps the application must take.</span></span> <span data-ttu-id="670f9-281">Os detalhes são fornecidos posteriormente nesta seção.</span><span class="sxs-lookup"><span data-stu-id="670f9-281">Details are given later in this section.</span></span>

1.  <span data-ttu-id="670f9-282">O aplicativo pode precisar fornecer um SRM para a saída de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-282">The application might have to provide an SRM to the video output.</span></span> <span data-ttu-id="670f9-283">O mecanismo para o recebimento de SRMs está fora do escopo da interface OPM.</span><span class="sxs-lookup"><span data-stu-id="670f9-283">The mechanism for receiving SRMs is outside the scope of the OPM interface.</span></span> <span data-ttu-id="670f9-284">Por exemplo, SRMs pode ser entregue como parte de um fluxo de difusão.</span><span class="sxs-lookup"><span data-stu-id="670f9-284">For example, SRMs might be delivered as part of a broadcast stream.</span></span>
2.  <span data-ttu-id="670f9-285">O aplicativo habilita a proteção de saída de HDCP.</span><span class="sxs-lookup"><span data-stu-id="670f9-285">The application enables HDCP output protection.</span></span>
3.  <span data-ttu-id="670f9-286">O aplicativo reproduz o conteúdo do vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-286">The application plays the video content.</span></span> <span data-ttu-id="670f9-287">Periodicamente, o aplicativo sonda o driver para verificar se o HDCP está ativado.</span><span class="sxs-lookup"><span data-stu-id="670f9-287">Periodically, the application polls the driver to make sure HDCP is on.</span></span>
4.  <span data-ttu-id="670f9-288">Quando a reprodução é concluída, o aplicativo desativa HDCP.</span><span class="sxs-lookup"><span data-stu-id="670f9-288">When playback is complete, the application turns off HDCP.</span></span>

### <a name="setting-the-srm"></a><span data-ttu-id="670f9-289">Configurando o SRM</span><span class="sxs-lookup"><span data-stu-id="670f9-289">Setting the SRM</span></span>

<span data-ttu-id="670f9-290">Para definir o SRM, execute as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="670f9-290">To set the SRM, perform the following steps.</span></span>

1.  <span data-ttu-id="670f9-291">Inicialize uma estrutura de [**\_ parâmetros de \_ \_ SRM \_ de HDCP definido de OPM**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) com o número de versão do SRM.</span><span class="sxs-lookup"><span data-stu-id="670f9-291">Initialize an [**OPM\_SET\_HDCP\_SRM\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) structure with the SRM version number.</span></span>
2.  <span data-ttu-id="670f9-292">Armazene o SRM em uma variável.</span><span class="sxs-lookup"><span data-stu-id="670f9-292">Store the SRM in a variable.</span></span>
3.  <span data-ttu-id="670f9-293">Envie um comando [**OPM \_ set \_ HDCP \_ SRM**](opm-set-hdcp-srm.md) para a saída de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-293">Send an [**OPM\_SET\_HDCP\_SRM**](opm-set-hdcp-srm.md) command to the video output.</span></span> <span data-ttu-id="670f9-294">Use o procedimento descrito em [enviando comandos OPM](#sending-opm-commands).</span><span class="sxs-lookup"><span data-stu-id="670f9-294">Use the procedure described in [Sending OPM Commands](#sending-opm-commands).</span></span>
    -   <span data-ttu-id="670f9-295">O membro **abParameters** da estrutura [**de \_ Configurar \_ parâmetros de OPM**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) contém a estrutura de [**\_ \_ \_ \_ parâmetros de SRM de HDCP definido**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) .</span><span class="sxs-lookup"><span data-stu-id="670f9-295">The **abParameters** member of the [**OPM\_CONFIGURE\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) structure contains the [**OPM\_SET\_HDCP\_SRM\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) structure.</span></span>
    -   <span data-ttu-id="670f9-296">O parâmetro *pbAdditionalParameters* do método [**IOPMVideoOutput:: Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure) aponta para a variável que contém o SRM.</span><span class="sxs-lookup"><span data-stu-id="670f9-296">The *pbAdditionalParameters* parameter of the [**IOPMVideoOutput::Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure) method points to the variable that contains the SRM.</span></span>
4.  <span data-ttu-id="670f9-297">Envie um OPM para obter a solicitação de status de [**\_ versão de \_ \_ \_ SRM \_ de HDCP atual**](opm-get-current-hdcp-srm-version.md) para a saída de vídeo.</span><span class="sxs-lookup"><span data-stu-id="670f9-297">Send an [**OPM\_GET\_CURRENT\_HDCP\_SRM\_VERSION**](opm-get-current-hdcp-srm-version.md) status request to the video output.</span></span> <span data-ttu-id="670f9-298">Use o procedimento descrito em [enviando solicitações de status OPM](#sending-opm-status-requests).</span><span class="sxs-lookup"><span data-stu-id="670f9-298">Use the procedure described in [Sending OPM Status Requests](#sending-opm-status-requests).</span></span> <span data-ttu-id="670f9-299">Essa solicitação de status não tem dados de entrada, portanto, o conteúdo do membro **abParameters** da estrutura de [**\_ \_ \_ parâmetros Get Info de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) não está definido.</span><span class="sxs-lookup"><span data-stu-id="670f9-299">This status request has no input data, so the contents of the **abParameters** member of the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure are undefined.</span></span>
5.  <span data-ttu-id="670f9-300">Quando o método [**IOPMVideoOutput:: GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) retorna, a matriz **abRequestedInformation** na estrutura [**de \_ \_ informações de OPM solicitado**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) contém uma estrutura de [**\_ \_ informações padrão OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="670f9-300">When the [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method returns, the **abRequestedInformation** array in the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure contains an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="670f9-301">O membro **ulInformation** dessa estrutura contém o número de versão do SRM atual.</span><span class="sxs-lookup"><span data-stu-id="670f9-301">The **ulInformation** member of this structure contains the version number of the current SRM.</span></span> <span data-ttu-id="670f9-302">Esse valor deve ser igual ao valor da etapa 2.</span><span class="sxs-lookup"><span data-stu-id="670f9-302">This value must equal the value from step 2.</span></span>

### <a name="enabling-hdcp"></a><span data-ttu-id="670f9-303">Habilitando HDCP</span><span class="sxs-lookup"><span data-stu-id="670f9-303">Enabling HDCP</span></span>

<span data-ttu-id="670f9-304">Para habilitar o HDCP, execute as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="670f9-304">To enable HDCP, perform the following steps.</span></span>

1.  <span data-ttu-id="670f9-305">Inicialize uma estrutura de [**parâmetros de nível de proteção dos OPMS \_ definidos \_ \_ \_**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) com os seguintes valores:</span><span class="sxs-lookup"><span data-stu-id="670f9-305">Initialize an [**OPM\_SET\_PROTECTION\_LEVEL\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) structure with the following values:</span></span>
    -   <span data-ttu-id="670f9-306">**ulProtectionType**  =  **OPM \_ tipo de proteção de \_ \_ HDCP**</span><span class="sxs-lookup"><span data-stu-id="670f9-306">**ulProtectionType** = **OPM\_PROTECTION\_TYPE\_HDCP**</span></span>
    -   <span data-ttu-id="670f9-307">**ulProtectionLevel**  =  **OPM \_ HDCP \_ ativado**</span><span class="sxs-lookup"><span data-stu-id="670f9-307">**ulProtectionLevel** = **OPM\_HDCP\_ON**</span></span>
    -   <span data-ttu-id="670f9-308">**Reservado** = 0</span><span class="sxs-lookup"><span data-stu-id="670f9-308">**Reserved** = 0</span></span>
    -   <span data-ttu-id="670f9-309">**Reserved2** = 0</span><span class="sxs-lookup"><span data-stu-id="670f9-309">**Reserved2** = 0</span></span>
2.  <span data-ttu-id="670f9-310">Envie um [**comando \_ OPM \_ definir \_ nível de proteção**](opm-set-protection-level.md) .</span><span class="sxs-lookup"><span data-stu-id="670f9-310">Send an [**OPM\_SET\_PROTECTION\_LEVEL**](opm-set-protection-level.md) command.</span></span> <span data-ttu-id="670f9-311">Os dados de entrada na matriz **abParameters** são a estrutura de parâmetros de [**nível de proteção de OPM \_ definido \_ \_ \_**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) .</span><span class="sxs-lookup"><span data-stu-id="670f9-311">The input data in the **abParameters** array is the [**OPM\_SET\_PROTECTION\_LEVEL\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) structure.</span></span>
3.  <span data-ttu-id="670f9-312">Envie uma solicitação de status de erro de [**\_ \_ \_ \_ nível de proteção virtual OPM**](opm-get-virtual-protection-level.md) para verificar se o HDCP está habilitado.</span><span class="sxs-lookup"><span data-stu-id="670f9-312">Send an [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) status request to check whether HDCP is enabled.</span></span> <span data-ttu-id="670f9-313">Os quatro primeiros bytes do membro **abParameters** da estrutura de [**\_ parâmetros get \_ info \_ de OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) contêm o valor de **\_ proteção OPM \_ tipo \_ HDCP**.</span><span class="sxs-lookup"><span data-stu-id="670f9-313">The first 4 bytes of the **abParameters** member of the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure contain the value **OPM\_PROTECTION\_TYPE\_HDCP**.</span></span>

<span data-ttu-id="670f9-314">Quando o método [**GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) retorna, a matriz **abRequestedInformation** na estrutura [**de \_ \_ informações de OPM solicitado**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) contém uma estrutura de [**\_ \_ informações padrão OPM**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="670f9-314">When the [**GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method returns, the **abRequestedInformation** array in the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure contains an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="670f9-315">O membro **ulInformation** dessa estrutura contém um valor da enumeração de [**\_ \_ \_ nível de proteção de HDCP de OPM**](/windows/desktop/api/opmapi/ne-opmapi-opm_hdcp_protection_level) .</span><span class="sxs-lookup"><span data-stu-id="670f9-315">The **ulInformation** member of this structure contains a value from the [**OPM\_HDCP\_PROTECTION\_LEVEL**](/windows/desktop/api/opmapi/ne-opmapi-opm_hdcp_protection_level) enumeration.</span></span> <span data-ttu-id="670f9-316">Se o valor for igual a **OPM \_ HDCP \_ em**, significa que HDCP está habilitado.</span><span class="sxs-lookup"><span data-stu-id="670f9-316">If the value equals **OPM\_HDCP\_ON**, it means HDCP is enabled.</span></span> <span data-ttu-id="670f9-317">Caso contrário, repita as etapas 1 a 2 até que a HDCP esteja habilitada ou um erro ocorra.</span><span class="sxs-lookup"><span data-stu-id="670f9-317">Otherwise, repeat steps 1–2 until HDCP is enabled, or an error occurs.</span></span> <span data-ttu-id="670f9-318">(Lembre-se de incrementar o número de sequência e gerar um novo número aleatório a cada vez.)</span><span class="sxs-lookup"><span data-stu-id="670f9-318">(Remember to increment the sequence number and generate a new random number each time.)</span></span>

<span data-ttu-id="670f9-319">Geralmente leva entre 100 e 200 milissegundos para habilitar a HDCP, mas pode levar mais tempo.</span><span class="sxs-lookup"><span data-stu-id="670f9-319">It usually takes between 100 and 200 milliseconds to enable HDCP, but it can take longer.</span></span> <span data-ttu-id="670f9-320">Não presuma que o HDCP esteja habilitado até que você o tenha verificado.</span><span class="sxs-lookup"><span data-stu-id="670f9-320">Do not assume that HDCP is enabled until you have verified it.</span></span>

<span data-ttu-id="670f9-321">Quando o aplicativo terminar de reproduzir o conteúdo protegido, desative o HDCP.</span><span class="sxs-lookup"><span data-stu-id="670f9-321">When the application finishes playing protected content, turn off HDCP.</span></span> <span data-ttu-id="670f9-322">As etapas são as mesmas para habilitar a HDCP, mas na etapa 1, defina **ulProtectionLevel** como **OPM de \_ HDCP \_ desativado**.</span><span class="sxs-lookup"><span data-stu-id="670f9-322">The steps are the same as for enabling HDCP, but in step 1, set **ulProtectionLevel** to **OPM\_HDCP\_OFF**.</span></span>

> [!Note]  
> <span data-ttu-id="670f9-323">Não habilite HDCP se o tipo de conector for um **\_ tipo de conector OPM \_ \_ DisplayPort \_ incorporado**.</span><span class="sxs-lookup"><span data-stu-id="670f9-323">Do not enable HDCP if the connector type is **OPM\_CONNECTOR\_TYPE\_DISPLAYPORT\_EMBEDDED**.</span></span> <span data-ttu-id="670f9-324">(Consulte [**sinalizadores de tipo de conector OPM**](opm-connector-type-flags.md).)</span><span class="sxs-lookup"><span data-stu-id="670f9-324">(See [**OPM Connector Type Flags**](opm-connector-type-flags.md).)</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="670f9-325">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="670f9-325">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="670f9-326">Gerenciador de proteção de saída</span><span class="sxs-lookup"><span data-stu-id="670f9-326">Output Protection Manager</span></span>](output-protection-manager.md)
</dt> </dl>

 

 



