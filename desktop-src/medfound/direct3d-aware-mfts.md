---
description: Este tópico descreve como implementar uma transformação de Media Foundation com reconhecimento de Direct3D (MFT) para vídeo.
ms.assetid: 8ec7e678-8477-41fa-9726-54df5ed187cd
title: Direct3D-Aware MFTs
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ad50438250c0ee1627cc20aebb49262ec8eec9ac
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104501177"
---
# <a name="direct3d-aware-mfts"></a><span data-ttu-id="2c5bc-103">Direct3D-Aware MFTs</span><span class="sxs-lookup"><span data-stu-id="2c5bc-103">Direct3D-Aware MFTs</span></span>

<span data-ttu-id="2c5bc-104">Este tópico descreve como implementar uma transformação de Media Foundation *com reconhecimento de Direct3D* (MFT) para vídeo.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-104">This topic describes how to implement a *Direct3D-aware* Media Foundation transform (MFT) for video.</span></span>

<span data-ttu-id="2c5bc-105">Um MFT de vídeo é considerado *com reconhecimento de Direct3D* se ele puder processar exemplos que contenham superfícies de Direct3D.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-105">An video MFT is considered *Direct3D-aware* if it can process samples that contain Direct3D surfaces.</span></span> <span data-ttu-id="2c5bc-106">O motivo típico para dar suporte ao Direct3D em um MFT de vídeo é habilitar a decodificação acelerada por hardware, usando a DXVA (aceleração de vídeo do DirectX).</span><span class="sxs-lookup"><span data-stu-id="2c5bc-106">The typical reason for supporting Direct3D in a video MFT is to enable hardware-accelerated decoding, using DirectX Video Acceleration (DXVA).</span></span>

<span data-ttu-id="2c5bc-107">Este tópico descreve as etapas necessárias para tornar o seu MFT com reconhecimento de Direct3D.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-107">This topic describes the steps that are required to make your MFT Direct3D-aware.</span></span> <span data-ttu-id="2c5bc-108">Este tópico não aborda a mecânica da decodificação de DXVA.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-108">This topic does not cover the mechanics of DXVA decoding.</span></span> <span data-ttu-id="2c5bc-109">Para obter informações sobre o DXVA, consulte [aceleração de vídeo do DirectX 2,0](directx-video-acceleration-2-0.md).</span><span class="sxs-lookup"><span data-stu-id="2c5bc-109">For information about DXVA, see [DirectX Video Acceleration 2.0](directx-video-acceleration-2-0.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="2c5bc-110">A partir do Windows 8, o [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) pode ser usado em vez do [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9).</span><span class="sxs-lookup"><span data-stu-id="2c5bc-110">Beginning in Windows 8, [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) can be used instead of the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9).</span></span> <span data-ttu-id="2c5bc-111">Para aplicativos da Windows Store, você deve usar o **IMFDXGIDeviceManager** e o Microsoft Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-111">For Windows Store apps, you must use **IMFDXGIDeviceManager** and Microsoft Direct3D 11.</span></span> <span data-ttu-id="2c5bc-112">Para obter mais informações, consulte as [APIs de vídeo do Direct3D 11](direct3d-11-video-apis.md).</span><span class="sxs-lookup"><span data-stu-id="2c5bc-112">For more info, see the [Direct3D 11 Video APIs](direct3d-11-video-apis.md).</span></span>

 

1.  <span data-ttu-id="2c5bc-113">Implemente o método [**IMFTransform:: GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) .</span><span class="sxs-lookup"><span data-stu-id="2c5bc-113">Implement the [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) method.</span></span> <span data-ttu-id="2c5bc-114">Esse método retorna um ponteiro para um repositório de atributos.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-114">This method returns a pointer to an attribute store.</span></span>
2.  <span data-ttu-id="2c5bc-115">O MFT deve definir o valor do atributo [**de \_ \_ \_ reconhecimento de D3D da SA MF**](mf-sa-d3d-aware-attribute.md) como **true** em seu próprio repositório de atributos.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-115">The MFT must set the value of the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) attribute to **TRUE** on its own attribute store.</span></span> <span data-ttu-id="2c5bc-116">A partir do Windows 8, se usar o Direct3D 11, use o [D3D11 do MF \_ SA com \_ \_ reconhecimento](mf-sa-d3d11-aware.md).</span><span class="sxs-lookup"><span data-stu-id="2c5bc-116">Beginning in Windows 8, if using Direct3D 11 use [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md).</span></span>
3.  <span data-ttu-id="2c5bc-117">Durante a negociação de formato, se o atributo de [**\_ \_ \_ reconhecimento de D3D Sa**](mf-sa-d3d-aware-attribute.md) (ou [MF \_ SA \_ D3D11 \_ ciente](mf-sa-d3d11-aware.md) se estiver usando o Direct3D 11) for **verdadeiro**, o cliente poderá enviar a mensagem do Gerenciador de D3D para o conjunto de mensagens do MFT para o MFT. [**\_ \_ \_ \_**](mft-message-set-d3d-manager.md)</span><span class="sxs-lookup"><span data-stu-id="2c5bc-117">During format negotiation, if the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) (or [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md) if using Direct3D 11) attribute is **TRUE**, the client may send the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message to the MFT.</span></span> <span data-ttu-id="2c5bc-118">O parâmetro de evento *ulParam* é um ponteiro para a interface [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="2c5bc-118">The *ulParam* event parameter is a pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="2c5bc-119">A partir do Windows 8, você pode usar [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) em vez de **IDirect3DDeviceManager9**.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-119">Beginning in Windows 8, you can use [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) instead of **IDirect3DDeviceManager9**.</span></span> <span data-ttu-id="2c5bc-120">O cliente não é necessário para enviar esta mensagem.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-120">The client is not required to send this message.</span></span>
4.  <span data-ttu-id="2c5bc-121">O MFT chama [**IDirect3DDeviceManager9:: GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) para consultar o serviço DXVA necessário.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-121">The MFT calls [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) to query for the DXVA service it needs.</span></span> <span data-ttu-id="2c5bc-122">A partir do Windows 8, se [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) foi usado, o MFT chama [**IMFDXGIDeviceManager:: GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span><span class="sxs-lookup"><span data-stu-id="2c5bc-122">Beginning in Windows 8, if [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) was used the MFT calls [**IMFDXGIDeviceManager::GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span></span> <span data-ttu-id="2c5bc-123">Normalmente, um decodificador consultaria [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice), e um processador de vídeo consultaria [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span><span class="sxs-lookup"><span data-stu-id="2c5bc-123">Typically a decoder would query for [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice), and a video processor would query for [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span></span>
5.  <span data-ttu-id="2c5bc-124">Supondo que a etapa anterior seja bem-sucedida, os métodos [**IMFTransform:: GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) e [**IMFTransform:: GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) devem retornar formatos compatíveis com DXVA.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-124">Assuming the previous step is successful, the [**IMFTransform::GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) and [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) methods must return DXVA-compatible formats.</span></span>
6.  <span data-ttu-id="2c5bc-125">O cliente configura os tipos de mídia no MFT.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-125">The client configures the media types on the MFT.</span></span> <span data-ttu-id="2c5bc-126">Se um tipo de mídia não for compatível com o DXVA, o MFT deverá retornar o código de erro **MF \_ E o \_ \_ \_ tipo de D3D sem suporte**.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-126">If a media type is not compatible with DXVA, the MFT must return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE**.</span></span>
7.  <span data-ttu-id="2c5bc-127">Neste ponto, há duas opções, dependendo se o cliente encontra um formato de DXVA adequado.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-127">At this point, there are two options, depending on whether the client finds a suitable DXVA format.</span></span>
    -   <span data-ttu-id="2c5bc-128">Se o cliente configurar com êxito um formato DXVA, ele poderá começar a ser processado.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-128">If the client successfully configures a DXVA format, it may begin processing.</span></span> <span data-ttu-id="2c5bc-129">Neste ponto, o MFT pode usar o DXVA para processamento ou fazer fallback para o processamento de software.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-129">At this point, the MFT can use DXVA for processing, or fall back to software processing.</span></span>
    -   <span data-ttu-id="2c5bc-130">Como alternativa, se o cliente não encontrar um formato de DXVA aceitável, o cliente poderá enviar outra mensagem de [**MFT do \_ \_ \_ \_ Gerenciador de D3D**](mft-message-set-d3d-manager.md) , desta vez definindo *ulParam* como **NULL**.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-130">Alternatively, if the client does not find an acceptable DXVA format, the client may send another [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message, this time setting *ulParam* to **NULL**.</span></span> <span data-ttu-id="2c5bc-131">O MFT deve liberar o ponteiro [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) (o ponteiro [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) , se **IMFDXGIDeviceManager** foi usado) e quaisquer outras interfaces de DXVA, e reverter para o processamento de software.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-131">The MFT must release the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) pointer (the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) pointer, if **IMFDXGIDeviceManager** was used) and any other DXVA interfaces, and revert to software processing.</span></span> <span data-ttu-id="2c5bc-132">Neste ponto, o MFT não deve usar o processamento de DXVA.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-132">At this point, the MFT must not use DXVA processing.</span></span>

<span data-ttu-id="2c5bc-133">Um MFT com reconhecimento de Direct3D deve estar preparado para manipular exemplos que contêm uma superfície do Direct3D.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-133">A Direct3D-aware MFT must be prepared to handle samples that contain a Direct3D surface.</span></span> <span data-ttu-id="2c5bc-134">O exemplo conterá exatamente um buffer de mídia.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-134">The sample will contain exactly one media buffer.</span></span> <span data-ttu-id="2c5bc-135">Para obter a superfície do Direct3D do buffer, chame a função [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) e especifique o serviço do **\_ \_ serviço de buffer do Mr** .</span><span class="sxs-lookup"><span data-stu-id="2c5bc-135">To get the Direct3D surface from the buffer, call the [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) function and specify the **MR\_BUFFER\_SERVICE** service.</span></span> <span data-ttu-id="2c5bc-136">Para obter mais informações, consulte [buffer de superfície DirectX](directx-surface-buffer.md).</span><span class="sxs-lookup"><span data-stu-id="2c5bc-136">For more information, see [DirectX Surface Buffer](directx-surface-buffer.md).</span></span>

<span data-ttu-id="2c5bc-137">Uma MFT que usa o DXVA deve alocar seus próprios exemplos de saída, da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="2c5bc-137">An MFT that uses DXVA must allocate its own output samples, as follows:</span></span>

1.  <span data-ttu-id="2c5bc-138">No método [**IMFTransform:: GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) , defina o **fluxo de saída do MFT fornece um sinalizador de \_ \_ \_ \_ exemplos** .</span><span class="sxs-lookup"><span data-stu-id="2c5bc-138">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag.</span></span>
2.  <span data-ttu-id="2c5bc-139">Crie um pool de superfícies de DXVA, conforme descrito na especificação DXVA.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-139">Create a pool of DXVA surfaces, as described in the DXVA specification.</span></span>
3.  <span data-ttu-id="2c5bc-140">Crie amostras de mídia chamando [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span><span class="sxs-lookup"><span data-stu-id="2c5bc-140">Create media samples by calling [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span></span>

<span data-ttu-id="2c5bc-141">O MFT deve sempre dar suporte ao processamento de software como um fallback, porque o processamento de DXVA pode não estar disponível, por vários motivos:</span><span class="sxs-lookup"><span data-stu-id="2c5bc-141">The MFT should always support software processing as a fallback, because DXVA processing might not available, for several reasons:</span></span>

-   <span data-ttu-id="2c5bc-142">A GPU pode não dar suporte a DXVA.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-142">The GPU might not support DXVA.</span></span>
-   <span data-ttu-id="2c5bc-143">O cliente não pode usar o Direct3D.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-143">The client might not use Direct3D.</span></span>
-   <span data-ttu-id="2c5bc-144">Os perfis de DXVA não estão definidos para cada formato de vídeo.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-144">DXVA profiles are not defined for every video format.</span></span>

<span data-ttu-id="2c5bc-145">Um MFT com reconhecimento de Direct3D deve ter um único fluxo de saída.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-145">A Direct3D-aware MFT must have a single output stream.</span></span> <span data-ttu-id="2c5bc-146">Ele não pode ter várias saídas.</span><span class="sxs-lookup"><span data-stu-id="2c5bc-146">It cannot have multiple outputs.</span></span>

## <a name="related-topics"></a><span data-ttu-id="2c5bc-147">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="2c5bc-147">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="2c5bc-148">Gravando uma MFT personalizada</span><span class="sxs-lookup"><span data-stu-id="2c5bc-148">Writing a Custom MFT</span></span>](writing-a-custom-mft.md)
</dt> </dl>

 

 



