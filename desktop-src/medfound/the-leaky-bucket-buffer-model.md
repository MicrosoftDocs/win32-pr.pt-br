---
description: A &\# 0034; o Bucket de vazamento&\# 0034; o modelo é uma maneira de modelar os requisitos de buffer para uma reprodução suave.
ms.assetid: 2f7f80d6-3abb-462f-a571-b223a1d59da6
title: O modelo de buffer de buckets vazados (Microsoft Media Foundation)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0f5a99932fb121808f6a49323360c47c09d0acbb
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/05/2021
ms.locfileid: "105761582"
---
# <a name="the-leaky-bucket-buffer-model-microsoft-media-foundation"></a><span data-ttu-id="59566-103">O modelo de buffer de buckets vazados (Microsoft Media Foundation)</span><span class="sxs-lookup"><span data-stu-id="59566-103">The Leaky Bucket Buffer Model (Microsoft Media Foundation)</span></span>

<span data-ttu-id="59566-104">Quando você transmite mídia em uma rede, o decodificador recebe dados codificados em uma taxa teoricamente constante (a taxa de transmissão).</span><span class="sxs-lookup"><span data-stu-id="59566-104">When you stream media over a network, the decoder receives encoded data at a theoretically constant rate (the transmission rate).</span></span> <span data-ttu-id="59566-105">O decodificador consome esses dados para produzir saída decodificada.</span><span class="sxs-lookup"><span data-stu-id="59566-105">The decoder consumes this data to produce decoded output.</span></span> <span data-ttu-id="59566-106">No entanto, no caso geral, o decodificador consome os dados em uma taxa *variável* , porque o codificador pode usar uma taxa de codificação variável.</span><span class="sxs-lookup"><span data-stu-id="59566-106">In the general case, however, the decoder consumes the data at a *variable* rate, because then encoder can use a variable encoding rate.</span></span>

<span data-ttu-id="59566-107">O modelo "Bucket de vazamentos" é uma maneira de modelar os requisitos de buffer para uma reprodução suave.</span><span class="sxs-lookup"><span data-stu-id="59566-107">The "leaky bucket" model is a way to model the buffering requirements for smooth playback.</span></span> <span data-ttu-id="59566-108">Nesse modelo, o decodificador mantém um buffer.</span><span class="sxs-lookup"><span data-stu-id="59566-108">In this model, the decoder maintains a buffer.</span></span> <span data-ttu-id="59566-109">Os dados codificados vão da rede para o buffer e do buffer para o decodificador.</span><span class="sxs-lookup"><span data-stu-id="59566-109">Encoded data goes from the network into the buffer, and from the buffer into the decoder.</span></span> <span data-ttu-id="59566-110">Se o buffer fluir, isso significará que o decodificador está removendo dados do buffer mais rápido do que a rede que o está entregando.</span><span class="sxs-lookup"><span data-stu-id="59566-110">If the buffer underflows, it means the decoder is removing data from the buffer faster than the network is delivering it.</span></span> <span data-ttu-id="59566-111">Se o buffer estourar, isso significa que a rede está entregando dados mais rápido do que o decodificador.</span><span class="sxs-lookup"><span data-stu-id="59566-111">If the buffer overflows, it means the network is delivering data faster than the decoder consumes it.</span></span>

<span data-ttu-id="59566-112">Este tópico descreve o modelo de "Bucket de vazamentos" de buffers para codificação e decodificação.</span><span class="sxs-lookup"><span data-stu-id="59566-112">This topic describes the "leaky bucket" model of buffers for encoding and decoding.</span></span>

-   [<span data-ttu-id="59566-113">O Bucket de vazamentos</span><span class="sxs-lookup"><span data-stu-id="59566-113">The Leaky Bucket</span></span>](#the-leaky-bucket)
-   [<span data-ttu-id="59566-114">O Bucket em uso</span><span class="sxs-lookup"><span data-stu-id="59566-114">The Bucket in Use</span></span>](#the-bucket-in-use)
-   [<span data-ttu-id="59566-115">Definindo valores de Bucket vazado para fluxos ASF</span><span class="sxs-lookup"><span data-stu-id="59566-115">Setting Leaky Bucket Values for ASF Streams</span></span>](#setting-leaky-bucket-values-for-asf-streams)
-   [<span data-ttu-id="59566-116">Valores de buckets vazados no Multiplexador de ASF</span><span class="sxs-lookup"><span data-stu-id="59566-116">Leaky Bucket Values in the ASF Multiplexer</span></span>](#leaky-bucket-values-in-the-asf-multiplexer)
-   [<span data-ttu-id="59566-117">Atualizando valores de buckets vazados no coletor de mídia ASF</span><span class="sxs-lookup"><span data-stu-id="59566-117">Updating Leaky Bucket Values in the ASF Media Sink</span></span>](#updating-leaky-bucket-values-in-the-asf-media-sink)
-   [<span data-ttu-id="59566-118">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="59566-118">Related topics</span></span>](#related-topics)

## <a name="the-leaky-bucket"></a><span data-ttu-id="59566-119">O Bucket de vazamentos</span><span class="sxs-lookup"><span data-stu-id="59566-119">The Leaky Bucket</span></span>

<span data-ttu-id="59566-120">Para entender o modelo de Bucket vazado, considere um Bucket com um pequeno orifício na parte inferior.</span><span class="sxs-lookup"><span data-stu-id="59566-120">To understand the leaky bucket model, consider a bucket with a small hole at the bottom.</span></span> <span data-ttu-id="59566-121">Três parâmetros definem o Bucket:</span><span class="sxs-lookup"><span data-stu-id="59566-121">Three parameters define the bucket:</span></span>

-   <span data-ttu-id="59566-122">A capacidade (B)</span><span class="sxs-lookup"><span data-stu-id="59566-122">The capacity (B)</span></span>
-   <span data-ttu-id="59566-123">A taxa na qual a água flui para fora do Bucket (R)</span><span class="sxs-lookup"><span data-stu-id="59566-123">The rate at which water flows out of the bucket (R)</span></span>
-   <span data-ttu-id="59566-124">A totalidade inicial do Bucket (F)</span><span class="sxs-lookup"><span data-stu-id="59566-124">The initial fullness of the bucket (F)</span></span>

<span data-ttu-id="59566-125">Nessa metáfora, o Bucket é o buffer:</span><span class="sxs-lookup"><span data-stu-id="59566-125">In this metaphor, the bucket is the buffer:</span></span>

![ilustração mostrando um buffer como um Bucket, taxa de entrada como água entrando no Bucket e a taxa de saída como água saindo por meio de um orifício no Bucket](images/asf-components03.png)

<span data-ttu-id="59566-127">Se a água for desapareceda no Bucket com a taxa exata de *R*, o Bucket permanecerá em F, porque a taxa de entrada é igual à taxa de saída.</span><span class="sxs-lookup"><span data-stu-id="59566-127">If water is poured into the bucket at exactly rate *R*, the bucket will remain at F, because the input rate equals the output rate.</span></span> <span data-ttu-id="59566-128">Se a taxa de entrada aumentar enquanto *R* permanecer constante, o Bucket acumulará água.</span><span class="sxs-lookup"><span data-stu-id="59566-128">If the input rate increases while *R* remains constant, the bucket accumulates water.</span></span> <span data-ttu-id="59566-129">Se a taxa de entrada for maior que *R* por um período sustentado, eventualmente, o Bucket estourará.</span><span class="sxs-lookup"><span data-stu-id="59566-129">If the input rate is larger than *R* for a sustained period, eventually the bucket overflows.</span></span> <span data-ttu-id="59566-130">No entanto, a taxa de entrada pode variar em relação ao *R* sem estourar o Bucket, desde que a taxa de entrada média não exceda a capacidade do Bucket.</span><span class="sxs-lookup"><span data-stu-id="59566-130">However, the input rate can vary around *R* without overflowing the bucket, as long as the average input rate does not exceed the capacity of the bucket.</span></span> <span data-ttu-id="59566-131">Quanto maior a capacidade, mais a taxa de entrada pode variar dentro de um determinado período de tempo.</span><span class="sxs-lookup"><span data-stu-id="59566-131">The larger the capacity, the more the input rate can vary within a given window of time.</span></span>

<span data-ttu-id="59566-132">No ASF, o Bucket de vazamento é definido por três parâmetros:</span><span class="sxs-lookup"><span data-stu-id="59566-132">In ASF, the leaky bucket is defined by three parameters:</span></span>

-   <span data-ttu-id="59566-133">A taxa média de bits, em bytes por segundo, que corresponde à taxa de saída (*R*)</span><span class="sxs-lookup"><span data-stu-id="59566-133">The average bit rate, in bytes per second, which corresponds to the output rate (*R*)</span></span>
-   <span data-ttu-id="59566-134">A janela de buffer, medida em milissegundos, que corresponde à capacidade do Bucket (*B*).</span><span class="sxs-lookup"><span data-stu-id="59566-134">The buffer window, measured in milliseconds, which corresponds to the bucket capacity (*B*).</span></span>
-   <span data-ttu-id="59566-135">A totalidade do buffer inicial, que geralmente é definida como zero.</span><span class="sxs-lookup"><span data-stu-id="59566-135">The initial buffer fullness, which is generally set to zero.</span></span>

<span data-ttu-id="59566-136">A taxa de bits mede o número médio de bits por segundo no fluxo codificado.</span><span class="sxs-lookup"><span data-stu-id="59566-136">The bit rate measures the average number of bits per second in the encoded stream.</span></span> <span data-ttu-id="59566-137">A janela buffer mede o número de milissegundos de dados nessa taxa de bits que podem caber no buffer.</span><span class="sxs-lookup"><span data-stu-id="59566-137">The buffer window measures the number of milliseconds of data at that bit rate that can fit in the buffer.</span></span> <span data-ttu-id="59566-138">O tamanho do buffer em bits é igual a R \* (B/1000).</span><span class="sxs-lookup"><span data-stu-id="59566-138">The size of the buffer in bits is equal to R \* (B / 1000).</span></span>

<span data-ttu-id="59566-139">Os dados de carga ASF podem inserir o Bucket de vazamento em horários irregulares e em quantidades irregulares, mas devem deixar o Bucket com uma taxa de bits positiva constante.</span><span class="sxs-lookup"><span data-stu-id="59566-139">ASF payload data may enter the leaky bucket at irregular times and in irregular amounts, but must leave the bucket at a constant positive bit rate.</span></span> <span data-ttu-id="59566-140">Devido à janela de buffer, há um possível atraso entre a hora em que a carga entra no Bucket e quando ela sai.</span><span class="sxs-lookup"><span data-stu-id="59566-140">Because of the buffer window, there is a possible delay between the time that payload enters the bucket and when it leaves.</span></span> <span data-ttu-id="59566-141">O atraso máximo que pode ocorrer é *B* / *R*.</span><span class="sxs-lookup"><span data-stu-id="59566-141">The maximum delay that can occur is *B*/*R*.</span></span> <span data-ttu-id="59566-142">Os dados de carga que entram no Bucket são de acordo com a hora da apresentação e nunca devem exceder o Bucket.</span><span class="sxs-lookup"><span data-stu-id="59566-142">The payload data that enters into the bucket is according to the presentation time and must never overflow the bucket.</span></span> <span data-ttu-id="59566-143">Além do tempo de apresentação, cada carga também tem um tempo de envio — a hora em que os dados de carga deixam o Bucket de acordo com a taxa de bits.</span><span class="sxs-lookup"><span data-stu-id="59566-143">In addition to the presentation time, each payload also has a send time—the time at which the payload data leaves the bucket according to the bit rate.</span></span> <span data-ttu-id="59566-144">A hora de envio deve ser anterior ao tempo de apresentação para garantir que, quando o Bucket de vazamentos ficar perto de estar cheio, cada carga deixará o Bucket antes ou em seu horário de apresentação.</span><span class="sxs-lookup"><span data-stu-id="59566-144">Send time must be earlier than the presentation time to ensure that, when the leaky bucket gets close to being full, every payload leaves the bucket before or at its presentation time.</span></span> <span data-ttu-id="59566-145">Para fazer isso, os tempos de apresentação são deslocados para frente pelo valor de *B* / *R* (o *rolo*) e os tempos de envio têm um início inicial a partir de zero.</span><span class="sxs-lookup"><span data-stu-id="59566-145">To accomplish this, the presentation times are shifted ahead by the *B*/*R* value (the *preroll*), and the send times get a head start starting at zero.</span></span> <span data-ttu-id="59566-146">A hora de envio não deve ser posterior à hora da apresentação, pois isso indicaria que a carga inseriu o Bucket muito tarde e não pode ser incluída no objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="59566-146">The send time must be no later than the presentation time because that would indicate that the payload entered the bucket too late and cannot be included in the data object.</span></span> <span data-ttu-id="59566-147">O valor de preroll está incluído no [objeto de cabeçalho ASF](asf-file-structure.md) .</span><span class="sxs-lookup"><span data-stu-id="59566-147">The preroll value is included in the [ASF Header Object](asf-file-structure.md) .</span></span>

<span data-ttu-id="59566-148">Para o streaming sem problemas na rede, fluxos compactados dentro do conteúdo de mídia devem manter uma taxa de bits constante durante a duração da reprodução.</span><span class="sxs-lookup"><span data-stu-id="59566-148">For glitch-free streaming over the network, compressed streams within the media content must maintain a constant bit rate throughout the playback duration.</span></span> <span data-ttu-id="59566-149">O modelo de Bucket vazado do ASF garante que os dados de mídia sejam enviados pela rede a uma taxa de bits constante.</span><span class="sxs-lookup"><span data-stu-id="59566-149">The ASF leaky bucket model ensures that media data is sent across the network at a constant bit rate.</span></span> <span data-ttu-id="59566-150">Os parâmetros do Bucket de vazamento são especificados no objeto de propriedades de fluxo estendido do [objeto de cabeçalho ASF](asf-file-structure.md).</span><span class="sxs-lookup"><span data-stu-id="59566-150">The parameters of the leaky bucket are specified in the Extended Stream Properties Object of the [ASF Header Object](asf-file-structure.md).</span></span> <span data-ttu-id="59566-151">No Microsoft Media Foundation, eles são definidos como atributos no tipo de mídia que representa o fluxo.</span><span class="sxs-lookup"><span data-stu-id="59566-151">In Microsoft Media Foundation, they are set as attributes on the media type that represents the stream.</span></span>

<span data-ttu-id="59566-152">Os valores de Bucket de vazamento são definidos no coletor de arquivos ASF e no objeto multiplexador ASF subjacente e no codificador de mídia do Windows.</span><span class="sxs-lookup"><span data-stu-id="59566-152">The leaky bucket values are defined both in the ASF file sink and the underlying ASF multiplexer object, and the Windows Media encoder.</span></span> <span data-ttu-id="59566-153">Esses valores podem ser iguais ou diferentes.</span><span class="sxs-lookup"><span data-stu-id="59566-153">These values could be same or different.</span></span> <span data-ttu-id="59566-154">Por exemplo, considere um cenário de streaming, que exige que os exemplos de áudio sejam entregues mais tarde do que os exemplos de vídeo para que o arquivo possa ser transmitido sem latência.</span><span class="sxs-lookup"><span data-stu-id="59566-154">For example, consider a streaming scenario, which requires the audio samples to be delivered later than the video samples so that the file can be streamed without latency.</span></span> <span data-ttu-id="59566-155">Para conseguir isso, o Bucket de vazamentos do fluxo de áudio no coletor de mídia pode ser definido como um valor maior do que o valor definido no codificador de áudio do Windows Media.</span><span class="sxs-lookup"><span data-stu-id="59566-155">To achieve this, the audio stream's leaky bucket in the media sink can be set to a value higher than the value set in the Windows Media audio encoder.</span></span>

<span data-ttu-id="59566-156">Para definir valores de B/R no codificador, o aplicativo deve definir as propriedades [**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md), [**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md), [**MFPKEY \_ RMAX**](mfpkey-rmaxproperty.md)e [**MFPKEY \_ BMAX**](mfpkey-bmaxproperty.md) .</span><span class="sxs-lookup"><span data-stu-id="59566-156">To set B/R values in the encoder, the application must set the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties.</span></span> <span data-ttu-id="59566-157">Para obter informações sobre como definir propriedades no codificador, consulte [Propriedades de codificação](configuring-the-encoder.md).</span><span class="sxs-lookup"><span data-stu-id="59566-157">For information about setting properties in the encoder, see [Encoding Properties](configuring-the-encoder.md).</span></span>

## <a name="the-bucket-in-use"></a><span data-ttu-id="59566-158">O Bucket em uso</span><span class="sxs-lookup"><span data-stu-id="59566-158">The Bucket in Use</span></span>

<span data-ttu-id="59566-159">O objetivo de um codificador é garantir que o conteúdo nunca flua o buffer.</span><span class="sxs-lookup"><span data-stu-id="59566-159">The goal of an encoder is to ensure that the content never overflows the buffer.</span></span> <span data-ttu-id="59566-160">O codificador usa os valores de taxa de bits e de janela de buffer como guias.</span><span class="sxs-lookup"><span data-stu-id="59566-160">The encoder uses the bit rate and buffer window values as guides.</span></span> <span data-ttu-id="59566-161">O número real de bits transmitidos em qualquer período de tempo igual à janela de buffer nunca pode ser maior do que o dobro do tamanho do buffer.</span><span class="sxs-lookup"><span data-stu-id="59566-161">The actual number of bits passed over any period of time equal to the buffer window can never be greater than twice the size of the buffer.</span></span>

<span data-ttu-id="59566-162">Considere o exemplo a seguir: você tem um Bucket de 3 litros com um orifício nele por meio do qual um litro pode fluir por minuto.</span><span class="sxs-lookup"><span data-stu-id="59566-162">Consider the following example: You have a 3-gallon bucket with a hole in it through which 1 gallon can flow per minute.</span></span> <span data-ttu-id="59566-163">Você coloca o Bucket sob uma bolsa e abre a válvula para deixar a água a uma taxa de 1 litro por minuto.</span><span class="sxs-lookup"><span data-stu-id="59566-163">You put the bucket under a spigot and open the valve to let out water at a rate of 1 gallon per minute.</span></span> <span data-ttu-id="59566-164">A água flui para fora do Bucket tão rapidamente quanto ele entra, não deixando nenhum extra no Bucket.</span><span class="sxs-lookup"><span data-stu-id="59566-164">The water flows out of the bucket as quickly as it enters, leaving no extra in the bucket.</span></span> <span data-ttu-id="59566-165">Em seguida, você aumenta o fluxo da bolsa para 2 galões por minuto.</span><span class="sxs-lookup"><span data-stu-id="59566-165">Then you increase the flow from the spigot to 2 gallons per minute.</span></span> <span data-ttu-id="59566-166">A cada minuto que a água flui nessa taxa, 2 galões entram no Bucket e um vazamento de 1 litro, deixando 1 litro no Bucket.</span><span class="sxs-lookup"><span data-stu-id="59566-166">Each minute that the water flows at this rate, 2 gallons go into the bucket and 1 gallon leaks out, leaving 1 gallon in the bucket.</span></span> <span data-ttu-id="59566-167">No final de 3 minutos, 6 galões de água ficaram para o Bucket, 3 galões vazaram e o Bucket está cheio.</span><span class="sxs-lookup"><span data-stu-id="59566-167">At the end of 3 minutes, 6 gallons of water have gone into the bucket, 3 gallons have leaked out, and the bucket is full.</span></span>

<span data-ttu-id="59566-168">Na prática, a taxa de dados máxima teórica em um intervalo igual à janela de buffer nunca é obtida.</span><span class="sxs-lookup"><span data-stu-id="59566-168">In practice, the theoretical maximum data rate over an interval equal to the buffer window is never achieved.</span></span> <span data-ttu-id="59566-169">O exemplo anterior assumiu uma taxa de dados constante.</span><span class="sxs-lookup"><span data-stu-id="59566-169">The previous example assumed a constant data rate.</span></span> <span data-ttu-id="59566-170">Considerando o mesmo Bucket de 3 litros, você poderia aumentar a taxa de fluxo da bolsa para 6 galões por minuto por um minuto e, em seguida, desligar a bolsa por dois minutos.</span><span class="sxs-lookup"><span data-stu-id="59566-170">Given the same 3-gallon bucket, you could increase the flow rate from the spigot to 6 gallons per minute for one minute and then turn the spigot off for two minutes.</span></span> <span data-ttu-id="59566-171">Embora a quantidade total de água colocada no Bucket esteja dentro do máximo teórico da janela de buffer, a concentração dessa quantidade em uma parte da janela faz com que o Bucket ultrapasse o estouro.</span><span class="sxs-lookup"><span data-stu-id="59566-171">Even though the total amount of water put into the bucket is within the theoretical maximum for the buffer window, the concentration of that amount into one part of the window causes the bucket to overflow.</span></span> <span data-ttu-id="59566-172">A 6 galões por minuto, os estouros de buckets de 3 litros logo após 30 segundos são aprovados.</span><span class="sxs-lookup"><span data-stu-id="59566-172">At 6 gallons per minute, the 3-gallon bucket overflows shortly after 30 seconds pass.</span></span> <span data-ttu-id="59566-173">Portanto, a quantidade máxima real de dados que podem ser entregues ao buffer durante a duração de qualquer intervalo igual à configuração da janela de buffer depende do tamanho de exemplos individuais e quando eles são entregues.</span><span class="sxs-lookup"><span data-stu-id="59566-173">Therefore, the actual maximum amount of data that can be delivered to the buffer over the duration of any interval equal to the buffer window setting depends upon the size of individual samples and when they are delivered.</span></span>

<span data-ttu-id="59566-174">Até agora, os exemplos só discutiam o buffer usado pelo decodificador, mas um buffer de buckets vazados também é usado pelo codificador que cria o conteúdo compactado.</span><span class="sxs-lookup"><span data-stu-id="59566-174">So far the examples have only discussed the buffer used by the decoder, but a leaky bucket buffer is also used by the encoder which creates the compressed content.</span></span> <span data-ttu-id="59566-175">O codificador faz quaisquer ajustes necessários aos algoritmos de compactação para manter a taxa de bits das amostras compactadas dentro dos limites descritos pela janela taxa de bits e buffer, supondo que os exemplos serão entregues ao decodificador a uma taxa constante.</span><span class="sxs-lookup"><span data-stu-id="59566-175">The encoder makes whatever adjustments are necessary to the compression algorithms to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window, assuming that the samples will be delivered to the decoder at a constant rate.</span></span> <span data-ttu-id="59566-176">Você pode considerar o Bucket do codificador como espelhamento do Bucket do decodificador.</span><span class="sxs-lookup"><span data-stu-id="59566-176">You can think of the encoder bucket as mirroring the decoder bucket.</span></span> <span data-ttu-id="59566-177">O Bucket do codificador é preenchido com uma taxa variável determinada pelo tamanho dos exemplos individuais e vazamentos a uma taxa constante igual à taxa média de bits.</span><span class="sxs-lookup"><span data-stu-id="59566-177">The encoder bucket is filled at a variable rate determined by the size of the individual samples and leaks at a constant rate equal to the average bit rate.</span></span>

<span data-ttu-id="59566-178">Considere o exemplo a seguir de um codificador e um decodificador conectado em uma rede.</span><span class="sxs-lookup"><span data-stu-id="59566-178">Consider the following example of an encoder and decoder connected together over a network.</span></span> <span data-ttu-id="59566-179">Você codifica um arquivo de vídeo em 30 quadros por segundo com uma taxa de bits de 6.000 bits por segundo e uma janela de buffer de 3 segundos (um tamanho total de buffer de 18.000 bits).</span><span class="sxs-lookup"><span data-stu-id="59566-179">You encode a video file at 30 frames per second with a bit rate of 6,000 bits per second and a buffer window of 3 seconds (a total buffer size of 18,000 bits).</span></span> <span data-ttu-id="59566-180">O primeiro exemplo é codificado como um quadro-chave e ocupa 7.000 bits.</span><span class="sxs-lookup"><span data-stu-id="59566-180">The first sample is encoded as a key frame and takes up 7,000 bits.</span></span> <span data-ttu-id="59566-181">O buffer do codificador agora contém 7.000 bits.</span><span class="sxs-lookup"><span data-stu-id="59566-181">The encoder buffer now contains 7,000 bits.</span></span> <span data-ttu-id="59566-182">Os próximos 29 quadros são todos os quadros Delta que totalizam 3.000 bits.</span><span class="sxs-lookup"><span data-stu-id="59566-182">The next 29 frames are all delta frames that total 3,000 bits.</span></span> <span data-ttu-id="59566-183">Portanto, o primeiro segundo de conteúdo (30 quadros) colocaria a totalidade do buffer em 10.000 bits se nada estivesse vazando. Sabemos que a taxa de bits do fluxo é de 6.000 bits por segundo, portanto, depois que o primeiro segundo de conteúdo codificado é colocado no buffer do codificador, a totalidade cai para 4.000 bits.</span><span class="sxs-lookup"><span data-stu-id="59566-183">So the first second of content (30 frames) would put the buffer fullness at 10,000 bits if nothing were leaking out. We know that the bit rate of the stream is 6,000 bits per second, so after the first second of encoded content is put in the encoder buffer, the fullness drops to 4,000 bits.</span></span> <span data-ttu-id="59566-184">No aplicativo de decodificação, esse fluxo é entregue ao buffer do decodificador em 6.000 bits por segundo.</span><span class="sxs-lookup"><span data-stu-id="59566-184">In the decoding application, this stream is delivered to the decoder buffer at 6,000 bits per second.</span></span> <span data-ttu-id="59566-185">Depois de um segundo, o buffer contém 6.000 bits.</span><span class="sxs-lookup"><span data-stu-id="59566-185">After one second, the buffer contains 6,000 bits.</span></span> <span data-ttu-id="59566-186">O primeiro exemplo contém 7.000 bits, portanto, o buffer do decodificador deve ser preenchido mais antes que o decodificador comece a remover amostras.</span><span class="sxs-lookup"><span data-stu-id="59566-186">The first sample contains 7,000 bits, so the decoder buffer must be filled more before the decoder begins removing samples.</span></span>

## <a name="setting-leaky-bucket-values-for-asf-streams"></a><span data-ttu-id="59566-187">Definindo valores de Bucket vazado para fluxos ASF</span><span class="sxs-lookup"><span data-stu-id="59566-187">Setting Leaky Bucket Values for ASF Streams</span></span>

<span data-ttu-id="59566-188">Em um cenário de codificação de arquivo, um aplicativo pode definir os valores de Bucket de vazamentos ao configurar os fluxos no [perfil ASF](asf-profile.md).</span><span class="sxs-lookup"><span data-stu-id="59566-188">In a file-encoding scenario, an application can set the leaky bucket values while configuring the streams in the [ASF Profile](asf-profile.md).</span></span>

<span data-ttu-id="59566-189">Depois de criar o fluxo e ter uma referência à interface [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) do fluxo, você pode definir os valores usando os seguintes atributos:</span><span class="sxs-lookup"><span data-stu-id="59566-189">After you have created the stream and have a reference to the stream's [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) interface, you can set the values by using the following attributes:</span></span>

-   <span data-ttu-id="59566-190">[**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (média de valores de Bucket de vazamento)</span><span class="sxs-lookup"><span data-stu-id="59566-190">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (average leaky bucket values)</span></span>
-   <span data-ttu-id="59566-191">[**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (máximo de valores de Bucket de vazamento)</span><span class="sxs-lookup"><span data-stu-id="59566-191">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (maximum leaky bucket values)</span></span>

<span data-ttu-id="59566-192">Para obter informações sobre como adicionar fluxos e obter o ponteiro **IMFASFStreamConfig** , consulte [adicionando informações de fluxo ao coletor de arquivo ASF](adding-stream-information-to-the-asf-file-sink.md).</span><span class="sxs-lookup"><span data-stu-id="59566-192">For information about adding streams and getting the **IMFASFStreamConfig** pointer, see [Adding Stream Information to the ASF File Sink](adding-stream-information-to-the-asf-file-sink.md).</span></span>

<span data-ttu-id="59566-193">Esses valores contêm o seguinte conjunto de informações:</span><span class="sxs-lookup"><span data-stu-id="59566-193">These values contain the following set of information:</span></span>

-   <span data-ttu-id="59566-194">Taxa média de bits: Obtenha a taxa média de bits do tipo de mídia de saída selecionado durante a negociação do tipo de mídia.</span><span class="sxs-lookup"><span data-stu-id="59566-194">Average bit rate: Get the average bit rate from the output media type that is selected during media type negotiation.</span></span> <span data-ttu-id="59566-195">Use o atributo de [**\_ \_ \_ bytes médios \_ \_ por \_ segundo do áudio MF MT**](mf-mt-audio-avg-bytes-per-second-attribute.md) (para fluxos de áudio) ou o atributo de média de taxa de [**\_ \_ \_ bits MF MT**](mf-mt-avg-bitrate-attribute.md) (para fluxos de vídeo).</span><span class="sxs-lookup"><span data-stu-id="59566-195">Use the [**MF\_MT\_AUDIO\_AVG\_BYTES\_PER\_SECOND**](mf-mt-audio-avg-bytes-per-second-attribute.md) attribute (for audio streams) or the [**MF\_MT\_AVG\_BITRATE**](mf-mt-avg-bitrate-attribute.md) attribute (for video streams).</span></span>
-   <span data-ttu-id="59566-196">Janela de buffer: se você tiver uma instância do codificador e tiver os tipos de mídia de saída negociados, poderá atualizar esse valor posteriormente consultando o codificador para a interface [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) e, em seguida, chamando [**IWMCodecLeakyBucket:: GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces. h, wmcodecdspuuid. lib).</span><span class="sxs-lookup"><span data-stu-id="59566-196">Buffer window: If you have an instance of the encoder and have negotiated output media types, you can update this value later by querying the encoder for the [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) interface and then calling [**IWMCodecLeakyBucket::GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces.h, wmcodecdspuuid.lib).</span></span> <span data-ttu-id="59566-197">Caso contrário, use o valor padrão de 3000 milissegundos.</span><span class="sxs-lookup"><span data-stu-id="59566-197">Otherwise, Use the default value of 3000 milliseconds.</span></span>
-   <span data-ttu-id="59566-198">Tamanho do buffer inicial: Defina como 0.</span><span class="sxs-lookup"><span data-stu-id="59566-198">Initial buffer size: Set to 0.</span></span>

<span data-ttu-id="59566-199">Os valores fornecidos pelo aplicativo dependem do tipo de codificação e do tipo de mídia do fluxo.</span><span class="sxs-lookup"><span data-stu-id="59566-199">The values provided by the application depend on the type of encoding and the media type of the stream.</span></span> <span data-ttu-id="59566-200">Por exemplo, a [codificação de taxa de bits constante](constant-bit-rate-encoding.md) requer uma taxa de bits fixa predeterminada e uma janela de buffer.</span><span class="sxs-lookup"><span data-stu-id="59566-200">For example, [Constant Bit Rate Encoding](constant-bit-rate-encoding.md) requires a predetermined fixed bit rate and a buffer window.</span></span> <span data-ttu-id="59566-201">O aplicativo pode especificar esses valores de Bucket de vazamentos definindo a propriedade de codificação [**MFPKEY \_ VIDEOWINDOW**](mfpkey-videowindowproperty.md) e o atributo [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) no fluxo.</span><span class="sxs-lookup"><span data-stu-id="59566-201">The application can specify these leaky bucket values by setting the [**MFPKEY\_VIDEOWINDOW**](mfpkey-videowindowproperty.md) encoding property and the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) attribute on the stream.</span></span> <span data-ttu-id="59566-202">Os valores de janela de buffer especificados são usados para garantir que o arquivo codificado tenha os horários de envio corretos marcados nos pacotes de dados e que o valor de preversão apareça no objeto de cabeçalho ASF.</span><span class="sxs-lookup"><span data-stu-id="59566-202">The specified buffer window values are used to make sure that the encoded file has the correct send times marked on the data packets and the preroll value appears in the ASF Header Object.</span></span> <span data-ttu-id="59566-203">É suficiente definir **MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1** porque esses valores especificados são copiados para o atributo [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) .</span><span class="sxs-lookup"><span data-stu-id="59566-203">It is sufficient to set **MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1** because these specified values are copied into the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) attribute.</span></span>

<span data-ttu-id="59566-204">Para modos de codificação de 2 passagens, você precisa definir ambos os atributos para especificar os valores médio e máximo.</span><span class="sxs-lookup"><span data-stu-id="59566-204">For 2-pass encoding modes you need to set both of these attributes to specify the average and maximum values.</span></span>

<span data-ttu-id="59566-205">Para a codificação de VBR, o aplicativo pode consultar os valores de Bucket de vazamentos usados pelo codificador somente após a conclusão da passagem de codificação.</span><span class="sxs-lookup"><span data-stu-id="59566-205">For VBR encoding, the application can query for the leaky bucket values used by the encoder only after the encoding pass is complete.</span></span> <span data-ttu-id="59566-206">Portanto, ao configurar o coletor de mídia, o aplicativo pode optar por não definir os atributos ou propriedades relacionados a buckets vazados.</span><span class="sxs-lookup"><span data-stu-id="59566-206">Therefore, while configuring the media sink, the application can choose not to set the attributes or properties related to leaky buckets.</span></span> <span data-ttu-id="59566-207">Após a codificação, o aplicativo deve consultar o codificador para as propriedades [**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md), [**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md), [**MFPKEY \_ RMAX**](mfpkey-rmaxproperty.md)e [**MFPKEY \_ BMAX**](mfpkey-bmaxproperty.md) e defini-las no coletor de mídia para que os valores precisos sejam refletidos no objeto header.</span><span class="sxs-lookup"><span data-stu-id="59566-207">After encoding, the application must query the encoder for the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties and set them in the media sink so that the accurate values are reflected in the Header Object.</span></span> <span data-ttu-id="59566-208">Para obter o exemplo de código sobre como atualizar os valores para a codificação de VBR, consulte "atualizar propriedades de codificação no coletor de arquivos", no [tutorial: 1-transmitir codificação de mídia do Windows](tutorial--1-pass-windows-media-encoding.md).</span><span class="sxs-lookup"><span data-stu-id="59566-208">For code example about how to update the values for VBR encoding, see "Update Encoding Properties in the File Sink" in [Tutorial: 1-Pass Windows Media Encoding](tutorial--1-pass-windows-media-encoding.md).</span></span>

<span data-ttu-id="59566-209">Se você estiver copiando o conteúdo do Windows Media do coletor de origem para mídia sem codificação, os valores de Bucket de vazamento devem ser definidos no coletor de mídia.</span><span class="sxs-lookup"><span data-stu-id="59566-209">If you are copying Windows Media content from source to media sink without encoding, the leaky bucket values must be set in the media sink.</span></span>

## <a name="leaky-bucket-values-in-the-asf-multiplexer"></a><span data-ttu-id="59566-210">Valores de buckets vazados no Multiplexador de ASF</span><span class="sxs-lookup"><span data-stu-id="59566-210">Leaky Bucket Values in the ASF Multiplexer</span></span>

<span data-ttu-id="59566-211">No Media Foundation, os valores de buckets vazados são usados pelo [Multiplexador de ASF](asf-multiplexer.md) para configurar os valores de buckets de vazamentos internos que ele usa para gerar pacotes de dados.</span><span class="sxs-lookup"><span data-stu-id="59566-211">In Media Foundation, the leaky bucket values are used by the [ASF Multiplexer](asf-multiplexer.md) to set up the internal leaky bucket values that it uses to generate data packets.</span></span> <span data-ttu-id="59566-212">A carga está contida em um exemplo de mídia e uma série de amostras de mídia constitui um pacote de dados ASF.</span><span class="sxs-lookup"><span data-stu-id="59566-212">The payload is contained within a media sample and a series of media samples constitutes an ASF data packet.</span></span> <span data-ttu-id="59566-213">Com base nos valores de buckets vazados e no tempo de apresentação, o multiplexador atribui um tempo de envio para cada exemplo de mídia, de modo que as taxas de bits dos pacotes que estão sendo enviados pela rede estejam em uma taxa de bits constante (*R*).</span><span class="sxs-lookup"><span data-stu-id="59566-213">Based on the leaky bucket values and the presentation time, the multiplexer assigns a send time for each media sample so that the bit rates of the packets being sent across the network is at a constant bit rate (*R*).</span></span>

<span data-ttu-id="59566-214">Um aplicativo não pode definir valores de buckets vazados diretamente no Multiplexador.</span><span class="sxs-lookup"><span data-stu-id="59566-214">An application cannot set leaky bucket values in the multiplexer directly.</span></span> <span data-ttu-id="59566-215">Os valores devem ser fornecidos no coletor de mídia ASF, que define os valores apropriados no Multiplexador.</span><span class="sxs-lookup"><span data-stu-id="59566-215">The values must be provided on the ASF media sink, which sets the appropriate values on the multiplexer.</span></span> <span data-ttu-id="59566-216">Os valores definidos em [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) e [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) são usados pelo multiplexador para validar que os exemplos enviados ao coletor de mídia ASF são gerados usando os valores especificados.</span><span class="sxs-lookup"><span data-stu-id="59566-216">The values set in [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) and [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) are used by the multiplexer to validate the samples sent to the ASF media sink are generated by using the specified values.</span></span>

## <a name="updating-leaky-bucket-values-in-the-asf-media-sink"></a><span data-ttu-id="59566-217">Atualizando valores de buckets vazados no coletor de mídia ASF</span><span class="sxs-lookup"><span data-stu-id="59566-217">Updating Leaky Bucket Values in the ASF Media Sink</span></span>

<span data-ttu-id="59566-218">Um aplicativo pode substituir os valores de Bucket de vazamento de nível de fluxo (definidos no perfil ASF durante a criação do fluxo) definindo a propriedade [**\_ LEAKYBUCKET MFPKEY ASFSTREAMSINK \_ corrigida \_**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) no repositório de propriedades do coletor de mídia.</span><span class="sxs-lookup"><span data-stu-id="59566-218">An application can overwrite the stream-level leaky bucket values (set in the ASF profile during stream creation) by setting the [**MFPKEY\_ASFSTREAMSINK\_CORRECTED\_LEAKYBUCKET**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) property in the media sink's property store.</span></span> <span data-ttu-id="59566-219">Para obter uma referência ao repositório de propriedades, use o objeto ContentInfo implementado pelo coletor de mídia.</span><span class="sxs-lookup"><span data-stu-id="59566-219">To get a reference to the property store, use the ContentInfo object implemented by the media sink.</span></span> <span data-ttu-id="59566-220">Para obter mais informações, consulte [definindo propriedades no coletor de arquivos](setting-properties-in-the-file-sink.md).</span><span class="sxs-lookup"><span data-stu-id="59566-220">For more information, see [Setting Properties in the File Sink](setting-properties-in-the-file-sink.md).</span></span>

<span data-ttu-id="59566-221">**Observação**  Esta operação só é permitida para fluxos de áudio.</span><span class="sxs-lookup"><span data-stu-id="59566-221">**Note**  This operation is only allowed for audio streams.</span></span>

<span data-ttu-id="59566-222">Essa propriedade deve ser definida depois que você definir o tipo de saída no codificador.</span><span class="sxs-lookup"><span data-stu-id="59566-222">This property must be set after you have set the output type on the encoder.</span></span> <span data-ttu-id="59566-223">Com base na taxa de bits definida no tipo de mídia, o codificador calcula o tamanho do buffer para garantir que os exemplos de mídia gerados nunca estourem o buffer.</span><span class="sxs-lookup"><span data-stu-id="59566-223">Based on the bit rate set in the media type, the encoder calculates the buffer size to ensure that the generated media samples never overflow the buffer.</span></span> <span data-ttu-id="59566-224">O codificador faz os ajustes necessários durante a compactação para manter a taxa de bits das amostras compactadas dentro dos limites descritos pela janela taxa de bits e buffer.</span><span class="sxs-lookup"><span data-stu-id="59566-224">The encoder makes necessary adjustments during compression to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window.</span></span>

<span data-ttu-id="59566-225">Semelhante aos atributos de configuração de fluxo para buckets vazados, defina a taxa média de bits e o tamanho do buffer e a totalidade do buffer inicial em uma matriz de DWORDs.</span><span class="sxs-lookup"><span data-stu-id="59566-225">Similar to the stream configuration attributes for leaky buckets, set the average bit rate and the buffer size, and the initial buffer fullness in an array of DWORDs.</span></span> <span data-ttu-id="59566-226">Para obter mais informações, consulte a seção "definindo valores de Bucket de vazamento para fluxos ASF" neste tópico.</span><span class="sxs-lookup"><span data-stu-id="59566-226">For more information, see "Setting Leaky Bucket Values for ASF Streams" section in this topic.</span></span>

## <a name="related-topics"></a><span data-ttu-id="59566-227">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="59566-227">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="59566-228">Suporte a ASF no Media Foundation</span><span class="sxs-lookup"><span data-stu-id="59566-228">ASF Support in Media Foundation</span></span>](asf-support-in-media-foundation.md)
</dt> <dt>

[<span data-ttu-id="59566-229">Codificações de mídia do Windows</span><span class="sxs-lookup"><span data-stu-id="59566-229">Windows Media Codecs</span></span>](windows-media-codecs.md)
</dt> </dl>

 

 
