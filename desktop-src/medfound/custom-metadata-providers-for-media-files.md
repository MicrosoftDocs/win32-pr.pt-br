---
description: Este tópico descreve como gravar um manipulador de propriedades de shell personalizado para uma fonte de mídia Microsoft Media Foundation.
ms.assetid: f8cf70ff-8324-4308-8adf-a145aa351ca9
title: Provedores de metadados personalizados para arquivos de mídia
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a2ded77492d03f7b802f6b2f9c25e1009ef97f50
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/03/2021
ms.locfileid: "105793714"
---
# <a name="custom-metadata-providers-for-media-files"></a><span data-ttu-id="01c4b-103">Provedores de metadados personalizados para arquivos de mídia</span><span class="sxs-lookup"><span data-stu-id="01c4b-103">Custom Metadata Providers for Media Files</span></span>

<span data-ttu-id="01c4b-104">Este tópico descreve como gravar um manipulador de propriedades de shell personalizado para uma fonte de mídia Microsoft Media Foundation.</span><span class="sxs-lookup"><span data-stu-id="01c4b-104">This topic describes how to write a custom Shell property handler for a Microsoft Media Foundation media source.</span></span>

> [!Note]  
> <span data-ttu-id="01c4b-105">Para obter informações básicas sobre provedores de metadados no Media Foundation, consulte [metadados de mídia](media-metadata.md).</span><span class="sxs-lookup"><span data-stu-id="01c4b-105">For background information about metadata providers in Media Foundation, see [Media Metadata](media-metadata.md).</span></span> <span data-ttu-id="01c4b-106">Este tópico discute os manipuladores de propriedades do Shell; Ele não descreve a interface de metadados da versão 1, [**IMFMetadata**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadata).</span><span class="sxs-lookup"><span data-stu-id="01c4b-106">This topic discusses Shell property handlers; it does not describe the version 1 metadata interface, [**IMFMetadata**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadata).</span></span>

 

<span data-ttu-id="01c4b-107">Os metadados estão fortemente ligados ao formato do arquivo.</span><span class="sxs-lookup"><span data-stu-id="01c4b-107">Metadata is closely tied to the format of the file.</span></span> <span data-ttu-id="01c4b-108">No Media Foundation, os formatos de arquivo são representados por fontes de mídia.</span><span class="sxs-lookup"><span data-stu-id="01c4b-108">In Media Foundation, file formats are represented by media sources.</span></span> <span data-ttu-id="01c4b-109">Se você quiser dar suporte a metadados para um formato sem suporte nativo no Media Foundation, deverá implementar uma fonte de mídia personalizada com um manipulador de propriedades.</span><span class="sxs-lookup"><span data-stu-id="01c4b-109">If you want to support metadata for a format that is not supported natively in Media Foundation, you must implement a custom media source with a property handler.</span></span> <span data-ttu-id="01c4b-110">O manipulador de propriedades permite que o sistema de propriedades do Shell Leia e grave metadados com eficiência.</span><span class="sxs-lookup"><span data-stu-id="01c4b-110">The property handler enables the Shell property system to read and write metadata efficiently.</span></span>

<span data-ttu-id="01c4b-111">Um manipulador de propriedades é um objeto COM que implementa as seguintes interfaces:</span><span class="sxs-lookup"><span data-stu-id="01c4b-111">A property handler is a COM object that implements the following interfaces:</span></span>

-   [<span data-ttu-id="01c4b-112">**IInitializeWithStream**</span><span class="sxs-lookup"><span data-stu-id="01c4b-112">**IInitializeWithStream**</span></span>](/windows/win32/api/propsys/nn-propsys-iinitializewithstream)
-   [<span data-ttu-id="01c4b-113">**IPropertyStore**</span><span class="sxs-lookup"><span data-stu-id="01c4b-113">**IPropertyStore**</span></span>](/windows/win32/api/propsys/nn-propsys-ipropertystore)

<span data-ttu-id="01c4b-114">Opcionalmente, ele também pode expor a seguinte interface:</span><span class="sxs-lookup"><span data-stu-id="01c4b-114">Optionally, it can also expose the following interface:</span></span>

-   [<span data-ttu-id="01c4b-115">**IPropertyStoreCapabilities**</span><span class="sxs-lookup"><span data-stu-id="01c4b-115">**IPropertyStoreCapabilities**</span></span>](/windows/win32/api/propsys/nn-propsys-ipropertystorecapabilities)

<span data-ttu-id="01c4b-116">Se o sistema de propriedades do Shell precisar obter metadados para um arquivo, ele chamará [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) para criar o manipulador de propriedades e, em seguida, chamará os métodos de leitura e gravação apropriados na interface [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) .</span><span class="sxs-lookup"><span data-stu-id="01c4b-116">If the Shell property system needs to get metadata for a file, it calls [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the property handler and then calls the appropriate read and write methods on the [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) interface.</span></span>

<span data-ttu-id="01c4b-117">O pipeline de Media Foundation usa um mecanismo ligeiramente diferente, porque o pipeline Obtém o manipulador de propriedade diretamente da origem da mídia.</span><span class="sxs-lookup"><span data-stu-id="01c4b-117">The Media Foundation pipeline uses a slightly different mechanism, because the pipeline gets the property handler directly from the media source.</span></span> <span data-ttu-id="01c4b-118">Em vez de chamar [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) para criar o manipulador de propriedades, o pipeline chama [**IMFGetService:: GetService**](/windows/desktop/api/mfidl/nf-mfidl-imfgetservice-getservice) na origem da mídia, conforme descrito no tópico [provedores de metadados do Shell](shell-metadata-providers.md).</span><span class="sxs-lookup"><span data-stu-id="01c4b-118">Instead of calling [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the property handler, the pipeline calls [**IMFGetService::GetService**](/windows/desktop/api/mfidl/nf-mfidl-imfgetservice-getservice) on the media source, as described in the topic [Shell Metadata Providers](shell-metadata-providers.md).</span></span>

<span data-ttu-id="01c4b-119">Para criar um manipulador de propriedade personalizada, faça o seguinte:</span><span class="sxs-lookup"><span data-stu-id="01c4b-119">To create a custom property handler, do the following:</span></span>

-   <span data-ttu-id="01c4b-120">Implemente a interface [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) para expor [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore).</span><span class="sxs-lookup"><span data-stu-id="01c4b-120">Implement the [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) interface to expose [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore).</span></span> <span data-ttu-id="01c4b-121">O GUID do serviço é o **\_ serviço de \_ manipulador \_ de propriedades MF**.</span><span class="sxs-lookup"><span data-stu-id="01c4b-121">The service GUID is **MF\_PROPERTY\_HANDLER\_SERVICE**.</span></span>
-   <span data-ttu-id="01c4b-122">Se a origem da mídia for usada remotamente, ela também deverá expor a interface [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) por meio do método **QueryInterface** da origem de mídia, além de [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice).</span><span class="sxs-lookup"><span data-stu-id="01c4b-122">If the media source will be used remotely, it must also expose the [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) interface through the media source's **QueryInterface** method, in addition to [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice).</span></span>
-   <span data-ttu-id="01c4b-123">Para disponibilizar o manipulador de propriedades para o sistema de propriedades do Shell, registre a DLL para o manipulador de propriedades, conforme descrito em [registrando e distribuindo manipuladores de propriedade](../properties/prophand-reg-dist.md).</span><span class="sxs-lookup"><span data-stu-id="01c4b-123">To make the property handler available to the Shell property system, register the DLL for the property handler as described in [Registering and Distributing Property Handlers](../properties/prophand-reg-dist.md).</span></span>
-   <span data-ttu-id="01c4b-124">A origem da mídia é registrada separadamente, conforme descrito em [manipuladores de esquema e manipuladores de Byte-Stream](scheme-handlers-and-byte-stream-handlers.md).</span><span class="sxs-lookup"><span data-stu-id="01c4b-124">The media source is registered separately, as described in [Scheme Handlers and Byte-Stream Handlers](scheme-handlers-and-byte-stream-handlers.md).</span></span>

### <a name="implementation-tips"></a><span data-ttu-id="01c4b-125">Dicas de implementação</span><span class="sxs-lookup"><span data-stu-id="01c4b-125">Implementation Tips</span></span>

<span data-ttu-id="01c4b-126">Para obter uma lista de chaves de propriedade de metadados, consulte [Propriedades de metadados para arquivos de mídia](metadata-properties-for-media-files.md).</span><span class="sxs-lookup"><span data-stu-id="01c4b-126">For a list of metadata property keys, see [Metadata Properties for Media Files](metadata-properties-for-media-files.md).</span></span>

<span data-ttu-id="01c4b-127">Manipuladores de propriedade devem ser rápidos; Eles devem fornecer acesso eficiente de leitura e gravação aos metadados.</span><span class="sxs-lookup"><span data-stu-id="01c4b-127">Property handlers must be fast; they must provide efficient read and write access to the metadata.</span></span> <span data-ttu-id="01c4b-128">(Considere que o Shell pode recuperar metadados de centenas de arquivos.) Portanto, não chame [**MFStartup**](/windows/desktop/api/mfapi/nf-mfapi-mfstartup) de seu manipulador de propriedade.</span><span class="sxs-lookup"><span data-stu-id="01c4b-128">(Consider that the Shell may retrieve metadata from hundreds of files.) Therefore, do not call [**MFStartup**](/windows/desktop/api/mfapi/nf-mfapi-mfstartup) from your property handler.</span></span> <span data-ttu-id="01c4b-129">A função **MFStartup** introduz a latência de inicialização, pois ela cria vários threads de fila de trabalho e aloca memória global.</span><span class="sxs-lookup"><span data-stu-id="01c4b-129">The **MFStartup** function introduces startup latency, because it creates multiple work-queue threads and allocates global memory.</span></span>

<span data-ttu-id="01c4b-130">Em uma implementação típica, o manipulador de propriedades e a origem da mídia compartilharão alguns dos mesmos códigos de análise.</span><span class="sxs-lookup"><span data-stu-id="01c4b-130">In a typical implementation, the property handler and the media source will share some of the same parsing code.</span></span> <span data-ttu-id="01c4b-131">No entanto, uma origem de mídia usa chamadas [**IMFByteStream**](/windows/desktop/api/mfobjects/nn-mfobjects-imfbytestream) assíncronas para e/s, enquanto o manipulador de propriedades usa a interface [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) .</span><span class="sxs-lookup"><span data-stu-id="01c4b-131">However, a media source uses asynchronous [**IMFByteStream**](/windows/desktop/api/mfobjects/nn-mfobjects-imfbytestream) calls for I/O, whereas the property handler uses the [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface.</span></span> <span data-ttu-id="01c4b-132">Media Foundation fornece um objeto auxiliar que encapsula um fluxo baseado em **IStream** e o expõe como um fluxo **IMFByteStream** .</span><span class="sxs-lookup"><span data-stu-id="01c4b-132">Media Foundation provides a helper object that wraps an **IStream**-based stream and exposes it as an **IMFByteStream** stream.</span></span> <span data-ttu-id="01c4b-133">Para criar o wrapper, chame [**MFCreateMFByteStreamOnStream**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatemfbytestreamonstream).</span><span class="sxs-lookup"><span data-stu-id="01c4b-133">To create the wrapper, call [**MFCreateMFByteStreamOnStream**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatemfbytestreamonstream).</span></span>

<span data-ttu-id="01c4b-134">Ao atualizar metadados, é recomendável gravar os dados diretamente no fluxo original.</span><span class="sxs-lookup"><span data-stu-id="01c4b-134">When updating metadata, it is recommended to write the data directly to the original stream.</span></span> <span data-ttu-id="01c4b-135">Essa recomendação é diferente do comportamento de *Copiar na gravação* da maioria dos manipuladores de propriedade, em que uma cópia dos dados é modificada.</span><span class="sxs-lookup"><span data-stu-id="01c4b-135">This recommendation differs from the *copy-on-write* behavior of most property handlers, in which a copy of the data is modified.</span></span> <span data-ttu-id="01c4b-136">Os arquivos de mídia podem ser muito grandes, portanto, a cópia em gravação normalmente é muito lenta para uma implementação eficiente.</span><span class="sxs-lookup"><span data-stu-id="01c4b-136">Media files can be very large, so copy-on-write is typically too slow for an efficient implementation.</span></span> <span data-ttu-id="01c4b-137">Para desabilitar a cópia em gravação, defina a configuração do registro **ManualSafeSave** , conforme descrito em [registrando e distribuindo manipuladores de propriedade](../properties/prophand-reg-dist.md).</span><span class="sxs-lookup"><span data-stu-id="01c4b-137">To disable copy-on-write, set the **ManualSafeSave** registry setting, as described in [Registering and Distributing Property Handlers](../properties/prophand-reg-dist.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="01c4b-138">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="01c4b-138">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="01c4b-139">Metadados de mídia</span><span class="sxs-lookup"><span data-stu-id="01c4b-139">Media Metadata</span></span>](media-metadata.md)
</dt> <dt>

[<span data-ttu-id="01c4b-140">Fontes de mídia</span><span class="sxs-lookup"><span data-stu-id="01c4b-140">Media Sources</span></span>](media-sources.md)
</dt> <dt>

[<span data-ttu-id="01c4b-141">Gravando uma fonte de mídia personalizada</span><span class="sxs-lookup"><span data-stu-id="01c4b-141">Writing a Custom Media Source</span></span>](writing-a-custom-media-source.md)
</dt> </dl>

 

 
