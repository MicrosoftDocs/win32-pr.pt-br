---
description: Descreve o conteúdo de vídeo&\# 8211; recursos de proteção que um driver de gráficos pode fornecer.
ms.assetid: FD0625BB-484A-43E6-8931-DB635D4F017F
title: GPU-Based Proteção de Conteúdo
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6bbc1a0f88cae199b9aab38e5ec429ea5427f44b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104568237"
---
# <a name="gpu-based-content-protection"></a><span data-ttu-id="91648-103">GPU-Based Proteção de Conteúdo</span><span class="sxs-lookup"><span data-stu-id="91648-103">GPU-Based Content Protection</span></span>

<span data-ttu-id="91648-104">Este tópico descreve o conteúdo de vídeo – recursos de proteção que um driver de gráficos pode fornecer.</span><span class="sxs-lookup"><span data-stu-id="91648-104">This topic describes video content–protection capabilities that a graphics driver can provide.</span></span>

-   [<span data-ttu-id="91648-105">Introdução</span><span class="sxs-lookup"><span data-stu-id="91648-105">Introduction</span></span>](#introduction)
-   [<span data-ttu-id="91648-106">Visão geral do processo de decodificação</span><span class="sxs-lookup"><span data-stu-id="91648-106">Overview of the Decoding Process</span></span>](#overview-of-the-decoding-process)
-   [<span data-ttu-id="91648-107">Criptografando buffers de vídeo compactados para o decodificador</span><span class="sxs-lookup"><span data-stu-id="91648-107">Encrypting Compressed Video Buffers for the Decoder</span></span>](#encrypting-compressed-video-buffers-for-the-decoder)
    -   [<span data-ttu-id="91648-108">1. consulte os recursos de Proteção de Conteúdo do driver</span><span class="sxs-lookup"><span data-stu-id="91648-108">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
    -   [<span data-ttu-id="91648-109">2. configurar o canal autenticado</span><span class="sxs-lookup"><span data-stu-id="91648-109">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
    -   [<span data-ttu-id="91648-110">3. configurar a sessão de criptografia</span><span class="sxs-lookup"><span data-stu-id="91648-110">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
    -   [<span data-ttu-id="91648-111">4. obter um identificador para o dispositivo de decodificador de DXVA</span><span class="sxs-lookup"><span data-stu-id="91648-111">4. Get a Handle to the DXVA Decoder Device</span></span>](#4-get-a-handle-to-the-dxva-decoder-device)
    -   [<span data-ttu-id="91648-112">5. associar o decodificador de DXVA à sessão criptográfica</span><span class="sxs-lookup"><span data-stu-id="91648-112">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>](#5-associate-the-dxva-decoder-with-the-cryptographic-session)
-   [<span data-ttu-id="91648-113">Enviando comandos de canal autenticado</span><span class="sxs-lookup"><span data-stu-id="91648-113">Sending Authenticated Channel Commands</span></span>](#sending-authenticated-channel-commands)
-   [<span data-ttu-id="91648-114">Enviando consultas de canal autenticado</span><span class="sxs-lookup"><span data-stu-id="91648-114">Sending Authenticated Channel Queries</span></span>](#sending-authenticated-channel-queries)
-   [<span data-ttu-id="91648-115">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="91648-115">Related topics</span></span>](#related-topics)

## <a name="introduction"></a><span data-ttu-id="91648-116">Introdução</span><span class="sxs-lookup"><span data-stu-id="91648-116">Introduction</span></span>

<span data-ttu-id="91648-117">O diagrama a seguir mostra uma exibição simplificada de como o conteúdo de vídeo protegido passa pelo pipeline para ser renderizado.</span><span class="sxs-lookup"><span data-stu-id="91648-117">The following diagram shows a simplified view of how protected video content travels through the pipeline to be rendered.</span></span>

![um diagrama que mostra o conteúdo de vídeo protegido.](images/d3d9video01.png)

> [!Note]  
> <span data-ttu-id="91648-119">O [caminho de mídia protegido](protected-media-path.md) (PMP) não está descrito neste diagrama.</span><span class="sxs-lookup"><span data-stu-id="91648-119">The [Protected Media Path](protected-media-path.md) (PMP) is not depicted in this diagram.</span></span> <span data-ttu-id="91648-120">O fluxo de dados mostrado aqui pode ocorrer em um processo de PMP ou em um processo de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="91648-120">The data flow that is shown here might occur within a PMP process, or within an application process.</span></span>

 

<span data-ttu-id="91648-121">O decodificador recebe dados de vídeo criptografados e compactados de uma fonte externa.</span><span class="sxs-lookup"><span data-stu-id="91648-121">The decoder receives encrypted, compressed video data from an external source.</span></span> <span data-ttu-id="91648-122">Presume-se também que o decodificador também receba uma chave de criptografia para descriptografar esses dados.</span><span class="sxs-lookup"><span data-stu-id="91648-122">It is assumed also the decoder also receives a cryptographic key to decrypt this data.</span></span> <span data-ttu-id="91648-123">Este tópico não descreve a troca de chaves entre a fonte de vídeo e o decodificador, mas a PMP define um mecanismo possível.</span><span class="sxs-lookup"><span data-stu-id="91648-123">This topic does not describe the key exchange between the video source and decoder, but the PMP defines one possible mechanism.</span></span> <span data-ttu-id="91648-124">A GPU não está envolvida neste estágio.</span><span class="sxs-lookup"><span data-stu-id="91648-124">The GPU is not involved at this stage.</span></span>

<span data-ttu-id="91648-125">Para a decodificação acelerada por hardware, o decodificador de software passa o conteúdo de vídeo compactado para a GPU.</span><span class="sxs-lookup"><span data-stu-id="91648-125">For hardware-accelerated decoding, the software decoder passes compressed video content to the GPU.</span></span> <span data-ttu-id="91648-126">Para proteger esse conteúdo, o decodificador criptografa novamente os dados, normalmente usando AES-CTR, antes de passá-los para o acelerador de hardware.</span><span class="sxs-lookup"><span data-stu-id="91648-126">To protect this content, the decoder re-encrypts the data, typically using AES-CTR, before passing it to the hardware accelerator.</span></span> <span data-ttu-id="91648-127">Um mecanismo de troca de chaves é definido entre o decodificador e o driver de gráficos.</span><span class="sxs-lookup"><span data-stu-id="91648-127">A key-exchange mechanism is defined between the decoder and the graphics driver.</span></span>

<span data-ttu-id="91648-128">Os quadros de vídeo decodificados são armazenados na memória de vídeo, geralmente em claro.</span><span class="sxs-lookup"><span data-stu-id="91648-128">Decoded video frames are stored in video memory, generally in the clear.</span></span> <span data-ttu-id="91648-129">Neste ponto, os quadros são processados e, em seguida, apresentados.</span><span class="sxs-lookup"><span data-stu-id="91648-129">At this point, the frames are processed and then presented.</span></span> <span data-ttu-id="91648-130">Há duas opções principais para apresentação.</span><span class="sxs-lookup"><span data-stu-id="91648-130">There are two main options for presentation.</span></span>

-   <span data-ttu-id="91648-131">Quadros podem ser apresentados usando uma sobreposição de hardware.</span><span class="sxs-lookup"><span data-stu-id="91648-131">Frames can be presented using a hardware overlay.</span></span> <span data-ttu-id="91648-132">Para obter mais informações, consulte [suporte à sobreposição de hardware](hardware-overlay-support.md).</span><span class="sxs-lookup"><span data-stu-id="91648-132">For more information, see [Hardware Overlay Support](hardware-overlay-support.md).</span></span>
-   <span data-ttu-id="91648-133">Os quadros podem ser apresentados pelo DWM (gerenciamento de janelas da área de trabalho) usando uma superfície compartilhada.</span><span class="sxs-lookup"><span data-stu-id="91648-133">Frames can be presented by the Desktop Window Manage (DWM) using a shared surface.</span></span>

<span data-ttu-id="91648-134">A última etapa é exibir o quadro no monitor, o que pode exigir proteção de link entre a placa gráfica e o dispositivo de vídeo.</span><span class="sxs-lookup"><span data-stu-id="91648-134">The last step is to display the frame on the monitor, which may require link protection between the graphics card and the display device.</span></span> <span data-ttu-id="91648-135">Um exemplo de proteção de link é High-Bandwidth Proteção de Conteúdo Digital (HDCP).</span><span class="sxs-lookup"><span data-stu-id="91648-135">An example of link protection is High-Bandwidth Digital Content Protection (HDCP).</span></span> <span data-ttu-id="91648-136">A proteção de link é configurada usando o [Gerenciador de proteção de saída](output-protection-manager.md) (OPM).</span><span class="sxs-lookup"><span data-stu-id="91648-136">Link protection is configured using [Output Protection Manager](output-protection-manager.md) (OPM).</span></span> <span data-ttu-id="91648-137">Este tópico não descreve OPM; para obter mais informações, consulte [usando o Gerenciador de proteção de saída](using-output-protection-manager.md).</span><span class="sxs-lookup"><span data-stu-id="91648-137">This topic does not describe OPM; for more information, see [Using Output Protection Manager](using-output-protection-manager.md).</span></span>

## <a name="overview-of-the-decoding-process"></a><span data-ttu-id="91648-138">Visão geral do processo de decodificação</span><span class="sxs-lookup"><span data-stu-id="91648-138">Overview of the Decoding Process</span></span>

<span data-ttu-id="91648-139">Durante a decodificação acelerada por hardware, o decodificador de software deve passar dados de vídeo compactados para a placa gráfica.</span><span class="sxs-lookup"><span data-stu-id="91648-139">During hardware-accelerated decoding, the software decoder must pass compressed video data to the graphics card.</span></span> <span data-ttu-id="91648-140">Para conteúdo premium, esses dados normalmente devem ser criptografados, usando criptografia de chave simétrica, antes de serem enviados para a GPU.</span><span class="sxs-lookup"><span data-stu-id="91648-140">For premium content, this data typically must be encrypted, using symmetric-key encryption, before it is sent to the GPU.</span></span>

<span data-ttu-id="91648-141">Para criptografar o vídeo para decodificação, o decodificador de software usa as seguintes interfaces:</span><span class="sxs-lookup"><span data-stu-id="91648-141">To encrypt the video for decoding, the software decoder uses the following interfaces:</span></span>

-   <span data-ttu-id="91648-142">[**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="91648-142">[**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder).</span></span> <span data-ttu-id="91648-143">Representa o dispositivo de decodificador DXVA, também chamado de acelerador.</span><span class="sxs-lookup"><span data-stu-id="91648-143">Represents the DXVA decoder device, also called the accelerator.</span></span>
-   <span data-ttu-id="91648-144">[**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9).</span><span class="sxs-lookup"><span data-stu-id="91648-144">[**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9).</span></span> <span data-ttu-id="91648-145">Representa uma sessão criptográfica, que fornece a chave de criptografia.</span><span class="sxs-lookup"><span data-stu-id="91648-145">Represents a cryptographic session, which provides the encryption key.</span></span>
-   <span data-ttu-id="91648-146">[**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9).</span><span class="sxs-lookup"><span data-stu-id="91648-146">[**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9).</span></span> <span data-ttu-id="91648-147">Representa um canal autenticado, que permite que o decodificador de software associe a sessão criptográfica ao decodificador DXVA.</span><span class="sxs-lookup"><span data-stu-id="91648-147">Represents an authenticated channel, which enables the software decoder to associate the cryptographic session with the DXVA decoder.</span></span>

![um diagrama que mostra as interfaces de decodificação de Direct3D9.](images/d3d9video02.png)

<span data-ttu-id="91648-149">Todas essas interfaces são obtidas do dispositivo Direct3D, da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="91648-149">All of these interfaces are obtained from the Direct3D device, as follows:</span></span>



| <span data-ttu-id="91648-150">Interface</span><span class="sxs-lookup"><span data-stu-id="91648-150">Interface</span></span>                                                                | <span data-ttu-id="91648-151">Criação</span><span class="sxs-lookup"><span data-stu-id="91648-151">Creation</span></span>                                                                                                                                                                      |
|--------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="91648-152">**IDirectXVideoDecoder**</span><span class="sxs-lookup"><span data-stu-id="91648-152">**IDirectXVideoDecoder**</span></span>](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder)                     | <span data-ttu-id="91648-153">Chame [**IDirectXVideoDecoderService:: CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="91648-153">Call [**IDirectXVideoDecoderService::CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span></span> <span data-ttu-id="91648-154">O dispositivo de decodificador DXVA é identificado por um GUID de perfil de DXVA.</span><span class="sxs-lookup"><span data-stu-id="91648-154">The DXVA decoder device is identified by a DXVA profile GUID.</span></span> |
| [<span data-ttu-id="91648-155">**IDirect3DCryptoSession9**</span><span class="sxs-lookup"><span data-stu-id="91648-155">**IDirect3DCryptoSession9**</span></span>](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9)               | <span data-ttu-id="91648-156">Chame [**IDirect3DDevice9Video:: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession).</span><span class="sxs-lookup"><span data-stu-id="91648-156">Call [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession).</span></span>                                                                         |
| [<span data-ttu-id="91648-157">**IDirect3DAuthenticatedChannel9**</span><span class="sxs-lookup"><span data-stu-id="91648-157">**IDirect3DAuthenticatedChannel9**</span></span>](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) | <span data-ttu-id="91648-158">Chame [**IDirect3DDevice9Video:: CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel).</span><span class="sxs-lookup"><span data-stu-id="91648-158">Call [**IDirect3DDevice9Video::CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel).</span></span>                                                           |



 

> [!Note]  
> <span data-ttu-id="91648-159">Para obter um ponteiro para a interface [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) , chame [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) em um dispositivo D3D9Ex.</span><span class="sxs-lookup"><span data-stu-id="91648-159">To get a pointer to the [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) interface, call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) on a D3D9Ex device.</span></span>

 

<span data-ttu-id="91648-160">O canal autenticado fornece um canal de comunicação confiável entre o decodificador de software e o driver.</span><span class="sxs-lookup"><span data-stu-id="91648-160">The authenticated channel provides a trusted communication channel between the software decoder and the driver.</span></span> <span data-ttu-id="91648-161">O canal de comunicação funciona da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="91648-161">The communication channel works as follows:</span></span>

-   <span data-ttu-id="91648-162">O driver fornece uma cadeia de certificados X. 509 cujo certificado raiz é assinado pela Microsoft.</span><span class="sxs-lookup"><span data-stu-id="91648-162">The driver provides an X.509 certificate chain whose root certificate is signed by Microsoft.</span></span>
-   <span data-ttu-id="91648-163">O certificado contém uma chave pública RSA para o driver.</span><span class="sxs-lookup"><span data-stu-id="91648-163">The certificate contains an RSA public key for the driver.</span></span>
-   <span data-ttu-id="91648-164">O decodificador de software usa a chave pública para enviar o driver a uma chave de sessão AES de 128 bits.</span><span class="sxs-lookup"><span data-stu-id="91648-164">The software decoder uses the public key to send the driver a 128-bit AES session key.</span></span>
-   <span data-ttu-id="91648-165">O decodificador de software envia consultas e comandos para o canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-165">The software decoder sends queries and commands to the authenticated channel.</span></span>
-   <span data-ttu-id="91648-166">A chave de sessão é usada para computar MACs (códigos de autenticação de mensagem) para as consultas e comandos.</span><span class="sxs-lookup"><span data-stu-id="91648-166">The session key is used to compute message authentication codes (MACs) for the queries and commands.</span></span> <span data-ttu-id="91648-167">O driver usa os MACs para verificar a integridade dos dados de consulta/comando, e o decodificador de software os usa para verificar a integridade dos dados de resposta do driver.</span><span class="sxs-lookup"><span data-stu-id="91648-167">The driver uses the MACs to verify the integrity of the query/command data, and the software decoder uses them to verify the integrity of the response data from the driver.</span></span>

## <a name="encrypting-compressed-video-buffers-for-the-decoder"></a><span data-ttu-id="91648-168">Criptografando buffers de vídeo compactados para o decodificador</span><span class="sxs-lookup"><span data-stu-id="91648-168">Encrypting Compressed Video Buffers for the Decoder</span></span>

<span data-ttu-id="91648-169">Aqui está uma visão geral de alto nível do processo de criptografia e decodificação:</span><span class="sxs-lookup"><span data-stu-id="91648-169">Here is a high-level overview of the encryption and decoding process:</span></span>

1.  <span data-ttu-id="91648-170">O decodificador de software recebe um fluxo de dados criptografados da fonte de vídeo.</span><span class="sxs-lookup"><span data-stu-id="91648-170">The software decoder receives a stream of encrypted data from the video source.</span></span> <span data-ttu-id="91648-171">O decodificador descriptografa esse fluxo.</span><span class="sxs-lookup"><span data-stu-id="91648-171">The decoder decrypts this stream.</span></span>
2.  <span data-ttu-id="91648-172">O decodificador de software negocia uma chave de sessão com a sessão criptográfica.</span><span class="sxs-lookup"><span data-stu-id="91648-172">The software decoder negotiates a session key with the cryptographic session.</span></span>
3.  <span data-ttu-id="91648-173">O decodificador de software usa o canal autenticado para associar a sessão criptográfica ao dispositivo de decodificador DXVA.</span><span class="sxs-lookup"><span data-stu-id="91648-173">The software decoder uses the authenticated channel to associate the cryptographic session with the DXVA decoder device.</span></span>
4.  <span data-ttu-id="91648-174">O decodificador de software coloca dados compactados em buffers de DXVA que obtém do dispositivo de decodificador de DXVA (acelerador).</span><span class="sxs-lookup"><span data-stu-id="91648-174">The software decoder puts compressed data in DXVA buffers that it gets from the DXVA decoder device (accelerator).</span></span> <span data-ttu-id="91648-175">Para conteúdo protegido, o codificador de software criptografa os dados que são colocados nos buffers de DXVA, usando a chave de sessão para a criptografia.</span><span class="sxs-lookup"><span data-stu-id="91648-175">For protected content, the software encoder encrypts the data that is puts into the DXVA buffers, using the session key for the encryption.</span></span>
    > [!Note]  
    > <span data-ttu-id="91648-176">Alguns drivers usam uma chave de conteúdo, em vez da chave de sessão, para criptografia.</span><span class="sxs-lookup"><span data-stu-id="91648-176">Some drivers use a content key, instead of the session key, for encryption.</span></span> <span data-ttu-id="91648-177">A chave de conteúdo pode mudar de um quadro para o outro.</span><span class="sxs-lookup"><span data-stu-id="91648-177">The content key could change from one frame to the next.</span></span>

     

5.  <span data-ttu-id="91648-178">O decodificador envia os buffers compactados criptografados para o acelerador.</span><span class="sxs-lookup"><span data-stu-id="91648-178">The decoder submits the encrypted compressed buffers to the accelerator.</span></span> <span data-ttu-id="91648-179">Para AES-CTR, o decodificador também passa o vetor de inicialização.</span><span class="sxs-lookup"><span data-stu-id="91648-179">For AES-CTR, the decoder also passes the initialization vector.</span></span> <span data-ttu-id="91648-180">Se uma chave de conteúdo for usada, o decodificador passará a chave de conteúdo, criptografada usando a chave de sessão.</span><span class="sxs-lookup"><span data-stu-id="91648-180">If a content key is used, the decoder passes content key, encrypted using the session key.</span></span>

<span data-ttu-id="91648-181">O Direct3D tem suporte padrão para o AES-CTR de 128 bits, mas foi projetado para estender para tipos de criptografia adicionais.</span><span class="sxs-lookup"><span data-stu-id="91648-181">Direct3D has standard support for 128-bit AES-CTR, but is designed to extend to additional encryption types.</span></span>

<span data-ttu-id="91648-182">As próximas cinco seções fornecem etapas mais detalhadas.</span><span class="sxs-lookup"><span data-stu-id="91648-182">The next five sections give more detailed steps.</span></span>

-   [<span data-ttu-id="91648-183">1. consulte os recursos de Proteção de Conteúdo do driver</span><span class="sxs-lookup"><span data-stu-id="91648-183">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
-   [<span data-ttu-id="91648-184">2. configurar o canal autenticado</span><span class="sxs-lookup"><span data-stu-id="91648-184">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
-   [<span data-ttu-id="91648-185">3. configurar a sessão de criptografia</span><span class="sxs-lookup"><span data-stu-id="91648-185">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
-   [<span data-ttu-id="91648-186">4. obter um identificador para o dispositivo de decodificador de DXVA</span><span class="sxs-lookup"><span data-stu-id="91648-186">4. Get a Handle to the DXVA Decoder Device</span></span>](#4-get-a-handle-to-the-dxva-decoder-device)
-   [<span data-ttu-id="91648-187">5. associar o decodificador de DXVA à sessão criptográfica</span><span class="sxs-lookup"><span data-stu-id="91648-187">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>](#5-associate-the-dxva-decoder-with-the-cryptographic-session)

### <a name="1-query-the-content-protection-capabilities-of-the-driver"></a><span data-ttu-id="91648-188">1. consulte os recursos de Proteção de Conteúdo do driver</span><span class="sxs-lookup"><span data-stu-id="91648-188">1. Query the Content Protection Capabilities of the Driver</span></span>

<span data-ttu-id="91648-189">Antes de tentar aplicar a criptografia, obtenha os recursos de proteção de conteúdo do driver.</span><span class="sxs-lookup"><span data-stu-id="91648-189">Before attempting to apply encryption, get the content protection capabilities of the driver.</span></span>

1.  <span data-ttu-id="91648-190">Obtenha um ponteiro para o dispositivo Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="91648-190">Get a pointer to the Direct3D 9 device.</span></span>
2.  <span data-ttu-id="91648-191">Chame [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) para a interface [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) .</span><span class="sxs-lookup"><span data-stu-id="91648-191">Call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) for the [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) interface.</span></span>
3.  <span data-ttu-id="91648-192">Chame [**IDirect3DDevice9Video:: GetContentProtectionCaps**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-getcontentprotectioncaps).</span><span class="sxs-lookup"><span data-stu-id="91648-192">Call [**IDirect3DDevice9Video::GetContentProtectionCaps**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-getcontentprotectioncaps).</span></span> <span data-ttu-id="91648-193">Esse método preenche uma estrutura [**D3DCONTENTPROTECTIONCAPS**](/windows/desktop/api/d3d9caps/ns-d3d9caps-d3dcontentprotectioncaps) com os recursos de proteção de conteúdo do driver.</span><span class="sxs-lookup"><span data-stu-id="91648-193">This method fills in a [**D3DCONTENTPROTECTIONCAPS**](/windows/desktop/api/d3d9caps/ns-d3d9caps-d3dcontentprotectioncaps) structure with the driver’s content protection capabilities.</span></span>

<span data-ttu-id="91648-194">Em particular, procure os seguintes recursos:</span><span class="sxs-lookup"><span data-stu-id="91648-194">In particular, look for the following capabilities:</span></span>

-   <span data-ttu-id="91648-195">Se o membro **Caps** contiver o sinalizador **D3DCPCAPS_SOFTWARE** ou **D3DCPCAPS_HARDWARE** , o driver poderá executar a criptografia.</span><span class="sxs-lookup"><span data-stu-id="91648-195">If the **Caps** member contains the **D3DCPCAPS_SOFTWARE** or **D3DCPCAPS_HARDWARE** flag, the driver can perform encryption.</span></span>
-   <span data-ttu-id="91648-196">O membro **Keyexchangetype** especifica como executar a troca de chaves para a chave de sessão.</span><span class="sxs-lookup"><span data-stu-id="91648-196">The **KeyExchangeType** member specifies how to perform key exchange for the session key.</span></span>
-   <span data-ttu-id="91648-197">Se o membro **Caps** contiver o sinalizador **D3DCPCAPS_CONTENTKEY** , o driver usará uma chave de conteúdo separada para criptografia.</span><span class="sxs-lookup"><span data-stu-id="91648-197">If the **Caps** member contains the **D3DCPCAPS_CONTENTKEY** flag, the driver uses a separate content key for encryption.</span></span> <span data-ttu-id="91648-198">Isso é importante quando você gera a chave de sessão.</span><span class="sxs-lookup"><span data-stu-id="91648-198">This is important when you generate the session key.</span></span>

<span data-ttu-id="91648-199">Recursos adicionais são indicados no membro **Caps** .</span><span class="sxs-lookup"><span data-stu-id="91648-199">Additional capabilities are indicated in the **Caps** member.</span></span>

### <a name="2-configure-the-authenticated-channel"></a><span data-ttu-id="91648-200">2. configurar o canal autenticado</span><span class="sxs-lookup"><span data-stu-id="91648-200">2. Configure the Authenticated Channel</span></span>

<span data-ttu-id="91648-201">A próxima etapa é configurar o canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-201">The next step is to configure the authenticated channel.</span></span>

1.  <span data-ttu-id="91648-202">Chame [**IDirect3DDevice9Video:: CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) para criar o canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-202">Call [**IDirect3DDevice9Video::CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) to create the authenticated channel.</span></span> <span data-ttu-id="91648-203">Para o parâmetro *channelType* , especifique um tipo de canal que corresponda aos recursos do driver.</span><span class="sxs-lookup"><span data-stu-id="91648-203">For the *ChannelType* parameter, specify a channel type that matches the capabilities of the driver.</span></span>
    -   <span data-ttu-id="91648-204">O tipo de canal **D3DAUTHENTICATEDCHANNEL_DRIVER_SOFTWARE** corresponde a **D3DCPCAPS_SOFTWARE**.</span><span class="sxs-lookup"><span data-stu-id="91648-204">The **D3DAUTHENTICATEDCHANNEL_DRIVER_SOFTWARE** channel type corresponds to **D3DCPCAPS_SOFTWARE**.</span></span>
    -   <span data-ttu-id="91648-205">O tipo de canal **D3DAUTHENTICATEDCHANNEL_DRIVER_HARDWARE** corresponde a **D3DCPCAPS_HARDWARE**.</span><span class="sxs-lookup"><span data-stu-id="91648-205">The **D3DAUTHENTICATEDCHANNEL_DRIVER_HARDWARE** channel type corresponds to **D3DCPCAPS_HARDWARE**.</span></span>

    <span data-ttu-id="91648-206">O método **CreateAuthenticatedChannel** retorna um ponteiro para a interface [**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) junto com um identificador para o canal.</span><span class="sxs-lookup"><span data-stu-id="91648-206">The **CreateAuthenticatedChannel** method returns a pointer to the [**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) interface along with a handle to the channel.</span></span> <span data-ttu-id="91648-207">O identificador é usado posteriormente para associar a sessão criptográfica ao canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-207">The handle is used later to associate the cryptographic session with the authenticated channel.</span></span>
2.  <span data-ttu-id="91648-208">Chame [**IDirect3DAuthenticatedChannel9:: Getcertificates**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificatesize) para obter o tamanho do certificado X. 509 do driver.</span><span class="sxs-lookup"><span data-stu-id="91648-208">Call [**IDirect3DAuthenticatedChannel9::GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="91648-209">Aloque um buffer do tamanho necessário.</span><span class="sxs-lookup"><span data-stu-id="91648-209">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="91648-210">Chame [**IDirect3DAuthenticatedChannel9:: Getcertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificate) para obter o certificado.</span><span class="sxs-lookup"><span data-stu-id="91648-210">Call [**IDirect3DAuthenticatedChannel9::GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificate) to get the certificate.</span></span> <span data-ttu-id="91648-211">O método copia o certificado no buffer que foi alocado na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="91648-211">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="91648-212">Verifique se o certificado do driver foi assinado pela Microsoft e não foi revogado.</span><span class="sxs-lookup"><span data-stu-id="91648-212">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="91648-213">Obtenha a chave pública do certificado.</span><span class="sxs-lookup"><span data-stu-id="91648-213">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="91648-214">Gere uma chave de sessão de RSA aleatória.</span><span class="sxs-lookup"><span data-stu-id="91648-214">Generate a random RSA session key.</span></span> <span data-ttu-id="91648-215">Essa chave de sessão é usada para assinar dados que são enviados para o canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-215">This session key is used to sign data that is sent to the authenticated channel.</span></span> <span data-ttu-id="91648-216">Criptografe a chave de sessão usando a chave pública do driver.</span><span class="sxs-lookup"><span data-stu-id="91648-216">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="91648-217">Chame [**IDirect3DAuthenticatedChannel9:: NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) para enviar a chave de sessão criptografada para o driver.</span><span class="sxs-lookup"><span data-stu-id="91648-217">Call [**IDirect3DAuthenticatedChannel9::NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="91648-218">Inicialize o canal seguro da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="91648-218">Initialize the secure channel as follows:</span></span>
    1.  <span data-ttu-id="91648-219">Preencha uma estrutura de [**D3DAUTHENTICATEDCHANNEL_CONFIGUREINITIALIZE**](d3dauthenticatedchannel-configureinitialize.md) , conforme descrito na documentação.</span><span class="sxs-lookup"><span data-stu-id="91648-219">Fill in a [**D3DAUTHENTICATEDCHANNEL_CONFIGUREINITIALIZE**](d3dauthenticatedchannel-configureinitialize.md) structure as described in the documentation.</span></span>
    2.  <span data-ttu-id="91648-220">Envie o comando [**D3DAUTHENTICATEDCONFIGURE_INITIALIZE**](d3dauthenticatedconfigure-initialize.md) chamando [**IDirect3DAuthenticatedChannel9:: Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) conforme descrito na seção [enviando comandos de canal autenticados](#sending-authenticated-channel-commands).</span><span class="sxs-lookup"><span data-stu-id="91648-220">Send the [**D3DAUTHENTICATEDCONFIGURE_INITIALIZE**](d3dauthenticatedconfigure-initialize.md) command by calling [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) as described in the section [Sending Authenticated Channel Commands](#sending-authenticated-channel-commands).</span></span> <span data-ttu-id="91648-221">Esse comando contém os números de sequência iniciais para os comandos e consultas que são enviados para o canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-221">This command contains the starting sequence numbers for the commands and queries that are sent to the authenticated channel.</span></span>
9.  <span data-ttu-id="91648-222">Verifique o tipo de canal enviando uma consulta [**D3DAUTHENTICATEDQUERY_CHANNELTYPE**](d3dauthenticatedquery-channeltype.md) para o canal autenticado, conforme descrito na seção [enviando consultas de canal autenticado](#sending-authenticated-channel-queries).</span><span class="sxs-lookup"><span data-stu-id="91648-222">Verify the channel type by sending a [**D3DAUTHENTICATEDQUERY_CHANNELTYPE**](d3dauthenticatedquery-channeltype.md) query to the authenticated channel, as described in the section [Sending Authenticated Channel Queries](#sending-authenticated-channel-queries).</span></span> <span data-ttu-id="91648-223">Verifique se o tipo de canal corresponde ao que você especificou no método [**CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) .</span><span class="sxs-lookup"><span data-stu-id="91648-223">Check that the channel type matches what you specified in the [**CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) method.</span></span>

### <a name="3-configure-the-cryptographic-session"></a><span data-ttu-id="91648-224">3. configurar a sessão de criptografia</span><span class="sxs-lookup"><span data-stu-id="91648-224">3. Configure the Cryptographic Session</span></span>

<span data-ttu-id="91648-225">Em seguida, configure a sessão de criptografia e estabeleça a chave de sessão.</span><span class="sxs-lookup"><span data-stu-id="91648-225">Next, configure the cryptographic session and establish the session key.</span></span>

1.  <span data-ttu-id="91648-226">Chame [**IDirect3DDevice9Video:: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) para criar a sessão criptográfica.</span><span class="sxs-lookup"><span data-stu-id="91648-226">Call [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) to create the cryptographic session.</span></span> <span data-ttu-id="91648-227">Esse método retorna um ponteiro para a interface [**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9) e junto com um identificador para a sessão criptográfica.</span><span class="sxs-lookup"><span data-stu-id="91648-227">This method returns a pointer to the [**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9) interface and along with a handle to the cryptographic session.</span></span>
2.  <span data-ttu-id="91648-228">Chame [**IDirect3DCryptoSession9:: Getcertificates**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificatesize) para obter o tamanho do certificado X. 509 do driver.</span><span class="sxs-lookup"><span data-stu-id="91648-228">Call [**IDirect3DCryptoSession9::GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="91648-229">Aloque um buffer do tamanho necessário.</span><span class="sxs-lookup"><span data-stu-id="91648-229">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="91648-230">Chame [**IDirect3DCryptoSession9:: Getcertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificate) para obter o certificado.</span><span class="sxs-lookup"><span data-stu-id="91648-230">Call [**IDirect3DCryptoSession9::GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificate) to get the certificate.</span></span> <span data-ttu-id="91648-231">O método copia o certificado no buffer que foi alocado na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="91648-231">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="91648-232">Verifique se o certificado do driver foi assinado pela Microsoft e não foi revogado.</span><span class="sxs-lookup"><span data-stu-id="91648-232">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="91648-233">Obtenha a chave pública do certificado.</span><span class="sxs-lookup"><span data-stu-id="91648-233">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="91648-234">Gere uma chave de sessão de RSA aleatória.</span><span class="sxs-lookup"><span data-stu-id="91648-234">Generate a random RSA session key.</span></span> <span data-ttu-id="91648-235">Essa é uma chave de sessão separada da chave de sessão de canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-235">This is a separate session key from the authenticated channel session key.</span></span> <span data-ttu-id="91648-236">Criptografe a chave de sessão usando a chave pública do driver.</span><span class="sxs-lookup"><span data-stu-id="91648-236">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="91648-237">Chame [**IDirect3DCryptoSession9:: NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) para enviar a chave de sessão criptografada para o driver.</span><span class="sxs-lookup"><span data-stu-id="91648-237">Call [**IDirect3DCryptoSession9::NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="91648-238">Se os recursos de proteção de conteúdo incluírem **D3DCPCAPS_CONTENTKEY**, crie uma chave de conteúdo de RSA aleatória.</span><span class="sxs-lookup"><span data-stu-id="91648-238">If the content protection capabilities include **D3DCPCAPS_CONTENTKEY**, create a random RSA content key.</span></span> <span data-ttu-id="91648-239">Isso será usado posteriormente no processo de decodificação.</span><span class="sxs-lookup"><span data-stu-id="91648-239">This will be used later in the decoding process.</span></span>

### <a name="4-get-a-handle-to-the-dxva-decoder-device"></a><span data-ttu-id="91648-240">4. obter um identificador para o dispositivo de decodificador de DXVA</span><span class="sxs-lookup"><span data-stu-id="91648-240">4. Get a Handle to the DXVA Decoder Device</span></span>

<span data-ttu-id="91648-241">Para a próxima etapa, você precisará de um identificador para o dispositivo de decodificador DXVA.</span><span class="sxs-lookup"><span data-stu-id="91648-241">For the next step, you will need a handle to the DXVA decoder device.</span></span> <span data-ttu-id="91648-242">Para obter esse identificador, preencha uma estrutura de DXVA2_DecodeExecuteParams da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="91648-242">To get this handle, fill in a DXVA2_DecodeExecuteParams structure as follows:</span></span>


```C++
HANDLE hDecodeDeviceHandle;

DXVA2_DecodeExecuteParams execParams = {0};
DXVA2_DecodeExtensionData ExtensionExecute = {0};
    
execParams.NumCompBuffers = 0;
execParams.pCompressedBuffers = NULL;
execParams.pExtensionData = &ExtensionExecute;

ExtensionExecute.Function = DXVA2_DECODE_GET_DRIVER_HANDLE;
ExtensionExecute.pPrivateInputData = NULL;
ExtensionExecute.PrivateInputDataSize = 0;
ExtensionExecute.pPrivateOutputData = &hDecodeDeviceHandle;
ExtensionExecute.PrivateOutputDataSize = sizeof(HANDLE);
```



<span data-ttu-id="91648-243">Defina o membro **pExtensionData** da estrutura de [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) como o endereço de uma estrutura de [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) .</span><span class="sxs-lookup"><span data-stu-id="91648-243">Set the **pExtensionData** member of the [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) structure to the address of a [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) structure.</span></span>

<span data-ttu-id="91648-244">Na estrutura [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) , defina o membro da **função** como **DXVA2_DECODE_GET_DRIVER_HANDLE**.</span><span class="sxs-lookup"><span data-stu-id="91648-244">In the [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) structure, set the **Function** member to **DXVA2_DECODE_GET_DRIVER_HANDLE**.</span></span> <span data-ttu-id="91648-245">Defina **pPrivateOutputData** como o endereço de um buffer que é grande o suficiente para armazenar um valor de **identificador** .</span><span class="sxs-lookup"><span data-stu-id="91648-245">Set **pPrivateOutputData** to the address of a buffer that is large enough to store a **HANDLE** value.</span></span> <span data-ttu-id="91648-246">(No exemplo anterior, esse buffer é a variável *hDecodeDeviceHandle* ).</span><span class="sxs-lookup"><span data-stu-id="91648-246">(In the previous example, this buffer is the *hDecodeDeviceHandle* variable.)</span></span>

<span data-ttu-id="91648-247">Em seguida, chame [**IDirectXVideoDecoder:: execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) e passe o endereço da estrutura de [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) .</span><span class="sxs-lookup"><span data-stu-id="91648-247">Then call [**IDirectXVideoDecoder::Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) and pass in the address of the [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) structure.</span></span> <span data-ttu-id="91648-248">O identificador para o decodificador DXVA é retornado em **pPrivateOutputData**.</span><span class="sxs-lookup"><span data-stu-id="91648-248">The handle to the DXVA decoder is returned in **pPrivateOutputData**.</span></span>

### <a name="5-associate-the-dxva-decoder-with-the-cryptographic-session"></a><span data-ttu-id="91648-249">5. associar o decodificador de DXVA à sessão criptográfica</span><span class="sxs-lookup"><span data-stu-id="91648-249">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>

<span data-ttu-id="91648-250">Em seguida, associe o dispositivo de decodificador DXVA ao dispositivo Direct3D e à sessão criptográfica, da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="91648-250">Next, associate the DXVA decoder device with the Direct3D device and the cryptographic session, as follows:</span></span>

1.  <span data-ttu-id="91648-251">Obtenha um identificador para o dispositivo de decodificador DXVA, conforme descrito na seção anterior.</span><span class="sxs-lookup"><span data-stu-id="91648-251">Get a handle to the DXVA decoder device, as described in the previous section.</span></span>
2.  <span data-ttu-id="91648-252">Obtenha um identificador para o dispositivo Direct3D, enviando uma consulta [**D3DAUTHENTICATEDQUERY_DEVICEHANDLE**](d3dauthenticatedquery-devicehandle.md) para o canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-252">Get a handle to the Direct3D device, by sending a [**D3DAUTHENTICATEDQUERY_DEVICEHANDLE**](d3dauthenticatedquery-devicehandle.md) query to the authenticated channel.</span></span>
3.  <span data-ttu-id="91648-253">Preencha uma estrutura de [**D3DAUTHENTICATEDCHANNEL_CONFIGURECRYPTOSESSION**](d3dauthenticatedchannel-configurecryptosession.md) com as seguintes informações:</span><span class="sxs-lookup"><span data-stu-id="91648-253">Fill in a [**D3DAUTHENTICATEDCHANNEL_CONFIGURECRYPTOSESSION**](d3dauthenticatedchannel-configurecryptosession.md) structure with the following information:</span></span>
    -   <span data-ttu-id="91648-254">Defina o membro **DXVA2DecodeHandle** para o identificador para o dispositivo de decodificador DXVA.</span><span class="sxs-lookup"><span data-stu-id="91648-254">Set the **DXVA2DecodeHandle** member to the handle to the DXVA decoder device.</span></span>
    -   <span data-ttu-id="91648-255">Defina o membro **CryptoSessionHandle** para o identificador para a sessão de criptografia.</span><span class="sxs-lookup"><span data-stu-id="91648-255">Set the **CryptoSessionHandle** member to the handle to the cryptographic session.</span></span> <span data-ttu-id="91648-256">Esse identificador é retornado pelo método [**IDirect3DDevice9Video:: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) .</span><span class="sxs-lookup"><span data-stu-id="91648-256">This handle is returned by the [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) method.</span></span>
    -   <span data-ttu-id="91648-257">Defina o membro **DeviceHandle** para o identificador do dispositivo Direct3D.</span><span class="sxs-lookup"><span data-stu-id="91648-257">Set the **DeviceHandle** member to the Direct3D device handle.</span></span>
4.  <span data-ttu-id="91648-258">Chame [**IDirect3DAuthenticatedChannel9:: Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) para enviar um comando [**D3DAUTHENTICATEDCONFIGURE_CRYPTOSESSION**](d3dauthenticatedconfigure-cryptosession.md) para o canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-258">Call [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) to send a [**D3DAUTHENTICATEDCONFIGURE_CRYPTOSESSION**](d3dauthenticatedconfigure-cryptosession.md) command to the authenticated channel.</span></span>

<span data-ttu-id="91648-259">O diagrama a seguir ilustra a troca de identificadores:</span><span class="sxs-lookup"><span data-stu-id="91648-259">The following diagram illustrates the exchange of handles:</span></span>

![um diagrama que mostra como o decodificador DXVA está associado à sessão criptográfica.](images/d3d9video03.png)

<span data-ttu-id="91648-261">O decodificador de software agora pode usar a chave de sessão de criptografia para criptografar os buffers de vídeo compactados.</span><span class="sxs-lookup"><span data-stu-id="91648-261">The software decoder can now use the cryptographic session key to encrypt the compressed video buffers.</span></span> <span data-ttu-id="91648-262">Cada buffer compactado terá seu próprio vetor de inicialização (IV) especificado no membro **pvPVPState** da estrutura de [**DXVA2_DecodeBufferDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodebufferdesc) .</span><span class="sxs-lookup"><span data-stu-id="91648-262">Each compressed buffer will have its own initialization vector (IV) specified in the **pvPVPState** member of the [**DXVA2_DecodeBufferDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodebufferdesc) structure.</span></span>

## <a name="sending-authenticated-channel-commands"></a><span data-ttu-id="91648-263">Enviando comandos de canal autenticado</span><span class="sxs-lookup"><span data-stu-id="91648-263">Sending Authenticated Channel Commands</span></span>

<span data-ttu-id="91648-264">Um conjunto de comandos é definido para configurar o canal autenticado e definir várias proteções de conteúdo.</span><span class="sxs-lookup"><span data-stu-id="91648-264">A set of commands are defined for configuring the authenticated channel and setting various content protections.</span></span> <span data-ttu-id="91648-265">Para obter uma lista de comandos, consulte [proteção de conteúdo comandos](content-protection-commands.md).</span><span class="sxs-lookup"><span data-stu-id="91648-265">For a list of commands, see [Content Protection Commands](content-protection-commands.md).</span></span>

<span data-ttu-id="91648-266">Para enviar um comando para o canal autenticado, execute as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="91648-266">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="91648-267">Preencha a estrutura de dados de entrada.</span><span class="sxs-lookup"><span data-stu-id="91648-267">Fill in the input data structure.</span></span> <span data-ttu-id="91648-268">Essa estrutura de dados é sempre uma estrutura de [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT**](d3dauthenticatedchannel-configure-input.md) seguida por campos adicionais.</span><span class="sxs-lookup"><span data-stu-id="91648-268">This data structure is always a [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT**](d3dauthenticatedchannel-configure-input.md) structure followed by additional fields.</span></span> <span data-ttu-id="91648-269">Preencha a estrutura de **D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT** , conforme mostrado na tabela a seguir.</span><span class="sxs-lookup"><span data-stu-id="91648-269">Fill in the **D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="91648-270">Membro</span><span class="sxs-lookup"><span data-stu-id="91648-270">Member</span></span></th>
    <th><span data-ttu-id="91648-271">DESCRIÇÃO</span><span class="sxs-lookup"><span data-stu-id="91648-271">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="91648-272"><strong>omac</strong></span><span class="sxs-lookup"><span data-stu-id="91648-272"><strong>omac</strong></span></span></td>
    <td><span data-ttu-id="91648-273">Ignore este campo por enquanto.</span><span class="sxs-lookup"><span data-stu-id="91648-273">Skip this field for now.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="91648-274"><strong>Configuratype</strong></span><span class="sxs-lookup"><span data-stu-id="91648-274"><strong>ConfigureType</strong></span></span></td>
    <td><span data-ttu-id="91648-275">GUID que identifica o comando.</span><span class="sxs-lookup"><span data-stu-id="91648-275">GUID that identifies the command.</span></span> <span data-ttu-id="91648-276">Para obter uma lista de comandos, consulte <a href="content-protection-commands.md">proteção de conteúdo comandos</a>.</span><span class="sxs-lookup"><span data-stu-id="91648-276">For a list of commands, see <a href="content-protection-commands.md">Content Protection Commands</a>.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="91648-277"><strong>hChannel</strong></span><span class="sxs-lookup"><span data-stu-id="91648-277"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="91648-278">O identificador para o canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-278">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="91648-279"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="91648-279"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="91648-280">O número de sequência.</span><span class="sxs-lookup"><span data-stu-id="91648-280">The sequence number.</span></span> <span data-ttu-id="91648-281">O primeiro número de sequência é especificado com o envio de um comando <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="91648-281">The first sequence number is specified by sending a <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="91648-282">Cada vez que você enviar outro comando, aumente esse número em 1.</span><span class="sxs-lookup"><span data-stu-id="91648-282">Each time you send another command, increment this number by 1.</span></span> <span data-ttu-id="91648-283">O número de sequência protege contra ataques de repetição.</span><span class="sxs-lookup"><span data-stu-id="91648-283">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="91648-284">Dois números de sequência separados são usados, um para comandos e outro para consultas.</span><span class="sxs-lookup"><span data-stu-id="91648-284">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="91648-285">Calcule a marca OMAC para o bloco de dados que aparece após o membro **OMAC** da estrutura de entrada.</span><span class="sxs-lookup"><span data-stu-id="91648-285">Calculate the OMAC tag for the block of data that appears after the **omac** member of the input structure.</span></span> <span data-ttu-id="91648-286">Em seguida, copie esse valor de marca para o membro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="91648-286">Then copy this tag value into the **omac** member.</span></span>
3.  <span data-ttu-id="91648-287">Chame [**IDirect3DAuthenticatedChannel9:: Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure).</span><span class="sxs-lookup"><span data-stu-id="91648-287">Call [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure).</span></span>
4.  <span data-ttu-id="91648-288">O driver coloca a saída do comando na estrutura de [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_OUTPUT**](d3dauthenticatedchannel-configure-output.md) .</span><span class="sxs-lookup"><span data-stu-id="91648-288">The driver places the output from the command in the [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_OUTPUT**](d3dauthenticatedchannel-configure-output.md) structure.</span></span>
5.  <span data-ttu-id="91648-289">Calcule a marca OMAC para o bloco de dados que aparece após o membro **OMAC** da estrutura de saída.</span><span class="sxs-lookup"><span data-stu-id="91648-289">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="91648-290">Compare isso com o valor do membro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="91648-290">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="91648-291">Falha se eles não corresponderem.</span><span class="sxs-lookup"><span data-stu-id="91648-291">Fail if they do not match.</span></span>
6.  <span data-ttu-id="91648-292">Compare os valores dos membros **configuratype**, **hChannel** e **SequenceNumber** na estrutura de saída com seus valores para esses membros.</span><span class="sxs-lookup"><span data-stu-id="91648-292">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="91648-293">Falha se eles não corresponderem.</span><span class="sxs-lookup"><span data-stu-id="91648-293">Fail if they do not match.</span></span>
7.  <span data-ttu-id="91648-294">Incrementar o número de sequência para o próximo comando.</span><span class="sxs-lookup"><span data-stu-id="91648-294">Increment the sequence number for the next command.</span></span>

## <a name="sending-authenticated-channel-queries"></a><span data-ttu-id="91648-295">Enviando consultas de canal autenticado</span><span class="sxs-lookup"><span data-stu-id="91648-295">Sending Authenticated Channel Queries</span></span>

<span data-ttu-id="91648-296">Um conjunto de consultas é definido para recuperar informações sobre o canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-296">A set of queries are defined for retrieving information about the authenticated channel.</span></span> <span data-ttu-id="91648-297">Para obter uma lista de consultas, consulte [proteção de conteúdo consultas](content-protection-queries.md).</span><span class="sxs-lookup"><span data-stu-id="91648-297">For a list of queries, see [Content Protection Queries](content-protection-queries.md).</span></span>

<span data-ttu-id="91648-298">Para enviar um comando para o canal autenticado, execute as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="91648-298">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="91648-299">Preencha a estrutura de dados de entrada.</span><span class="sxs-lookup"><span data-stu-id="91648-299">Fill in the input data structure.</span></span> <span data-ttu-id="91648-300">Essa estrutura de dados é sempre uma estrutura de [**D3DAUTHENTICATEDCHANNEL_QUERY_INPUT**](d3dauthenticatedchannel-query-input.md) , possivelmente seguida por campos adicionais.</span><span class="sxs-lookup"><span data-stu-id="91648-300">This data structure is always a [**D3DAUTHENTICATEDCHANNEL_QUERY_INPUT**](d3dauthenticatedchannel-query-input.md) structure, possibly followed by additional fields.</span></span> <span data-ttu-id="91648-301">Preencha a estrutura de **D3DAUTHENTICATEDCHANNEL_QUERY_INPUT** , conforme mostrado na tabela a seguir.</span><span class="sxs-lookup"><span data-stu-id="91648-301">Fill in the **D3DAUTHENTICATEDCHANNEL_QUERY_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="91648-302">Membro</span><span class="sxs-lookup"><span data-stu-id="91648-302">Member</span></span></th>
    <th><span data-ttu-id="91648-303">DESCRIÇÃO</span><span class="sxs-lookup"><span data-stu-id="91648-303">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="91648-304"><strong>QueryType</strong></span><span class="sxs-lookup"><span data-stu-id="91648-304"><strong>QueryType</strong></span></span></td>
    <td><span data-ttu-id="91648-305">GUID que identifica a consulta.</span><span class="sxs-lookup"><span data-stu-id="91648-305">GUID that identifies the query.</span></span> <span data-ttu-id="91648-306">Para obter uma lista de consultas, consulte <a href="content-protection-queries.md">proteção de conteúdo consultas</a>.</span><span class="sxs-lookup"><span data-stu-id="91648-306">For a list of queries, see <a href="content-protection-queries.md">Content Protection Queries</a>.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="91648-307"><strong>hChannel</strong></span><span class="sxs-lookup"><span data-stu-id="91648-307"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="91648-308">O identificador para o canal autenticado.</span><span class="sxs-lookup"><span data-stu-id="91648-308">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="91648-309"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="91648-309"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="91648-310">O número de sequência.</span><span class="sxs-lookup"><span data-stu-id="91648-310">The sequence number.</span></span> <span data-ttu-id="91648-311">O primeiro número de sequência é especificado com o envio de um comando <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="91648-311">The first sequence number is specified by sending a <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="91648-312">Cada vez que você enviar outra consulta, aumente esse número em 1.</span><span class="sxs-lookup"><span data-stu-id="91648-312">Each time you send another query, increment this number by 1.</span></span> <span data-ttu-id="91648-313">O número de sequência protege contra ataques de repetição.</span><span class="sxs-lookup"><span data-stu-id="91648-313">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="91648-314">Dois números de sequência separados são usados, um para comandos e outro para consultas.</span><span class="sxs-lookup"><span data-stu-id="91648-314">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="91648-315">Chame [**IDirect3DAuthenticatedChannel9:: Query**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-query).</span><span class="sxs-lookup"><span data-stu-id="91648-315">Call [**IDirect3DAuthenticatedChannel9::Query**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-query).</span></span>
3.  <span data-ttu-id="91648-316">O driver coloca a saída da consulta em uma estrutura de [**D3DAUTHENTICATEDCHANNEL_QUERY_OUTPUT**](d3dauthenticatedchannel-query-output.md) .</span><span class="sxs-lookup"><span data-stu-id="91648-316">The driver places the output from the query in a [**D3DAUTHENTICATEDCHANNEL_QUERY_OUTPUT**](d3dauthenticatedchannel-query-output.md) structure.</span></span> <span data-ttu-id="91648-317">Essa estrutura é seguida por campos adicionais, dependendo do tipo de consulta.</span><span class="sxs-lookup"><span data-stu-id="91648-317">This structure is followed by additional fields, depending on the query type.</span></span>
4.  <span data-ttu-id="91648-318">Calcule a marca OMAC para o bloco de dados que aparece após o membro **OMAC** da estrutura de saída.</span><span class="sxs-lookup"><span data-stu-id="91648-318">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="91648-319">Compare isso com o valor do membro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="91648-319">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="91648-320">Falha se eles não corresponderem.</span><span class="sxs-lookup"><span data-stu-id="91648-320">Fail if they do not match.</span></span>
5.  <span data-ttu-id="91648-321">Compare os valores dos membros **configuratype**, **hChannel** e **SequenceNumber** na estrutura de saída com seus valores para esses membros.</span><span class="sxs-lookup"><span data-stu-id="91648-321">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="91648-322">Falha se eles não corresponderem.</span><span class="sxs-lookup"><span data-stu-id="91648-322">Fail if they do not match.</span></span>
6.  <span data-ttu-id="91648-323">Incrementar o número de sequência para a próxima consulta.</span><span class="sxs-lookup"><span data-stu-id="91648-323">Increment the sequence number for the next query.</span></span>

## <a name="related-topics"></a><span data-ttu-id="91648-324">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="91648-324">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="91648-325">APIs de vídeo do Direct3D 9</span><span class="sxs-lookup"><span data-stu-id="91648-325">Direct3D 9 Video APIs</span></span>](direct3d-video-apis.md)
</dt> </dl>

 

 
