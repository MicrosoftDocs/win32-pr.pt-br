---
title: Autenticação (BITS)
description: O BITS dá suporte à autenticação básica, autenticação do Passport e vários esquemas de autenticação de desafio/resposta.
ms.assetid: cfd4aec3-79d0-4971-93f8-df797e5c0f75
ms.topic: article
ms.date: 10/09/2018
ms.openlocfilehash: 5d970956676a3348dd4b8c4b420e044bd4714775
ms.sourcegitcommit: 8fa6614b715bddf14648cce36d2df22e5232801a
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/10/2020
ms.locfileid: "103917889"
---
# <a name="authentication-bits"></a><span data-ttu-id="333f3-103">Autenticação (BITS)</span><span class="sxs-lookup"><span data-stu-id="333f3-103">Authentication (BITS)</span></span>

<span data-ttu-id="333f3-104">O BITS dá suporte à autenticação básica, autenticação do Passport e vários esquemas de autenticação de desafio/resposta.</span><span class="sxs-lookup"><span data-stu-id="333f3-104">BITS supports Basic authentication, Passport authentication, and several challenge/response authentication schemes.</span></span> <span data-ttu-id="333f3-105">Se o servidor ou proxy exigir autenticação de usuário, use a função [**IBackgroundCopyJob2:: SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) para especificar as credenciais do usuário.</span><span class="sxs-lookup"><span data-stu-id="333f3-105">If the server or proxy requires user authentication, use the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user's credentials.</span></span> <span data-ttu-id="333f3-106">O BITS usa o [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) para proteger as credenciais.</span><span class="sxs-lookup"><span data-stu-id="333f3-106">BITS uses the [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) to protect the credentials.</span></span>

<span data-ttu-id="333f3-107">Para definir credenciais para autenticação básica, use a função [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) para especificar o nome de usuário e a senha.</span><span class="sxs-lookup"><span data-stu-id="333f3-107">To set credentials for Basic authentication use the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user name and password.</span></span> <span data-ttu-id="333f3-108">Você só deve usar a autenticação básica com sites seguros protegidos pelo https://; caso contrário, o nome de usuário e a senha ficarão visíveis para os usuários.</span><span class="sxs-lookup"><span data-stu-id="333f3-108">You should only use Basic authentication with https:// protected secure websites; otherwise the username and password will be visible to users.</span></span> 

<span data-ttu-id="333f3-109">É possível inserir o nome de usuário e a senha na URL.</span><span class="sxs-lookup"><span data-stu-id="333f3-109">It's possible to embed the user name and password in the URL.</span></span> <span data-ttu-id="333f3-110">Isso não é considerado uma boa prática de segurança e é preterido no RFC 3986 (seção 3.2.1).</span><span class="sxs-lookup"><span data-stu-id="333f3-110">This is not considered a good security practice, and is deprecated in RFC 3986 (section 3.2.1).</span></span>

<span data-ttu-id="333f3-111">Para a autenticação do [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) , o bits dá suporte apenas a credenciais explícitas, não a credenciais implícitas ligadas à conta.</span><span class="sxs-lookup"><span data-stu-id="333f3-111">For [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) authentication, BITS supports explicit credentials only, not implicit credentials tied to the account.</span></span>

<span data-ttu-id="333f3-112">Para a autenticação de desafio/resposta, o BITS representa o usuário e usa [Snego](../com/snego.md) para determinar qual autenticação de desafio/resposta usar, como NTLM ou o protocolo Kerberos.</span><span class="sxs-lookup"><span data-stu-id="333f3-112">For challenge/response authentication, BITS impersonates the user and uses [Snego](../com/snego.md) to determine which challenge/response authentication to use, such as NTLM or the Kerberos protocol.</span></span> <span data-ttu-id="333f3-113">Para obter uma lista de esquemas de desafio/resposta aos quais o BITS dá suporte, consulte [**BG \_ auth \_ Scheme**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span><span class="sxs-lookup"><span data-stu-id="333f3-113">For a list of challenge/response schemes that BITS supports, see [**BG\_AUTH\_SCHEME**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span></span>

<span data-ttu-id="333f3-114">Os trabalhos do BITS poderão falhar se o diretório virtual no servidor tiver autenticação anônima e outro esquema de autenticação habilitado e se as ACLs protegerem o diretório virtual ou os arquivos de download.</span><span class="sxs-lookup"><span data-stu-id="333f3-114">BITS jobs can fail if the virtual directory on the server has anonymous authentication and another authentication scheme enabled and if ACLs protect the virtual directory or download files.</span></span> <span data-ttu-id="333f3-115">Por exemplo, um trabalho falhará com "acesso negado" se o diretório virtual tiver a autenticação anônima e integrada habilitada e o arquivo contiver uma ACL que permita apenas Ben ler o arquivo.</span><span class="sxs-lookup"><span data-stu-id="333f3-115">For example, a job fails with "access denied" if the virtual directory has anonymous and integrated authentication enabled and the file contains an ACL that allows only Ben to read the file.</span></span> <span data-ttu-id="333f3-116">Isso ocorre porque o diretório virtual permite acesso anônimo, portanto o IIS não autentica explicitamente Ben (as credenciais de Ben não são usadas para acessar o arquivo e o acesso é negado).</span><span class="sxs-lookup"><span data-stu-id="333f3-116">This occurs because the virtual directory allows anonymous access, so IIS does not explicitly authenticate Ben (Ben's credentials are not used to access the file and access is denied).</span></span>

## <a name="using-implicit-credentials"></a><span data-ttu-id="333f3-117">Usando credenciais implícitas</span><span class="sxs-lookup"><span data-stu-id="333f3-117">Using implicit credentials</span></span>

<span data-ttu-id="333f3-118">Para usar as credenciais implícitas (logon) do usuário para autenticação NTLM ou Kerberos, chame o método [**IBackgroundCopyJob2:: SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) e defina os membros **nome de usuário** e **senha** da estrutura de [**\_ \_ credenciais básica BG**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) como **NULL**.</span><span class="sxs-lookup"><span data-stu-id="333f3-118">To use the user's implicit (logon) credentials for NTLM or Kerberos authentication, call the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method and set the **UserName** and **Password** members of the [**BG\_BASIC\_CREDENTIALS**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) structure to **NULL**.</span></span> <span data-ttu-id="333f3-119">Se você especificar credenciais implícitas para um proxy, os BITS também usarão as credenciais implícitas para autenticação de servidor, a menos que você especifique credenciais de servidor explícitas.</span><span class="sxs-lookup"><span data-stu-id="333f3-119">If you specify implicit credentials for a proxy, BITS will also use the implicit credentials for server authentication unless you specify explicit server credentials.</span></span>

<span data-ttu-id="333f3-120">Para obter informações adicionais para serviços, consulte [contas de serviço e bits](service-accounts-and-bits.md).</span><span class="sxs-lookup"><span data-stu-id="333f3-120">For additional information for services, see [Service Accounts and BITS](service-accounts-and-bits.md).</span></span>

<span data-ttu-id="333f3-121">Você também pode alterar o valor do registro **LmCompatibilityLevel** ou **UseLMCompat** ; no entanto, você deve alterar esses valores somente se tiver um aplicativo existente que não pode ser alterado para chamar o método [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="333f3-121">You could also change the **LMCompatibilityLevel** or **UseLMCompat** registry value; however, you should change these values only if you have an existing application that cannot be changed to call the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span>

<span data-ttu-id="333f3-122">O BITS usará credenciais implícitas para autenticação se o valor do registro **LmCompatibilityLevel** for dois ou maior, e você não tiver chamado o método [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="333f3-122">BITS will use implicit credentials for authentication if the **LMCompatibilityLevel** registry value is two or greater, and you have not called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span> <span data-ttu-id="333f3-123">O caminho completo para o valor do registro **LmCompatibilityLevel** é **HKEY \_ local \_ Machine** \\ **System** \\ **CurrentControlSet** \\ **Control** \\ **LSA** \\ **LmCompatibilityLevel**.</span><span class="sxs-lookup"><span data-stu-id="333f3-123">The full path to the **LMCompatibilityLevel** registry value is **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**LSA**\\**LmCompatibilityLevel**.</span></span>

<span data-ttu-id="333f3-124">Observe que alterar o valor do registro **LmCompatibilityLevel** pode afetar outros aplicativos e serviços em execução no computador.</span><span class="sxs-lookup"><span data-stu-id="333f3-124">Note that changing the **LMCompatibilityLevel** registry value can affect other applications and services running on the computer.</span></span> <span data-ttu-id="333f3-125">Para obter mais informações sobre como usar o valor do registro **LmCompatibilityLevel** , consulte [KB147706](https://support.microsoft.com/kb/147706).</span><span class="sxs-lookup"><span data-stu-id="333f3-125">For more information about using the **LMCompatibilityLevel** registry value, see [KB147706](https://support.microsoft.com/kb/147706).</span></span>

<span data-ttu-id="333f3-126">Se a definição do valor do registro **LmCompatibilityLevel** for um problema, você poderá criar o valor do registro **UseLMCompat** em **HKEY \_ local \_ Machine** \\ **software** \\ **Microsoft** \\ **Windows** \\ **CurrentVersion** \\ **bits**.</span><span class="sxs-lookup"><span data-stu-id="333f3-126">If setting the **LMCompatibilityLevel** registry value is an issue, you can create the **UseLMCompat** registry value under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Windows**\\**CurrentVersion**\\**BITS**.</span></span> <span data-ttu-id="333f3-127">O valor do registro é um DWORD.</span><span class="sxs-lookup"><span data-stu-id="333f3-127">The registry value is a DWORD.</span></span> <span data-ttu-id="333f3-128">A tabela a seguir lista os possíveis valores para **UseLMCompat**:</span><span class="sxs-lookup"><span data-stu-id="333f3-128">The following table lists the possible values for **UseLMCompat**:</span></span>

|<span data-ttu-id="333f3-129">Valor</span><span class="sxs-lookup"><span data-stu-id="333f3-129">Value</span></span>|<span data-ttu-id="333f3-130">Descrição</span><span class="sxs-lookup"><span data-stu-id="333f3-130">Description</span></span>|
|-|-|
| <span data-ttu-id="333f3-131">0</span><span class="sxs-lookup"><span data-stu-id="333f3-131">0</span></span>     | <span data-ttu-id="333f3-132">O BITS enviará credenciais implícitas sempre que o servidor solicitar credenciais NTLM ou Kerberos.</span><span class="sxs-lookup"><span data-stu-id="333f3-132">BITS will send implicit credentials whenever the server prompts for NTLM or Kerberos credentials.</span></span>                                                                                           |
| <span data-ttu-id="333f3-133">1</span><span class="sxs-lookup"><span data-stu-id="333f3-133">1</span></span>     | <span data-ttu-id="333f3-134">O BITS enviará credenciais implícitas somente se o valor do registro **LmCompatibilityLevel** do computador cliente for maior ou igual a 2.</span><span class="sxs-lookup"><span data-stu-id="333f3-134">BITS will send implicit credentials only if the client computer's **LMCompatibilityLevel** registry value is greater than or equal to 2.</span></span><br/>     |
| <span data-ttu-id="333f3-135">2</span><span class="sxs-lookup"><span data-stu-id="333f3-135">2</span></span>     | <span data-ttu-id="333f3-136">O BITS enviará credenciais implícitas somente se o aplicativo tiver chamado o método [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="333f3-136">BITS will send implicit credentials only if the application called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span><br/> |

<span data-ttu-id="333f3-137">Os BITS usarão um valor padrão de "2" para o valor do registro **UseLMCompat** se o valor do registro não existir.</span><span class="sxs-lookup"><span data-stu-id="333f3-137">BITS will use a default value of "2" for the **UseLMCompat** registry value if the registry value does not exist.</span></span>

## <a name="using-certificates-for-clientserver-authentication"></a><span data-ttu-id="333f3-138">Usando certificados para autenticação de cliente/servidor</span><span class="sxs-lookup"><span data-stu-id="333f3-138">Using certificates for client/server authentication</span></span>

<span data-ttu-id="333f3-139">Na comunicação segura do cliente/servidor, os clientes e servidores podem usar certificados digitais para se autenticar mutuamente.</span><span class="sxs-lookup"><span data-stu-id="333f3-139">In secure client/server communication, clients and servers can use digital certificates to mutually authenticate each other.</span></span> <span data-ttu-id="333f3-140">O BITS dá suporte automaticamente à autenticação de servidor baseada em certificado para transportes HTTP seguros.</span><span class="sxs-lookup"><span data-stu-id="333f3-140">BITS automatically supports certificate-based server authentication for secure HTTP transports.</span></span> <span data-ttu-id="333f3-141">Para fornecer BITS o certificado de cliente necessário para a autenticação mútua, chame o método [**IBackgroundCopyJobHttpOptions:: SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) ou [**IBackgroundCopyJobHttpOptions:: SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) .</span><span class="sxs-lookup"><span data-stu-id="333f3-141">To provide BITS the client certificate needed for mutual authentication, call either the [**IBackgroundCopyJobHttpOptions::SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) or [**IBackgroundCopyJobHttpOptions::SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) method.</span></span>

<span data-ttu-id="333f3-142">Quando um site aceita, mas não requer um certificado de cliente SSL, e o trabalho BITS não especifica um certificado de cliente, o trabalho falhará com o **erro \_ WinHTTP \_ Client \_ auth \_ CERT \_ necessário** (0x80072f0c).</span><span class="sxs-lookup"><span data-stu-id="333f3-142">When a website accepts but does not require an SSL client certificate, and the BITS job does not specify a client certificate, the job will fail with **ERROR\_WINHTTP\_CLIENT\_AUTH\_CERT\_NEEDED** (0x80072f0c).</span></span>

## <a name="how-to-handle-authenticated-proxy-scenarios-that-require-user-specific-settings"></a><span data-ttu-id="333f3-143">Como lidar com cenários de proxy autenticados que exigem configurações específicas do usuário</span><span class="sxs-lookup"><span data-stu-id="333f3-143">How to handle authenticated proxy scenarios that require user-specific settings</span></span>

<span data-ttu-id="333f3-144">Se você estiver usando BITS em um ambiente que exija autenticação de proxy durante a execução como uma conta sem credenciais NTLM ou Kerberos utilizáveis no domínio de rede da máquina, será necessário executar etapas adicionais para autenticar corretamente usando as credenciais de outra conta de usuário que tenha credenciais no domínio.</span><span class="sxs-lookup"><span data-stu-id="333f3-144">If you are using BITS in an environment that requires proxy authentication while running as an account without usable NTLM or Kerberos credentials in the machine's network domain, you must take extra steps to authenticate properly by using the credentials of another user account that does have credentials on the domain.</span></span> <span data-ttu-id="333f3-145">Esse é um cenário típico quando o código BITS está sendo executado como um serviço de sistema, como LocalService, NetworkService ou LocalSystem, pois essas contas não têm credenciais NTLM ou Kerberos utilizáveis.</span><span class="sxs-lookup"><span data-stu-id="333f3-145">This is a typical scenario when your BITS code is running as a system service such as LocalService, NetworkService, or LocalSystem, as those accounts do not have usable NTLM or Kerberos credentials.</span></span>

<span data-ttu-id="333f3-146">A lógica de detecção de proxy usada em BITS faz o seguinte quando um token auxiliar de rede ( \_ rede de token BG \_ ) é definido:</span><span class="sxs-lookup"><span data-stu-id="333f3-146">The proxy detection logic used in BITS does the following when a network helper token (BG\_TOKEN\_NETWORK) is set:</span></span>

-   <span data-ttu-id="333f3-147">Se [**método ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) foi chamado com **a \_ \_ configuração de \_ uso \_ de proxy de trabalho BG**, leia as configurações de proxy do IE local usando a representação do contexto do token do proprietário do trabalho por meio de [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="333f3-147">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**, then read local IE proxy settings using job owner token context impersonation via [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="333f3-148">A partir do Windows 10, versão 1809 (10,0; Build 17763), a identidade do token auxiliar é usada para esta etapa.</span><span class="sxs-lookup"><span data-stu-id="333f3-148">Starting in Windows 10, version 1809 (10.0; Build 17763), the helper token identity is used for this step.</span></span>
-   <span data-ttu-id="333f3-149">Se [**método ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) for chamado com a detecção automática de uso de proxy de BG ou se as configurações do IE do caso de configuração de uso do proxy de trabalho BG especificarem uma **\_ \_ \_ \_ AutoConfig** ou uma URL de configuração automática, realize a detecção de proxy automático ou o protocolo de descoberta automática de proxy da Web (WPAD), usando a representação de token auxiliar via [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl). **\_ \_ \_**</span><span class="sxs-lookup"><span data-stu-id="333f3-149">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_PROXY\_USAGE\_AUTODETECT** or if the IE settings from the **BG\_JOB\_PROXY\_USAGE\_PRECONFIG** case specify auto-detect or an auto-config URL, then conduct auto-proxy detection, or Web Proxy Autodiscovery Protocol (WPAD), using helper token impersonation via [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl).</span></span>

<span data-ttu-id="333f3-150">Depois disso, a representação do token auxiliar é usada para autenticação de proxy ou de servidor em todo o.</span><span class="sxs-lookup"><span data-stu-id="333f3-150">After that, helper token impersonation is used for proxy or server authentication throughout.</span></span>

<span data-ttu-id="333f3-151">A partir do Windows 10, versão 1809 (10,0; Build 17763), o cenário de proxy autenticado com credenciais específicas do usuário é simplificado.</span><span class="sxs-lookup"><span data-stu-id="333f3-151">Starting in Windows 10, version 1809 (10.0; Build 17763), the authenticated proxy scenario with user-specific credentials is simplified.</span></span>

1.  <span data-ttu-id="333f3-152">Chame o método [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) do trabalho do bits com o **BG \_ auth \_ Scheme \_ Negotiate**, *username* definido como **NULL**, *password* Set como **null** e *target* Set como **BG \_ auth \_ target \_ proxy**.</span><span class="sxs-lookup"><span data-stu-id="333f3-152">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="333f3-153">Isso faz com que as credenciais implícitas da conta do usuário sejam usadas para a autenticação NTLM e Kerberos com o proxy e o servidor.</span><span class="sxs-lookup"><span data-stu-id="333f3-153">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
2.  <span data-ttu-id="333f3-154">Chame [**método ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) com o **BG \_ uso de proxy de trabalho de \_ \_ \_ configuração**.</span><span class="sxs-lookup"><span data-stu-id="333f3-154">Call [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**.</span></span>
3.  <span data-ttu-id="333f3-155">QueryInterface para [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="333f3-155">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
4.  <span data-ttu-id="333f3-156">Representar a conta de usuário que você está usando para credenciais NTLM/Kerberos.</span><span class="sxs-lookup"><span data-stu-id="333f3-156">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
5.  <span data-ttu-id="333f3-157">Chame [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span><span class="sxs-lookup"><span data-stu-id="333f3-157">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
6. <span data-ttu-id="333f3-158">Chame [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) com **a \_ \_ rede de token bg**.</span><span class="sxs-lookup"><span data-stu-id="333f3-158">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
7. <span data-ttu-id="333f3-159">Reverta a representação.</span><span class="sxs-lookup"><span data-stu-id="333f3-159">Revert impersonation.</span></span>
8. <span data-ttu-id="333f3-160">Continuar a instalação do trabalho.</span><span class="sxs-lookup"><span data-stu-id="333f3-160">Continue job setup.</span></span>
9. <span data-ttu-id="333f3-161">Chame [**resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) no trabalho.</span><span class="sxs-lookup"><span data-stu-id="333f3-161">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>

<span data-ttu-id="333f3-162">Antes do Windows 10, versão 1809 (10,0; Build 17763), a identidade de usuário correta (a identidade do token auxiliar) é usada para a detecção de proxy baseada em rede (WPAD) e para autenticação de proxy, mas a detecção real de configurações de proxy locais (IE) é sempre feita usando o token do proprietário do trabalho, mesmo quando um token auxiliar é configurado.</span><span class="sxs-lookup"><span data-stu-id="333f3-162">Before Windows 10, version 1809 (10.0; Build 17763), the correct user identity (the helper token's identity) is used for network-based proxy detection (WPAD) and for proxy authentication, but the actual detection of local (IE) proxy settings is always done using the job owner's token, even when a helper token is configured.</span></span> <span data-ttu-id="333f3-163">Para contornar essa deficiência, você pode seguir estas etapas.</span><span class="sxs-lookup"><span data-stu-id="333f3-163">To work around this shortcoming, you can follow these steps.</span></span>

1.  <span data-ttu-id="333f3-164">Representar a conta de usuário que você está usando para credenciais NTLM/Kerberos.</span><span class="sxs-lookup"><span data-stu-id="333f3-164">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
2.  <span data-ttu-id="333f3-165">Recupere as configurações de proxy do IE da conta de usuário chamando [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="333f3-165">Retrieve the user account's IE proxy settings by calling [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span>
3.  <span data-ttu-id="333f3-166">Reverta a representação.</span><span class="sxs-lookup"><span data-stu-id="333f3-166">Revert impersonation.</span></span>
4.  <span data-ttu-id="333f3-167">Chame o método [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) do trabalho do bits com o **BG \_ auth \_ Scheme \_ Negotiate**, *username* definido como **NULL**, *password* Set como **null** e *target* Set como **BG \_ auth \_ target \_ proxy**.</span><span class="sxs-lookup"><span data-stu-id="333f3-167">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="333f3-168">Isso faz com que as credenciais implícitas da conta do usuário sejam usadas para a autenticação NTLM e Kerberos com o proxy e o servidor.</span><span class="sxs-lookup"><span data-stu-id="333f3-168">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
5.  <span data-ttu-id="333f3-169">Se a etapa 2 gerou quaisquer configurações de proxy específicas de usuário (ou seja, *lpszProxy* ou *LpszProxyBypass* não forem **nulas**), defina as configurações de trabalho correspondentes manualmente, usando [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) com a configuração de substituição de uso de **proxy de \_ trabalho \_ \_ \_ BG** .</span><span class="sxs-lookup"><span data-stu-id="333f3-169">If step 2 yielded any user-specific proxy settings (i.e. *lpszProxy* or *lpszProxyBypass* are not **NULL**), set the corresponding job settings manually, using [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with the **BG\_JOB\_PROXY\_USAGE\_OVERRIDE** setting.</span></span>
6.  <span data-ttu-id="333f3-170">Se a etapa 2 não gerar nenhuma configuração de proxy específica do usuário, chame [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) com o **BG uso de trabalho de \_ \_ \_ configuração**.</span><span class="sxs-lookup"><span data-stu-id="333f3-170">If step 2 did not yield any user-specific proxy settings, call [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_USAGE\_PRECONFIG**.</span></span>
7.  <span data-ttu-id="333f3-171">QueryInterface para [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="333f3-171">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
8.  <span data-ttu-id="333f3-172">Represente a conta de usuário.</span><span class="sxs-lookup"><span data-stu-id="333f3-172">Impersonate the user account again.</span></span>
9.  <span data-ttu-id="333f3-173">Chame [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span><span class="sxs-lookup"><span data-stu-id="333f3-173">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
10. <span data-ttu-id="333f3-174">Chame [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) com **a \_ \_ rede de token bg**.</span><span class="sxs-lookup"><span data-stu-id="333f3-174">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
11. <span data-ttu-id="333f3-175">Reverta a representação.</span><span class="sxs-lookup"><span data-stu-id="333f3-175">Revert impersonation.</span></span>
12. <span data-ttu-id="333f3-176">Continuar a instalação do trabalho.</span><span class="sxs-lookup"><span data-stu-id="333f3-176">Continue job setup.</span></span>
13. <span data-ttu-id="333f3-177">Chame [**resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) no trabalho.</span><span class="sxs-lookup"><span data-stu-id="333f3-177">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>
