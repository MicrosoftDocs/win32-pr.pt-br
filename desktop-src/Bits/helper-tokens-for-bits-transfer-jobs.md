---
title: Tokens auxiliares para trabalhos de transferência de BITS
description: Tokens auxiliares para trabalhos de transferência de BITS
ms.assetid: f29f9870-e406-472b-9342-203def7453ae
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 52925a6e0d5a9601e21848d514214bfb843f6246
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/20/2020
ms.locfileid: "104454334"
---
# <a name="helper-tokens-for-bits-transfer-jobs"></a><span data-ttu-id="4efa6-103">Tokens auxiliares para trabalhos de transferência de BITS</span><span class="sxs-lookup"><span data-stu-id="4efa6-103">Helper Tokens for BITS Transfer Jobs</span></span>

<span data-ttu-id="4efa6-104">No Windows Vista, o serviço de Serviço de Transferência Inteligente em Segundo Plano (BITS) permite que um aplicativo associe um único token de segurança a um trabalho de transferência de BITS.</span><span class="sxs-lookup"><span data-stu-id="4efa6-104">In Windows Vista, the Background Intelligent Transfer Service (BITS) service allows an application to associate a single security token to a BITS transfer job.</span></span> <span data-ttu-id="4efa6-105">O trabalho de transferência de BITS usa esse token para autenticação e para acesso a recursos locais e remotos.</span><span class="sxs-lookup"><span data-stu-id="4efa6-105">The BITS transfer job then uses this token for authentication and for access to local and remote resources.</span></span>

<span data-ttu-id="4efa6-106">No Windows 7, o serviço BITS associa um token adicional a um trabalho de transferência de BITS.</span><span class="sxs-lookup"><span data-stu-id="4efa6-106">In Windows 7, the BITS service associates an additional token to a BITS transfer job.</span></span> <span data-ttu-id="4efa6-107">O trabalho de transferência do BITS pode ser configurado com um token de segurança adicional, que é um token de representação criado por um aplicativo que chama a API COM do BITS.</span><span class="sxs-lookup"><span data-stu-id="4efa6-107">The BITS transfer job can be configured with an additional security token, which is an impersonation token created by an application calling the BITS COM API.</span></span> <span data-ttu-id="4efa6-108">Esse modelo de token auxiliar permite que os aplicativos usem simultaneamente dois tokens de segurança diferentes para acessar arquivos locais, certificados do lado do cliente, arquivos remotos e proxies.</span><span class="sxs-lookup"><span data-stu-id="4efa6-108">This helper token model allows applications to simultaneously use two different security tokens to access local files, client-side certificates, remote files, and proxies.</span></span> <span data-ttu-id="4efa6-109">Por exemplo, um trabalho de transferência de BITS é criado para gravar os dados baixados em um diretório local com privilégios e, em seguida, apresenta uma identidade de domínio de direitos limitados ao servidor HTTP e ao servidor proxy.</span><span class="sxs-lookup"><span data-stu-id="4efa6-109">For example, a BITS transfer job is created that writes the downloaded data to a privileged local directory, and then it presents a low-rights domain identity to the HTTP server and proxy server.</span></span>

<span data-ttu-id="4efa6-110">Um aplicativo, normalmente um serviço do Windows, especifica um token auxiliar usando a nova interface [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="4efa6-110">An application, typically a Windows service, specifies a helper token by using the new interface [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span> <span data-ttu-id="4efa6-111">Essa interface é implementada pelo objeto de trabalho BITS.</span><span class="sxs-lookup"><span data-stu-id="4efa6-111">This interface is implemented by the BITS job object.</span></span> <span data-ttu-id="4efa6-112">O aplicativo chama [**método ibackgroundcopyjob:: QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) para obter o ponteiro de interface.</span><span class="sxs-lookup"><span data-stu-id="4efa6-112">The application calls [**IBackgroundCopyJob::QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) to get the interface pointer.</span></span> <span data-ttu-id="4efa6-113">O aplicativo representa a identidade auxiliar e chama [**IBitsTokenOptions:: SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) para passar o token para o serviço bits.</span><span class="sxs-lookup"><span data-stu-id="4efa6-113">The application impersonates the helper identity and calls [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) to pass the token to the BITS service.</span></span> <span data-ttu-id="4efa6-114">Em seguida, o aplicativo especifica os recursos aos quais o token se aplica passando um conjunto de sinalizadores de bit usando [**IBitsTokenOptions:: SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags).</span><span class="sxs-lookup"><span data-stu-id="4efa6-114">Then the application specifies the resources to which the token applies by passing a set of bit flags using [**IBitsTokenOptions::SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags).</span></span> <span data-ttu-id="4efa6-115">O aplicativo limpa todos os sinalizadores (usando **SetHelperTokenFlags** novamente) para reverter o comportamento.</span><span class="sxs-lookup"><span data-stu-id="4efa6-115">The application clears all the flags (using **SetHelperTokenFlags** again) to revert the behavior.</span></span> <span data-ttu-id="4efa6-116">O serviço BITS armazena os sinalizadores de bit e o token no trabalho de transferência BITS.</span><span class="sxs-lookup"><span data-stu-id="4efa6-116">The BITS service stores the bit flags and the token in the BITS transfer job.</span></span>

<span data-ttu-id="4efa6-117">Quando o proprietário dos trabalhos de transferência de BITS faz logoff, o serviço BITS descarta os tokens auxiliares associados ao trabalho de transferência.</span><span class="sxs-lookup"><span data-stu-id="4efa6-117">When the owner of the BITS transfer jobs logs off, the BITS service discards any helper tokens that are associated with the transfer job.</span></span> <span data-ttu-id="4efa6-118">Se a transferência não for concluída, o serviço BITS colocará o trabalho em um estado de erro com o **token BG e o código de erro \_ \_ \_ necessário** e descartará o token auxiliar.</span><span class="sxs-lookup"><span data-stu-id="4efa6-118">If the transfer is not complete, the BITS service places the job in an error state with the **BG\_E\_TOKEN\_REQUIRED** error code and discards the helper token.</span></span> <span data-ttu-id="4efa6-119">O aplicativo cliente pode atualizar o token chamando [**IBitsTokenOptions:: SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) e, em seguida, pode retomar o trabalho de transferência do bits.</span><span class="sxs-lookup"><span data-stu-id="4efa6-119">The client application can refresh the token by calling [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) and can then resume the BITS transfer job.</span></span> <span data-ttu-id="4efa6-120">Como alternativa, o aplicativo cliente pode limpar os sinalizadores do token auxiliar usando [**IBitsTokenOptions:: SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) e, em seguida, retomar o trabalho de transferência sem um token auxiliar.</span><span class="sxs-lookup"><span data-stu-id="4efa6-120">Alternatively, the client application can clear the helper token flags using [**IBitsTokenOptions::SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) and then resume the transfer job without a helper token.</span></span>

<span data-ttu-id="4efa6-121">Da mesma forma, quando o proprietário de uma sessão dos serviços de terminal faz logoff, o serviço BITS deve descartar os tokens auxiliares dessa sessão e posicionar os trabalhos de transferência afetados em um estado de erro com o código de erro **BG \_ E \_ token \_ necessário** .</span><span class="sxs-lookup"><span data-stu-id="4efa6-121">Similarly, when the owner of a terminal services session logs off, the BITS service must discard any helper tokens from that session and place the affected transfer jobs in an error state with the **BG\_E\_TOKEN\_REQUIRED** error code.</span></span>

<span data-ttu-id="4efa6-122">O modelo de token auxiliar requer uma alteração na política de controle de acesso do BITS.</span><span class="sxs-lookup"><span data-stu-id="4efa6-122">The helper token model requires a change to BITS access control policy.</span></span> <span data-ttu-id="4efa6-123">Versões anteriores de BITS implementaram verificações de acesso em cada chamada de método.</span><span class="sxs-lookup"><span data-stu-id="4efa6-123">Previous versions of BITS implemented access checks on every method call.</span></span> <span data-ttu-id="4efa6-124">A partir do Windows 7, a verificação de acesso deve ser executada dentro da chamada [**método ibackgroundcopyjob:: QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) ; caso contrário, o token auxiliar pode não ter acesso ao trabalho de transferência.</span><span class="sxs-lookup"><span data-stu-id="4efa6-124">Starting with Windows 7, the access check must be performed inside the [**IBackgroundCopyJob::QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) call; otherwise, the helper token might not have access to the transfer job.</span></span>

> [!Note]  
> <span data-ttu-id="4efa6-125">As implementações mais antigas exigiam efetivamente que os usuários do BITS tenham privilégios de administrador para definir os tokens auxiliares.</span><span class="sxs-lookup"><span data-stu-id="4efa6-125">Older implementations effectively required that BITS users have administrator privileges in order to set helper tokens.</span></span> <span data-ttu-id="4efa6-126">A partir do Windows 10, versão 1607, os usuários que não são administradores podem usar [**IBitsTokenOptions:: SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) para definir tokens auxiliares não administradores em trabalhos bits que eles possuem.</span><span class="sxs-lookup"><span data-stu-id="4efa6-126">Starting with Windows 10, version 1607, non-administrator BITS users can use [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) to set non-administrator helper tokens on BITS jobs they own.</span></span> <span data-ttu-id="4efa6-127">Essa alteração permite que usuários não administradores de BITS (como serviços de download de segundo plano em execução na [conta NetworkService](/windows/desktop/Services/networkservice-account)) definam tokens auxiliares.</span><span class="sxs-lookup"><span data-stu-id="4efa6-127">This change enables non-administrator BITS users (such as background downloader services running under the [NetworkService account](/windows/desktop/Services/networkservice-account)) to set helper tokens.</span></span>
>
> <span data-ttu-id="4efa6-128">Especificamente, a implementação foi alterada para permitir que usuários sem privilégios de administrador definam tokens auxiliares, desde que as seguintes condições sejam atendidas:</span><span class="sxs-lookup"><span data-stu-id="4efa6-128">Specifically, the implementation has been changed to allow users without administrator privileges to set helper tokens, as long as the following conditions are met:</span></span>
>
> -   <span data-ttu-id="4efa6-129">durante a chamada [**método ibackgroundcopyjob:: QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) , o SID do token thread's do chamador é o mesmo que o SID da conta de usuário do proprietário do trabalho e</span><span class="sxs-lookup"><span data-stu-id="4efa6-129">during the [**IBackgroundCopyJob::QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) call, the SID of the caller's thread's token is the same as the SID of the job owner's user account, and</span></span>
> -   <span data-ttu-id="4efa6-130">Quando [**IBitsTokenOptions:: SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) é chamado, o token auxiliar não tem o Sid de administrador (**\_ \_ \_ Administradores RID de alias de domínio**) habilitado.</span><span class="sxs-lookup"><span data-stu-id="4efa6-130">when [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) is called, the helper token does not have the administrator SID (**DOMAIN\_ALIAS\_RID\_ADMINS**) enabled.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="4efa6-131">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="4efa6-131">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="4efa6-132">**IBitsTokenOptions**</span><span class="sxs-lookup"><span data-stu-id="4efa6-132">**IBitsTokenOptions**</span></span>](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions)
</dt> </dl>

 

 