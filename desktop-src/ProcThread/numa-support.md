---
description: O modelo tradicional para suporte a vários processadores é um SMP (multiprocessador simétrico). Nesse modelo, cada processador tem acesso igual à memória e À E/S. À medida que mais processadores são adicionados, o barramento do processador se torna uma limitação para o desempenho do sistema.
ms.assetid: a1263968-2b26-45cc-bdd7-6aa354821a5a
title: Suporte ao NUMA
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 178f53c6b55b6ae291cd5cdcf99386515a441094
ms.sourcegitcommit: f848119a8faa29b27585f4df53f6e50ee9666684
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 05/27/2021
ms.locfileid: "110549801"
---
# <a name="numa-support"></a><span data-ttu-id="28656-105">Suporte ao NUMA</span><span class="sxs-lookup"><span data-stu-id="28656-105">NUMA Support</span></span>

<span data-ttu-id="28656-106">O modelo tradicional para suporte a vários processadores é um SMP (multiprocessador simétrico).</span><span class="sxs-lookup"><span data-stu-id="28656-106">The traditional model for multiprocessor support is symmetric multiprocessor (SMP).</span></span> <span data-ttu-id="28656-107">Nesse modelo, cada processador tem acesso igual à memória e À E/S.</span><span class="sxs-lookup"><span data-stu-id="28656-107">In this model, each processor has equal access to memory and I/O.</span></span> <span data-ttu-id="28656-108">À medida que mais processadores são adicionados, o barramento do processador se torna uma limitação para o desempenho do sistema.</span><span class="sxs-lookup"><span data-stu-id="28656-108">As more processors are added, the processor bus becomes a limitation for system performance.</span></span>

<span data-ttu-id="28656-109">Os designers de sistema usam NUMA (acesso não uniforme à memória) para aumentar a velocidade do processador sem aumentar a carga no barramento do processador.</span><span class="sxs-lookup"><span data-stu-id="28656-109">System designers use non-uniform memory access (NUMA) to increase processor speed without increasing the load on the processor bus.</span></span> <span data-ttu-id="28656-110">A arquitetura não é uniforme porque cada processador está próximo de algumas partes da memória e mais distante de outras partes da memória.</span><span class="sxs-lookup"><span data-stu-id="28656-110">The architecture is non-uniform because each processor is close to some parts of memory and farther from other parts of memory.</span></span> <span data-ttu-id="28656-111">O processador obtém rapidamente acesso à memória à que está próximo, enquanto pode levar mais tempo para obter acesso à memória mais distante.</span><span class="sxs-lookup"><span data-stu-id="28656-111">The processor quickly gains access to the memory it is close to, while it can take longer to gain access to memory that is farther away.</span></span>

<span data-ttu-id="28656-112">Em um sistema NUMA, as CPUs são organizadas em sistemas menores chamados *nós*.</span><span class="sxs-lookup"><span data-stu-id="28656-112">In a NUMA system, CPUs are arranged in smaller systems called *nodes*.</span></span> <span data-ttu-id="28656-113">Cada nó tem seus próprios processadores e memória e está conectado ao sistema maior por meio de um barramento de interconexão coerente com cache.</span><span class="sxs-lookup"><span data-stu-id="28656-113">Each node has its own processors and memory, and is connected to the larger system through a cache-coherent interconnect bus.</span></span>

<span data-ttu-id="28656-114">O sistema tenta melhorar o desempenho agendando threads em processadores que estão no mesmo nó que a memória que está sendo usada.</span><span class="sxs-lookup"><span data-stu-id="28656-114">The system attempts to improve performance by scheduling threads on processors that are in the same node as the memory being used.</span></span> <span data-ttu-id="28656-115">Ele tenta atender às solicitações de alocação de memória de dentro do nó, mas alocará memória de outros nós, se necessário.</span><span class="sxs-lookup"><span data-stu-id="28656-115">It attempts to satisfy memory-allocation requests from within the node, but will allocate memory from other nodes if necessary.</span></span> <span data-ttu-id="28656-116">Ele também fornece uma API para disponibilizar a topologia do sistema para aplicativos.</span><span class="sxs-lookup"><span data-stu-id="28656-116">It also provides an API to make the topology of the system available to applications.</span></span> <span data-ttu-id="28656-117">Você pode melhorar o desempenho de seus aplicativos usando as funções NUMA para otimizar o agendamento e o uso de memória.</span><span class="sxs-lookup"><span data-stu-id="28656-117">You can improve the performance of your applications by using the NUMA functions to optimize scheduling and memory usage.</span></span>

<span data-ttu-id="28656-118">Em primeiro lugar, você precisará determinar o layout dos nós no sistema.</span><span class="sxs-lookup"><span data-stu-id="28656-118">First of all, you will need to determine the layout of nodes in the system.</span></span> <span data-ttu-id="28656-119">Para recuperar o nó numerado mais alto no sistema, use [**a função GetNumaHighestNodeNumber.**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber)</span><span class="sxs-lookup"><span data-stu-id="28656-119">To retrieve the highest numbered node in the system, use the [**GetNumaHighestNodeNumber**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber) function.</span></span> <span data-ttu-id="28656-120">Observe que não há garantia de que esse número seja igual ao número total de nós no sistema.</span><span class="sxs-lookup"><span data-stu-id="28656-120">Note that this number is not guaranteed to equal the total number of nodes in the system.</span></span> <span data-ttu-id="28656-121">Além disso, não há garantia de que os nós com números sequenciais sejam próximos.</span><span class="sxs-lookup"><span data-stu-id="28656-121">Also, nodes with sequential numbers are not guaranteed to be close together.</span></span> <span data-ttu-id="28656-122">Para recuperar a lista de processadores no sistema, use a função [**GetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-getprocessaffinitymask) .</span><span class="sxs-lookup"><span data-stu-id="28656-122">To retrieve the list of processors on the system, use the [**GetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-getprocessaffinitymask) function.</span></span> <span data-ttu-id="28656-123">Você pode determinar o nó para cada processador na lista usando a função [**GetNumaProcessorNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode) .</span><span class="sxs-lookup"><span data-stu-id="28656-123">You can determine the node for each processor in the list by using the [**GetNumaProcessorNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode) function.</span></span> <span data-ttu-id="28656-124">Como alternativa, para recuperar uma lista de todos os processadores em um nó, use a função [**GetNumaNodeProcessorMask**](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask) .</span><span class="sxs-lookup"><span data-stu-id="28656-124">Alternatively, to retrieve a list of all processors in a node, use the [**GetNumaNodeProcessorMask**](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask) function.</span></span>

<span data-ttu-id="28656-125">Depois de determinar quais processadores pertencem a quais nós, você pode otimizar o desempenho do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="28656-125">After you have determined which processors belong to which nodes, you can optimize your application's performance.</span></span> <span data-ttu-id="28656-126">Para garantir que todos os threads do processo sejam executados no mesmo nó, use a função [**SetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setprocessaffinitymask) com uma máscara de afinidade de processo que especifique os processadores no mesmo nó.</span><span class="sxs-lookup"><span data-stu-id="28656-126">To ensure that all threads for your process run on the same node, use the [**SetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setprocessaffinitymask) function with a process affinity mask that specifies processors in the same node.</span></span> <span data-ttu-id="28656-127">Isso aumenta a eficiência dos aplicativos cujos threads precisam acessar a mesma memória.</span><span class="sxs-lookup"><span data-stu-id="28656-127">This increases the efficiency of applications whose threads need to access the same memory.</span></span> <span data-ttu-id="28656-128">Como alternativa, para limitar o número de threads em cada nó, use a função [**SetThreadAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setthreadaffinitymask) .</span><span class="sxs-lookup"><span data-stu-id="28656-128">Alternatively, to limit the number of threads on each node, use the [**SetThreadAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setthreadaffinitymask) function.</span></span>

<span data-ttu-id="28656-129">Aplicativos com uso intensivo de memória precisarão otimizar seu uso de memória.</span><span class="sxs-lookup"><span data-stu-id="28656-129">Memory-intensive applications will need to optimize their memory usage.</span></span> <span data-ttu-id="28656-130">Para recuperar a quantidade de memória livre disponível para um nó, use a função [**GetNumaAvailableMemoryNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode) .</span><span class="sxs-lookup"><span data-stu-id="28656-130">To retrieve the amount of free memory available to a node, use the [**GetNumaAvailableMemoryNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode) function.</span></span> <span data-ttu-id="28656-131">A função [**VirtualAllocExNuma**](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma) permite que o aplicativo especifique um nó preferencial para a alocação de memória.</span><span class="sxs-lookup"><span data-stu-id="28656-131">The [**VirtualAllocExNuma**](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma) function enables the application to specify a preferred node for the memory allocation.</span></span> <span data-ttu-id="28656-132">O **VirtualAllocExNuma** não aloca nenhuma página física, portanto, será bem sucedido se as páginas estão disponíveis ou não nesse nó ou em outro lugar no sistema.</span><span class="sxs-lookup"><span data-stu-id="28656-132">**VirtualAllocExNuma** does not allocate any physical pages, so it will succeed whether or not the pages are available on that node or elsewhere in the system.</span></span> <span data-ttu-id="28656-133">As páginas físicas são alocadas sob demanda.</span><span class="sxs-lookup"><span data-stu-id="28656-133">The physical pages are allocated on demand.</span></span> <span data-ttu-id="28656-134">Se o nó preferencial for executado fora de páginas, o Gerenciador de memória usará páginas de outros nós.</span><span class="sxs-lookup"><span data-stu-id="28656-134">If the preferred node runs out of pages, the memory manager will use pages from other nodes.</span></span> <span data-ttu-id="28656-135">Se a memória for paginada, o mesmo processo será usado quando for retornado.</span><span class="sxs-lookup"><span data-stu-id="28656-135">If the memory is paged out, the same process is used when it is brought back in.</span></span>

### <a name="numa-support-on-systems-with-more-than-64-logical-processors"></a><span data-ttu-id="28656-136">Suporte a NUMA em sistemas com mais de 64 processadores lógicos</span><span class="sxs-lookup"><span data-stu-id="28656-136">NUMA Support on Systems With More Than 64 Logical Processors</span></span>

<span data-ttu-id="28656-137">Em sistemas com mais de 64 processadores lógicos, os nós são atribuídos a [grupos de processadores](processor-groups.md) de acordo com a capacidade dos nós.</span><span class="sxs-lookup"><span data-stu-id="28656-137">On systems with more than 64 logical processors, nodes are assigned to [processor groups](processor-groups.md) according to the capacity of the nodes.</span></span> <span data-ttu-id="28656-138">A capacidade de um nó é o número de processadores que estão presentes quando o sistema é iniciado junto com quaisquer processadores lógicos adicionais que podem ser adicionados enquanto o sistema está em execução.</span><span class="sxs-lookup"><span data-stu-id="28656-138">The capacity of a node is the number of processors that are present when the system starts together with any additional logical processors that can be added while the system is running.</span></span>

<span data-ttu-id="28656-139">**Windows Server 2008, Windows Vista, Windows Server 2003 e Windows XP:** Não há suporte para grupos de processadores.</span><span class="sxs-lookup"><span data-stu-id="28656-139">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Processor groups are not supported.</span></span>

<span data-ttu-id="28656-140">Cada nó deve estar totalmente contido em um grupo.</span><span class="sxs-lookup"><span data-stu-id="28656-140">Each node must be fully contained within a group.</span></span> <span data-ttu-id="28656-141">Se as capacidades dos nós são relativamente pequenas, o sistema atribui mais de um nó ao mesmo grupo, escolhendo nós fisicamente próximos um do outro para melhorar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="28656-141">If the capacities of the nodes are relatively small, the system assigns more than one node to the same group, choosing nodes that are physically close to one another for better performance.</span></span> <span data-ttu-id="28656-142">Se a capacidade de um nó exceder o número máximo de processadores em um grupo, o sistema dividirá o nó em vários nós menores, cada um pequeno o suficiente para caber em um grupo.</span><span class="sxs-lookup"><span data-stu-id="28656-142">If a node's capacity exceeds the maximum number of processors in a group, the system splits the node into multiple smaller nodes, each small enough to fit in a group.</span></span>

<span data-ttu-id="28656-143">Um nó NUMA ideal para um novo processo pode ser solicitado usando o atributo [**estendido PROC THREAD ATTRIBUTE PREFERRED \_ \_ \_ \_ NODE**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) quando o processo é criado.</span><span class="sxs-lookup"><span data-stu-id="28656-143">An ideal NUMA node for a new process can be requested using the [**PROC\_THREAD\_ATTRIBUTE\_PREFERRED\_NODE**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) extended attribute when the process is created.</span></span> <span data-ttu-id="28656-144">Como um processador ideal de thread, o nó ideal é uma dica para o agendador, que atribui o novo processo ao grupo que contém o nó solicitado, se possível.</span><span class="sxs-lookup"><span data-stu-id="28656-144">Like a thread ideal processor, the ideal node is a hint to the scheduler, which assigns the new process to the group that contains the requested node if possible.</span></span>

<span data-ttu-id="28656-145">As funções NUMA estendidas [**GetNumaAvailableMemoryNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex), [**GetNumaNodeProcessorMaskEx,**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex) [**GetNumaProcessorNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex)e [**GetNumaProximityNodeEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex) diferem de suas contrapartes não autônomas, já que o número de nós é um **valor USHORT** em vez de **um UCHAR,** para acomodar o número potencialmente maior de nós em um sistema com mais de 64 processadores lógicos.</span><span class="sxs-lookup"><span data-stu-id="28656-145">The extended NUMA functions [**GetNumaAvailableMemoryNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex), [**GetNumaNodeProcessorMaskEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex), [**GetNumaProcessorNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex), and [**GetNumaProximityNodeEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex) differ from their unextended counterparts in that the node number is a **USHORT** value rather than a **UCHAR**, to accommodate the potentially greater number of nodes on a system with more than 64 logical processors.</span></span> <span data-ttu-id="28656-146">Além disso, o processador especificado com ou recuperado pelas funções estendidas inclui o grupo de processadores; O processador especificado com ou recuperado pelas funções não autônomas é relativo ao grupo.</span><span class="sxs-lookup"><span data-stu-id="28656-146">Also, the processor specified with or retrieved by the extended functions includes the processor group; the processor specified with or retrieved by the unextended functions is group-relative.</span></span> <span data-ttu-id="28656-147">Para obter detalhes, consulte os tópicos de referência de função individual.</span><span class="sxs-lookup"><span data-stu-id="28656-147">For details, see the individual function reference topics.</span></span>

<span data-ttu-id="28656-148">Um aplicativo com conhecimento de grupo pode atribuir todos os seus threads a um nó específico de maneira semelhante ao descrito anteriormente neste tópico, usando as funções NUMA estendidas correspondentes.</span><span class="sxs-lookup"><span data-stu-id="28656-148">A group-aware application can assign all of its threads to a particular node in a similar fashion to that described earlier in this topic, using the corresponding extended NUMA functions.</span></span> <span data-ttu-id="28656-149">O aplicativo usa [**GetLogicalProcessorInformationEx**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) para obter a lista de todos os processadores no sistema.</span><span class="sxs-lookup"><span data-stu-id="28656-149">The application uses [**GetLogicalProcessorInformationEx**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) to get the list of all processors on the system.</span></span> <span data-ttu-id="28656-150">Observe que o aplicativo não pode definir a máscara de afinidade de processo, a menos que o processo seja atribuído a um único grupo e o nó pretendido esteja localizado nesse grupo.</span><span class="sxs-lookup"><span data-stu-id="28656-150">Note that the application cannot set the process affinity mask unless the process is assigned to a single group and the intended node is located in that group.</span></span> <span data-ttu-id="28656-151">Normalmente, o aplicativo deve chamar [**SetThreadGroupAffinity**](/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity) para limitar seus threads ao nó desejado.</span><span class="sxs-lookup"><span data-stu-id="28656-151">Usually the application must call [**SetThreadGroupAffinity**](/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity) to limit its threads to the intended node.</span></span>


### <a name="behavior-starting-with-windows-10-build-20348"></a><span data-ttu-id="28656-152">Comportamento a partir do Build 20348 do Windows 10</span><span class="sxs-lookup"><span data-stu-id="28656-152">Behavior starting with Windows 10 Build 20348</span></span> 

> [!NOTE]
> <span data-ttu-id="28656-153">A partir do Build 20348 do Windows 10, o comportamento dessa e de outras funções NUMA foi modificado para oferecer melhor suporte a sistemas com nós que contenham mais de 64 processadores.</span><span class="sxs-lookup"><span data-stu-id="28656-153">Starting with Windows 10 Build 20348, the behavior of this and other NUMA functions has been modified to better support systems with nodes containing more that 64 processors.</span></span>

<span data-ttu-id="28656-154">A criação de nós "falsificados" para acomodar um mapeamento 1:1 entre grupos e nós resultou em comportamentos confusos em que números inesperados de nós NUMA são relatados e, portanto, a partir do Build 20348 do Windows 10, o sistema operacional mudou para permitir que vários grupos sejam associados a um nó e, portanto, agora a topologia NUMA verdadeira do sistema pode ser relatada.</span><span class="sxs-lookup"><span data-stu-id="28656-154">Creating "fake" nodes to accommodate a 1:1 mapping between groups and nodes has resulted in confusing behaviors where unexpected numbers of NUMA nodes are reported and so, starting with Windows 10 Build 20348, the OS has changed to allow multiple groups to be associated with a node, and so now the true NUMA topology of the system can be reported.</span></span>  

<span data-ttu-id="28656-155">Como parte dessas alterações no sistema operacional, várias APIs NUMA foram alteradas para dar suporte ao relatório de vários grupos que agora podem ser associados a um único nó NUMA.</span><span class="sxs-lookup"><span data-stu-id="28656-155">As part of these changes to the OS, a number of NUMA APIs have changed to support reporting the multiple groups which can now be associated with a single NUMA node.</span></span> <span data-ttu-id="28656-156">As APIs atualizadas e novas são rotuladas na tabela na seção da **API numa** abaixo.</span><span class="sxs-lookup"><span data-stu-id="28656-156">Updated and new APIs are labeled in the table in the **NUMA API** section below.</span></span>

<span data-ttu-id="28656-157">Como a remoção da divisão de nó pode afetar potencialmente os aplicativos existentes, um valor de registro está disponível para permitir a permissão de volta ao comportamento de divisão de nó herdado.</span><span class="sxs-lookup"><span data-stu-id="28656-157">Because the removal of node splitting can potentially impact existing applications, a registry value is available to allow opting back into the legacy node splitting behavior.</span></span> <span data-ttu-id="28656-158">A divisão de nó pode ser reabilitada com a criação de um valor de **REG_DWORD** chamado "SplitLargeNodes" com o valor 1 abaixo de HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\NUMA.</span><span class="sxs-lookup"><span data-stu-id="28656-158">Node splitting can be re-enabled by creating a **REG_DWORD** value named "SplitLargeNodes" with value 1 underneath HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\NUMA.</span></span> <span data-ttu-id="28656-159">As alterações nessa configuração exigem que uma reinicialização entre em vigor.</span><span class="sxs-lookup"><span data-stu-id="28656-159">Changes to this setting require a reboot to take effect.</span></span>

```powershell
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\NUMA" /v SplitLargeNumaNodes /t REG_DWORD /v 1
```

> [!NOTE]
> <span data-ttu-id="28656-160">Os aplicativos que são atualizados para usar a nova funcionalidade de API que relata a verdadeira topologia NUMA continuarão funcionando corretamente em sistemas em que a divisão de nó grande foi reabilitada com essa chave do registro.</span><span class="sxs-lookup"><span data-stu-id="28656-160">Applications that are updated to use the new API functionality that reports the true NUMA topology will continue to work properly on systems where large node splitting has been reenabled with this registry key.</span></span>

<span data-ttu-id="28656-161">O exemplo a seguir demonstra primeiro os possíveis problemas com os processadores de mapeamento de tabelas do para nós NUMA usando as APIs de afinidade herdadas, que não fornecem mais uma capa completa de todos os processadores no sistema, isso pode resultar em uma tabela incompleta.</span><span class="sxs-lookup"><span data-stu-id="28656-161">The following example first demonstrates potential issues with builds tables mapping processors to NUMA nodes using the legacy affinity APIs, which no longer provide a full cover of all processors in the system this can result in an incomplete table.</span></span> <span data-ttu-id="28656-162">As implicações dessa inintegridade dependem do conteúdo da tabela.</span><span class="sxs-lookup"><span data-stu-id="28656-162">The implications of such incompleteness depend on the contents of the table.</span></span> <span data-ttu-id="28656-163">Se a tabela simplesmente armazenar o número do nó correspondente, provavelmente isso será apenas um problema de desempenho com processadores descobertos sendo deixados como parte do nó 0.</span><span class="sxs-lookup"><span data-stu-id="28656-163">If the table simply stores the corresponding node number then this is likely only a performance issue with uncovered processors being left as part of node 0.</span></span> <span data-ttu-id="28656-164">No entanto, se a tabela contiver ponteiros para uma estrutura de contexto por nó, isso poderá resultar em desreferências NULL em runtime.</span><span class="sxs-lookup"><span data-stu-id="28656-164">However, if the table contains pointers to a per-node context structure this can result in NULL dereferences at runtime.</span></span>

<span data-ttu-id="28656-165">Em seguida, o exemplo de código ilustra duas soluções alternativas para o problema.</span><span class="sxs-lookup"><span data-stu-id="28656-165">Next, the code example illustrates two workarounds for the issue.</span></span> <span data-ttu-id="28656-166">A primeira é migrar para as APIs de afinidade de nó de vários grupos (modo de usuário e modo kernel).</span><span class="sxs-lookup"><span data-stu-id="28656-166">The first is to migrate to the multi-group node affinity APIs (user-mode and kernel-mode).</span></span> <span data-ttu-id="28656-167">A segunda é usar **KeQueryLogicalProcessorRelationship** para consultar diretamente o nó NUMA associado a um determinado número de processador.</span><span class="sxs-lookup"><span data-stu-id="28656-167">The second is to use **KeQueryLogicalProcessorRelationship** to directly query the NUMA node associated with a given processor number.</span></span>

```cpp

//
// Problematic implementation using KeQueryNodeActiveAffinity.
//

USHORT CurrentNode;
USHORT HighestNodeNumber;
GROUP_AFFINITY NodeAffinity;
ULONG ProcessorIndex;
PROCESSOR_NUMBER ProcessorNumber;

HighestNodeNumber = KeQueryHighestNodeNumber();
for (CurrentNode = 0; CurrentNode <= HighestNodeNumber; CurrentNode += 1) {

    KeQueryNodeActiveAffinity(CurrentNode, &NodeAffinity, NULL);
    while (NodeAffinity.Mask != 0) {

        ProcessorNumber.Group = NodeAffinity.Group;
        BitScanForward(&ProcessorNumber.Number, NodeAffinity.Mask);

        ProcessorIndex = KeGetProcessorIndexFromNumber(&ProcessorNumber);

        ProcessorNodeContexts[ProcessorIndex] = NodeContexts[CurrentNode;]

        NodeAffinity.Mask &= ~((KAFFINITY)1 << ProcessorNumber.Number);
    }
}

//
// Resolution using KeQueryNodeActiveAffinity2.
//

USHORT CurrentIndex;
USHORT CurrentNode;
USHORT CurrentNodeAffinityCount;
USHORT HighestNodeNumber;
ULONG MaximumGroupCount;
PGROUP_AFFINITY NodeAffinityMasks;
ULONG ProcessorIndex;
PROCESSOR_NUMBER ProcessorNumber;
NTSTATUS Status;

MaximumGroupCount = KeQueryMaximumGroupCount();
NodeAffinityMasks = ExAllocatePool2(POOL_FLAG_PAGED,
                                    sizeof(GROUP_AFFINITY) * MaximumGroupCount,
                                    'tseT');

if (NodeAffinityMasks == NULL) {
    return STATUS_NO_MEMORY;
}

HighestNodeNumber = KeQueryHighestNodeNumber();
for (CurrentNode = 0; CurrentNode <= HighestNodeNumber; CurrentNode += 1) {

    Status = KeQueryNodeActiveAffinity2(CurrentNode,
                                        NodeAffinityMasks,
                                        MaximumGroupCount,
                                        &CurrentNodeAffinityCount);
    NT_ASSERT(NT_SUCCESS(Status));

    for (CurrentIndex = 0; CurrentIndex < CurrentNodeAffinityCount; CurrentIndex += 1) {

        CurrentAffinity = &NodeAffinityMasks[CurrentIndex];

        while (CurrentAffinity->Mask != 0) {

            ProcessorNumber.Group = CurrentAffinity.Group;
            BitScanForward(&ProcessorNumber.Number, CurrentAffinity->Mask);

            ProcessorIndex = KeGetProcessorIndexFromNumber(&ProcessorNumber);

            ProcessorNodeContexts[ProcessorIndex] = NodeContexts[CurrentNode];

            CurrentAffinity->Mask &= ~((KAFFINITY)1 << ProcessorNumber.Number);
        }
    }
}

//
// Resolution using KeQueryLogicalProcessorRelationship.
//

ULONG ProcessorCount;
ULONG ProcessorIndex;
SYSTEM_LOGICAL_PROCESSOR_INFORMATION_EX ProcessorInformation;
ULONG ProcessorInformationSize;
PROCESSOR_NUMBER ProcessorNumber;
NTSTATUS Status;

ProcessorCount = KeQueryActiveProcessorCountEx(ALL_PROCESSOR_GROUPS);

for (ProcessorIndex = 0; ProcessorIndex < ProcessorCount; ProcessorIndex += 1) {

    Status = KeGetProcessorNumberFromIndex(ProcessorIndex, &ProcessorNumber);
    NT_ASSERT(NT_SUCCESS(Status));

    ProcessorInformationSize = sizeof(ProcessorInformation);
    Status = KeQueryLogicalProcessorRelationship(&ProcessorNumber,
                                                    RelationNumaNode,
                                                    &ProcessorInformation,
                                                    &ProcesorInformationSize);
    NT_ASSERT(NT_SUCCESS(Status));

    NodeNumber = ProcessorInformation.NumaNode.NodeNumber;

    ProcessorNodeContexts[ProcessorIndex] = NodeContexts[NodeNumber];
}
```

## <a name="numa-api"></a><span data-ttu-id="28656-168">NUMA API</span><span class="sxs-lookup"><span data-stu-id="28656-168">NUMA API</span></span>

<span data-ttu-id="28656-169">A tabela a seguir descreve a API NUMA.</span><span class="sxs-lookup"><span data-stu-id="28656-169">The following table describes the NUMA API.</span></span>



| <span data-ttu-id="28656-170">Função</span><span class="sxs-lookup"><span data-stu-id="28656-170">Function</span></span>                                                                     | <span data-ttu-id="28656-171">Descrição</span><span class="sxs-lookup"><span data-stu-id="28656-171">Description</span></span>                                                                                                                                                                                                                     |
|------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="28656-172">**AllocateUserPhysicalPagesNuma**</span><span class="sxs-lookup"><span data-stu-id="28656-172">**AllocateUserPhysicalPagesNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-allocateuserphysicalpagesnuma)      | <span data-ttu-id="28656-173">Aloca páginas de memória física a serem mapeadas e desmapeadas em qualquer região AWE [(Extensões](../memory/address-windowing-extensions.md) de Janela de Endereço) de um processo especificado e especifica o nó NUMA para a memória física.</span><span class="sxs-lookup"><span data-stu-id="28656-173">Allocates physical memory pages to be mapped and unmapped within any [Address Windowing Extensions](../memory/address-windowing-extensions.md) (AWE) region of a specified process and specifies the NUMA node for the physical memory.</span></span> |
| [<span data-ttu-id="28656-174">**CreateFileMappingNuma**</span><span class="sxs-lookup"><span data-stu-id="28656-174">**CreateFileMappingNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-createfilemappingnumaw)                      | <span data-ttu-id="28656-175">Cria ou abre um objeto de mapeamento de arquivo nomeado ou sem nome para um arquivo especificado e especifica o nó NUMA para a memória física.</span><span class="sxs-lookup"><span data-stu-id="28656-175">Creates or opens a named or unnamed file mapping object for a specified file, and specifies the NUMA node for the physical memory.</span></span>                                                                                              |
| [<span data-ttu-id="28656-176">**GetLogicalProcessorInformation**</span><span class="sxs-lookup"><span data-stu-id="28656-176">**GetLogicalProcessorInformation**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformation)     | <span data-ttu-id="28656-177">Atualizado no Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="28656-177">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="28656-178">Recupera informações sobre processadores lógicos e hardware relacionado.</span><span class="sxs-lookup"><span data-stu-id="28656-178">Retrieves information about logical processors and related hardware.</span></span>                                                                                                                                                            |
| [<span data-ttu-id="28656-179">**GetLogicalProcessorInformationEx**</span><span class="sxs-lookup"><span data-stu-id="28656-179">**GetLogicalProcessorInformationEx**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) | <span data-ttu-id="28656-180">Atualizado no Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="28656-180">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="28656-181">Recupera informações sobre as relações de processadores lógicos e hardware relacionado.</span><span class="sxs-lookup"><span data-stu-id="28656-181">Retrieves information about the relationships of logical processors and related hardware.</span></span>                                                                                                                                       |
| [<span data-ttu-id="28656-182">**GetNumaAvailableMemoryNode**</span><span class="sxs-lookup"><span data-stu-id="28656-182">**GetNumaAvailableMemoryNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode)             | <span data-ttu-id="28656-183">Recupera a quantidade de memória disponível no nó especificado.</span><span class="sxs-lookup"><span data-stu-id="28656-183">Retrieves the amount of memory available in the specified node.</span></span>                                                                                                                                                                 |
| [<span data-ttu-id="28656-184">**GetNumaAvailableMemoryNodeEx**</span><span class="sxs-lookup"><span data-stu-id="28656-184">**GetNumaAvailableMemoryNodeEx**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex)         | <span data-ttu-id="28656-185">Recupera a quantidade de memória disponível em um nó especificado como um valor **UShort** .</span><span class="sxs-lookup"><span data-stu-id="28656-185">Retrieves the amount of memory available in a node specified as a **USHORT** value.</span></span>                                                                                                                                             |
| [<span data-ttu-id="28656-186">**GetNumaHighestNodeNumber**</span><span class="sxs-lookup"><span data-stu-id="28656-186">**GetNumaHighestNodeNumber**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber)                 | <span data-ttu-id="28656-187">Recupera o nó que atualmente tem o número mais alto.</span><span class="sxs-lookup"><span data-stu-id="28656-187">Retrieves the node that currently has the highest number.</span></span>                                                                                                                                                                       |
| [<span data-ttu-id="28656-188">**GetNumaNodeProcessorMask**</span><span class="sxs-lookup"><span data-stu-id="28656-188">**GetNumaNodeProcessorMask**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask)                 | <span data-ttu-id="28656-189">Atualizado no Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="28656-189">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="28656-190">Recupera a máscara do processador para o nó especificado.</span><span class="sxs-lookup"><span data-stu-id="28656-190">Retrieves the processor mask for the specified node.</span></span>                                                                                                                                                                            |
| [<span data-ttu-id="28656-191">**GetNumaNodeProcessorMask2**</span><span class="sxs-lookup"><span data-stu-id="28656-191">**GetNumaNodeProcessorMask2**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormask2)                         | <span data-ttu-id="28656-192">Novidade no Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="28656-192">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="28656-193">Recupera a máscara do processador de vários grupos do nó especificado.</span><span class="sxs-lookup"><span data-stu-id="28656-193">Retrieves the multi-group processor mask of the specified node.</span></span>                                                                                                                                                                          |
| [<span data-ttu-id="28656-194">**GetNumaNodeProcessorMaskEx**</span><span class="sxs-lookup"><span data-stu-id="28656-194">**GetNumaNodeProcessorMaskEx**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex)             | <span data-ttu-id="28656-195">Atualizado no Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="28656-195">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="28656-196">Recupera a máscara do processador para um nó especificado como um valor **UShort** .</span><span class="sxs-lookup"><span data-stu-id="28656-196">Retrieves the processor mask for a node specified as a **USHORT** value.</span></span>                                                                                                                                                        |
| [<span data-ttu-id="28656-197">**GetNumaProcessorNode**</span><span class="sxs-lookup"><span data-stu-id="28656-197">**GetNumaProcessorNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode)                         | <span data-ttu-id="28656-198">Recupera o número do nó do processador especificado.</span><span class="sxs-lookup"><span data-stu-id="28656-198">Retrieves the node number for the specified processor.</span></span>                                                                                                                                                                          |
| [<span data-ttu-id="28656-199">**GetNumaProcessorNodeEx**</span><span class="sxs-lookup"><span data-stu-id="28656-199">**GetNumaProcessorNodeEx**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex)                     | <span data-ttu-id="28656-200">Recupera o número do nó como um valor **UShort** para o processador especificado.</span><span class="sxs-lookup"><span data-stu-id="28656-200">Retrieves the node number as a **USHORT** value for the specified processor.</span></span>                                                                                                                                                    |
| [<span data-ttu-id="28656-201">**GetNumaProximityNode**</span><span class="sxs-lookup"><span data-stu-id="28656-201">**GetNumaProximityNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaproximitynode)                         | <span data-ttu-id="28656-202">Recupera o número do nó para o identificador de proximidade especificado.</span><span class="sxs-lookup"><span data-stu-id="28656-202">Retrieves the node number for the specified proximity identifier.</span></span>                                                                                                                                                               |
| [<span data-ttu-id="28656-203">**GetNumaProximityNodeEx**</span><span class="sxs-lookup"><span data-stu-id="28656-203">**GetNumaProximityNodeEx**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex)                     | <span data-ttu-id="28656-204">Recupera o número do nó como um valor **UShort** para o identificador de proximidade especificado.</span><span class="sxs-lookup"><span data-stu-id="28656-204">Retrieves the node number as a **USHORT** value for the specified proximity identifier.</span></span>                                                                                                                                         |
| [<span data-ttu-id="28656-205">**GetProcessDefaultCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="28656-205">**GetProcessDefaultCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getprocessdefaultcpusetmasks)                     | <span data-ttu-id="28656-206">Novo no Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="28656-206">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="28656-207">Recupera a lista de Conjuntos de CPU no conjunto padrão de processo definido por SetProcessDefaultCpuSetMasks ou SetProcessDefaultCpuSets.</span><span class="sxs-lookup"><span data-stu-id="28656-207">Retrieves the list of CPU Sets in the process default set that was set by SetProcessDefaultCpuSetMasks or SetProcessDefaultCpuSets.</span></span>                                                                                                                                         |
| [<span data-ttu-id="28656-208">**GetThreadSelectedCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="28656-208">**GetThreadSelectedCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreadselectedcpusetmasks)                     | <span data-ttu-id="28656-209">Novo no Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="28656-209">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="28656-210">Define a atribuição de Conjuntos de CPU selecionados para o thread especificado.</span><span class="sxs-lookup"><span data-stu-id="28656-210">Sets the selected CPU Sets assignment for the specified thread.</span></span> <span data-ttu-id="28656-211">Essa atribuição substituirá a atribuição padrão do processo, se uma estiver definida.</span><span class="sxs-lookup"><span data-stu-id="28656-211">This assignment overrides the process default assignment, if one is set.</span></span>                                                                                                                                          |
| [<span data-ttu-id="28656-212">**MapViewOfFileExNuma**</span><span class="sxs-lookup"><span data-stu-id="28656-212">**MapViewOfFileExNuma**</span></span>](/windows/win32/api/winbase/nf-winbase-mapviewoffileexnuma)                          | <span data-ttu-id="28656-213">Mapeia uma exibição de um mapeamento de arquivo para o espaço de endereço de um processo de chamada e especifica o nó NUMA para a memória física.</span><span class="sxs-lookup"><span data-stu-id="28656-213">Maps a view of a file mapping into the address space of a calling process, and specifies the NUMA node for the physical memory.</span></span>                                                                                                 |
| [<span data-ttu-id="28656-214">**SetProcessDefaultCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="28656-214">**SetProcessDefaultCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessdefaultcpusetmasks)                     | <span data-ttu-id="28656-215">Novo no Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="28656-215">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="28656-216">Define a atribuição de Conjuntos de CPU padrão para threads no processo especificado.</span><span class="sxs-lookup"><span data-stu-id="28656-216">Sets the default CPU Sets assignment for threads in the specified process.</span></span>                                                                                                                                          |
| [<span data-ttu-id="28656-217">**SetThreadSelectedCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="28656-217">**SetThreadSelectedCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadselectedcpusetmasks)                     | <span data-ttu-id="28656-218">Novo no Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="28656-218">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="28656-219">Define a atribuição de Conjuntos de CPU selecionados para o thread especificado.</span><span class="sxs-lookup"><span data-stu-id="28656-219">Sets the selected CPU Sets assignment for the specified thread.</span></span> <span data-ttu-id="28656-220">Essa atribuição substituirá a atribuição padrão do processo, se uma estiver definida.</span><span class="sxs-lookup"><span data-stu-id="28656-220">This assignment overrides the process default assignment, if one is set.</span></span>                                                                                                                                          |
| [<span data-ttu-id="28656-221">**VirtualAllocExNuma**</span><span class="sxs-lookup"><span data-stu-id="28656-221">**VirtualAllocExNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma)                            | <span data-ttu-id="28656-222">Reserva ou confirma uma região de memória dentro do espaço de endereço virtual do processo especificado e especifica o nó NUMA para a memória física.</span><span class="sxs-lookup"><span data-stu-id="28656-222">Reserves or commits a region of memory within the virtual address space of the specified process, and specifies the NUMA node for the physical memory.</span></span>                                                                          |



 

<span data-ttu-id="28656-223">A [**função QueryWorkingSetEx**](/windows/win32/api/psapi/nf-psapi-queryworkingsetex) pode ser usada para recuperar o nó NUMA no qual uma página é alocada.</span><span class="sxs-lookup"><span data-stu-id="28656-223">The [**QueryWorkingSetEx**](/windows/win32/api/psapi/nf-psapi-queryworkingsetex) function can be used to retrieve the NUMA node on which a page is allocated.</span></span> <span data-ttu-id="28656-224">Para ver um exemplo, consulte [Alocando memória de um nó NUMA.](../memory/allocating-memory-from-a-numa-node.md)</span><span class="sxs-lookup"><span data-stu-id="28656-224">For an example, see [Allocating Memory from a NUMA Node](../memory/allocating-memory-from-a-numa-node.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="28656-225">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="28656-225">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="28656-226">Alocando memória de um nó NUMA</span><span class="sxs-lookup"><span data-stu-id="28656-226">Allocating Memory from a NUMA Node</span></span>](../memory/allocating-memory-from-a-numa-node.md)
</dt> <dt>

[<span data-ttu-id="28656-227">Vários processadores</span><span class="sxs-lookup"><span data-stu-id="28656-227">Multiple Processors</span></span>](multiple-processors.md)
</dt> <dt>

[<span data-ttu-id="28656-228">Grupos de processadores</span><span class="sxs-lookup"><span data-stu-id="28656-228">Processor Groups</span></span>](processor-groups.md)
</dt> </dl>

 

 
