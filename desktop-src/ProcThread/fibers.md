---
description: Uma fibra é uma unidade de execução que deve ser agendada manualmente pelo aplicativo.
ms.assetid: 6283f56b-23ae-4840-abd0-2478a50c670c
title: Fibras
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4ea0383e6d207a77c621f00f358c72bb8873ecb5
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103662175"
---
# <a name="fibers"></a><span data-ttu-id="fa6b0-103">Fibras</span><span class="sxs-lookup"><span data-stu-id="fa6b0-103">Fibers</span></span>

<span data-ttu-id="fa6b0-104">Uma *fibra* é uma unidade de execução que deve ser agendada manualmente pelo aplicativo.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-104">A *fiber* is a unit of execution that must be manually scheduled by the application.</span></span> <span data-ttu-id="fa6b0-105">Os fibras são executados no contexto dos threads que os agendam.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-105">Fibers run in the context of the threads that schedule them.</span></span> <span data-ttu-id="fa6b0-106">Cada thread pode agendar várias fibras.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-106">Each thread can schedule multiple fibers.</span></span> <span data-ttu-id="fa6b0-107">Em geral, os fibras não fornecem vantagens em relação a um aplicativo multithread bem projetado.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-107">In general, fibers do not provide advantages over a well-designed multithreaded application.</span></span> <span data-ttu-id="fa6b0-108">No entanto, o uso de fibras pode facilitar a porta de aplicativos que foram projetados para agendar seus próprios threads.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-108">However, using fibers can make it easier to port applications that were designed to schedule their own threads.</span></span>

<span data-ttu-id="fa6b0-109">Do ponto de vista do sistema, uma fibra assume a identidade do thread que a executa.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-109">From a system standpoint, a fiber assumes the identity of the thread that runs it.</span></span> <span data-ttu-id="fa6b0-110">Por exemplo, se um Fiber acessa o [armazenamento local de thread](thread-local-storage.md) (TLS), ele está acessando o armazenamento local de thread do thread que o está executando.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-110">For example, if a fiber accesses [thread local storage](thread-local-storage.md) (TLS), it is accessing the thread local storage of the thread that is running it.</span></span> <span data-ttu-id="fa6b0-111">Além disso, se uma fibra chamar a função [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) , o thread que a está executando será encerrado.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-111">In addition, if a fiber calls the [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) function, the thread that is running it exits.</span></span> <span data-ttu-id="fa6b0-112">No entanto, uma fibra não tem todas as mesmas informações de estado associadas a ela associadas a um thread.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-112">However, a fiber does not have all the same state information associated with it as that associated with a thread.</span></span> <span data-ttu-id="fa6b0-113">As informações de estado mantidas para uma fibra são sua pilha, um subconjunto de seus registros e os dados de fibra fornecidos durante a criação de fibra.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-113">The only state information maintained for a fiber is its stack, a subset of its registers, and the fiber data provided during fiber creation.</span></span> <span data-ttu-id="fa6b0-114">Os registros salvos são o conjunto de registros normalmente preservados em uma chamada de função.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-114">The saved registers are the set of registers typically preserved across a function call.</span></span>

<span data-ttu-id="fa6b0-115">Fibras não são agendadas de preempção.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-115">Fibers are not preemptively scheduled.</span></span> <span data-ttu-id="fa6b0-116">Você agenda uma fibra alternando para ela de outra fibra.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-116">You schedule a fiber by switching to it from another fiber.</span></span> <span data-ttu-id="fa6b0-117">O sistema ainda agenda threads para execução.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-117">The system still schedules threads to run.</span></span> <span data-ttu-id="fa6b0-118">Quando um thread executando fibras é preempção, sua fibra atualmente em execução é preempção, mas permanece selecionada.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-118">When a thread running fibers is preempted, its currently running fiber is preempted but remains selected.</span></span> <span data-ttu-id="fa6b0-119">A fibra selecionada é executada quando seu thread é executado.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-119">The selected fiber runs when its thread runs.</span></span>

<span data-ttu-id="fa6b0-120">Antes de agendar a primeira fibra, chame a função [**ConvertThreadToFiber**](/windows/desktop/api/WinBase/nf-winbase-convertthreadtofiber) para criar uma área na qual salvar informações de estado de fibra.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-120">Before scheduling the first fiber, call the [**ConvertThreadToFiber**](/windows/desktop/api/WinBase/nf-winbase-convertthreadtofiber) function to create an area in which to save fiber state information.</span></span> <span data-ttu-id="fa6b0-121">O thread de chamada agora é a fibra em execução no momento.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-121">The calling thread is now the currently executing fiber.</span></span> <span data-ttu-id="fa6b0-122">As informações de estado armazenadas para essa fibra incluem os dados de fibra passados como um argumento para **ConvertThreadToFiber**.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-122">The stored state information for this fiber includes the fiber data passed as an argument to **ConvertThreadToFiber**.</span></span>

<span data-ttu-id="fa6b0-123">A função [**CreateFiber**](/windows/desktop/api/WinBase/nf-winbase-createfiber) é usada para criar uma nova fibra a partir de uma fibra existente; a chamada requer o tamanho da pilha, o endereço inicial e os dados de fibra.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-123">The [**CreateFiber**](/windows/desktop/api/WinBase/nf-winbase-createfiber) function is used to create a new fiber from an existing fiber; the call requires the stack size, the starting address, and the fiber data.</span></span> <span data-ttu-id="fa6b0-124">O endereço inicial normalmente é uma função fornecida pelo usuário, chamada função de fibra, que usa um parâmetro (os dados de fibra) e não retorna um valor.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-124">The starting address is typically a user-supplied function, called the fiber function, that takes one parameter (the fiber data) and does not return a value.</span></span> <span data-ttu-id="fa6b0-125">Se a função Fiber retornar, o thread que executa a fibra será encerrado.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-125">If your fiber function returns, the thread running the fiber exits.</span></span> <span data-ttu-id="fa6b0-126">Para executar qualquer fibra criada com **CreateFiber**, chame a função [**SwitchToFiber**](/windows/desktop/api/WinBase/nf-winbase-switchtofiber) .</span><span class="sxs-lookup"><span data-stu-id="fa6b0-126">To execute any fiber created with **CreateFiber**, call the [**SwitchToFiber**](/windows/desktop/api/WinBase/nf-winbase-switchtofiber) function.</span></span> <span data-ttu-id="fa6b0-127">Você pode chamar **SwitchToFiber** com o endereço de uma fibra criada por um thread diferente.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-127">You can call **SwitchToFiber** with the address of a fiber created by a different thread.</span></span> <span data-ttu-id="fa6b0-128">Para fazer isso, você deve ter o endereço retornado para o outro thread quando ele chamou **CreateFiber** e você deve usar a sincronização adequada.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-128">To do this, you must have the address returned to the other thread when it called **CreateFiber** and you must use proper synchronization.</span></span>

<span data-ttu-id="fa6b0-129">Uma fibra pode recuperar os dados de fibra chamando a macro [**GetFiberData**](/windows/win32/api/winnt/nf-winnt-getfiberdata) .</span><span class="sxs-lookup"><span data-stu-id="fa6b0-129">A fiber can retrieve the fiber data by calling the [**GetFiberData**](/windows/win32/api/winnt/nf-winnt-getfiberdata) macro.</span></span> <span data-ttu-id="fa6b0-130">Uma fibra pode recuperar o endereço de fibra a qualquer momento chamando a macro [**GetCurrentFiber**](/windows/win32/api/winnt/nf-winnt-getcurrentfiber) .</span><span class="sxs-lookup"><span data-stu-id="fa6b0-130">A fiber can retrieve the fiber address at any time by calling the [**GetCurrentFiber**](/windows/win32/api/winnt/nf-winnt-getcurrentfiber) macro.</span></span>

## <a name="fiber-local-storage"></a><span data-ttu-id="fa6b0-131">Armazenamento local de fibra</span><span class="sxs-lookup"><span data-stu-id="fa6b0-131">Fiber Local Storage</span></span>

<span data-ttu-id="fa6b0-132">Uma fibra pode usar o *armazenamento local de fibra* (FLS) para criar uma cópia exclusiva de uma variável para cada fibra.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-132">A fiber can use *fiber local storage* (FLS) to create a unique copy of a variable for each fiber.</span></span> <span data-ttu-id="fa6b0-133">Se não ocorrer nenhuma alternância de fibra, FLS agirá exatamente da mesma forma que o [armazenamento local de thread](thread-local-storage.md).</span><span class="sxs-lookup"><span data-stu-id="fa6b0-133">If no fiber switching occurs, FLS acts exactly the same as [thread local storage](thread-local-storage.md).</span></span> <span data-ttu-id="fa6b0-134">As funções FLS ([**FlsAlloc**](/windows/win32/api/fibersapi/nf-fibersapi-flsalloc), [**FlsFree**](/windows/win32/api/fibersapi/nf-fibersapi-flsfree), [**FlsGetValue**](/windows/win32/api/fibersapi/nf-fibersapi-flsgetvalue)e [**FlsSetValue**](/windows/win32/api/fibersapi/nf-fibersapi-flssetvalue)) manipulam os FLS associados ao thread atual.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-134">The FLS functions ([**FlsAlloc**](/windows/win32/api/fibersapi/nf-fibersapi-flsalloc), [**FlsFree**](/windows/win32/api/fibersapi/nf-fibersapi-flsfree), [**FlsGetValue**](/windows/win32/api/fibersapi/nf-fibersapi-flsgetvalue), and [**FlsSetValue**](/windows/win32/api/fibersapi/nf-fibersapi-flssetvalue)) manipulate the FLS associated with the current thread.</span></span> <span data-ttu-id="fa6b0-135">Se o thread estiver executando uma fibra e a fibra for trocada, o FLS também será alternado.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-135">If the thread is executing a fiber and the fiber is switched, the FLS is also switched.</span></span>

<span data-ttu-id="fa6b0-136">Para limpar os dados associados a uma fibra, chame a função [**DeleteFiber**](/windows/desktop/api/WinBase/nf-winbase-deletefiber) .</span><span class="sxs-lookup"><span data-stu-id="fa6b0-136">To clean up the data associated with a fiber, call the [**DeleteFiber**](/windows/desktop/api/WinBase/nf-winbase-deletefiber) function.</span></span> <span data-ttu-id="fa6b0-137">Esses dados incluem a pilha, um subconjunto dos registros e os dados de fibra.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-137">This data includes the stack, a subset of the registers, and the fiber data.</span></span> <span data-ttu-id="fa6b0-138">Se a fibra atualmente em execução chamar **DeleteFiber**, seu thread chamará [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) e será encerrado.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-138">If the currently running fiber calls **DeleteFiber**, its thread calls [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) and terminates.</span></span> <span data-ttu-id="fa6b0-139">No entanto, se a fibra selecionada de um thread for excluída por uma fibra em execução em outro thread, o thread com a fibra excluída provavelmente será encerrado de forma anormal porque a pilha de fibra foi liberada.</span><span class="sxs-lookup"><span data-stu-id="fa6b0-139">However, if the selected fiber of a thread is deleted by a fiber running in another thread, the thread with the deleted fiber is likely to terminate abnormally because the fiber stack has been freed.</span></span>

## <a name="related-topics"></a><span data-ttu-id="fa6b0-140">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="fa6b0-140">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="fa6b0-141">Usando fibras</span><span class="sxs-lookup"><span data-stu-id="fa6b0-141">Using Fibers</span></span>](using-fibers.md)
</dt> </dl>

 

 
