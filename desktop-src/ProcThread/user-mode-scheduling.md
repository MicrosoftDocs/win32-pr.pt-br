---
description: O UMS (agendamento de modo de usuário) é um mecanismo leve que os aplicativos podem usar para agendar seus próprios threads.
ms.assetid: f9dd92fe-6d7a-452c-893e-e6df1757e377
title: Agendamento de User-Mode
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f3ceea3c4d4e40d73f48414d074bcb5b4f6e911d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "105757740"
---
# <a name="user-mode-scheduling"></a><span data-ttu-id="1171f-103">Agendamento de User-Mode</span><span class="sxs-lookup"><span data-stu-id="1171f-103">User-Mode Scheduling</span></span>

<span data-ttu-id="1171f-104">O UMS (agendamento de modo de usuário) é um mecanismo leve que os aplicativos podem usar para agendar seus próprios threads.</span><span class="sxs-lookup"><span data-stu-id="1171f-104">User-mode scheduling (UMS) is a lightweight mechanism that applications can use to schedule their own threads.</span></span> <span data-ttu-id="1171f-105">Um aplicativo pode alternar entre threads UMS no modo de usuário sem envolver o [Agendador do sistema](scheduling.md) e reobter o controle do processador se um thread UMS for bloqueado no kernel.</span><span class="sxs-lookup"><span data-stu-id="1171f-105">An application can switch between UMS threads in user mode without involving the [system scheduler](scheduling.md) and regain control of the processor if a UMS thread blocks in the kernel.</span></span> <span data-ttu-id="1171f-106">Threads UMS diferem de [fibras](fibers.md) em que cada thread UMS tem seu próprio contexto de thread em vez de compartilhar o contexto de thread de um único thread.</span><span class="sxs-lookup"><span data-stu-id="1171f-106">UMS threads differ from [fibers](fibers.md) in that each UMS thread has its own thread context instead of sharing the thread context of a single thread.</span></span> <span data-ttu-id="1171f-107">A capacidade de alternar entre threads no modo de usuário torna o UMS mais eficiente do que os [pools de threads](thread-pools.md) para gerenciar grandes números de itens de trabalho de curta duração que exigem poucas chamadas do sistema.</span><span class="sxs-lookup"><span data-stu-id="1171f-107">The ability to switch between threads in user mode makes UMS more efficient than [thread pools](thread-pools.md) for managing large numbers of short-duration work items that require few system calls.</span></span>

<span data-ttu-id="1171f-108">O UMS é recomendado para aplicativos com requisitos de alto desempenho que precisam executar com eficiência vários threads simultaneamente em sistemas multiprocessadores ou de vários núcleos.</span><span class="sxs-lookup"><span data-stu-id="1171f-108">UMS is recommended for applications with high performance requirements that need to efficiently run many threads concurrently on multiprocessor or multicore systems.</span></span> <span data-ttu-id="1171f-109">Para tirar proveito do UMS, um aplicativo deve implementar um componente do Agendador que gerencia os threads do UMS do aplicativo e determina quando eles devem ser executados.</span><span class="sxs-lookup"><span data-stu-id="1171f-109">To take advantage of UMS, an application must implement a scheduler component that manages the application's UMS threads and determines when they should run.</span></span> <span data-ttu-id="1171f-110">Os desenvolvedores devem considerar se os requisitos de desempenho do aplicativo justificam o trabalho envolvido no desenvolvimento desse componente.</span><span class="sxs-lookup"><span data-stu-id="1171f-110">Developers should consider whether their application performance requirements justify the work involved in developing such a component.</span></span> <span data-ttu-id="1171f-111">Os aplicativos com requisitos de desempenho moderado podem ser melhor atendidos permitindo que o Agendador do sistema agende seus threads.</span><span class="sxs-lookup"><span data-stu-id="1171f-111">Applications with moderate performance requirements might be better served by allowing the system scheduler to schedule their threads.</span></span>

<span data-ttu-id="1171f-112">O UMS está disponível para aplicativos de 64 bits executados em versões de 64 bits do Windows 7 e Windows Server 2008 R2 ou versões mais recentes de 64 bits do Windows.</span><span class="sxs-lookup"><span data-stu-id="1171f-112">UMS is available for 64-bit applications running on 64-bit versions of Windows 7 and Windows Server 2008 R2 or later 64-bit versions of Windows.</span></span> <span data-ttu-id="1171f-113">Esse recurso não está disponível nas versões de 32 bits do Windows.</span><span class="sxs-lookup"><span data-stu-id="1171f-113">This feature is not available on 32-bit versions of Windows.</span></span>

<span data-ttu-id="1171f-114">Para obter detalhes, consulte as seguintes seções:</span><span class="sxs-lookup"><span data-stu-id="1171f-114">For details, see the following sections:</span></span>

-   [<span data-ttu-id="1171f-115">Agendador de UMS</span><span class="sxs-lookup"><span data-stu-id="1171f-115">UMS Scheduler</span></span>](#ums-scheduler)
-   [<span data-ttu-id="1171f-116">Thread do Agendador do UMS</span><span class="sxs-lookup"><span data-stu-id="1171f-116">UMS Scheduler Thread</span></span>](#ums-scheduler-thread)
-   [<span data-ttu-id="1171f-117">UMS threads de trabalho, contextos de thread e listas de conclusão</span><span class="sxs-lookup"><span data-stu-id="1171f-117">UMS Worker Threads, Thread Contexts, and Completion Lists</span></span>](#ums-worker-threads-thread-contexts-and-completion-lists)
-   [<span data-ttu-id="1171f-118">Função de ponto de entrada do Agendador UMS</span><span class="sxs-lookup"><span data-stu-id="1171f-118">UMS Scheduler Entry Point Function</span></span>](#ums-scheduler-entry-point-function)
-   [<span data-ttu-id="1171f-119">Execução de thread UMS</span><span class="sxs-lookup"><span data-stu-id="1171f-119">UMS Thread Execution</span></span>](#ums-thread-execution)
-   [<span data-ttu-id="1171f-120">Práticas recomendadas do UMS</span><span class="sxs-lookup"><span data-stu-id="1171f-120">UMS Best Practices</span></span>](#ums-best-practices)

## <a name="ums-scheduler"></a><span data-ttu-id="1171f-121">Agendador de UMS</span><span class="sxs-lookup"><span data-stu-id="1171f-121">UMS Scheduler</span></span>

<span data-ttu-id="1171f-122">O Agendador UMS de um aplicativo é responsável por criar, gerenciar e excluir threads UMS e determinar qual thread do UMS executar.</span><span class="sxs-lookup"><span data-stu-id="1171f-122">An application's UMS scheduler is responsible for creating, managing, and deleting UMS threads and determining which UMS thread to run.</span></span> <span data-ttu-id="1171f-123">O Agendador de um aplicativo executa as seguintes tarefas:</span><span class="sxs-lookup"><span data-stu-id="1171f-123">An application's scheduler performs the following tasks:</span></span>

-   <span data-ttu-id="1171f-124">Cria um thread do Agendador UMS para cada processador no qual o aplicativo executará UMS threads de trabalho.</span><span class="sxs-lookup"><span data-stu-id="1171f-124">Creates one UMS scheduler thread for each processor on which the application will run UMS worker threads.</span></span>
-   <span data-ttu-id="1171f-125">Cria threads de trabalho do UMS para executar o trabalho do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="1171f-125">Creates UMS worker threads to perform the work of the application.</span></span>
-   <span data-ttu-id="1171f-126">Mantém sua própria fila de threads prontas para threads de trabalho que estão prontos para execução e seleciona threads para execução com base nas políticas de agendamento do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="1171f-126">Maintains its own ready-thread queue of worker threads that are ready to run, and selects threads to run based on the application's scheduling policies.</span></span>
-   <span data-ttu-id="1171f-127">Cria e monitora uma ou mais listas de conclusão em que o sistema enfileira threads depois de concluir o processamento no kernel.</span><span class="sxs-lookup"><span data-stu-id="1171f-127">Creates and monitors one or more completion lists where the system queues threads after they finish processing in the kernel.</span></span> <span data-ttu-id="1171f-128">Isso inclui threads de trabalho recém-criados e threads anteriormente bloqueados em uma chamada do sistema que se tornam desbloqueados.</span><span class="sxs-lookup"><span data-stu-id="1171f-128">These include newly created worker threads and threads previously blocked on a system call that become unblocked.</span></span>
-   <span data-ttu-id="1171f-129">Fornece uma função de ponto de entrada do Agendador para manipular notificações do sistema.</span><span class="sxs-lookup"><span data-stu-id="1171f-129">Provides a scheduler entry point function to handles notifications from the system.</span></span> <span data-ttu-id="1171f-130">O sistema chama a função de ponto de entrada quando um thread do Agendador é criado, quando um thread de trabalho é bloqueado em uma chamada do sistema ou quando um thread de trabalho concede explicitamente o controle.</span><span class="sxs-lookup"><span data-stu-id="1171f-130">The system calls the entry point function when a scheduler thread is created, when a worker thread blocks on a system call, or when a worker thread explicitly yields control.</span></span>
-   <span data-ttu-id="1171f-131">Executa tarefas de limpeza para threads de trabalho que concluíram a execução.</span><span class="sxs-lookup"><span data-stu-id="1171f-131">Performs cleanup tasks for worker threads that have finished running.</span></span>
-   <span data-ttu-id="1171f-132">Executa um desligamento ordenado do Agendador quando solicitado pelo aplicativo.</span><span class="sxs-lookup"><span data-stu-id="1171f-132">Performs an orderly shutdown of the scheduler when requested by the application.</span></span>

## <a name="ums-scheduler-thread"></a><span data-ttu-id="1171f-133">Thread do Agendador do UMS</span><span class="sxs-lookup"><span data-stu-id="1171f-133">UMS Scheduler Thread</span></span>

<span data-ttu-id="1171f-134">Um thread do Agendador do UMS é um thread comum que foi convertido em UMS chamando a função [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) .</span><span class="sxs-lookup"><span data-stu-id="1171f-134">A UMS scheduler thread is an ordinary thread that has converted itself to UMS by calling the [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) function.</span></span> <span data-ttu-id="1171f-135">O Agendador do sistema determina quando o thread do Agendador do UMS é executado com base em sua prioridade em relação a outros threads prontos.</span><span class="sxs-lookup"><span data-stu-id="1171f-135">The system scheduler determines when the UMS scheduler thread runs based on its priority relative to other ready threads.</span></span> <span data-ttu-id="1171f-136">O processador no qual o thread do Agendador é executado é influenciado pela afinidade do thread, o mesmo que para threads não UMS.</span><span class="sxs-lookup"><span data-stu-id="1171f-136">The processor on which the scheduler thread runs is influenced by the thread's affinity, same as for non-UMS threads.</span></span>

<span data-ttu-id="1171f-137">O chamador de [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) especifica uma lista de conclusão e uma função de ponto de entrada [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) para associar ao thread do Agendador do ums.</span><span class="sxs-lookup"><span data-stu-id="1171f-137">The caller of [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) specifies a completion list and a [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) entry point function to associate with the UMS scheduler thread.</span></span> <span data-ttu-id="1171f-138">O sistema chama a função de ponto de entrada especificada quando termina de converter o thread de chamada para UMS.</span><span class="sxs-lookup"><span data-stu-id="1171f-138">The system calls the specified entry point function when it is finished converting the calling thread to UMS.</span></span> <span data-ttu-id="1171f-139">A função de ponto de entrada do Agendador é responsável por determinar a próxima ação apropriada para o thread especificado.</span><span class="sxs-lookup"><span data-stu-id="1171f-139">The scheduler entry point function is responsible for determining the appropriate next action for the specified thread.</span></span> <span data-ttu-id="1171f-140">Para obter mais informações, consulte [função de ponto de entrada do Agendador ums](#ums-scheduler-entry-point-function) mais adiante neste tópico.</span><span class="sxs-lookup"><span data-stu-id="1171f-140">For more information, see [UMS Scheduler Entry Point Function](#ums-scheduler-entry-point-function) later in this topic.</span></span>

<span data-ttu-id="1171f-141">Um aplicativo pode criar um thread do Agendador UMS para cada processador que será usado para executar threads do UMS.</span><span class="sxs-lookup"><span data-stu-id="1171f-141">An application might create one UMS scheduler thread for each processor that will be used to run UMS threads.</span></span> <span data-ttu-id="1171f-142">O aplicativo também pode definir a afinidade de cada thread do Agendador do UMS para um processador lógico específico, o que tende a excluir threads não relacionados de serem executados no processador, preservando-os efetivamente para esse thread do Agendador.</span><span class="sxs-lookup"><span data-stu-id="1171f-142">The application might also set the affinity of each UMS scheduler thread for a specific logical processor, which tends to exclude unrelated threads from running on that processor, effectively reserving it for that scheduler thread.</span></span> <span data-ttu-id="1171f-143">Lembre-se de que definir a afinidade de thread dessa maneira pode afetar o desempenho geral do sistema por meio da falta de outros processos que possam estar em execução no sistema.</span><span class="sxs-lookup"><span data-stu-id="1171f-143">Be aware that setting thread affinity in this way can affect overall system performance by starving other processes that may be running on the system.</span></span> <span data-ttu-id="1171f-144">Para obter mais informações sobre afinidade de thread, consulte [vários processadores](multiple-processors.md).</span><span class="sxs-lookup"><span data-stu-id="1171f-144">For more information about thread affinity, see [Multiple Processors](multiple-processors.md).</span></span>

## <a name="ums-worker-threads-thread-contexts-and-completion-lists"></a><span data-ttu-id="1171f-145">UMS threads de trabalho, contextos de thread e listas de conclusão</span><span class="sxs-lookup"><span data-stu-id="1171f-145">UMS Worker Threads, Thread Contexts, and Completion Lists</span></span>

<span data-ttu-id="1171f-146">Um thread de trabalho do UMS é criado chamando [**CreateRemoteThreadEx**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethreadex) com o atributo de thread proc \_ ums de \_ \_ \_ thread e especificando um contexto de thread UMS e uma lista de conclusão.</span><span class="sxs-lookup"><span data-stu-id="1171f-146">A UMS worker thread is created by calling [**CreateRemoteThreadEx**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethreadex) with the PROC\_THREAD\_ATTRIBUTE\_UMS\_THREAD attribute and specifying a UMS thread context and a completion list.</span></span>

<span data-ttu-id="1171f-147">Um contexto de thread UMS representa o estado de thread UMS de um thread de trabalho e é usado para identificar o thread de trabalho nas chamadas de função UMS.</span><span class="sxs-lookup"><span data-stu-id="1171f-147">A UMS thread context represents the UMS thread state of a worker thread and is used to identify the worker thread in UMS function calls.</span></span> <span data-ttu-id="1171f-148">Ele é criado chamando [**CreateUmsThreadContext**](/windows/desktop/api/WinBase/nf-winbase-createumsthreadcontext).</span><span class="sxs-lookup"><span data-stu-id="1171f-148">It is created by calling [**CreateUmsThreadContext**](/windows/desktop/api/WinBase/nf-winbase-createumsthreadcontext).</span></span>

<span data-ttu-id="1171f-149">Uma lista de conclusão é criada chamando a função [**CreateUmsCompletionList**](/windows/desktop/api/WinBase/nf-winbase-createumscompletionlist) .</span><span class="sxs-lookup"><span data-stu-id="1171f-149">A completion list is created by calling the [**CreateUmsCompletionList**](/windows/desktop/api/WinBase/nf-winbase-createumscompletionlist) function.</span></span> <span data-ttu-id="1171f-150">Uma lista de conclusão recebe threads de trabalho UMS que concluíram a execução no kernel e estão prontas para execução no modo de usuário.</span><span class="sxs-lookup"><span data-stu-id="1171f-150">A completion list receives UMS worker threads that have completed execution in the kernel and are ready to run in user mode.</span></span> <span data-ttu-id="1171f-151">Somente o sistema pode enfileirar threads de trabalho para uma lista de conclusão.</span><span class="sxs-lookup"><span data-stu-id="1171f-151">Only the system can queue worker threads to a completion list.</span></span> <span data-ttu-id="1171f-152">Novos threads de trabalho do UMS são automaticamente enfileirados para a lista de conclusão especificada quando os threads foram criados.</span><span class="sxs-lookup"><span data-stu-id="1171f-152">New UMS worker threads are automatically queued to the completion list specified when the threads were created.</span></span> <span data-ttu-id="1171f-153">Os threads de trabalho bloqueados anteriormente também são enfileirados na lista de conclusão quando não estão mais bloqueados.</span><span class="sxs-lookup"><span data-stu-id="1171f-153">Previously blocked worker threads are also queued to the completion list when they are no longer blocked.</span></span>

<span data-ttu-id="1171f-154">Cada thread do Agendador do UMS é associado a uma única lista de conclusão.</span><span class="sxs-lookup"><span data-stu-id="1171f-154">Each UMS scheduler thread is associated with a single completion list.</span></span> <span data-ttu-id="1171f-155">No entanto, a mesma lista de conclusão pode ser associada a qualquer número de threads do Agendador UMS, e um thread do Agendador pode recuperar contextos UMS de qualquer lista de conclusão para a qual ele tem um ponteiro.</span><span class="sxs-lookup"><span data-stu-id="1171f-155">However, the same completion list can be associated with any number of UMS scheduler threads, and a scheduler thread can retrieve UMS contexts from any completion list for which it has a pointer.</span></span>

<span data-ttu-id="1171f-156">Cada lista de conclusão tem um evento associado que é sinalizado pelo sistema quando ele enfileira um ou mais threads de trabalho em uma lista vazia.</span><span class="sxs-lookup"><span data-stu-id="1171f-156">Each completion list has an associated event that is signaled by the system when it queues one or more worker threads to an empty list.</span></span> <span data-ttu-id="1171f-157">A função [**GetUmsCompletionListEvent**](/windows/desktop/api/WinBase/nf-winbase-getumscompletionlistevent) recupera um identificador para o evento para uma lista de conclusão especificada.</span><span class="sxs-lookup"><span data-stu-id="1171f-157">The [**GetUmsCompletionListEvent**](/windows/desktop/api/WinBase/nf-winbase-getumscompletionlistevent) function retrieves a handle to the event for a specified completion list.</span></span> <span data-ttu-id="1171f-158">Um aplicativo pode aguardar mais de um evento de lista de conclusão junto com outros eventos que fazem sentido para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="1171f-158">An application can wait on more than one completion list event along with other events that make sense for the application.</span></span>

## <a name="ums-scheduler-entry-point-function"></a><span data-ttu-id="1171f-159">Função de ponto de entrada do Agendador UMS</span><span class="sxs-lookup"><span data-stu-id="1171f-159">UMS Scheduler Entry Point Function</span></span>

<span data-ttu-id="1171f-160">A função de ponto de entrada do Agendador de um aplicativo é implementada como uma função [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) .</span><span class="sxs-lookup"><span data-stu-id="1171f-160">An application's scheduler entry point function is implemented as a [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) function.</span></span> <span data-ttu-id="1171f-161">O sistema chama a função de ponto de entrada do Agendador do aplicativo nos seguintes horários:</span><span class="sxs-lookup"><span data-stu-id="1171f-161">The system calls the application's scheduler entry point function at the following times:</span></span>

-   <span data-ttu-id="1171f-162">Quando um thread não UMS é convertido em um thread do Agendador do UMS chamando [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span><span class="sxs-lookup"><span data-stu-id="1171f-162">When a non-UMS thread is converted to a UMS scheduler thread by calling [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span></span>
-   <span data-ttu-id="1171f-163">Quando um thread de trabalho do UMS chama [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span><span class="sxs-lookup"><span data-stu-id="1171f-163">When a UMS worker thread calls [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span></span>
-   <span data-ttu-id="1171f-164">Quando um thread de trabalho do UMS é bloqueado em um serviço do sistema, como uma chamada do sistema ou uma falha de página.</span><span class="sxs-lookup"><span data-stu-id="1171f-164">When a UMS worker thread blocks on a system service such as a system call or a page fault.</span></span>

<span data-ttu-id="1171f-165">O parâmetro *Reason* da função [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) especifica o motivo pelo qual a função de ponto de entrada foi chamada.</span><span class="sxs-lookup"><span data-stu-id="1171f-165">The *Reason* parameter of the [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) function specifies the reason that the entry point function was called.</span></span> <span data-ttu-id="1171f-166">Se a função de ponto de entrada foi chamada porque um novo thread do Agendador UMS foi criado, o parâmetro *SchedulerParam* contém dados especificados pelo chamador de [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span><span class="sxs-lookup"><span data-stu-id="1171f-166">If the entry point function was called because a new UMS scheduler thread was created, the *SchedulerParam* parameter contains data specified by the caller of [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span></span> <span data-ttu-id="1171f-167">Se a função de ponto de entrada foi chamada porque um thread de trabalho UMS foi produzido, o parâmetro *SchedulerParam* conterá dados especificados pelo chamador de [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span><span class="sxs-lookup"><span data-stu-id="1171f-167">If the entry point function was called because a UMS worker thread yielded, the *SchedulerParam* parameter contains data specified by the caller of [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span></span> <span data-ttu-id="1171f-168">Se a função de ponto de entrada foi chamada porque um thread de trabalho do UMS foi bloqueado no kernel, o parâmetro *SchedulerParam* é nulo.</span><span class="sxs-lookup"><span data-stu-id="1171f-168">If the entry point function was called because a UMS worker thread blocked in the kernel, the *SchedulerParam* parameter is NULL.</span></span>

<span data-ttu-id="1171f-169">A função de ponto de entrada do Agendador é responsável por determinar a próxima ação apropriada para o thread especificado.</span><span class="sxs-lookup"><span data-stu-id="1171f-169">The scheduler entry point function is responsible for determining the appropriate next action for the specified thread.</span></span> <span data-ttu-id="1171f-170">Por exemplo, se um thread de trabalho estiver bloqueado, a função de ponto de entrada do Agendador poderá executar o próximo thread de trabalho do UMS Ready disponível.</span><span class="sxs-lookup"><span data-stu-id="1171f-170">For example, if a worker thread is blocked, the scheduler entry point function might run the next available ready UMS worker thread.</span></span>

<span data-ttu-id="1171f-171">Quando a função de ponto de entrada do Agendador é chamada, o Agendador do aplicativo deve tentar recuperar todos os itens em sua lista de conclusão associada chamando a função [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) .</span><span class="sxs-lookup"><span data-stu-id="1171f-171">When the scheduler entry point function is called, the application's scheduler should attempt to retrieve all of the items in its associated completion list by calling the [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) function.</span></span> <span data-ttu-id="1171f-172">Essa função recupera uma lista de contextos de thread UMS que concluíram o processamento no kernel e estão prontos para execução no modo de usuário.</span><span class="sxs-lookup"><span data-stu-id="1171f-172">This function retrieves a list of UMS thread contexts that have finished processing in the kernel and are ready to run in user mode.</span></span> <span data-ttu-id="1171f-173">O Agendador do aplicativo não deve executar threads UMS diretamente desta lista porque isso pode causar um comportamento imprevisível no aplicativo.</span><span class="sxs-lookup"><span data-stu-id="1171f-173">The application's scheduler should not run UMS threads directly from this list because this can cause unpredictable behavior in the application.</span></span> <span data-ttu-id="1171f-174">Em vez disso, o Agendador deve recuperar todos os contextos de thread UMS chamando a função [**GetNextUmsListItem**](/windows/desktop/api/WinBase/nf-winbase-getnextumslistitem) uma vez para cada contexto, inserir os contextos de thread UMS na fila de threads pronta do Agendador e, em seguida, executar threads de ums da fila de threads pronta.</span><span class="sxs-lookup"><span data-stu-id="1171f-174">Instead, the scheduler should retrieve all UMS thread contexts by calling the [**GetNextUmsListItem**](/windows/desktop/api/WinBase/nf-winbase-getnextumslistitem) function once for each context, insert the UMS thread contexts in the scheduler’s ready thread queue, and only then run UMS threads from the ready thread queue.</span></span>

<span data-ttu-id="1171f-175">Se o Agendador não precisar aguardar vários eventos, ele deverá chamar [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) com um parâmetro de tempo limite diferente de zero para que a função aguarde o evento da lista de conclusão antes de retornar.</span><span class="sxs-lookup"><span data-stu-id="1171f-175">If the scheduler does not need to wait on multiple events, it should call [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) with a nonzero timeout parameter so the function waits on the completion list event before returning.</span></span> <span data-ttu-id="1171f-176">Se o Agendador precisar aguardar vários eventos de lista de conclusão, ele deverá chamar **DequeueUmsCompletionListItems** com um parâmetro de tempo limite igual a zero para que a função retorne imediatamente, mesmo se a lista de conclusão estiver vazia.</span><span class="sxs-lookup"><span data-stu-id="1171f-176">If the scheduler does need to wait on multiple completion list events, it should call **DequeueUmsCompletionListItems** with a timeout parameter of zero so the function returns immediately, even if the completion list is empty.</span></span> <span data-ttu-id="1171f-177">Nesse caso, o Agendador pode aguardar explicitamente nos eventos da lista de conclusão, por exemplo, usando [**WaitForMultipleObjects**](/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects).</span><span class="sxs-lookup"><span data-stu-id="1171f-177">In this case, the scheduler can wait explicitly on completion list events, for example, by using [**WaitForMultipleObjects**](/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects).</span></span>

## <a name="ums-thread-execution"></a><span data-ttu-id="1171f-178">Execução de thread UMS</span><span class="sxs-lookup"><span data-stu-id="1171f-178">UMS Thread Execution</span></span>

<span data-ttu-id="1171f-179">Um thread de trabalho UMS criado recentemente é enfileirado na lista de conclusão especificada e não começa a ser executado até que o Agendador UMS do aplicativo o Selecione.</span><span class="sxs-lookup"><span data-stu-id="1171f-179">A newly created UMS worker thread is queued to the specified completion list and does not begin running until the application's UMS scheduler selects it to run.</span></span> <span data-ttu-id="1171f-180">Isso difere dos threads não UMS, que o Agendador do sistema agendará automaticamente para ser executado, a menos que o chamador crie explicitamente o thread suspenso.</span><span class="sxs-lookup"><span data-stu-id="1171f-180">This differs from non-UMS threads, which the system scheduler automatically schedules to run unless the caller explicitly creates the thread suspended.</span></span>

<span data-ttu-id="1171f-181">O Agendador executa um thread de trabalho chamando [**ExecuteUmsThread**](/windows/desktop/api/WinBase/nf-winbase-executeumsthread) com o contexto ums do thread de trabalho.</span><span class="sxs-lookup"><span data-stu-id="1171f-181">The scheduler runs a worker thread by calling [**ExecuteUmsThread**](/windows/desktop/api/WinBase/nf-winbase-executeumsthread) with the worker thread's UMS context.</span></span> <span data-ttu-id="1171f-182">Um thread de trabalho do UMS é executado até que ele resulte chamando a função [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield) , bloqueia ou termina.</span><span class="sxs-lookup"><span data-stu-id="1171f-182">A UMS worker thread runs until it yields by calling the [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield) function, blocks, or terminates.</span></span>

## <a name="ums-best-practices"></a><span data-ttu-id="1171f-183">Práticas recomendadas do UMS</span><span class="sxs-lookup"><span data-stu-id="1171f-183">UMS Best Practices</span></span>

<span data-ttu-id="1171f-184">Os aplicativos que implementam o UMS devem seguir estas práticas recomendadas:</span><span class="sxs-lookup"><span data-stu-id="1171f-184">Applications that implement UMS should follow these best practices:</span></span>

-   <span data-ttu-id="1171f-185">As estruturas subjacentes para contextos de thread UMS são gerenciadas pelo sistema e não devem ser modificadas diretamente.</span><span class="sxs-lookup"><span data-stu-id="1171f-185">The underlying structures for UMS thread contexts are managed by the system and should not be modified directly.</span></span> <span data-ttu-id="1171f-186">Em vez disso, use [**QueryUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-queryumsthreadinformation) e [**SetUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-setumsthreadinformation) para recuperar e definir informações sobre um thread de trabalho do ums.</span><span class="sxs-lookup"><span data-stu-id="1171f-186">Instead, use [**QueryUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-queryumsthreadinformation) and [**SetUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-setumsthreadinformation) to retrieve and set information about a UMS worker thread.</span></span>
-   <span data-ttu-id="1171f-187">Para ajudar a evitar deadlocks, o thread do Agendador do UMS não deve compartilhar bloqueios com threads de trabalho do UMS.</span><span class="sxs-lookup"><span data-stu-id="1171f-187">To help prevent deadlocks, the UMS scheduler thread should not share locks with UMS worker threads.</span></span> <span data-ttu-id="1171f-188">Isso inclui bloqueios criados por aplicativos e bloqueios do sistema que são adquiridos indiretamente por operações como alocar a partir do heap ou carregar DLLs.</span><span class="sxs-lookup"><span data-stu-id="1171f-188">This includes both application-created locks and system locks that are acquired indirectly by operations such as allocating from the heap or loading DLLs.</span></span> <span data-ttu-id="1171f-189">Por exemplo, suponha que o Agendador execute um thread de trabalho do UMS que carrega uma DLL.</span><span class="sxs-lookup"><span data-stu-id="1171f-189">For example, suppose the scheduler runs a UMS worker thread that loads a DLL.</span></span> <span data-ttu-id="1171f-190">O thread de trabalho adquire o bloqueio e os blocos do carregador.</span><span class="sxs-lookup"><span data-stu-id="1171f-190">The worker thread acquires the loader lock and blocks.</span></span> <span data-ttu-id="1171f-191">O sistema chama a função de ponto de entrada do Agendador, que, em seguida, carrega uma DLL.</span><span class="sxs-lookup"><span data-stu-id="1171f-191">The system calls the scheduler entry point function, which then loads a DLL.</span></span> <span data-ttu-id="1171f-192">Isso causa um deadlock, porque o bloqueio do carregador já está mantido e não pode ser liberado até que o primeiro thread seja desbloqueado.</span><span class="sxs-lookup"><span data-stu-id="1171f-192">This causes a deadlock, because the loader lock is already held and cannot be released until the first thread unblocks.</span></span> <span data-ttu-id="1171f-193">Para ajudar a evitar esse problema, delegue o trabalho que pode compartilhar bloqueios com threads de trabalho do UMS para um thread de trabalho UMS dedicado ou um thread que não seja de UMS.</span><span class="sxs-lookup"><span data-stu-id="1171f-193">To help avoid this problem, delegate work that might share locks with UMS worker threads to a dedicated UMS worker thread or a non-UMS thread.</span></span>
-   <span data-ttu-id="1171f-194">O UMS é mais eficiente quando a maioria dos processamentos é feita no modo de usuário.</span><span class="sxs-lookup"><span data-stu-id="1171f-194">UMS is most efficient when most processing is done in user mode.</span></span> <span data-ttu-id="1171f-195">Sempre que possível, evite fazer chamadas do sistema em threads de trabalho do UMS.</span><span class="sxs-lookup"><span data-stu-id="1171f-195">Whenever possible, avoid making system calls in UMS worker threads.</span></span>
-   <span data-ttu-id="1171f-196">Os threads de trabalho do UMS não devem assumir que o Agendador do sistema está sendo usado.</span><span class="sxs-lookup"><span data-stu-id="1171f-196">UMS worker threads should not assume the system scheduler is being used.</span></span> <span data-ttu-id="1171f-197">Essa suposição pode ter efeitos sutis; por exemplo, se um thread no código desconhecido definir uma prioridade ou afinidade de thread, o Agendador UMS ainda poderá substituí-lo.</span><span class="sxs-lookup"><span data-stu-id="1171f-197">This assumption can have subtle effects; for example, if a thread in the unknown code sets a thread priority or affinity, the UMS scheduler might still override it.</span></span> <span data-ttu-id="1171f-198">O código que assume que o Agendador do sistema está sendo usado pode não se comportar conforme o esperado e pode ser interrompido quando chamado por um thread UMS.</span><span class="sxs-lookup"><span data-stu-id="1171f-198">Code that assumes the system scheduler is being used may not behave as expected and may break when called by a UMS thread.</span></span>
-   <span data-ttu-id="1171f-199">O sistema pode precisar bloquear o contexto de thread de um thread de trabalho do UMS.</span><span class="sxs-lookup"><span data-stu-id="1171f-199">The system may need to lock the thread context of a UMS worker thread.</span></span> <span data-ttu-id="1171f-200">Por exemplo, uma APC (chamada de procedimento assíncrono) do modo kernel pode alterar o contexto do thread UMS, portanto, o contexto do thread deve ser bloqueado.</span><span class="sxs-lookup"><span data-stu-id="1171f-200">For example, a kernel-mode asynchronous procedure call (APC) might change the context of the UMS thread, so the thread context must be locked.</span></span> <span data-ttu-id="1171f-201">Se o Agendador tentar executar o contexto do thread UMS enquanto ele estiver bloqueado, a chamada falhará.</span><span class="sxs-lookup"><span data-stu-id="1171f-201">If the scheduler tries to execute the UMS thread context while it is locked, the call will fail.</span></span> <span data-ttu-id="1171f-202">Esse comportamento é por design, e o Agendador deve ser projetado para tentar novamente o acesso ao contexto do thread UMS.</span><span class="sxs-lookup"><span data-stu-id="1171f-202">This behavior is by design, and the scheduler should be designed to retry access to the UMS thread context.</span></span>

 

 
