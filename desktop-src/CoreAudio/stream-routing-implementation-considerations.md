---
description: Saiba mais sobre as considerações de implementação para roteamento de fluxo. As APIs implementam o roteamento de fluxo manipulando a alternação de fluxo para um novo ponto de extremidade de áudio padrão.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Considerações sobre implementação de roteamento de fluxo
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 62bd753fe027c92ffac9f5a41cea589b600d7f26
ms.sourcegitcommit: 51ef825fb48f15e1aa30e8795988f10dc2b2155c
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 06/14/2021
ms.locfileid: "112068032"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="75638-104">Considerações sobre implementação de roteamento de fluxo</span><span class="sxs-lookup"><span data-stu-id="75638-104">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="75638-105">No Windows 7, as APIs de plataforma de alto nível que usam APIs de áudio principais, como apIs de áudio Media Foundation, DirectSound e Wave, implementam o recurso de roteamento de fluxo manipulando a troca de fluxo de um dispositivo existente para um novo ponto de extremidade de áudio padrão.</span><span class="sxs-lookup"><span data-stu-id="75638-105">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="75638-106">Os aplicativos de mídia que usam essas APIs usam o comportamento de roteamento de fluxo sem nenhuma modificação na origem.</span><span class="sxs-lookup"><span data-stu-id="75638-106">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="75638-107">Os clientes WASAPI diretos podem usar as notificações enviadas pelos componentes do Core Audio e implementar o recurso de roteamento de fluxo.</span><span class="sxs-lookup"><span data-stu-id="75638-107">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="75638-108">Clientes WASAPI diretos (aplicativos de mídia que usam WASAPI diretamente) recebem novas notificações de dispositivo e de sessão de áudio enviadas pelos componentes do Core Audio.</span><span class="sxs-lookup"><span data-stu-id="75638-108">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="75638-109">O comportamento do recurso de roteamento de fluxo é definido por como o aplicativo lida com essas notificações.</span><span class="sxs-lookup"><span data-stu-id="75638-109">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="75638-110">A API MMDevice e a sessão de áudio enviam notificações sobre alterações de estado do dispositivo e alterações de sessão para clientes WASAPI na forma de retornos de chamada.</span><span class="sxs-lookup"><span data-stu-id="75638-110">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="75638-111">Para obter essas notificações, o cliente deve registrar sua implementação [**de IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) e [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span><span class="sxs-lookup"><span data-stu-id="75638-111">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="75638-112">Para obter mais informações, consulte [Notificações relevantes para roteamento de fluxo.](relevant-device-notifications-for-stream-routing.md)</span><span class="sxs-lookup"><span data-stu-id="75638-112">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="75638-113">No cenário de headset USB descrito em [Roteamento](stream-routing.md)de Fluxo, um aplicativo está tocando um fluxo de áudio e usa MMDeviceAPI e WASAPI para renderizar o fluxo no dispositivo de renderização padrão, o **Locutor**.</span><span class="sxs-lookup"><span data-stu-id="75638-113">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="75638-114">Quando o dispositivo padrão é alterado, o aplicativo recebe uma [**notificação IMMNotificationClient.**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient)</span><span class="sxs-lookup"><span data-stu-id="75638-114">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="75638-115">O aplicativo também recebe notificações [**de IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) indicando que o usuário removeu o dispositivo de ponto de extremidade de áudio ou que o formato de fluxo foi alterado para o dispositivo ao qual a sessão de áudio está conectada.</span><span class="sxs-lookup"><span data-stu-id="75638-115">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="75638-116">Após receber as notificações, o aplicativo interrompe o streaming para o ponto de extremidade do locutor e reabre o fluxo para renderização no ponto de extremidade padrão atual, o headset.</span><span class="sxs-lookup"><span data-stu-id="75638-116">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![diagrama do fluxo de dados para notificações do dispositivo.](images/stream-routing.gif)

<span data-ttu-id="75638-118">Em resposta a essas notificações, o cliente pode reabrir o fluxo no novo dispositivo padrão no novo formato selecionado pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="75638-118">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="75638-119">Stream Managment</span><span class="sxs-lookup"><span data-stu-id="75638-119">Stream Managment</span></span>

<span data-ttu-id="75638-120">A lista a seguir resume as etapas que um cliente WASAPI deve executar para fornecer a funcionalidade de troca de fluxo.</span><span class="sxs-lookup"><span data-stu-id="75638-120">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="75638-121">Aguarde a notificação [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) relevante.</span><span class="sxs-lookup"><span data-stu-id="75638-121">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="75638-122">Se o dispositivo for o dispositivo padrão, a notificação [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) será recebida.</span><span class="sxs-lookup"><span data-stu-id="75638-122">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="75638-123">Se um novo dispositivo estiver disponível, obter uma referência ao ponto de extremidade do novo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="75638-123">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="75638-124">Chame [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) para o novo dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="75638-124">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="75638-125">Se o novo dispositivo não for o dispositivo padrão, você poderá recuperar o dispositivo chamando [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span><span class="sxs-lookup"><span data-stu-id="75638-125">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="75638-126">Para obter mais informações, consulte [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="75638-126">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="75638-127">Aguarde o [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) com o valor do motivo.</span><span class="sxs-lookup"><span data-stu-id="75638-127">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="75638-128">Como todas essas operações são assíncronas, a ordem na qual o aplicativo recebe notificações de alteração de dispositivo e desconexão de sessão não pode ser prevista.</span><span class="sxs-lookup"><span data-stu-id="75638-128">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="75638-129">O aplicativo deve implementar o tratamento de notificação para receber essas notificações em qualquer ordem.</span><span class="sxs-lookup"><span data-stu-id="75638-129">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="75638-130">No entanto, normalmente, o aplicativo recebe o **valor AudioSessionDisconnect** antes da notificação de alteração do dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="75638-130">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="75638-131">Avalie o valor do motivo e determine se o fluxo precisa ser transferido para outro ponto de extremidade de áudio ou se o fluxo precisa ser reinicializado com um novo formato.</span><span class="sxs-lookup"><span data-stu-id="75638-131">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="75638-132">Pare o streaming para o dispositivo padrão antigo se o motivo indicar que o fluxo deve ser roteado para o novo dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="75638-132">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="75638-133">Executar cálculos de mapeamento de posição.</span><span class="sxs-lookup"><span data-stu-id="75638-133">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="75638-134">Abra o fluxo no novo dispositivo e transfira todas as informações de estado.</span><span class="sxs-lookup"><span data-stu-id="75638-134">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="75638-135">Retome o streaming no novo dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="75638-135">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="75638-136">Manipular a partida do dispositivo padrão antigo.</span><span class="sxs-lookup"><span data-stu-id="75638-136">Handle the departure of the old default device.</span></span>

<span data-ttu-id="75638-137">Para que a operação de alternação de fluxo pareça perfeita, ela deve ser feita o mais rápido possível.</span><span class="sxs-lookup"><span data-stu-id="75638-137">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="75638-138">Isso depende do desempenho dos componentes envolvidos na re-inicialização do fluxo no novo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="75638-138">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="75638-139">Considerações sobre mapeamento de posição</span><span class="sxs-lookup"><span data-stu-id="75638-139">Position Mapping Considerations</span></span>

<span data-ttu-id="75638-140">Quando o aplicativo obtém notificações [**de IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) e [**IAudioSessionEvents,**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) ele pode rotear os fluxos existentes para o novo dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="75638-140">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="75638-141">Quando um fluxo de áudio existente é interrompido e aberto no novo dispositivo, a renderização no novo dispositivo deve começar na posição em que o fluxo foi interrompido no dispositivo antigo.</span><span class="sxs-lookup"><span data-stu-id="75638-141">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="75638-142">Para fazer isso, o aplicativo deve ter a última posição de dispositivo conhecida para calcular a posição inicial no novo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="75638-142">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="75638-143">Por exemplo, essa posição pode ser usada como o deslocamento delta para mapeamento de posição subsequente.</span><span class="sxs-lookup"><span data-stu-id="75638-143">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="75638-144">Quando o fluxo inicia a renderização, a nova posição do dispositivo pode ser remapped para a posição do dispositivo armazenado em cache.</span><span class="sxs-lookup"><span data-stu-id="75638-144">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="75638-145">As etapas a seguir resumem o processo de fazer uma transição contínua de fluxo.</span><span class="sxs-lookup"><span data-stu-id="75638-145">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="75638-146">Armazenar em cache a última posição do dispositivo do fluxo no dispositivo antigo.</span><span class="sxs-lookup"><span data-stu-id="75638-146">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="75638-147">Pare o fluxo no dispositivo antigo.</span><span class="sxs-lookup"><span data-stu-id="75638-147">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="75638-148">Execute cálculos de remapeamento para obter a nova posição.</span><span class="sxs-lookup"><span data-stu-id="75638-148">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="75638-149">Comece a renderizar o fluxo no novo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="75638-149">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="75638-150">Libere o fluxo antigo.</span><span class="sxs-lookup"><span data-stu-id="75638-150">Release the old stream.</span></span>

<span data-ttu-id="75638-151">Durante a transição, o aplicativo deve garantir que o relógio não saia da sincronização, resultando em fluxos de áudio e vídeo fora de sincronia.</span><span class="sxs-lookup"><span data-stu-id="75638-151">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="75638-152">Isso pode ocorrer se os exemplos de vídeo continuarem a ser renderados enquanto o fluxo de áudio é roteado para o novo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="75638-152">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="75638-153">O aplicativo deve armazenar em cache a posição do relógio para o cálculo de remapeamento e garantir que os exemplos de vídeo não sejam renderizados até que o fluxo de áudio seja reaberto no novo dispositivo, para que, quando o clipe retomar a renderização, o áudio e os fluxos de vídeo sejam sincronizados.</span><span class="sxs-lookup"><span data-stu-id="75638-153">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="75638-154">Em alguns casos, em que o tempo de apresentação para renderizar os quadros de vídeo é baseado no relógio de áudio, é suficiente interromper o fluxo de áudio até que a alternação de fluxo seja concluída e nenhuma outra implementação de mapeamento de posição para o fluxo de vídeo seja necessária para sincronização de vídeo de áudio.</span><span class="sxs-lookup"><span data-stu-id="75638-154">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="75638-155">Se, durante a renderização, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) retornar um erro porque o dispositivo antigo foi perdido, o aplicativo não precisará interromper o fluxo antigo porque a operação de streaming já foi encerrada.</span><span class="sxs-lookup"><span data-stu-id="75638-155">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="75638-156">Para obter informações sobre como tratar esse erro, consulte [Recuperando de um erro Invalid-Device erro](recovering-from-an-invalid-device-error.md).</span><span class="sxs-lookup"><span data-stu-id="75638-156">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="75638-157">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="75638-157">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="75638-158">Sobre a API MMDevice</span><span class="sxs-lookup"><span data-stu-id="75638-158">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="75638-159">Sobre WASAPI</span><span class="sxs-lookup"><span data-stu-id="75638-159">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="75638-160">Roteamento de fluxo</span><span class="sxs-lookup"><span data-stu-id="75638-160">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



