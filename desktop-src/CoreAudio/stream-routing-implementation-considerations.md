---
description: No Windows 7, as APIs de plataforma de alto nível que usam APIs de áudio de núcleo, como as APIs Media Foundation, DirectSound e Wave, implementam o recurso de roteamento de fluxo manipulando a alternância de fluxo de um dispositivo existente para um novo ponto de extremidade de áudio padrão.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Considerações de implementação de roteamento de fluxo
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 27dc1f7e3fe56d6b421ca59f528ab1a65d2261a9
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103920404"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="73a68-103">Considerações de implementação de roteamento de fluxo</span><span class="sxs-lookup"><span data-stu-id="73a68-103">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="73a68-104">No Windows 7, as APIs de plataforma de alto nível que usam APIs de áudio de núcleo, como as APIs Media Foundation, DirectSound e Wave, implementam o recurso de roteamento de fluxo manipulando a alternância de fluxo de um dispositivo existente para um novo ponto de extremidade de áudio padrão.</span><span class="sxs-lookup"><span data-stu-id="73a68-104">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="73a68-105">Os aplicativos de mídia que usam essas APIs usam o comportamento de roteamento de fluxo sem nenhuma modificação na origem.</span><span class="sxs-lookup"><span data-stu-id="73a68-105">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="73a68-106">Os clientes Direct WASAPI podem usar as notificações enviadas pelos componentes de áudio principal e implementar o recurso de roteamento de fluxo.</span><span class="sxs-lookup"><span data-stu-id="73a68-106">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="73a68-107">Os clientes Direct WASAPI (aplicativos de mídia que usam o WASAPI diretamente) recebem novas notificações de dispositivo e de sessão de áudio enviadas por componentes de áudio principais.</span><span class="sxs-lookup"><span data-stu-id="73a68-107">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="73a68-108">O comportamento do recurso de roteamento de fluxo é definido por como o aplicativo manipula essas notificações.</span><span class="sxs-lookup"><span data-stu-id="73a68-108">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="73a68-109">A API MMDevice e a sessão de áudio enviam notificações sobre alterações de estado do dispositivo e alterações de sessão para clientes WASAPI na forma de retornos de chamada.</span><span class="sxs-lookup"><span data-stu-id="73a68-109">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="73a68-110">Para obter essas notificações, o cliente deve registrar sua implementação de [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) e [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span><span class="sxs-lookup"><span data-stu-id="73a68-110">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="73a68-111">Para obter mais informações, consulte [notificações relevantes para roteamento de fluxo](relevant-device-notifications-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="73a68-111">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="73a68-112">No cenário de headset USB descrito em [Roteamento de fluxo](stream-routing.md), um aplicativo está reproduzindo um fluxo de áudio e usa MMDEVICEAPI e WASAPI para renderizar o fluxo no dispositivo de renderização padrão, no **palestrante**.</span><span class="sxs-lookup"><span data-stu-id="73a68-112">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="73a68-113">Quando o dispositivo padrão é alterado, o aplicativo recebe uma notificação [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) .</span><span class="sxs-lookup"><span data-stu-id="73a68-113">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="73a68-114">O aplicativo também recebe notificações [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) indicando que o usuário removeu o dispositivo de ponto de extremidade de áudio ou que o formato de fluxo foi alterado para o dispositivo ao qual a sessão de áudio está conectada.</span><span class="sxs-lookup"><span data-stu-id="73a68-114">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="73a68-115">Após o recebimento das notificações, o aplicativo para de streaming para o ponto de extremidade do orador e reabre o fluxo para renderização no ponto de extremidade padrão atual, o headset.</span><span class="sxs-lookup"><span data-stu-id="73a68-115">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![diagrama de fluxo de dados para notificações de dispositivo.](images/stream-routing.gif)

<span data-ttu-id="73a68-117">Em resposta a tais notificações, o cliente pode reabrir o fluxo no novo dispositivo padrão no novo formato selecionado pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="73a68-117">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="73a68-118">Gerenciamento de fluxo</span><span class="sxs-lookup"><span data-stu-id="73a68-118">Stream Managment</span></span>

<span data-ttu-id="73a68-119">A lista a seguir resume as etapas que um cliente WASAPI deve executar para fornecer a funcionalidade de comutação de fluxo.</span><span class="sxs-lookup"><span data-stu-id="73a68-119">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="73a68-120">Aguarde a notificação de [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) relevante.</span><span class="sxs-lookup"><span data-stu-id="73a68-120">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="73a68-121">Se o dispositivo for o dispositivo padrão, a notificação [**IMMNotificationClient:: OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) será recebida.</span><span class="sxs-lookup"><span data-stu-id="73a68-121">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="73a68-122">Se um novo dispositivo estiver disponível, obtenha uma referência para o ponto de extremidade do novo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="73a68-122">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="73a68-123">Chame [**IMMDeviceEnumerator:: GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) para o novo dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="73a68-123">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="73a68-124">Se o novo dispositivo não for o dispositivo padrão, você poderá recuperar o dispositivo chamando [**IMMDeviceEnumerator:: GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span><span class="sxs-lookup"><span data-stu-id="73a68-124">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="73a68-125">Para obter mais informações, consulte [obtendo o ponto de extremidade do dispositivo para roteamento de fluxo](getting-the-default-device-endpoint-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="73a68-125">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="73a68-126">Aguarde o [**IAudioSessionEvents:: OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) com o valor do motivo.</span><span class="sxs-lookup"><span data-stu-id="73a68-126">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="73a68-127">Como todas essas operações são assíncrona, a ordem na qual o aplicativo recebe notificações de alteração de dispositivo e de desconexão de sessão não foi possível ser prevista.</span><span class="sxs-lookup"><span data-stu-id="73a68-127">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="73a68-128">O aplicativo deve implementar o tratamento de notificação para receber essas notificações em qualquer ordem.</span><span class="sxs-lookup"><span data-stu-id="73a68-128">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="73a68-129">No entanto, normalmente, o aplicativo recebe o valor de **AudioSessionDisconnect** antes da notificação de alteração de dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="73a68-129">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="73a68-130">Avalie o valor do motivo e determine se o fluxo precisa ser transferido para outro ponto de extremidade de áudio ou se o fluxo precisa ser reinicializado com um novo formato.</span><span class="sxs-lookup"><span data-stu-id="73a68-130">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="73a68-131">Pare o streaming para o dispositivo padrão antigo se o motivo indicar que o fluxo deve ser roteado novamente para o novo dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="73a68-131">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="73a68-132">Executar cálculos de mapeamento de posição.</span><span class="sxs-lookup"><span data-stu-id="73a68-132">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="73a68-133">Abra o fluxo no novo dispositivo e transfira todas as informações de estado.</span><span class="sxs-lookup"><span data-stu-id="73a68-133">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="73a68-134">Retomar streaming no novo dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="73a68-134">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="73a68-135">Manipule a saída do antigo dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="73a68-135">Handle the departure of the old default device.</span></span>

<span data-ttu-id="73a68-136">Para fazer com que a operação de alternância de fluxo pareça direta, ela deve ser feita o mais rapidamente possível.</span><span class="sxs-lookup"><span data-stu-id="73a68-136">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="73a68-137">Isso depende do desempenho dos componentes envolvidos na reinicialização do fluxo no novo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="73a68-137">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="73a68-138">Considerações sobre mapeamento de posição</span><span class="sxs-lookup"><span data-stu-id="73a68-138">Position Mapping Considerations</span></span>

<span data-ttu-id="73a68-139">Quando o aplicativo obtém notificações [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) e [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) , ele pode rotear os fluxos existentes para o novo dispositivo padrão.</span><span class="sxs-lookup"><span data-stu-id="73a68-139">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="73a68-140">Quando um fluxo de áudio existente é interrompido e aberto no novo dispositivo, a renderização no novo dispositivo deve começar na posição em que o fluxo foi interrompido no dispositivo antigo.</span><span class="sxs-lookup"><span data-stu-id="73a68-140">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="73a68-141">Para fazer isso, o aplicativo deve ter a última posição de dispositivo conhecida para calcular a posição inicial no novo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="73a68-141">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="73a68-142">Por exemplo, essa posição pode ser usada como o deslocamento Delta para mapeamento de posição subsequente.</span><span class="sxs-lookup"><span data-stu-id="73a68-142">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="73a68-143">Quando o fluxo inicia a renderização, a nova posição do dispositivo pode ser remapeada para a posição do dispositivo em cache.</span><span class="sxs-lookup"><span data-stu-id="73a68-143">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="73a68-144">As etapas a seguir resumem o processo de fazer uma transição de fluxo contínuo.</span><span class="sxs-lookup"><span data-stu-id="73a68-144">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="73a68-145">Armazenar em cache a última posição do dispositivo do fluxo no dispositivo antigo.</span><span class="sxs-lookup"><span data-stu-id="73a68-145">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="73a68-146">Pare o fluxo no dispositivo antigo.</span><span class="sxs-lookup"><span data-stu-id="73a68-146">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="73a68-147">Execute remapeando cálculos para obter a nova posição.</span><span class="sxs-lookup"><span data-stu-id="73a68-147">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="73a68-148">Comece a renderizar o fluxo no novo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="73a68-148">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="73a68-149">Libere o fluxo antigo.</span><span class="sxs-lookup"><span data-stu-id="73a68-149">Release the old stream.</span></span>

<span data-ttu-id="73a68-150">Durante a transição, o aplicativo deve garantir que o relógio não seja sincronizado, resultando em fluxos de áudio e vídeo fora de sincronia.</span><span class="sxs-lookup"><span data-stu-id="73a68-150">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="73a68-151">Isso pode ocorrer se os exemplos de vídeo continuarem a ser renderizados enquanto o fluxo de áudio é roteado para o novo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="73a68-151">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="73a68-152">O aplicativo deve armazenar em cache a posição do relógio para o cálculo do remapeamento e certificar-se de que os exemplos de vídeo não sejam renderizados até que o fluxo de áudio seja reaberto no novo dispositivo, para que, quando o clipe retomar a renderização, os fluxos de áudio e de vídeo sejam sincronizados.</span><span class="sxs-lookup"><span data-stu-id="73a68-152">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="73a68-153">Em alguns casos, onde o tempo de apresentação para renderizar os quadros de vídeo é baseado no relógio de áudio, é suficiente parar o fluxo de áudio até que a alternância de fluxo seja concluída e nenhuma outra implementação de mapeamento de posição para o fluxo de vídeo é necessária para a sincronização de vídeo em áudio.</span><span class="sxs-lookup"><span data-stu-id="73a68-153">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="73a68-154">Se durante a renderização, [**IAudioRenderClient:: GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) retornará um erro porque o dispositivo antigo é perdido, o aplicativo não precisa parar o fluxo antigo porque a operação de streaming já foi encerrada.</span><span class="sxs-lookup"><span data-stu-id="73a68-154">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="73a68-155">Para obter informações sobre como lidar com esse erro, consulte [recuperando de um erro de Invalid-Device](recovering-from-an-invalid-device-error.md).</span><span class="sxs-lookup"><span data-stu-id="73a68-155">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="73a68-156">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="73a68-156">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="73a68-157">Sobre a API do MMDevice</span><span class="sxs-lookup"><span data-stu-id="73a68-157">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="73a68-158">Sobre o WASAPI</span><span class="sxs-lookup"><span data-stu-id="73a68-158">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="73a68-159">Roteamento de fluxo</span><span class="sxs-lookup"><span data-stu-id="73a68-159">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



