---
description: Os componentes geralmente são projetados para executar tarefas de inicialização quando são chamados pela primeira vez, em vez de quando são carregados.
ms.assetid: 404c083c-7bee-44c2-b8e7-da1901b6ab2f
title: Inicialização de One-Time
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 16f451e3c51716b4ff6f33b55d8d8602b5d5c28f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "105753699"
---
# <a name="one-time-initialization"></a><span data-ttu-id="23cba-103">Inicialização de One-Time</span><span class="sxs-lookup"><span data-stu-id="23cba-103">One-Time Initialization</span></span>

<span data-ttu-id="23cba-104">Os componentes geralmente são projetados para executar tarefas de inicialização quando são chamados pela primeira vez, em vez de quando são carregados.</span><span class="sxs-lookup"><span data-stu-id="23cba-104">Components are often designed to perform initialization tasks when they are first called, rather than when they are loaded.</span></span> <span data-ttu-id="23cba-105">As funções de inicialização única garantem que essa inicialização ocorra apenas uma vez, mesmo quando vários threads podem tentar a inicialização.</span><span class="sxs-lookup"><span data-stu-id="23cba-105">The one-time initialization functions ensure that this initialization occurs only once, even when multiple threads may attempt the initialization.</span></span>

<span data-ttu-id="23cba-106">**Windows Server 2003 e Windows XP:** Os aplicativos devem fornecer sua própria sincronização para inicialização única usando as [funções](interlocked-variable-access.md) interligadas ou outro mecanismo de sincronização.</span><span class="sxs-lookup"><span data-stu-id="23cba-106">**Windows Server 2003 and Windows XP:** Applications must provide their own synchronization for one-time initialization by using the [interlocked functions](interlocked-variable-access.md) or other synchronization mechanism.</span></span> <span data-ttu-id="23cba-107">As funções de inicialização única estão disponíveis a partir do Windows Vista e do Windows Server 2008.</span><span class="sxs-lookup"><span data-stu-id="23cba-107">The one-time initialization functions are available starting with Windows Vista and Windows Server 2008.</span></span>

<span data-ttu-id="23cba-108">As funções de inicialização única fornecem vantagens significativas para garantir que apenas um thread execute a inicialização:</span><span class="sxs-lookup"><span data-stu-id="23cba-108">The one-time initialization functions provide significant advantages to ensure that only one thread performs the initialization:</span></span>

-   <span data-ttu-id="23cba-109">Eles são otimizados para velocidade.</span><span class="sxs-lookup"><span data-stu-id="23cba-109">They are optimized for speed.</span></span>
-   <span data-ttu-id="23cba-110">Eles criam as barreiras apropriadas em arquiteturas de processador que os exigem.</span><span class="sxs-lookup"><span data-stu-id="23cba-110">They create the appropriate barriers on processor architectures that require them.</span></span>
-   <span data-ttu-id="23cba-111">Eles dão suporte a inicialização bloqueada e paralela.</span><span class="sxs-lookup"><span data-stu-id="23cba-111">They support both locked and parallel initialization.</span></span>
-   <span data-ttu-id="23cba-112">Eles evitam o bloqueio interno para que o código possa operar de forma assíncrona ou síncrona.</span><span class="sxs-lookup"><span data-stu-id="23cba-112">They avoid internal locking so the code can operate asynchronously or synchronously.</span></span>

<span data-ttu-id="23cba-113">O sistema gerencia o processo de inicialização por meio de uma estrutura de **inicialização opaca \_ uma vez** que contém dados e informações de estado.</span><span class="sxs-lookup"><span data-stu-id="23cba-113">The system manages the initialization process through an opaque **INIT\_ONCE** structure that contains data and state information.</span></span> <span data-ttu-id="23cba-114">O chamador aloca essa estrutura e a inicializa chamando [**InitOnceInitialize**](/windows/win32/api/synchapi/nf-synchapi-initonceinitialize) (para inicializar a estrutura dinamicamente) ou atribuindo a constante **init \_ uma vez \_ estática \_ init** à variável de estrutura (para inicializar a estrutura estaticamente).</span><span class="sxs-lookup"><span data-stu-id="23cba-114">The caller allocates this structure and initializes it by either calling [**InitOnceInitialize**](/windows/win32/api/synchapi/nf-synchapi-initonceinitialize) (to initialize the structure dynamically) or assigning the constant **INIT\_ONCE\_STATIC\_INIT** to the structure variable (to initialize the structure statically).</span></span> <span data-ttu-id="23cba-115">Inicialmente, os dados armazenados na estrutura de inicialização única são nulos e seu estado não é inicializado.</span><span class="sxs-lookup"><span data-stu-id="23cba-115">Initially, the data stored in the one-time initialization structure is NULL and its state is uninitialized.</span></span>

<span data-ttu-id="23cba-116">Estruturas de inicialização única não podem ser compartilhadas entre processos.</span><span class="sxs-lookup"><span data-stu-id="23cba-116">One-time initialization structures cannot be shared across processes.</span></span>

<span data-ttu-id="23cba-117">O thread que executa a inicialização pode, opcionalmente, definir um contexto que está disponível para o chamador após a conclusão da inicialização.</span><span class="sxs-lookup"><span data-stu-id="23cba-117">The thread that performs the initialization can optionally set a context that is available to the caller after initialization is complete.</span></span> <span data-ttu-id="23cba-118">O contexto pode ser um objeto de sincronização ou pode ser um valor ou estrutura de dados.</span><span class="sxs-lookup"><span data-stu-id="23cba-118">The context can be a synchronization object or it can be a value or data structure.</span></span> <span data-ttu-id="23cba-119">Se o contexto for um valor, sua inicialização de ordem **inferior \_ uma vez que os \_ \_ \_ bits reservados CTX** devem ser zero.</span><span class="sxs-lookup"><span data-stu-id="23cba-119">If the context is a value, its low-order **INIT\_ONCE\_CTX\_RESERVED\_BITS** must be zero.</span></span> <span data-ttu-id="23cba-120">Se o contexto for uma estrutura de dados, a estrutura de dados deverá ser alinhada em **DWORD**.</span><span class="sxs-lookup"><span data-stu-id="23cba-120">If the context is a data structure, the data structure must be **DWORD**-aligned.</span></span> <span data-ttu-id="23cba-121">O contexto é retornado para o chamador no parâmetro de saída *lpContext* da função [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) ou [**InitOnceExecuteOnce**](/windows/win32/api/synchapi/nf-synchapi-initonceexecuteonce) .</span><span class="sxs-lookup"><span data-stu-id="23cba-121">The context is returned to the caller in the *lpContext* output parameter of the [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) or [**InitOnceExecuteOnce**](/windows/win32/api/synchapi/nf-synchapi-initonceexecuteonce) function.</span></span>

<span data-ttu-id="23cba-122">A inicialização única pode ser executada de forma síncrona ou assíncrona.</span><span class="sxs-lookup"><span data-stu-id="23cba-122">One-time initialization can be performed synchronously or asynchronously.</span></span> <span data-ttu-id="23cba-123">Uma função de retorno de chamada opcional pode ser usada para inicialização única síncrona.</span><span class="sxs-lookup"><span data-stu-id="23cba-123">An optional callback function can be used for synchronous one-time initialization.</span></span>

## <a name="synchronous-one-time-initialization"></a><span data-ttu-id="23cba-124">Inicialização única síncrona</span><span class="sxs-lookup"><span data-stu-id="23cba-124">Synchronous One-time Initialization</span></span>

<span data-ttu-id="23cba-125">As etapas a seguir descrevem a inicialização única síncrona que não usa uma função de retorno de chamada.</span><span class="sxs-lookup"><span data-stu-id="23cba-125">The following steps describe synchronous one-time initialization that does not use a callback function.</span></span>

1.  <span data-ttu-id="23cba-126">O primeiro thread para chamar a função [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) faz com que a inicialização única seja iniciada.</span><span class="sxs-lookup"><span data-stu-id="23cba-126">The first thread to call the [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) function successfully causes one-time initialization to begin.</span></span> <span data-ttu-id="23cba-127">Para inicialização única síncrona, **InitOnceBeginInitialize** deve ser chamado sem o sinalizador **assíncrono Init \_ Once \_** .</span><span class="sxs-lookup"><span data-stu-id="23cba-127">For synchronous one-time initialization, **InitOnceBeginInitialize** must be called without the **INIT\_ONCE\_ASYNC** flag.</span></span>
2.  <span data-ttu-id="23cba-128">Os threads subsequentes que tentam a inicialização são bloqueados até que o primeiro thread conclua a inicialização ou falhe.</span><span class="sxs-lookup"><span data-stu-id="23cba-128">Subsequent threads that attempt initialization are blocked until the first thread either completes initialization or fails.</span></span> <span data-ttu-id="23cba-129">Se o primeiro thread falhar, o próximo thread terá permissão para tentar a inicialização e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="23cba-129">If the first thread fails, the next thread is allowed to attempt the initialization, and so on.</span></span>
3.  <span data-ttu-id="23cba-130">Quando a inicialização é concluída, o thread chama a função [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) .</span><span class="sxs-lookup"><span data-stu-id="23cba-130">When initialization is finished, the thread calls the [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) function.</span></span> <span data-ttu-id="23cba-131">Opcionalmente, o thread pode criar um objeto de sincronização (ou outros dados de contexto) e especificá-lo no parâmetro *lpContext* da função **InitOnceComplete** .</span><span class="sxs-lookup"><span data-stu-id="23cba-131">The thread can optionally create a synchronization object (or other context data) and specify it in the *lpContext* parameter of the **InitOnceComplete** function.</span></span>
4.  <span data-ttu-id="23cba-132">Se a inicialização for realizada com sucesso, o estado da estrutura de inicialização única será alterado para inicializado e o identificador *lpContext* (se houver) será armazenado na estrutura de inicialização.</span><span class="sxs-lookup"><span data-stu-id="23cba-132">If the initialization succeeds, the state of the one-time initialization structure is changed to initialized and the *lpContext* handle (if any) is stored in the initialization structure.</span></span> <span data-ttu-id="23cba-133">As tentativas de inicialização subsequentes retornam esses dados de contexto.</span><span class="sxs-lookup"><span data-stu-id="23cba-133">Subsequent initialization attempts return this context data.</span></span> <span data-ttu-id="23cba-134">Se a inicialização falhar, os dados serão **nulos**.</span><span class="sxs-lookup"><span data-stu-id="23cba-134">If the initialization fails, the data is **NULL**.</span></span>

<span data-ttu-id="23cba-135">As etapas a seguir descrevem a inicialização única síncrona que usa uma função de retorno de chamada.</span><span class="sxs-lookup"><span data-stu-id="23cba-135">The following steps describe synchronous one-time initialization that uses a callback function.</span></span>

1.  <span data-ttu-id="23cba-136">O primeiro thread a chamar com êxito a função [**InitOnceExecuteOnce**](/windows/win32/api/synchapi/nf-synchapi-initonceexecuteonce) passa um ponteiro para uma função de retorno de chamada [*InitOnceCallback*](/windows/win32/api/synchapi/nc-synchapi-pinit_once_fn) definida pelo aplicativo e quaisquer dados exigidos pela função de retorno de chamada.</span><span class="sxs-lookup"><span data-stu-id="23cba-136">The first thread to successfully call the [**InitOnceExecuteOnce**](/windows/win32/api/synchapi/nf-synchapi-initonceexecuteonce) function passes a pointer to an application-defined [*InitOnceCallback*](/windows/win32/api/synchapi/nc-synchapi-pinit_once_fn) callback function and any data required by the callback function.</span></span> <span data-ttu-id="23cba-137">Se a chamada for realizada com sucesso, a função de retorno de chamada *InitOnceCallback* será executada.</span><span class="sxs-lookup"><span data-stu-id="23cba-137">If the call succeeds, the *InitOnceCallback* callback function executes.</span></span>
2.  <span data-ttu-id="23cba-138">Os threads subsequentes que tentam a inicialização são bloqueados até que o primeiro thread conclua a inicialização ou falhe.</span><span class="sxs-lookup"><span data-stu-id="23cba-138">Subsequent threads that attempt initialization are blocked until the first thread either completes initialization or fails.</span></span> <span data-ttu-id="23cba-139">Se o primeiro thread falhar, o próximo thread terá permissão para tentar a inicialização e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="23cba-139">If the first thread fails, the next thread is allowed to attempt the initialization, and so on.</span></span>
3.  <span data-ttu-id="23cba-140">Quando a inicialização é concluída, a função de retorno de chamada retorna.</span><span class="sxs-lookup"><span data-stu-id="23cba-140">When initialization is finished, the callback function returns.</span></span> <span data-ttu-id="23cba-141">A função de retorno de chamada pode, opcionalmente, criar um objeto de sincronização (ou outros dados de contexto) e especificá-lo em seu parâmetro de saída de *contexto* .</span><span class="sxs-lookup"><span data-stu-id="23cba-141">The callback function can optionally create a synchronization object (or other context data) and specify it in its *Context* output parameter.</span></span>
4.  <span data-ttu-id="23cba-142">Se a inicialização for realizada com sucesso, o estado da estrutura de inicialização única será alterado para inicializado e o identificador de *contexto* (se houver) será armazenado na estrutura de inicialização.</span><span class="sxs-lookup"><span data-stu-id="23cba-142">If the initialization succeeds, the state of the one-time initialization structure is changed to initialized and the *Context* handle (if any) is stored in the initialization structure.</span></span> <span data-ttu-id="23cba-143">As tentativas de inicialização subsequentes retornam esses dados de contexto.</span><span class="sxs-lookup"><span data-stu-id="23cba-143">Subsequent initialization attempts return this context data.</span></span> <span data-ttu-id="23cba-144">Se a inicialização falhar, os dados serão **nulos**.</span><span class="sxs-lookup"><span data-stu-id="23cba-144">If the initialization fails, the data is **NULL**.</span></span>

## <a name="asynchronous-one-time-initialization"></a><span data-ttu-id="23cba-145">Inicialização única assíncrona</span><span class="sxs-lookup"><span data-stu-id="23cba-145">Asynchronous One-time Initialization</span></span>

<span data-ttu-id="23cba-146">As etapas a seguir descrevem a inicialização única assíncrona.</span><span class="sxs-lookup"><span data-stu-id="23cba-146">The following steps describe asynchronous one-time initialization.</span></span>

1.  <span data-ttu-id="23cba-147">Se vários threads tentarem iniciar a inicialização simultaneamente chamando [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) com **init \_ após \_ Async**, a função terá sucesso para todos os threads com o parâmetro *fPending* definido como **true**.</span><span class="sxs-lookup"><span data-stu-id="23cba-147">If multiple threads simultaneously attempt to begin initialization by calling [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) with **INIT\_ONCE\_ASYNC**, the function succeeds for all of the threads with the *fPending* parameter set to **TRUE**.</span></span> <span data-ttu-id="23cba-148">Apenas um thread terá sucesso na inicialização; outras tentativas simultâneas não alteram o estado de inicialização.</span><span class="sxs-lookup"><span data-stu-id="23cba-148">Only one thread will actually succeed at initialization; other concurrent attempts do not change the initialization state.</span></span>
2.  <span data-ttu-id="23cba-149">Quando [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) retorna, o parâmetro *fPending* indica o status de inicialização:</span><span class="sxs-lookup"><span data-stu-id="23cba-149">When [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) returns, the *fPending* parameter indicates the initialization status:</span></span>
    -   <span data-ttu-id="23cba-150">Se *fPending* for **false**, um thread terá êxito na inicialização.</span><span class="sxs-lookup"><span data-stu-id="23cba-150">If *fPending* is **FALSE**, one thread has succeeded at initialization.</span></span> <span data-ttu-id="23cba-151">Outros threads devem limpar todos os dados de contexto que criaram e usar os dados de contexto no parâmetro de saída *lpContext* de [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize).</span><span class="sxs-lookup"><span data-stu-id="23cba-151">Other threads should clean up any context data they have created and use the context data in the *lpContext* output parameter of [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize).</span></span>
    -   <span data-ttu-id="23cba-152">Se *fPending* for **true**, a inicialização ainda não foi concluída e outros threads devem continuar.</span><span class="sxs-lookup"><span data-stu-id="23cba-152">If *fPending* is **TRUE**, initialization has not yet completed and other threads should continue.</span></span>
3.  <span data-ttu-id="23cba-153">Cada thread chama a função [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) .</span><span class="sxs-lookup"><span data-stu-id="23cba-153">Each thread calls the [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) function.</span></span> <span data-ttu-id="23cba-154">Opcionalmente, o thread pode criar um objeto de sincronização (ou outros dados de contexto) e especificá-lo no parâmetro *lpContext* de **InitOnceComplete**.</span><span class="sxs-lookup"><span data-stu-id="23cba-154">The thread can optionally create a synchronization object (or other context data) and specify it in the *lpContext* parameter of **InitOnceComplete**.</span></span>
4.  <span data-ttu-id="23cba-155">Quando [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) retorna, seu valor de retorno indica se o thread de chamada foi bem-sucedido na inicialização.</span><span class="sxs-lookup"><span data-stu-id="23cba-155">When [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) returns, its return value indicates whether the calling thread succeeded at initialization.</span></span>
    -   <span data-ttu-id="23cba-156">Se [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) tiver êxito, o thread de chamada terá êxito na inicialização.</span><span class="sxs-lookup"><span data-stu-id="23cba-156">If [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) succeeds, the calling thread has succeeded at initialization.</span></span> <span data-ttu-id="23cba-157">O estado da estrutura de inicialização única é alterado para inicializado e o identificador *lpContext* (se houver) é armazenado na estrutura de inicialização.</span><span class="sxs-lookup"><span data-stu-id="23cba-157">The state of the one-time initialization structure is changed to initialized and the *lpContext* handle (if any) is stored in the initialization structure.</span></span>
    -   <span data-ttu-id="23cba-158">Se [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) falhar, outro thread terá êxito na inicialização.</span><span class="sxs-lookup"><span data-stu-id="23cba-158">If [**InitOnceComplete**](/windows/win32/api/synchapi/nf-synchapi-initoncecomplete) fails, another thread has succeeded at initialization.</span></span> <span data-ttu-id="23cba-159">O thread de chamada deve limpar todos os dados de contexto que foram criados e chamar [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) com **init \_ \_ \_ somente uma vez** para recuperar os dados de contexto armazenados na estrutura de inicialização única.</span><span class="sxs-lookup"><span data-stu-id="23cba-159">The calling thread should clean up any context data it has created and call [**InitOnceBeginInitialize**](/windows/win32/api/synchapi/nf-synchapi-initoncebegininitialize) with **INIT\_ONCE\_CHECK\_ONLY** to retrieve any context data stored in the one-time initialization structure.</span></span>

## <a name="calling-one-time-initialization-from-multiple-sites"></a><span data-ttu-id="23cba-160">Chamando One-Time inicialização de vários sites</span><span class="sxs-lookup"><span data-stu-id="23cba-160">Calling One-Time Initialization from multiple sites</span></span>

<span data-ttu-id="23cba-161">A inicialização única protegida por um único **init \_ Once** pode ser executada a partir de sites vários; um retorno de chamada diferente pode ser passado de cada site, e a sincronização com e sem o retorno de chamada pode ser mista.</span><span class="sxs-lookup"><span data-stu-id="23cba-161">One-time initialization guarded by a single **INIT\_ONCE** structure may be performed from mutiple sites; different callback may be passed from each site, and synchronization with and without callback may be mixed.</span></span> <span data-ttu-id="23cba-162">A inicialização ainda é guaranted para executar sucesfully apenas uma vez.</span><span class="sxs-lookup"><span data-stu-id="23cba-162">Initialization is still guaranted to perform sucesfully just once.</span></span>

<span data-ttu-id="23cba-163">No entanto, a inicialização assíncrona e síncrona não pode ser mista: após a tentativa de inicialização assíncrona, as tentativas de iniciar a inicialização síncrona falharão.</span><span class="sxs-lookup"><span data-stu-id="23cba-163">However, asynchronous and synchronous initialization cannot be mixed: once asynchronous initialization is attempted, attempts to start synchronous initialization would fail.</span></span>

## <a name="related-topics"></a><span data-ttu-id="23cba-164">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="23cba-164">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="23cba-165">Usando a inicialização do One-Time</span><span class="sxs-lookup"><span data-stu-id="23cba-165">Using One-Time Initialization</span></span>](using-one-time-initialization.md)
</dt> </dl>

 

 
