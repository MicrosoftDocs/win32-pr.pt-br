---
title: Problemas de Threading do In-Process Server
description: Problemas de Threading do In-Process Server
ms.assetid: 7bd6f62f-8c91-44bd-9a7f-d47988180eed
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8a9d02af739eac11a6adae62de76be9078ee8e32
ms.sourcegitcommit: 89f99926f946dc6c5ea600fb7c41f6b19ceac516
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/21/2020
ms.locfileid: "104366908"
---
# <a name="in-process-server-threading-issues"></a><span data-ttu-id="26014-103">Problemas de Threading do In-Process Server</span><span class="sxs-lookup"><span data-stu-id="26014-103">In-Process Server Threading Issues</span></span>

<span data-ttu-id="26014-104">Um servidor em processo não chama [**CoInitialize**](/windows/desktop/api/Objbase/nf-objbase-coinitialize), [**CoInitializeEx**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializeex)ou [**OleInitialize**](/windows/desktop/api/Ole2/nf-ole2-oleinitialize) para marcar seu modelo de Threading.</span><span class="sxs-lookup"><span data-stu-id="26014-104">An in-process server does not call [**CoInitialize**](/windows/desktop/api/Objbase/nf-objbase-coinitialize), [**CoInitializeEx**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializeex), or [**OleInitialize**](/windows/desktop/api/Ole2/nf-ole2-oleinitialize) to mark its threading model.</span></span> <span data-ttu-id="26014-105">Para objetos baseados em DLL ou em processo de reconhecimento de thread, você precisa definir o modelo de threading no registro.</span><span class="sxs-lookup"><span data-stu-id="26014-105">For thread-aware DLL-based or in-process objects, you need to set the threading model in the registry.</span></span> <span data-ttu-id="26014-106">O modelo padrão quando você não especifica um modelo de threading é de thread único por processo.</span><span class="sxs-lookup"><span data-stu-id="26014-106">The default model when you do not specify a threading model is single-thread-per-process.</span></span> <span data-ttu-id="26014-107">Para especificar um modelo, você adiciona o valor de **ThreadingModel** à chave [InprocServer32](inprocserver32.md) no registro.</span><span class="sxs-lookup"><span data-stu-id="26014-107">To specify a model, you add the **ThreadingModel** value to the [InprocServer32](inprocserver32.md) key in the registry.</span></span>

<span data-ttu-id="26014-108">DLLs que dão suporte à instanciação de um objeto de classe devem implementar e exportar as funções [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) e [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow).</span><span class="sxs-lookup"><span data-stu-id="26014-108">DLLs that support instantiation of a class object must implement and export the functions [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) and [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow).</span></span> <span data-ttu-id="26014-109">Quando um cliente deseja uma instância da classe à qual a DLL dá suporte, uma chamada para [**CoGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetclassobject) (diretamente ou por meio de uma chamada para [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance)) chama **DllGetClassObject** para obter um ponteiro para seu objeto de classe quando o objeto é implementado em uma dll.</span><span class="sxs-lookup"><span data-stu-id="26014-109">When a client wants an instance of the class the DLL supports, a call to [**CoGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetclassobject) (either directly or through a call to [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance)) calls **DllGetClassObject** to get a pointer to its class object when the object is implemented in a DLL.</span></span> <span data-ttu-id="26014-110">O **DllGetClassObject** , portanto, deve ser capaz de fornecer vários objetos de classe ou um único objeto thread-safe (essencialmente, simplesmente usando [**InterlockedIncrement**](/windows/win32/api/winnt/nf-winnt-interlockedincrement) / [**InterlockedDecrement**](/windows/desktop/api/winbase/nf-winbase-interlockeddecrement) em suas contagens de referência internas).</span><span class="sxs-lookup"><span data-stu-id="26014-110">**DllGetClassObject** should therefore be able to give away multiple class objects or a single thread-safe object (essentially just using [**InterlockedIncrement**](/windows/win32/api/winnt/nf-winnt-interlockedincrement)/[**InterlockedDecrement**](/windows/desktop/api/winbase/nf-winbase-interlockeddecrement) on their internal reference counts).</span></span>

<span data-ttu-id="26014-111">Como o nome indica, [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow) é chamado para determinar se a DLL que a implementa está em uso, permitindo que o chamador o descarregue com segurança, se não for.</span><span class="sxs-lookup"><span data-stu-id="26014-111">As its name implies, [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow) is called to determine whether the DLL that implements it is in use, enabling the caller to safely unload it if it is not.</span></span> <span data-ttu-id="26014-112">Chamadas para [**CoFreeUnusedLibraries**](/windows/desktop/api/combaseapi/nf-combaseapi-cofreeunusedlibraries) de qualquer thread sempre roteiam o thread do apartamento principal para chamar **DllCanUnloadNow**.</span><span class="sxs-lookup"><span data-stu-id="26014-112">Calls to [**CoFreeUnusedLibraries**](/windows/desktop/api/combaseapi/nf-combaseapi-cofreeunusedlibraries) from any thread always route through the main apartment's thread to call **DllCanUnloadNow**.</span></span>

<span data-ttu-id="26014-113">Assim como outros servidores, os servidores em processo podem ser de thread único, de thread apartment ou de thread livre.</span><span class="sxs-lookup"><span data-stu-id="26014-113">Like other servers, in-process servers can be single-threaded, apartment-threaded, or free-threaded.</span></span> <span data-ttu-id="26014-114">Esses servidores podem ser usados por qualquer cliente OLE, independentemente do modelo de Threading usado pelo cliente.</span><span class="sxs-lookup"><span data-stu-id="26014-114">These servers can be used by any OLE client, regardless of the threading model used by that client.</span></span>

<span data-ttu-id="26014-115">Todas as combinações de interoperabilidade do modelo de Threading são permitidas entre clientes e objetos em processo.</span><span class="sxs-lookup"><span data-stu-id="26014-115">All combinations of threading model interoperability are allowed between clients and in-process objects.</span></span> <span data-ttu-id="26014-116">A interação entre um cliente e um objeto em processo que usa modelos de Threading diferentes é exatamente como a interação entre clientes e servidores fora do processo.</span><span class="sxs-lookup"><span data-stu-id="26014-116">Interaction between a client and an in-process object that use different threading models is exactly like the interaction between clients and out-of-process servers.</span></span> <span data-ttu-id="26014-117">Para um servidor em processo, quando o modelo de Threading do cliente e do servidor em processo difere, o COM deve se apresentar entre o cliente e o objeto.</span><span class="sxs-lookup"><span data-stu-id="26014-117">For an in-process server, when the threading model of the client and in-process server differ, COM must interpose itself between the client and the object.</span></span>

<span data-ttu-id="26014-118">Quando um objeto em processo que dá suporte ao modelo de thread único é chamado simultaneamente por vários threads de um cliente, o COM não pode permitir que os threads do cliente acessem diretamente o interfaceâ do objeto "o objeto não foi projetado para esse acesso.</span><span class="sxs-lookup"><span data-stu-id="26014-118">When an in-process object that supports the single-threaded model is called simultaneously by multiple threads of a client, COM cannot allow the client threads to directly access the object's interfaceâ€”the object was not designed for such access.</span></span> <span data-ttu-id="26014-119">Em vez disso, COM deve garantir que as chamadas sejam sincronizadas e sejam feitas somente pelo thread do cliente que criou o objeto.</span><span class="sxs-lookup"><span data-stu-id="26014-119">Instead, COM must ensure that calls are synchronized and are made only by the client thread that created the object.</span></span> <span data-ttu-id="26014-120">Portanto, o COM cria o objeto no apartamento principal do cliente e requer que todos os outros Apartments do cliente acessem o objeto usando proxies.</span><span class="sxs-lookup"><span data-stu-id="26014-120">Therefore, COM creates the object in the client's main apartment and requires all the other client apartments to access the object by using proxies.</span></span>

<span data-ttu-id="26014-121">Quando um apartamento de thread livre (modelo de apartamento multi-threaded) em um cliente cria um servidor em processo Apartment-Threaded, o COM gira um thread de "host" de modelo de apartamento de um único thread no cliente.</span><span class="sxs-lookup"><span data-stu-id="26014-121">When a free-threaded apartment (multithreaded apartment model) in a client creates an apartment-threaded in-process server, COM spins up a single-threaded apartment model "host" thread in the client.</span></span> <span data-ttu-id="26014-122">Esse thread de host criará o objeto e o ponteiro de interface será submetido a marshaling de volta para o apartamento de thread livre do cliente.</span><span class="sxs-lookup"><span data-stu-id="26014-122">This host thread will create the object, and the interface pointer will be marshaled back to the client's free-threaded apartment.</span></span> <span data-ttu-id="26014-123">Da mesma forma, quando um apartamento de thread único em um cliente de modelo de apartamento cria um servidor de thread em processo livre, o COM gira um thread de host de thread livre (multithreaded apartment no qual o objeto será criado e, em seguida, é empacotado de volta para o apartamento de thread único do cliente).</span><span class="sxs-lookup"><span data-stu-id="26014-123">Similarly, when a single-threaded apartment in an apartment-model client creates a free-threaded in-process server, COM spins up a free-threaded host thread (multithreaded apartment on which the object will be created and then marshaled back to the client single-threaded apartment).</span></span>

> [!Note]  
> <span data-ttu-id="26014-124">Em geral, se você criar uma interface personalizada em um servidor em processo, também deverá fornecer o código de marshaling para ela, de modo que o COM possa realizar marshaling da interface entre o cliente Apartments.</span><span class="sxs-lookup"><span data-stu-id="26014-124">In general, if you design a custom interface on an in-process server, you should also provide the marshaling code for it so that COM can marshal the interface between client apartments.</span></span>

 

<span data-ttu-id="26014-125">O COM ajuda a proteger o acesso a objetos fornecidos por uma DLL de thread único, exigindo acesso do mesmo apartamento de cliente no qual eles foram criados.</span><span class="sxs-lookup"><span data-stu-id="26014-125">COM helps protect access to objects provided by a single-threaded DLL by requiring access from the same client apartment in which they were created.</span></span> <span data-ttu-id="26014-126">Além disso, todos os pontos de entrada de DLL (como [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) e [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) e os dados globais devem ser sempre acessados pelo mesmo apartamento.</span><span class="sxs-lookup"><span data-stu-id="26014-126">In addition, all of the DLL entry points (like [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) and [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) and global data should always be accessed by the same apartment.</span></span> <span data-ttu-id="26014-127">O COM cria esses objetos no apartamento principal do cliente, dando ao principal o acesso direto do apartamento aos ponteiros do objeto.</span><span class="sxs-lookup"><span data-stu-id="26014-127">COM creates such objects in the main apartment of the client, giving the main apartment direct access to the object's pointers.</span></span> <span data-ttu-id="26014-128">Chamadas de outro Apartments usam o marshaling entre threads para ir do proxy para o stub no apartamento principal e, em seguida, para o objeto.</span><span class="sxs-lookup"><span data-stu-id="26014-128">Calls from the other apartments use interthread marshaling to go from the proxy to the stub in the main apartment and then to the object.</span></span> <span data-ttu-id="26014-129">Isso permite que o COM sincronize chamadas para o objeto.</span><span class="sxs-lookup"><span data-stu-id="26014-129">This allows COM to synchronize calls to the object.</span></span> <span data-ttu-id="26014-130">Chamadas interthreads são lentas, portanto, é recomendável que esses servidores sejam reescritos para dar suporte a vários Apartments.</span><span class="sxs-lookup"><span data-stu-id="26014-130">Interthread calls are slow, so it is recommended that these servers be rewritten to support multiple apartments.</span></span>

<span data-ttu-id="26014-131">Como um servidor de thread único em processo, um objeto fornecido por uma DLL de modelo de apartamento deve ser acessado pelo mesmo apartamento de cliente do qual foi criado.</span><span class="sxs-lookup"><span data-stu-id="26014-131">Like a single-threaded in-process server, an object provided by an apartment model DLL must be accessed by the same client apartment from which it was created.</span></span> <span data-ttu-id="26014-132">No entanto, os objetos fornecidos por esse servidor podem ser criados em vários Apartments do cliente, portanto, o servidor deve implementar seus pontos de entrada (como [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) e [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) para uso multithread.</span><span class="sxs-lookup"><span data-stu-id="26014-132">However, objects provided by this server can be created in multiple apartments of the client, so the server must implement its entry points (like [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) and [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) for multithreaded use.</span></span> <span data-ttu-id="26014-133">Por exemplo, se dois Apartments de um cliente tentarem criar duas instâncias do objeto em processo simultaneamente, **DllGetClassObject** poderá ser chamado simultaneamente por ambos os Apartments.</span><span class="sxs-lookup"><span data-stu-id="26014-133">For example, if two apartments of a client try to create two instances of the in-process object simultaneously, **DllGetClassObject** can be called simultaneously by both apartments.</span></span> <span data-ttu-id="26014-134">**DllCanUnloadNow** deve ser escrito para que a dll não seja descarregada enquanto o código ainda estiver sendo executado na dll.</span><span class="sxs-lookup"><span data-stu-id="26014-134">**DllCanUnloadNow** must be written so that the DLL does not unload while code is still executing in the DLL.</span></span>

<span data-ttu-id="26014-135">Se a DLL fornecer apenas uma instância da fábrica de classes para criar todos os objetos, a implementação da fábrica de classes também deverá ser projetada para uso multithread, pois ela será acessada por vários clientes Apartments.</span><span class="sxs-lookup"><span data-stu-id="26014-135">If the DLL provides only one instance of the class factory to create all the objects, the class factory implementation must also be designed for multithreaded use, because it will be accessed by multiple client apartments.</span></span> <span data-ttu-id="26014-136">Se a DLL criar uma nova instância da fábrica de classes cada vez que [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) for chamado, a fábrica de classes não precisará ser thread-safe.</span><span class="sxs-lookup"><span data-stu-id="26014-136">If the DLL creates a new instance of the class factory each time [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) is called, the class factory need not be thread-safe.</span></span>

<span data-ttu-id="26014-137">Os objetos criados pela fábrica de classes não precisam ser thread-safe.</span><span class="sxs-lookup"><span data-stu-id="26014-137">Objects created by the class factory need not be thread-safe.</span></span> <span data-ttu-id="26014-138">Uma vez criado por um thread, o objeto é sempre acessado por meio desse thread e todas as chamadas para o objeto são sincronizadas pelo COM.</span><span class="sxs-lookup"><span data-stu-id="26014-138">Once created by a thread, the object is always accessed through that thread and all calls to the object are synchronized by COM.</span></span> <span data-ttu-id="26014-139">O apartamento do modelo de apartamento de um cliente que cria esse objeto receberá um ponteiro direto para o objeto.</span><span class="sxs-lookup"><span data-stu-id="26014-139">The apartment model apartment of a client that creates this object will get a direct pointer to the object.</span></span> <span data-ttu-id="26014-140">Os Apartments de cliente que são diferentes do apartamento no qual o objeto foi criado devem acessar o objeto por meio de proxies.</span><span class="sxs-lookup"><span data-stu-id="26014-140">Client apartments that are different from the apartment in which the object was created must access the object through proxies.</span></span> <span data-ttu-id="26014-141">Esses proxies são criados quando o cliente realiza marshaling da interface entre seu Apartments.</span><span class="sxs-lookup"><span data-stu-id="26014-141">These proxies are created when the client marshals the interface between its apartments.</span></span>

<span data-ttu-id="26014-142">Quando um valor de **ThreadingModel** de dll em processo é definido como "both", um objeto fornecido por essa DLL pode ser criado e usado diretamente (sem um proxy) em Apartments de cliente de thread único ou multithread.</span><span class="sxs-lookup"><span data-stu-id="26014-142">When an in-process DLL **ThreadingModel** value is set to "Both", an object provided by this DLL can be created and used directly (without a proxy) in single-threaded or multithreaded client apartments.</span></span> <span data-ttu-id="26014-143">No entanto, ele só pode ser usado diretamente dentro do apartamento no qual foi criado.</span><span class="sxs-lookup"><span data-stu-id="26014-143">However, it can be used directly only within the apartment in which it was created.</span></span> <span data-ttu-id="26014-144">Para fornecer o objeto para qualquer outro apartamento, o objeto deve ser empacotado.</span><span class="sxs-lookup"><span data-stu-id="26014-144">To give the object to any other apartment, the object must be marshaled.</span></span> <span data-ttu-id="26014-145">O objeto DLL deve implementar sua própria sincronização e pode ser acessado por vários clientes Apartments ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="26014-145">The DLL object must implement its own synchronization and can be accessed by multiple client apartments at the same time.</span></span>

<span data-ttu-id="26014-146">Para acelerar o desempenho de acesso de thread livre a objetos DLL em processo, o COM fornece a função [**CoCreateFreeThreadedMarshaler**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreatefreethreadedmarshaler) .</span><span class="sxs-lookup"><span data-stu-id="26014-146">To speed performance for free-threaded access to in-process DLL objects, COM provides the [**CoCreateFreeThreadedMarshaler**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreatefreethreadedmarshaler) function.</span></span> <span data-ttu-id="26014-147">Essa função cria um objeto de marshaling com thread livre que pode ser agregado com um objeto de servidor em processo.</span><span class="sxs-lookup"><span data-stu-id="26014-147">This function creates a free-threaded marshaling object that can be aggregated with an in-process server object.</span></span> <span data-ttu-id="26014-148">Quando um apartamento de cliente no mesmo processo precisa de acesso a um objeto em outro apartamento, agregar o marshaler de thread livre fornece ao cliente um ponteiro direto para o objeto de servidor, em vez de um proxy, quando o cliente realiza o marshaling da interface do objeto para um apartamento diferente.</span><span class="sxs-lookup"><span data-stu-id="26014-148">When a client apartment in the same process needs access to an object in another apartment, aggregating the free-threaded marshaler provides the client with a direct pointer to the server object, rather than to a proxy, when the client marshals the object's interface to a different apartment.</span></span> <span data-ttu-id="26014-149">O cliente não precisa fazer nenhuma sincronização.</span><span class="sxs-lookup"><span data-stu-id="26014-149">The client does not need to do any synchronization.</span></span> <span data-ttu-id="26014-150">Isso funciona apenas dentro do mesmo processo; o marshaling padrão é usado para uma referência ao objeto que é enviado para outro processo.</span><span class="sxs-lookup"><span data-stu-id="26014-150">This works only within the same process; standard marshaling is used for a reference to the object that is sent to another process.</span></span>

<span data-ttu-id="26014-151">Um objeto fornecido por uma DLL em processo que dá suporte apenas a threads livres é um objeto de thread livre.</span><span class="sxs-lookup"><span data-stu-id="26014-151">An object provided by an in-process DLL that supports only free threading is a free-threaded object.</span></span> <span data-ttu-id="26014-152">Ele implementa sua própria sincronização e pode ser acessado por vários threads de cliente ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="26014-152">It implements its own synchronization and can be accessed by multiple client threads at the same time.</span></span> <span data-ttu-id="26014-153">Esse servidor não empacota interfaces entre threads, portanto, esse servidor pode ser criado e usado diretamente (sem um proxy) somente por Apartments de vários threads em um cliente.</span><span class="sxs-lookup"><span data-stu-id="26014-153">This server does not marshal interfaces between threads, so this server can be created and used directly (without a proxy) only by multithreaded apartments in a client.</span></span> <span data-ttu-id="26014-154">O Apartments de thread único que o cria acessará por meio de um proxy.</span><span class="sxs-lookup"><span data-stu-id="26014-154">Single-threaded apartments that create it will access it through a proxy.</span></span>

## <a name="related-topics"></a><span data-ttu-id="26014-155">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="26014-155">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="26014-156">Acessando interfaces em Apartments</span><span class="sxs-lookup"><span data-stu-id="26014-156">Accessing Interfaces Across Apartments</span></span>](accessing-interfaces-across-apartments.md)
</dt> <dt>

[<span data-ttu-id="26014-157">Escolhendo o modelo de Threading</span><span class="sxs-lookup"><span data-stu-id="26014-157">Choosing the Threading Model</span></span>](choosing-the-threading-model.md)
</dt> <dt>

[<span data-ttu-id="26014-158">Apartments multithread</span><span class="sxs-lookup"><span data-stu-id="26014-158">Multithreaded Apartments</span></span>](multithreaded-apartments.md)
</dt> <dt>

[<span data-ttu-id="26014-159">Processos, threads e Apartments</span><span class="sxs-lookup"><span data-stu-id="26014-159">Processes, Threads, and Apartments</span></span>](processes--threads--and-apartments.md)
</dt> <dt>

[<span data-ttu-id="26014-160">Comunicação de thread único e multithread</span><span class="sxs-lookup"><span data-stu-id="26014-160">Single-Threaded and Multithreaded Communication</span></span>](single-threaded-and-multithreaded-communication.md)
</dt> <dt>

[<span data-ttu-id="26014-161">Apartments de thread único</span><span class="sxs-lookup"><span data-stu-id="26014-161">Single-Threaded Apartments</span></span>](single-threaded-apartments.md)
</dt> </dl>

 

 