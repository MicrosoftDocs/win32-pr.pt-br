---
title: Licenciamento e IClassFactory2
description: Licenciamento e IClassFactory2
ms.assetid: 2bead555-8c62-4f48-a4c6-6f0942ec75f8
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9376d5187588ba14da434161309409bf1d189a8f
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/21/2020
ms.locfileid: "104366767"
---
# <a name="licensing-and-iclassfactory2"></a><span data-ttu-id="f1099-103">Licenciamento e IClassFactory2</span><span class="sxs-lookup"><span data-stu-id="f1099-103">Licensing and IClassFactory2</span></span>

<span data-ttu-id="f1099-104">A interface [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory) em um objeto de classe fornece o mecanismo básico de criação de objeto de com.</span><span class="sxs-lookup"><span data-stu-id="f1099-104">The [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory) interface on a class object provides the basic object creation mechanism of COM.</span></span> <span data-ttu-id="f1099-105">Usando **IClassFactory**, um servidor pode controlar a criação de objetos em uma base de máquina.</span><span class="sxs-lookup"><span data-stu-id="f1099-105">Using **IClassFactory**, a server can control object creation on a machine basis.</span></span> <span data-ttu-id="f1099-106">A implementação do método [**IClassFactory:: CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance) pode permitir ou impedir a criação de objetos com base na existência de uma licença de computador.</span><span class="sxs-lookup"><span data-stu-id="f1099-106">The implementation of the [**IClassFactory::CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance) method can allow or disallow object creation based on the existence of a machine license.</span></span> <span data-ttu-id="f1099-107">Uma licença de computador é uma informação separada do aplicativo que existe em um computador para indicar que o software foi instalado de uma fonte válida, como os discos de instalação do fornecedor.</span><span class="sxs-lookup"><span data-stu-id="f1099-107">A machine license is a piece of information separate from the application that exists on a machine to indicate that the software was installed from a valid source, such as the vendor's installation disks.</span></span> <span data-ttu-id="f1099-108">Se a licença do computador não existir, o servidor poderá impedir a criação do objeto.</span><span class="sxs-lookup"><span data-stu-id="f1099-108">If the machine license does not exist, the server can disallow object creation.</span></span> <span data-ttu-id="f1099-109">O licenciamento de máquina impede a pirataria em casos em que um usuário tenta copiar o software de um computador para outro, pois as informações de licença não são copiadas com o software e o computador que recebe a cópia não é licenciado.</span><span class="sxs-lookup"><span data-stu-id="f1099-109">Machine licensing prevents piracy in cases where a user attempts to copy the software from one machine to another, because the license information is not copied with the software and the machine that receives the copy is not licensed.</span></span>

<span data-ttu-id="f1099-110">No entanto, em um setor de software de componente, os fornecedores precisam de um nível mais preciso de controle sobre o licenciamento.</span><span class="sxs-lookup"><span data-stu-id="f1099-110">However, in a component software industry, vendors need a finer level of control over licensing.</span></span> <span data-ttu-id="f1099-111">Além do controle de licença de computador, um fornecedor precisa permitir que alguns clientes criem um objeto de componente ao mesmo tempo que nega a outros clientes o mesmo recurso.</span><span class="sxs-lookup"><span data-stu-id="f1099-111">In addition to machine license control, a vendor needs to allow some clients to create a component object while denying other clients the same capability.</span></span> <span data-ttu-id="f1099-112">Isso requer que o aplicativo cliente obtenha uma chave de licença do componente enquanto o aplicativo cliente ainda está em desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="f1099-112">This requires that the client application obtain a license key from the component while the client application is still under development.</span></span> <span data-ttu-id="f1099-113">O aplicativo cliente usa a chave de licença em tempo de execução para criar objetos em um computador sem licença.</span><span class="sxs-lookup"><span data-stu-id="f1099-113">The client application uses the license key at run time to create objects on an unlicensed machine.</span></span>

<span data-ttu-id="f1099-114">Por exemplo, se um fornecedor fornecer uma biblioteca de controles para desenvolvedores, o desenvolvedor que adquire a biblioteca terá uma licença completa do computador, permitindo que os objetos sejam criados no computador de desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="f1099-114">For example, if a vendor provides a library of controls to developers, the developer who purchases the library will have a full machine license, allowing the objects to be created on the development machine.</span></span> <span data-ttu-id="f1099-115">O desenvolvedor pode então criar um aplicativo cliente na máquina licenciada que incorpora um ou mais dos controles.</span><span class="sxs-lookup"><span data-stu-id="f1099-115">The developer can then build a client application on the licensed machine incorporating one or more of the controls.</span></span> <span data-ttu-id="f1099-116">Quando o aplicativo cliente resultante é executado em outro computador, os controles usados no aplicativo cliente devem ser criados no outro computador mesmo se esse computador não possuir uma licença de computador para os controles do fornecedor original.</span><span class="sxs-lookup"><span data-stu-id="f1099-116">When the resulting client application is run on another machine, the controls used in the client application must be created on the other machine even if that machine does not possess a machine license for the controls from the original vendor.</span></span>

<span data-ttu-id="f1099-117">A interface [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) fornece esse nível de controle.</span><span class="sxs-lookup"><span data-stu-id="f1099-117">The [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) interface provides this level of control.</span></span> <span data-ttu-id="f1099-118">Para permitir o licenciamento baseado em chave para qualquer componente específico, você implementa **IClassFactory2** no objeto de fábrica de classes para esse componente.</span><span class="sxs-lookup"><span data-stu-id="f1099-118">To allow key-based licensing for any given component, you implement **IClassFactory2** on the class factory object for that component.</span></span> <span data-ttu-id="f1099-119">**IClassFactory2** é derivado de [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory), portanto, ao implementar **IClassFactory2**, o objeto de fábrica de classes atende aos requisitos de com básicos.</span><span class="sxs-lookup"><span data-stu-id="f1099-119">**IClassFactory2** is derived from [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory), so by implementing **IClassFactory2**, the class factory object fulfills the basic COM requirements.</span></span>

<span data-ttu-id="f1099-120">Para incorporar um componente licenciado ao seu aplicativo cliente, use os seguintes métodos no [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2):</span><span class="sxs-lookup"><span data-stu-id="f1099-120">To incorporate a licensed component into your client application, use the following methods in [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2):</span></span>

-   <span data-ttu-id="f1099-121">O método [**GetLicInfo**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) preenche uma estrutura [**LICINFO**](/windows/win32/api/ocidl/ns-ocidl-licinfo) com informações que descrevem o comportamento de licenciamento da fábrica de classes.</span><span class="sxs-lookup"><span data-stu-id="f1099-121">The [**GetLicInfo**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) method fills a [**LICINFO**](/windows/win32/api/ocidl/ns-ocidl-licinfo) structure with information describing the licensing behavior of the class factory.</span></span> <span data-ttu-id="f1099-122">Por exemplo, a fábrica de classes pode fornecer chaves de licença para licenciamento em tempo de execução se o membro **fRunTimeKeyAvail** for **true**.</span><span class="sxs-lookup"><span data-stu-id="f1099-122">For example, the class factory can provide license keys for run-time licensing if the **fRunTimeKeyAvail** member is **TRUE**.</span></span>
-   <span data-ttu-id="f1099-123">O método [**RequestLicKey**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) fornece uma chave de licença para o componente.</span><span class="sxs-lookup"><span data-stu-id="f1099-123">The [**RequestLicKey**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) method provides a license key for the component.</span></span> <span data-ttu-id="f1099-124">Uma licença de computador deve estar disponível quando o cliente chama esse método.</span><span class="sxs-lookup"><span data-stu-id="f1099-124">A machine license must be available when the client calls this method.</span></span>
-   <span data-ttu-id="f1099-125">O método [**CreateInstanceLic**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) cria uma instância do componente licenciado se o parâmetro de chave de licença (BSTRÂ bstrKey) for válido.</span><span class="sxs-lookup"><span data-stu-id="f1099-125">The [**CreateInstanceLic**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) method creates an instance of the licensed component if the license key parameter (BSTRÂ bstrKey) is valid.</span></span>

> [!Note]  
> <span data-ttu-id="f1099-126">Em suas informações de tipo, um componente usa o atributo licenciado para marcar a coclasse que dá suporte a licenciamento por meio de [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2).</span><span class="sxs-lookup"><span data-stu-id="f1099-126">In its type information, a component uses the attribute licensed to mark the coclass that supports licensing through [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2).</span></span>

 

<span data-ttu-id="f1099-127">Primeiro, você precisa de uma ferramenta de desenvolvimento separada que também seja um cliente do componente licenciado.</span><span class="sxs-lookup"><span data-stu-id="f1099-127">First, you need a separate development tool that is also a client of the licensed component.</span></span> <span data-ttu-id="f1099-128">A finalidade dessa ferramenta é obter a chave de licença em tempo de execução e salvá-la em seu aplicativo cliente.</span><span class="sxs-lookup"><span data-stu-id="f1099-128">The purpose of this tool is to obtain the run-time license key and save it in your client application.</span></span> <span data-ttu-id="f1099-129">Essa ferramenta é executada somente em um computador que possui uma licença de computador para o componente.</span><span class="sxs-lookup"><span data-stu-id="f1099-129">This tool runs only on a machine that possesses a machine license for the component.</span></span> <span data-ttu-id="f1099-130">A ferramenta chama os métodos [**GetLicInfo**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) e [**RequestLicKey**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) para obter a chave de licença de tempo de execução e salva a chave de licença em seu aplicativo cliente.</span><span class="sxs-lookup"><span data-stu-id="f1099-130">The tool calls the [**GetLicInfo**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) and [**RequestLicKey**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) methods to obtain the run-time license key and then saves the license key in your client application.</span></span> <span data-ttu-id="f1099-131">Por exemplo, a ferramenta de desenvolvimento pode criar um arquivo de cabeçalho (. h) contendo a chave de licença BSTR e, em seguida, você deve incluir esse arquivo. h em seu aplicativo cliente.</span><span class="sxs-lookup"><span data-stu-id="f1099-131">For example, the development tool could create a header (.h) file containing the BSTR license key, and then you would include that .h file in your client application.</span></span>

<span data-ttu-id="f1099-132">Para instanciar o componente em seu aplicativo cliente, primeiro tente instanciar o objeto diretamente com [**IClassFactory:: CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance).</span><span class="sxs-lookup"><span data-stu-id="f1099-132">To instantiate the component within your client application, first try to instantiate the object directly with [**IClassFactory::CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance).</span></span> <span data-ttu-id="f1099-133">Se **CreateInstance** for bem sucedido, a segunda máquina será licenciada para o componente e os objetos poderão ser criados ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="f1099-133">If **CreateInstance** succeeds, the second machine is licensed for the component and objects can be created at will.</span></span> <span data-ttu-id="f1099-134">Se **CreateInstance** falhar com a classe de código de retorno \_ E não \_ licenciado, a única maneira de criar o objeto é passar a chave de tempo de execução para o método [**CreateInstanceLic**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) .</span><span class="sxs-lookup"><span data-stu-id="f1099-134">If **CreateInstance** fails with the return code CLASS\_E\_NOTLICENSED, the only way to create the object is to pass the run-time key to the [**CreateInstanceLic**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) method.</span></span> <span data-ttu-id="f1099-135">**CreateInstanceLic** verifica a chave e cria o objeto se a chave for válida.</span><span class="sxs-lookup"><span data-stu-id="f1099-135">**CreateInstanceLic** verifies the key and creates the object if the key is valid.</span></span>

<span data-ttu-id="f1099-136">Dessa forma, um aplicativo criado com componentes (como controles) pode ser executado em um computador que não tem nenhuma outra licença — somente o aplicativo cliente que contém a licença de tempo de execução tem permissão para criar os objetos de componente em questão.</span><span class="sxs-lookup"><span data-stu-id="f1099-136">In this way, an application built with components (such as controls) can run on a machine that has no other license—only the client application containing the run-time license is allowed to create the component objects in question.</span></span>

<span data-ttu-id="f1099-137">A interface [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) dá suporte à flexibilidade em esquemas de licenciamento.</span><span class="sxs-lookup"><span data-stu-id="f1099-137">The [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) interface supports flexibility in licensing schemes.</span></span> <span data-ttu-id="f1099-138">Por exemplo, o implementador de servidor pode criptografar as chaves de licença no componente para aumentar a segurança.</span><span class="sxs-lookup"><span data-stu-id="f1099-138">For example, the server implementor can encrypt license keys in the component for added security.</span></span> <span data-ttu-id="f1099-139">Os implementadores de servidor também podem habilitar ou desabilitar níveis de funcionalidade em seus objetos, fornecendo chaves de licença diferentes para funções diferentes.</span><span class="sxs-lookup"><span data-stu-id="f1099-139">Server implementers can also enable or disable levels of functionality in their objects by providing different license keys for different functions.</span></span> <span data-ttu-id="f1099-140">Por exemplo, uma chave pode permitir um nível básico de funcionalidade, enquanto outra permite a funcionalidade básica e avançada, e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="f1099-140">For example, one key might allow a base level of functionality while another allows basic and advanced functionality, and so on.</span></span>

## <a name="related-topics"></a><span data-ttu-id="f1099-141">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="f1099-141">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="f1099-142">Responsabilidades do servidor COM</span><span class="sxs-lookup"><span data-stu-id="f1099-142">COM Server Responsibilities</span></span>](com-server-responsibilities.md)
</dt> </dl>

 

 