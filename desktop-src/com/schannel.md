---
title: SChannel
description: O pacote de segurança do Schannel (canal seguro), cujo identificador de serviço de autenticação é RPC \_ C \_ Authn \_ GSS \_ Schannel, dá suporte aos seguintes protocolos baseados em chave pública SSL (protocolo SSL) 2,0 e 3,0, protocolo TLS 1,0 e tecnologia de comunicação privada (PCT) 1,0. O TLS 1,0 é uma versão padronizada e ligeiramente modificada do SSL 3,0 que foi emitida pelo IETF (Internet Engineering Task Force) em 1999 de Janeiro, no documento RFC 2246. Como o TLS foi padronizado, os desenvolvedores são incentivados a usar TLS em vez de SSL. O PCT é incluído apenas para fins de compatibilidade com versões anteriores e não deve ser usado para um novo desenvolvimento. Quando o pacote de segurança Schannel é usado, o DCOM negocia automaticamente o melhor protocolo, dependendo dos recursos do cliente e do servidor.
ms.assetid: 03a5f987-f668-4f19-9b58-d62711f58734
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: eccc9f82a05d1542e7585426128f10cdf452d31d
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/21/2020
ms.locfileid: "104294538"
---
# <a name="schannel"></a><span data-ttu-id="5c720-107">SChannel</span><span class="sxs-lookup"><span data-stu-id="5c720-107">Schannel</span></span>

<span data-ttu-id="5c720-108">O pacote de segurança do Schannel (canal seguro), cujo identificador do serviço de autenticação é RPC \_ C \_ Authn \_ GSS \_ Schannel, dá suporte aos seguintes protocolos baseados em chave pública: SSL (protocolo SSL) versões 2,0 e 3,0, TLS (Transport Layer Security) 1,0 e PCT (tecnologia de comunicação privada) 1,0.</span><span class="sxs-lookup"><span data-stu-id="5c720-108">The Secure Channel (Schannel) security package, whose authentication service identifier is RPC\_C\_AUTHN\_GSS\_SCHANNEL, supports the following public-key based protocols: SSL (Secure Sockets Layer) versions 2.0 and 3.0, Transport Layer Security (TLS) 1.0, and Private Communication Technology (PCT) 1.0.</span></span> <span data-ttu-id="5c720-109">O TLS 1,0 é uma versão padronizada e ligeiramente modificada do SSL 3,0 que foi emitida pelo IETF (Internet Engineering Task Force) em 1999 de Janeiro, no documento [RFC 2246](https://www.ietf.org/rfc/rfc2246.txt).</span><span class="sxs-lookup"><span data-stu-id="5c720-109">TLS 1.0 is a standardized, slightly modified version of SSL 3.0 that was issued by the Internet Engineering Task Force (IETF) in January 1999, in document [RFC 2246](https://www.ietf.org/rfc/rfc2246.txt).</span></span> <span data-ttu-id="5c720-110">Como o TLS foi padronizado, os desenvolvedores são incentivados a usar TLS em vez de SSL.</span><span class="sxs-lookup"><span data-stu-id="5c720-110">Because TLS has been standardized, developers are encouraged to use TLS rather than SSL.</span></span> <span data-ttu-id="5c720-111">O PCT é incluído apenas para fins de compatibilidade com versões anteriores e não deve ser usado para um novo desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="5c720-111">PCT is included for backward compatibility only and should not be used for new development.</span></span> <span data-ttu-id="5c720-112">Quando o pacote de segurança Schannel é usado, o DCOM negocia automaticamente o melhor protocolo, dependendo dos recursos do cliente e do servidor.</span><span class="sxs-lookup"><span data-stu-id="5c720-112">When the Schannel security package is used, DCOM automatically negotiates the best protocol, depending on the client and server capabilities.</span></span>

<span data-ttu-id="5c720-113">Os tópicos a seguir descrevem brevemente o protocolo TLS e como ele funciona com o DCOM.</span><span class="sxs-lookup"><span data-stu-id="5c720-113">The following topics briefly describe the TLS protocol and how it works with DCOM.</span></span>

-   [<span data-ttu-id="5c720-114">Quando usar o TLS</span><span class="sxs-lookup"><span data-stu-id="5c720-114">When to Use TLS</span></span>](#when-to-use-tls)
-   [<span data-ttu-id="5c720-115">Breve visão geral de como o TLS funciona</span><span class="sxs-lookup"><span data-stu-id="5c720-115">Brief Overview of How TLS Works</span></span>](#brief-overview-of-how-tls-works)
-   [<span data-ttu-id="5c720-116">Certificados X. 509</span><span class="sxs-lookup"><span data-stu-id="5c720-116">X.509 Certificates</span></span>](#x509-certificates)
    -   [<span data-ttu-id="5c720-117">Certificados do cliente</span><span class="sxs-lookup"><span data-stu-id="5c720-117">Client Certificates</span></span>](#client-certificates)
-   [<span data-ttu-id="5c720-118">Usando o TLS no COM</span><span class="sxs-lookup"><span data-stu-id="5c720-118">Using TLS in COM</span></span>](#using-tls-in-com)
    -   [<span data-ttu-id="5c720-119">Como um servidor define a cobertura de segurança</span><span class="sxs-lookup"><span data-stu-id="5c720-119">How a Server Sets the Security Blanket</span></span>](#how-a-server-sets-the-security-blanket)
    -   [<span data-ttu-id="5c720-120">Como um cliente define a cobertura de segurança</span><span class="sxs-lookup"><span data-stu-id="5c720-120">How a Client Sets the Security Blanket</span></span>](#how-a-client-sets-the-security-blanket)
    -   [<span data-ttu-id="5c720-121">Como um cliente altera a cobertura de segurança</span><span class="sxs-lookup"><span data-stu-id="5c720-121">How a Client Changes the Security Blanket</span></span>](#how-a-client-changes-the-security-blanket)
    -   [<span data-ttu-id="5c720-122">Exemplo: o cliente altera a cobertura de segurança</span><span class="sxs-lookup"><span data-stu-id="5c720-122">Example: Client Changes the Security Blanket</span></span>](#example-client-changes-the-security-blanket)
-   [<span data-ttu-id="5c720-123">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="5c720-123">Related topics</span></span>](#related-topics)

> [!Note]  
> <span data-ttu-id="5c720-124">Todas as informações sobre o protocolo TLS nessas seções também se aplicam aos protocolos SSL e PCT.</span><span class="sxs-lookup"><span data-stu-id="5c720-124">All the information about the TLS protocol in these sections also applies to the SSL and PCT protocols.</span></span>

 

## <a name="when-to-use-tls"></a><span data-ttu-id="5c720-125">Quando usar o TLS</span><span class="sxs-lookup"><span data-stu-id="5c720-125">When to Use TLS</span></span>

<span data-ttu-id="5c720-126">O TLS é a única opção de segurança disponível quando os servidores precisam provar sua identidade para clientes anônimos.</span><span class="sxs-lookup"><span data-stu-id="5c720-126">TLS is the only security option available when servers need to prove their identity to anonymous clients.</span></span> <span data-ttu-id="5c720-127">Isso é particularmente importante para sites que desejam participar do comércio eletrônico porque ele ajuda a proteger a transmissão de informações confidenciais, como números de cartão de crédito.</span><span class="sxs-lookup"><span data-stu-id="5c720-127">This is particularly important for websites that want to participate in e-commerce because it helps protect the transmission of sensitive information such as credit card numbers.</span></span> <span data-ttu-id="5c720-128">O TLS garante que os clientes de comércio eletrônico possam ter certeza de quem eles estão fazendo negócios, pois recebem uma prova da identidade do servidor.</span><span class="sxs-lookup"><span data-stu-id="5c720-128">TLS assures that the e-commerce customers can be certain of whom they are doing business with because they are given proof of the server's identity.</span></span> <span data-ttu-id="5c720-129">Ele também dá ao servidor de comércio eletrônico a eficiência de não ter que se preocupar com a autenticação da identidade de cada um de seus clientes.</span><span class="sxs-lookup"><span data-stu-id="5c720-129">It also gives the e-commerce server the efficiency of not having to concern itself with authenticating the identity of each of its customers.</span></span>

<span data-ttu-id="5c720-130">O TLS requer que todos os servidores comprovem sua identidade aos clientes.</span><span class="sxs-lookup"><span data-stu-id="5c720-130">TLS requires that all servers prove their identity to clients.</span></span> <span data-ttu-id="5c720-131">Além disso, o TLS fornece a opção de fazer com que os clientes comprovem sua identidade aos servidores.</span><span class="sxs-lookup"><span data-stu-id="5c720-131">Additionally, TLS provides the option of having clients prove their identity to servers.</span></span> <span data-ttu-id="5c720-132">Essa autenticação mútua pode ser útil para restringir o acesso de determinadas páginas da Web em uma grande intranet corporativa.</span><span class="sxs-lookup"><span data-stu-id="5c720-132">This mutual authentication can be useful in restricting the access of certain webpages in a large corporate intranet.</span></span>

<span data-ttu-id="5c720-133">O TLS dá suporte aos níveis de autenticação mais fortes e oferece uma arquitetura aberta que permite que a segurança de criptografia aumente ao longo do tempo para acompanhar a inovação tecnológica.</span><span class="sxs-lookup"><span data-stu-id="5c720-133">TLS supports the strongest authentication levels and offers an open architecture that permits encryption strength to increase over time to keep up with technological innovation.</span></span> <span data-ttu-id="5c720-134">O TLS é a melhor opção para ambientes em que o nível mais alto de segurança é desejado para os dados em trânsito.</span><span class="sxs-lookup"><span data-stu-id="5c720-134">TLS is the best choice for environments where the highest level of security is desired for the data in transit.</span></span>

## <a name="brief-overview-of-how-tls-works"></a><span data-ttu-id="5c720-135">Breve visão geral de como o TLS funciona</span><span class="sxs-lookup"><span data-stu-id="5c720-135">Brief Overview of How TLS Works</span></span>

<span data-ttu-id="5c720-136">O TLS é criado com base em uma PKI (infraestrutura de chave pública), que usa pares de chaves públicas/privadas para habilitar a criptografia de dados e estabelecer a integridade dos dados, e usa certificados X. 509 para autenticação.</span><span class="sxs-lookup"><span data-stu-id="5c720-136">TLS is built upon a public key infrastructure (PKI), which uses public/private key pairs for enabling data encryption and establishing data integrity, and uses X.509 certificates for authentication.</span></span>

<span data-ttu-id="5c720-137">Muitos protocolos de segurança, como o protocolo Kerberos V5, dependem de uma única chave para criptografar e descriptografar dados.</span><span class="sxs-lookup"><span data-stu-id="5c720-137">Many security protocols, such as the Kerberos v5 protocol, depend on a single key to both encrypt and decrypt data.</span></span> <span data-ttu-id="5c720-138">Portanto, esses protocolos dependem da troca segura de chaves de criptografia; no protocolo Kerberos, isso é feito por meio de tíquetes obtidos do centro de distribuição de chaves (KDC).</span><span class="sxs-lookup"><span data-stu-id="5c720-138">Such protocols therefore depend on the secure exchange of encryption keys; in the Kerberos protocol, this is done through tickets obtained from the Key Distribution Center (KDC).</span></span> <span data-ttu-id="5c720-139">Isso exige que todos que usam o protocolo Kerberos sejam registrados com o KDC, o que seria uma limitação impraticável para um servidor Web de comércio eletrônico destinado a atrair milhões de clientes de todo o mundo.</span><span class="sxs-lookup"><span data-stu-id="5c720-139">This requires that everyone using the Kerberos protocol be registered with the KDC, which would be an impractical limitation for an e-commerce web server that is intended to attract millions of customers from around the world.</span></span> <span data-ttu-id="5c720-140">Portanto, o TLS depende de uma PKI, que usa duas chaves para data encryptionâ € "quando uma chave do par criptografa os dados, somente a outra chave do par pode descriptografá-lo.</span><span class="sxs-lookup"><span data-stu-id="5c720-140">TLS therefore relies upon a PKI, which uses two keys for data encryptionâ€”when one key of the pair encrypts the data, only the other key of the pair can decrypt it.</span></span> <span data-ttu-id="5c720-141">O benefício principal desse design é que a criptografia pode ser executada sem a necessidade da troca segura de chaves de criptografia.</span><span class="sxs-lookup"><span data-stu-id="5c720-141">The principle benefit of this design is that encryption can be performed without requiring the secure exchange of encryption keys.</span></span>

<span data-ttu-id="5c720-142">Uma PKI usa uma técnica em que uma das chaves é mantida privada e está disponível somente para a entidade para a qual ela está registrada, enquanto a outra chave é pública para qualquer pessoa acessar.</span><span class="sxs-lookup"><span data-stu-id="5c720-142">A PKI uses a technique where one of the keys is kept private and is available only to the principal to whom it is registered, while the other key is made public for anyone to access.</span></span> <span data-ttu-id="5c720-143">Se alguém quiser enviar uma mensagem privada para o proprietário de um par de chaves, a mensagem poderá ser criptografada com a chave pública e somente a chave privada poderá ser usada para descriptografar a mensagem.</span><span class="sxs-lookup"><span data-stu-id="5c720-143">If someone wants to send a private message to the owner of a key pair, the message can be encrypted with the public key and only the private key can be used to decrypt the message.</span></span>

<span data-ttu-id="5c720-144">Os pares de chaves também são usados para verificar a integridade dos dados que estão sendo enviados.</span><span class="sxs-lookup"><span data-stu-id="5c720-144">Key pairs are also used to verify the integrity of the data being sent.</span></span> <span data-ttu-id="5c720-145">Para fazer isso, o proprietário do par de chaves pode anexar uma assinatura digital aos dados antes de enviá-la.</span><span class="sxs-lookup"><span data-stu-id="5c720-145">To do this, the owner of the key pair can attach a digital signature to the data before sending it.</span></span> <span data-ttu-id="5c720-146">A criação de uma assinatura digital envolve o cálculo de um hash dos dados e a criptografia do hash com a chave privada.</span><span class="sxs-lookup"><span data-stu-id="5c720-146">Creating a digital signature involves calculating a hash of the data and encrypting the hash with the private key.</span></span> <span data-ttu-id="5c720-147">Qualquer pessoa que usa a chave pública para descriptografar a assinatura digital é garantida de que a assinatura digital deve ter vindo apenas da pessoa que possui a chave privada.</span><span class="sxs-lookup"><span data-stu-id="5c720-147">Anyone who uses the public key to decrypt the digital signature is assured that the digital signature must have come only from the person who owns the private key.</span></span> <span data-ttu-id="5c720-148">Além disso, o destinatário pode calcular um hash dos dados usando o mesmo algoritmo que o remetente e, se o hash calculado corresponder ao enviado na assinatura digital, o destinatário poderá ter certeza de que os dados não foram modificados após serem assinados digitalmente.</span><span class="sxs-lookup"><span data-stu-id="5c720-148">Additionally, the recipient can calculate a hash of the data using the same algorithm as the sender, and if the calculated hash matches the one sent in the digital signature, the recipient can be certain that the data was not modified after it was digitally signed.</span></span>

<span data-ttu-id="5c720-149">Uma desvantagem de usar uma PKI para a criptografia de dados de alto volume é o desempenho relativamente lento.</span><span class="sxs-lookup"><span data-stu-id="5c720-149">One disadvantage of using a PKI for high-volume data encryption is its relatively slow performance.</span></span> <span data-ttu-id="5c720-150">Devido à intensa matemática envolvida, a criptografia e a descriptografia de dados usando uma codificação assimétrica que depende de um par de chaves pode ser de até 1.000 vezes mais lenta do que a criptografia e a descriptografia usando uma criptografia simétrica que depende apenas de uma única chave.</span><span class="sxs-lookup"><span data-stu-id="5c720-150">Because of the intensive mathematics involved, encryption and decryption of data using an asymmetric cipher that depends on a key pair can be up to 1,000 times slower than encryption and decryption using a symmetric cipher that depends only on a single key.</span></span> <span data-ttu-id="5c720-151">Portanto, o TLS usa uma PKI somente para gerar assinaturas digitais e para negociar a única chave específica da sessão que será usada pelo cliente e pelo servidor para criptografia e descriptografia de dados em massa.</span><span class="sxs-lookup"><span data-stu-id="5c720-151">TLS therefore uses a PKI only for generating digital signatures and for negotiating the session-specific single key that will be used by both the client and the server for bulk data encryption and decryption.</span></span> <span data-ttu-id="5c720-152">O TLS dá suporte a uma ampla variedade de codificações simétricas de chave única, e codificações adicionais podem ser adicionadas no futuro.</span><span class="sxs-lookup"><span data-stu-id="5c720-152">TLS supports a wide variety of single-key symmetric ciphers, and additional ciphers may be added in the future.</span></span>

<span data-ttu-id="5c720-153">Para obter mais informações sobre o protocolo de handshake de TLS, consulte [protocolo de handshake TLS](/windows/desktop/SecAuthN/tls-handshake-protocol).</span><span class="sxs-lookup"><span data-stu-id="5c720-153">For more information about the TLS handshake protocol, see [TLS Handshake Protocol](/windows/desktop/SecAuthN/tls-handshake-protocol).</span></span>

<span data-ttu-id="5c720-154">Para obter mais detalhes sobre a criptografia por trás do protocolo TLS, consulte [princípios básicos de criptografia](/windows/desktop/SecCrypto/cryptography-essentials).</span><span class="sxs-lookup"><span data-stu-id="5c720-154">For more details regarding the cryptography behind the TLS protocol, see [Cryptography Essentials](/windows/desktop/SecCrypto/cryptography-essentials).</span></span>

## <a name="x509-certificates"></a><span data-ttu-id="5c720-155">Certificados X. 509</span><span class="sxs-lookup"><span data-stu-id="5c720-155">X.509 Certificates</span></span>

<span data-ttu-id="5c720-156">Um problema crítico que deve ser tratado por uma PKI é a capacidade de confiar na autenticidade da chave pública que está sendo usada.</span><span class="sxs-lookup"><span data-stu-id="5c720-156">A critical issue that must be handled by a PKI is the ability to trust the authenticity of the public key that is being used.</span></span> <span data-ttu-id="5c720-157">Ao usar uma chave pública emitida para uma empresa com a qual você deseja fazer negócios, você deve ter certeza de que a chave realmente pertence à empresa, e não a um ladrão que deseja descobrir seu número de cartão de crédito.</span><span class="sxs-lookup"><span data-stu-id="5c720-157">When you use a public key issued to a company that you want to do business with, you want to be certain that the key actually belongs to the company rather than to a thief who wants to discover your credit card number.</span></span>

<span data-ttu-id="5c720-158">Para garantir a identidade de uma entidade de segurança que contém um par de chaves, o principal recebe um certificado X. 509 por uma autoridade de certificação (CA).</span><span class="sxs-lookup"><span data-stu-id="5c720-158">To guarantee the identity of a principal holding a key pair, the principal is issued an X.509 certificate by a certification authority (CA).</span></span> <span data-ttu-id="5c720-159">Esse certificado contém informações que identificam a entidade de segurança, contém a chave pública da entidade de segurança e são assinadas digitalmente pela autoridade de certificação.</span><span class="sxs-lookup"><span data-stu-id="5c720-159">This certificate contains information that identifies the principal, contains the principal's public key, and is digitally signed by the CA.</span></span> <span data-ttu-id="5c720-160">Essa assinatura digital indica que a autoridade de certificação acredita que a chave pública contida no certificado realmente pertence à entidade de segurança identificada pelo certificado.</span><span class="sxs-lookup"><span data-stu-id="5c720-160">This digital signature indicates that the CA believes that the public key contained in the certificate truly belongs to the principal identified by the certificate.</span></span>

<span data-ttu-id="5c720-161">E como você confia na autoridade de certificação?</span><span class="sxs-lookup"><span data-stu-id="5c720-161">And how do you trust the CA?</span></span> <span data-ttu-id="5c720-162">Como a própria CA contém um certificado X. 509 que foi assinado por uma autoridade de certificação de nível superior.</span><span class="sxs-lookup"><span data-stu-id="5c720-162">Because the CA itself holds an X.509 certificate that has been signed by a higher-level CA.</span></span> <span data-ttu-id="5c720-163">Essa cadeia de assinaturas de certificado continua até atingir uma CA raiz, que é uma autoridade de certificação que assina seus próprios certificados.</span><span class="sxs-lookup"><span data-stu-id="5c720-163">This chain of certificate signatures continues until it reaches a root CA, which is a CA that signs its own certificates.</span></span> <span data-ttu-id="5c720-164">Se você confiar na integridade da autoridade de certificação raiz de um certificado, deverá ser capaz de confiar na autenticidade do certificado em si.</span><span class="sxs-lookup"><span data-stu-id="5c720-164">If you trust the integrity of the root CA of a certificate, you should be able to trust the authenticity of the certificate itself.</span></span> <span data-ttu-id="5c720-165">Portanto, selecionar CAs raiz nas quais você está disposto a confiar é um direito importante para um administrador do sistema.</span><span class="sxs-lookup"><span data-stu-id="5c720-165">Therefore, picking root CAs that you are willing to trust is an important duty for a system administrator.</span></span>

### <a name="client-certificates"></a><span data-ttu-id="5c720-166">Certificados do cliente</span><span class="sxs-lookup"><span data-stu-id="5c720-166">Client Certificates</span></span>

<span data-ttu-id="5c720-167">Quando os protocolos de camada de transporte de segurança surgem pela primeira vez, sua principal finalidade era garantir que um cliente estivesse se conectando a um servidor autêntico e ajudasse a proteger a privacidade dos dados em trânsito.</span><span class="sxs-lookup"><span data-stu-id="5c720-167">When security transport-layer protocols first emerged, their primary purpose was to guarantee that a client was connecting to an authentic server and help protect the privacy of data while in transit.</span></span> <span data-ttu-id="5c720-168">No entanto, o SSL 3,0 e o TLS 1,0 também incluem suporte para a transmissão do certificado de um cliente durante o handshake do protocolo.</span><span class="sxs-lookup"><span data-stu-id="5c720-168">However, SSL 3.0 and TLS 1.0 also include support for the transmission of a client's certificate during the protocol's handshake.</span></span> <span data-ttu-id="5c720-169">Esse recurso opcional permite a autenticação mútua do cliente e do servidor.</span><span class="sxs-lookup"><span data-stu-id="5c720-169">This optional feature enables the mutual authentication of the client and server.</span></span>

<span data-ttu-id="5c720-170">A decisão de usar um certificado de cliente deve ser feita no contexto do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5c720-170">The decision of whether to use a client certificate should be made in the context of the application.</span></span> <span data-ttu-id="5c720-171">Certificados de cliente são desnecessários se o requisito primário está Autenticando o servidor.</span><span class="sxs-lookup"><span data-stu-id="5c720-171">Client certificates are unnecessary if the primary requirement is authenticating the server.</span></span> <span data-ttu-id="5c720-172">No entanto, se a autenticação de cliente for essencial, o certificado de um cliente poderá ser usado em vez de depender da autenticação personalizada dentro do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5c720-172">However, if client authentication is essential, a client's certificate can be used rather than relying on custom authentication within the application.</span></span> <span data-ttu-id="5c720-173">O uso de certificados de cliente é preferível em relação à autenticação personalizada porque fornece aos usuários um cenário de logon único.</span><span class="sxs-lookup"><span data-stu-id="5c720-173">Using client certificates is preferable over custom authentication because it gives users a single sign-on scenario.</span></span>

## <a name="using-tls-in-com"></a><span data-ttu-id="5c720-174">Usando o TLS no COM</span><span class="sxs-lookup"><span data-stu-id="5c720-174">Using TLS in COM</span></span>

<span data-ttu-id="5c720-175">O TLS dá suporte apenas ao nível de representação personificar (RPC \_ C \_ imp. de \_ nível de redistribuição \_ ).</span><span class="sxs-lookup"><span data-stu-id="5c720-175">TLS supports only the impersonate (RPC\_C\_IMP\_LEVEL\_IMPERSONATE) level of impersonation.</span></span> <span data-ttu-id="5c720-176">Se COM negociar o TLS como o serviço de autenticação em um proxy, o COM definirá o nível de representação para representar, independentemente do padrão do processo.</span><span class="sxs-lookup"><span data-stu-id="5c720-176">If COM negotiates TLS as the authentication service on a proxy, COM will set the impersonation level to impersonate regardless of the process default.</span></span> <span data-ttu-id="5c720-177">Para que a representação funcione corretamente no TLS, o cliente deve fornecer um certificado X. 509 para o servidor e o servidor deve ter esse certificado mapeado para uma conta de usuário específica no servidor.</span><span class="sxs-lookup"><span data-stu-id="5c720-177">For impersonation to work properly in TLS, the client must provide an X.509 certificate to the server and the server must have that certificate mapped to a particular user account on the server.</span></span> <span data-ttu-id="5c720-178">Para obter mais informações, consulte o [guia passo a passo para mapear certificados para contas de usuário](https://www.microsoft.com/isapi/redir.dll?prd=windows2000&sbp=technicallibrary&ar=security&sba=mappingcertificates).</span><span class="sxs-lookup"><span data-stu-id="5c720-178">For more information, see the [Step-by-Step Guide to Mapping Certificates to User Accounts](https://www.microsoft.com/isapi/redir.dll?prd=windows2000&sbp=technicallibrary&ar=security&sba=mappingcertificates).</span></span>

<span data-ttu-id="5c720-179">O TLS não oferece suporte ao [encobrimento](cloaking.md).</span><span class="sxs-lookup"><span data-stu-id="5c720-179">TLS does not support [cloaking](cloaking.md).</span></span> <span data-ttu-id="5c720-180">Se um sinalizador de encobrimento e o TLS forem especificados em um [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) ou em uma chamada [**IClientSecurity:: setampla**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) , e \_ INVALIDARG serão retornados.</span><span class="sxs-lookup"><span data-stu-id="5c720-180">If a cloaking flag and TLS are specified in a [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) or a [**IClientSecurity::SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) call, E\_INVALIDARG will be returned.</span></span>

<span data-ttu-id="5c720-181">O TLS não funciona com o nível de autenticação definido como nenhum.</span><span class="sxs-lookup"><span data-stu-id="5c720-181">TLS does not work with the authentication level set to None.</span></span> <span data-ttu-id="5c720-182">O handshake entre o cliente e o servidor examina o nível de autenticação definido por cada um e escolhe a configuração de segurança mais alta para a conexão.</span><span class="sxs-lookup"><span data-stu-id="5c720-182">The handshake between the client and server examines the authentication level set by each and chooses the higher security setting for the connection.</span></span>

<span data-ttu-id="5c720-183">Os parâmetros de segurança para TLS podem ser definidos chamando [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) e [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span><span class="sxs-lookup"><span data-stu-id="5c720-183">The security parameters for TLS can be set by calling [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) and [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span></span> <span data-ttu-id="5c720-184">As seções a seguir descrevem as nuances envolvidas na realização dessas chamadas.</span><span class="sxs-lookup"><span data-stu-id="5c720-184">The following sections describe the nuances involved in making those calls.</span></span>

### <a name="how-a-server-sets-the-security-blanket"></a><span data-ttu-id="5c720-185">Como um servidor define a cobertura de segurança</span><span class="sxs-lookup"><span data-stu-id="5c720-185">How a Server Sets the Security Blanket</span></span>

<span data-ttu-id="5c720-186">Se um servidor quiser usar o TLS, ele deverá especificar Schannel (RPC \_ C \_ Authn \_ GSS \_ Schannel) como um serviço de autenticação no parâmetro *asAuthSvc* de [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="5c720-186">If a server wants to use TLS, it must specify Schannel (RPC\_C\_AUTHN\_GSS\_SCHANNEL) as an authentication service in the *asAuthSvc* parameter of [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span> <span data-ttu-id="5c720-187">Para impedir que os clientes se conectem ao servidor usando um serviço de autenticação menos seguro, o servidor deve especificar apenas o Schannel como um serviço de autenticação ao chamar **CoInitializeSecurity**.</span><span class="sxs-lookup"><span data-stu-id="5c720-187">To prevent clients from connecting to the server by using a less secure authentication service, the server should specify only Schannel as an authentication service when it calls **CoInitializeSecurity**.</span></span> <span data-ttu-id="5c720-188">O servidor não pode alterar a cobertura de segurança depois de ter chamado **CoInitializeSecurity**.</span><span class="sxs-lookup"><span data-stu-id="5c720-188">The server cannot change the security blanket after it has called **CoInitializeSecurity**.</span></span>

<span data-ttu-id="5c720-189">Para usar o TLS, os seguintes parâmetros devem ser especificados quando um servidor chama [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span><span class="sxs-lookup"><span data-stu-id="5c720-189">To use TLS, the following parameters should be specified when a server calls [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span></span>

-   <span data-ttu-id="5c720-190">*pVoid* deve ser um ponteiro para um objeto [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) ou um ponteiro para um [**\_ descritor de segurança**](/windows/desktop/api/winnt/ns-winnt-security_descriptor).</span><span class="sxs-lookup"><span data-stu-id="5c720-190">*pVoid* should be either a pointer to an [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) object or a pointer to a [**SECURITY\_DESCRIPTOR**](/windows/desktop/api/winnt/ns-winnt-security_descriptor).</span></span> <span data-ttu-id="5c720-191">Ele não deve ser **nulo** ou um ponteiro para uma AppID.</span><span class="sxs-lookup"><span data-stu-id="5c720-191">It should not be **NULL** or a pointer to an AppID.</span></span>
-   <span data-ttu-id="5c720-192">*cAuthSvc* não pode ser 0 ou-1.</span><span class="sxs-lookup"><span data-stu-id="5c720-192">*cAuthSvc* cannot be 0 or -1.</span></span> <span data-ttu-id="5c720-193">Os servidores COM nunca escolhem Schannel quando *cAuthSvc* é-1.</span><span class="sxs-lookup"><span data-stu-id="5c720-193">COM servers never chooses Schannel when *cAuthSvc* is -1.</span></span>
-   <span data-ttu-id="5c720-194">*asAuthSvc* deve especificar Schannel como um serviço de autenticação possível.</span><span class="sxs-lookup"><span data-stu-id="5c720-194">*asAuthSvc* must specify Schannel as a possible authentication service.</span></span> <span data-ttu-id="5c720-195">Isso é feito definindo os seguintes parâmetros [**de \_ \_ serviço de autenticação únicos**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_service) para o membro Schannel da [**\_ \_ lista exclusiva de autenticação**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_list):</span><span class="sxs-lookup"><span data-stu-id="5c720-195">This is done by setting the following [**SOLE\_AUTHENTICATION\_SERVICE**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_service) parameters for the Schannel member of the [**SOLE\_AUTHENTICATION\_LIST**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_list):</span></span>
    -   <span data-ttu-id="5c720-196">*dwAuthnSvc* deve ser RPC \_ C \_ Authn \_ GSS \_ Schannel.</span><span class="sxs-lookup"><span data-stu-id="5c720-196">*dwAuthnSvc* must be RPC\_C\_AUTHN\_GSS\_SCHANNEL.</span></span>
    -   <span data-ttu-id="5c720-197">*dwAuthzSvc* deve ser RPC \_ C \_ AUTHZ \_ None.</span><span class="sxs-lookup"><span data-stu-id="5c720-197">*dwAuthzSvc* should be RPC\_C\_AUTHZ\_NONE.</span></span> <span data-ttu-id="5c720-198">No momento, ele é ignorado.</span><span class="sxs-lookup"><span data-stu-id="5c720-198">Currently, it is ignored.</span></span>
    -   <span data-ttu-id="5c720-199">*pPrincipalName* deve ser um ponteiro para um [**\_ contexto de certificado**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), Cast como um ponteiro para OLECHAR, que representa o certificado X. 509 do servidor.</span><span class="sxs-lookup"><span data-stu-id="5c720-199">*pPrincipalName* must be a pointer to a [**CERT\_CONTEXT**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), cast as a pointer to OLECHAR, which represents the server's X.509 certificate.</span></span>
-   <span data-ttu-id="5c720-200">*dwAuthnLevel* indica o nível de autenticação mínimo que será aceito de clientes para uma conexão bem-sucedida.</span><span class="sxs-lookup"><span data-stu-id="5c720-200">*dwAuthnLevel* indicates the minimum authentication level that will be accepted from clients for a successful connection.</span></span> <span data-ttu-id="5c720-201">Não pode ser RPC \_ C \_ Authn \_ nível \_ None.</span><span class="sxs-lookup"><span data-stu-id="5c720-201">It cannot be RPC\_C\_AUTHN\_LEVEL\_NONE.</span></span>
-   <span data-ttu-id="5c720-202">*dwCapabilities* não deve ter o \_ sinalizador AppID EOAC definido.</span><span class="sxs-lookup"><span data-stu-id="5c720-202">*dwCapabilities* should not have the EOAC\_APPID flag set.</span></span> <span data-ttu-id="5c720-203">O \_ sinalizador de controle de acesso EOAC \_ deve ser definido se *pVoid* aponta para um objeto [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) ; ele não deve ser definido se *pVoid* aponta para um \_ descritor de segurança.</span><span class="sxs-lookup"><span data-stu-id="5c720-203">The EOAC\_ACCESS\_CONTROL flag should be set if *pVoid* points to an [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) object; it should not be set if *pVoid* points to a SECURITY\_DESCRIPTOR.</span></span> <span data-ttu-id="5c720-204">Para outros sinalizadores que podem ser definidos, consulte [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="5c720-204">For other flags that may be set, see [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span>

<span data-ttu-id="5c720-205">Para obter mais informações sobre como usar [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), consulte [Configurando a segurança do processwide com CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span><span class="sxs-lookup"><span data-stu-id="5c720-205">For more information about using [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), see [Setting Processwide Security with CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span></span>

### <a name="how-a-client-sets-the-security-blanket"></a><span data-ttu-id="5c720-206">Como um cliente define a cobertura de segurança</span><span class="sxs-lookup"><span data-stu-id="5c720-206">How a Client Sets the Security Blanket</span></span>

<span data-ttu-id="5c720-207">Se um cliente quiser usar o TLS, ele deverá especificar Schannel (RPC \_ C \_ Authn \_ GSS \_ Schannel) em sua lista de serviços de autenticação no parâmetro *pAuthList* de [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="5c720-207">If a client wants to use TLS, it must specify Schannel (RPC\_C\_AUTHN\_GSS\_SCHANNEL) in its list of authentication services in the *pAuthList* parameter of [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span> <span data-ttu-id="5c720-208">Se Schannel não for especificado como um possível serviço de autenticação quando **CoInitializeSecurity** for chamado, uma chamada posterior para [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) (ou [**IClientSecurity:: setampla**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket)) falhará se tentar especificar Schannel como o serviço de autenticação.</span><span class="sxs-lookup"><span data-stu-id="5c720-208">If Schannel is not specified as a possible authentication service when **CoInitializeSecurity** is called, a later call to [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) (or [**IClientSecurity::SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket)) will fail if it tries to specify Schannel as the authentication service.</span></span>

<span data-ttu-id="5c720-209">Os parâmetros a seguir devem ser especificados quando um cliente chama [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span><span class="sxs-lookup"><span data-stu-id="5c720-209">The following parameters should be specified when a client calls [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span></span>

-   <span data-ttu-id="5c720-210">*dwAuthnLevel* especifica o nível de autenticação padrão que o cliente deseja usar.</span><span class="sxs-lookup"><span data-stu-id="5c720-210">*dwAuthnLevel* specifies the default authentication level that the client wants to use.</span></span> <span data-ttu-id="5c720-211">Não pode ser RPC \_ C \_ Authn \_ nível \_ None.</span><span class="sxs-lookup"><span data-stu-id="5c720-211">It cannot be RPC\_C\_AUTHN\_LEVEL\_NONE.</span></span>
-   <span data-ttu-id="5c720-212">*dwImpLevel* deve ser a \_ representação de nível de imp do RPC C \_ \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="5c720-212">*dwImpLevel* must be RPC\_C\_IMP\_LEVEL\_IMPERSONATE.</span></span>
-   <span data-ttu-id="5c720-213">*pAuthList* deve ter os seguintes parâmetros de [**\_ \_ informações de autenticação exclusivas**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_info) como um membro da lista:</span><span class="sxs-lookup"><span data-stu-id="5c720-213">*pAuthList* must have the following [**SOLE\_AUTHENTICATION\_INFO**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_info) parameters as a member of the list:</span></span>
    -   <span data-ttu-id="5c720-214">*dwAuthnSvc* deve ser RPC \_ C \_ Authn \_ GSS \_ Schannel.</span><span class="sxs-lookup"><span data-stu-id="5c720-214">*dwAuthnSvc* must be RPC\_C\_AUTHN\_GSS\_SCHANNEL.</span></span>
    -   <span data-ttu-id="5c720-215">*dwAuthzSvc* deve ser RPC \_ C \_ AUTHZ \_ None.</span><span class="sxs-lookup"><span data-stu-id="5c720-215">*dwAuthzSvc* must be RPC\_C\_AUTHZ\_NONE.</span></span>
    -   <span data-ttu-id="5c720-216">*pAuthInfo* é um ponteiro para um [**\_ contexto de certificado**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), convertido como um ponteiro para void, que representa o certificado X. 509 do cliente.</span><span class="sxs-lookup"><span data-stu-id="5c720-216">*pAuthInfo* is a pointer to a [**CERT\_CONTEXT**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), cast as a pointer to void, which represents the client's X.509 certificate.</span></span> <span data-ttu-id="5c720-217">Se o cliente não tiver um certificado ou não quiser apresentar seu certificado ao servidor, o *pAuthInfo* deverá ser **nulo** e será feita uma tentativa de conexão anônima com o servidor.</span><span class="sxs-lookup"><span data-stu-id="5c720-217">If the client does not have a certificate or does not wish to present its certificate to the server, *pAuthInfo* must be **NULL** and an anonymous connection will be attempted with the server.</span></span>
-   <span data-ttu-id="5c720-218">*dwCapabilities* é um conjunto de sinalizadores que indicam recursos adicionais do cliente.</span><span class="sxs-lookup"><span data-stu-id="5c720-218">*dwCapabilities* is a set of flags that indicate additional client capabilities.</span></span> <span data-ttu-id="5c720-219">Consulte [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) para obter informações sobre quais sinalizadores devem ser definidos.</span><span class="sxs-lookup"><span data-stu-id="5c720-219">See [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) for information about which flags should be set.</span></span>

<span data-ttu-id="5c720-220">Para obter mais informações sobre como usar [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), consulte [Configurando a segurança do processwide com CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span><span class="sxs-lookup"><span data-stu-id="5c720-220">For more information about using [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), see [Setting Processwide Security with CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span></span>

### <a name="how-a-client-changes-the-security-blanket"></a><span data-ttu-id="5c720-221">Como um cliente altera a cobertura de segurança</span><span class="sxs-lookup"><span data-stu-id="5c720-221">How a Client Changes the Security Blanket</span></span>

<span data-ttu-id="5c720-222">Se um cliente quiser usar o TLS, mas alterar a cobertura de segurança depois de chamar [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), ele deverá chamar [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) ou [**IClientSecurity:: setampla**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) com parâmetros semelhantes aos usados na chamada para **CoInitializeSecurity**, com as seguintes diferenças:</span><span class="sxs-lookup"><span data-stu-id="5c720-222">If a client wants to use TLS but change the security blanket after calling [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), it must call either [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) or [**IClientSecurity::SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) with parameters similar to those used in the call to **CoInitializeSecurity**, with the following differences:</span></span>

-   <span data-ttu-id="5c720-223">*pServerPrincName* indica o nome da entidade de segurança do servidor, no formato msstd ou fullsic.</span><span class="sxs-lookup"><span data-stu-id="5c720-223">*pServerPrincName* indicates the principal name of the server, in either msstd or fullsic format.</span></span> <span data-ttu-id="5c720-224">Para obter informações sobre esses formatos, consulte [nomes de entidade de segurança](/windows/desktop/Rpc/principal-names).</span><span class="sxs-lookup"><span data-stu-id="5c720-224">For information on these formats, see [Principal Names](/windows/desktop/Rpc/principal-names).</span></span> <span data-ttu-id="5c720-225">Se o cliente tiver o certificado X. 509 do servidor, ele poderá encontrar o nome da entidade de segurança chamando [**RpcCertGeneratePrincipalName**](/windows/desktop/api/rpcssl/nf-rpcssl-rpccertgenerateprincipalname).</span><span class="sxs-lookup"><span data-stu-id="5c720-225">If the client has the server's X.509 certificate, it can find the principal name by calling [**RpcCertGeneratePrincipalName**](/windows/desktop/api/rpcssl/nf-rpcssl-rpccertgenerateprincipalname).</span></span>
-   <span data-ttu-id="5c720-226">*pAuthInfo* é um ponteiro para um [**\_ contexto de certificado**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), convertido como um ponteiro para \_ identificador de identidade de autenticação RPC \_ \_ , que representa o certificado X. 509 do cliente.</span><span class="sxs-lookup"><span data-stu-id="5c720-226">*pAuthInfo* is a pointer to a [**CERT\_CONTEXT**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), cast as a pointer to RPC\_AUTH\_IDENTITY\_HANDLE, which represents the client's X.509 certificate.</span></span> <span data-ttu-id="5c720-227">Se o cliente não tiver um certificado ou não quiser apresentar seu certificado ao servidor, o *pAuthInfo* deverá ser **nulo** e será feita uma tentativa de conexão anônima com o servidor.</span><span class="sxs-lookup"><span data-stu-id="5c720-227">If the client does not have a certificate or does not wish to present its certificate to the server, *pAuthInfo* must be **NULL** and an anonymous connection will be attempted with the server.</span></span>
-   <span data-ttu-id="5c720-228">*dwCapabilities* consiste em sinalizadores que indicam recursos adicionais do cliente.</span><span class="sxs-lookup"><span data-stu-id="5c720-228">*dwCapabilities* consists of flags that indicate additional client capabilities.</span></span> <span data-ttu-id="5c720-229">Somente quatro sinalizadores podem ser usados para alterar as configurações de ampla segurança: EOAC \_ padrão, EOAC \_ Mutual \_ auth, EOAC \_ qualquer \_ autoridade (esse sinalizador é preterido) e EOAC \_ Make \_ FULLSIC.</span><span class="sxs-lookup"><span data-stu-id="5c720-229">Only four flags can be used to change security blanket settings: EOAC\_DEFAULT, EOAC\_MUTUAL\_AUTH, EOAC\_ANY\_AUTHORITY (this flag is deprecated), and EOAC\_MAKE\_FULLSIC.</span></span> <span data-ttu-id="5c720-230">Para obter mais informações, consulte [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span><span class="sxs-lookup"><span data-stu-id="5c720-230">For more information, see [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span></span>

<span data-ttu-id="5c720-231">Para obter mais informações sobre como usar o [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket), consulte [definindo a segurança no nível de proxy da interface](setting-security-at-the-interface-proxy-level.md).</span><span class="sxs-lookup"><span data-stu-id="5c720-231">For more information about using [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket), see [Setting Security at the Interface Proxy Level](setting-security-at-the-interface-proxy-level.md).</span></span>

### <a name="example-client-changes-the-security-blanket"></a><span data-ttu-id="5c720-232">Exemplo: o cliente altera a cobertura de segurança</span><span class="sxs-lookup"><span data-stu-id="5c720-232">Example: Client Changes the Security Blanket</span></span>

<span data-ttu-id="5c720-233">O exemplo a seguir demonstra como um cliente pode alterar a cobertura de segurança para acomodar uma solicitação do servidor para o cliente fornecer seu certificado X. 509.</span><span class="sxs-lookup"><span data-stu-id="5c720-233">The following example demonstrates how a client can change the security blanket to accommodate a request from the server for the client to provide its X.509 certificate.</span></span> <span data-ttu-id="5c720-234">O código de tratamento de erros é omitido para fins de brevidade.</span><span class="sxs-lookup"><span data-stu-id="5c720-234">Error handling code is omitted for brevity.</span></span>


```C++
void ClientChangesSecurity ()
{
  HCRYPTPROV                   provider           = 0;
  HCERTSTORE                   cert_store         = NULL;
  PCCERT_CONTEXT               client_cert        = NULL;
  PCCERT_CONTEXT               server_cert        = NULL;
  WCHAR                        *server_princ_name = NULL;
  ISecret                      *pSecret           = NULL;
  MULTI_QI                     server_instance;
  COSERVERINFO                 server_machine;
  SOLE_AUTHENTICATION_LIST     auth_list;
  SOLE_AUTHENTICATION_INFO     auth_info[1];



  // Specify all the authentication info. 
  // The client is willing to connect using SChannel,
  //   with no client certificate.
  auth_list.cAuthInfo     = 1;
  auth_list.aAuthInfo     = auth_info;
  auth_info[0].dwAuthnSvc = RPC_C_AUTHN_GSS_SCHANNEL;
  auth_info[0].dwAuthzSvc = RPC_C_AUTHZ_NONE;
  auth_info[0].pAuthInfo  = NULL;  // No certificate

  // Initialize client security with no client certificate.
  CoInitializeSecurity( NULL, -1, NULL, NULL,
                        RPC_C_AUTHN_LEVEL_PKT,
                        RPC_C_IMP_LEVEL_IMPERSONATE, &auth_list,
                        EOAC_NONE, NULL );
  
  // Specify info for the proxy.
  server_instance = {&IID_ISecret, NULL, S_OK};
  server_machine  = {0, L"ServerMachineName", NULL, 0};
  
  // Create a proxy.
  CoCreateInstanceEx( CLSID_Secret, NULL, CLSCTX_REMOTE_SERVER, 
                      &server_machine, 1, &server_instance);
  pSecret = (ISecret *) server_instance.pItf;

  //** The client obtained the server's certificate during the handshake.
  //** The server requests a certificate from the client.

  // Get the default certificate provider.
  CryptAcquireContext( &provider, NULL, NULL, PROV_RSA_SCHANNEL, 0 );

  // Open the certificate store.
  cert_store = CertOpenSystemStore( provider, L"my" );

  // Find the client's certificate.
  client_cert = 
    CertFindCertificateInStore( cert_store,
                                X509_ASN_ENCODING | PKCS_7_ASN_ENCODING,
                                0,
                                CERT_FIND_SUBJECT_STR,
                                L"ClientName",  // Use the principal name
                                NULL );

  // Find the fullsic principal name of the server.
  RpcCertGeneratePrincipalName( server_cert, RPC_C_FULL_CERT_CHAIN, 
                                &server_princ_name );

  // Change the client's security: 
  // Increase the authentication level and attach a certificate.
  CoSetProxyBlanket( pSecret, RPC_C_AUTHN_GSS_SCHANNEL,
                     RPC_C_AUTHZ_NONE,
                     server_princ_name, RPC_C_AUTHN_LEVEL_PKT_PRIVACY,
                     RPC_C_IMP_LEVEL_IMPERSONATE, 
                     (RPC_AUTH_IDENTITY_HANDLE *) client_cert,
                     EOAC_NONE );

  cleanup:
  if (server_princ_name != NULL)
    RpcStringFree( &server_princ_name );
  if (client_cert != NULL)
    CertFreeCertificateContext(client_cert);
  if (server_cert != NULL)
    CertFreeCertificateContext(server_cert);
  if (cert_store != NULL)
    CertCloseStore( cert_store, CERT_CLOSE_STORE_CHECK_FLAG );
  if (provider != 0 )
    CryptReleaseContext( provider, 0 );
  if (pSecret != NULL)
    pSecret->Release();
  CoUninitialize();
}
```



## <a name="related-topics"></a><span data-ttu-id="5c720-235">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="5c720-235">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5c720-236">Pacotes de segurança e COM</span><span class="sxs-lookup"><span data-stu-id="5c720-236">COM and Security Packages</span></span>](com-and-security-packages.md)
</dt> </dl>

 

 