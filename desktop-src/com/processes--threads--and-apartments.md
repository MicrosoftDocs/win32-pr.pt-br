---
title: Processos, threads e Apartments
description: Um processo é uma coleção de espaço de memória virtual, código, dados e recursos do sistema.
ms.assetid: cb62412a-d079-40f9-89dc-cce0bf3889af
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d598fc9d7dd39ab070b58aa7ba45a6e2fcae90db
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/21/2020
ms.locfileid: "104366747"
---
# <a name="processes-threads-and-apartments"></a><span data-ttu-id="a8731-103">Processos, threads e Apartments</span><span class="sxs-lookup"><span data-stu-id="a8731-103">Processes, Threads, and Apartments</span></span>

<span data-ttu-id="a8731-104">Um *processo* é uma coleção de espaço de memória virtual, código, dados e recursos do sistema.</span><span class="sxs-lookup"><span data-stu-id="a8731-104">A *process* is a collection of virtual memory space, code, data, and system resources.</span></span> <span data-ttu-id="a8731-105">Um *thread* é um código que deve ser executado em série em um processo.</span><span class="sxs-lookup"><span data-stu-id="a8731-105">A *thread* is code that is to be serially executed within a process.</span></span> <span data-ttu-id="a8731-106">Um processador executa threads, não processos, para que cada aplicativo tenha pelo menos um processo, e um processo sempre tenha pelo menos um thread de execução, conhecido como thread primário.</span><span class="sxs-lookup"><span data-stu-id="a8731-106">A processor executes threads, not processes, so each application has at least one process, and a process always has at least one thread of execution, known as the primary thread.</span></span> <span data-ttu-id="a8731-107">Um processo pode ter vários threads além do thread principal.</span><span class="sxs-lookup"><span data-stu-id="a8731-107">A process can have multiple threads in addition to the primary thread.</span></span>

<span data-ttu-id="a8731-108">Os processos se comunicam entre si por meio de mensagens, usando a tecnologia RPC (chamada de procedimento remoto) da Microsoft para passar informações entre si.</span><span class="sxs-lookup"><span data-stu-id="a8731-108">Processes communicate with one another through messages, using Microsoft's Remote Procedure Call (RPC) technology to pass information to one another.</span></span> <span data-ttu-id="a8731-109">Não há nenhuma diferença para o chamador entre uma chamada proveniente de um processo em um computador remoto e uma chamada proveniente de outro processo no mesmo computador.</span><span class="sxs-lookup"><span data-stu-id="a8731-109">There is no difference to the caller between a call coming from a process on a remote machine and a call coming from another process on the same machine.</span></span>

<span data-ttu-id="a8731-110">Quando um thread começa a ser executado, ele continua até ser eliminado ou até ser interrompido por um thread com prioridade mais alta (por uma ação do usuário ou o Agendador de threads do kernel).</span><span class="sxs-lookup"><span data-stu-id="a8731-110">When a thread begins to execute, it continues until it is killed or until it is interrupted by a thread with higher priority (by a user action or the kernel's thread scheduler).</span></span> <span data-ttu-id="a8731-111">Cada thread pode executar seções separadas de código ou vários threads podem executar a mesma seção de código.</span><span class="sxs-lookup"><span data-stu-id="a8731-111">Each thread can run separate sections of code, or multiple threads can execute the same section of code.</span></span> <span data-ttu-id="a8731-112">Os threads que executam o mesmo bloco de código mantêm pilhas separadas.</span><span class="sxs-lookup"><span data-stu-id="a8731-112">Threads executing the same block of code maintain separate stacks.</span></span> <span data-ttu-id="a8731-113">Cada thread em um processo compartilha as variáveis e os recursos globais do processo.</span><span class="sxs-lookup"><span data-stu-id="a8731-113">Each thread in a process shares that process's global variables and resources.</span></span>

<span data-ttu-id="a8731-114">O Agendador de thread determina quando e com que frequência executar um thread, de acordo com uma combinação do atributo de classe de prioridade do processo e a prioridade base do thread.</span><span class="sxs-lookup"><span data-stu-id="a8731-114">The thread scheduler determines when and how often to execute a thread, according to a combination of the process's priority class attribute and the thread's base priority.</span></span> <span data-ttu-id="a8731-115">Você define o atributo de classe de prioridade de um processo chamando a função [**SetPriorityClass**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setpriorityclass) e define a prioridade base de um thread com uma chamada para [**SetThreadPriority**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setthreadpriority).</span><span class="sxs-lookup"><span data-stu-id="a8731-115">You set a process's priority class attribute by calling the [**SetPriorityClass**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setpriorityclass) function , and you set a thread's base priority with a call to [**SetThreadPriority**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setthreadpriority).</span></span>

<span data-ttu-id="a8731-116">Os aplicativos multissegmentados devem evitar dois problemas de Threading: *deadlocks* e *corridas*.</span><span class="sxs-lookup"><span data-stu-id="a8731-116">Multithreaded applications must avoid two threading problems: *deadlocks* and *races*.</span></span> <span data-ttu-id="a8731-117">Um deadlock ocorre quando cada thread está aguardando que o outro faça algo.</span><span class="sxs-lookup"><span data-stu-id="a8731-117">A deadlock occurs when each thread is waiting for the other to do something.</span></span> <span data-ttu-id="a8731-118">O controle de chamada COM ajuda a impedir deadlocks em chamadas entre objetos.</span><span class="sxs-lookup"><span data-stu-id="a8731-118">The COM call control helps prevent deadlocks in calls between objects.</span></span> <span data-ttu-id="a8731-119">Uma condição de corrida ocorre quando um thread termina antes de outro em que ele depende, fazendo com que o primeiro use um valor não inicializado porque o último ainda não forneceu um válido.</span><span class="sxs-lookup"><span data-stu-id="a8731-119">A race condition occurs when one thread finishes before another on which it depends, causing the former to use an uninitialized value because the latter has not yet supplied a valid one.</span></span> <span data-ttu-id="a8731-120">O COM fornece algumas funções projetadas especificamente para ajudar a evitar condições de corrida em servidores fora do processo.</span><span class="sxs-lookup"><span data-stu-id="a8731-120">COM supplies some functions specifically designed to help avoid race conditions in out-of-process servers.</span></span> <span data-ttu-id="a8731-121">(Consulte [auxiliares de implementação do servidor fora do processo](out-of-process-server-implementation-helpers.md).)</span><span class="sxs-lookup"><span data-stu-id="a8731-121">(See [Out-of-Process Server Implementation Helpers](out-of-process-server-implementation-helpers.md).)</span></span>

## <a name="the-apartment-and-the-com-threading-architecture"></a><span data-ttu-id="a8731-122">A arquitetura de threading de apartamento e COM</span><span class="sxs-lookup"><span data-stu-id="a8731-122">The Apartment and the COM Threading Architecture</span></span>

<span data-ttu-id="a8731-123">Embora o COM ofereça suporte à predominante do modelo de thread único por processo antes da introdução de vários threads de execução, você pode escrever código para tirar proveito de vários threads, resultando em aplicativos mais eficientes, permitindo que um thread seja executado enquanto outro thread aguarda a conclusão de uma operação demorada.</span><span class="sxs-lookup"><span data-stu-id="a8731-123">While COM supports the single-thread-per-process model prevalent before the introduction of multiple threads of execution, you can write code to take advantage of multiple threads, resulting in more efficient applications, by allowing one thread to be executed while another thread waits for some time-consuming operation to complete.</span></span>

> [!Note]  
> <span data-ttu-id="a8731-124">O uso de vários threads não é uma garantia de melhor desempenho.</span><span class="sxs-lookup"><span data-stu-id="a8731-124">Using multiple threads is not a guarantee of better performance.</span></span> <span data-ttu-id="a8731-125">Na verdade, como o fatoração de thread é um problema difícil, o uso de vários threads geralmente causa problemas de desempenho.</span><span class="sxs-lookup"><span data-stu-id="a8731-125">In fact, because thread factoring is a difficult problem, using multiple threads often causes performance problems.</span></span> <span data-ttu-id="a8731-126">A chave é usar vários threads somente se você tiver certeza do que está fazendo.</span><span class="sxs-lookup"><span data-stu-id="a8731-126">The key is to use multiple threads only if you are very sure of what you are doing.</span></span>

 

<span data-ttu-id="a8731-127">Em geral, a maneira mais simples de exibir a arquitetura de Threading COM é considerar todos os objetos COM no processo, conforme dividido em grupos chamados *Apartments*.</span><span class="sxs-lookup"><span data-stu-id="a8731-127">In general, the simplest way to view the COM threading architecture is to think of all the COM objects in the process as divided into groups called *apartments*.</span></span> <span data-ttu-id="a8731-128">Um objeto COM reside exatamente em um apartamento, no sentido de que seus métodos podem ser chamados legalmente apenas por um thread que pertence a esse apartamento.</span><span class="sxs-lookup"><span data-stu-id="a8731-128">A COM object lives in exactly one apartment, in the sense that its methods can legally be directly called only by a thread that belongs to that apartment.</span></span> <span data-ttu-id="a8731-129">Qualquer outro thread que queira chamar o objeto deve passar por um proxy.</span><span class="sxs-lookup"><span data-stu-id="a8731-129">Any other thread that wants to call the object must go through a proxy.</span></span>

<span data-ttu-id="a8731-130">Há dois tipos de Apartments: [Apartments de thread único](single-threaded-apartments.md)e [Apartments multithread](multithreaded-apartments.md).</span><span class="sxs-lookup"><span data-stu-id="a8731-130">There are two types of apartments: [single-threaded apartments](single-threaded-apartments.md), and [multithreaded apartments](multithreaded-apartments.md).</span></span>

-   <span data-ttu-id="a8731-131">O Apartments de thread único consiste em exatamente um thread, de modo que todos os objetos COM que residem em um apartamento single-thread pode receber chamadas de método somente de um thread que pertence a esse apartamento.</span><span class="sxs-lookup"><span data-stu-id="a8731-131">Single-threaded apartments consist of exactly one thread, so all COM objects that live in a single-threaded apartment can receive method calls only from the one thread that belongs to that apartment.</span></span> <span data-ttu-id="a8731-132">Todas as chamadas de método para um objeto COM em um apartamento de thread único são sincronizadas com a fila de mensagens do Windows para o thread de apartment de thread único.</span><span class="sxs-lookup"><span data-stu-id="a8731-132">All method calls to a COM object in a single-threaded apartment are synchronized with the windows message queue for the single-threaded apartment's thread.</span></span> <span data-ttu-id="a8731-133">Um processo com um único thread de execução é simplesmente um caso especial desse modelo.</span><span class="sxs-lookup"><span data-stu-id="a8731-133">A process with a single thread of execution is simply a special case of this model.</span></span>
-   <span data-ttu-id="a8731-134">O Apartments multithread consiste em um ou mais threads, de modo que todos os objetos COM que residem em um apartamento multithread podem receber chamadas de método diretamente de qualquer um dos threads que pertencem ao apartamento multi-threaded.</span><span class="sxs-lookup"><span data-stu-id="a8731-134">Multithreaded apartments consist of one or more threads, so all COM objects that live in an multithreaded apartment can receive method calls directly from any of the threads that belong to the multithreaded apartment.</span></span> <span data-ttu-id="a8731-135">Threads em um apartamento multithread usam um modelo chamado *Threading livre*.</span><span class="sxs-lookup"><span data-stu-id="a8731-135">Threads in a multithreaded apartment use a model called *free-threading*.</span></span> <span data-ttu-id="a8731-136">Chamadas para objetos COM em um apartamento multithread são sincronizadas pelos próprios objetos.</span><span class="sxs-lookup"><span data-stu-id="a8731-136">Calls to COM objects in a multithreaded apartment are synchronized by the objects themselves.</span></span>

> [!Note]  
> <span data-ttu-id="a8731-137">Para obter uma descrição de comunicação entre Apartments de thread único e Apartments multithread no mesmo processo, consulte [comunicação de thread único e multithread](single-threaded-and-multithreaded-communication.md).</span><span class="sxs-lookup"><span data-stu-id="a8731-137">For a description of communication between single-threaded apartments and multithreaded apartments within the same process, see [Single-Threaded and Multithreaded Communication](single-threaded-and-multithreaded-communication.md).</span></span>

 

<span data-ttu-id="a8731-138">Um processo pode ter zero ou mais Apartments de thread único e zero ou um apartamento multithread.</span><span class="sxs-lookup"><span data-stu-id="a8731-138">A process can have zero or more single-threaded apartments and zero or one multithreaded apartment.</span></span>

<span data-ttu-id="a8731-139">Em um processo, o apartamento principal é o primeiro a ser inicializado.</span><span class="sxs-lookup"><span data-stu-id="a8731-139">In a process, the main apartment is the first to be initialized.</span></span> <span data-ttu-id="a8731-140">Em um processo de thread único, esse é o único apartamento.</span><span class="sxs-lookup"><span data-stu-id="a8731-140">In a single-threaded process, this is the only apartment.</span></span> <span data-ttu-id="a8731-141">Os parâmetros de chamada são empacotados entre Apartments e o COM manipula a sincronização por meio de mensagens.</span><span class="sxs-lookup"><span data-stu-id="a8731-141">Call parameters are marshaled between apartments, and COM handles the synchronization through messaging.</span></span> <span data-ttu-id="a8731-142">Se você designar vários threads em um processo para serem de thread livre, todos os threads livres residirem em um único apartamento, os parâmetros serão passados diretamente para qualquer thread no apartamento e você deverá lidar com toda a sincronização.</span><span class="sxs-lookup"><span data-stu-id="a8731-142">If you designate multiple threads in a process to be free-threaded, all free threads reside in a single apartment, parameters are passed directly to any thread in the apartment, and you must handle all synchronization.</span></span> <span data-ttu-id="a8731-143">Em um processo com Threading livre e thread apartment, todos os threads livres residem em um único apartamento e todos os outros Apartments são Apartments de thread único.</span><span class="sxs-lookup"><span data-stu-id="a8731-143">In a process with both free-threading and apartment threading, all free threads reside in a single apartment and all other apartments are single-threaded apartments.</span></span> <span data-ttu-id="a8731-144">Um processo que faz trabalho COM é uma coleção de Apartments com, no máximo, um apartamento multi-threaded, mas qualquer número de Apartments de thread único.</span><span class="sxs-lookup"><span data-stu-id="a8731-144">A process that does COM work is a collection of apartments with, at most, one multithreaded apartment but any number of single-threaded apartments.</span></span>

<span data-ttu-id="a8731-145">Os modelos de threading no COM fornecem o mecanismo para clientes e servidores que usam diferentes arquiteturas de threading para trabalharem juntos.</span><span class="sxs-lookup"><span data-stu-id="a8731-145">The threading models in COM provide the mechanism for clients and servers that use different threading architectures to work together.</span></span> <span data-ttu-id="a8731-146">As chamadas entre objetos com modelos de Threading diferentes em processos diferentes são naturalmente suportadas.</span><span class="sxs-lookup"><span data-stu-id="a8731-146">Calls among objects with different threading models in different processes are naturally supported.</span></span> <span data-ttu-id="a8731-147">Da perspectiva do objeto de chamada, todas as chamadas para objetos fora de um processo se comportam de forma idêntica, independentemente de como o objeto que está sendo chamado é threaded.</span><span class="sxs-lookup"><span data-stu-id="a8731-147">From the perspective of the calling object, all calls to objects outside a process behave identically, no matter how the object being called is threaded.</span></span> <span data-ttu-id="a8731-148">Da mesma forma, da perspectiva do objeto que está sendo chamado, chamadas de chegada se comportam de maneira idêntica, independentemente do modelo de Threading do chamador.</span><span class="sxs-lookup"><span data-stu-id="a8731-148">Likewise, from the perspective of the object being called, arriving calls behave identically, regardless of the threading model of the caller.</span></span>

<span data-ttu-id="a8731-149">A interação entre um cliente e um objeto fora do processo é simples, mesmo quando eles usam modelos de Threading diferentes porque o cliente e o objeto estão em processos diferentes.</span><span class="sxs-lookup"><span data-stu-id="a8731-149">Interaction between a client and an out-of-process object is straightforward, even when they use different threading models because the client and object are in different processes.</span></span> <span data-ttu-id="a8731-150">COM, entre o cliente e o servidor, o pode fornecer o código para que os modelos de Threading interoperem, usando marshaling padrão e RPC.</span><span class="sxs-lookup"><span data-stu-id="a8731-150">COM, interposed between the client and the server, can provide the code for the threading models to interoperate, using standard marshaling and RPC.</span></span> <span data-ttu-id="a8731-151">Por exemplo, se um objeto de thread único for chamado simultaneamente por vários clientes de thread livre, as chamadas serão sincronizadas pelo COM colocando as mensagens de janela correspondentes na fila de mensagens do servidor.</span><span class="sxs-lookup"><span data-stu-id="a8731-151">For example, if a single-threaded object is called simultaneously by multiple free-threaded clients, the calls will be synchronized by COM by placing corresponding window messages in the server's message queue.</span></span> <span data-ttu-id="a8731-152">O apartamento do objeto receberá uma chamada cada vez que recuperar e enviar mensagens.</span><span class="sxs-lookup"><span data-stu-id="a8731-152">The object's apartment will receive one call each time it retrieves and dispatches messages.</span></span> <span data-ttu-id="a8731-153">No entanto, deve-se tomar cuidado para garantir que os servidores em processo interajam corretamente com seus clientes.</span><span class="sxs-lookup"><span data-stu-id="a8731-153">However, some care must be taken to ensure that in-process servers interact properly with their clients.</span></span> <span data-ttu-id="a8731-154">(Consulte [problemas de thread de servidor em processo](in-process-server-threading-issues.md).)</span><span class="sxs-lookup"><span data-stu-id="a8731-154">(See [In-Process Server Threading Issues](in-process-server-threading-issues.md).)</span></span>

<span data-ttu-id="a8731-155">O problema mais importante na programação com um modelo multi-threaded é tornar seu código seguro para thread, de forma que as mensagens destinadas a um thread específico passem apenas para esse thread e o acesso aos threads seja protegido.</span><span class="sxs-lookup"><span data-stu-id="a8731-155">The most important issue in programming with a multithreaded model is to make your code thread-safe so that messages intended for a particular thread go only to that thread and access to threads is protected.</span></span>

<span data-ttu-id="a8731-156">Para mais informações, consulte os seguintes tópicos:</span><span class="sxs-lookup"><span data-stu-id="a8731-156">For more information, see the following topics:</span></span>

-   [<span data-ttu-id="a8731-157">Escolhendo o modelo de Threading</span><span class="sxs-lookup"><span data-stu-id="a8731-157">Choosing the Threading Model</span></span>](choosing-the-threading-model.md)
-   [<span data-ttu-id="a8731-158">Apartments de thread único</span><span class="sxs-lookup"><span data-stu-id="a8731-158">Single-Threaded Apartments</span></span>](single-threaded-apartments.md)
-   [<span data-ttu-id="a8731-159">Apartments multithread</span><span class="sxs-lookup"><span data-stu-id="a8731-159">Multithreaded Apartments</span></span>](multithreaded-apartments.md)
-   [<span data-ttu-id="a8731-160">Comunicação de thread único e multithread</span><span class="sxs-lookup"><span data-stu-id="a8731-160">Single-Threaded and Multithreaded Communication</span></span>](single-threaded-and-multithreaded-communication.md)
-   [<span data-ttu-id="a8731-161">Problemas de Threading do servidor em processo</span><span class="sxs-lookup"><span data-stu-id="a8731-161">In-Process Server Threading Issues</span></span>](in-process-server-threading-issues.md)
-   [<span data-ttu-id="a8731-162">Acessando interfaces em Apartments</span><span class="sxs-lookup"><span data-stu-id="a8731-162">Accessing Interfaces Across Apartments</span></span>](accessing-interfaces-across-apartments.md)

 

 