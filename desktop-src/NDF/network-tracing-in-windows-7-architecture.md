---
title: Rastreamento de rede na arquitetura do Windows 7
description: A ilustração a seguir mostra a arquitetura básica de rastreamento de rede no Windows 7.
ms.assetid: b3023469-0f98-451c-b39f-c3eae771eacc
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 41221ebf434c05a8c9b7c8489e861128029b5320
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/20/2020
ms.locfileid: "105759195"
---
# <a name="network-tracing-in-windows-7-architecture"></a><span data-ttu-id="8da1a-103">Rastreamento de rede no Windows 7: arquitetura</span><span class="sxs-lookup"><span data-stu-id="8da1a-103">Network Tracing in Windows 7: Architecture</span></span>

<span data-ttu-id="8da1a-104">A ilustração a seguir mostra a arquitetura básica de rastreamento de rede no Windows 7.</span><span class="sxs-lookup"><span data-stu-id="8da1a-104">The illustration below shows the basic network tracing architecture in Windows 7.</span></span>

![diagrama da arquitetura de rastreamento de rede](images/ut1.png)

<span data-ttu-id="8da1a-106">O rastreamento de rede utiliza a estrutura ETW (rastreamento de eventos para Windows) disponível no Windows.</span><span class="sxs-lookup"><span data-stu-id="8da1a-106">Network tracing utilizes the Event Tracing for Windows (ETW) framework available in Windows.</span></span> <span data-ttu-id="8da1a-107">Os componentes de rede (como Winsock, TCP/IP, NDIS, captura de pacotes e assim por diante) se registram como provedores de rastreamento ETW e emitem eventos relacionados à atividade de rede.</span><span class="sxs-lookup"><span data-stu-id="8da1a-107">Network components (such as Winsock, TCP/IP, NDIS, packet-capture, and so on) register as ETW trace providers and emit events related to network activity.</span></span> <span data-ttu-id="8da1a-108">Qualquer atividade gravável de significância pode ser um evento registrado no ETW.</span><span class="sxs-lookup"><span data-stu-id="8da1a-108">Any recordable activity of significance can be an event logged to ETW.</span></span> <span data-ttu-id="8da1a-109">O rastreamento para esses componentes de rede e capturas de pacotes pode ser habilitado usando o contexto de **rastreamento netsh** que atua como um controlador ETW.</span><span class="sxs-lookup"><span data-stu-id="8da1a-109">Tracing for these network components and packet captures can be enabled using the **netsh trace** context which acts as an ETW controller.</span></span>

<span data-ttu-id="8da1a-110">Os rastreamentos gerados são coletados em um arquivo de log de rastreamento de eventos (ETL).</span><span class="sxs-lookup"><span data-stu-id="8da1a-110">The generated traces are collected in an Event Trace Log (ETL) file.</span></span> <span data-ttu-id="8da1a-111">Esses arquivos ETL podem ser analisados usando várias ferramentas, como Monitor de Rede 3,2 e posterior, Visualizador de Eventos, **netsh trace Convert** ou Tracerpt.exe.</span><span class="sxs-lookup"><span data-stu-id="8da1a-111">These ETL files can then be analyzed using a number of tools, such as Network Monitor 3.2 and later, Event Viewer, **netsh trace convert**, or Tracerpt.exe.</span></span>

<span data-ttu-id="8da1a-112">Cada evento ETW tem um cabeçalho comum em que o ETW armazena informações como as propriedades do evento, carimbos de data/hora e ID da atividade.</span><span class="sxs-lookup"><span data-stu-id="8da1a-112">Each ETW event has a common header where ETW stores information such as the event properties, time stamps, and activity ID.</span></span> <span data-ttu-id="8da1a-113">(Para obter mais informações sobre IDs de atividade, consulte [escrevendo eventos relacionados em um cenário de ponta a ponta](../etw/writing-related-events-in-an-end-to-end-scenario.md)).</span><span class="sxs-lookup"><span data-stu-id="8da1a-113">(For more information about activity IDs, see [Writing Related Events in an End-to-End Scenario](../etw/writing-related-events-in-an-end-to-end-scenario.md)).</span></span> <span data-ttu-id="8da1a-114">A ID da atividade é usada para correlacionar eventos.</span><span class="sxs-lookup"><span data-stu-id="8da1a-114">The activity ID is used to correlate events.</span></span> <span data-ttu-id="8da1a-115">No modo de usuário, as IDs de atividade são armazenadas em threads e todos os eventos registrados em um thread serão automaticamente marcados com a mesma ID de atividade.</span><span class="sxs-lookup"><span data-stu-id="8da1a-115">In user mode, activity IDs are stored in threads, and all events logged in one thread will automatically be tagged with the same activity ID.</span></span> <span data-ttu-id="8da1a-116">No modo kernel, a ID da atividade deve ser passada explicitamente quando um evento é registrado.</span><span class="sxs-lookup"><span data-stu-id="8da1a-116">In kernel mode, the activity ID must be explicitly passed when an event is logged.</span></span> <span data-ttu-id="8da1a-117">Por padrão, os arquivos ETL são correlacionados para agrupar eventos em IDs de atividade específicas.</span><span class="sxs-lookup"><span data-stu-id="8da1a-117">By default, ETL files are correlated to group events together under specific activity IDs.</span></span>

<span data-ttu-id="8da1a-118">Para obter mais informações sobre eventos do Windows e ETW, consulte [eventos do Windows](../events/windows-events.md).</span><span class="sxs-lookup"><span data-stu-id="8da1a-118">For more information about Windows Events and ETW, see [Windows Events](../events/windows-events.md).</span></span>

## <a name="etw-components-in-network-tracing"></a><span data-ttu-id="8da1a-119">Componentes do ETW no rastreamento de rede</span><span class="sxs-lookup"><span data-stu-id="8da1a-119">ETW Components in Network Tracing</span></span>

<span data-ttu-id="8da1a-120">O rastreamento de rede usa o ETW como seu mecanismo de rastreamento primário para fornecer informações sobre o que os subsistemas de rede estão fazendo.</span><span class="sxs-lookup"><span data-stu-id="8da1a-120">Network tracing uses ETW as its primary tracing mechanism to provide information about what the networking subsystems are doing.</span></span> <span data-ttu-id="8da1a-121">Há quatro componentes principais no ETW: sessões de rastreamento de eventos, provedores de eventos, controladores de eventos e consumidores de eventos.</span><span class="sxs-lookup"><span data-stu-id="8da1a-121">There are four main components in ETW: event trace sessions, event providers, event controllers and event consumers.</span></span>

<span data-ttu-id="8da1a-122">O buffer e o log ocorrem em *sessões de rastreamento de eventos*, que aceitam eventos de provedores e criam arquivos de rastreamento.</span><span class="sxs-lookup"><span data-stu-id="8da1a-122">Buffering and logging take place in *event trace sessions*, which accept events from providers and creates trace files.</span></span>

<span data-ttu-id="8da1a-123">Um *provedor de eventos* é uma entidade lógica que grava eventos em sessões de ETW.</span><span class="sxs-lookup"><span data-stu-id="8da1a-123">An *event provider* is a logical entity that writes events to ETW sessions.</span></span> <span data-ttu-id="8da1a-124">Um provedor de eventos pode ser um aplicativo de modo de usuário, um aplicativo gerenciado, um driver ou qualquer outra entidade de software.</span><span class="sxs-lookup"><span data-stu-id="8da1a-124">An event provider can be a user-mode application, a managed application, a driver, or any other software entity.</span></span> <span data-ttu-id="8da1a-125">Os provedores de eventos se registram com o ETW e gravam eventos de vários pontos no código invocando a API de log do ETW.</span><span class="sxs-lookup"><span data-stu-id="8da1a-125">Event providers register with ETW and write events from various points in the code by invoking the ETW logging API.</span></span> <span data-ttu-id="8da1a-126">Devido à crescente Instrumentação de eventos em vários componentes do sistema operacional, mesmo um aplicativo ou cenário simples no Windows conterá vários componentes que são provedores de eventos.</span><span class="sxs-lookup"><span data-stu-id="8da1a-126">Due to the growing event instrumentation in many operating system components, even a simple application or scenario in Windows will contain several components that are event providers.</span></span>

<span data-ttu-id="8da1a-127">Um *controlador de eventos* inicia e interrompe as sessões de rastreamento de eventos e habilita os provedores.</span><span class="sxs-lookup"><span data-stu-id="8da1a-127">An *event controller* starts and stops event trace sessions and enables providers.</span></span> <span data-ttu-id="8da1a-128">Quando um provedor de eventos é habilitado dinamicamente pelo aplicativo do controlador de eventos, o provedor envia eventos para uma sessão de rastreamento de eventos específica designada pelo controlador de evento.</span><span class="sxs-lookup"><span data-stu-id="8da1a-128">When an event provider is enabled dynamically by the event controller application, the provider sends events to a specific event trace session designated by the event controller.</span></span> <span data-ttu-id="8da1a-129">Cada evento enviado pelo provedor de eventos para a sessão de rastreamento de eventos consiste em um cabeçalho fixo, que inclui metadados de eventos e quaisquer dados personalizados adicionais registrados pelo provedor.</span><span class="sxs-lookup"><span data-stu-id="8da1a-129">Each event sent by the event provider to the event trace session consists of a fixed header, which includes event metadata and any additional custom data logged by the provider.</span></span>

<span data-ttu-id="8da1a-130">Um *consumidor de eventos* é um aplicativo que lê arquivos de log ou que ouve uma sessão de rastreamento de eventos para eventos em tempo real e os processa.</span><span class="sxs-lookup"><span data-stu-id="8da1a-130">An *event consumer* is an application that reads log files or that listens to an event trace session for real-time events and processes them.</span></span> <span data-ttu-id="8da1a-131">Um exemplo de um consumidor de evento é Monitor de Rede da Microsoft 3,2, que inclui a capacidade de ler e exibir arquivos de log produzidos pelo rastreamento de rede no Windows 7.</span><span class="sxs-lookup"><span data-stu-id="8da1a-131">One example of an event consumer is Microsoft Network Monitor 3.2, which includes the capability to read and display log files produced by network tracing in Windows 7.</span></span>

<span data-ttu-id="8da1a-132">Os eventos são entregues aos consumidores de eventos em ordem cronológica e há vários aplicativos de consumidor de eventos que exibem os eventos em formatos específicos.</span><span class="sxs-lookup"><span data-stu-id="8da1a-132">Events are delivered to event consumers in chronological order, and there are various event consumer applications that display the events in specific formats.</span></span> <span data-ttu-id="8da1a-133">Quando um evento é registrado em uma sessão, o ETW adiciona informações adicionais ao cabeçalho do evento, incluindo o carimbo de data/hora, o processo e a ID do thread, o número do processador e os dados de uso da CPU do thread de log.</span><span class="sxs-lookup"><span data-stu-id="8da1a-133">When an event is logged to a session, ETW adds additional information to the event header, including the timestamp, process and thread ID, processor number, and CPU usage data of the logging thread.</span></span> <span data-ttu-id="8da1a-134">Esses dados são então passados para consumidores de eventos, juntamente com quaisquer dados personalizados incluídos pelo provedor.</span><span class="sxs-lookup"><span data-stu-id="8da1a-134">This data is then passed on to event consumers, along with any custom data included by the provider.</span></span>

<span data-ttu-id="8da1a-135">Os provedores que usam as novas [APIs de log de eventos](/windows/win32/api/evntprov/nf-evntprov-eventwrite) devem fornecer um arquivo XML chamado manifesto de [evento](../wes/eventschema-schema.md).</span><span class="sxs-lookup"><span data-stu-id="8da1a-135">Providers using the new [Event Logging APIs](/windows/win32/api/evntprov/nf-evntprov-eventwrite) are expected to supply an XML file called the [event manifest](../wes/eventschema-schema.md).</span></span> <span data-ttu-id="8da1a-136">Esse arquivo fornece metadados para definir todos os dados personalizados e informações de layout para os eventos gravados pelo provedor.</span><span class="sxs-lookup"><span data-stu-id="8da1a-136">This file provides metadata to define all of the custom data and layout information for the events written by the provider.</span></span> <span data-ttu-id="8da1a-137">Em seguida, um aplicativo consumidor de uso geral usa APIs [TDH (Trace Data Helper)](/windows/win32/api/tdh/) para recuperar os metadados do evento, decodificar os eventos e exibi-los.</span><span class="sxs-lookup"><span data-stu-id="8da1a-137">A general purpose consumer application then uses [Trace Data Helper (TDH)](/windows/win32/api/tdh/) APIs to retrieve the event metadata, decode the events, and display them.</span></span>

<span data-ttu-id="8da1a-138">Com o rastreamento de rede no Windows 7, o lado do controlador de eventos/consumidor inclui suporte de rastreamento baseado em cenário de ponta a ponta integrado às experiências gerais de diagnóstico e suporte do Windows.</span><span class="sxs-lookup"><span data-stu-id="8da1a-138">With network tracing in Windows 7, the event controller/consumer side includes end-to-end scenario-based tracing support integrated with overall Windows diagnostic and support experiences.</span></span> <span data-ttu-id="8da1a-139">Um cenário define uma coleção de provedores de eventos envolvidos no cenário.</span><span class="sxs-lookup"><span data-stu-id="8da1a-139">A scenario defines a collection of event providers involved in the scenario.</span></span> <span data-ttu-id="8da1a-140">O lado do controlador de evento/consumidor define os cenários (contextos) em que o rastreamento pode ser usado, incluindo os provedores relevantes para determinados cenários em todos os componentes de rede.</span><span class="sxs-lookup"><span data-stu-id="8da1a-140">The event controller/consumer side defines the scenarios (contexts) where tracing can be used, including the relevant providers for given scenarios across network components.</span></span> <span data-ttu-id="8da1a-141">O lado do provedor de eventos inclui eventos de rastreamento de rede padronizados de diferentes componentes na pilha de rede, que podem ser correlacionados por meio de IDs de atividade de ETW.</span><span class="sxs-lookup"><span data-stu-id="8da1a-141">The event provider side includes standardized network tracing events from different components in the network stack, which can be correlated via ETW activity IDs.</span></span> <span data-ttu-id="8da1a-142">Os provedores usam um esquema de rede comum que padroniza o uso de conceitos de ETW, como palavras-chave, níveis, tarefas e OpCodes.</span><span class="sxs-lookup"><span data-stu-id="8da1a-142">The providers use a common network schema that standardizes the use of ETW concepts such as keywords, levels, tasks, and opcodes.</span></span> <span data-ttu-id="8da1a-143">O esquema também define eventos que são comuns para muitos componentes de rede, como eventos de erro, eventos de descarte de pacotes, eventos de esquema e eventos de transição de estado.</span><span class="sxs-lookup"><span data-stu-id="8da1a-143">The schema also defines events that are common for many network components such as error events, packet drop events, schema events, and state transition events.</span></span>

 

 