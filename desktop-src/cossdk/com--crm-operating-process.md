---
description: Processo operacional de CRM do COM+
ms.assetid: be50912e-b9fd-4ef7-b81a-e37617a96955
title: Processo operacional de CRM do COM+
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d39dba3dedcbdefebe0f62144547ebb6985fa51f
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103826648"
---
# <a name="com-crm-operating-process"></a><span data-ttu-id="8584e-103">Processo operacional de CRM do COM+</span><span class="sxs-lookup"><span data-stu-id="8584e-103">COM+ CRM Operating Process</span></span>

<span data-ttu-id="8584e-104">Em uma operação normal, um componente de aplicativo em execução em um processo de aplicativo de servidor usaria um CRM do COM+ criando um trabalho de CRM.</span><span class="sxs-lookup"><span data-stu-id="8584e-104">In normal operation, an application component running in a server application process would use a COM+ CRM by creating a CRM worker.</span></span> <span data-ttu-id="8584e-105">O trabalhador do CRM implementa uma interface COM específica à tarefa que ele foi projetado para executar.</span><span class="sxs-lookup"><span data-stu-id="8584e-105">The CRM worker implements a COM interface specific to the task it is designed to perform.</span></span> <span data-ttu-id="8584e-106">O componente do aplicativo deve ser executado sob uma transação para que o trabalhador do CRM herde a transação do componente do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8584e-106">The application component must be running under a transaction so that the CRM worker inherits the transaction of the application component.</span></span> <span data-ttu-id="8584e-107">Os trabalhadores do CRM sempre exigem uma transação.</span><span class="sxs-lookup"><span data-stu-id="8584e-107">CRM workers always require a transaction.</span></span>

<span data-ttu-id="8584e-108">Para acessar o CRM COM+, o trabalhador do CRM primeiro obtém a interface [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) , que permite que o trabalhador do CRM grave registros no log durável.</span><span class="sxs-lookup"><span data-stu-id="8584e-108">To access the COM+ CRM, the CRM worker first obtains the [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface, which allows the CRM worker to write records to the durable log.</span></span> <span data-ttu-id="8584e-109">O trabalhador do CRM obtém essa interface criando um componente do administrador do CRM.</span><span class="sxs-lookup"><span data-stu-id="8584e-109">The CRM worker obtains this interface by creating a CRM clerk component.</span></span>

<span data-ttu-id="8584e-110">Em seguida, o trabalhador do CRM deve informar ao administrador do CRM o nome do compensador de CRM que deseja usar.</span><span class="sxs-lookup"><span data-stu-id="8584e-110">Next the CRM worker must tell the CRM clerk the name of the CRM Compensator it wants to use.</span></span> <span data-ttu-id="8584e-111">Ele faz isso chamando o método [**ICrmLogControl:: RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) .</span><span class="sxs-lookup"><span data-stu-id="8584e-111">It does this by calling the [**ICrmLogControl::RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) method.</span></span> <span data-ttu-id="8584e-112">Depois que esse método é chamado, o compensador de CRM é criado pela infraestrutura do CRM quando a transação é concluída.</span><span class="sxs-lookup"><span data-stu-id="8584e-112">After this method is called, the CRM Compensator is created by the CRM infrastructure when the transaction completes.</span></span>

<span data-ttu-id="8584e-113">Depois que o trabalhador do CRM tiver registrado seu compensador de CRM, ele poderá gravar registros no log do CRM usando [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span><span class="sxs-lookup"><span data-stu-id="8584e-113">After the CRM worker has registered its CRM Compensator, it can write records to the CRM log using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="8584e-114">O trabalhador do CRM deve fazer *write-ahead*; ou seja, ele deve gravar um registro no log que descreve uma ação antes de realmente executar a ação, caso uma falha ocorra imediatamente após a conclusão da ação.</span><span class="sxs-lookup"><span data-stu-id="8584e-114">The CRM worker must *write ahead*; that is, it must write a record to the log describing an action before it actually performs the action, in case a crash occurs immediately after completing the action.</span></span> <span data-ttu-id="8584e-115">Sem esses registros de log write-ahead, não há nenhuma maneira de corrigir para a ação.</span><span class="sxs-lookup"><span data-stu-id="8584e-115">Without these write-ahead log records, there is no way to correct for the action.</span></span>

<span data-ttu-id="8584e-116">Além disso, write ahead significa que o compensador de CRM, que é o componente que recebe os registros de log na recuperação, deve lidar com o caso em que os registros de log foram gravados, mas a ação não realmente ocorre.</span><span class="sxs-lookup"><span data-stu-id="8584e-116">Also, write ahead means that the CRM Compensator, which is the component that receives the log records on recovery, must deal with the case where the log records were written but the action did not in fact occur.</span></span> <span data-ttu-id="8584e-117">As ações do compensador de CRM devem ser *idempotentes*; ou seja, eles devem ser capazes de serem executados mais de uma vez, mas devem levar ao mesmo resultado.</span><span class="sxs-lookup"><span data-stu-id="8584e-117">Actions by the CRM Compensator must be *idempotent*; that is, they should be capable of being performed more than once but should lead to the same outcome.</span></span> <span data-ttu-id="8584e-118">Por exemplo, definir um saldo de conta com o valor de $100 é uma ação idempotente; Adicionar $100 ao saldo da conta não é.</span><span class="sxs-lookup"><span data-stu-id="8584e-118">For example, setting an account balance to the value of $100 is an idempotent action; adding $100 to the account balance is not.</span></span>

<span data-ttu-id="8584e-119">A interface [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) fornece os dois métodos a seguir para gravar registros de log:</span><span class="sxs-lookup"><span data-stu-id="8584e-119">The [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface provides the following two methods for writing log records:</span></span>

-   <span data-ttu-id="8584e-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) é usado para gravar um registro de log estruturado que é criado como uma coleção de variantes.</span><span class="sxs-lookup"><span data-stu-id="8584e-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) is used for writing a structured log record that is built up as a collection of Variants.</span></span> <span data-ttu-id="8584e-121">Ele é usado principalmente para desenvolver CRMs no Microsoft Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="8584e-121">It is primarily for use when developing CRMs in Microsoft Visual Basic.</span></span>
-   <span data-ttu-id="8584e-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) é usado para gravar um registro de log não estruturado como BLOBs de bytes.</span><span class="sxs-lookup"><span data-stu-id="8584e-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) is used for writing an unstructured log record as BLOBs of bytes.</span></span> <span data-ttu-id="8584e-123">Ele é usado principalmente para desenvolver CRMs em Microsoft Visual C++.</span><span class="sxs-lookup"><span data-stu-id="8584e-123">It is primarily for use when developing CRMs in Microsoft Visual C++.</span></span> <span data-ttu-id="8584e-124">Como as estruturas de registro em C geralmente são constituídas de um conjunto de cabeçalhos e campos que podem ser dispersos na memória, o método **WriteLogRecord** implementa um recurso de coleta que reduz a cópia de dados.</span><span class="sxs-lookup"><span data-stu-id="8584e-124">Because record structures in C are often made up of a set of headers and fields that may be scattered in memory, the **WriteLogRecord** method implements a gather capability that reduces the copying of data.</span></span>

> [!Note]  
> <span data-ttu-id="8584e-125">Você não deve digitar os tipos de ponteiro do usuário em estruturas de dados em um registro de log.</span><span class="sxs-lookup"><span data-stu-id="8584e-125">You should not user pointer types within data structures in a log record.</span></span> <span data-ttu-id="8584e-126">Os ponteiros não são mais válidos durante a fase de recuperação porque o compensador de CRM é executado em um processo diferente daquele do trabalhador do CRM que gravou o registro de log.</span><span class="sxs-lookup"><span data-stu-id="8584e-126">Pointers are no longer valid during recovery phase because the CRM Compensator runs in a different process than that of the CRM worker that wrote the log record.</span></span> <span data-ttu-id="8584e-127">A inclusão de tipos de ponteiro em um registro de log pode fazer com que um aplicativo falhe ou se corrompa durante a recuperação.</span><span class="sxs-lookup"><span data-stu-id="8584e-127">Including pointer types in a log record might cause an application to crash or corrupt itself during recovery.</span></span>

 

<span data-ttu-id="8584e-128">Esses dois métodos de gravação gravam um registro de log no disco, mas não garantem a durabilidade do registro.</span><span class="sxs-lookup"><span data-stu-id="8584e-128">Both of these write methods write a log record to disk but do not guarantee the record's durability.</span></span> <span data-ttu-id="8584e-129">Embora permitir que as gravações lentas sejam acumuladas antes de forçar o disco possa melhorar o desempenho, você pode usar o método [**ICrmLogControl:: ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) em vez de garantir que todas as gravações feitas pelo CRM sejam duráveis em disco, o que é importante para a recuperação de falhas.</span><span class="sxs-lookup"><span data-stu-id="8584e-129">While allowing lazy writes to accumulate before forcing to disk can improve performance, you can use the [**ICrmLogControl::ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) method instead to guarantee that all writes done by the CRM are durable on disk, which is important for failure recovery.</span></span>

<span data-ttu-id="8584e-130">Quando o trabalhador do CRM é concluído com suas ações e concluiu a gravação e a força de registros no log, ele deve liberar [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span><span class="sxs-lookup"><span data-stu-id="8584e-130">When the CRM worker is done with its actions and has finished writing and forcing records to the log, it must release [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="8584e-131">Quando a transação é concluída (normalmente devido ao componente de aplicativo chamando [**SetComplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) ou [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)), a infraestrutura de CRM cria o componente compensador de CRM, que implementa a interface [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) ou a interface [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) .</span><span class="sxs-lookup"><span data-stu-id="8584e-131">When the transaction completes (typically due to the application component calling [**SetComplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) or [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)), the CRM infrastructure creates the CRM Compensator component, which implements either the [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) interface or the [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) interface.</span></span> <span data-ttu-id="8584e-132">Essas interfaces são usadas para passar os registros não estruturados (Visual C++) ou estruturados (Visual Basic) para o compensador de CRM junto com as notificações de resultado da transação.</span><span class="sxs-lookup"><span data-stu-id="8584e-132">These interfaces are used to pass the unstructured (Visual C++) or structured (Visual Basic) records to the CRM Compensator along with the transaction outcome notifications.</span></span>

<span data-ttu-id="8584e-133">O compensador de CRM é notificado primeiro da fase de preparação da conclusão da transação e pode votar em Sim ou não na solicitação de preparação.</span><span class="sxs-lookup"><span data-stu-id="8584e-133">The CRM Compensator is first notified of the prepare phase of the transaction completion and can vote either yes or no to the prepare request.</span></span> <span data-ttu-id="8584e-134">Se o compensador de CRM não receber nenhuma outra notificação de anulação.</span><span class="sxs-lookup"><span data-stu-id="8584e-134">If the CRM Compensator votes no, it does not receive any further abort notifications.</span></span> <span data-ttu-id="8584e-135">Se ele tiver votos de Sim para a solicitação de preparação, ele receberá as notificações de confirmação ou anulação.</span><span class="sxs-lookup"><span data-stu-id="8584e-135">If it votes yes to the prepare request, it receives either the commit or abort notifications.</span></span> <span data-ttu-id="8584e-136">No caso de uma anulação de cliente, nenhuma notificação de preparação é recebida, somente as notificações de anulação.</span><span class="sxs-lookup"><span data-stu-id="8584e-136">In the case of a client abort, no prepare notifications are received, only abort notifications.</span></span> <span data-ttu-id="8584e-137">O compensador de CRM deve estar preparado para lidar com todos esses casos e também deve lidar com o caso em que nenhum registro de log foi gravado com êxito pelo trabalhador do CRM.</span><span class="sxs-lookup"><span data-stu-id="8584e-137">The CRM Compensator must be prepared to handle all these cases, and it also must handle the case where no log records were successfully written by the CRM worker.</span></span> <span data-ttu-id="8584e-138">O compensador de CRM não deve assumir que a mesma instância de compensador de CRM receberá as notificações da fase 1 (preparação) e da fase 2 (confirmação ou anulação), pois elas podem ser interrompidas pela recuperação.</span><span class="sxs-lookup"><span data-stu-id="8584e-138">The CRM Compensator must not assume that the same CRM Compensator instance will receive both the phase 1 (prepare) and the phase 2 (commit or abort) notifications, as these could be interrupted by recovery.</span></span>

<span data-ttu-id="8584e-139">Normalmente, um compensador de CRM usa a notificação de anulação para reverter a ação que foi executada pelo trabalhador do CRM.</span><span class="sxs-lookup"><span data-stu-id="8584e-139">Typically, a CRM Compensator uses the abort notification to reverse the action that was performed by the CRM worker.</span></span> <span data-ttu-id="8584e-140">O trabalhador do CRM pode deixar algum estado disponível caso precise reverter sua ação.</span><span class="sxs-lookup"><span data-stu-id="8584e-140">The CRM worker might leave some state available in case it needs to reverse its action.</span></span> <span data-ttu-id="8584e-141">Esse Estado pode estar totalmente contido nos registros de log e, se não for, o compensador de CRM precisará limpar esse Estado se a transação for confirmada.</span><span class="sxs-lookup"><span data-stu-id="8584e-141">That state might be fully contained in the log records, and if not, the CRM Compensator needs to clean up that state if the transaction commits.</span></span> <span data-ttu-id="8584e-142">Esse é o motivo pelo qual o compensador de CRM recebe a notificação de confirmação.</span><span class="sxs-lookup"><span data-stu-id="8584e-142">This is the reason why the CRM Compensator receives the commit notification.</span></span> <span data-ttu-id="8584e-143">O compensador de CRM não é executado em uma transação DTC.</span><span class="sxs-lookup"><span data-stu-id="8584e-143">The CRM Compensator does not run under a DTC transaction.</span></span>

<span data-ttu-id="8584e-144">O compensador de CRM pode registrar novos registros, se necessário, usando [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), que recebe à medida que ele é criado.</span><span class="sxs-lookup"><span data-stu-id="8584e-144">The CRM Compensator can log new records if required by using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), which it receives as it is created.</span></span> <span data-ttu-id="8584e-145">O trabalho de CRM e o compensador de CRM também podem esquecer o último registro de log gravado, o que pode ser necessário para evitar a recuperação desnecessária.</span><span class="sxs-lookup"><span data-stu-id="8584e-145">Both the CRM worker and CRM Compensator can also forget the last log record they wrote, which might be required to avoid unnecessary recovery.</span></span>

## <a name="related-topics"></a><span data-ttu-id="8584e-146">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="8584e-146">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8584e-147">Conceitos do Gerenciador de recursos de compensação COM+</span><span class="sxs-lookup"><span data-stu-id="8584e-147">COM+ Compensating Resource Manager Concepts</span></span>](com--compensating-resource-manager-concepts.md)
</dt> <dt>

[<span data-ttu-id="8584e-148">Inicialização e recuperação do CRM do COM+</span><span class="sxs-lookup"><span data-stu-id="8584e-148">COM+ CRM Startup and Recovery</span></span>](com--crm-startup-and-recovery.md)
</dt> </dl>

 

 



