---
description: Gerenciando identificadores de arquivo transacionais em NTFS Transacional.
ms.assetid: 29879a3f-14b4-462c-a001-46c3c3eb74d1
title: Como usar o NTFS Transacional
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 43681f0d5b27f0db03d8b6c44564b792fce4b467
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "105778604"
---
# <a name="how-to-use-transactional-ntfs"></a><span data-ttu-id="d5381-103">Como usar o NTFS Transacional</span><span class="sxs-lookup"><span data-stu-id="d5381-103">How to Use Transactional NTFS</span></span>

## <a name="transacted-file-handles"></a><span data-ttu-id="d5381-104">Identificadores de arquivo transacionado</span><span class="sxs-lookup"><span data-stu-id="d5381-104">Transacted File Handles</span></span>

<span data-ttu-id="d5381-105">O NTFS Transacional (TxF) associa um identificador de arquivo a uma transação.</span><span class="sxs-lookup"><span data-stu-id="d5381-105">Transactional NTFS (TxF) binds a file handle to a transaction.</span></span> <span data-ttu-id="d5381-106">Para operações que funcionam em um identificador (por exemplo, as funções [**ReadFile**](/windows/desktop/api/FileAPI/nf-fileapi-readfile) e [**WriteFile**](/windows/desktop/api/FileAPI/nf-fileapi-writefile) ), a chamada de função de API real não é alterada.</span><span class="sxs-lookup"><span data-stu-id="d5381-106">For operations that work on a handle (for example, the [**ReadFile**](/windows/desktop/api/FileAPI/nf-fileapi-readfile) and [**WriteFile**](/windows/desktop/api/FileAPI/nf-fileapi-writefile) functions), the actual API function call does not change.</span></span> <span data-ttu-id="d5381-107">Para operações de arquivo que recebem um nome, há funções transacionadas explícitas para essas operações.</span><span class="sxs-lookup"><span data-stu-id="d5381-107">For file operations that take a name, there are explicit transacted functions for these operations.</span></span> <span data-ttu-id="d5381-108">Por exemplo, em vez de chamar [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea), chame [**CreateFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span><span class="sxs-lookup"><span data-stu-id="d5381-108">For example, instead of calling [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea), call [**CreateFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span></span> <span data-ttu-id="d5381-109">Isso cria um identificador de arquivo transacionado, que pode ser usado para todas as operações de arquivo que exigem um identificador.</span><span class="sxs-lookup"><span data-stu-id="d5381-109">This creates a transacted file handle, which can then be used for all file operations requiring a handle.</span></span> <span data-ttu-id="d5381-110">Todas as operações subsequentes que usam esse identificador são operações transacionadas.</span><span class="sxs-lookup"><span data-stu-id="d5381-110">All subsequent operations using this handle are transacted operations.</span></span>

## <a name="basic-txf-usage"></a><span data-ttu-id="d5381-111">Uso básico do TxF</span><span class="sxs-lookup"><span data-stu-id="d5381-111">Basic TxF Usage</span></span>

<span data-ttu-id="d5381-112">A série de etapas a seguir representa o uso mais básico do TxF.</span><span class="sxs-lookup"><span data-stu-id="d5381-112">The following series of steps represents the most basic usage for TxF.</span></span> <span data-ttu-id="d5381-113">Cenários mais complexos também têm suporte, a critério do designer de aplicativos.</span><span class="sxs-lookup"><span data-stu-id="d5381-113">More complex scenarios are also supported, at the discretion of the application designer.</span></span>

1.  <span data-ttu-id="d5381-114">Crie uma transação chamando a função de KTM [**CreateTransaction**](/windows/desktop/api/ktmw32/nf-ktmw32-createtransaction) ou usando a interface **IKernelTransaction** do [Coordenador de transações distribuídas](/previous-versions/windows/desktop/mscs/distributed-transaction-coordinator) (DTC).</span><span class="sxs-lookup"><span data-stu-id="d5381-114">Create a transaction by calling the KTM function [**CreateTransaction**](/windows/desktop/api/ktmw32/nf-ktmw32-createtransaction) or by using the **IKernelTransaction** interface of the [Distributed Transaction Coordinator](/previous-versions/windows/desktop/mscs/distributed-transaction-coordinator) (DTC).</span></span>
2.  <span data-ttu-id="d5381-115">Obtenha identificadores de arquivo transacionados chamando [**CreateFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span><span class="sxs-lookup"><span data-stu-id="d5381-115">Get transacted file handle(s) by calling [**CreateFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span></span>
3.  <span data-ttu-id="d5381-116">Modifique os arquivos conforme necessário usando o (s) identificador (es) de arquivo transacionado.</span><span class="sxs-lookup"><span data-stu-id="d5381-116">Modify the file(s) as necessary using the transacted file handle(s).</span></span>
4.  <span data-ttu-id="d5381-117">Feche todos os identificadores de arquivo transacionados associados à transação criada na etapa 1.</span><span class="sxs-lookup"><span data-stu-id="d5381-117">Close all transacted file handles associated with the transaction created in step 1.</span></span>
5.  <span data-ttu-id="d5381-118">Confirme ou anule a transação chamando a função de KTM ou do DTC correspondente.</span><span class="sxs-lookup"><span data-stu-id="d5381-118">Commit or abort the transaction by calling the corresponding KTM or DTC function.</span></span>

## <a name="key-points-of-the-txf-programming-model"></a><span data-ttu-id="d5381-119">Pontos principais do modelo de programação TxF</span><span class="sxs-lookup"><span data-stu-id="d5381-119">Key Points of the TxF Programming Model</span></span>

<span data-ttu-id="d5381-120">O modelo de programação TxF tem os seguintes pontos principais a serem considerados ao desenvolver um aplicativo TxF:</span><span class="sxs-lookup"><span data-stu-id="d5381-120">The TxF programming model has the following key points for you to consider when you develop a TxF application:</span></span>

-   <span data-ttu-id="d5381-121">É altamente recomendável que um aplicativo feche todos os identificadores de arquivo transacionado antes de confirmar ou reverter uma transação.</span><span class="sxs-lookup"><span data-stu-id="d5381-121">It is highly recommended that an application close all transacted file handles before committing or rolling back a transaction.</span></span> <span data-ttu-id="d5381-122">O sistema invalida todos os identificadores transacionados quando uma transação termina.</span><span class="sxs-lookup"><span data-stu-id="d5381-122">The system invalidates all transacted handles when a transaction ends.</span></span> <span data-ttu-id="d5381-123">Qualquer operação, exceto fechar, executada em um identificador transacionado após o término da transação retorna o seguinte erro: o **identificador de erro \_ não é \_ \_ mais \_ válido**.</span><span class="sxs-lookup"><span data-stu-id="d5381-123">Any operation, except close, performed on a transacted handle after the transaction ends returns the following error: **ERROR\_HANDLE\_NO\_LONGER\_VALID**.</span></span>
-   <span data-ttu-id="d5381-124">Um arquivo é exibido como uma unidade de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="d5381-124">A file is viewed as a unit of storage.</span></span> <span data-ttu-id="d5381-125">Há suporte para atualizações parciais e substituições de arquivo completas.</span><span class="sxs-lookup"><span data-stu-id="d5381-125">Partial updates and complete file overwrites are supported.</span></span> <span data-ttu-id="d5381-126">Várias transações não podem modificar o mesmo arquivo simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="d5381-126">Multiple transactions cannot concurrently modify the same file.</span></span>
-   <span data-ttu-id="d5381-127">A e/s mapeada da memória é transparente e consistente com a e/s de arquivo regular.</span><span class="sxs-lookup"><span data-stu-id="d5381-127">Memory mapped I/O is transparent and consistent with the regular file I/O.</span></span> <span data-ttu-id="d5381-128">Um aplicativo deve liberar e fechar uma seção aberta antes de confirmar uma transação.</span><span class="sxs-lookup"><span data-stu-id="d5381-128">An application must flush and close an opened section before committing a transaction.</span></span> <span data-ttu-id="d5381-129">A falha em fazer isso pode resultar em alterações parciais no arquivo mapeado dentro da transação.</span><span class="sxs-lookup"><span data-stu-id="d5381-129">Failure to do this can result in partial changes to the mapped file within the transaction.</span></span> <span data-ttu-id="d5381-130">Uma reversão falhará se isso não for feito.</span><span class="sxs-lookup"><span data-stu-id="d5381-130">A rollback fails if this is not done.</span></span>

## <a name="common-programming-errors"></a><span data-ttu-id="d5381-131">Erros comuns de programação</span><span class="sxs-lookup"><span data-stu-id="d5381-131">Common Programming Errors</span></span>

<span data-ttu-id="d5381-132">Os seguintes erros comuns podem ocorrer ao desenvolver aplicativos transacionados:</span><span class="sxs-lookup"><span data-stu-id="d5381-132">The following common errors can occur when developing transacted applications:</span></span>

-   <span data-ttu-id="d5381-133">Usando um identificador de arquivo após a conclusão de uma transação.</span><span class="sxs-lookup"><span data-stu-id="d5381-133">Using a file handle after a transaction is completed.</span></span>
-   <span data-ttu-id="d5381-134">Falha ao fechar identificadores para arquivos e diretórios excluídos antes de confirmar uma transação, o que impedirá que as operações de exclusão ocorram.</span><span class="sxs-lookup"><span data-stu-id="d5381-134">Failing to close handles to deleted files and directories before committing a transaction, which will prevent the delete operations from occurring.</span></span> <span data-ttu-id="d5381-135">Esse evento deve ocorrer antes de executar a confirmação para que a operação de exclusão seja considerada parte da transação.</span><span class="sxs-lookup"><span data-stu-id="d5381-135">This event must occur before performing the commit for the delete operation to be considered part of the transaction.</span></span> <span data-ttu-id="d5381-136">Isso ocorre porque o sistema não exclui realmente um arquivo até que o último identificador para ele seja fechado, mesmo quando a operação não é transacionada, como parte do subsistema de e/s de arquivo do Windows.</span><span class="sxs-lookup"><span data-stu-id="d5381-136">This is because the system does not actually delete a file until the last handle to it is closed, even when the operation is not transacted, as part of the Windows file I/O subsystem.</span></span>
-   <span data-ttu-id="d5381-137">Falha ao considerar as reversões de transação iniciadas pelo sistema, o que pode acontecer a qualquer momento; por exemplo, uma transação será revertida se os recursos do sistema estiverem esgotados.</span><span class="sxs-lookup"><span data-stu-id="d5381-137">Failing to account for system-initiated transaction rollbacks, which may happen at any time; for example, a transaction is rolled back if the system resources are exhausted.</span></span>

 

 
