---
description: Descreve os bloqueios oportunistas de nível 1, nível 2, lote e filtro.
ms.assetid: 06136348-0c08-4e9c-9c96-fd3af33cbdc0
title: Tipos de bloqueios oportunistas
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a755a6ff766f5d19e13d4b269c1ba4bb9803e934
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103829675"
---
# <a name="types-of-opportunistic-locks"></a><span data-ttu-id="b372e-103">Tipos de bloqueios oportunistas</span><span class="sxs-lookup"><span data-stu-id="b372e-103">Types of Opportunistic Locks</span></span>

<span data-ttu-id="b372e-104">As operações de bloqueio oportunista funcionam com quatro tipos de bloqueios oportunistas: nível 1, nível 2, lote e filtro.</span><span class="sxs-lookup"><span data-stu-id="b372e-104">The opportunistic lock operations work with four types of opportunistic locks: level 1, level 2, batch, and filter.</span></span> <span data-ttu-id="b372e-105">*Bloqueios oportunistas exclusivos* são bloqueios de nível 1, lote e filtro.</span><span class="sxs-lookup"><span data-stu-id="b372e-105">*Exclusive opportunistic locks* are level 1, batch, and filter locks.</span></span> <span data-ttu-id="b372e-106">Se um thread tiver qualquer tipo de bloqueio exclusivo em um arquivo, ele também não poderá ter um bloqueio de nível 2 no mesmo arquivo.</span><span class="sxs-lookup"><span data-stu-id="b372e-106">If a thread has any type of exclusive lock on a file, it cannot also have a level 2 lock on the same file.</span></span>

## <a name="level-1-opportunistic-locks"></a><span data-ttu-id="b372e-107">Bloqueios oportunistas de nível 1</span><span class="sxs-lookup"><span data-stu-id="b372e-107">Level 1 Opportunistic Locks</span></span>

<span data-ttu-id="b372e-108">Um bloqueio oportunista de nível 1 em um arquivo permite que um cliente leia a frente no arquivo e armazene em cache o Read-Ahead e grave dados do arquivo localmente.</span><span class="sxs-lookup"><span data-stu-id="b372e-108">A level 1 opportunistic lock on a file allows a client to read ahead in the file and cache both read-ahead and write data from the file locally.</span></span> <span data-ttu-id="b372e-109">Desde que o cliente tenha acesso exclusivo a um arquivo, não há nenhum risco de coerência de dados ao fornecer um bloqueio oportunista de nível 1.</span><span class="sxs-lookup"><span data-stu-id="b372e-109">As long as the client has sole access to a file, there is no danger to data coherency in providing a level 1 opportunistic lock.</span></span>

<span data-ttu-id="b372e-110">O cliente pode solicitar um bloqueio oportunista de nível 1 depois de abrir um arquivo.</span><span class="sxs-lookup"><span data-stu-id="b372e-110">The client can request a level 1 opportunistic lock after opening a file.</span></span> <span data-ttu-id="b372e-111">Se nenhum outro cliente (ou nenhum outro thread no mesmo cliente) tiver o arquivo aberto, o servidor poderá conceder o bloqueio oportunista.</span><span class="sxs-lookup"><span data-stu-id="b372e-111">If no other client (or no other thread on the same client) has the file open, the server may grant the opportunistic lock.</span></span> <span data-ttu-id="b372e-112">Em seguida, o cliente pode armazenar em cache a leitura e gravação de dados do arquivo localmente.</span><span class="sxs-lookup"><span data-stu-id="b372e-112">The client can then cache read and write data from the file locally.</span></span> <span data-ttu-id="b372e-113">Se outro cliente tiver aberto o arquivo, o servidor recusará o bloqueio oportunista e o cliente não fará cache local.</span><span class="sxs-lookup"><span data-stu-id="b372e-113">If another client has opened the file, then the server refuses the opportunistic lock and the client does no local caching.</span></span> <span data-ttu-id="b372e-114">(O servidor pode recusar o bloqueio oportunista por outros motivos também, como não oferecer suporte a bloqueios oportunistas.)</span><span class="sxs-lookup"><span data-stu-id="b372e-114">(The server may refuse the opportunistic lock for other reasons as well, such as not supporting opportunistic locks.)</span></span>

<span data-ttu-id="b372e-115">Quando o servidor abre um arquivo que já tem um bloqueio oportunista de nível 1, o servidor examina o estado de compartilhamento do arquivo antes de interromper o bloqueio oportunista de nível 1.</span><span class="sxs-lookup"><span data-stu-id="b372e-115">When the server opens a file that already has a level 1 opportunistic lock on it, the server examines the sharing state of the file before it breaks the level 1 opportunistic lock.</span></span> <span data-ttu-id="b372e-116">Se o servidor interromper o bloqueio após esse exame, o tempo que o cliente com o bloqueio anterior passa a liberar seu cache de gravação é o tempo que o cliente solicita que o arquivo deve aguardar.</span><span class="sxs-lookup"><span data-stu-id="b372e-116">If the server breaks the lock after this examination, the time the client with the former lock spends flushing its write cache is time the client requesting the file must wait.</span></span> <span data-ttu-id="b372e-117">Esse período de despesas significa que os bloqueios oportunistas de nível 1 devem ser evitados em arquivos que muitos clientes abrem.</span><span class="sxs-lookup"><span data-stu-id="b372e-117">This time expenditure means that level 1 opportunistic locks should be avoided on files that many clients open.</span></span>

<span data-ttu-id="b372e-118">No entanto, como o servidor verifica o estado de compartilhamento antes de interromper o bloqueio, no caso em que o servidor negaria uma solicitação aberta devido a um conflito de compartilhamento, o servidor não interrompe o bloqueio.</span><span class="sxs-lookup"><span data-stu-id="b372e-118">However, because the server checks the sharing state before it breaks the lock, in the case where the server would deny an open request due to a sharing conflict the server does not break the lock.</span></span> <span data-ttu-id="b372e-119">Por exemplo, se você tiver aberto um arquivo, o compartilhamento negado para operações de gravação e obtido um bloqueio de nível 1, o servidor negará a solicitação de outro cliente para abrir o arquivo para gravação antes que ele examine o bloqueio no arquivo.</span><span class="sxs-lookup"><span data-stu-id="b372e-119">For example, if you have opened a file, denied sharing for write operations, and obtained a level 1 lock, the server denies another client's request to open the file for writing before it even examines your lock on the file.</span></span> <span data-ttu-id="b372e-120">Nessa instância, o bloqueio oportunista não é interrompido.</span><span class="sxs-lookup"><span data-stu-id="b372e-120">In this instance, your opportunistic lock is not broken.</span></span>

<span data-ttu-id="b372e-121">Para obter um exemplo de como um bloqueio oportunista de nível 1 funciona, consulte exemplo de bloqueio oportunista de nível 1.</span><span class="sxs-lookup"><span data-stu-id="b372e-121">For an example of how a level 1 opportunistic lock works, see Level 1 Opportunistic Lock Example.</span></span> <span data-ttu-id="b372e-122">Para saber mais sobre como interromper os bloqueios oportunistas, confira [bloqueios oportunistas](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="b372e-122">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="level-2-opportunistic-locks"></a><span data-ttu-id="b372e-123">Bloqueios oportunistas de nível 2</span><span class="sxs-lookup"><span data-stu-id="b372e-123">Level 2 Opportunistic Locks</span></span>

<span data-ttu-id="b372e-124">Um bloqueio oportunista de nível 2 informa um cliente de que há vários clientes simultâneos de um arquivo e que nenhum ainda o modificou.</span><span class="sxs-lookup"><span data-stu-id="b372e-124">A level 2 opportunistic lock informs a client that there are multiple concurrent clients of a file and that none has yet modified it.</span></span> <span data-ttu-id="b372e-125">Esse bloqueio permite que o cliente execute operações de leitura e obtenha atributos de arquivo usando informações locais em cache ou de leitura antecipada, mas o cliente deve enviar todas as outras solicitações (como para operações de gravação) para o servidor.</span><span class="sxs-lookup"><span data-stu-id="b372e-125">This lock allows the client to perform read operations and obtain file attributes using cached or read-ahead local information, but the client must send all other requests (such as for write operations) to the server.</span></span> <span data-ttu-id="b372e-126">Seu aplicativo deve usar o bloqueio oportunista de nível 2 quando você espera que outros aplicativos gravem no arquivo aleatoriamente ou leiam o arquivo aleatoriamente ou sequencialmente.</span><span class="sxs-lookup"><span data-stu-id="b372e-126">Your application should use the level 2 opportunistic lock when you expect other applications to write to the file at random or read the file at random or sequentially.</span></span>

<span data-ttu-id="b372e-127">Um bloqueio oportunista de nível 2 é muito semelhante a um bloqueio oportunista de filtro.</span><span class="sxs-lookup"><span data-stu-id="b372e-127">A level 2 opportunistic lock is very similar to a filter opportunistic lock.</span></span> <span data-ttu-id="b372e-128">Na maioria das situações, seu aplicativo deve usar o bloqueio oportunista de nível 2.</span><span class="sxs-lookup"><span data-stu-id="b372e-128">In most situations, your application should use the level 2 opportunistic lock.</span></span> <span data-ttu-id="b372e-129">Somente use o bloqueio de filtro se você não quiser que as operações abertas para leitura causem violações no modo de compartilhamento no período de tempo entre o aplicativo que está abrindo o arquivo e recebendo o bloqueio.</span><span class="sxs-lookup"><span data-stu-id="b372e-129">Only use the filter lock if you do not want open operations for reading to cause sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="b372e-130">Para obter mais informações, consulte filtrar bloqueios oportunistas e [resposta do servidor para abrir solicitações em arquivos bloqueados](server-response-to-open-requests-on-locked-files.md).</span><span class="sxs-lookup"><span data-stu-id="b372e-130">For more information, see Filter Opportunistic Locks and [Server Response to Open Requests on Locked Files](server-response-to-open-requests-on-locked-files.md).</span></span>

<span data-ttu-id="b372e-131">Para saber mais sobre como interromper os bloqueios oportunistas, confira [bloqueios oportunistas](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="b372e-131">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="batch-opportunistic-locks"></a><span data-ttu-id="b372e-132">Bloqueios oportunistas em lote</span><span class="sxs-lookup"><span data-stu-id="b372e-132">Batch Opportunistic Locks</span></span>

<span data-ttu-id="b372e-133">Um bloqueio oportunista em lote manipula aberturas e fechamentos de arquivos.</span><span class="sxs-lookup"><span data-stu-id="b372e-133">A batch opportunistic lock manipulates file openings and closings.</span></span> <span data-ttu-id="b372e-134">Por exemplo, na execução de um arquivo em lotes, o arquivo em lotes pode ser aberto e fechado uma vez para cada linha do arquivo.</span><span class="sxs-lookup"><span data-stu-id="b372e-134">For example, in the execution of a batch file, the batch file may be opened and closed once for each line of the file.</span></span> <span data-ttu-id="b372e-135">Um bloqueio oportunista em lote abre o arquivo em lotes no servidor e o mantém aberto.</span><span class="sxs-lookup"><span data-stu-id="b372e-135">A batch opportunistic lock opens the batch file on the server and keeps it open.</span></span> <span data-ttu-id="b372e-136">Como o processador de comando "abre" e "fecha" o arquivo em lotes, o redirecionador de rede intercepta os comandos abrir e fechar.</span><span class="sxs-lookup"><span data-stu-id="b372e-136">As the command processor "opens" and "closes" the batch file, the network redirector intercepts the open and close commands.</span></span> <span data-ttu-id="b372e-137">Todo o servidor recebe os comandos de busca e leitura.</span><span class="sxs-lookup"><span data-stu-id="b372e-137">All the server receives are the seek and read commands.</span></span> <span data-ttu-id="b372e-138">Se o cliente também estiver lendo com antecedência, o servidor receberá uma solicitação de leitura específica no máximo uma vez.</span><span class="sxs-lookup"><span data-stu-id="b372e-138">If the client is also reading ahead, the server receives a particular read request at most one time.</span></span>

<span data-ttu-id="b372e-139">Ao abrir um arquivo que já tem um bloqueio oportunista em lote, o servidor verifica o estado de compartilhamento do arquivo depois de interromper o bloqueio.</span><span class="sxs-lookup"><span data-stu-id="b372e-139">When opening a file that already has a batch opportunistic lock, the server checks the sharing state of the file after breaking the lock.</span></span> <span data-ttu-id="b372e-140">Essa verificação fornece ao proprietário do bloqueio a chance de concluir a liberação de seu cache e fechar o identificador de arquivo.</span><span class="sxs-lookup"><span data-stu-id="b372e-140">This check gives the holder of the lock a chance to complete flushing its cache and to close the file handle.</span></span> <span data-ttu-id="b372e-141">Uma operação aberta tentada durante a verificação de compartilhamento não faz com que a verificação de compartilhamento falhe se o proprietário do bloqueio liberar o bloqueio.</span><span class="sxs-lookup"><span data-stu-id="b372e-141">An open operation attempted during the sharing check does not cause the sharing check to fail if the lock holder releases the lock.</span></span>

<span data-ttu-id="b372e-142">Para obter um exemplo de como funciona um bloqueio oportunista em lotes, consulte exemplo de bloqueio oportunista em lote.</span><span class="sxs-lookup"><span data-stu-id="b372e-142">For an example of how a batch opportunistic lock works, see Batch Opportunistic Lock Example.</span></span> <span data-ttu-id="b372e-143">Para saber mais sobre como interromper os bloqueios oportunistas, confira [bloqueios oportunistas](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="b372e-143">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="filter-opportunistic-locks"></a><span data-ttu-id="b372e-144">Filtrar bloqueios oportunistas</span><span class="sxs-lookup"><span data-stu-id="b372e-144">Filter Opportunistic Locks</span></span>

<span data-ttu-id="b372e-145">Um bloqueio oportunista de filtro bloqueia um arquivo para que ele não possa ser aberto para o acesso de gravação ou exclusão.</span><span class="sxs-lookup"><span data-stu-id="b372e-145">A filter opportunistic lock locks a file so that it cannot be opened for either write or delete access.</span></span> <span data-ttu-id="b372e-146">Todos os clientes devem ser capazes de compartilhar o arquivo.</span><span class="sxs-lookup"><span data-stu-id="b372e-146">All clients must be able to share the file.</span></span> <span data-ttu-id="b372e-147">Os bloqueios de filtro permitem que os aplicativos executem operações de filtragem não intrusivas em dados de arquivo (por exemplo, um compilador abrindo código-fonte ou um programa de catalogação).</span><span class="sxs-lookup"><span data-stu-id="b372e-147">Filter locks allow applications to perform nonintrusive filtering operations on file data (for example, a compiler opening source code or a cataloging program).</span></span>

<span data-ttu-id="b372e-148">Um bloqueio oportunista de filtro difere de um bloqueio oportunista de nível 2, pois permite que operações abertas para leitura ocorram sem violações de modo de compartilhamento no período de tempo entre o aplicativo que está abrindo o arquivo e recebendo o bloqueio.</span><span class="sxs-lookup"><span data-stu-id="b372e-148">A filter opportunistic lock differs from a level 2 opportunistic lock in that it allows open operations for reading to occur without sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="b372e-149">O bloqueio oportunista de filtro é o melhor bloqueio a ser usado quando for importante permitir que outros clientes leiam o acesso.</span><span class="sxs-lookup"><span data-stu-id="b372e-149">The filter opportunistic lock is the best lock to use when it is important to allow other clients reading access.</span></span> <span data-ttu-id="b372e-150">Em outros casos, seu aplicativo deve usar um bloqueio oportunista de nível 2.</span><span class="sxs-lookup"><span data-stu-id="b372e-150">In other cases, your application should use a level 2 opportunistic lock.</span></span> <span data-ttu-id="b372e-151">Um bloqueio oportunista de filtro difere de um bloqueio oportunista em lote, pois ele não permite que várias aberturas e fechamentos sejam tratados pelo redirecionador de rede como faz um bloqueio oportunista em lote.</span><span class="sxs-lookup"><span data-stu-id="b372e-151">A filter opportunistic lock differs from a batch opportunistic lock in that it does not allow multiple openings and closings to be handled by the network redirector the way a batch opportunistic lock does.</span></span>

<span data-ttu-id="b372e-152">Seu aplicativo deve solicitar um bloqueio oportunista de filtro em um arquivo em três etapas:</span><span class="sxs-lookup"><span data-stu-id="b372e-152">Your application should request a filter opportunistic lock on a file in three steps:</span></span>

1.  <span data-ttu-id="b372e-153">Use a função [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) para abrir um identificador para o arquivo com o parâmetro *desiredAccess* definido como zero, indicando que não há acesso e o parâmetro *dwShareMode* definido como o sinalizador de **\_ \_ leitura de compartilhamento de arquivos** para permitir o compartilhamento para leitura.</span><span class="sxs-lookup"><span data-stu-id="b372e-153">Use the [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) function to open a handle to the file with the *DesiredAccess* parameter set to zero, indicating no access, and the *dwShareMode* parameter set to the **FILE\_SHARE\_READ** flag to allow sharing for reading.</span></span> <span data-ttu-id="b372e-154">O identificador obtido nesse ponto é chamado de identificador de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="b372e-154">The handle obtained at this point is called the locking handle.</span></span>
2.  <span data-ttu-id="b372e-155">Solicite um bloqueio nesse identificador com o código de controle [**\_ oplock do \_ filtro \_ de solicitação fsctl**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) .</span><span class="sxs-lookup"><span data-stu-id="b372e-155">Request a lock on this handle with the [**FSCTL\_REQUEST\_FILTER\_OPLOCK**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) control code.</span></span>
3.  <span data-ttu-id="b372e-156">Quando o bloqueio for concedido, use [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) para abrir o arquivo novamente com *desiredAccess* definido como o sinalizador de **\_ leitura genérico** .</span><span class="sxs-lookup"><span data-stu-id="b372e-156">When the lock is granted, use [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) to open the file again with *DesiredAccess* set to the **GENERIC\_READ** flag.</span></span> <span data-ttu-id="b372e-157">Defina *dwShareMode* como o sinalizador de **\_ \_ leitura de compartilhamento de arquivos** para permitir que outras pessoas leiam o arquivo enquanto você o tiver aberto, o sinalizador de **\_ \_ exclusão de compartilhamento de arquivos** para permitir que outras pessoas marquem o arquivo para exclusão enquanto você o tiver aberto, ou ambos.</span><span class="sxs-lookup"><span data-stu-id="b372e-157">Set *dwShareMode* to the **FILE\_SHARE\_READ** flag to allow others to read the file while you have it open, the **FILE\_SHARE\_DELETE** flag to allow others to mark the file for deletion while you have it open, or both.</span></span> <span data-ttu-id="b372e-158">O identificador obtido nesse ponto é chamado de identificador de leitura.</span><span class="sxs-lookup"><span data-stu-id="b372e-158">The handle obtained at this point is called the read handle.</span></span>

<span data-ttu-id="b372e-159">Use a alça de leitura para ler ou gravar o conteúdo do arquivo.</span><span class="sxs-lookup"><span data-stu-id="b372e-159">Use the read handle to read from or write to the contents of the file.</span></span>

<span data-ttu-id="b372e-160">Ao abrir um arquivo que já tem um filtro de bloqueio oportunista, o servidor interrompe o bloqueio e verifica o estado de compartilhamento do arquivo.</span><span class="sxs-lookup"><span data-stu-id="b372e-160">When opening a file that already has a filter opportunistic lock, the server breaks the lock and then checks the sharing state of the file.</span></span> <span data-ttu-id="b372e-161">Essa verificação fornece ao cliente que mantinha o bloqueio oportunista anterior a chance de abandonar todos os dados armazenados em cache e confirmar a interrupção.</span><span class="sxs-lookup"><span data-stu-id="b372e-161">This check gives the client that held the former opportunistic lock a chance to abandon any cached data and acknowledge the break.</span></span> <span data-ttu-id="b372e-162">Uma operação aberta tentada durante essa verificação de compartilhamento não faz com que a verificação de compartilhamento falhe se o antigo proprietário do bloqueio liberar o bloqueio.</span><span class="sxs-lookup"><span data-stu-id="b372e-162">An open operation attempted during this sharing check does not cause the sharing check to fail if the former lock holder releases the lock.</span></span> <span data-ttu-id="b372e-163">O sistema de arquivos mantém em abeyance a operação de abertura até que o proprietário do bloqueio feche a alça de leitura e, em seguida, a alça de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="b372e-163">The file system holds in abeyance the open operation until the lock's owner closes both the read handle and then the locking handle.</span></span> <span data-ttu-id="b372e-164">Depois que isso for feito, a solicitação aberta do outro cliente poderá continuar.</span><span class="sxs-lookup"><span data-stu-id="b372e-164">After this is done, the other client's open request can proceed.</span></span>

<span data-ttu-id="b372e-165">Para saber mais sobre como interromper os bloqueios oportunistas, confira [bloqueios oportunistas](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="b372e-165">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

 

 
