---
description: Exemplo de um intercâmbio de pacotes do protocolo SMB da Microsoft entre um cliente e um servidor.
ms.assetid: f831d0de-0e38-4141-811c-892a1b5c4037
title: Cenário de intercâmbio de pacotes do protocolo SMB da Microsoft
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e8a03e2f75b00aa93e629b3e698631c5efde4694
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104296287"
---
# <a name="microsoft-smb-protocol-packet-exchange-scenario"></a><span data-ttu-id="16c71-103">Cenário de intercâmbio de pacotes do protocolo SMB da Microsoft</span><span class="sxs-lookup"><span data-stu-id="16c71-103">Microsoft SMB Protocol Packet Exchange Scenario</span></span>

<span data-ttu-id="16c71-104">Este tópico fornece um exemplo de um intercâmbio de pacotes do protocolo SMB da Microsoft entre um cliente e um servidor.</span><span class="sxs-lookup"><span data-stu-id="16c71-104">This topic gives an example of a Microsoft SMB Protocol packet exchange between a client and a server.</span></span> <span data-ttu-id="16c71-105">As etapas a seguir são uma visão geral do processo:</span><span class="sxs-lookup"><span data-stu-id="16c71-105">The following steps are an overview of the process:</span></span>

1.  <span data-ttu-id="16c71-106">O cliente e o servidor estabelecem uma sessão NetBIOS.</span><span class="sxs-lookup"><span data-stu-id="16c71-106">The client and server establish a NetBIOS session.</span></span>
2.  <span data-ttu-id="16c71-107">O cliente e o servidor negociam o dialeto do protocolo SMB da Microsoft.</span><span class="sxs-lookup"><span data-stu-id="16c71-107">The client and server negotiate the Microsoft SMB Protocol dialect.</span></span>
3.  <span data-ttu-id="16c71-108">O cliente faz logon no servidor.</span><span class="sxs-lookup"><span data-stu-id="16c71-108">The client logs on to the server.</span></span>
4.  <span data-ttu-id="16c71-109">O cliente se conecta a um compartilhamento no servidor.</span><span class="sxs-lookup"><span data-stu-id="16c71-109">The client connects to a share on the server.</span></span>
5.  <span data-ttu-id="16c71-110">O cliente abre um arquivo no compartilhamento.</span><span class="sxs-lookup"><span data-stu-id="16c71-110">The client opens a file on the share.</span></span>
6.  <span data-ttu-id="16c71-111">O cliente lê a partir do arquivo.</span><span class="sxs-lookup"><span data-stu-id="16c71-111">The client reads from the file.</span></span>

<span data-ttu-id="16c71-112">Primeiro, uma conexão TCP Full duplex é estabelecida pelo cliente com o servidor.</span><span class="sxs-lookup"><span data-stu-id="16c71-112">First, a full-duplex TCP connection is established by the client with the server.</span></span> <span data-ttu-id="16c71-113">Em seguida, o cliente cria e envia um pacote de solicitação de sessão NetBIOS pela conexão TCP.</span><span class="sxs-lookup"><span data-stu-id="16c71-113">Then the client builds and sends a NetBIOS session request packet over the TCP connection.</span></span> <span data-ttu-id="16c71-114">Se o pacote foi formatado corretamente, o servidor retorna um pacote que contém uma mensagem confirmando que a sessão foi estabelecida.</span><span class="sxs-lookup"><span data-stu-id="16c71-114">If the packet was formatted correctly, the server then returns a packet that contains a message acknowledging that the session has been established.</span></span> <span data-ttu-id="16c71-115">Depois disso, o cliente envia os primeiros pacotes do protocolo SMB da Microsoft para o servidor.</span><span class="sxs-lookup"><span data-stu-id="16c71-115">After this, the client sends the first Microsoft SMB Protocol packets to the server.</span></span>



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="16c71-116">**Pacote 1: \_ negociação de com SMB \_**</span><span class="sxs-lookup"><span data-stu-id="16c71-116">**Packet 1:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="16c71-117">**Direção:** Cliente para servidor</span><span class="sxs-lookup"><span data-stu-id="16c71-117">**Direction:** Client to server</span></span><br/> <span data-ttu-id="16c71-118">**Descrição:** O cliente solicita que o servidor negocie o dialeto do protocolo SMB da Microsoft.</span><span class="sxs-lookup"><span data-stu-id="16c71-118">**Description:** The client requests that the server negotiate the Microsoft SMB Protocol dialect.</span></span> <span data-ttu-id="16c71-119">Uma lista de cadeias de caracteres que identificam os dialetos com os quais o cliente pode trabalhar está incluída no pacote.</span><span class="sxs-lookup"><span data-stu-id="16c71-119">A list of strings identifying the dialects that the client can work with is included in the packet.</span></span><br/>                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="16c71-120">**Pacote 2: \_ negociação de com SMB \_**</span><span class="sxs-lookup"><span data-stu-id="16c71-120">**Packet 2:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="16c71-121">**Direção:** Servidor para cliente</span><span class="sxs-lookup"><span data-stu-id="16c71-121">**Direction:** Server to client</span></span><br/> <span data-ttu-id="16c71-122">**Descrição:** O servidor responde à solicitação do cliente para identificar o dialeto do protocolo SMB da Microsoft que será usado na sessão.</span><span class="sxs-lookup"><span data-stu-id="16c71-122">**Description:** The server responds to the client's request to identify the Microsoft SMB Protocol dialect that is going to be used in the session.</span></span> <span data-ttu-id="16c71-123">O pacote retornado também inclui uma cadeia de caracteres aleatória de 8 bytes que será usada na próxima etapa para autenticar o cliente durante o processo de logon.</span><span class="sxs-lookup"><span data-stu-id="16c71-123">The returned packet also includes an 8-byte random string that will be used in the next step to authenticate the client during the logon process.</span></span><br/>                                                                                                                                                                                                                                   |
| <span data-ttu-id="16c71-124">**Pacote 3: \_ configuração da \_ sessão com SMB \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="16c71-124">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="16c71-125">**Direção:** Cliente para servidor</span><span class="sxs-lookup"><span data-stu-id="16c71-125">**Direction:** Client to server</span></span><br/> <span data-ttu-id="16c71-126">**Descrição:** Esse pacote inclui informações sobre os recursos do cliente, portanto, esse pacote deve ser enviado mesmo que o servidor tenha implementado apenas a segurança em nível de compartilhamento.</span><span class="sxs-lookup"><span data-stu-id="16c71-126">**Description:** This packet includes information about client capabilities, so this packet must be sent even if the server has implemented only share-level security.</span></span><br/> <span data-ttu-id="16c71-127">**Pacote 3: \_ configuração da \_ sessão com SMB \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="16c71-127">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="16c71-128">**Direção:** Servidor para cliente</span><span class="sxs-lookup"><span data-stu-id="16c71-128">**Direction:** Server to client</span></span><br/> <span data-ttu-id="16c71-129">**Descrição:** Se o desafio/resposta for aceito pelo servidor, um UID válido será incluído no pacote que é retornado ao cliente.</span><span class="sxs-lookup"><span data-stu-id="16c71-129">**Description:** If the challenge/response is accepted by the server, a valid UID is included in the packet that is returned to the client.</span></span> <span data-ttu-id="16c71-130">Se não for aceito, o servidor retornará um código de erro neste pacote e negará acesso.</span><span class="sxs-lookup"><span data-stu-id="16c71-130">If it is not accepted, the server will return an error code in this packet and deny access.</span></span><br/> |
| <span data-ttu-id="16c71-131">**Pacote 4: \_ ANDX de \_ conexão de árvore com \_ SMB \_**</span><span class="sxs-lookup"><span data-stu-id="16c71-131">**Packet 4:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="16c71-132">**Direção:** Cliente para servidor</span><span class="sxs-lookup"><span data-stu-id="16c71-132">**Direction:** Client to server</span></span><br/> <span data-ttu-id="16c71-133">**Descrição:** O cliente solicita acesso ao compartilhamento.</span><span class="sxs-lookup"><span data-stu-id="16c71-133">**Description:** The client requests access to the share.</span></span> <span data-ttu-id="16c71-134">O pacote contém o caminho totalmente especificado do compartilhamento no formato UNC.</span><span class="sxs-lookup"><span data-stu-id="16c71-134">The packet contains the fully specified path of the share in UNC format.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                             |
| <span data-ttu-id="16c71-135">**Pacote 5: \_ ANDX de \_ conexão de árvore com \_ SMB \_**</span><span class="sxs-lookup"><span data-stu-id="16c71-135">**Packet 5:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="16c71-136">**Direção:** Servidor para cliente</span><span class="sxs-lookup"><span data-stu-id="16c71-136">**Direction:** Server to client</span></span><br/> <span data-ttu-id="16c71-137">**Descrição:** Se o acesso ao compartilhamento for concedido, o servidor retornará a ID de árvore de 16 bits (TID) que corresponde ao compartilhamento nesse pacote.</span><span class="sxs-lookup"><span data-stu-id="16c71-137">**Description:** If access to the share is granted, then the server returns the 16-bit tree ID (TID) that corresponds to the share in this packet.</span></span> <span data-ttu-id="16c71-138">Se o compartilhamento não existir ou se o usuário não tiver credenciais suficientes para acessar o compartilhamento, o servidor retornará um código de erro nesse pacote e negará acesso ao compartilhamento.</span><span class="sxs-lookup"><span data-stu-id="16c71-138">If the share does not exist or the user has insufficient credentials to access the share, the server will return an error code in this packet and deny access to the share.</span></span><br/>                                                                                                                                                                                                 |
| <span data-ttu-id="16c71-139">**Pacote 6: \_ ANDX com \_ Open \_ SMB**</span><span class="sxs-lookup"><span data-stu-id="16c71-139">**Packet 6:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="16c71-140">**Direção:** Cliente para servidor</span><span class="sxs-lookup"><span data-stu-id="16c71-140">**Direction:** Client to server</span></span><br/> <span data-ttu-id="16c71-141">**Descrição:** O cliente solicita que o servidor Abra um arquivo no compartilhamento acessado em nome do cliente.</span><span class="sxs-lookup"><span data-stu-id="16c71-141">**Description:** The client requests the server to open a file on the accessed share on behalf of the client.</span></span> <span data-ttu-id="16c71-142">Esse pacote contém o nome do arquivo a ser aberto.</span><span class="sxs-lookup"><span data-stu-id="16c71-142">This packet contains the name of the file to be opened.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="16c71-143">**Pacote 7: SMB \_ com \_ Open \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="16c71-143">**Packet 7:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="16c71-144">**Direção:** Servidor para cliente</span><span class="sxs-lookup"><span data-stu-id="16c71-144">**Direction:** Server to client</span></span><br/> <span data-ttu-id="16c71-145">**Descrição:** Se o acesso ao arquivo for concedido, o servidor retornará a ID de arquivo do arquivo solicitado.</span><span class="sxs-lookup"><span data-stu-id="16c71-145">**Description:** If access to the file is granted, then the server returns the file ID of the requested file.</span></span> <span data-ttu-id="16c71-146">Se o arquivo não existir ou se o usuário não tiver credenciais suficientes para acessar o arquivo, o servidor retornará um código de erro nesse pacote e negará acesso ao arquivo.</span><span class="sxs-lookup"><span data-stu-id="16c71-146">If the file does not exist or the user has insufficient credentials to access the file, the server will return an error code in this packet and deny access to the file.</span></span><br/>                                                                                                                                                                                                                                                  |
| <span data-ttu-id="16c71-147">**Pacote 8: \_ ANDX de \_ leitura de com SMB \_**</span><span class="sxs-lookup"><span data-stu-id="16c71-147">**Packet 8:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="16c71-148">**Direção:** Cliente para servidor</span><span class="sxs-lookup"><span data-stu-id="16c71-148">**Direction:** Client to server</span></span><br/> <span data-ttu-id="16c71-149">**Descrição:** O cliente solicita que o servidor leia dados do arquivo aberto em nome do cliente e retorne esses dados para o cliente.</span><span class="sxs-lookup"><span data-stu-id="16c71-149">**Description:** The client requests the server to read data from the opened file on behalf of the client and return this data to the client.</span></span> <span data-ttu-id="16c71-150">A ID de arquivo obtida pelo cliente quando o arquivo foi aberto está incluída neste pacote para identificar em qual arquivo aberto o servidor deve ler dados.</span><span class="sxs-lookup"><span data-stu-id="16c71-150">The file ID that is obtained by the client when the file was opened is included in this packet in order to identify which opened file the server should read data from.</span></span><br/>                                                                                                                                                                                                                   |
| <span data-ttu-id="16c71-151">**Pacote 9: \_ ANDX de \_ leitura de com SMB \_**</span><span class="sxs-lookup"><span data-stu-id="16c71-151">**Packet 9:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="16c71-152">**Direção:** Servidor para cliente</span><span class="sxs-lookup"><span data-stu-id="16c71-152">**Direction:** Server to client</span></span><br/> <span data-ttu-id="16c71-153">**Descrição:** O servidor retorna os dados de arquivo solicitados neste pacote.</span><span class="sxs-lookup"><span data-stu-id="16c71-153">**Description:** The server returns the requested file data in this packet.</span></span> <span data-ttu-id="16c71-154">Um erro aqui é improvável, uma vez que o acesso ao servidor, ao compartilhamento e ao arquivo foi concedido.</span><span class="sxs-lookup"><span data-stu-id="16c71-154">An error here is unlikely given that access to the server, share, and file has been granted.</span></span> <span data-ttu-id="16c71-155">No entanto, isso pode acontecer em algumas situações: por exemplo, se o acesso a um compartilhamento for alterado entre a hora em que o arquivo é aberto e a hora em que ele é lido.</span><span class="sxs-lookup"><span data-stu-id="16c71-155">It can happen in some situations, however: for example, if access to a share is changed between the time the file is opened and the time it is read from.</span></span><br/>                                                                                                                                                                                                      |



 

> [!Note]  
> <span data-ttu-id="16c71-156">Se você implementar um CIFS que não ofereça suporte a notificações de alteração, o Windows não poderá manter um identificador pendente para o sistema de arquivos e a conexão SMB poderá desaparecer sem aviso prévio.</span><span class="sxs-lookup"><span data-stu-id="16c71-156">If you implement a CIFS that does not support change notifications, Windows cannot keep an outstanding handle to the file system, and the SMB connection can go away without notice.</span></span>

 

 

 




