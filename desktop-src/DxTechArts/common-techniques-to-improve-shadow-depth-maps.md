---
title: Técnicas comuns para aprimorar os mapas de profundidade de sombra
description: Este artigo técnico fornece uma visão geral de alguns algoritmos comuns de mapa de profundidade de sombra e artefatos comuns, além de explicar várias técnicas, que vão desde o básico até o intermediário — que pode ser usado para aumentar a qualidade dos mapas de sombra padrão.
ms.assetid: bf994838-a261-0379-9301-eb9b250d216c
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c8b25507d7f6b8608d4dacf5fab620bc8a3294c7
ms.sourcegitcommit: 218b1ff779402c3ebe1786679e1aa80a5c0d6c95
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/01/2020
ms.locfileid: "103641952"
---
# <a name="common-techniques-to-improve-shadow-depth-maps"></a><span data-ttu-id="51884-103">Técnicas comuns para aprimorar os mapas de profundidade de sombra</span><span class="sxs-lookup"><span data-stu-id="51884-103">Common Techniques to Improve Shadow Depth Maps</span></span>

<span data-ttu-id="51884-104">Os mapas de sombra, apresentados pela primeira vez em 1978, são uma técnica comum para adicionar sombras a jogos.</span><span class="sxs-lookup"><span data-stu-id="51884-104">Shadow maps, first introduced in 1978, are a common technique for adding shadows to games.</span></span> <span data-ttu-id="51884-105">Três décadas mais tarde, apesar de avanços em hardware e software, artefatos de sombreamento – ou seja, bordas shimmerings, alias de perspectiva e outros problemas de precisão — persistem.</span><span class="sxs-lookup"><span data-stu-id="51884-105">Three decades later, despite advances in hardware and software, shadowing artifacts—namely shimmering edges, perspective aliasing, and other precision issues—persist.</span></span>

<span data-ttu-id="51884-106">Este artigo técnico fornece uma visão geral de alguns algoritmos comuns de mapa de profundidade de sombra e artefatos comuns, além de explicar várias técnicas, que vão desde o básico até o intermediário — que pode ser usado para aumentar a qualidade dos mapas de sombra padrão.</span><span class="sxs-lookup"><span data-stu-id="51884-106">This technical article provides an overview of some common shadow depth map algorithms and common artifacts, and explains several techniques—ranging in difficulty from basic to intermediate—that can be used to increase the quality of standard shadow maps.</span></span> <span data-ttu-id="51884-107">A adição de mapas de sombra básicos a um título normalmente é simples, mas entender as nuances de artefatos de sombra pode ser desafiador.</span><span class="sxs-lookup"><span data-stu-id="51884-107">Adding basic shadow maps to a title typically is straightforward, but understanding the nuances of shadow artifacts can be challenging.</span></span> <span data-ttu-id="51884-108">Este artigo técnico foi escrito para o desenvolvedor de gráficos intermediário que implementou sombras, mas não entende totalmente por que os artefatos específicos aparecem e não tem certeza de como contorná-los.</span><span class="sxs-lookup"><span data-stu-id="51884-108">This technical article is written for the intermediate graphics developer who has implemented shadows, but does not fully understand why specific artifacts appear and is not sure how to work around them.</span></span>

<span data-ttu-id="51884-109">Selecionar as técnicas corretas para mitigar artefatos específicos não é trivial.</span><span class="sxs-lookup"><span data-stu-id="51884-109">Selecting the correct techniques to mitigate specific artifacts is nontrivial.</span></span> <span data-ttu-id="51884-110">Quando as deficiências do mapa de sombra são resolvidas, a diferença na qualidade pode ser impressionante (Figura 1).</span><span class="sxs-lookup"><span data-stu-id="51884-110">When shadow map shortcomings are addressed, the difference in quality can be impressive (Figure 1).</span></span> <span data-ttu-id="51884-111">A implementação correta dessas técnicas melhora drasticamente as sombras padrão.</span><span class="sxs-lookup"><span data-stu-id="51884-111">Correctly implementing these techniques drastically improves standard shadows.</span></span> <span data-ttu-id="51884-112">As técnicas explicadas neste artigo são implementadas no exemplo CascadedShadowMaps11 no SDK do DirectX.</span><span class="sxs-lookup"><span data-stu-id="51884-112">The techniques explained in this article are implemented in the sample CascadedShadowMaps11 in the DirectX SDK.</span></span>

<span data-ttu-id="51884-113">**Figura 1. Sombras com artefatos graves (à esquerda) e sombras após a implementação das técnicas descritas neste artigo (à direita)**</span><span class="sxs-lookup"><span data-stu-id="51884-113">**Figure 1. Shadows with severe artifacts (left), and shadows after implementing the techniques described in this article (right)**</span></span>

![sombras com artefatos graves (à esquerda) e sombras após a implementação das técnicas descritas neste artigo (à direita)](images/shadows-before-and-after.jpg)

## <a name="shadow-depth-maps-review"></a><span data-ttu-id="51884-115">Análise de mapas de profundidade de sombra</span><span class="sxs-lookup"><span data-stu-id="51884-115">Shadow Depth Maps Review</span></span>

<span data-ttu-id="51884-116">O algoritmo de mapa de profundidade de sombra é um algoritmo de duas passagens.</span><span class="sxs-lookup"><span data-stu-id="51884-116">The shadow depth map algorithm is a two-pass algorithm.</span></span> <span data-ttu-id="51884-117">A primeira passagem gera um mapa de profundidade em espaço leve.</span><span class="sxs-lookup"><span data-stu-id="51884-117">The first pass generates a depth map in light space.</span></span> <span data-ttu-id="51884-118">Na segunda passagem, esse mapa é usado para comparar a profundidade de cada pixel em espaço leve em relação à sua profundidade correspondente no mapa de profundidade de espaço claro.</span><span class="sxs-lookup"><span data-stu-id="51884-118">In the second pass, this map is used to compare each pixel's depth in light space against its corresponding depth in the light space depth map.</span></span>

<span data-ttu-id="51884-119">**Figura 2. Partes-chave de uma cena de sombra**</span><span class="sxs-lookup"><span data-stu-id="51884-119">**Figure 2. Key parts of a shadow scene**</span></span>

![partes-chave de uma cena de sombra](images/key-parts-of-shadow-scene.jpg)

### <a name="pass-1"></a><span data-ttu-id="51884-121">Pass 1</span><span class="sxs-lookup"><span data-stu-id="51884-121">Pass 1</span></span>

<span data-ttu-id="51884-122">A cena é mostrada na Figura 2.</span><span class="sxs-lookup"><span data-stu-id="51884-122">The scene is shown in Figure 2.</span></span> <span data-ttu-id="51884-123">Na primeira passagem (Figura 3), a geometria é renderizada em um buffer de profundidade do ponto de vista da luz.</span><span class="sxs-lookup"><span data-stu-id="51884-123">In the first pass (Figure 3), the geometry is rendered into a depth buffer from the point of view of the light.</span></span> <span data-ttu-id="51884-124">Mais especificamente, o sombreador de vértice transforma a geometria em um espaço de exibição clara.</span><span class="sxs-lookup"><span data-stu-id="51884-124">More specifically, the vertex shader transforms the geometry into light-view space.</span></span>

<span data-ttu-id="51884-125">O resultado final dessa primeira passagem é um buffer de profundidade que contém as informações de profundidade da cena do ponto de vista da luz.</span><span class="sxs-lookup"><span data-stu-id="51884-125">The end result of this first pass is a depth buffer containing the scene's depth information from the point of view of the light.</span></span> <span data-ttu-id="51884-126">Isso agora pode ser usado em Pass 2 para determinar quais pixels são obstruídodos da luz.</span><span class="sxs-lookup"><span data-stu-id="51884-126">This now can be used in pass 2 to determine which pixels are occluded from the light.</span></span>

<span data-ttu-id="51884-127">**Figura 3. Primeira passagem de mapeamento de sombra básica**</span><span class="sxs-lookup"><span data-stu-id="51884-127">**Figure 3. First pass of basic shadow mapping**</span></span>

![primeira passagem de mapeamento de sombra básica](images/first-pass-of-basic-hadow-mapping.png)

### <a name="pass-2"></a><span data-ttu-id="51884-129">Pass 2</span><span class="sxs-lookup"><span data-stu-id="51884-129">Pass 2</span></span>

<span data-ttu-id="51884-130">Na segunda passagem (Figura 4), o sombreador de vértice transforma cada vértice duas vezes.</span><span class="sxs-lookup"><span data-stu-id="51884-130">In the second pass (Figure 4), the vertex shader transforms each vertex twice.</span></span> <span data-ttu-id="51884-131">Cada vértice é transformado no espaço de exibição da câmera e passado para o sombreador de pixel como a posição.</span><span class="sxs-lookup"><span data-stu-id="51884-131">Each vertex is transformed into the camera's view space and passed to the pixel shader as the position.</span></span> <span data-ttu-id="51884-132">Cada vértice também é transformado pela matriz da luz de exibição-projeção-Texture e passada para o sombreador de pixel como uma coordenada de textura.</span><span class="sxs-lookup"><span data-stu-id="51884-132">Each vertex is also transformed by the light's view-projection-texture matrix and passed to the pixel shader as a texture coordinate.</span></span> <span data-ttu-id="51884-133">A matriz View-projetion-Texture é a mesma matriz usada para renderizar a cena na Pass 1 com uma transformação adicional.</span><span class="sxs-lookup"><span data-stu-id="51884-133">The view-projection-texture matrix is the same matrix used to render the scene in pass 1 with one additional transform.</span></span> <span data-ttu-id="51884-134">É uma transformação que dimensiona e traduz os pontos do espaço de exibição (– 1 a 1 em X e Y) para o espaço de textura (0 a 1 em X e 1 para 0 em Y).</span><span class="sxs-lookup"><span data-stu-id="51884-134">It's a transformation that scales and translates the points from view space (–1 to 1 in X and Y) to texture space (0 to 1 in X and 1 to 0 in Y).</span></span>

<span data-ttu-id="51884-135">O sombreador de pixel recebe a posição interpolada e as coordenadas de textura interpoladas.</span><span class="sxs-lookup"><span data-stu-id="51884-135">The pixel shader receives the interpolated position and the interpolated texture coordinates.</span></span> <span data-ttu-id="51884-136">Tudo o que é necessário para executar o teste de profundidade agora está nessa coordenada de textura.</span><span class="sxs-lookup"><span data-stu-id="51884-136">Everything needed to perform the depth test is now in this texture coordinate.</span></span> <span data-ttu-id="51884-137">O teste de profundidade agora pode ser executado com a indexação do buffer de profundidade da primeira passagem com as coordenadas X e Y Texture e a comparação do valor de profundidade resultante em relação à coordenada de textura Z.</span><span class="sxs-lookup"><span data-stu-id="51884-137">The depth test can now be performed by indexing the depth buffer from the first pass with the X and Y texture coordinates and comparing the resulting depth value against the Z-texture coordinate.</span></span>

<span data-ttu-id="51884-138">**Figura 4. Segunda passagem de mapeamento de sombra básica**</span><span class="sxs-lookup"><span data-stu-id="51884-138">**Figure 4. Second pass of basic shadow mapping**</span></span>

![segunda passagem de mapeamento de sombra básica](images/second-pass-of-basic-shadow-mapping.png)

## <a name="shadow-map-artifacts"></a><span data-ttu-id="51884-140">Artefatos de mapa de sombra</span><span class="sxs-lookup"><span data-stu-id="51884-140">Shadow Map Artifacts</span></span>

<span data-ttu-id="51884-141">O algoritmo de mapa de profundidade de sombra é o algoritmo de sombreamento em tempo real mais amplamente usado, mas ainda produz vários artefatos que exigem mitigação.</span><span class="sxs-lookup"><span data-stu-id="51884-141">The shadow depth map algorithm is the most widely used real-time shadowing algorithm, but still produces several artifacts requiring mitigation.</span></span> <span data-ttu-id="51884-142">Os tipos de artefatos que podem ocorrer são resumidos a seguir.</span><span class="sxs-lookup"><span data-stu-id="51884-142">The types of artifacts that can occur are summarized next.</span></span>

### <a name="perspective-aliasing"></a><span data-ttu-id="51884-143">Alias de perspectiva</span><span class="sxs-lookup"><span data-stu-id="51884-143">Perspective Aliasing</span></span>

<span data-ttu-id="51884-144">O alias de perspectiva, um artefato comum, é mostrado na Figura 5.</span><span class="sxs-lookup"><span data-stu-id="51884-144">Perspective aliasing, a common artifact, is shown in Figure 5.</span></span> <span data-ttu-id="51884-145">Isso ocorre quando o mapeamento de pixels em espaço de exibição para texels no mapa de sombra não é uma taxa de um para um.</span><span class="sxs-lookup"><span data-stu-id="51884-145">It occurs when the mapping of pixels in view space to texels in the shadow map is not a one-to-one ratio.</span></span> <span data-ttu-id="51884-146">Isso ocorre porque os pixels próximos ao plano próximo estão mais juntos e exigem uma resolução de mapa de sombra mais alta.</span><span class="sxs-lookup"><span data-stu-id="51884-146">This is because pixels close to the near plane are closer together and require a higher shadow map resolution.</span></span>

<span data-ttu-id="51884-147">A Figura 6 mostra um mapa de sombra e um frustum de exibição.</span><span class="sxs-lookup"><span data-stu-id="51884-147">Figure 6 shows a shadow map and a view frustum.</span></span> <span data-ttu-id="51884-148">Perto do olho, os pixels estão mais próximos, e muitos pixels são mapeados para o mesmo texels de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-148">Near the eye, the pixels are closer together, and many pixels map to the same shadow texels.</span></span> <span data-ttu-id="51884-149">Os pixels pelo plano distante são distribuídos, reduzindo assim o alias de perspectiva.</span><span class="sxs-lookup"><span data-stu-id="51884-149">The pixels by the far plane are spread out, thereby reducing perspective aliasing.</span></span>

<span data-ttu-id="51884-150">**Figura 5. Alias de alta perspectiva (à esquerda) versus alias de perspectiva baixa (direita)**</span><span class="sxs-lookup"><span data-stu-id="51884-150">**Figure 5. High-perspective aliasing (left) vs. low-perspective aliasing (right)**</span></span>

![alias de alta perspectiva (à esquerda) versus alias de perspectiva baixa (direita)](images/high-perspective-aliasing-vs-low-perspective-aliasing.jpg)

<span data-ttu-id="51884-152">Para a imagem à esquerda, o alias de perspectiva é maior; muitos pixels de espaço de olho são mapeados para o mesmo texels de mapa de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-152">For the image at left, perspective aliasing is higher; too many eye-space pixels map to the same shadow-map texels.</span></span> <span data-ttu-id="51884-153">Na imagem à direita, o alias de perspectiva é baixo porque há um mapeamento 1:1 entre os pixels de espaço de olho e texels de mapa de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-153">In the image at right, perspective aliasing is low because there is a 1:1 mapping between the eye-space pixels and shadow-map texels.</span></span>

<span data-ttu-id="51884-154">**Figura 6. Exibir frustum com o mapa de sombra**</span><span class="sxs-lookup"><span data-stu-id="51884-154">**Figure 6. View frustum with shadow map**</span></span>

![Exibir frustum com o mapa de sombra](images/view-frustum-with-shadow-map.jpg)

<span data-ttu-id="51884-156">Os pixels claros no plano distante representam o alias de baixa perspectiva e os pixels escuros no plano próximo representam o alias de alta perspectiva.</span><span class="sxs-lookup"><span data-stu-id="51884-156">Light pixels in the far plane represent low-perspective aliasing, and dark pixels in the near plane represent high-perspective aliasing.</span></span>

<span data-ttu-id="51884-157">A resolução do mapa de sombra também pode ser muito alta.</span><span class="sxs-lookup"><span data-stu-id="51884-157">Shadow map resolution can also be too high.</span></span> <span data-ttu-id="51884-158">Embora uma resolução mais alta seja menos perceptível, isso pode resultar em objetos pequenos, como fios de telefone, sem a transmissão de sombras.</span><span class="sxs-lookup"><span data-stu-id="51884-158">Although a higher resolution is less noticeable, it nevertheless can result in small objects, such as telephone wires, not casting shadows.</span></span> <span data-ttu-id="51884-159">Além disso, ter uma resolução muito alta pode causar sérios problemas de desempenho devido a padrões de acesso de textura.</span><span class="sxs-lookup"><span data-stu-id="51884-159">Also, having too high of a resolution can cause severe performance issues because of texture access patterns.</span></span>

<span data-ttu-id="51884-160">Os mapas de sombra em perspectiva (PSMs) e os mapas de sombra de perspectiva (LSPSMs) tentam resolver o alias da perspectiva distorcendo a matriz de projeção da luz para posicionar mais texels perto do olho onde são necessárias.</span><span class="sxs-lookup"><span data-stu-id="51884-160">Perspective shadow maps (PSMs) and light space perspective shadow maps (LSPSMs) attempt to address perspective aliasing by skewing the light's projection matrix in order to place more texels near the eye where they are needed.</span></span> <span data-ttu-id="51884-161">Infelizmente, nenhuma técnica é capaz de resolver o alias de perspectiva.</span><span class="sxs-lookup"><span data-stu-id="51884-161">Unfortunately, neither technique is able to solve the perspective aliasing.</span></span> <span data-ttu-id="51884-162">A parametrização da transformação necessária para mapear pixels de espaço de olho para texels no mapa de sombra não pode ser associada por uma distorção linear.</span><span class="sxs-lookup"><span data-stu-id="51884-162">The parameterization of the transform required to map eye-space pixels to texels in the shadow map cannot be bound by a linear skew.</span></span> <span data-ttu-id="51884-163">Uma parametrização logarítmica é necessária.</span><span class="sxs-lookup"><span data-stu-id="51884-163">A logarithmic parameterization is required.</span></span> <span data-ttu-id="51884-164">PSMs Coloque muitos detalhes perto do olho, fazendo com que as sombras distantes sejam de baixa qualidade ou até mesmo desaparecerem.</span><span class="sxs-lookup"><span data-stu-id="51884-164">PSMs put too much detail near the eye, causing distant shadows to be of low quality or to even disappear.</span></span> <span data-ttu-id="51884-165">O LSPSMs realiza um trabalho melhor de encontrar um aterramento médio entre a resolução crescente perto do olho e deixar detalhes suficientes para objetos distantes.</span><span class="sxs-lookup"><span data-stu-id="51884-165">LSPSMs do a better job of finding a middle ground between increasing resolution near the eye, and leaving enough detail for objects far away.</span></span> <span data-ttu-id="51884-166">Ambas as técnicas são geradas para sombras ortográficas em algumas configurações de cena.</span><span class="sxs-lookup"><span data-stu-id="51884-166">Both techniques degenerate to orthographic shadows in some scene configurations.</span></span> <span data-ttu-id="51884-167">Essa degeração pode ser feita com o processamento de um mapa de sombra separado para cada face da exibição frustum, embora isso seja caro.</span><span class="sxs-lookup"><span data-stu-id="51884-167">This degeneration can be counteracted by rendering a separate shadow map for each face of the view frustum, although this is expensive.</span></span> <span data-ttu-id="51884-168">Os mapas de sombra de perspectiva logarítmica (LogPSMs) também renderizam um mapa separado por face da exibição frustum.</span><span class="sxs-lookup"><span data-stu-id="51884-168">Logarithmic perspective shadow maps (LogPSMs) also render a separate map per face of the view frustum.</span></span> <span data-ttu-id="51884-169">Essa técnica usa a rasterização não linear para posicionar mais texels perto do olho.</span><span class="sxs-lookup"><span data-stu-id="51884-169">This technique uses nonlinear rasterization to place more texels near the eye.</span></span> <span data-ttu-id="51884-170">O D3D10 e o hardware de classe D3D11 não dão suporte à rasterização não linear.</span><span class="sxs-lookup"><span data-stu-id="51884-170">D3D10 and D3D11-class hardware do not support nonlinear rasterization.</span></span> <span data-ttu-id="51884-171">Para obter mais informações sobre essas técnicas e algoritmos, consulte a seção References.</span><span class="sxs-lookup"><span data-stu-id="51884-171">For more information about these techniques and algorithms, see the References section.</span></span>

<span data-ttu-id="51884-172">Os mapas de sombra em cascata (CSMs) são a técnica mais popular para lidar com o alias de perspectiva.</span><span class="sxs-lookup"><span data-stu-id="51884-172">Cascaded shadow maps (CSMs) are the most popular technique for dealing with perspective aliasing.</span></span> <span data-ttu-id="51884-173">Embora CSMs possa ser combinado com PSMs e LSPSMs, ele é desnecessário.</span><span class="sxs-lookup"><span data-stu-id="51884-173">Although CSMs can be combined with PSMs and LSPSMs, it's unnecessary.</span></span> <span data-ttu-id="51884-174">O uso de CSMs para corrigir erros de alias de perspectiva é abordado no artigo complementar, [mapas de sombra em cascata](/windows/desktop/DxTechArts/cascaded-shadow-maps).</span><span class="sxs-lookup"><span data-stu-id="51884-174">Using CSMs to fix perspective aliasing errors is addressed in the companion article, [Cascaded Shadow Maps](/windows/desktop/DxTechArts/cascaded-shadow-maps).</span></span>

### <a name="projective-aliasing"></a><span data-ttu-id="51884-175">Alias projetado</span><span class="sxs-lookup"><span data-stu-id="51884-175">Projective Aliasing</span></span>

<span data-ttu-id="51884-176">O alias projetado é mais difícil de mostrar que o alias de perspectiva.</span><span class="sxs-lookup"><span data-stu-id="51884-176">Projective aliasing is harder to show than perspective aliasing.</span></span> <span data-ttu-id="51884-177">As sombras disputadas destacadas na Figura 7 demonstram erros de alias projetados.</span><span class="sxs-lookup"><span data-stu-id="51884-177">The distended shadows highlighted in Figure 7 demonstrate projective aliasing errors.</span></span> <span data-ttu-id="51884-178">O alias projetado ocorre quando o mapeamento entre texels no espaço da câmera para texels em espaço leve não é uma proporção de um para um; Isso ocorre devido à orientação da geometria em relação à câmera clara.</span><span class="sxs-lookup"><span data-stu-id="51884-178">Projective aliasing occurs when the mapping between texels in camera space to texels in light space is not a one-to-one ratio; this is because of the orientation of the geometry with respect to the light camera.</span></span> <span data-ttu-id="51884-179">O alias projetado ocorre conforme o plano tangente da geometria se torna paralelo aos raios claros.</span><span class="sxs-lookup"><span data-stu-id="51884-179">Projective aliasing occurs as the tangent plane of the geometry becomes parallel to the light rays.</span></span>

<span data-ttu-id="51884-180">**Figura 7. Alias de alta projeção versus alias de baixa projeção**</span><span class="sxs-lookup"><span data-stu-id="51884-180">**Figure 7. High-projective aliasing vs. low-projective aliasing**</span></span>

![alias de alta projeção versus alias de baixa projeção](images/high-projective-aliasing-vs-low%20projective-aliasing.jpg)

<span data-ttu-id="51884-182">As técnicas usadas para aliviar erros de alias de perspectiva também atenuam o alias projetado.</span><span class="sxs-lookup"><span data-stu-id="51884-182">Techniques used to alleviate perspective aliasing errors also mitigate projective aliasing.</span></span> <span data-ttu-id="51884-183">O alias projetado ocorre quando a superfície normal é ortogonal à luz; essas superfícies devem receber menos luz com base nas equações de iluminação difusa.</span><span class="sxs-lookup"><span data-stu-id="51884-183">Projective aliasing occurs when the surface normal is orthogonal to the light; these surfaces should be receiving less light based on diffuse lighting equations.</span></span>

### <a name="shadow-acne-and-erroneous-self-shadowing"></a><span data-ttu-id="51884-184">Acne de sombra e incorreta Self-Shadowing</span><span class="sxs-lookup"><span data-stu-id="51884-184">Shadow Acne and Erroneous Self-Shadowing</span></span>

<span data-ttu-id="51884-185">Sombra acne (Figura 8), um termo sinônimo de autosombreamento errôneo, ocorre quando o mapa de sombra quantizes a profundidade sobre um Texel inteiro.</span><span class="sxs-lookup"><span data-stu-id="51884-185">Shadow acne (Figure 8), a term synonymous with erroneous self-shadowing, occurs when the shadow map quantizes the depth over an entire texel.</span></span> <span data-ttu-id="51884-186">Quando o sombreador compara uma profundidade real com relação a esse valor, é provável que seja autosombreado, uma vez que ele deve ser sombreado.</span><span class="sxs-lookup"><span data-stu-id="51884-186">When the shader compares an actual depth against this value, it is as likely to be self-shadowed as it is to be unshadowed.</span></span>

<span data-ttu-id="51884-187">Outro motivo para o Shadow acne é que o Texel em espaço leve está tão próximo da profundidade do Texel correspondente no mapa de profundidade que os erros de precisão fazem com que o teste de profundidade falhe erroneamente.</span><span class="sxs-lookup"><span data-stu-id="51884-187">Another reason for shadow acne is that the texel in light space is so close to the depth of the corresponding texel in the depth map that precision errors cause the depth test to erroneously fail.</span></span> <span data-ttu-id="51884-188">Um motivo para essa diferença de precisão é que o mapa de profundidade foi calculado pelo hardware de rasterização de função fixa, enquanto a profundidade sendo comparada foi calculada pelo sombreador.</span><span class="sxs-lookup"><span data-stu-id="51884-188">One reason for this precision difference is that the depth map was calculated by the fixed-function rasterization hardware, while the depth being compared was computed by the shader.</span></span> <span data-ttu-id="51884-189">O alias projetado também pode causar acne de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-189">Projective aliasing can also cause shadow acne.</span></span>

<span data-ttu-id="51884-190">**Figura 8. Artefato acne sombra**</span><span class="sxs-lookup"><span data-stu-id="51884-190">**Figure 8. Shadow acne artifact**</span></span>

![artefato acne sombra](images/shadow-acne-artifact.jpg)

<span data-ttu-id="51884-192">Conforme mostrado na imagem à esquerda, alguns de pixels falharam no teste de profundidade e criamos artefatos manchados e padrões moiré.</span><span class="sxs-lookup"><span data-stu-id="51884-192">As shown in the left image, some of pixels failed the depth test and created speckled artifacts and moiré patterns.</span></span> <span data-ttu-id="51884-193">Para reduzir a auto-sombreamento errado, os limites no plano próximo e o plano distante para a exibição de espaço frustum devem ser calculados da maneira mais rígida possível.</span><span class="sxs-lookup"><span data-stu-id="51884-193">In order to reduce erroneous self-shadowing, the bounds on the near plane and the far plane for the light space view frustum should be calculated as tightly as possible.</span></span> <span data-ttu-id="51884-194">A tendência de profundidade baseada em escala de inclinação e outros tipos de tendência são outras soluções usadas para mitigar o acne de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-194">The slope scale-based depth bias and other types of bias are other solutions used to mitigate shadow acne.</span></span>

### <a name="peter-panning"></a><span data-ttu-id="51884-195">Peter panorâmica</span><span class="sxs-lookup"><span data-stu-id="51884-195">Peter Panning</span></span>

<span data-ttu-id="51884-196">O termo *Peter panorâmica* deriva seu nome do caractere de livro de um filho cuja sombra se tornou desanexada e que poderia voar.</span><span class="sxs-lookup"><span data-stu-id="51884-196">The term *Peter Panning* derives its name from a children's book character whose shadow became detached and who could fly.</span></span> <span data-ttu-id="51884-197">Esse artefato faz com que os objetos com sombras ausentes pareçam ser desanexados e flutuantes acima da superfície (Figura 9).</span><span class="sxs-lookup"><span data-stu-id="51884-197">This artifact makes objects with missing shadows appear to be detached from and to float above the surface (Figure 9).</span></span>

<span data-ttu-id="51884-198">**Figura 9. Artefato do Peter panorâmica**</span><span class="sxs-lookup"><span data-stu-id="51884-198">**Figure 9. Peter Panning artifact**</span></span>

![artefato do Peter panorâmica](images/peter-panning-artifact.jpg)

<span data-ttu-id="51884-200">Na imagem à esquerda, a sombra é desanexada do objeto, criando um efeito flutuante.</span><span class="sxs-lookup"><span data-stu-id="51884-200">In the image at left, the shadow is detached from the object, creating a floating effect.</span></span>

<span data-ttu-id="51884-201">Uma técnica para remover a superfície acne é adicionar algum valor à posição de pixel em espaço leve; Isso é chamado de adição de um deslocamento de profundidade.</span><span class="sxs-lookup"><span data-stu-id="51884-201">One technique for removing surface acne is to add some value to pixel position in light space; this is called adding a depth offset.</span></span> <span data-ttu-id="51884-202">Peter panorâmica resultados quando o deslocamento de profundidade usado é muito grande.</span><span class="sxs-lookup"><span data-stu-id="51884-202">Peter Panning results when the depth offset used is too large.</span></span> <span data-ttu-id="51884-203">Nesse caso, o deslocamento de profundidade faz com que o teste de profundidade passe erroneamente.</span><span class="sxs-lookup"><span data-stu-id="51884-203">In this case the depth offset causes the depth test to erroneously pass.</span></span> <span data-ttu-id="51884-204">Como o Shadow acne, Peter panorâmica é agravadas quando não há precisão suficiente no buffer de profundidade.</span><span class="sxs-lookup"><span data-stu-id="51884-204">Like shadow acne, Peter Panning is aggravated when there is insufficient precision in the depth buffer.</span></span> <span data-ttu-id="51884-205">Calcular os planos próximos e os planos distantes também ajuda a evitar Peter panorâmica.</span><span class="sxs-lookup"><span data-stu-id="51884-205">Calculating tight near planes and far planes also helps avoid Peter Panning.</span></span>

## <a name="techniques-to-improve-shadow-maps"></a><span data-ttu-id="51884-206">Técnicas para melhorar os mapas de sombra</span><span class="sxs-lookup"><span data-stu-id="51884-206">Techniques to Improve Shadow Maps</span></span>

<span data-ttu-id="51884-207">Adicionar sombras a um título é um processo.</span><span class="sxs-lookup"><span data-stu-id="51884-207">Adding shadows to a title is a process.</span></span> <span data-ttu-id="51884-208">A primeira etapa é obter mapas de sombra básicos funcionando.</span><span class="sxs-lookup"><span data-stu-id="51884-208">The first step is to get basic shadow maps working.</span></span> <span data-ttu-id="51884-209">A segunda é garantir que todos os cálculos básicos sejam concluídos de maneira ideal: Frusta se ajustam o mais rigidamente possível, os planos próximos/distantes se encaixam rigidamente, a tendência de escala de inclinação é usada e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="51884-209">The second is to ensure all basic calculations are done optimally: frusta fit as tightly as possible, near/far planes fit tightly, slope-scaled bias is used, and so on.</span></span> <span data-ttu-id="51884-210">Depois que as sombras básicas estiverem habilitadas e a melhor aparência possível, o desenvolvedor terá uma ideia mais adequada de quais algoritmos são necessários para obter as sombras a uma fidelidade suficiente.</span><span class="sxs-lookup"><span data-stu-id="51884-210">Once basic shadows are enabled, and look as good as possible, the developer has a better idea of what algorithms are needed to get the shadows to sufficient fidelity.</span></span> <span data-ttu-id="51884-211">Dicas básicas que podem ser necessárias para obter mapas de sombra básicos que examinam seus melhores são fornecidos nesta seção.</span><span class="sxs-lookup"><span data-stu-id="51884-211">Basic tips that may be needed to get basic shadow maps looking at their best are given in this section.</span></span>

### <a name="slope-scale-depth-bias"></a><span data-ttu-id="51884-212">Slope-Scale a tendência de profundidade</span><span class="sxs-lookup"><span data-stu-id="51884-212">Slope-Scale Depth Bias</span></span>

<span data-ttu-id="51884-213">Como mencionado anteriormente, o sombreamento automático pode levar ao acne de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-213">As previously mentioned, self-shadowing can lead to shadow acne.</span></span> <span data-ttu-id="51884-214">Adicionar muita diferença pode resultar em Peter Panorâmicaing.</span><span class="sxs-lookup"><span data-stu-id="51884-214">Adding too much bias can result in Peter Panning.</span></span> <span data-ttu-id="51884-215">Além disso, polígonos com inclinação acentuada (em relação à luz) sofrem mais de alias projetado do que polígonos com inclinação superficial (em relação à luz).</span><span class="sxs-lookup"><span data-stu-id="51884-215">Additionally, polygons with steep slopes (relative to the light) suffer more from projective aliasing than polygons with shallow slopes (relative to the light).</span></span> <span data-ttu-id="51884-216">Por isso, cada valor de mapa de profundidade pode precisar de um deslocamento diferente, dependendo da inclinação do polígono em relação à luz.</span><span class="sxs-lookup"><span data-stu-id="51884-216">Because of this, each depth map value may need a different offset depending on the polygon's slope relative to the light.</span></span>

<span data-ttu-id="51884-217">O hardware do Direct3D 10 tem a capacidade de inclinar um polígono com base em sua inclinação em relação à direção da exibição.</span><span class="sxs-lookup"><span data-stu-id="51884-217">Direct3D 10 hardware has the ability to bias a polygon based on its slope with respect to the view direction.</span></span> <span data-ttu-id="51884-218">Isso tem o efeito de aplicar uma grande diferença a um polígono que é exibido de ponta para a direção da luz, mas não aplica qualquer tendência a um polígono voltado diretamente para a luz.</span><span class="sxs-lookup"><span data-stu-id="51884-218">This has the effect of applying a large bias to a polygon that is viewed edge-on to the light direction, but not applying any bias to a polygon facing the light directly.</span></span> <span data-ttu-id="51884-219">A Figura 10 ilustra como dois pixels vizinhos podem alternar entre sombreados e não sombreados ao testar a mesma inclinação não tendenciosa.</span><span class="sxs-lookup"><span data-stu-id="51884-219">Figure 10 illustrates how two neighboring pixels can alternate between shadowed and unshadowed when testing against the same unbiased slope.</span></span>

<span data-ttu-id="51884-220">**Figura 10. Inclinação de profundidade dimensionada em comparação com profundidade não polarizada**</span><span class="sxs-lookup"><span data-stu-id="51884-220">**Figure 10. Slope scaled depth-bias compared to unbiased depth**</span></span>

![inclinação de profundidade dimensionada em comparação com profundidade não polarizada](images/slope-scaled-depth-bias-compared-to-unbiased-depth.png)

### <a name="calculating-a-tight-projection"></a><span data-ttu-id="51884-222">Calculando uma projeção justa</span><span class="sxs-lookup"><span data-stu-id="51884-222">Calculating a Tight Projection</span></span>

<span data-ttu-id="51884-223">Ajustar rigidamente a projeção da luz à exibição frustum aumenta a cobertura do mapa de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-223">Tightly fitting the light's projection to the view frustum increases the shadow map coverage.</span></span> <span data-ttu-id="51884-224">A Figura 11 ilustra que usar uma projeção arbitrária ou ajustar a projeção aos limites da cena resulta em um alias de perspectiva mais alto.</span><span class="sxs-lookup"><span data-stu-id="51884-224">Figure 11 illustrates that using an arbitrary projection, or fitting the projection to the scene bounds, results in higher perspective aliasing.</span></span>

<span data-ttu-id="51884-225">**Figura 11. Frustum de sombra arbitrária e sombra frustum ajuste à cena**</span><span class="sxs-lookup"><span data-stu-id="51884-225">**Figure 11. Arbitrary shadow frustum and shadow frustum fit to scene**</span></span>

![frustum de sombra arbitrária e sombra frustum ajuste à cena](images/arbitrary-shadow-frustum-and-shadow-frustum-fit-to-scene.jpg)

<span data-ttu-id="51884-227">A exibição é do ponto de vista da luz.</span><span class="sxs-lookup"><span data-stu-id="51884-227">The view is from the point of view of the light.</span></span> <span data-ttu-id="51884-228">O trapézio representa o frustum da câmera de exibição.</span><span class="sxs-lookup"><span data-stu-id="51884-228">The trapezoid represents the view camera's frustum.</span></span> <span data-ttu-id="51884-229">A grade desenhada sobre a imagem representa o mapa de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-229">The grid drawn over the image represents the shadow map.</span></span> <span data-ttu-id="51884-230">A imagem à direita mostra que o mesmo mapa de sombra de resolução cria mais cobertura de Texel quando se ajusta mais rigidamente à cena.</span><span class="sxs-lookup"><span data-stu-id="51884-230">The image on the right shows that the same resolution shadow map creates more texel coverage when it is fit more tightly to the scene.</span></span>

<span data-ttu-id="51884-231">A Figura 12 ilustra os frustums que se ajustam corretamente.</span><span class="sxs-lookup"><span data-stu-id="51884-231">Figure 12 illustrates frustums that are correctly fit.</span></span> <span data-ttu-id="51884-232">Para calcular a projeção, os oito pontos que compõem a exibição frustum são transformados em espaço leve.</span><span class="sxs-lookup"><span data-stu-id="51884-232">To calculate the projection, the eight points that make up the view frustum are transformed into light space.</span></span> <span data-ttu-id="51884-233">Em seguida, os valores mínimo e máximo em X e Y são encontrados.</span><span class="sxs-lookup"><span data-stu-id="51884-233">Next, the minimum and maximum values in X and Y are found.</span></span> <span data-ttu-id="51884-234">Esses valores compõem os limites de uma projeção ortográfica.</span><span class="sxs-lookup"><span data-stu-id="51884-234">These values make up the bounds for an orthographic projection.</span></span>

<span data-ttu-id="51884-235">**Figura 12. Ajuste de projeção de sombra para exibir frustum**</span><span class="sxs-lookup"><span data-stu-id="51884-235">**Figure 12. Shadow projection fit to view frustum**</span></span>

![ajuste de projeção de sombra para exibir frustum](images/shadow-projection-fit-to-view-frustum.jpg)

<span data-ttu-id="51884-237">Também é possível recortar o frustum para a cena AABB para obter um limite mais rígido.</span><span class="sxs-lookup"><span data-stu-id="51884-237">It is also possible to clip the frustum to the scene AABB to get a tighter bound.</span></span> <span data-ttu-id="51884-238">Isso não é recomendável em todos os casos porque isso pode alterar o tamanho da projeção da câmera clara do quadro para o quadro.</span><span class="sxs-lookup"><span data-stu-id="51884-238">This is not advised in all cases because this can change the size of the light camera's projection from frame to frame.</span></span> <span data-ttu-id="51884-239">Muitas técnicas, como as descritas na seção movendo a luz Texel-Sized incrementos, apresentam melhores resultados quando o tamanho da projeção da luz permanece constante em todos os quadros.</span><span class="sxs-lookup"><span data-stu-id="51884-239">Many techniques, such as those described in the section Moving the Light Texel-Sized Increments, give better results when the size of the light's projection remains constant in every frame.</span></span>

### <a name="calculating-the-near-plane-and-far-plane"></a><span data-ttu-id="51884-240">Calculando o plano próximo e o plano distante</span><span class="sxs-lookup"><span data-stu-id="51884-240">Calculating the Near Plane and Far Plane</span></span>

<span data-ttu-id="51884-241">Os planos próximos e distantes são as partes finais necessárias para calcular a matriz de projeção.</span><span class="sxs-lookup"><span data-stu-id="51884-241">The near plane and far plane are the final pieces required to calculate the projection matrix.</span></span> <span data-ttu-id="51884-242">Quanto mais detalhadamente os planos, mais preciso os valores no buffer de profundidade.</span><span class="sxs-lookup"><span data-stu-id="51884-242">The more closely together the planes are, the more precise the values in the depth buffer.</span></span>

<span data-ttu-id="51884-243">O buffer de profundidade pode ser de 16 bits, de 24 bits ou de 32 bits, com valores entre 0 e 1.</span><span class="sxs-lookup"><span data-stu-id="51884-243">The depth buffer can be 16-bit, 24-bit, or 32-bit, with values between 0 and 1.</span></span> <span data-ttu-id="51884-244">Em geral, os buffers de profundidade são um ponto fixo, com os valores próximos ao plano próximo agrupados mais de perto do que os valores próximos ao plano distante.</span><span class="sxs-lookup"><span data-stu-id="51884-244">Generally, depth buffers are fixed point, with the values close to the near plane grouped more closely together than the values close to the far plane.</span></span> <span data-ttu-id="51884-245">O grau de precisão disponível para o buffer de profundidade é determinado pela proporção do plano próximo ao plano distante.</span><span class="sxs-lookup"><span data-stu-id="51884-245">The degree of precision available to the depth buffer is determined by the ratio of the near plane to the far plane.</span></span> <span data-ttu-id="51884-246">Usar o mais rígido possível plano próximo/longe pode permitir o uso de um buffer de profundidade de 16 bits.</span><span class="sxs-lookup"><span data-stu-id="51884-246">Using the tightest possible near/far plane could allow use of a 16-bit depth buffer.</span></span> <span data-ttu-id="51884-247">Um buffer de profundidade de 16 bits pode reduzir o uso da memória enquanto aumenta a velocidade de processamento.</span><span class="sxs-lookup"><span data-stu-id="51884-247">A 16-bit depth buffer could reduce the use of memory while increasing processing speed.</span></span>

### <a name="aabb-based-near-plane-and-far-plane"></a><span data-ttu-id="51884-248">AABB-Based próximo plano e plano distante</span><span class="sxs-lookup"><span data-stu-id="51884-248">AABB-Based Near Plane and Far Plane</span></span>

<span data-ttu-id="51884-249">Uma maneira fácil e simples de calcular o plano próximo e o avião é transformar o volume delimitador da cena em espaço leve.</span><span class="sxs-lookup"><span data-stu-id="51884-249">An easy and naive way to calculate the near plane and far plane is to transform the scene's bounding volume into light space.</span></span> <span data-ttu-id="51884-250">O menor valor de coordenada Z é o plano próximo e o maior valor de coordenada Z é o plano distante.</span><span class="sxs-lookup"><span data-stu-id="51884-250">The smallest Z-coordinate value is the near plane and the largest Z-coordinate value is the far plane.</span></span> <span data-ttu-id="51884-251">Para muitas configurações da cena e da luz, essa abordagem é suficiente.</span><span class="sxs-lookup"><span data-stu-id="51884-251">For many configurations of the scene and light, this approach is sufficient.</span></span> <span data-ttu-id="51884-252">No entanto, o pior cenário pode resultar em uma perda significativa de precisão no buffer de profundidade; A Figura 13 mostra esse cenário.</span><span class="sxs-lookup"><span data-stu-id="51884-252">The worst case scenario, however, can result in a significant loss of precision in the depth buffer; Figure 13 shows such a scenario.</span></span> <span data-ttu-id="51884-253">Aqui, a faixa do plano próximo ao plano distante é quatro vezes maior do que o necessário.</span><span class="sxs-lookup"><span data-stu-id="51884-253">Here the range of the near plane to the far plane is four times larger than necessary.</span></span>

<span data-ttu-id="51884-254">A exibição frustum na Figura 13 foi intencionalmente escolhida para ser pequena.</span><span class="sxs-lookup"><span data-stu-id="51884-254">The view frustum in Figure 13 was purposely chosen to be small.</span></span> <span data-ttu-id="51884-255">Uma pequena exibição frustum é mostrada em uma cena muito grande que consiste em pilares que se estendem da câmera de exibição.</span><span class="sxs-lookup"><span data-stu-id="51884-255">A small view frustum is shown in a very large scene consisting of pillars extending out from the view camera.</span></span> <span data-ttu-id="51884-256">Usar o AABB de cena para os planos próximos e distantes não é o ideal.</span><span class="sxs-lookup"><span data-stu-id="51884-256">Using the Scene AABB for the near and far planes is not optimal.</span></span> <span data-ttu-id="51884-257">O algoritmo CSM descrito no artigo técnico [mapas de sombra em cascata](/windows/desktop/DxTechArts/cascaded-shadow-maps) deve calcular planos próximos e distantes para frustums muito pequenos.</span><span class="sxs-lookup"><span data-stu-id="51884-257">The CSM algorithm described in the [Cascaded Shadow Maps](/windows/desktop/DxTechArts/cascaded-shadow-maps) technical article must calculate near and far planes for very small frustums.</span></span>

<span data-ttu-id="51884-258">**Figura 13. Planos próximos e distantes com base em AABB de cena**</span><span class="sxs-lookup"><span data-stu-id="51884-258">**Figure 13. Near and far planes based on Scene AABB**</span></span>

![planos próximos e distantes com base em AABB de cena](images/near-far-%20planes-based-on-scene-aabb.jpg)

### <a name="frustum-based-near-plane-and-far-plane"></a><span data-ttu-id="51884-260">Frustum-Based próximo plano e plano distante</span><span class="sxs-lookup"><span data-stu-id="51884-260">Frustum-Based Near Plane and Far Plane</span></span>

<span data-ttu-id="51884-261">Outra técnica para calcular os planos próximos e distantes é transformar o frustum em espaço leve e usar os valores mínimo e máximo em Z como os planos próximos e distantes, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="51884-261">Another technique for calculating the near and far planes is to transform the frustum into light space and use the minimal and maximal values in Z as the near and the far planes, respectively.</span></span> <span data-ttu-id="51884-262">A Figura 14 ilustra os dois problemas com essa abordagem.</span><span class="sxs-lookup"><span data-stu-id="51884-262">Figure 14 illustrates the two issues with this approach.</span></span> <span data-ttu-id="51884-263">Primeiro, o cálculo é muito conservador, como mostrado quando o frustum se estende além da geometria da cena.</span><span class="sxs-lookup"><span data-stu-id="51884-263">First, the calculation is too conservative, as shown when the frustum extends beyond the scene's geometry.</span></span> <span data-ttu-id="51884-264">Em segundo lugar, o plano próximo poderia ser muito apertado, fazendo com que os transmissões de sombra sejam cortados.</span><span class="sxs-lookup"><span data-stu-id="51884-264">Second, the near plane could be too tight, causing shadow casters to be cropped.</span></span>

<span data-ttu-id="51884-265">**Figura 14. Planos próximos e distantes com base apenas na exibição frustum**</span><span class="sxs-lookup"><span data-stu-id="51884-265">**Figure 14. Near and far planes based solely on view frustum**</span></span>

![planos próximos e distantes com base apenas na exibição frustum](images/near-far-planes-based-solely-on-view-frustum.jpg)

### <a name="light-frustum-intersected-with-scene-to-calculate-near-and-far-planes"></a><span data-ttu-id="51884-267">Frustum claro interseccionado com a cena para calcular planos próximos e distantes</span><span class="sxs-lookup"><span data-stu-id="51884-267">Light Frustum Intersected with Scene to Calculate Near and Far Planes</span></span>

<span data-ttu-id="51884-268">A maneira correta de calcular os planos próximos e distantes é mostrada na Figura 15.</span><span class="sxs-lookup"><span data-stu-id="51884-268">The proper way to calculate the near and far planes is shown in Figure 15.</span></span> <span data-ttu-id="51884-269">Quatro dos planos do frustum de luz ortográfica foram calculados usando o mínimo e o máximo das coordenadas X e Y da exibição frustum em espaço leve.</span><span class="sxs-lookup"><span data-stu-id="51884-269">Four of the planes of the orthographic light frustum were calculated using the minimum and maximum of the X and Y coordinates of the view frustum in light space.</span></span> <span data-ttu-id="51884-270">Os dois últimos planos da exibição ortogonal frustum são os planos próximos e distantes.</span><span class="sxs-lookup"><span data-stu-id="51884-270">The last two planes of the orthogonal view frustum are the near and the far planes.</span></span> <span data-ttu-id="51884-271">Para encontrar esses planos, os limites da cena são recortados em relação aos quatro planos de frustum claros conhecidos.</span><span class="sxs-lookup"><span data-stu-id="51884-271">To find these planes, the scene's bounds are clipped against the four known light frustum planes.</span></span> <span data-ttu-id="51884-272">Os valores Z menores e maiores do limite recentemente recortado representam o plano próximo e o plano distante, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="51884-272">The smallest and largest Z-values from the newly clipped boundary represent the near plane and far plane, respectively.</span></span>

<span data-ttu-id="51884-273">O código que executa essa operação está localizado no exemplo CascadedShadowMaps11.</span><span class="sxs-lookup"><span data-stu-id="51884-273">The code that performs this operation is located in the CascadedShadowMaps11 sample.</span></span> <span data-ttu-id="51884-274">Os oito pontos que compõem o AABB do mundo são transformados em espaço leve.</span><span class="sxs-lookup"><span data-stu-id="51884-274">The eight points that make up the world's AABB are transformed into light space.</span></span> <span data-ttu-id="51884-275">Transformar os pontos em espaço leve simplifica os testes de recorte.</span><span class="sxs-lookup"><span data-stu-id="51884-275">Transforming the points into light space simplifies the clipping tests.</span></span> <span data-ttu-id="51884-276">Os quatro planos conhecidos do frustum Light agora podem ser representados como linhas.</span><span class="sxs-lookup"><span data-stu-id="51884-276">The four known planes of the light frustum can now be represented as lines.</span></span> <span data-ttu-id="51884-277">O volume delimitador de cenas em espaço leve pode ser representado como seis quadrilaterals.</span><span class="sxs-lookup"><span data-stu-id="51884-277">The scenes bounding volume in light space can be represented as six quadrilaterals.</span></span> <span data-ttu-id="51884-278">Esses 6 quadrilaterals podem então ser transformados em 12 triângulos para recortes baseados em triângulo.</span><span class="sxs-lookup"><span data-stu-id="51884-278">These 6 quadrilaterals can then be turned into 12 triangles for triangle-based clipping.</span></span> <span data-ttu-id="51884-279">Os triângulos são recortados em relação aos planos conhecidos da exibição frustum (são linhas horizontais e verticais em X e Y em espaço leve).</span><span class="sxs-lookup"><span data-stu-id="51884-279">The triangles are clipped against the known planes of the view frustum (these are horizontal and vertical lines in X and Y in light space).</span></span> <span data-ttu-id="51884-280">Quando um ponto de interseção é encontrado em X e Y, o triângulo 3D é recortado nesse ponto.</span><span class="sxs-lookup"><span data-stu-id="51884-280">When an intersection point is found in X and Y, the 3D triangle is clipped at that point.</span></span> <span data-ttu-id="51884-281">Os valores Z mínimo e máximo de todos os triângulos recortados são os planos próximos e distantes.</span><span class="sxs-lookup"><span data-stu-id="51884-281">The minimum and maximum Z-values of all the clipped triangles are the near plane and far plane.</span></span> <span data-ttu-id="51884-282">O exemplo CascadedShadowMaps11 mostra como executar esse recorte na função **ComputeNearAndFar** .</span><span class="sxs-lookup"><span data-stu-id="51884-282">The CascadedShadowMaps11 sample shows how to perform this clipping in the **ComputeNearAndFar** function.</span></span>

<span data-ttu-id="51884-283">Há mais duas técnicas que podem ser usadas para calcular os mais rígidos planos próximos e distantes.</span><span class="sxs-lookup"><span data-stu-id="51884-283">There are two more techniques that could be used to calculate the tightest possible near and far planes.</span></span> <span data-ttu-id="51884-284">Essas técnicas não são mostradas no exemplo CascadedShadowMaps.</span><span class="sxs-lookup"><span data-stu-id="51884-284">These techniques are not shown in the CascadedShadowMaps sample.</span></span>

-   <span data-ttu-id="51884-285">Os planos mais rígidos próximos e distantes poderiam ser calculados interseccionando uma hierarquia de uma cena ou objetos individuais em uma cena em relação ao frustum claro.</span><span class="sxs-lookup"><span data-stu-id="51884-285">Even tighter near and far planes could be calculated by intersecting a hierarchy of a scene or individual objects in a scene against the light frustum.</span></span> <span data-ttu-id="51884-286">Isso seria computacionalmente mais complexo.</span><span class="sxs-lookup"><span data-stu-id="51884-286">This would be computationally more complex.</span></span> <span data-ttu-id="51884-287">Embora não esteja ilustrado no exemplo CascadedShadowMaps11, isso pode ser uma técnica válida para alguns blocos.</span><span class="sxs-lookup"><span data-stu-id="51884-287">While not illustrated in the CascadedShadowMaps11 sample, this could be a valid technique for some tiles.</span></span>
-   <span data-ttu-id="51884-288">O plano distante pode ser calculado com o mínimo de:</span><span class="sxs-lookup"><span data-stu-id="51884-288">The far plane could be calculated by taking the minimum of:</span></span>

    -   <span data-ttu-id="51884-289">A maior profundidade da exibição frustum em espaço leve.</span><span class="sxs-lookup"><span data-stu-id="51884-289">The largest depth of the view frustum in light space.</span></span>
    -   <span data-ttu-id="51884-290">A maior profundidade da interseção da exibição frustum e da cena AABB.</span><span class="sxs-lookup"><span data-stu-id="51884-290">The largest depth of the intersection of the view frustum and the scene AABB.</span></span>

<span data-ttu-id="51884-291">Essa abordagem pode ser problemática quando usada com mapas de sombra em cascata, onde é possível indexar fora de um frustum de exibição.</span><span class="sxs-lookup"><span data-stu-id="51884-291">This approach can be problematic when used with cascaded shadow maps where it is possible to index outside of a view frustum.</span></span> <span data-ttu-id="51884-292">Nesse caso, o mapa de sombra pode estar faltando Geometry.</span><span class="sxs-lookup"><span data-stu-id="51884-292">In this case, the shadow map might be missing geometry.</span></span>

<span data-ttu-id="51884-293">**Figura 15. Planos próximos e distantes com base na interseção dos quatro planos calculados do frustum claro e da geometria delimitadora da cena**</span><span class="sxs-lookup"><span data-stu-id="51884-293">**Figure 15. Near and far planes based on the intersection of the four calculated planes of the light frustum and the scene's bounding geometry**</span></span>

![planos próximos e distantes com base na interseção dos quatro planos calculados do frustum claro e da geometria delimitadora da cena](images/near-far-plane-based-on-intersection-of-four.jpg)

### <a name="moving-the-light-in-texel-sized-increments"></a><span data-ttu-id="51884-295">Movendo a luz em incrementos de Texel-Sized</span><span class="sxs-lookup"><span data-stu-id="51884-295">Moving the Light in Texel-Sized Increments</span></span>

<span data-ttu-id="51884-296">Um artefato comum em mapas de sombra é o efeito de borda shimmering.</span><span class="sxs-lookup"><span data-stu-id="51884-296">A common artifact in shadow maps is the shimmering edge effect.</span></span> <span data-ttu-id="51884-297">À medida que a câmera se move, os pixels ao longo das bordas são clareados e escurecedos.</span><span class="sxs-lookup"><span data-stu-id="51884-297">As the camera moves, the pixels along the shadows' edges brighten and darken.</span></span> <span data-ttu-id="51884-298">Isso não pode ser visto em imagens ainda, mas é muito perceptível e atrapalhando em tempo real.</span><span class="sxs-lookup"><span data-stu-id="51884-298">This cannot be seen in still images, but it is very noticeable and distracting in real time.</span></span> <span data-ttu-id="51884-299">A Figura 16 realça esse problema e a figura 17 mostra como as bordas de sombra devem ser exibidas.</span><span class="sxs-lookup"><span data-stu-id="51884-299">Figure 16 highlights this problem and Figure 17 shows how the shadow edges should look.</span></span>

<span data-ttu-id="51884-300">O erro de borda shimmering ocorre porque a matriz de projeção Light está sendo recalculada sempre que a câmera se move.</span><span class="sxs-lookup"><span data-stu-id="51884-300">The shimmering edge error occurs because the light projection matrix is being recalculated every time the camera moves.</span></span> <span data-ttu-id="51884-301">Isso cria diferenças sutis nos mapas de sombra gerados.</span><span class="sxs-lookup"><span data-stu-id="51884-301">This creates subtle differences in the generated shadow maps.</span></span> <span data-ttu-id="51884-302">Todos os fatores a seguir podem influenciar a matriz criada para associar a cena.</span><span class="sxs-lookup"><span data-stu-id="51884-302">All of the following factors can influence the matrix created to bound the scene.</span></span>

-   <span data-ttu-id="51884-303">Tamanho da exibição frustum</span><span class="sxs-lookup"><span data-stu-id="51884-303">Size of the view frustum</span></span>
-   <span data-ttu-id="51884-304">Orientação da exibição frustum</span><span class="sxs-lookup"><span data-stu-id="51884-304">Orientation of the view frustum</span></span>
-   <span data-ttu-id="51884-305">Local da luz</span><span class="sxs-lookup"><span data-stu-id="51884-305">Location of the light</span></span>
-   <span data-ttu-id="51884-306">Local da câmera</span><span class="sxs-lookup"><span data-stu-id="51884-306">Location of the camera</span></span>

<span data-ttu-id="51884-307">Toda vez que essa matriz é alterada, as bordas de sombras podem ser alteradas.</span><span class="sxs-lookup"><span data-stu-id="51884-307">Every time this matrix changes, the shadows edges could change.</span></span>

<span data-ttu-id="51884-308">**Figura 16. Bordas de sombra shimmering**</span><span class="sxs-lookup"><span data-stu-id="51884-308">**Figure 16. Shimmering shadow edges**</span></span>

![bordas de sombra shimmering](images/shimmering-shadow-edges.jpg)

<span data-ttu-id="51884-310">Os pixels ao longo da borda da sombra entram e saem da sombra à medida que a câmera se move da esquerda para a direita.</span><span class="sxs-lookup"><span data-stu-id="51884-310">The pixels along the border of the shadow come in and out of shadow as the camera moves from left to right.</span></span>

<span data-ttu-id="51884-311">**Figura 17. Sombras sem bordas shimmerings**</span><span class="sxs-lookup"><span data-stu-id="51884-311">**Figure 17. Shadows without shimmering edges**</span></span>

![sombras sem bordas shimmerings](images/shadows-without-shimmering-edges.jpg)

<span data-ttu-id="51884-313">As bordas de sombra permanecem constantes à medida que a câmera se move da esquerda para a direita.</span><span class="sxs-lookup"><span data-stu-id="51884-313">The shadow edges stay constant as the camera moves from left to right.</span></span>

<span data-ttu-id="51884-314">Para luzes direcionais, a solução para esse problema é arredondar o valor mínimo/máximo em X e Y (que compõem os limites de projeção ortográficas) para incrementos de tamanho de pixel.</span><span class="sxs-lookup"><span data-stu-id="51884-314">For directional lights, the solution to this problem is to round the minimum/maximum value in X and Y (that make up the orthographic projection bounds) to pixel size increments.</span></span> <span data-ttu-id="51884-315">Isso pode ser feito com uma operação de divisão, uma operação de andar e uma multiplicação.</span><span class="sxs-lookup"><span data-stu-id="51884-315">This can be done with a divide operation, a floor operation, and a multiply.</span></span>


```C++
        vLightCameraOrthographicMin /= vWorldUnitsPerTexel;
        vLightCameraOrthographicMin = XMVectorFloor( vLightCameraOrthographicMin );
        vLightCameraOrthographicMin *= vWorldUnitsPerTexel;
        vLightCameraOrthographicMax /= vWorldUnitsPerTexel;
        vLightCameraOrthographicMax = XMVectorFloor( vLightCameraOrthographicMax );
        vLightCameraOrthographicMax *= vWorldUnitsPerTexel;
```



<span data-ttu-id="51884-316">O valor de vWorldUnitsPerTexel é calculado por meio de um limite da exibição frustum e dividindo pelo tamanho do buffer.</span><span class="sxs-lookup"><span data-stu-id="51884-316">The vWorldUnitsPerTexel value is calculated by taking a bound of the view frustum, and dividing by the buffer size.</span></span>


```C++
        FLOAT fWorldUnitsPerTexel = fCascadeBound /
        (float)m_CopyOfCascadeConfig.m_iBufferSize;
        vWorldUnitsPerTexel = XMVectorSet( fWorldUnitsPerTexel, fWorldUnitsPerTexel,                            0.0f, 0.0f );
```



<span data-ttu-id="51884-317">O limite do tamanho máximo da exibição frustum resulta em uma ajuste mais flexível para a projeção ortográfica.</span><span class="sxs-lookup"><span data-stu-id="51884-317">Bounding the maximum size of the view frustum results in a looser fit for the orthographic projection.</span></span>

<span data-ttu-id="51884-318">É importante observar que a textura tem um pixel maior em largura e altura ao usar essa técnica.</span><span class="sxs-lookup"><span data-stu-id="51884-318">It is important to note that the texture is 1 pixel larger in width and height when using this technique.</span></span> <span data-ttu-id="51884-319">Isso mantém as coordenadas de sombra da indexação fora do mapa de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-319">This keeps shadow coordinates from indexing outside of the shadow map.</span></span>

### <a name="back-face-and-front-face"></a><span data-ttu-id="51884-320">Face traseira e face frontal</span><span class="sxs-lookup"><span data-stu-id="51884-320">Back Face and Front Face</span></span>

<span data-ttu-id="51884-321">Mapas de sombra devem ser renderizados com a remoção de face de fundo padrão, um processo que ignora a rasterização de objetos que o visualizador não pode ver e acelera a renderização da cena.</span><span class="sxs-lookup"><span data-stu-id="51884-321">Shadow maps should be rendered with standard back-face culling, a process that skips rasterization of objects that the viewer cannot see, and speeds up rendering of the scene.</span></span> <span data-ttu-id="51884-322">Outra opção comum é renderizar mapas de sombra com a remoção de face frontal habilitada, o que significa que os objetos voltados para o visualizador são eliminados.</span><span class="sxs-lookup"><span data-stu-id="51884-322">Another common option is to render shadow maps with front-face culling enabled, which means that objects facing the viewer are eliminated.</span></span> <span data-ttu-id="51884-323">O argumento para isso é que ele ajuda com o sombreamento automático, pois a geometria que compõe a parte posterior dos objetos é um deslocamento ligeiramente.</span><span class="sxs-lookup"><span data-stu-id="51884-323">The argument for this is that it helps with self-shadowing as the geometry making up the back of objects is slightly offset.</span></span> <span data-ttu-id="51884-324">Há dois problemas com essa ideia.</span><span class="sxs-lookup"><span data-stu-id="51884-324">There are two problems with this idea.</span></span>

-   <span data-ttu-id="51884-325">Qualquer objeto com geometria de frente ou verso inadequada causa artefatos no mapa de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-325">Any object with improper front-face or back-face geometry causes artifacts in the shadow map.</span></span> <span data-ttu-id="51884-326">No entanto, ter uma geometria incorreta ou de face traseira causará outros problemas, por isso pode ser seguro pressupor que a geometria de frente e de verso seja feita corretamente.</span><span class="sxs-lookup"><span data-stu-id="51884-326">However, having incorrect front-face or back-face geometry will cause other problems, so it may be safe to assume front-face and back-face geometry is done correctly.</span></span> <span data-ttu-id="51884-327">Pode ser impraticável criar faces traseiras para geometria baseada em Sprite, como folhagem.</span><span class="sxs-lookup"><span data-stu-id="51884-327">It may be impractical to create back faces for sprite-based geometry such as foliage.</span></span>
-   <span data-ttu-id="51884-328">Peter panorâmica e lacunas de sombra perto da base de objetos, como paredes, têm mais probabilidade de ocorrer porque a diparidade de profundidade de sombra é muito pequena.</span><span class="sxs-lookup"><span data-stu-id="51884-328">Peter Panning and shadow gaps near the base of objects such as walls are more likely to occur because the shadow depth disparity is too small.</span></span>

### <a name="shadow-mapfriendly-geometry"></a><span data-ttu-id="51884-329">Mapa de sombra – geometria amigável</span><span class="sxs-lookup"><span data-stu-id="51884-329">Shadow Map–Friendly Geometry</span></span>

<span data-ttu-id="51884-330">Criar geometria que funciona bem em mapas de sombra permite mais flexibilidade ao combater artefatos como Peter Panorâmicaing e Shadow acne.</span><span class="sxs-lookup"><span data-stu-id="51884-330">Creating geometry that works well in shadow maps allows for more flexibility when combating artifacts like Peter Panning and shadow acne.</span></span>

<span data-ttu-id="51884-331">As bordas rígidas são problemáticas para sombreamento automático.</span><span class="sxs-lookup"><span data-stu-id="51884-331">Hard edges are problematic for self-shadowing.</span></span> <span data-ttu-id="51884-332">A diparidade de profundidade próxima à ponta da borda é muito pequena.</span><span class="sxs-lookup"><span data-stu-id="51884-332">The depth disparity near the tip of the edge is very small.</span></span> <span data-ttu-id="51884-333">Mesmo um pequeno deslocamento pode fazer com que os objetos percam suas sombras (Figura 18).</span><span class="sxs-lookup"><span data-stu-id="51884-333">Even a small offset can cause objects to lose their shadows (Figure 18).</span></span>

<span data-ttu-id="51884-334">**Figura 18. Bordas nítidas causam artefatos que derivam de uma diparidade de profundidade com deslocamentos**</span><span class="sxs-lookup"><span data-stu-id="51884-334">**Figure 18. Sharp edges cause artifacts stemming from low-depth disparity with offsets**</span></span>

![bordas nítidas causam artefatos que derivam de uma diparidade de profundidade com deslocamentos](images/sharp-edges-cause%20artifacts.jpg)

<span data-ttu-id="51884-336">Objetos estreitos, como paredes, devem ter backups mesmo se nunca estiverem visíveis.</span><span class="sxs-lookup"><span data-stu-id="51884-336">Narrow objects such as walls should have backs even if they are never visible.</span></span> <span data-ttu-id="51884-337">Isso aumentará a diparidade de profundidade.</span><span class="sxs-lookup"><span data-stu-id="51884-337">This will increase the depth disparity.</span></span>

<span data-ttu-id="51884-338">Também é importante certificar-se de que a direção que a geometria está enfrentando está correta; ou seja, o fora de um objeto deve ser voltado e o dentro de um objeto deve ser frente.</span><span class="sxs-lookup"><span data-stu-id="51884-338">It's also important to make sure that the direction the geometry is facing is correct; that is, the outside of an object should be back facing and the inside of an object should be front facing.</span></span> <span data-ttu-id="51884-339">Isso é importante para o processamento com a remoção de face para frente habilitada, bem como para combater os efeitos de tendência de profundidade.</span><span class="sxs-lookup"><span data-stu-id="51884-339">This is important for rendering with back-face culling enabled, as well as for combating the effects of depth bias.</span></span>

## <a name="summary"></a><span data-ttu-id="51884-340">Resumo</span><span class="sxs-lookup"><span data-stu-id="51884-340">Summary</span></span>

<span data-ttu-id="51884-341">As técnicas descritas neste artigo podem ser usadas para aumentar a qualidade dos mapas de sombra padrão.</span><span class="sxs-lookup"><span data-stu-id="51884-341">The techniques described in this article can be used to increase the quality of standard shadow maps.</span></span> <span data-ttu-id="51884-342">A próxima etapa é examinar as técnicas que podem funcionar bem com mapas de sombra padrão.</span><span class="sxs-lookup"><span data-stu-id="51884-342">The next step is to look at techniques that can work well with standard shadow maps.</span></span> <span data-ttu-id="51884-343">CSMs são recomendadas como uma técnica superior para combater o alias de perspectiva.</span><span class="sxs-lookup"><span data-stu-id="51884-343">CSMs are recommended as a superior technique to combat perspective aliasing.</span></span> <span data-ttu-id="51884-344">A filtragem mais próxima ou os mapas de sombra de variação podem ser usados para suavizar as bordas de sombra.</span><span class="sxs-lookup"><span data-stu-id="51884-344">Percentage closer filtering or variance shadow maps can be used to soften shadow edges.</span></span> <span data-ttu-id="51884-345">Consulte o artigo técnico [mapas de sombra em cascata](/windows/desktop/DxTechArts/cascaded-shadow-maps) para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="51884-345">See the [Cascaded Shadow Maps](/windows/desktop/DxTechArts/cascaded-shadow-maps) technical article for more information.</span></span>

<span data-ttu-id="51884-346">Donnelly, W. e Lauritzen, A. [mapas de sombra de variância](https://portal.acm.org/citation.cfm?doid=1111411.1111440).</span><span class="sxs-lookup"><span data-stu-id="51884-346">Donnelly, W., and Lauritzen, A. [Variance Shadow Maps](https://portal.acm.org/citation.cfm?doid=1111411.1111440).</span></span> <span data-ttu-id="51884-347">Symposium em gráficos 3D interativos, procedimentos de Symposium de 2006 em jogos e gráficos 3D interativos.</span><span class="sxs-lookup"><span data-stu-id="51884-347">Symposium on Interactive 3D Graphics, Proceedings of the 2006 Symposium on Interactive 3D Graphics and Games.</span></span> <span data-ttu-id="51884-348">2006, pp. 161 – 165.</span><span class="sxs-lookup"><span data-stu-id="51884-348">2006, pp. 161–165.</span></span>

<span data-ttu-id="51884-349">Engel, Woflgang F. section 4.</span><span class="sxs-lookup"><span data-stu-id="51884-349">Engel, Woflgang F. Section 4.</span></span> <span data-ttu-id="51884-350">Mapas de sombra em cascata.</span><span class="sxs-lookup"><span data-stu-id="51884-350">Cascaded Shadow Maps.</span></span> <span data-ttu-id="51884-351">ShaderX5, *técnicas de renderização avançadas*, Wolfgang F. Engel, Ed.</span><span class="sxs-lookup"><span data-stu-id="51884-351">ShaderX5, *Advanced Rendering Techniques*, Wolfgang F. Engel, Ed.</span></span> <span data-ttu-id="51884-352">Charles River Media, Boston, Massachusetts.</span><span class="sxs-lookup"><span data-stu-id="51884-352">Charles River Media, Boston, Massachusetts.</span></span> <span data-ttu-id="51884-353">2006.</span><span class="sxs-lookup"><span data-stu-id="51884-353">2006.</span></span> <span data-ttu-id="51884-354">PP. 197 – 206.</span><span class="sxs-lookup"><span data-stu-id="51884-354">pp. 197–206.</span></span>

<span data-ttu-id="51884-355">Stamminger, Marc e Drettakis, George.</span><span class="sxs-lookup"><span data-stu-id="51884-355">Stamminger, Marc, and Drettakis, George.</span></span> <span data-ttu-id="51884-356">[Mapas de sombra em perspectiva](https://portal.acm.org/citation.cfm?id=566616).</span><span class="sxs-lookup"><span data-stu-id="51884-356">[Perspective Shadow Maps](https://portal.acm.org/citation.cfm?id=566616).</span></span> <span data-ttu-id="51884-357">Conferência Internacional em gráficos de computador e técnicas interativas, *procedimentos da conferência anual de 29 em gráficos de computador e técnicas interativas*.</span><span class="sxs-lookup"><span data-stu-id="51884-357">International Conference on Computer Graphics and Interactive Techniques, *Proceedings of the 29th Annual Conference on Computer Graphics and Interactive Techniques*.</span></span> <span data-ttu-id="51884-358">2002, PP 557 – 562.</span><span class="sxs-lookup"><span data-stu-id="51884-358">2002, pp 557–562.</span></span>

<span data-ttu-id="51884-359">Wimmer, M., Scherzer, D., e Purgathofer, W. [Light Space perspectiva sombra mapas](https://www.cg.tuwien.ac.at/research/vr/lispsm/shadows_egsr2004_revised.pdf).</span><span class="sxs-lookup"><span data-stu-id="51884-359">Wimmer, M., Scherzer, D., and Purgathofer, W. [Light Space Perspective Shadow Maps](https://www.cg.tuwien.ac.at/research/vr/lispsm/shadows_egsr2004_revised.pdf).</span></span> <span data-ttu-id="51884-360">Eurographics Symposium na renderização.</span><span class="sxs-lookup"><span data-stu-id="51884-360">Eurographics Symposium on Rendering.</span></span> <span data-ttu-id="51884-361">2004.</span><span class="sxs-lookup"><span data-stu-id="51884-361">2004.</span></span> <span data-ttu-id="51884-362">Revisado em 10 de junho de 2005.</span><span class="sxs-lookup"><span data-stu-id="51884-362">Revised June 10, 2005.</span></span> <span data-ttu-id="51884-363">[Technische Universität Wien](https://www.cg.tuwien.ac.at/research/vr/lispsm/).</span><span class="sxs-lookup"><span data-stu-id="51884-363">[Technische Universität Wien](https://www.cg.tuwien.ac.at/research/vr/lispsm/).</span></span>

 

 
