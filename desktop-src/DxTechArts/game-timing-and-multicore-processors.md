---
title: Tempo do jogo e processadores com vários núcleos
description: Este artigo sugere uma solução mais precisa e confiável para obter tempos de CPU de alta resolução usando as APIs do Windows QueryPerformanceCounter e QueryPerformanceFrequency.
ms.assetid: 1512324d-dffa-3681-be3f-f63a3b8f11db
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f7a6d9d65ccb79c7b496b4d02b1bed132bdc2d3f
ms.sourcegitcommit: 998a611c97d5e20ac0c45e3bda768ae67d8c2cca
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 05/11/2021
ms.locfileid: "109725005"
---
# <a name="game-timing-and-multicore-processors"></a><span data-ttu-id="02f6b-103">Tempo do jogo e processadores com vários núcleos</span><span class="sxs-lookup"><span data-stu-id="02f6b-103">Game Timing and Multicore Processors</span></span>

<span data-ttu-id="02f6b-104">Com as tecnologias de gerenciamento de energia que se tornam mais comuns nos computadores atuais, um método comumente usado para obter intervalos de CPU de alta resolução, a instrução RDTSC, pode não funcionar mais conforme o esperado.</span><span class="sxs-lookup"><span data-stu-id="02f6b-104">With power management technologies becoming more commonplace in today's computers, a commonly-used method to obtain high-resolution CPU timings, the RDTSC instruction, may no longer work as expected.</span></span> <span data-ttu-id="02f6b-105">Este artigo sugere uma solução mais precisa e confiável para obter tempos de CPU de alta resolução usando as APIs do Windows [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) e [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span><span class="sxs-lookup"><span data-stu-id="02f6b-105">This article suggests a more accurate, reliable solution to obtain high-resolution CPU timings by using the Windows APIs [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

-   [<span data-ttu-id="02f6b-106">Tela de fundo</span><span class="sxs-lookup"><span data-stu-id="02f6b-106">Background</span></span>](#background)
-   [<span data-ttu-id="02f6b-107">Recomendações</span><span class="sxs-lookup"><span data-stu-id="02f6b-107">Recommendations</span></span>](#recommendations)
-   [<span data-ttu-id="02f6b-108">Compatibilidade de aplicativos</span><span class="sxs-lookup"><span data-stu-id="02f6b-108">Application Compatibility</span></span>](#application-compatibility)

## <a name="background"></a><span data-ttu-id="02f6b-109">Tela de fundo</span><span class="sxs-lookup"><span data-stu-id="02f6b-109">Background</span></span>

<span data-ttu-id="02f6b-110">Desde a introdução do conjunto de instruções do P5 x86, muitos desenvolvedores de jogos fizeram o uso do contador de carimbo de data/hora de leitura, a instrução RDTSC, para executar o tempo de alta resolução.</span><span class="sxs-lookup"><span data-stu-id="02f6b-110">Since the introduction of the x86 P5 instruction set, many game developers have made use of read time stamp counter, the RDTSC instruction, to perform high-resolution timing.</span></span> <span data-ttu-id="02f6b-111">Os temporizadores de multimídia do Windows são precisos o suficiente para o processamento de som e vídeo, mas com horários de quadros de dezenas de milissegundos ou menos, eles não têm resolução suficiente para fornecer informações em tempo Delta.</span><span class="sxs-lookup"><span data-stu-id="02f6b-111">The Windows multimedia timers are precise enough for sound and video processing, but with frame times of a dozen milliseconds or less, they don't have enough resolution to provide delta-time information.</span></span> <span data-ttu-id="02f6b-112">Muitos jogos ainda usam um temporizador de multimídia na inicialização para estabelecer a frequência da CPU e usam esse valor de frequência para dimensionar os resultados de RDTSC para obter um tempo preciso.</span><span class="sxs-lookup"><span data-stu-id="02f6b-112">Many games still use a multimedia timer at start-up to establish the frequency of the CPU, and they use that frequency value to scale results from RDTSC to get accurate time.</span></span> <span data-ttu-id="02f6b-113">Devido às limitações do RDTSC, a API do Windows expõe a maneira mais correta de acessar essa funcionalidade por meio das rotinas de [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) e [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span><span class="sxs-lookup"><span data-stu-id="02f6b-113">Due to the limitations of RDTSC, the Windows API exposes the more correct way to access this functionality through the routines of [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

<span data-ttu-id="02f6b-114">Esse uso de RDTSC para o tempo sofre contra esses problemas fundamentais:</span><span class="sxs-lookup"><span data-stu-id="02f6b-114">This use of RDTSC for timing suffers from these fundamental issues:</span></span>

-   <span data-ttu-id="02f6b-115">Valores descontínuos.</span><span class="sxs-lookup"><span data-stu-id="02f6b-115">Discontinuous values.</span></span> <span data-ttu-id="02f6b-116">Usar o RDTSC diretamente pressupõe que o thread esteja sempre em execução no mesmo processador.</span><span class="sxs-lookup"><span data-stu-id="02f6b-116">Using RDTSC directly assumes that the thread is always running on the same processor.</span></span> <span data-ttu-id="02f6b-117">Os sistemas multiprocessador e dual-core não garantem a sincronização de seus contadores de ciclo entre os núcleos.</span><span class="sxs-lookup"><span data-stu-id="02f6b-117">Multiprocessor and dual-core systems do not guarantee synchronization of their cycle counters between cores.</span></span> <span data-ttu-id="02f6b-118">Isso é exacerbado quando combinado com as tecnologias de gerenciamento de energia modernas que estão ociosas e restauram vários núcleos em momentos diferentes, o que resulta em normalmente os núcleos estarem fora de sincronização.</span><span class="sxs-lookup"><span data-stu-id="02f6b-118">This is exacerbated when combined with modern power management technologies that idle and restore various cores at different times, which results in the cores typically being out of synchronization.</span></span> <span data-ttu-id="02f6b-119">Para um aplicativo, isso geralmente resulta em falhas ou em possíveis falhas à medida que o thread salta entre os processadores e obtém valores de tempo que resultam em deltas grandes, deltas negativos ou tempo interrompido.</span><span class="sxs-lookup"><span data-stu-id="02f6b-119">For an application, this generally results in glitches or in potential crashes as the thread jumps between the processors and gets timing values that result in large deltas, negative deltas, or halted timing.</span></span>
-   <span data-ttu-id="02f6b-120">Disponibilidade de hardware dedicado.</span><span class="sxs-lookup"><span data-stu-id="02f6b-120">Availability of dedicated hardware.</span></span> <span data-ttu-id="02f6b-121">O RDTSC bloqueia as informações de tempo que o aplicativo solicita ao contador de ciclo do processador.</span><span class="sxs-lookup"><span data-stu-id="02f6b-121">RDTSC locks the timing information that the application requests to the processor's cycle counter.</span></span> <span data-ttu-id="02f6b-122">Por muitos anos, essa era a melhor maneira de obter informações de tempo de alta precisão, mas as placas-mãe mais novas agora incluem dispositivos de tempo dedicados que fornecem informações de tempo de alta resolução sem as desvantagens do RDTSC.</span><span class="sxs-lookup"><span data-stu-id="02f6b-122">For many years this was the best way to get high-precision timing information, but newer motherboards are now including dedicated timing devices which provide high-resolution timing information without the drawbacks of RDTSC.</span></span>
-   <span data-ttu-id="02f6b-123">Variabilidade da frequência da CPU.</span><span class="sxs-lookup"><span data-stu-id="02f6b-123">Variability of the CPU's frequency.</span></span> <span data-ttu-id="02f6b-124">Muitas vezes, é feita a suposição de que a frequência da CPU é fixa durante a vida útil do programa.</span><span class="sxs-lookup"><span data-stu-id="02f6b-124">The assumption is often made that the frequency of the CPU is fixed for the life of the program.</span></span> <span data-ttu-id="02f6b-125">No entanto, com tecnologias modernas de gerenciamento de energia, essa é uma suposição incorreta.</span><span class="sxs-lookup"><span data-stu-id="02f6b-125">However, with modern power management technologies, this is an incorrect assumption.</span></span> <span data-ttu-id="02f6b-126">Embora inicialmente limitada a computadores laptop e outros dispositivos móveis, a tecnologia que altera a frequência da CPU está em uso em muitos computadores de área de trabalho de alto nível; desabilitar sua função para manter uma frequência consistente geralmente não é aceitável para os usuários.</span><span class="sxs-lookup"><span data-stu-id="02f6b-126">While initially limited to laptop computers and other mobile devices, technology that changes the frequency of the CPU is in use in many high-end desktop PCs; disabling its function to maintain a consistent frequency is generally not acceptable to users.</span></span>

## <a name="recommendations"></a><span data-ttu-id="02f6b-127">Recomendações</span><span class="sxs-lookup"><span data-stu-id="02f6b-127">Recommendations</span></span>

<span data-ttu-id="02f6b-128">Os jogos precisam de informações precisas de tempo, mas você também precisa implementar o código de tempo de uma maneira que evite os problemas associados ao uso do RDTSC.</span><span class="sxs-lookup"><span data-stu-id="02f6b-128">Games need accurate timing information, but you also need to implement timing code in a way that avoids the problems associated with using RDTSC.</span></span> <span data-ttu-id="02f6b-129">Ao implementar o tempo de alta resolução, tome as seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="02f6b-129">When you implement high-resolution timing, take the following steps:</span></span>

1.  <span data-ttu-id="02f6b-130">Use [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) e [**QueryPerformanceFrequency em vez**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) de RDTSC.</span><span class="sxs-lookup"><span data-stu-id="02f6b-130">Use [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) instead of RDTSC.</span></span> <span data-ttu-id="02f6b-131">Essas APIs podem usar o RDTSC, mas podem usar dispositivos de tempo na placa-mãe ou alguns outros serviços do sistema que fornecem informações de tempo de alta resolução de alta qualidade.</span><span class="sxs-lookup"><span data-stu-id="02f6b-131">These APIs may make use of RDTSC, but might instead make use of a timing devices on the motherboard or some other system services that provide high-quality high-resolution timing information.</span></span> <span data-ttu-id="02f6b-132">Embora o RDTSC seja muito mais rápido do que **QueryPerformanceCounter,** já que a última é uma chamada à API, é uma API que pode ser chamada várias centenas de vezes por quadro sem nenhum impacto perceptível.</span><span class="sxs-lookup"><span data-stu-id="02f6b-132">While RDTSC is much faster than **QueryPerformanceCounter**, since the latter is an API call, it is an API that can be called several hundred times per frame without any noticeable impact.</span></span> <span data-ttu-id="02f6b-133">(No entanto, os desenvolvedores devem tentar fazer com que seus jogos chamem **QueryPerformanceCounter** o menos possível para evitar qualquer penalidade de desempenho.)</span><span class="sxs-lookup"><span data-stu-id="02f6b-133">(Nevertheless, developers should attempt to have their games call **QueryPerformanceCounter** as little as possible to avoid any performance penalty.)</span></span>
2.  <span data-ttu-id="02f6b-134">Ao computar deltas, os valores devem ser clamped para garantir que qualquer bug nos valores de tempo não cause panes ou cálculos relacionados ao tempo instável.</span><span class="sxs-lookup"><span data-stu-id="02f6b-134">When computing deltas, the values should be clamped to ensure that any bugs in the timing values do not cause crashes or unstable time-related computations.</span></span> <span data-ttu-id="02f6b-135">O intervalo de fixe deve ser de 0 (para evitar valores Delta negativos) a um valor razoável com base na taxa de quadros esperada mais baixa.</span><span class="sxs-lookup"><span data-stu-id="02f6b-135">The clamp range should be from 0 (to prevent negative delta values) to some reasonable value based on your lowest expected framerate.</span></span> <span data-ttu-id="02f6b-136">O fixação MSS provavelmente será útil em qualquer depuração do seu aplicativo, mas lembre-se de mantê-lo em mente se estiver fazendo análise de desempenho ou executando o jogo em algum modo não otimizado.</span><span class="sxs-lookup"><span data-stu-id="02f6b-136">Clamping is likely to be useful in any debugging of your application, but be sure to keep it in mind if doing performance analysis or running the game in some unoptimized mode.</span></span>
3.  <span data-ttu-id="02f6b-137">Computar todo o tempo em um único thread.</span><span class="sxs-lookup"><span data-stu-id="02f6b-137">Compute all timing on a single thread.</span></span> <span data-ttu-id="02f6b-138">Computação de tempo em vários threads — por exemplo, com cada thread associado a um processador específico — reduz significativamente o desempenho de sistemas de vários núcleos.</span><span class="sxs-lookup"><span data-stu-id="02f6b-138">Computation of timing on multiple threads — for example, with each thread associated with a specific processor — greatly reduces performance of multi-core systems.</span></span>
4.  <span data-ttu-id="02f6b-139">Defina esse thread único para permanecer em um único processador usando a API do Windows [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span><span class="sxs-lookup"><span data-stu-id="02f6b-139">Set that single thread to remain on a single processor by using the Windows API [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span></span> <span data-ttu-id="02f6b-140">Normalmente, esse é o thread principal do jogo.</span><span class="sxs-lookup"><span data-stu-id="02f6b-140">Typically, this is the main game thread.</span></span> <span data-ttu-id="02f6b-141">Embora [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) e [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) normalmente se ajustem a vários processadores, os bugs no BIOS ou nos drivers podem resultar nessas rotinas retornando valores diferentes conforme o thread passa de um processador para outro.</span><span class="sxs-lookup"><span data-stu-id="02f6b-141">While [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) typically adjust for multiple processors, bugs in the BIOS or drivers may result in these routines returning different values as the thread moves from one processor to another.</span></span> <span data-ttu-id="02f6b-142">Portanto, é melhor manter o thread em um único processador.</span><span class="sxs-lookup"><span data-stu-id="02f6b-142">So, it's best to keep the thread on a single processor.</span></span>

    <span data-ttu-id="02f6b-143">Todos os outros threads devem operar sem a coleta de seus próprios dados de timer.</span><span class="sxs-lookup"><span data-stu-id="02f6b-143">All other threads should operate without gathering their own timer data.</span></span> <span data-ttu-id="02f6b-144">Não recomendamos o uso de um thread de trabalho para calcular o tempo, pois isso se tornará um afunilamento de sincronização.</span><span class="sxs-lookup"><span data-stu-id="02f6b-144">We do not recommend using a worker thread to compute timing, as this will become a synchronization bottleneck.</span></span> <span data-ttu-id="02f6b-145">Em vez disso, os threads de trabalho devem ler carimbos de data/hora do thread principal e, como os threads de trabalho só lêem carimbos de data/hora, não há necessidade de usar seções críticas.</span><span class="sxs-lookup"><span data-stu-id="02f6b-145">Instead, worker threads should read timestamps from the main thread, and because the worker threads only read timestamps, there is no need to use critical sections.</span></span>

5.  <span data-ttu-id="02f6b-146">Chame [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) apenas uma vez, porque a frequência não será alterada enquanto o sistema estiver em execução.</span><span class="sxs-lookup"><span data-stu-id="02f6b-146">Call [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) only once, because the frequency will not change while the system is running.</span></span>

## <a name="application-compatibility"></a><span data-ttu-id="02f6b-147">Compatibilidade de aplicativos</span><span class="sxs-lookup"><span data-stu-id="02f6b-147">Application Compatibility</span></span>

<span data-ttu-id="02f6b-148">Muitos desenvolvedores fizeram suposições sobre o comportamento de RDTSC por muitos anos, portanto, é bem provável que alguns aplicativos existentes apresentem problemas quando executados em um sistema com vários processadores ou núcleos devido à implementação de tempo.</span><span class="sxs-lookup"><span data-stu-id="02f6b-148">Many developers have made assumptions about the behavior of RDTSC over many years, so it is quite likely that some existing applications will exhibit problems when run on a system with multiple processors or cores due to the timing implementation.</span></span> <span data-ttu-id="02f6b-149">Esses problemas normalmente serão manifestados como um movimento de movimento lento ou de falha.</span><span class="sxs-lookup"><span data-stu-id="02f6b-149">These problems will usually manifest as glitching or slow-motion movement.</span></span> <span data-ttu-id="02f6b-150">Não há uma solução fácil para aplicativos que não estão cientes do gerenciamento de energia, mas há um shim existente para forçar um aplicativo a sempre executar em um único processador em um sistema multiprocessador.</span><span class="sxs-lookup"><span data-stu-id="02f6b-150">There is no easy remedy for applications that are not aware of power management, but there is an existing shim for forcing an application to always run on a single processor in a multiprocessor system.</span></span>

<span data-ttu-id="02f6b-151">Para criar esse shim, baixe o Microsoft Application Compatibility Toolkit do [Windows Application Compatibility](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span><span class="sxs-lookup"><span data-stu-id="02f6b-151">To create this shim, download the Microsoft Application Compatibility Toolkit from [Windows Application Compatibility](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span></span>

<span data-ttu-id="02f6b-152">Usando o Administrador de Compatibilidade, parte do kit de ferramentas, crie um banco de dados do seu aplicativo e correções associadas.</span><span class="sxs-lookup"><span data-stu-id="02f6b-152">Using the Compatibility Administrator, part of the toolkit, create a database of your application and associated fixes.</span></span> <span data-ttu-id="02f6b-153">Crie um novo modo de compatibilidade para esse banco de dados e selecione a correção de compatibilidade **SingleProcAffinity** para forçar todos os threads do aplicativo a executar em um único processador/núcleo.</span><span class="sxs-lookup"><span data-stu-id="02f6b-153">Create a new compatibility mode for this database and select the compatibility fix **SingleProcAffinity** to force all of the threads of the application to run on a single processor/core.</span></span> <span data-ttu-id="02f6b-154">Usando a ferramenta de linha de comando Fixpack.exe (também parte do kit de ferramentas), você pode converter esse banco de dados em um pacote instalável para instalação, teste e distribuição.</span><span class="sxs-lookup"><span data-stu-id="02f6b-154">By using the command-line tool Fixpack.exe (also part of the toolkit), you can convert this database into an installable package for installation, testing, and distribution.</span></span>

<span data-ttu-id="02f6b-155">Para saber mais sobre como usar o Administrador de Compatibilidade, confira a documentação do kit de ferramentas.</span><span class="sxs-lookup"><span data-stu-id="02f6b-155">For instruction on using Compatibility Administrator, see the toolkit's documentation.</span></span> <span data-ttu-id="02f6b-156">Para ver a sintaxe e exemplos de Fixpack.exe, confira sua ajuda de linha de comando.</span><span class="sxs-lookup"><span data-stu-id="02f6b-156">For syntax for and examples of using Fixpack.exe, see its command-line help.</span></span>

<span data-ttu-id="02f6b-157">Para obter informações orientadas ao cliente, consulte os seguintes artigos da base de dados de conhecimento da Ajuda e suporte da Microsoft:</span><span class="sxs-lookup"><span data-stu-id="02f6b-157">For customer-oriented information, see the following knowledge base articles from Microsoft Help and Support:</span></span>

-   <span data-ttu-id="02f6b-158">[Programas que usam a função QueryPerformanceCounter](https://support.microsoft.com/kb/895980) podem ter um desempenho ruim no Windows Server 2003 e no Windows XP (artigo 895980)</span><span class="sxs-lookup"><span data-stu-id="02f6b-158">[Programs that use the QueryPerformanceCounter function may perform poorly in Windows Server 2003 and in Windows XP](https://support.microsoft.com/kb/895980) (article 895980)</span></span>
-   <span data-ttu-id="02f6b-159">[O desempenho do jogo pode ser ruim em](https://support.microsoft.com/kb/909944) um computador baseado em Windows XP que está usando um processador de núcleo duplo (artigo 909944)</span><span class="sxs-lookup"><span data-stu-id="02f6b-159">[Game performance may be poor on a Windows XP-based computer that is using a dual-core processor](https://support.microsoft.com/kb/909944) (article 909944)</span></span>

 

 
