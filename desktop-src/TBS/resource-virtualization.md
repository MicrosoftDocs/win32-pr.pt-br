---
title: Virtualização de recursos
description: Virtualização de recursos
ms.assetid: ead0e99a-94da-4e80-bb68-d8f4b199173d
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f340b1a1bddfb3fd591452e028c80403b9c7e02f
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/16/2019
ms.locfileid: "103636341"
---
# <a name="resource-virtualization"></a><span data-ttu-id="ddd3a-103">Virtualização de recursos</span><span class="sxs-lookup"><span data-stu-id="ddd3a-103">Resource Virtualization</span></span>

<span data-ttu-id="ddd3a-104">A função principal do TBS é compartilhar com eficiência determinados recursos limitados do TPM: chaves, autorização e sessões de transporte.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-104">The primary function of the TBS is to efficiently share certain limited TPM resources: keys, authorization, and transport sessions.</span></span>

<span data-ttu-id="ddd3a-105">Quando uma instância de um desses recursos é criada, o TBS cria uma instância virtual do recurso e retorna um identificador para essa instância virtual no fluxo do comando de resultado (em vez da instância de identificador real retornada pelo TPM).</span><span class="sxs-lookup"><span data-stu-id="ddd3a-105">When an instance of one of these resources is created, the TBS creates a virtual instance of the resource, and returns a handle to this virtual instance in the result command stream (rather than the actual handle instance returned by the TPM).</span></span> <span data-ttu-id="ddd3a-106">O TBS mantém um mapeamento entre o identificador virtual e o identificador real internamente.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-106">The TBS maintains a mapping between the virtual handle and the actual handle internally.</span></span> <span data-ttu-id="ddd3a-107">Se o TPM ficar sem espaço para conter mais recursos de um determinado tipo, as instâncias existentes do recurso serão salvas e removidas seletivamente até que o TPM possa manter o novo recurso.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-107">If the TPM runs out of space to hold more resources of a given type, existing instances of the resource are selectively saved and evicted until the TPM can hold the new resource.</span></span> <span data-ttu-id="ddd3a-108">Quando os recursos antigos forem requeridos novamente, o TBS carregará os contextos salvos (salvando e removendo outros recursos, se necessário) antes de enviar o comando.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-108">When the old resources are required again, the TBS loads the saved contexts (saving and evicting other resources if necessary) before submitting the command.</span></span>

<span data-ttu-id="ddd3a-109">Toda a virtualização no TBS é executada em nome de um contexto específico.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-109">All virtualization in the TBS is performed on behalf of a specific context.</span></span> <span data-ttu-id="ddd3a-110">Cada contexto só tem permissão para acessar recursos virtuais criados especificamente em seu nome, bem como os recursos físicos no TPM que corresponde a esses recursos virtuais.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-110">Each context is only allowed to access virtual resources created specifically on its behalf, as well as the physical resources on the TPM that corresponds to those virtual resources.</span></span> <span data-ttu-id="ddd3a-111">Por padrão, o número total de todos os recursos virtualizados é limitado a 500.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-111">By default, the total number of all virtualized resources is limited to 500.</span></span> <span data-ttu-id="ddd3a-112">Esse número pode ser alterado criando ou modificando um valor de registro **DWORD** chamado **MaxResources** em **HKEY \_ local \_ Machine** \\ **software** \\ **Microsoft** \\ **TPM**.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-112">This number can be altered by creating or modifying a **DWORD** registry value named **MaxResources** under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Tpm**.</span></span> <span data-ttu-id="ddd3a-113">O uso de recursos TBS em tempo real pode ser observado usando a ferramenta Monitor de desempenho para controlar o número de recursos TBS.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-113">Real-time TBS resource usage can be observed by using the Performance Monitor tool to track the number of TBS resources.</span></span> <span data-ttu-id="ddd3a-114">Essa restrição se tornou obsoleta com o Windows 8 e o Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-114">This restriction became obsolete with Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="ddd3a-115">Os recursos limitados do TPM que não são virtualizados pelo TBS (como contadores e armazenamento NV) devem ser compartilhados de forma cooperativa entre as pilhas de software.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-115">Limited TPM resources that are not virtualized by the TBS (such as counters and NV store) must be cooperatively shared among software stacks.</span></span>

> [!Note]  
> <span data-ttu-id="ddd3a-116">Essa virtualização de identificador faz com que os comandos que incluem os principais identificadores no cálculo dos parâmetros de autorização HMAC falhem.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-116">This handle virtualization causes commands that include key handles in the calculation of HMAC authorization parameters to fail.</span></span> <span data-ttu-id="ddd3a-117">Como resultado, muitos comandos preteridos no TPM versão 1,2 não podem ser usados pelo software de aplicativo no ambiente TBS.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-117">As a result, many commands deprecated in TPM version 1.2 cannot be used by application software in the TBS environment.</span></span>

 

## <a name="resource-limits"></a><span data-ttu-id="ddd3a-118">Limites de recursos</span><span class="sxs-lookup"><span data-stu-id="ddd3a-118">Resource Limits</span></span>

<span data-ttu-id="ddd3a-119">O TPM permite que os chamadores consultem seus recursos para determinar a quantidade de espaço disponível para determinados tipos de recursos.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-119">The TPM enables callers to query its capabilities to determine how much space is available for certain types of resources.</span></span> <span data-ttu-id="ddd3a-120">Alguns desses limites de recursos, como a quantidade de espaço disponível para chaves, sessões de autorização e sessões de transporte, são efetivamente estendidos pelos TBS por meio da virtualização.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-120">Some of these resource limits, such as the amount of space available for keys, authorization sessions, and transport sessions, are effectively extended by the TBS through virtualization.</span></span> <span data-ttu-id="ddd3a-121">As limitações do TBS, que são controladas pela configuração do registro **MaxResources** , geralmente são muito maiores do que as limitações reais do hardware do TPM subjacente.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-121">TBS limitations, which are controlled by the **MaxResources** registry setting, are usually far larger than the actual limitations of the underlying TPM hardware.</span></span> <span data-ttu-id="ddd3a-122">Nenhum mecanismo é fornecido para consultar limitações de TBS separadamente dos limites de hardware do TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-122">No mechanism is supplied for querying TBS limitations separately from the TPM hardware limits.</span></span> <span data-ttu-id="ddd3a-123">Essa limitação de TBS se tornou obsoleta com o Windows 8 e o Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-123">This TBS limitation became obsolete with Windows 8 and Windows Server 2012.</span></span>

## <a name="keys"></a><span data-ttu-id="ddd3a-124">simétricas</span><span class="sxs-lookup"><span data-stu-id="ddd3a-124">Keys</span></span>

<span data-ttu-id="ddd3a-125">O TBS virtualiza os principais identificadores para que as chaves possam ser descarregadas de forma transparente do TPM quando não estiverem sendo usadas e carregadas de volta no TPM quando forem necessárias.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-125">The TBS virtualizes key handles so that keys can be transparently unloaded from the TPM when they are not being used and loaded back onto the TPM when they are needed.</span></span> <span data-ttu-id="ddd3a-126">Quando uma chave é criada, o TBS associa um identificador virtual à chave carregada.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-126">When a key is created, the TBS associates a virtual handle with the loaded key.</span></span> <span data-ttu-id="ddd3a-127">O mesmo identificador virtual é usado para o tempo de vida do recurso.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-127">The same virtual handle is used for the lifetime of the resource.</span></span> <span data-ttu-id="ddd3a-128">Os identificadores de chave virtual são válidos apenas no contexto que os criou, e os recursos associados não são preservados além da vida útil do contexto.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-128">Virtual key handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the context.</span></span>

-   <span data-ttu-id="ddd3a-129">Criando chaves com \_ LOADKEY2 TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-129">Creating Keys with TPM\_LoadKey2</span></span>

    <span data-ttu-id="ddd3a-130">Se uma chave for criada usando o comando TPM \_ LoadKey2, TPM2 \_ createprimário, TPM2 \_ Load ou TPM2 \_ loadexternal, o TBS substituirá o identificador no fluxo de retorno de bytes por um identificador de chave virtual de sua escolha.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-130">If a key is created by using the TPM\_LoadKey2, TPM2\_CreatePrimary, TPM2\_Load, or TPM2\_LoadExternal command, the TBS replaces the handle in the return byte stream with a virtual key handle of its choosing.</span></span> <span data-ttu-id="ddd3a-131">Como resultado, o TBS garante que cada identificador virtual seja exclusivo.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-131">As a result, the TBS ensures that each virtual handle is unique.</span></span> <span data-ttu-id="ddd3a-132">Se o TBS detectar uma colisão (um evento extremamente improvável), o TBS descarregará a chave do TPM e informará o software de chamada.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-132">If the TBS detects a collision (an extremely unlikely event), the TBS unloads the key from the TPM and informs the calling software.</span></span> <span data-ttu-id="ddd3a-133">O software pode enviar a operação novamente.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-133">The software can then resubmit the operation.</span></span> <span data-ttu-id="ddd3a-134">Esse processo pode ser repetido até que o TBS obtenha um identificador de chave exclusivo.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-134">This process can be repeated until the TBS gets a unique key handle.</span></span>

-   <span data-ttu-id="ddd3a-135">Limpando chaves</span><span class="sxs-lookup"><span data-stu-id="ddd3a-135">Clearing Keys</span></span>

    <span data-ttu-id="ddd3a-136">O TBS invalida o identificador de chave virtual quando recebe uma mensagem de FlushSpecific do TPM \_ ou TPM2 \_ FlushContext para esse identificador virtual do contexto do cliente.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-136">The TBS invalidates the virtual key handle when it receives a TPM\_FlushSpecific or TPM2\_FlushContext message for that virtual handle from the client context.</span></span> <span data-ttu-id="ddd3a-137">Se a chave estiver fisicamente presente no TPM quando a mensagem de liberação for recebida, o TBS liberará a chave do TPM nesse momento.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-137">If the key is physically present on the TPM when the flush message is received, the TBS flushes the key from the TPM at that time.</span></span>

-   <span data-ttu-id="ddd3a-138">Removendo chaves temporariamente</span><span class="sxs-lookup"><span data-stu-id="ddd3a-138">Temporarily Removing Keys</span></span>

    <span data-ttu-id="ddd3a-139">Ao remover uma chave do TPM para liberar espaço para um novo item, o TBS executa um \_ comando TPM SaveContext ou TPM2 \_ ContextSave na chave antes de removê-lo.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-139">When evicting a key from the TPM to make room for a new item, the TBS executes a TPM\_SaveContext or TPM2\_ContextSave command on the key before evicting it.</span></span>

-   <span data-ttu-id="ddd3a-140">Restaurando chaves</span><span class="sxs-lookup"><span data-stu-id="ddd3a-140">Restoring Keys</span></span>

    <span data-ttu-id="ddd3a-141">Quando um comando que faz referência a uma chave carregada é enviado para o TBS, ele garante que a chave esteja fisicamente presente no TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-141">When a command that references a loaded key is submitted to the TBS, it ensures that the key is physically present on the TPM.</span></span> <span data-ttu-id="ddd3a-142">Se a chave não estiver presente, o TBS a restaurará com uma chamada para \_ Loadcontext do TPM ou TPM2 \_ ContextLoad.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-142">If the key is not present, the TBS restores it with a call to TPM\_LoadContext or TPM2\_ContextLoad.</span></span> <span data-ttu-id="ddd3a-143">Se uma chave não puder ser restaurada para o TPM, o TBS retornará um manipulador de chaves do TPM \_ E \_ inválido \_ como resultado do TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-143">If a key cannot be restored to the TPM, the TBS returns TPM\_E\_INVALID\_KEYHANDLE as the TPM result.</span></span>

<span data-ttu-id="ddd3a-144">O TBS substitui cada identificador virtual associado a uma chave em um fluxo de comando pelo identificador físico da chave carregada no TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-144">The TBS replaces each virtual handle associated with a key in a command stream with the physical handle of the key loaded on the TPM.</span></span> <span data-ttu-id="ddd3a-145">Se um comando for enviado com um identificador virtual que não é reconhecido pelo TBS no contexto do chamador, o TBS formatará um fluxo de erro para o chamador com o \_ manipulador de \_ keyHandle inválido E o TPM \_ .</span><span class="sxs-lookup"><span data-stu-id="ddd3a-145">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller with TPM\_E\_INVALID\_KEYHANDLE.</span></span>

## <a name="authorization-sessions"></a><span data-ttu-id="ddd3a-146">Sessões de autorização</span><span class="sxs-lookup"><span data-stu-id="ddd3a-146">Authorization Sessions</span></span>

<span data-ttu-id="ddd3a-147">As sessões de autorização são criadas chamando o TPM \_ OIAP, TPM \_ oSAP ou TPM \_ DSAP.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-147">Authorization sessions are created by calling TPM\_OIAP, TPM\_OSAP, or TPM\_DSAP.</span></span> <span data-ttu-id="ddd3a-148">Em cada caso, o fluxo de bytes de retorno contém o identificador de TPM físico da sessão de autorização criada recentemente.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-148">In each case, the return byte stream contains the physical TPM handle of the newly created authorization session.</span></span> <span data-ttu-id="ddd3a-149">O TBS substitui isso por um identificador virtual.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-149">The TBS replaces this with a virtual handle.</span></span> <span data-ttu-id="ddd3a-150">Quando a sessão de autorização é referenciada posteriormente, o TBS substitui o identificador virtual no fluxo de comando pelo identificador físico da sessão de autorização.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-150">When the authorization session is subsequently referenced, the TBS replaces the virtual handle in the command stream with the physical handle of the authorization session.</span></span> <span data-ttu-id="ddd3a-151">O TBS garante que o tempo de vida da sessão de autorização virtual corresponda ao da sessão de autorização física.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-151">The TBS ensures that the lifetime of the virtual authorization session matches that of the physical authorization session.</span></span> <span data-ttu-id="ddd3a-152">Se um cliente tentar usar um identificador virtual expirado, o TBS formatará um fluxo de erro com o erro TPM \_ INVALIDAUTHHANDLE.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-152">If a client attempts to use an expired virtual handle, the TBS formats an error stream with error TPM\_INVALIDAUTHHANDLE.</span></span>

<span data-ttu-id="ddd3a-153">Os slots de sessão são limitados e os TBS podem ficar sem Slots externos para salvar contextos de sessão de autorização.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-153">Session slots are limited, and the TBS may run out of external slots in which to save authorization session contexts.</span></span> <span data-ttu-id="ddd3a-154">Se isso acontecer, o TBS escolherá uma sessão de autorização para invalidar, de modo que o novo contexto possa ser salvo com êxito.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-154">If this happens, the TBS chooses an authorization session to invalidate so that the new context can be successfully saved.</span></span> <span data-ttu-id="ddd3a-155">Um aplicativo que tenta usar o contexto antigo precisará recriar a sessão de autorização.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-155">An application that attempts to use the old context will need to re-create the authorization session.</span></span>

<span data-ttu-id="ddd3a-156">O TBS invalida a sessão de autorização virtual quando ocorre um dos seguintes casos:</span><span class="sxs-lookup"><span data-stu-id="ddd3a-156">The TBS invalidates the virtual authorization session when any of the following cases occur:</span></span>

-   <span data-ttu-id="ddd3a-157">O sinalizador continue-use associado à sessão de autorização no fluxo de comando retornado do TPM é **false**.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-157">The continue-use flag associated with the authorization session in the returned command stream from the TPM is **FALSE**.</span></span>
-   <span data-ttu-id="ddd3a-158">Um comando que usa uma sessão de autorização falha.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-158">A command that uses an authorization session fails.</span></span>
-   <span data-ttu-id="ddd3a-159">É executado um comando que invalida a sessão de autorização associada ao comando (como TPM \_ CreateWrapKey).</span><span class="sxs-lookup"><span data-stu-id="ddd3a-159">A command is executed that invalidates the authorization session associated with the command (such as TPM\_CreateWrapKey).</span></span>
-   <span data-ttu-id="ddd3a-160">Uma chave associada a uma sessão OSAP ou DSAP é removida do TPM com uma chamada para o TPM \_ FlushSpecific ou TPM2 \_ FlushContext (sem considerar se esse comando foi originado no TBS ou com um software de nível superior).</span><span class="sxs-lookup"><span data-stu-id="ddd3a-160">A key associated with an OSAP or DSAP session is evicted from the TPM with a call to TPM\_FlushSpecific or TPM2\_FlushContext (without regard to whether this command originated with the TBS or with higher-level software).</span></span>

    <span data-ttu-id="ddd3a-161">O TBS ressincronizará automaticamente as sessões de autorização após a execução bem-sucedida de determinados comandos não determinísticos para garantir que o estado TBS permaneça consistente com o estado do TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-161">The TBS will automatically resynchronize the authorization sessions after successful execution of certain nondeterministic commands to ensure that the TBS state remains consistent with the TPM state.</span></span> <span data-ttu-id="ddd3a-162">Os comandos afetados são:</span><span class="sxs-lookup"><span data-stu-id="ddd3a-162">The affected commands are:</span></span>

    -   <span data-ttu-id="ddd3a-163">Gerenciar o delegado do TPM \_ Ord \_ \_</span><span class="sxs-lookup"><span data-stu-id="ddd3a-163">TPM\_ORD\_Delegate\_Manage</span></span>
    -   <span data-ttu-id="ddd3a-164">\_ \_ CreateOwnerDelegation delegado do TPM Ord \_</span><span class="sxs-lookup"><span data-stu-id="ddd3a-164">TPM\_ORD\_Delegate\_CreateOwnerDelegation</span></span>
    -   <span data-ttu-id="ddd3a-165">\_ \_ LoadOwnerDelegation delegado do TPM Ord \_</span><span class="sxs-lookup"><span data-stu-id="ddd3a-165">TPM\_ORD\_Delegate\_LoadOwnerDelegation</span></span>

<span data-ttu-id="ddd3a-166">Em cada um dos casos a seguir, a sessão de autorização no TPM é liberada automaticamente pelo TPM:</span><span class="sxs-lookup"><span data-stu-id="ddd3a-166">In each of the following cases the authorization session on the TPM is flushed automatically by the TPM:</span></span>

-   <span data-ttu-id="ddd3a-167">Criando sessões de autorização</span><span class="sxs-lookup"><span data-stu-id="ddd3a-167">Creating Authorization Sessions</span></span>

    <span data-ttu-id="ddd3a-168">Os identificadores de sessão de autorização virtual são válidos apenas no contexto que os criou e os recursos associados não são preservados além da vida útil do contexto associado.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-168">Virtual authorization session handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the associated context.</span></span>

-   <span data-ttu-id="ddd3a-169">Limpando sessões de autorização</span><span class="sxs-lookup"><span data-stu-id="ddd3a-169">Clearing Authorization Sessions</span></span>

    <span data-ttu-id="ddd3a-170">O TBS invalida a sessão de autorização virtual se receber um \_ comando FlushSpecific do TPM ou TPM2 \_ FlushContext para o identificador virtual do contexto do cliente.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-170">The TBS invalidates the virtual authorization session if it receives a TPM\_FlushSpecific or TPM2\_FlushContext command for the virtual handle from the client context.</span></span> <span data-ttu-id="ddd3a-171">Se a sessão de autorização estiver fisicamente presente no TPM quando o comando flush for recebido, o TBS liberará a sessão física do TPM imediatamente.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-171">If the authorization session is physically present on the TPM when the flush command is received, the TBS flushes the physical session from the TPM immediately.</span></span>

-   <span data-ttu-id="ddd3a-172">Removendo sessões de autorização temporariamente</span><span class="sxs-lookup"><span data-stu-id="ddd3a-172">Temporarily Removing Authorization Sessions</span></span>

    <span data-ttu-id="ddd3a-173">Ao remover uma sessão de autorização do TPM para liberar espaço para uma nova entidade, o TBS executa o TPM \_ SaveContext ou o TPM2 \_ ContextSave nessa sessão de autorização.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-173">When evicting an authorization session from the TPM to make room for a new entity, the TBS executes TPM\_SaveContext or TPM2\_ContextSave on that authorization session.</span></span>

-   <span data-ttu-id="ddd3a-174">Restaurando sessões de autorização</span><span class="sxs-lookup"><span data-stu-id="ddd3a-174">Restoring Authorization Sessions</span></span>

    <span data-ttu-id="ddd3a-175">Quando um comando TPM autorizado é enviado para o TBS, o TBS garante que todas as sessões de autorização virtual referenciadas no comando estejam fisicamente presentes no TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-175">When an authorized TPM command is submitted to the TBS, the TBS ensures that all virtual authorization sessions referred to in the command are physically present on the TPM.</span></span> <span data-ttu-id="ddd3a-176">Se qualquer uma das sessões de autorização não estiver presente, o TBS as restaurará com uma chamada para \_ Loadcontext do TPM ou TPM2 \_ ContextLoad.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-176">If any of the authorization sessions are not present, the TBS restores them with a call to TPM\_LoadContext or TPM2\_ContextLoad.</span></span> <span data-ttu-id="ddd3a-177">Se uma sessão de autorização não puder ser restaurada para o TPM, o TBS retornará um \_ \_ identificador de TPM E inválido \_ como o resultado do TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-177">If an authorization session cannot be restored to the TPM, the TBS returns TPM\_E\_INVALID\_HANDLE as the TPM result.</span></span>

<span data-ttu-id="ddd3a-178">O TBS substitui cada identificador virtual associado a uma sessão de autorização em um fluxo de comando com o identificador físico da sessão de autorização carregada no TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-178">The TBS replaces each virtual handle associated with an authorization session in a command stream with the physical handle of the authorization session loaded on the TPM.</span></span>

<span data-ttu-id="ddd3a-179">Se um comando for enviado com um identificador virtual que não é reconhecido pelo TBS no contexto do chamador, o TBS formatará um fluxo de erro para o chamador com o manipulador do TPM \_ E \_ o \_ identificador inválido.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-179">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller with the error TPM\_E\_INVALID\_HANDLE.</span></span>

## <a name="transport-sessions"></a><span data-ttu-id="ddd3a-180">Sessões de transporte</span><span class="sxs-lookup"><span data-stu-id="ddd3a-180">Transport Sessions</span></span>

> [!Note]  
> <span data-ttu-id="ddd3a-181">A manipulação de sessões de transporte, conforme descrito aqui, é específica para o Windows Vista e o Windows Server 2008.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-181">The handling of transport sessions as described here is specific to Windows Vista and Windows Server 2008.</span></span>

 

<span data-ttu-id="ddd3a-182">As sessões de transporte são um mecanismo fornecido pelo TPM que permite que uma pilha de software criptografe dados em um comando enquanto ele passa entre o software e o TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-182">Transport sessions are a mechanism provided by the TPM that enables a software stack to encrypt data in a command as it passes between the software and the TPM.</span></span> <span data-ttu-id="ddd3a-183">Isso impede que um adversário intercepte os dados conforme eles passam pelo barramento de hardware.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-183">This prevents an adversary from intercepting the data as it passes over the hardware bus.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="ddd3a-184">Somente os dados de carga são criptografados.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-184">Only the payload data is encrypted.</span></span> <span data-ttu-id="ddd3a-185">Os comandos que estão sendo executados ainda podem ser identificados.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-185">The commands being executed can still be identified.</span></span>

 

<span data-ttu-id="ddd3a-186">Infelizmente, esse mecanismo também impede que os TBS examinem os dados de carga.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-186">Unfortunately, this mechanism also prevents the TBS from examining payload data.</span></span> <span data-ttu-id="ddd3a-187">Na maioria dos casos, isso não é um problema porque o TBS modifica apenas os identificadores, não os dados de carga.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-187">In most cases this is not an issue because the TBS only modifies handles, not payload data.</span></span> <span data-ttu-id="ddd3a-188">No entanto, no caso do TPM \_ loadcontext, por exemplo, o identificador de recurso retornado é coberto pela criptografia.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-188">However, in the case of TPM\_LoadContext for instance, the returned resource handle is covered by the encryption.</span></span> <span data-ttu-id="ddd3a-189">Portanto, o TBS impede tentativas de executar uma \_ operação Loadcontext do TPM coberta por uma sessão de transporte.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-189">Therefore, the TBS prevents attempts to perform a TPM\_LoadContext operation covered by a transport session.</span></span>

<span data-ttu-id="ddd3a-190">O TBS bloqueia os seguintes comandos na sessão de transporte:</span><span class="sxs-lookup"><span data-stu-id="ddd3a-190">The TBS blocks the following commands under transport session:</span></span>

-   <span data-ttu-id="ddd3a-191">\_ESTABLISHTRANSPORT TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-191">TPM\_EstablishTransport</span></span>
-   <span data-ttu-id="ddd3a-192">\_EXECUTETRANSPORT TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-192">TPM\_ExecuteTransport</span></span>
-   <span data-ttu-id="ddd3a-193">\_Identificador de término do TPM \_</span><span class="sxs-lookup"><span data-stu-id="ddd3a-193">TPM\_Terminate\_Handle</span></span>
-   <span data-ttu-id="ddd3a-194">\_LOADKEY TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-194">TPM\_LoadKey</span></span>
-   <span data-ttu-id="ddd3a-195">\_EVICTKEY TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-195">TPM\_EvictKey</span></span>
-   <span data-ttu-id="ddd3a-196">\_SAVEKEYCONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-196">TPM\_SaveKeyContext</span></span>
-   <span data-ttu-id="ddd3a-197">\_LOADKEYCONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-197">TPM\_LoadKeyContext</span></span>
-   <span data-ttu-id="ddd3a-198">\_SAVEAUTHCONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-198">TPM\_SaveAuthContext</span></span>
-   <span data-ttu-id="ddd3a-199">\_LOADAUTHCONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-199">TPM\_LoadAuthContext</span></span>
-   <span data-ttu-id="ddd3a-200">\_SAVECONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-200">TPM\_SaveContext</span></span>
-   <span data-ttu-id="ddd3a-201">Contexto loadtpm \_</span><span class="sxs-lookup"><span data-stu-id="ddd3a-201">TPM\_LoadContext</span></span>
-   <span data-ttu-id="ddd3a-202">\_FLUSHSPECIFIC TPM</span><span class="sxs-lookup"><span data-stu-id="ddd3a-202">TPM\_FlushSpecific</span></span>

<span data-ttu-id="ddd3a-203">Quando qualquer um desses comandos é coberto por uma sessão de transporte, o TBS retorna o \_ comando TPM E \_ Embedded \_ \_ sem suporte como resultado do TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-203">When any one of these commands is covered by a transport session, the TBS returns TPM\_E\_EMBEDDED\_COMMAND\_UNSUPPORTED as the TPM result.</span></span>

<span data-ttu-id="ddd3a-204">Os identificadores de sessão de transporte são virtualizados de maneira semelhante a identificadores de chave e identificadores de autorização.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-204">Transport session handles are virtualized in a manner similar to key handles and authorization handles.</span></span> <span data-ttu-id="ddd3a-205">Há um número limitado de Slots de contexto de sessão de transporte salvos disponíveis no TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-205">There are a limited number of saved transport session context slots available on the TPM.</span></span>

<span data-ttu-id="ddd3a-206">O TBS invalida a sessão de transporte virtual se qualquer um dos seguintes casos ocorrer:</span><span class="sxs-lookup"><span data-stu-id="ddd3a-206">The TBS invalidates the virtual transport session if any of the following cases occurs:</span></span>

-   <span data-ttu-id="ddd3a-207">O sinalizador continue-use associado à sessão de transporte no fluxo de comando de retorno do TPM é **false**.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-207">The continue-use flag associated with the transport session in the return command stream from the TPM is **FALSE**.</span></span>

    <span data-ttu-id="ddd3a-208">Assim como nas sessões de autorização acima, o TBS ressincronizará automaticamente as sessões de transporte após a execução bem-sucedida de determinados comandos não determinísticos para garantir que o estado TBS permaneça consistente com o estado do TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-208">As with authorization sessions above, the TBS will automatically resynchronize transport sessions after successful execution of certain nondeterministic commands to ensure that the TBS state remains consistent with the TPM state.</span></span> <span data-ttu-id="ddd3a-209">Os comandos afetados são:</span><span class="sxs-lookup"><span data-stu-id="ddd3a-209">The affected commands are:</span></span>

    -   <span data-ttu-id="ddd3a-210">Gerenciar o delegado do TPM \_ Ord \_ \_</span><span class="sxs-lookup"><span data-stu-id="ddd3a-210">TPM\_ORD\_Delegate\_Manage</span></span>
    -   <span data-ttu-id="ddd3a-211">\_ \_ CreateOwnerDelegation delegado do TPM Ord \_</span><span class="sxs-lookup"><span data-stu-id="ddd3a-211">TPM\_ORD\_Delegate\_CreateOwnerDelegation</span></span>
    -   <span data-ttu-id="ddd3a-212">\_ \_ LoadOwnerDelegation delegado do TPM Ord \_</span><span class="sxs-lookup"><span data-stu-id="ddd3a-212">TPM\_ORD\_Delegate\_LoadOwnerDelegation</span></span>

<span data-ttu-id="ddd3a-213">Em cada um desses casos, a sessão de transporte no TPM será liberada automaticamente pelo TPM:</span><span class="sxs-lookup"><span data-stu-id="ddd3a-213">In each of these cases, the transport session on the TPM will be flushed automatically by the TPM:</span></span>

-   <span data-ttu-id="ddd3a-214">Criando sessões de transporte</span><span class="sxs-lookup"><span data-stu-id="ddd3a-214">Creating Transport Sessions</span></span>

    <span data-ttu-id="ddd3a-215">O TBS cria um identificador virtual para cada sessão de transporte criada por um cliente.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-215">The TBS creates a virtual handle for each transport session created by a client.</span></span> <span data-ttu-id="ddd3a-216">Os identificadores de transporte virtual são válidos apenas no contexto que os criou, e os recursos associados não são preservados além da vida útil do contexto associado.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-216">Virtual transport handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the associated context.</span></span>

-   <span data-ttu-id="ddd3a-217">Limpando sessões de transporte</span><span class="sxs-lookup"><span data-stu-id="ddd3a-217">Clearing Transport Sessions</span></span>

    <span data-ttu-id="ddd3a-218">O TBS invalida a sessão de transporte virtual se receber um \_ comando FlushSpecific do TPM para o identificador virtual do contexto do cliente.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-218">The TBS invalidates the virtual transport session if it receives a TPM\_FlushSpecific command for the virtual handle from the client context.</span></span> <span data-ttu-id="ddd3a-219">Se a sessão de transporte estiver fisicamente presente no TPM quando o comando flush for recebido, o TBS liberará a sessão física do TPM imediatamente.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-219">If the transport session is physically present on the TPM when the flush command is received, the TBS flushes the physical session from the TPM immediately.</span></span>

-   <span data-ttu-id="ddd3a-220">Removendo sessões de transporte temporariamente</span><span class="sxs-lookup"><span data-stu-id="ddd3a-220">Temporarily Removing Transport Sessions</span></span>

    <span data-ttu-id="ddd3a-221">Ao remover uma sessão de transporte do TPM para liberar espaço para uma nova entidade, o TBS executa o \_ SaveContext do TPM nessa sessão de transporte.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-221">When evicting a transport session from the TPM to make room for a new entity, the TBS executes TPM\_SaveContext on that transport session.</span></span>

-   <span data-ttu-id="ddd3a-222">Restaurando sessões de transporte</span><span class="sxs-lookup"><span data-stu-id="ddd3a-222">Restoring Transport Sessions</span></span>

    <span data-ttu-id="ddd3a-223">Quando um \_ comando ExecuteTransport do TPM é enviado para o TBS, o TBS garante que a sessão de transporte referida no comando esteja fisicamente presente no TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-223">When a TPM\_ExecuteTransport command is submitted to the TBS, the TBS ensures that the transport session referred to in the command is physically present on the TPM.</span></span> <span data-ttu-id="ddd3a-224">Se a sessão de transporte não estiver presente, o TBS a restaurará com uma chamada para \_ Loadcontext do TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-224">If the transport session is not present, the TBS restores it with a call to TPM\_LoadContext.</span></span>

<span data-ttu-id="ddd3a-225">O TBS substitui o identificador virtual associado à sessão de transporte em um fluxo de comando pelo identificador físico da sessão de transporte carregada no TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-225">The TBS replaces the virtual handle associated with the transport session in a command stream with the physical handle of the transport session loaded on the TPM.</span></span> <span data-ttu-id="ddd3a-226">Se um comando for enviado com um identificador virtual que não é reconhecido pelo TBS no contexto do chamador, o TBS formata um fluxo de erro para o chamador usando o TPM E o \_ \_ identificador inválido \_ .</span><span class="sxs-lookup"><span data-stu-id="ddd3a-226">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller by using TPM\_E\_INVALID\_HANDLE.</span></span>

## <a name="exclusive-transport-sessions"></a><span data-ttu-id="ddd3a-227">Sessões de transporte exclusivas</span><span class="sxs-lookup"><span data-stu-id="ddd3a-227">Exclusive Transport Sessions</span></span>

<span data-ttu-id="ddd3a-228">As sessões de transporte encapsuladas exclusivas são uma maneira para o software de nível superior determinar se algum outro software acessou o TPM durante uma cadeia de comandos.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-228">Exclusive wrapped transport sessions are a way for top-level software to determine whether any other software has accessed the TPM during a chain of commands.</span></span> <span data-ttu-id="ddd3a-229">Eles não impedem que outro software acesse o TPM, basta dar ao criador da sessão de transporte um meio de determinar que algum outro acesso ocorreu.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-229">They do not prevent other software from accessing the TPM, they just give the creator of the transport session a means of determining that some other access occurred.</span></span> <span data-ttu-id="ddd3a-230">O TBS não faz nada específico para impedir sessões de transporte exclusivas, mas é um pouco compatível com elas.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-230">The TBS does not do anything specific to hinder exclusive transport sessions, but it is somewhat incompatible with them.</span></span> <span data-ttu-id="ddd3a-231">O TBS tenta duplicar o comportamento natural do TPM, sendo transparente, de modo que não favorece comandos de contextos que estabelecem uma sessão de transporte exclusiva.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-231">The TBS attempts to duplicate the natural behavior of the TPM by being transparent, so it does not favor commands from contexts that establish an exclusive transport session.</span></span> <span data-ttu-id="ddd3a-232">Por exemplo, se o cliente B enviar um comando quando o cliente A estiver em uma sessão de transporte exclusiva, ele invalidará a sessão de transporte exclusiva do cliente A.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-232">For example, if client B submits a command when client A is in an exclusive transport session, then it will invalidate the exclusive transport session of client A.</span></span>

<span data-ttu-id="ddd3a-233">Os comandos iniciados por TBS também podem encerrar a sessão de transporte exclusiva.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-233">Commands initiated by TBS can also terminate the exclusive transport session.</span></span> <span data-ttu-id="ddd3a-234">Isso acontece quando o cliente A está em uma sessão de transporte exclusiva e um comando executado pelo cliente A chama um recurso que não está fisicamente presente no TPM.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-234">This happens when client A is in an exclusive transport session, and a command executed by client A calls for a resource that is not physically present in the TPM.</span></span> <span data-ttu-id="ddd3a-235">Essa situação dispara o Gerenciador de virtualização de TBS para executar um \_ comando Loadcontext do TPM para fornecer esse recurso, que encerra a sessão de transporte exclusiva do cliente a.</span><span class="sxs-lookup"><span data-stu-id="ddd3a-235">This situation triggers the TBS virtualization manager to execute a TPM\_LoadContext command to supply that resource, which terminates the exclusive transport session of client A.</span></span>

 

 




