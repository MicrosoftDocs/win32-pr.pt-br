---
description: O ws2 \_32.dll carrega a DLL de interface do provedor de serviços no sistema usando os mecanismos padrão de carregamento da biblioteca dinâmica do Microsoft Windows e inicializa-o chamando WSPStartup.
ms.assetid: 6df28d93-8757-45b3-8f05-86381c3be64e
title: Inicialização
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 84d6ef10db421ef15f2bb94eb67e96fc2cfc5924
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "105772990"
---
# <a name="initialization"></a><span data-ttu-id="ee58d-103">Inicialização</span><span class="sxs-lookup"><span data-stu-id="ee58d-103">Initialization</span></span>

<span data-ttu-id="ee58d-104">O *Ws2 \_32.dll* carrega a DLL de interface do provedor de serviços no sistema usando os mecanismos padrão de carregamento da biblioteca dinâmica do Microsoft Windows e inicializa-o chamando [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span><span class="sxs-lookup"><span data-stu-id="ee58d-104">The *Ws2\_32.dll* loads the service provider's interface DLL into the system by using the standard Microsoft Windows dynamic library loading mechanisms, and initializes it by calling [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="ee58d-105">Normalmente, isso é disparado por um aplicativo chamando [**Socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) ou [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) para criar um novo soquete a ser associado a um provedor de serviços cuja dll de interface não esteja atualmente carregada na memória.</span><span class="sxs-lookup"><span data-stu-id="ee58d-105">This is typically triggered by an application calling either [**socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) or [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) to create a new socket to be associated with a service provider whose interface DLL is not currently loaded into memory.</span></span> <span data-ttu-id="ee58d-106">O caminho para a DLL de interface do provedor de serviços é armazenado *pelo \_32.dllWs2* no momento em que o provedor de serviços está sendo instalado.</span><span class="sxs-lookup"><span data-stu-id="ee58d-106">The path to each service provider's interface DLL is stored by the *Ws2\_32.dll* at the time the service provider is being installed.</span></span> <span data-ttu-id="ee58d-107">Confira [funções de instalação e configuração](installation-and-configuration-functions-2.md) para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="ee58d-107">See [Installation and Configuration Functions](installation-and-configuration-functions-2.md) for more information.</span></span>

<span data-ttu-id="ee58d-108">Ao longo do tempo, podem existir versões diferentes para as DLLs, os aplicativos e os provedores de serviços do Winsock.</span><span class="sxs-lookup"><span data-stu-id="ee58d-108">Over time, different versions may exist for the Winsock DLLs, applications, and service providers.</span></span> <span data-ttu-id="ee58d-109">Novas versões podem definir novos recursos e novos parâmetros para estruturas de dados e parâmetros de bits, etc. Portanto, os números de versão indicam como interpretar várias estruturas de dados.</span><span class="sxs-lookup"><span data-stu-id="ee58d-109">New versions may define new features and new parameters to data structures and bit parameters, etc. Version numbers therefore indicate how to interpret various data structures.</span></span>

<span data-ttu-id="ee58d-110">Para permitir a combinação ideal e a correspondência de diferentes versões de aplicativos, versões do ws2 \_32.dll si mesma e versões de provedores de serviço por diferentes fornecedores, o SPI fornece um mecanismo de negociação de versão para uso entre o *\_32.dllde ws2* e os provedores de serviços.</span><span class="sxs-lookup"><span data-stu-id="ee58d-110">To allow optimal mixing and matching of different versions of applications, versions of the Ws2\_32.dll itself, and versions of service providers by different vendors, the SPI provides a version negotiation mechanism for use between the *Ws2\_32.dll* and the service providers.</span></span> <span data-ttu-id="ee58d-111">Essa negociação de versão é tratada pelo [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span><span class="sxs-lookup"><span data-stu-id="ee58d-111">This version negotiation is handled by [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="ee58d-112">Basicamente, o *\_32.dllWs2* passa para o provedor de serviços os números de versão mais altos com os quais ele é compatível.</span><span class="sxs-lookup"><span data-stu-id="ee58d-112">Basically, the *Ws2\_32.dll* passes to the service provider the highest version numbers with which it is compatible.</span></span> <span data-ttu-id="ee58d-113">O provedor de serviços compara isso com seu próprio intervalo de números de versão com suporte.</span><span class="sxs-lookup"><span data-stu-id="ee58d-113">The service provider compares this with its own supported range of version numbers.</span></span> <span data-ttu-id="ee58d-114">Se esses intervalos se sobrepõem, o provedor de serviços retorna um valor dentro da parte sobreposta do intervalo como o resultado da negociação.</span><span class="sxs-lookup"><span data-stu-id="ee58d-114">If these ranges overlap, the service provider returns a value within the overlapping portion of the range as the result of the negotiation.</span></span> <span data-ttu-id="ee58d-115">Normalmente, isso deve ser o maior valor possível.</span><span class="sxs-lookup"><span data-stu-id="ee58d-115">Usually, this should be the highest possible value.</span></span> <span data-ttu-id="ee58d-116">Se os intervalos não se sobrepõem, as duas partes são incompatíveis e a função retorna um erro.</span><span class="sxs-lookup"><span data-stu-id="ee58d-116">If the ranges do not overlap, the two parties are incompatible and the function returns an error.</span></span>

<span data-ttu-id="ee58d-117">[**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) deve ser chamado pelo menos uma vez por cada processo de cliente e pode ser chamado várias vezes por Ws2 \_32.dll ou outras entidades.</span><span class="sxs-lookup"><span data-stu-id="ee58d-117">[**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) must be called at least once by each client process, and may be called multiple times by Ws2\_32.dll or other entities.</span></span> <span data-ttu-id="ee58d-118">Um [**WSPCleanup**](/previous-versions/windows/hardware/network/ff566270(v=vs.85)) correspondente deve ser chamado para cada chamada **WSPStartup** bem-sucedida.</span><span class="sxs-lookup"><span data-stu-id="ee58d-118">A matching [**WSPCleanup**](/previous-versions/windows/hardware/network/ff566270(v=vs.85)) must be called for each successful **WSPStartup** call.</span></span> <span data-ttu-id="ee58d-119">O provedor de serviços deve manter uma contagem de referência em cada processo.</span><span class="sxs-lookup"><span data-stu-id="ee58d-119">The service provider should maintain a reference count on a per-process basis.</span></span> <span data-ttu-id="ee58d-120">Em cada chamada de **WSPStartup** , o chamador pode especificar qualquer número de versão com suporte na DLL do SP.</span><span class="sxs-lookup"><span data-stu-id="ee58d-120">On each **WSPStartup** call, the caller may specify any version number supported by the SP DLL.</span></span>

<span data-ttu-id="ee58d-121">Um provedor de serviços deve armazenar o ponteiro para a tabela de expedição de chamada do cliente que é recebida como um parâmetro [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) por processo.</span><span class="sxs-lookup"><span data-stu-id="ee58d-121">A service provider must store the pointer to the client's upcall dispatch table that is received as a [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) parameter on a per-process basis.</span></span> <span data-ttu-id="ee58d-122">Se um determinado processo chamar **WSPStartup** várias vezes, o provedor de serviços deverá usar apenas o ponteiro de tabela de expedição fornecido mais recentemente.</span><span class="sxs-lookup"><span data-stu-id="ee58d-122">If a given process calls **WSPStartup** multiple times, the service provider must use only the most recently supplied dispatch table pointer.</span></span>

<span data-ttu-id="ee58d-123">Como parte do processo de inicialização do provedor de serviços, o ws2 \_32.dll recupera a tabela de expedição do provedor de serviços por meio do parâmetro *lpProcTable* para obter pontos de entrada para o restante das funções SPI especificadas neste documento.</span><span class="sxs-lookup"><span data-stu-id="ee58d-123">As part of the service provider initialization process The Ws2\_32.dll retrieves the service provider's dispatch table through the *lpProcTable* parameter in order to obtain entry points to the rest of the SPI functions specified in this document.</span></span>

<span data-ttu-id="ee58d-124">Usar uma tabela de expedição (ao contrário dos mecanismos de DLL usuais para acessar pontos de entrada) atende a duas finalidades:</span><span class="sxs-lookup"><span data-stu-id="ee58d-124">Using a dispatch table (as opposed to the usual DLL mechanisms for accessing entry points) serves two purposes:</span></span>

-   <span data-ttu-id="ee58d-125">É mais conveniente para a32.dll Ws2 \_ , já que uma única chamada pode ser feita para descobrir o conjunto inteiro de pontos de entrada.</span><span class="sxs-lookup"><span data-stu-id="ee58d-125">It is more convenient for the Ws2\_32.dll since a single call can be made to discover the entire set of entry points.</span></span>
-   <span data-ttu-id="ee58d-126">Ele permite que provedores de serviço em camadas formados em cadeias de protocolos operem com mais eficiência.</span><span class="sxs-lookup"><span data-stu-id="ee58d-126">It enables layered service providers formed into protocol chains to operate more efficiently.</span></span>

## <a name="initializing-protocol-chains"></a><span data-ttu-id="ee58d-127">Inicializando cadeias de protocolo</span><span class="sxs-lookup"><span data-stu-id="ee58d-127">Initializing Protocol Chains</span></span>

<span data-ttu-id="ee58d-128">No momento em que a estrutura de [**\_ informações de WSAPROTOCOL**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) para uma cadeia de protocolos é instalada, o caminho para o primeiro provedor em camadas na cadeia também é especificado.</span><span class="sxs-lookup"><span data-stu-id="ee58d-128">At the time the [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure for a protocol chain is installed, the path to the first layered provider in the chain is also specified.</span></span> <span data-ttu-id="ee58d-129">Quando uma cadeia de protocolos é inicializada, o \_32.dll Ws2 usa esse caminho para carregar a DLL do provedor e, em seguida, invoca [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span><span class="sxs-lookup"><span data-stu-id="ee58d-129">When a protocol chain is initialized, the Ws2\_32.dll uses this path to load the provider DLL and then invokes [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="ee58d-130">Como o **WSPStartup** inclui um ponteiro para a estrutura **de \_ informações do WSAPROTOCOL** da cadeia como um de seus parâmetros, os provedores em camadas podem determinar em que tipo de cadeia eles estão sendo inicializados e a identidade da próxima camada inferior na cadeia.</span><span class="sxs-lookup"><span data-stu-id="ee58d-130">Since **WSPStartup** includes a pointer to the chain's **WSAPROTOCOL\_INFO** structure as one of its parameters, layered providers can determine what type of chain they are being initialized into, and the identity of the next lower layer in the chain.</span></span> <span data-ttu-id="ee58d-131">Um provedor em camadas, por sua vez, carregaria o próximo provedor de protocolo na cadeia e o inicializaria com uma chamada para **WSPStartup** e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="ee58d-131">A layered provider would then in turn load the next protocol provider in the chain and initialize it with a call to **WSPStartup**, and so forth.</span></span> <span data-ttu-id="ee58d-132">Sempre que a próxima camada inferior for outro provedor em camadas, a estrutura **de \_ informações WSAPROTOCOL** da cadeia deverá ser referenciada na chamada **WSPStartup** .</span><span class="sxs-lookup"><span data-stu-id="ee58d-132">Whenever the next lower layer is another layered provider, the chain's **WSAPROTOCOL\_INFO** structure must be referenced in the **WSPStartup** call.</span></span> <span data-ttu-id="ee58d-133">Quando a próxima camada inferior é um protocolo base (que significa o fim da cadeia), a estrutura de **\_ informações WSAPROTOCOL** da cadeia não é mais propagada para baixo.</span><span class="sxs-lookup"><span data-stu-id="ee58d-133">When the next lower layer is a base protocol (signifying the end of the chain), the chain's **WSAPROTOCOL\_INFO** structure is no longer propagated downward.</span></span> <span data-ttu-id="ee58d-134">Em vez disso, a camada atual deve fazer referência a uma estrutura de **\_ informações de WSAPROTOCOL** que corresponde ao protocolo que o provedor base deve usar.</span><span class="sxs-lookup"><span data-stu-id="ee58d-134">Instead, the current layer must reference a **WSAPROTOCOL\_INFO** structure that corresponds to the protocol that the base provider should use.</span></span> <span data-ttu-id="ee58d-135">Portanto, o provedor base não tem nenhuma noção de estar envolvido em uma cadeia de protocolos.</span><span class="sxs-lookup"><span data-stu-id="ee58d-135">Thus, the base provider has no notion of being involved in a protocol chain.</span></span>

<span data-ttu-id="ee58d-136">A tabela de expedição fornecida por qualquer provedor em camadas específico irá, em muitos casos, duplicar os pontos de entrada de um provedor subjacente.</span><span class="sxs-lookup"><span data-stu-id="ee58d-136">The dispatch table provided by any given layered provider will, in many instances, duplicate the entry points of an underlying provider.</span></span> <span data-ttu-id="ee58d-137">O provedor em camadas só inseriria seus próprios pontos de entrada para funções que precisava estar diretamente envolvido no.</span><span class="sxs-lookup"><span data-stu-id="ee58d-137">The layered provider would only insert its own entry points for functions that it needed to be directly involved in.</span></span> <span data-ttu-id="ee58d-138">No entanto, observe que é imperativo que um provedor em camadas não modifique o conteúdo da tabela de chamada recebida ao chamar [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) na próxima camada inferior em uma cadeia de protocolos.</span><span class="sxs-lookup"><span data-stu-id="ee58d-138">Note, however, that it is imperative that a layered provider not modify the contents of the upcall table that it received when calling [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) on the next lower layer in a protocol chain.</span></span> <span data-ttu-id="ee58d-139">Essas chamadas devem ser feitas diretamente para a DLL do Windows Sockets 2.</span><span class="sxs-lookup"><span data-stu-id="ee58d-139">These upcalls must be made directly to the Windows Sockets 2 DLL.</span></span>

 

 
