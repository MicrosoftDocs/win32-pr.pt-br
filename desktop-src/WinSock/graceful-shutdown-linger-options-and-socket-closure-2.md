---
description: O material a seguir é fornecido como esclarecimento para o assunto de desligar conexões de soquete que fecham os soquetes. É importante distinguir a diferença entre desligar uma conexão de soquete e fechar um soquete.
ms.assetid: 383747c3-dd3d-4a18-b4e8-2815d5e5c0c7
title: Desligamento normal, opções persistentes e fechamento de soquete
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 59f6791eaa803da561fc9f3c175b5270950cbec3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104164473"
---
# <a name="graceful-shutdown-linger-options-and-socket-closure"></a><span data-ttu-id="9cd89-104">Desligamento normal, opções persistentes e fechamento de soquete</span><span class="sxs-lookup"><span data-stu-id="9cd89-104">Graceful Shutdown, Linger Options, and Socket Closure</span></span>

<span data-ttu-id="9cd89-105">O material a seguir é fornecido como esclarecimento para o assunto de desligar conexões de soquete que fecham os soquetes.</span><span class="sxs-lookup"><span data-stu-id="9cd89-105">The following material is provided as clarification for the subject of shutting down socket connections closing the sockets.</span></span> <span data-ttu-id="9cd89-106">É importante distinguir a diferença entre desligar uma conexão de soquete e fechar um soquete.</span><span class="sxs-lookup"><span data-stu-id="9cd89-106">It is important to distinguish the difference between shutting down a socket connection and closing a socket.</span></span>

<span data-ttu-id="9cd89-107">Desligar uma conexão de soquete envolve uma troca de mensagens de protocolo entre os dois pontos de extremidade, daqui em diante, chamado de sequência de desligamento.</span><span class="sxs-lookup"><span data-stu-id="9cd89-107">Shutting down a socket connection involves an exchange of protocol messages between the two endpoints, hereafter referred to as a shutdown sequence.</span></span> <span data-ttu-id="9cd89-108">Duas classes gerais de sequências de desligamento são definidas: normal e de anulação (também chamada de difícil).</span><span class="sxs-lookup"><span data-stu-id="9cd89-108">Two general classes of shutdown sequences are defined: graceful and abortive (also called hard).</span></span> <span data-ttu-id="9cd89-109">Em uma sequência de desligamento normal, todos os dados que foram enfileirados, mas ainda não transmitidos, podem ser enviados antes que a conexão seja fechada.</span><span class="sxs-lookup"><span data-stu-id="9cd89-109">In a graceful shutdown sequence, any data that has been queued, but not yet transmitted can be sent prior to the connection being closed.</span></span> <span data-ttu-id="9cd89-110">Em um desligamento anulado, todos os dados não enviados são perdidos.</span><span class="sxs-lookup"><span data-stu-id="9cd89-110">In an abortive shutdown, any unsent data is lost.</span></span> <span data-ttu-id="9cd89-111">A ocorrência de uma sequência de desligamento (normal ou de anulação) também pode ser usada para fornecer uma \_ indicação FD Close para os aplicativos associados, indicando que um desligamento está em andamento.</span><span class="sxs-lookup"><span data-stu-id="9cd89-111">The occurrence of a shutdown sequence (graceful or abortive) can also be used to provide an FD\_CLOSE indication to the associated applications signifying that a shutdown is in progress.</span></span>

<span data-ttu-id="9cd89-112">Fechar um soquete, por outro lado, faz com que o identificador de soquete se torne desalocado para que o aplicativo não possa mais fazer referência ou usar o soquete de forma alguma.</span><span class="sxs-lookup"><span data-stu-id="9cd89-112">Closing a socket, on the other hand, causes the socket handle to become deallocated so that the application can no longer reference or use the socket in any manner.</span></span>

<span data-ttu-id="9cd89-113">No Windows Sockets, a função de [**desligamento**](/windows/desktop/api/winsock/nf-winsock-shutdown) e a função [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) podem ser usadas para iniciar uma sequência de desligamento, enquanto a função [**fechamento**](/windows/desktop/api/winsock/nf-winsock-closesocket) é usada para desalocar identificadores de soquete e liberar todos os recursos associados.</span><span class="sxs-lookup"><span data-stu-id="9cd89-113">In Windows Sockets, both the [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) function, and the [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) function can be used to initiate a shutdown sequence, while the [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) function is used to deallocate socket handles and free up any associated resources.</span></span> <span data-ttu-id="9cd89-114">Uma certa confusão surge, no entanto, do fato de que a função **fechamento** implicitamente faz com que uma sequência de desligamento ocorra caso ainda não tenha ocorrido.</span><span class="sxs-lookup"><span data-stu-id="9cd89-114">Some amount of confusion arises, however, from the fact that the **closesocket** function implicitly causes a shutdown sequence to occur if it has not already happened.</span></span> <span data-ttu-id="9cd89-115">Na verdade, ele se tornou uma prática de programação bastante comum para contar com esse recurso e usar o **fechamento** para iniciar a sequência de desligamento e desalocar o identificador de soquete.</span><span class="sxs-lookup"><span data-stu-id="9cd89-115">In fact, it has become a rather common programming practice to rely on this feature and to use **closesocket** to both initiate the shutdown sequence and deallocate the socket handle.</span></span>

<span data-ttu-id="9cd89-116">Para facilitar esse uso, a interface de soquetes fornece controles por meio do mecanismo de opção de soquete que permite que o programador indique se a sequência de desligamento implícita deve ser normal ou anulada, e também se a função [**fechamento**](/windows/desktop/api/winsock/nf-winsock-closesocket) deve permanecer (não concluída imediatamente) para dar tempo para a conclusão de uma sequência de desligamento normal.</span><span class="sxs-lookup"><span data-stu-id="9cd89-116">To facilitate this usage, the sockets interface provides for controls by way of the socket option mechanism that allow the programmer to indicate whether the implicit shutdown sequence should be graceful or abortive, and also whether the [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) function should linger (that is not complete immediately) to allow time for a graceful shutdown sequence to complete.</span></span> <span data-ttu-id="9cd89-117">Essas distinções importantes e as ramificações de usar **fechamento** dessa maneira ainda não são amplamente compreendidas.</span><span class="sxs-lookup"><span data-stu-id="9cd89-117">These important distinctions and the ramifications of using **closesocket** in this manner are still not widely understood.</span></span>

<span data-ttu-id="9cd89-118">Ao estabelecer os valores apropriados para as opções de soquete, de modo \_ remanescente e, portanto \_ , DONTLINGER, os seguintes tipos de comportamento podem ser obtidos com a função [**fechamento**](/windows/desktop/api/winsock/nf-winsock-closesocket) :</span><span class="sxs-lookup"><span data-stu-id="9cd89-118">By establishing appropriate values for the socket options SO\_LINGER and SO\_DONTLINGER, the following types of behavior can be obtained with the [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) function:</span></span>

-   <span data-ttu-id="9cd89-119">Sequência de desligamento abortada, retorno imediato de [**fechamento**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span><span class="sxs-lookup"><span data-stu-id="9cd89-119">Abortive shutdown sequence, immediate return from [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span></span>
-   <span data-ttu-id="9cd89-120">Desligamento normal, atrasando o retorno até que a sequência de desligamento seja concluída ou um intervalo de tempo especificado decorre.</span><span class="sxs-lookup"><span data-stu-id="9cd89-120">Graceful shutdown, delaying return until either shutdown sequence completes or a specified time interval elapses.</span></span> <span data-ttu-id="9cd89-121">Se o intervalo de tempo expirar antes da conclusão da sequência de desligamento normal, ocorrerá uma sequência de desligamento abortada e [**fechamento**](/windows/desktop/api/winsock/nf-winsock-closesocket) retornará.</span><span class="sxs-lookup"><span data-stu-id="9cd89-121">If the time interval expires before the graceful shutdown sequence completes, an abortive shutdown sequence occurs, and [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) returns.</span></span>
-   <span data-ttu-id="9cd89-122">Desligamento normal, retorno imediato — permitindo que a sequência de desligamento seja concluída em segundo plano.</span><span class="sxs-lookup"><span data-stu-id="9cd89-122">Graceful shutdown, immediate return—allowing the shutdown sequence to complete in the background.</span></span> <span data-ttu-id="9cd89-123">Embora esse seja o comportamento padrão, o aplicativo não tem como saber quando (ou se) a sequência de desligamento normal é realmente concluída.</span><span class="sxs-lookup"><span data-stu-id="9cd89-123">Although this is the default behavior, the application has no way of knowing when (or whether) the graceful shutdown sequence actually completes.</span></span>

<span data-ttu-id="9cd89-124">O uso das opções de \_ soquete de so persistentes e \_ de DONTLINGER e a estrutura [**persistente**](/windows/desktop/api/winsock/ns-winsock-linger) associada é discutida mais detalhadamente nas seções de referência nas opções de [**soquete de \_ soquete de sol**](sol-socket-socket-options.md) e na estrutura **persistente** .</span><span class="sxs-lookup"><span data-stu-id="9cd89-124">The use of the SO\_LINGER and SO\_DONTLINGER socket options and the associated [**linger**](/windows/desktop/api/winsock/ns-winsock-linger) structure is discussed in more detail in the reference sections on [**SOL\_SOCKET Socket Options**](sol-socket-socket-options.md) and the **linger** structure.</span></span>

<span data-ttu-id="9cd89-125">Uma técnica que pode ser usada para minimizar a chance de problemas ocorrendo durante a desmontagem da conexão é evitar depender de um desligamento implícito que está sendo iniciado pelo [**fechamento**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span><span class="sxs-lookup"><span data-stu-id="9cd89-125">One technique that can be used to minimize the chance of problems occurring during connection teardown is to avoid relying on an implicit shutdown being initiated by [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span></span> <span data-ttu-id="9cd89-126">Em vez disso, use uma das duas funções de desligamento explícitas, [**Shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) ou [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect).</span><span class="sxs-lookup"><span data-stu-id="9cd89-126">Instead, use one of the two explicit shutdown functions, [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) or [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect).</span></span> <span data-ttu-id="9cd89-127">Isso, por sua vez, faz com \_ que uma indicação de fechamento FD seja recebida pelo aplicativo par, indicando que todos os dados pendentes foram recebidos.</span><span class="sxs-lookup"><span data-stu-id="9cd89-127">This in turn causes an FD\_CLOSE indication to be received by the peer application indicating that all pending data has been received.</span></span> <span data-ttu-id="9cd89-128">Para ilustrar isso, a tabela a seguir mostra as funções que seriam invocadas pelos componentes do cliente e do servidor de um aplicativo, em que o cliente é responsável por iniciar um desligamento normal.</span><span class="sxs-lookup"><span data-stu-id="9cd89-128">To illustrate this, the following table shows the functions that would be invoked by the client and server components of an application, where the client is responsible for initiating a graceful shutdown.</span></span>

| <span data-ttu-id="9cd89-129">Lado do cliente</span><span class="sxs-lookup"><span data-stu-id="9cd89-129">Client side</span></span>                                                                                                                | <span data-ttu-id="9cd89-130">Lado do Servidor</span><span class="sxs-lookup"><span data-stu-id="9cd89-130">Server side</span></span>                                                                                           |
|----------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="9cd89-131">(1) invoca o [**desligamento**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD \_ Send) para sinalizar o fim da sessão e esse cliente não tem mais dados a serem enviados.</span><span class="sxs-lookup"><span data-stu-id="9cd89-131">(1) Invokes [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD\_SEND) to signal end of session and that client has no more data to send.</span></span> |                                                                                                       |
|                                                                                                                            | <span data-ttu-id="9cd89-132">(2) recebe FD \_ Close, indicando que o desligamento normal está em andamento e que todos os dados foram recebidos.</span><span class="sxs-lookup"><span data-stu-id="9cd89-132">(2) Receives FD\_CLOSE, indicating graceful shutdown in progress and that all data has been received.</span></span> |
|                                                                                                                            | <span data-ttu-id="9cd89-133">(3) envia todos os dados de resposta restantes.</span><span class="sxs-lookup"><span data-stu-id="9cd89-133">(3) Sends any remaining response data.</span></span>                                                                |
| <span data-ttu-id="9cd89-134">(somente significância de tempo local) Obtém o FD \_ Read e chama [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) para obter os dados de resposta enviados pelo servidor.</span><span class="sxs-lookup"><span data-stu-id="9cd89-134">(local timing significance only) Gets FD\_READ and calls [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) to get any response data sent by server .</span></span>  | <span data-ttu-id="9cd89-135">(4) invoca o [**desligamento**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD \_ Send) para indicar que o servidor não tem mais dados a serem enviados.</span><span class="sxs-lookup"><span data-stu-id="9cd89-135">(4) Invokes [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD\_SEND) to indicate server has no more data to send.</span></span>  |
| <span data-ttu-id="9cd89-136">(5) recebe a \_ indicação de fechamento FD.</span><span class="sxs-lookup"><span data-stu-id="9cd89-136">(5) Receives FD\_CLOSE indication.</span></span>                                                                                         | <span data-ttu-id="9cd89-137">(somente significância de tempo local) Invoca [**fechamento**](/windows/desktop/api/winsock/nf-winsock-closesocket) .</span><span class="sxs-lookup"><span data-stu-id="9cd89-137">(local timing significance only) Invokes [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) .</span></span>                       |
| <span data-ttu-id="9cd89-138">(6) invoca [**fechamento**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span><span class="sxs-lookup"><span data-stu-id="9cd89-138">(6) Invokes [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span></span>                                                                          |                                                                                                       |



 

 

 



