---
title: Usando DsAddSidHistory
description: Este tópico descreve como usar a função DsAddSidHistory.
ms.assetid: cbf4983c-551d-4771-870e-a192ed898eb7
ms.tgt_platform: multiple
keywords:
- Usando o DsAddSidHistory Active Directory
- Active Directory Active Directory, usando, usando DsAddSidHistory
- DsAddSidHistory Active Directory, usando
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3d45792dbd8c7a2bfa2dd047111a3ed165a2011e
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/16/2019
ms.locfileid: "103634905"
---
# <a name="using-dsaddsidhistory"></a><span data-ttu-id="2ab96-106">Usando DsAddSidHistory</span><span class="sxs-lookup"><span data-stu-id="2ab96-106">Using DsAddSidHistory</span></span>

<span data-ttu-id="2ab96-107">A função [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) Obtém o Sid (identificador de segurança) da conta primária de uma entidade de segurança de um domínio (o domínio de origem) e o adiciona ao atributo **SIDHistory** de uma entidade de segurança em outro domínio (destino) em uma floresta diferente.</span><span class="sxs-lookup"><span data-stu-id="2ab96-107">The [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) function gets the primary account security identifier (SID) of a security principal from one domain (the source domain) and adds it to the **sIDHistory** attribute of a security principal in another (destination) domain in a different forest.</span></span> <span data-ttu-id="2ab96-108">Quando o domínio de origem está no modo nativo do Windows 2000, essa função também recupera os valores de **SIDHistory** da entidade de segurança e os adiciona ao **SIDHistory** da entidade de segurança de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-108">When the source domain is in Windows 2000 native mode, this function also retrieves the **sIDHistory** values of the source principal and adds them to the destination principal's **sIDHistory**.</span></span>

<span data-ttu-id="2ab96-109">A adição de SIDs ao **SIDHistory** de uma entidade de segurança é uma operação sensível à segurança que efetivamente concede ao acesso principal de destino a todos os recursos acessíveis à entidade de origem, desde que existam relações de confiança existentes nos domínios de recursos aplicáveis ao domínio de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-109">Adding SIDs to a security principal's **sIDHistory** is a security-sensitive operation that effectively grants to the destination principal access to all resources accessible to the source principal, provided that trusts exist from applicable resource domains to the destination domain.</span></span>

<span data-ttu-id="2ab96-110">Em um domínio do Windows 2000 no modo nativo, um logon de usuário cria um token de acesso que contém o SID da conta primária do usuário e os SIDs de grupo, bem como o **SIDHistory** do usuário e o **SIDHistory** dos grupos dos quais o usuário é membro.</span><span class="sxs-lookup"><span data-stu-id="2ab96-110">In a native mode Windows 2000 domain a user logon creates an access token that contains the user primary account SID and group SIDs, as well as the user **sIDHistory** and the **sIDHistory** of the groups of which the user is a member.</span></span> <span data-ttu-id="2ab96-111">Ter esses SIDs anteriores (valores de **SIDHistory** ) no token do usuário concede ao usuário acesso aos recursos protegidos pelas ACLs (listas de controle de acesso) que contêm os SIDs anteriores.</span><span class="sxs-lookup"><span data-stu-id="2ab96-111">Having these former SIDs (**sIDHistory** values) in the user's token grants the user access to resources protected by access-control lists (ACLs) containing the former SIDs.</span></span>

<span data-ttu-id="2ab96-112">Esta operação facilita determinados cenários de implantação do Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="2ab96-112">This operation facilitates certain Windows 2000 deployment scenarios.</span></span> <span data-ttu-id="2ab96-113">Em particular, ele dá suporte a um cenário no qual as contas em uma nova floresta do Windows 2000 são criadas para usuários e grupos que já existem em um ambiente de produção do Windows NT 4,0.</span><span class="sxs-lookup"><span data-stu-id="2ab96-113">In particular, it supports a scenario in which accounts in a new Windows 2000 forest are created for users and groups that already exist in an Windows NT 4.0 production environment.</span></span> <span data-ttu-id="2ab96-114">Ao colocar o SID da conta do Windows NT 4,0 no **SIDHistory** da conta do Windows 2000, o acesso aos recursos de rede é preservado para o logon do usuário em sua nova conta do Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="2ab96-114">By placing the Windows NT 4.0 account SID in the Windows 2000 account **sIDHistory**, access to network resources is preserved for the user logging onto his new Windows 2000 account.</span></span>

<span data-ttu-id="2ab96-115">O [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) também dá suporte à migração de servidores de recursos dos BDCs (controladores de domínio de backup) do windows NT 4,0 (ou DCS e servidores membro em um domínio do Windows 2000 no modo nativo) para um domínio do Windows 2000 como servidores membro.</span><span class="sxs-lookup"><span data-stu-id="2ab96-115">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) also supports migration of Windows NT 4.0 backup domain controllers (BDCs) resource servers (or DCs and member servers in a native mode Windows 2000 domain) to a Windows 2000 domain as member servers.</span></span> <span data-ttu-id="2ab96-116">Essa migração requer a criação, no domínio de destino do Windows 2000, de grupos locais de domínio que contêm, em seu **SIDHistory**, os SIDs primários dos grupos locais definidos no BDC (ou grupos locais de domínio referenciados em ACLs nos servidores Windows 2000) no domínio de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-116">This migration requires the creation, in the destination Windows 2000 domain, of domain local groups that contain, in their **sIDHistory**, the primary SIDs of the local groups defined on the BDC (or domain local groups referenced in ACLs on the Windows 2000 servers) in the source domain.</span></span> <span data-ttu-id="2ab96-117">Ao criar um grupo local de destino contendo o **SIDHistory** e todos os membros do grupo local de origem, o acesso aos recursos migrados do servidor, protegidos por ACLs que fazem referência ao grupo local de origem, é mantido para todos os membros.</span><span class="sxs-lookup"><span data-stu-id="2ab96-117">By creating a destination local group containing the **sIDHistory** and all members of the source local group, access to the migrated server resources, protected by ACLs referencing the source local group, is maintained for all members.</span></span>

> [!Note]  
> <span data-ttu-id="2ab96-118">O uso de [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requer uma compreensão de suas implicações administrativas e de segurança mais amplas nesses e em outros cenários.</span><span class="sxs-lookup"><span data-stu-id="2ab96-118">Use of [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requires an understanding of its broader administrative and security implications in these and other scenarios.</span></span> <span data-ttu-id="2ab96-119">Para obter mais informações, consulte a white paper "planejando a migração do Windows NT para o Microsoft Windows 2000", entregue como Dommig.doc nas ferramentas de suporte do Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="2ab96-119">For more information, see the white paper "Planning Migration from Windows NT to Microsoft Windows 2000", delivered as Dommig.doc in the Windows 2000 Support Tools.</span></span> <span data-ttu-id="2ab96-120">Esta documentação também pode ser encontrada no CD do produto em \\ ferramentas de suporte \\ .</span><span class="sxs-lookup"><span data-stu-id="2ab96-120">This documentation may also be found on the product CD under \\support\\tools.</span></span>

 

## <a name="authorization-requirements"></a><span data-ttu-id="2ab96-121">Requisitos de autorização</span><span class="sxs-lookup"><span data-stu-id="2ab96-121">Authorization Requirements</span></span>

<span data-ttu-id="2ab96-122">O [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requer privilégios de administrador nos domínios de origem e de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-122">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requires administrator privileges in the source and destination domains.</span></span> <span data-ttu-id="2ab96-123">Especificamente, o chamador dessa API deve ser um membro do grupo de administradores de domínio no domínio de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-123">Specifically, the caller of this API must be a member of the Domain Administrators group in the destination domain.</span></span> <span data-ttu-id="2ab96-124">Uma verificação embutida em código para essa associação é executada.</span><span class="sxs-lookup"><span data-stu-id="2ab96-124">A hard-coded check for this membership is performed.</span></span> <span data-ttu-id="2ab96-125">Além disso, o chamador ou a conta fornecida no parâmetro *SrcDomainCreds* , se não for **NULL**, deve ser um membro do grupo Administradores ou administradores de domínio no domínio de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-125">Also, the caller or the account provided in the *SrcDomainCreds* parameter, if not **NULL**, must be a member of either the Administrators or Domain Administrators group in the source domain.</span></span>

## <a name="domain-and-trust-requirements"></a><span data-ttu-id="2ab96-126">Requisitos de domínio e confiança</span><span class="sxs-lookup"><span data-stu-id="2ab96-126">Domain and Trust Requirements</span></span>

<span data-ttu-id="2ab96-127">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) exige que o domínio de destino esteja no modo nativo do Windows 2000 ou posterior, pois somente esse tipo de domínio dá suporte ao atributo **SIDHistory** .</span><span class="sxs-lookup"><span data-stu-id="2ab96-127">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requires that the destination domain be in Windows 2000 native mode or later, because only this domain type supports the **sIDHistory** attribute.</span></span> <span data-ttu-id="2ab96-128">O domínio de origem pode ser o Windows NT 4,0 ou Windows 2000, modo misto ou nativo.</span><span class="sxs-lookup"><span data-stu-id="2ab96-128">The source domain may be either Windows NT 4.0 or Windows 2000, mixed or native mode.</span></span> <span data-ttu-id="2ab96-129">Os domínios de origem e de destino não devem estar na mesma floresta.</span><span class="sxs-lookup"><span data-stu-id="2ab96-129">The source and destination domains must not be in the same forest.</span></span> <span data-ttu-id="2ab96-130">Os domínios do Windows NT 4,0 são por definição que não estão em uma floresta.</span><span class="sxs-lookup"><span data-stu-id="2ab96-130">Windows NT 4.0 domains are by definition not in a forest.</span></span> <span data-ttu-id="2ab96-131">Essa restrição entre florestas garante que SIDs duplicados, sejam exibidos como SIDs primários ou valores de **SIDHistory** , não sejam criados na mesma floresta.</span><span class="sxs-lookup"><span data-stu-id="2ab96-131">This inter-forest constraint ensures that duplicate SIDs, whether appearing as primary SIDs or **sIDHistory** values, are not created in the same forest.</span></span>

<span data-ttu-id="2ab96-132">O [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requer uma relação de confiança externa do domínio de origem para o domínio de destino nos casos listados na tabela a seguir.</span><span class="sxs-lookup"><span data-stu-id="2ab96-132">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requires an external trust from the source domain to the destination domain in the cases listed in the following table.</span></span>



| <span data-ttu-id="2ab96-133">Caixa</span><span class="sxs-lookup"><span data-stu-id="2ab96-133">Case</span></span>                                                                             | <span data-ttu-id="2ab96-134">Description</span><span class="sxs-lookup"><span data-stu-id="2ab96-134">Description</span></span>                                                                                                                                                                                                                                                                 |
|----------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="2ab96-135">O domínio de origem é o Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="2ab96-135">The source domain is Windows 2000.</span></span><br/>                                    | <span data-ttu-id="2ab96-136">O atributo **SIDHistory** de origem, disponível somente em domínios de origem do Windows 2000, pode ser somente leitura usando LDAP, o que exige essa relação de confiança para a proteção de integridade.</span><span class="sxs-lookup"><span data-stu-id="2ab96-136">The source **sIDHistory** attribute, available only in Windows 2000 source domains, may be read only using LDAP, which requires this trust for integrity protection.</span></span><br/>                                                                                             |
| <span data-ttu-id="2ab96-137">O domínio de origem é o Windows NT 4,0 e o *SrcDomainCreds* é **nulo**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-137">The source domain is Windows NT 4.0 and *SrcDomainCreds* is **NULL**.</span></span><br/> | <span data-ttu-id="2ab96-138">A representação, necessária para dar suporte às operações de domínio de origem usando as credenciais do chamador, depende dessa relação de confiança.</span><span class="sxs-lookup"><span data-stu-id="2ab96-138">The impersonation, required to support source domain operations using the caller's credentials, depends on this trust.</span></span> <span data-ttu-id="2ab96-139">A representação também exige que o controlador de domínio de destino tenha "confiável para delegação" habilitada por padrão em controladores de domínio.</span><span class="sxs-lookup"><span data-stu-id="2ab96-139">Impersonation also requires that the destination domain controller has "Trusted for Delegation" enabled by default on domain controllers.</span></span><br/> |



 

<span data-ttu-id="2ab96-140">No entanto, não há nenhuma relação de confiança necessária entre os domínios de origem e de destino se o domínio de origem for Windows NT 4,0 e *SrcDomainCreds* não for **nulo**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-140">However, there is no trust required between the source and destination domains if the source domain is Windows NT 4.0 and *SrcDomainCreds* is not **NULL**.</span></span>

## <a name="source-domain-controller-requirements"></a><span data-ttu-id="2ab96-141">Requisitos do controlador de domínio de origem</span><span class="sxs-lookup"><span data-stu-id="2ab96-141">Source Domain Controller Requirements</span></span>

<span data-ttu-id="2ab96-142">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requer que o controlador de domínio, selecionado como o destino para operações no domínio de origem, seja o PDC em domínios do windows NT 4,0 ou o emulador de PDC em domínios do Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="2ab96-142">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requires that the domain controller, selected as the target for operations in the source domain, be the PDC in Windows NT 4.0 domains or the PDC Emulator in Windows 2000 domains.</span></span> <span data-ttu-id="2ab96-143">A auditoria de domínio de origem é gerada por meio de operações de gravação, portanto, o PDC é necessário em domínios de origem do Windows NT 4,0 e a restrição somente PDC garante que as auditorias **DsAddSidHistory** sejam geradas em um único computador.</span><span class="sxs-lookup"><span data-stu-id="2ab96-143">Source domain auditing is generated by way of write operations, therefore, the PDC is required in Windows NT 4.0 source domains, and the PDC-only restriction ensures that **DsAddSidHistory** audits are generated on a single computer.</span></span> <span data-ttu-id="2ab96-144">Isso reduz a necessidade de examinar os logs de auditoria de todos os DCs para monitorar o uso dessa operação.</span><span class="sxs-lookup"><span data-stu-id="2ab96-144">This reduces the need to review the audit logs of all DCs to monitor use of this operation.</span></span>

> [!Note]  
> <span data-ttu-id="2ab96-145">Em domínios de origem do Windows NT 4,0, o PDC (destino de operações no domínio de origem) deve estar executando o Service Pack 4 (SP4) e posterior para garantir o suporte adequado à auditoria.</span><span class="sxs-lookup"><span data-stu-id="2ab96-145">In Windows NT 4.0 source domains, the PDC (target of operations in the source domain) must be running Service Pack 4 (SP4) and later to ensure proper auditing support.</span></span>

 

<span data-ttu-id="2ab96-146">O valor do registro a seguir deve ser criado como um \_ valor reg DWORD e definido como 1 no controlador de domínio de origem para os DCS de origem do Windows NT 4,0 e do windows 2000.</span><span class="sxs-lookup"><span data-stu-id="2ab96-146">The following registry value must be created as a REG\_DWORD value and set to 1 on the source domain controller for both Windows NT 4.0 and Windows 2000 source DCs.</span></span>

```
HKEY_LOCAL_MACHINE
   System
      CurrentControlSet
         Control
            Lsa
               TcpipClientSupport
```

<span data-ttu-id="2ab96-147">Definir esse valor habilita chamadas RPC no transporte TCP.</span><span class="sxs-lookup"><span data-stu-id="2ab96-147">Setting this value enables RPC calls over the TCP transport.</span></span> <span data-ttu-id="2ab96-148">Isso é necessário porque, por padrão, as interfaces SAMRPC são remotas somente em pipes nomeados.</span><span class="sxs-lookup"><span data-stu-id="2ab96-148">This is required because, by default, SAMRPC interfaces are remotable only on named pipes.</span></span> <span data-ttu-id="2ab96-149">O uso de pipes nomeados resulta em um sistema de gerenciamento de credenciais adequado para usuários conectados interativamente, fazendo chamadas em rede, mas não é flexível para um processo do sistema que faz chamadas de redes com credenciais fornecidas pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="2ab96-149">Using named pipes results in a credential management system suitable for interactively logged-on users making networked calls, but is not flexible for a system process that makes network calls with user-supplied credentials.</span></span> <span data-ttu-id="2ab96-150">RPC sobre TCP é mais adequado para essa finalidade.</span><span class="sxs-lookup"><span data-stu-id="2ab96-150">RPC over TCP is more suitable for that purpose.</span></span> <span data-ttu-id="2ab96-151">A definição desse valor não diminui a segurança do sistema.</span><span class="sxs-lookup"><span data-stu-id="2ab96-151">Setting this value does not diminish system security.</span></span> <span data-ttu-id="2ab96-152">Se esse valor for criado ou alterado, o controlador de domínio de origem deverá ser reiniciado para que essa configuração entre em vigor.</span><span class="sxs-lookup"><span data-stu-id="2ab96-152">If this value is created or changed, the source domain controller must be restarted for this setting to take effect.</span></span>

<span data-ttu-id="2ab96-153">Um novo grupo local, " <SrcDomainName> $ $ $", deve ser criado no domínio de origem para fins de auditoria.</span><span class="sxs-lookup"><span data-stu-id="2ab96-153">A new local group, "<SrcDomainName>$$$", must be created in the source domain for auditing purposes.</span></span>

## <a name="auditing"></a><span data-ttu-id="2ab96-154">Auditoria</span><span class="sxs-lookup"><span data-stu-id="2ab96-154">Auditing</span></span>

<span data-ttu-id="2ab96-155">As operações [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) são auditadas para garantir que os administradores de domínio de origem e de destino sejam capazes de detectar quando essa função foi executada.</span><span class="sxs-lookup"><span data-stu-id="2ab96-155">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) operations are audited to ensure that both source and destination domain administrators are able to detect when this function has been run.</span></span> <span data-ttu-id="2ab96-156">A auditoria é obrigatória nos domínios de origem e de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-156">Auditing is mandatory in both the source and destination domains.</span></span> <span data-ttu-id="2ab96-157">**DsAddSidHistory** verifica se o modo de auditoria está ativado em cada domínio e se a auditoria de gerenciamento de conta de eventos de êxito/falha está ativada.</span><span class="sxs-lookup"><span data-stu-id="2ab96-157">**DsAddSidHistory** verifies that the Audit Mode is on in each domain and that Account Management auditing of Success/Failure events is on.</span></span> <span data-ttu-id="2ab96-158">No domínio de destino, um evento de auditoria exclusivo "Adicionar histórico SID" é gerado para cada operação de **DsAddSidHistory** bem-sucedida ou com falha.</span><span class="sxs-lookup"><span data-stu-id="2ab96-158">In the destination domain, a unique "Add Sid History" audit event is generated for each successful or failed **DsAddSidHistory** operation.</span></span>

<span data-ttu-id="2ab96-159">Os eventos de auditoria exclusivos do "Adicionar histórico SID" não estão disponíveis em sistemas Windows NT 4,0.</span><span class="sxs-lookup"><span data-stu-id="2ab96-159">Unique "Add Sid History" audit events are not available on Windows NT 4.0 systems.</span></span> <span data-ttu-id="2ab96-160">Para gerar eventos de auditoria que refletem inequivocamente o uso de [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) em relação ao domínio de origem, ele executa operações em um grupo especial cujo nome é o identificador exclusivo no log de auditoria.</span><span class="sxs-lookup"><span data-stu-id="2ab96-160">To generate audit events that unambiguously reflect use of [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) against the source domain, it performs operations on a special group whose name is the unique identifier in the audit log.</span></span> <span data-ttu-id="2ab96-161">Um grupo local, " <SrcDomainName> $ $ $", cujo nome é composto pelo nome NetBIOS do domínio de origem acrescentado com três sinais de dólar ($) (código ASCII = 0x24 e Unicode = U + 0024), deve ser criado no controlador de domínio de origem antes de chamar **DsAddSidHistory**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-161">A local group, "<SrcDomainName>$$$", whose name is composed of the source domain NetBIOS name appended with three dollar signs ($) (ASCII code = 0x24 and Unicode = U+0024), must be created on the source domain controller prior to calling **DsAddSidHistory**.</span></span> <span data-ttu-id="2ab96-162">Cada usuário de origem e grupo global que é um destino dessa operação é adicionado e removido da associação deste grupo.</span><span class="sxs-lookup"><span data-stu-id="2ab96-162">Each source user and global group that is a target of this operation is added to and then removed from the membership of this group.</span></span> <span data-ttu-id="2ab96-163">Isso gera eventos de auditoria Adicionar membro e excluir membro no domínio de origem, que pode ser monitorado pesquisando eventos que fazem referência ao nome do grupo.</span><span class="sxs-lookup"><span data-stu-id="2ab96-163">This generates Add Member and Delete Member audit events in the source domain, which can be monitored by searching for events that reference the group name.</span></span>

> [!Note]  
> <span data-ttu-id="2ab96-164">As operações [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) em grupos locais em um domínio de origem de modo misto do windows NT 4,0 ou do Windows 2000 não podem ser auditadas porque os grupos locais não podem se tornar membros de outro grupo local e, portanto, não podem ser adicionados ao <SrcDomainName> grupo local "$ $ $" especial.</span><span class="sxs-lookup"><span data-stu-id="2ab96-164">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) operations on local groups in a Windows NT 4.0, or Windows 2000 mixed-mode source domain cannot be audited because local groups cannot be made members of another local group and therefore cannot be added to the special "<SrcDomainName>$$$" local group.</span></span> <span data-ttu-id="2ab96-165">Essa falta de auditoria não apresenta um problema de segurança para o domínio de origem, pois o acesso ao recurso do domínio de origem não é afetado por essa operação.</span><span class="sxs-lookup"><span data-stu-id="2ab96-165">This lack of auditing does not present a security issue to the source domain, because source domain resource access is not affected by this operation.</span></span> <span data-ttu-id="2ab96-166">A adição do SID de um grupo local de origem a um grupo local de destino não concede acesso aos recursos de origem, protegidos por esse grupo local, a qualquer usuário adicional.</span><span class="sxs-lookup"><span data-stu-id="2ab96-166">Adding the SID of a source local group to a destination local group does not grant access to source resources, protected by that local group, to any additional users.</span></span> <span data-ttu-id="2ab96-167">Adicionar membros ao grupo local de destino não concede a eles acesso aos recursos de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-167">Adding members to the destination local group does not grant them access to source resources.</span></span> <span data-ttu-id="2ab96-168">Os membros adicionados recebem acesso somente aos servidores no domínio de destino migrados do domínio de origem, que podem ter recursos protegidos pelo SID do grupo local de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-168">Added members are granted access only to servers in the destination domain migrated from the source domain, which may have resources protected by the source local group SID.</span></span>

 

## <a name="data-transmission-security"></a><span data-ttu-id="2ab96-169">Segurança de transmissão de dados</span><span class="sxs-lookup"><span data-stu-id="2ab96-169">Data Transmission Security</span></span>

<span data-ttu-id="2ab96-170">O [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) impõe as seguintes medidas de segurança:</span><span class="sxs-lookup"><span data-stu-id="2ab96-170">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) enforces the following security measures:</span></span>

-   <span data-ttu-id="2ab96-171">Chamado de uma estação de trabalho do Windows 2000, as credenciais do chamador são usadas para autenticar e proteger a chamada RPC para o controlador de domínio de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-171">Called from a Windows 2000 workstation, the caller's credentials are used to authenticate and privacy-protect the RPC call to the destination domain controller.</span></span> <span data-ttu-id="2ab96-172">Se *SrcDomainCreds* não for **NULL**, tanto a estação de trabalho quanto o DC de destino deverão oferecer suporte à criptografia de 128 bits para privacidade-proteger as credenciais.</span><span class="sxs-lookup"><span data-stu-id="2ab96-172">If *SrcDomainCreds* is not **NULL**, both the workstation and the destination DC must support 128-bit encryption to privacy-protect the credentials.</span></span> <span data-ttu-id="2ab96-173">Se a criptografia de 128 bits não estiver disponível e *SrcDomainCreds* forem fornecidas, a chamada deverá ser feita no DC de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-173">If 128-bit encryption is not available and *SrcDomainCreds* are provided, then the call must be made on the destination DC.</span></span>
-   <span data-ttu-id="2ab96-174">O controlador de domínio de destino se comunica com o controlador de domínio de origem usando *SrcDomainCreds* ou as credenciais do chamador para autenticar mutuamente e proteger a leitura do Sid da conta de origem (usando uma pesquisa Sam) e **SIDHistory** (usando uma leitura LDAP).</span><span class="sxs-lookup"><span data-stu-id="2ab96-174">The destination domain controller communicates with the source domain controller using either *SrcDomainCreds* or the caller's credentials to mutually authenticate and integrity-protect the read of the source account SID (using a SAM lookup) and **sIDHistory** (using an LDAP read).</span></span>

## <a name="threat-models"></a><span data-ttu-id="2ab96-175">Modelos de ameaça</span><span class="sxs-lookup"><span data-stu-id="2ab96-175">Threat Models</span></span>

<span data-ttu-id="2ab96-176">A tabela a seguir lista as possíveis ameaças associadas à chamada [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) e resolve as medidas de segurança pertinentes à ameaça específica.</span><span class="sxs-lookup"><span data-stu-id="2ab96-176">The following table lists the potential threats associated with the [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) call and addresses the security measures pertinent to the particular threat.</span></span>



<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th><span data-ttu-id="2ab96-177">Ameaça potencial</span><span class="sxs-lookup"><span data-stu-id="2ab96-177">Potential threat</span></span></th>
<th><span data-ttu-id="2ab96-178">Medida de segurança</span><span class="sxs-lookup"><span data-stu-id="2ab96-178">Security measure</span></span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span data-ttu-id="2ab96-179">Homem no ataque do meio</span><span class="sxs-lookup"><span data-stu-id="2ab96-179">Man in the Middle Attack</span></span><br/> <span data-ttu-id="2ab96-180">Um usuário não autorizado intercepta o <em>Sid de pesquisa da chamada de retorno do objeto de origem</em> , substituindo o SID do objeto de origem por um SID arbitrário para inserção em um objeto de destino SIDhistory.</span><span class="sxs-lookup"><span data-stu-id="2ab96-180">An unauthorized user intercepts the <em>lookup SID of source object</em> return call, replacing the source object SID with an arbitrary SID for insertion into a target object SIDhistory.</span></span><br/></td>
<td><span data-ttu-id="2ab96-181">O <em>Sid de pesquisa do objeto de origem</em> é um RPC autenticado, usando as credenciais de administrador do chamador, com proteção de mensagem de integridade de pacote.</span><span class="sxs-lookup"><span data-stu-id="2ab96-181">The <em>lookup SID of source object</em> is an authenticated RPC, using the caller's administrator credentials, with packet integrity message protection.</span></span> <span data-ttu-id="2ab96-182">Isso garante que a chamada de retorno não pode ser modificada sem detecção.</span><span class="sxs-lookup"><span data-stu-id="2ab96-182">This ensures that the return call cannot be modified without detection.</span></span> <span data-ttu-id="2ab96-183">O controlador de domínio de destino cria um evento exclusivo de &quot; auditoria de histórico de SID &quot; que reflete o Sid adicionado ao <strong>SIDHistory</strong>da conta de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-183">The destination domain controller creates a unique &quot;Add SID History&quot; audit event that reflects the SID added to the destination account <strong>sIDHistory</strong>.</span></span><br/></td>
</tr>
<tr class="even">
<td><span data-ttu-id="2ab96-184">Domínio de origem do cavalo de Troia</span><span class="sxs-lookup"><span data-stu-id="2ab96-184">Trojan Source Domain</span></span><br/> <span data-ttu-id="2ab96-185">Um usuário não autorizado cria um &quot; domínio de origem do cavalo &quot; de Troia em uma rede privada que tem o mesmo SID de domínio e alguns dos mesmos SIDs de conta que o domínio de origem legítimo.</span><span class="sxs-lookup"><span data-stu-id="2ab96-185">An unauthorized user creates a &quot;Trojan Horse&quot; source domain on a private network that has the same domain SID and some of the same account SIDs as the legitimate source domain.</span></span> <span data-ttu-id="2ab96-186">Em seguida, o usuário não autorizado tenta executar <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a> em um domínio de destino para obter o Sid de uma conta de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-186">The unauthorized user then attempts to run <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a> in a destination domain to obtain the SID of a source account.</span></span> <span data-ttu-id="2ab96-187">Isso é feito sem a necessidade de credenciais de administrador de domínio de origem real e sem deixar uma trilha de auditoria no domínio de origem real.</span><span class="sxs-lookup"><span data-stu-id="2ab96-187">This is done without the need for the real source Domain Administrator credentials and without leaving an audit trail in the real source domain.</span></span> <span data-ttu-id="2ab96-188">O método do usuário não autorizado para criar o domínio de origem do cavalo de Troia pode ser um dos seguintes:</span><span class="sxs-lookup"><span data-stu-id="2ab96-188">The unauthorized user's method for creating the Trojan Horse source domain could be one of the following:</span></span>
<ul>
<li><span data-ttu-id="2ab96-189">Obtenha uma cópia (backup do BDC) do SAM do domínio de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-189">Obtain a copy (BDC backup) of the source domain SAM.</span></span></li>
<li><span data-ttu-id="2ab96-190">Crie um novo domínio, alterando o SID do domínio no disco para corresponder ao SID do domínio de origem legítimo e, em seguida, crie usuários suficientes para criar uma instância de uma conta com o SID desejado.</span><span class="sxs-lookup"><span data-stu-id="2ab96-190">Create a new domain, altering the domain SID on disk to match the legitimate source domain SID, then create enough users to instantiate an account with the desired SID.</span></span></li>
<li><span data-ttu-id="2ab96-191">Crie uma réplica do BDC.</span><span class="sxs-lookup"><span data-stu-id="2ab96-191">Create a BDC replica.</span></span> <span data-ttu-id="2ab96-192">Isso requer credenciais de administrador de domínio de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-192">This requires source domain Administrator credentials.</span></span> <span data-ttu-id="2ab96-193">Em seguida, o usuário não autorizado leva a réplica para uma rede privada para implementar o ataque.</span><span class="sxs-lookup"><span data-stu-id="2ab96-193">Then the unauthorized user takes the replica to a private network to implement the attack.</span></span></li>
</ul>
<br/></td>
<td><span data-ttu-id="2ab96-194">Embora haja várias maneiras de um usuário não autorizado recuperar ou criar um SID de objeto de origem desejado, o usuário não autorizado não pode usá-lo para atualizar o <strong>SIDHistory</strong> de uma conta sem ser membro do grupo de administradores de domínio de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-194">Although there are many ways for an unauthorized user to retrieve or create a desired source object SID, the unauthorized user cannot use it to update an account's <strong>sIDHistory</strong> without being a member of the destination Domain Administrators group.</span></span> <span data-ttu-id="2ab96-195">Como a verificação, no controlador de domínio de destino, para a associação de administrador de domínio é embutida em código, no DC de destino, não há nenhum método para fazer uma modificação no disco para alterar os dados de controle de acesso que protegem essa função.</span><span class="sxs-lookup"><span data-stu-id="2ab96-195">Because the check, on the destination domain controller, for Domain Administrator membership is hard-coded, on the target DC, there is no method for doing a disk modification to change the access control data protecting this function.</span></span> <span data-ttu-id="2ab96-196">Uma tentativa de clonar uma conta de origem do cavalo de Troia é auditada no domínio de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-196">An attempt to clone a Trojan Horse source account is audited in the destination domain.</span></span> <span data-ttu-id="2ab96-197">Esse ataque é mitigado ao reservar a associação no grupo de administradores de domínio apenas para indivíduos altamente confiáveis.</span><span class="sxs-lookup"><span data-stu-id="2ab96-197">This attack is mitigated by reserving membership in the Domain Administrators group for only highly trusted individuals.</span></span><br/></td>
</tr>
<tr class="odd">
<td><span data-ttu-id="2ab96-198">Modificação no disco do histórico de SID</span><span class="sxs-lookup"><span data-stu-id="2ab96-198">On-disk Modification of SID History</span></span><br/> <span data-ttu-id="2ab96-199">Um usuário não autorizado sofisticado, com credenciais de administrador de domínio e com acesso físico a um DC no domínio de destino, pode modificar um valor de <strong>SIDHistory</strong> de conta no disco.</span><span class="sxs-lookup"><span data-stu-id="2ab96-199">A sophisticated unauthorized user, with Domain Administrator credentials and with physical access to a DC in the destination domain, could modify an account <strong>sIDHistory</strong> value on disk.</span></span><br/></td>
<td><span data-ttu-id="2ab96-200">Essa tentativa não é habilitada pelo uso de <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a>.</span><span class="sxs-lookup"><span data-stu-id="2ab96-200">This attempt is not enabled by use of <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a>.</span></span> <span data-ttu-id="2ab96-201">Esse ataque é mitigado ao impedir o acesso físico a controladores de domínio a todos, exceto administradores altamente confiáveis.</span><span class="sxs-lookup"><span data-stu-id="2ab96-201">This attack is mitigated by preventing physical access to domain controllers to all except highly trusted administrators.</span></span><br/></td>
</tr>
<tr class="even">
<td><span data-ttu-id="2ab96-202">Código não autorizado usado para remover proteções</span><span class="sxs-lookup"><span data-stu-id="2ab96-202">Rogue Code Used to Remove Protections</span></span><br/> <span data-ttu-id="2ab96-203">Um usuário não autorizado ou um administrador não autorizado com acesso físico ao código do serviço de diretório poderia criar um código não autorizado que:</span><span class="sxs-lookup"><span data-stu-id="2ab96-203">An unauthorized user or rogue administrator with physical access to the Directory Service code could create rogue code that:</span></span>
<ol>
<li><span data-ttu-id="2ab96-204">Remove a verificação de associação no grupo Administradores de domínio no código.</span><span class="sxs-lookup"><span data-stu-id="2ab96-204">Removes the check for membership in the Domain Administrators group in the code.</span></span></li>
<li><span data-ttu-id="2ab96-205">Altera as chamadas no controlador de domínio de origem que aponta o SID para um LookupSidFromName que não é auditado.</span><span class="sxs-lookup"><span data-stu-id="2ab96-205">Changes the calls on the source domain controller that points the SID to a LookupSidFromName that is not audited.</span></span></li>
<li><span data-ttu-id="2ab96-206">Remove as chamadas de log de auditoria.</span><span class="sxs-lookup"><span data-stu-id="2ab96-206">Removes audit log calls.</span></span></li>
</ol>
<br/></td>
<td><span data-ttu-id="2ab96-207">Alguém com acesso físico ao código DS e com conhecimento suficiente para criar código não autorizado tem a capacidade de modificar arbitrariamente o atributo <strong>SIDHistory</strong> de uma conta.</span><span class="sxs-lookup"><span data-stu-id="2ab96-207">Someone with physical access to the DS code and knowledgeable enough to create rogue code has the capability of arbitrarily modifying the <strong>sIDHistory</strong> attribute of an account.</span></span> <span data-ttu-id="2ab96-208">A API <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a> não aumenta esse risco de segurança.</span><span class="sxs-lookup"><span data-stu-id="2ab96-208">The <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a> API does not increase this security risk.</span></span><br/></td>
</tr>
<tr class="odd">
<td><span data-ttu-id="2ab96-209">Recursos vulneráveis a SIDs roubados</span><span class="sxs-lookup"><span data-stu-id="2ab96-209">Resources Vulnerable to Stolen SIDs</span></span><br/> <span data-ttu-id="2ab96-210">Se um usuário não autorizado tiver tido êxito no uso de um dos métodos descritos aqui para modificar um <strong>SIDHistory</strong>de conta e se os domínios de recursos de interesse confiarem no domínio de conta de usuário não autorizado, o usuário não autorizado poderá obter acesso não autorizado aos recursos do Sid roubado, potencialmente sem deixar uma trilha de auditoria no domínio da conta do qual o Sid foi roubado.</span><span class="sxs-lookup"><span data-stu-id="2ab96-210">If an unauthorized user has succeeded in using one of the methods described here to modify an account <strong>sIDHistory</strong>, and if the resource domains of interest trust the unauthorized user account domain, then the unauthorized user can get unauthorized access to the stolen SID's resources, potentially without leaving an audit trail in the account domain from which the SID was stolen.</span></span><br/></td>
<td><span data-ttu-id="2ab96-211">Os administradores de domínio de recursos protegem seus recursos Configurando apenas as relações de confiança que fazem sentido de uma perspectiva de segurança.</span><span class="sxs-lookup"><span data-stu-id="2ab96-211">Resource domain administrators protect their resources by setting up only those trust relationships that make sense from a security perspective.</span></span> <span data-ttu-id="2ab96-212">O uso de <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a> é restrito, no domínio de destino confiável, aos membros do grupo de administradores de domínio que já têm permissões amplas dentro do escopo de suas responsabilidades.</span><span class="sxs-lookup"><span data-stu-id="2ab96-212">Use of <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a> is restricted, in the trusted target domain, to members of the Domain Administrators group who already have broad permissions within the scope of their responsibilities.</span></span><br/></td>
</tr>
<tr class="even">
<td><span data-ttu-id="2ab96-213">Domínio de destino não autorizado</span><span class="sxs-lookup"><span data-stu-id="2ab96-213">Rogue Target Domain</span></span><br/> <span data-ttu-id="2ab96-214">Um usuário não autorizado cria um domínio do Windows 2000 com uma conta cujo <strong>SIDHistory</strong> contém um SID que foi roubado de um domínio de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-214">An unauthorized user creates a Windows 2000 domain with an account whose <strong>sIDHistory</strong> contains a SID that has been stolen from a source domain.</span></span> <span data-ttu-id="2ab96-215">O usuário não autorizado usa essa conta para acesso não autorizado aos recursos.</span><span class="sxs-lookup"><span data-stu-id="2ab96-215">The unauthorized user uses this account for unauthorized access to resources.</span></span><br/></td>
<td><span data-ttu-id="2ab96-216">O usuário não autorizado requer credenciais de administrador para o domínio de origem a fim de usar o <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a>e deixa uma trilha de auditoria no controlador de domínio de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-216">The unauthorized user requires Administrator credentials for the source domain in order to use <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a>, and leaves an audit trail on the source domain controller.</span></span> <span data-ttu-id="2ab96-217">O domínio de destino invasor obtém acesso não autorizado somente em outros domínios que confiam no domínio não autorizado, o que exige privilégios de administrador nesses domínios de recurso.</span><span class="sxs-lookup"><span data-stu-id="2ab96-217">The rogue target domain gains unauthorized access only in other domains that trust the rogue domain, which requires Administrator privileges in those resource domains.</span></span><br/></td>
</tr>
</tbody>
</table>



 

## <a name="operational-constraints"></a><span data-ttu-id="2ab96-218">Restrições operacionais</span><span class="sxs-lookup"><span data-stu-id="2ab96-218">Operational Constraints</span></span>

<span data-ttu-id="2ab96-219">Esta seção descreve as restrições operacionais do uso da função [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) .</span><span class="sxs-lookup"><span data-stu-id="2ab96-219">This section describes the operational constraints of using the [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) function.</span></span>

<span data-ttu-id="2ab96-220">O SID de *SrcPrincipal* já não deve existir na floresta de destino, seja como um SID de conta primária ou no **SIDHistory** de uma conta.</span><span class="sxs-lookup"><span data-stu-id="2ab96-220">The SID of *SrcPrincipal* must not already exist in the destination forest, either as a primary account SID or in the **sIDHistory** of an account.</span></span> <span data-ttu-id="2ab96-221">A exceção é que [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) não gera um erro ao tentar adicionar um SID a um **SIDHistory** que contém um SID idêntico.</span><span class="sxs-lookup"><span data-stu-id="2ab96-221">The exception is that [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) does not generate an error when attempting to add a SID to a **sIDHistory** that contains an identical SID.</span></span> <span data-ttu-id="2ab96-222">Esse comportamento permite que o **DsAddSidHistory** seja executado várias vezes com entrada idêntica, resultando em êxito e em um estado final consistente, para a facilidade de uso do desenvolvedor de ferramentas.</span><span class="sxs-lookup"><span data-stu-id="2ab96-222">This behavior enables **DsAddSidHistory** to be run multiple times with identical input, resulting in success and a consistent end state, for tool developer ease-of-use.</span></span>

> [!Note]  
> <span data-ttu-id="2ab96-223">A latência de replicação de catálogo global pode fornecer uma janela durante a qual SIDs duplicados podem ser criados.</span><span class="sxs-lookup"><span data-stu-id="2ab96-223">Global Catalog replication latency may provide a window during which duplicate SIDs may be created.</span></span> <span data-ttu-id="2ab96-224">No entanto, os SIDs duplicados podem ser facilmente excluídos por um administrador.</span><span class="sxs-lookup"><span data-stu-id="2ab96-224">However, duplicate SIDs can be easily deleted by an administrator.</span></span>

 

<span data-ttu-id="2ab96-225">*SrcPrincipal* e *DstPrincipal* devem ser um dos seguintes tipos:</span><span class="sxs-lookup"><span data-stu-id="2ab96-225">*SrcPrincipal* and *DstPrincipal* must be one of the following types:</span></span>

-   <span data-ttu-id="2ab96-226">Usuário</span><span class="sxs-lookup"><span data-stu-id="2ab96-226">User</span></span>
-   <span data-ttu-id="2ab96-227">Grupo habilitado para segurança, incluindo:</span><span class="sxs-lookup"><span data-stu-id="2ab96-227">Security Enabled Group, including:</span></span>

    <dl> <span data-ttu-id="2ab96-228">Grupo local</span><span class="sxs-lookup"><span data-stu-id="2ab96-228">Local group</span></span>  
    <span data-ttu-id="2ab96-229">Grupo global</span><span class="sxs-lookup"><span data-stu-id="2ab96-229">Global group</span></span>  
    <span data-ttu-id="2ab96-230">Grupo de domínio local (somente no modo nativo do Windows 2000)</span><span class="sxs-lookup"><span data-stu-id="2ab96-230">Domain local group (Windows 2000 native mode only)</span></span>  
    <span data-ttu-id="2ab96-231">Grupo universal (somente no modo nativo do Windows 2000)</span><span class="sxs-lookup"><span data-stu-id="2ab96-231">Universal group (Windows 2000 native mode only)</span></span>  
    </dl>

<span data-ttu-id="2ab96-232">Os tipos de objeto de *SrcPrincipal* e *DstPrincipal* devem corresponder.</span><span class="sxs-lookup"><span data-stu-id="2ab96-232">The object types of *SrcPrincipal* and *DstPrincipal* must match.</span></span>

-   <span data-ttu-id="2ab96-233">Se *SrcPrincipal* for um usuário, *DstPrincipal* deverá ser um usuário.</span><span class="sxs-lookup"><span data-stu-id="2ab96-233">If *SrcPrincipal* is a User, *DstPrincipal* must be a User.</span></span>
-   <span data-ttu-id="2ab96-234">Se *SrcPrincipal* for um grupo local ou de domínio, *DstPrincipal* deverá ser um grupo de domínio local.</span><span class="sxs-lookup"><span data-stu-id="2ab96-234">If *SrcPrincipal* is a Local or Domain Local Group, *DstPrincipal* must be a Domain Local Group.</span></span>
-   <span data-ttu-id="2ab96-235">Se *SrcPrincipal* for um grupo global ou universal, *DstPrincipal* deverá ser um grupo global ou universal.</span><span class="sxs-lookup"><span data-stu-id="2ab96-235">If *SrcPrincipal* is a Global or Universal Group, *DstPrincipal* must be a Global or Universal Group.</span></span>

<span data-ttu-id="2ab96-236">*SrcPrincipal* e *DstPrincipal* não podem ser um dos seguintes tipos: ([**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) falha com um erro nesses casos)</span><span class="sxs-lookup"><span data-stu-id="2ab96-236">*SrcPrincipal* and *DstPrincipal* cannot be one of the following types: ([**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) fails with an error in these cases)</span></span>

-   <span data-ttu-id="2ab96-237">Computador (estação de trabalho ou controlador de domínio)</span><span class="sxs-lookup"><span data-stu-id="2ab96-237">Computer (workstation or domain controller)</span></span>
-   <span data-ttu-id="2ab96-238">Confiança entre domínios</span><span class="sxs-lookup"><span data-stu-id="2ab96-238">Inter-domain trust</span></span>
-   <span data-ttu-id="2ab96-239">Conta duplicada temporária (um recurso virtualmente não utilizado, um herdado do LANman)</span><span class="sxs-lookup"><span data-stu-id="2ab96-239">Temporary duplicate account (virtually unused feature, a legacy of LANman)</span></span>
-   <span data-ttu-id="2ab96-240">Contas com SIDs bem conhecidos.</span><span class="sxs-lookup"><span data-stu-id="2ab96-240">Accounts with Well Known SIDs.</span></span> <span data-ttu-id="2ab96-241">SIDs bem conhecidos são idênticos em todos os domínios; Portanto, adicioná-los a um **SIDHistory** violaria o requisito de exclusividade de Sid de uma floresta do Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="2ab96-241">Well Known SIDs are identical in every domain; thus adding them to a **sIDHistory** would violate the SID uniqueness requirement of a Windows 2000 forest.</span></span> <span data-ttu-id="2ab96-242">As contas com SIDs bem conhecidos incluem os seguintes grupos locais:</span><span class="sxs-lookup"><span data-stu-id="2ab96-242">Accounts with Well Known SIDs include the following local groups:</span></span>

    <dl> <span data-ttu-id="2ab96-243">Operadores de conta</span><span class="sxs-lookup"><span data-stu-id="2ab96-243">Account operators</span></span>  
    <span data-ttu-id="2ab96-244">Administradores</span><span class="sxs-lookup"><span data-stu-id="2ab96-244">Administrators</span></span>  
    <span data-ttu-id="2ab96-245">Operadores de backup</span><span class="sxs-lookup"><span data-stu-id="2ab96-245">Backup operators</span></span>  
    <span data-ttu-id="2ab96-246">Convidados</span><span class="sxs-lookup"><span data-stu-id="2ab96-246">Guests</span></span>  
    <span data-ttu-id="2ab96-247">Operadores de impressão</span><span class="sxs-lookup"><span data-stu-id="2ab96-247">Print operators</span></span>  
    <span data-ttu-id="2ab96-248">Replicador</span><span class="sxs-lookup"><span data-stu-id="2ab96-248">Replicator</span></span>  
    <span data-ttu-id="2ab96-249">Operadores de servidor</span><span class="sxs-lookup"><span data-stu-id="2ab96-249">Server operators</span></span>  
    <span data-ttu-id="2ab96-250">Usuários</span><span class="sxs-lookup"><span data-stu-id="2ab96-250">Users</span></span>  
    </dl>

<span data-ttu-id="2ab96-251">Se *SrcPrincipal* tiver um RID (identificador relativo) bem conhecido e um prefixo específico de domínio, ou seja, administradores de domínio, usuários de domínio e computadores de domínio, o *DstPrincipal* deverá ter o mesmo RID conhecido para que o [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) seja bem sucedido.</span><span class="sxs-lookup"><span data-stu-id="2ab96-251">If *SrcPrincipal* has a well-known relative identifier (RID) and a domain specific prefix, that is, Domain Administrators, Domain Users, and Domain Computers, then *DstPrincipal* must possess the same well-known RID in order for [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) to succeed.</span></span> <span data-ttu-id="2ab96-252">As contas com RIDs bem conhecidos incluem os seguintes usuários e grupos globais:</span><span class="sxs-lookup"><span data-stu-id="2ab96-252">Accounts with well-known RIDs include the following users and global groups:</span></span>

-   <span data-ttu-id="2ab96-253">Administrador</span><span class="sxs-lookup"><span data-stu-id="2ab96-253">Administrator</span></span>
-   <span data-ttu-id="2ab96-254">Convidado</span><span class="sxs-lookup"><span data-stu-id="2ab96-254">Guest</span></span>
-   <span data-ttu-id="2ab96-255">Administradores de domínio</span><span class="sxs-lookup"><span data-stu-id="2ab96-255">Domain administrators</span></span>
-   <span data-ttu-id="2ab96-256">Convidados do domínio</span><span class="sxs-lookup"><span data-stu-id="2ab96-256">Domain guests</span></span>
-   <span data-ttu-id="2ab96-257">Usuários de domínio</span><span class="sxs-lookup"><span data-stu-id="2ab96-257">Domain users</span></span>

## <a name="setting-the-registry-value"></a><span data-ttu-id="2ab96-258">Definindo o valor do registro</span><span class="sxs-lookup"><span data-stu-id="2ab96-258">Setting the Registry Value</span></span>

<span data-ttu-id="2ab96-259">O procedimento a seguir mostra como definir o valor de Registro TcpipClientSupport.</span><span class="sxs-lookup"><span data-stu-id="2ab96-259">The following procedure shows how to set the TcpipClientSupport registry value.</span></span>

<span data-ttu-id="2ab96-260">**Para definir o valor de Registro TcpipClientSupport**</span><span class="sxs-lookup"><span data-stu-id="2ab96-260">**To Set the TcpipClientSupport Registry Value**</span></span>

1.  <span data-ttu-id="2ab96-261">Crie o seguinte valor de registro como um \_ valor de reg DWORD no controlador de domínio de origem e defina seu valor como 1.</span><span class="sxs-lookup"><span data-stu-id="2ab96-261">Create the following registry value as a REG\_DWORD value on the source domain controller and set its value to 1.</span></span>

    <span data-ttu-id="2ab96-262">**HKEY \_ local \_ Machine \\ System \\ CurrentControlSet \\ Control \\ LSA \\ TcpipClientSupport**</span><span class="sxs-lookup"><span data-stu-id="2ab96-262">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\TcpipClientSupport**</span></span>

2.  <span data-ttu-id="2ab96-263">Em seguida, reinicie o controlador de domínio de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-263">Then, restart the source domain controller.</span></span> <span data-ttu-id="2ab96-264">Esse valor de registro faz com que o SAM escute no TCP/IP.</span><span class="sxs-lookup"><span data-stu-id="2ab96-264">This registry value causes the SAM to listen on TCP/IP.</span></span> <span data-ttu-id="2ab96-265">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) falhará se esse valor não estiver definido no controlador de domínio de origem.</span><span class="sxs-lookup"><span data-stu-id="2ab96-265">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) will fail if this value is not set on the source domain controller.</span></span>

## <a name="enabling-auditing-of-usergroup-management-events"></a><span data-ttu-id="2ab96-266">Habilitando a auditoria de eventos de gerenciamento de usuário/grupo</span><span class="sxs-lookup"><span data-stu-id="2ab96-266">Enabling Auditing of User/Group Management Events</span></span>

<span data-ttu-id="2ab96-267">O procedimento a seguir mostra como habilitar a auditoria de eventos de gerenciamento de usuário/grupo em um domínio de origem ou de destino do Windows 2000 ou do Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="2ab96-267">The following procedure shows how to enable auditing of User/Group management events in a Windows 2000 or Windows Server 2003 source or destination domain.</span></span>

<span data-ttu-id="2ab96-268">**Para habilitar a auditoria de eventos de gerenciamento de usuário/grupo em um domínio de origem ou de destino do Windows 2000 ou do Windows Server 2003**</span><span class="sxs-lookup"><span data-stu-id="2ab96-268">**To enable auditing of User/Group management events in a Windows 2000 or Windows Server 2003 source or destination domain**</span></span>

1.  <span data-ttu-id="2ab96-269">No snap-in Active Directory usuários e computadores do MMC, selecione o contêiner controladores de domínio de domínio de destino.</span><span class="sxs-lookup"><span data-stu-id="2ab96-269">In the Active Directory Users and Computers MMC Snap-in, select the destination domain Domain Controllers container.</span></span>
2.  <span data-ttu-id="2ab96-270">Clique com o botão direito do mouse em **controladores de domínio** e escolha **Propriedades**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-270">Right-click **Domain Controllers** and choose **Properties**.</span></span>
3.  <span data-ttu-id="2ab96-271">Clique na guia **política de grupo** .</span><span class="sxs-lookup"><span data-stu-id="2ab96-271">Click the **Group Policy** tab.</span></span>
4.  <span data-ttu-id="2ab96-272">Selecione a **política controladores de domínio padrão** e clique em **Editar**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-272">Select the **Default Domain Controllers Policy** and click **Edit**.</span></span>
5.  <span data-ttu-id="2ab96-273">Em **configuração do computador \\ configurações do Windows \\ configurações de segurança \\ políticas locais \\ política de auditoria**, clique duas vezes em gerenciamento de conta de **auditoria**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-273">Under **Computer Configuration\\Windows Settings\\Security Settings\\Local Policies\\Audit Policy**, double-click **Audit Account Management**.</span></span>
6.  <span data-ttu-id="2ab96-274">Na janela **Gerenciamento de conta de auditoria** , selecione auditoria de **êxito** e de **falha** .</span><span class="sxs-lookup"><span data-stu-id="2ab96-274">In the **Audit Account Management** window, select both **Success** and **Failure** auditing.</span></span> <span data-ttu-id="2ab96-275">As atualizações de política entram em vigor após uma reinicialização ou após uma atualização.</span><span class="sxs-lookup"><span data-stu-id="2ab96-275">Policy updates take effect after a restart or after a refresh occurs.</span></span>
7.  <span data-ttu-id="2ab96-276">Verifique se a auditoria está habilitada exibindo a diretiva de auditoria efetiva no snap-in do Política de Grupo MMC.</span><span class="sxs-lookup"><span data-stu-id="2ab96-276">Verify that auditing is enabled by viewing the effective audit policy in the Group Policy MMC Snap-in.</span></span>

<span data-ttu-id="2ab96-277">O procedimento a seguir mostra como habilitar a auditoria de eventos de gerenciamento de usuário/grupo em um domínio do Windows NT 4,0.</span><span class="sxs-lookup"><span data-stu-id="2ab96-277">The following procedure shows how to enable auditing of User/Group management events in a Windows NT 4.0 domain.</span></span>

<span data-ttu-id="2ab96-278">**Para habilitar a auditoria de eventos de gerenciamento de usuário/grupo em um domínio do Windows NT 4,0**</span><span class="sxs-lookup"><span data-stu-id="2ab96-278">**To enable auditing of User/Group management events in a Windows NT 4.0 domain**</span></span>

1.  <span data-ttu-id="2ab96-279">No **Gerenciador de usuários para domínios**, clique no menu **políticas** e selecione **auditoria**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-279">In **User Manager for Domains**, click the **Policies** menu and select **Audit**.</span></span>
2.  <span data-ttu-id="2ab96-280">Selecione **auditar esses eventos**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-280">Select **Audit These Events**.</span></span>
3.  <span data-ttu-id="2ab96-281">Para o **Gerenciamento de usuários e grupos**, verifique **êxito e falha**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-281">For **User and Group Management**, check **Success and Failure**.</span></span>

<span data-ttu-id="2ab96-282">O procedimento a seguir mostra como habilitar a auditoria de eventos de gerenciamento de usuário/grupo em um domínio de origem do Windows NT 4,0, Windows 2000 ou Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="2ab96-282">The following procedure shows how to enable auditing of User/Group management events in a Windows NT 4.0, Windows 2000, or Windows Server 2003 source domain.</span></span>

<span data-ttu-id="2ab96-283">**Para habilitar a auditoria de eventos de gerenciamento de usuário/grupo em um domínio de origem do Windows NT 4,0, Windows 2000 ou Windows Server 2003**</span><span class="sxs-lookup"><span data-stu-id="2ab96-283">**To enable auditing of User/Group management events in a Windows NT 4.0, Windows 2000, or Windows Server 2003 source domain**</span></span>

1.  <span data-ttu-id="2ab96-284">No **Gerenciador de usuários para domínios**, clique no menu **usuário** e selecione **novo grupo local**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-284">In **User Manager for Domains**, click the **User** menu and select **New Local Group**.</span></span>
2.  <span data-ttu-id="2ab96-285">Insira um nome de grupo composto pelo nome NetBIOS do domínio de origem acrescentado com três sinais de dólar ($), por exemplo, FABRIKAM $ $ $.</span><span class="sxs-lookup"><span data-stu-id="2ab96-285">Enter a group name composed of the source domain NetBIOS name appended with three dollar signs ($), for example, FABRIKAM$$$.</span></span> <span data-ttu-id="2ab96-286">O campo descrição deve indicar que esse grupo é usado para auditar o uso de operações de clonagem ou [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) .</span><span class="sxs-lookup"><span data-stu-id="2ab96-286">The description field should indicate that this group is used to audit use of [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) or cloning operations.</span></span> <span data-ttu-id="2ab96-287">Verifique se não há membros no grupo.</span><span class="sxs-lookup"><span data-stu-id="2ab96-287">Ensure there are no members in the group.</span></span> <span data-ttu-id="2ab96-288">Clique em **OK**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-288">Click **OK**.</span></span>

<span data-ttu-id="2ab96-289">A operação [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) falhará se a auditoria de origem e de destino não estiver habilitada conforme descrito aqui.</span><span class="sxs-lookup"><span data-stu-id="2ab96-289">The [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) operation fails if source and destination auditing are not enabled as described here.</span></span>

## <a name="set-up-trust-if-required"></a><span data-ttu-id="2ab96-290">Configurar confiança se necessário</span><span class="sxs-lookup"><span data-stu-id="2ab96-290">Set up Trust if Required</span></span>

<span data-ttu-id="2ab96-291">Se uma das seguintes opções for verdadeira, uma relação de confiança deverá ser estabelecida do domínio de origem para o domínio de destino (isso deve ocorrer em uma floresta diferente):</span><span class="sxs-lookup"><span data-stu-id="2ab96-291">If one of the following is true, a trust must be established from the source domain to the destination domain (this must occur in a different forest):</span></span>

-   <span data-ttu-id="2ab96-292">O domínio de origem é o Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="2ab96-292">The source domain is Windows Server 2003.</span></span>
-   <span data-ttu-id="2ab96-293">O domínio de origem é o Windows NT 4,0 e o *SrcDomainCreds* é **nulo**.</span><span class="sxs-lookup"><span data-stu-id="2ab96-293">The source domain is Windows NT 4.0 and *SrcDomainCreds* is **NULL**.</span></span>

 

 





