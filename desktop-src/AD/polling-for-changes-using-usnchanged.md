---
title: Sondando alterações usando USNChanged
description: As alterações de Active Directory também podem ser obtidas consultando o atributo uSNChanged, que evita as limitações do controle DirSync.
ms.assetid: 83bda359-09e5-4abf-8f60-9c63bccfcdd1
ms.tgt_platform: multiple
keywords:
- Sondando alterações usando o AD do USNChanged
- USNChanged AD
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a8e062c84fae575f837f45d78be7c92e5e284c1e
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/17/2020
ms.locfileid: "103823642"
---
# <a name="polling-for-changes-using-usnchanged"></a><span data-ttu-id="981b6-105">Sondando alterações usando USNChanged</span><span class="sxs-lookup"><span data-stu-id="981b6-105">Polling for Changes Using USNChanged</span></span>

<span data-ttu-id="981b6-106">O controle DirSync é poderoso e eficiente, mas tem duas limitações significativas:</span><span class="sxs-lookup"><span data-stu-id="981b6-106">The DirSync control is powerful and efficient, but has two significant limitations:</span></span>

-   <span data-ttu-id="981b6-107">Somente para aplicativos altamente privilegiados: para usar o controle DirSync, um aplicativo deve ser executado em uma conta que tenha o privilégio de **\_ nome do \_ agente \_ de sincronização se** no controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="981b6-107">Only for highly privileged applications: To use the DirSync control, an application must run under an account that has the **SE\_SYNC\_AGENT\_NAME** privilege on the domain controller.</span></span> <span data-ttu-id="981b6-108">Algumas contas são tão privilegiadas, portanto, um aplicativo que usa o controle DirSync não pode ser executado por usuários comuns.</span><span class="sxs-lookup"><span data-stu-id="981b6-108">Few accounts are so highly privileged, so an application that uses the DirSync control cannot be run by ordinary users.</span></span>
-   <span data-ttu-id="981b6-109">Nenhum escopo de subárvore: o controle DirSync retorna todas as alterações que ocorrem dentro de um contexto de nomenclatura.</span><span class="sxs-lookup"><span data-stu-id="981b6-109">No subtree scoping: The DirSync control returns all changes that occur within a naming context.</span></span> <span data-ttu-id="981b6-110">Um aplicativo interessado apenas em alterações que ocorrem em uma subárvore pequena de um contexto de nomenclatura deve ser alterado por meio de muitas alterações irrelevantes, o que é ineficiente para o aplicativo e para o controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="981b6-110">An application interested only in changes that occur in a small subtree of a naming context must wade through many irrelevant changes, which is inefficient both for the application and for the domain controller.</span></span>

<span data-ttu-id="981b6-111">As alterações de Active Directory também podem ser obtidas consultando o atributo [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) , que evita as limitações do controle DirSync.</span><span class="sxs-lookup"><span data-stu-id="981b6-111">Changes from Active Directory can also be obtained by querying the [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute, which avoids the limitations of the DirSync control.</span></span> <span data-ttu-id="981b6-112">Essa alternativa não é melhor do que o controle DirSync em todos os aspectos porque envolve a transmissão de todos os atributos quando qualquer atributo é alterado e requer mais trabalho do desenvolvedor de aplicativos para lidar corretamente com determinados cenários de falha.</span><span class="sxs-lookup"><span data-stu-id="981b6-112">This alternative is not better than the DirSync control in all respects because it involves transmitting all attributes when any attribute changes and it requires more work from the application developer to handle certain failure scenarios correctly.</span></span> <span data-ttu-id="981b6-113">Atualmente, é a melhor maneira de escrever determinados aplicativos de controle de alterações.</span><span class="sxs-lookup"><span data-stu-id="981b6-113">It is, currently, the best way to write certain change-tracking applications.</span></span>

<span data-ttu-id="981b6-114">Quando um controlador de domínio modifica um objeto, ele define o atributo [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) do objeto como um valor maior do que o valor anterior do atributo **uSNChanged** para esse objeto e maior que o valor atual do atributo **uSNChanged** para todos os outros objetos mantidos nesse controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="981b6-114">When a domain controller modifies an object it sets that object's [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute to a value that is larger than the previous value of the **uSNChanged** attribute for that object, and larger than the current value of the **uSNChanged** attribute for all other objects held on that domain controller.</span></span> <span data-ttu-id="981b6-115">Como consequência, um aplicativo pode encontrar o objeto alterado mais recentemente em um controlador de domínio encontrando o objeto com o maior valor **uSNChanged** .</span><span class="sxs-lookup"><span data-stu-id="981b6-115">As a consequence, an application can find the most recently changed object on a domain controller by finding the object with the largest **uSNChanged** value.</span></span> <span data-ttu-id="981b6-116">O segundo objeto alterado mais recentemente em um controlador de domínio terá o segundo maior valor de **uSNChanged** e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="981b6-116">The second most recently changed object on a domain controller will have the second largest **uSNChanged** value, and so on.</span></span>

<span data-ttu-id="981b6-117">O atributo [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) não é replicado, portanto, ler o atributo **uSNChanged** de um objeto em dois controladores de domínio diferentes normalmente fornecerá valores diferentes.</span><span class="sxs-lookup"><span data-stu-id="981b6-117">The [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute is not replicated, therefore reading an object's **uSNChanged** attribute at two different domain controllers will typically give different values.</span></span>

<span data-ttu-id="981b6-118">Por exemplo, o atributo [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) pode ser usado para controlar as alterações em uma subárvore S. Primeiro, execute uma "sincronização completa" da subárvore S. suponha que o maior valor de **uSNChanged** para qualquer objeto em s seja U. consulte periodicamente todos os objetos na subárvore S cujo valor de **uSNChanged** é maior que U. A consulta retornará todos os objetos que foram alterados desde a sincronização completa. Defina para o maior **uSNChanged** entre esses objetos alterados e você estará pronto para sondar novamente.</span><span class="sxs-lookup"><span data-stu-id="981b6-118">For example, the [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute can be used to track changes in a subtree S. First, perform a "full sync" of the subtree S. Suppose the largest **uSNChanged** value for any object in S is U. Periodically query for all objects in subtree S whose **uSNChanged** value is greater than U. The query will return all objects that have changed since the full sync. Set U to the largest **uSNChanged** among these changed objects, and you are ready to poll again.</span></span>

<span data-ttu-id="981b6-119">As sutilezas da implementação de um aplicativo de sincronização [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) incluem:</span><span class="sxs-lookup"><span data-stu-id="981b6-119">The subtleties of implementing a [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) synchronization application include:</span></span>

-   <span data-ttu-id="981b6-120">Use o atributo **HighestCommittedUsn** de RootDSE para associar seus filtros de [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) .</span><span class="sxs-lookup"><span data-stu-id="981b6-120">Use the **highestCommittedUSN** attribute of rootDSE to bound your [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) filters.</span></span> <span data-ttu-id="981b6-121">Ou seja, antes de iniciar uma sincronização completa, leia o **HighestCommittedUsn** do controlador de domínio afiliado.</span><span class="sxs-lookup"><span data-stu-id="981b6-121">That is, before starting a full sync, read the **highestCommittedUSN** of your affiliated domain controller.</span></span> <span data-ttu-id="981b6-122">Em seguida, execute uma consulta de sincronização completa (usando os resultados paginados) para inicializar o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="981b6-122">Then, perform a full synchronization query (using paged results) to initialize the database.</span></span> <span data-ttu-id="981b6-123">Quando isso for concluído, armazene o valor de **HighestCommittedUsn** lido antes da consulta de sincronização completa; para usar como os limites inferiores do atributo **uSNChanged** para a próxima sincronização.</span><span class="sxs-lookup"><span data-stu-id="981b6-123">When this is complete, store the **highestCommittedUSN** value read before the full sync query; to use as the lower bounds of the **uSNChanged** attribute for the next synchronization.</span></span> <span data-ttu-id="981b6-124">Posteriormente, para executar uma sincronização incremental, leia novamente o atributo **HighestCommittedUsn** RootDSE.</span><span class="sxs-lookup"><span data-stu-id="981b6-124">Later, to perform an incremental synchronization, reread the **highestCommittedUSN** rootDSE attribute.</span></span> <span data-ttu-id="981b6-125">Em seguida, consulte os objetos relevantes, usando os resultados paginados, cujo **uSNChanged** é maior do que os limites inferiores do valor de atributo **uSNChanged** salvo da sincronização anterior.</span><span class="sxs-lookup"><span data-stu-id="981b6-125">Then query for relevant objects, using paged results, whose **uSNChanged** is greater than the lower bounds of the **uSNChanged** attribute value saved from the previous synchronization.</span></span> <span data-ttu-id="981b6-126">Atualize o banco de dados usando essas informações.</span><span class="sxs-lookup"><span data-stu-id="981b6-126">Update the database using this information.</span></span> <span data-ttu-id="981b6-127">Ao concluir, atualize os limites inferiores do atributo **uSNChanged** do valor **HighestCommittedUsn** lido antes da consulta de sincronização incremental.</span><span class="sxs-lookup"><span data-stu-id="981b6-127">When complete, update the lower bounds of the **uSNChanged** attribute from the **highestCommittedUSN** value read before the incremental synchronization query.</span></span> <span data-ttu-id="981b6-128">Sempre armazene os limites inferiores do valor do atributo **uSNChanged** no mesmo armazenamento que o aplicativo está sincronizando com o conteúdo do controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="981b6-128">Always store the lower bounds of the **uSNChanged** attribute value in the same storage that the application is synchronizing with the domain controller content.</span></span>

    <span data-ttu-id="981b6-129">Seguir esse procedimento, em vez de fazer isso com base nos valores de [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) em objetos recuperados, evita que o servidor Examine novamente os objetos atualizados que estão fora do conjunto que é aplicável ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="981b6-129">Following this procedure, rather than that based on [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) values on retrieved objects, avoids making the server reexamine updated objects that fall outside the set that is applicable to the application.</span></span>

-   <span data-ttu-id="981b6-130">Como [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) é um atributo não replicado, o aplicativo deve ser associado ao mesmo controlador de domínio sempre que for executado.</span><span class="sxs-lookup"><span data-stu-id="981b6-130">Because [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) is a non-replicated attribute, the application must bind to the same domain controller every time it runs.</span></span> <span data-ttu-id="981b6-131">Se ele não puder se associar a esse controlador de domínio, ele deverá aguardar até que ele possa fazer isso, ou afiliado a um novo controlador de domínio e executar uma sincronização completa com esse controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="981b6-131">If it cannot bind to that domain controller it must either wait until it can do so, or affiliate with some new domain controller and perform a full synchronization with that domain controller.</span></span> <span data-ttu-id="981b6-132">Quando o aplicativo afiliado a um controlador de domínio, ele registra o nome DNS desse controlador de domínio no armazenamento estável, que é o mesmo armazenamento que está mantendo consistente com o conteúdo do controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="981b6-132">When the application affiliates with a domain controller it records the DNS name of that domain controller in stable storage, which is the same storage it is keeping consistent with the domain controller content.</span></span> <span data-ttu-id="981b6-133">Em seguida, ele usa o nome DNS armazenado para associar ao mesmo controlador de domínio para sincronizações subsequentes.</span><span class="sxs-lookup"><span data-stu-id="981b6-133">Then it uses the stored DNS name to bind to the same domain controller for subsequent synchronizations.</span></span>
-   <span data-ttu-id="981b6-134">O aplicativo deve detectar quando o controlador de domínio no qual ele está afiliado no momento foi restaurado do backup, pois isso pode causar inconsistência.</span><span class="sxs-lookup"><span data-stu-id="981b6-134">The application must detect when the domain controller it is currently affiliated with has been restored from backup, because this can cause inconsistency.</span></span> <span data-ttu-id="981b6-135">Quando o aplicativo afiliado a um controlador de domínio, ele armazena em cache a "ID de invocação" desse controlador de domínio no armazenamento estável, ou seja, o mesmo armazenamento que está mantendo consistente com o conteúdo do controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="981b6-135">When the application affiliates with a domain controller it caches the "invocation id" of that domain controller in stable storage, that is, the same storage it is keeping consistent with the domain controller content.</span></span> <span data-ttu-id="981b6-136">A "ID de invocação" de um controlador de domínio é um GUID armazenado no atributo **inrevocationid** do objeto de serviço do controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="981b6-136">The "invocation id" of a domain controller is a GUID stored in the **invocationID** attribute of the domain controller's service object.</span></span> <span data-ttu-id="981b6-137">Para obter o nome distinto do objeto de serviço de um controlador de domínio, leia o atributo **dsServiceName** do RootDSE.</span><span class="sxs-lookup"><span data-stu-id="981b6-137">To get the distinguished name of a domain controller's service object, read the **dsServiceName** attribute of the rootDSE.</span></span>

    <span data-ttu-id="981b6-138">Lembre-se de que, quando o armazenamento estável do aplicativo é restaurado do backup, não há nenhum problema de consistência porque o nome do controlador de domínio, a ID de invocação e os limites inferiores do valor do atributo [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) são armazenados com os dados sincronizados com o conteúdo do controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="981b6-138">Be aware that when the application's stable storage is restored from backup there are no consistency problems because the domain controller name, invocation id, and lower bounds of the [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute value are stored with the data synchronized with the domain controller content.</span></span>

-   <span data-ttu-id="981b6-139">Use a paginação ao consultar o servidor, tanto as sincronizações completas quanto as incrementais, para evitar a possibilidade de recuperar grandes conjuntos de resultados simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="981b6-139">Use paging when querying the server, both full and incremental synchronizations, to avoid the possibility of retrieving large result sets simultaneously.</span></span> <span data-ttu-id="981b6-140">Para obter mais informações, consulte [especificando outras opções de pesquisa](specifying-other-search-options.md).</span><span class="sxs-lookup"><span data-stu-id="981b6-140">For more information, see [Specifying Other Search Options](specifying-other-search-options.md).</span></span>
-   <span data-ttu-id="981b6-141">Execute consultas baseadas em índice para evitar forçar o servidor a armazenar grandes resultados intermediários ao usar os resultados paginados.</span><span class="sxs-lookup"><span data-stu-id="981b6-141">Perform index-based queries to avoid forcing the server to store large intermediate results when using paged results.</span></span> <span data-ttu-id="981b6-142">Para obter mais informações, consulte [atributos indexados](indexed-attributes.md).</span><span class="sxs-lookup"><span data-stu-id="981b6-142">For more information, see [Indexed Attributes](indexed-attributes.md).</span></span>
-   <span data-ttu-id="981b6-143">Em geral, não use a classificação do lado do servidor dos resultados da pesquisa, o que pode forçar o servidor a armazenar e classificar grandes resultados intermediários.</span><span class="sxs-lookup"><span data-stu-id="981b6-143">In general, do not use server-side sorting of search results, which can force the server to store and sort large intermediate results.</span></span> <span data-ttu-id="981b6-144">Isso se aplica a Sincronizações completas e incrementais.</span><span class="sxs-lookup"><span data-stu-id="981b6-144">This applies to both full and incremental synchronizations.</span></span> <span data-ttu-id="981b6-145">Para obter mais informações, consulte [especificando outras opções de pesquisa](specifying-other-search-options.md).</span><span class="sxs-lookup"><span data-stu-id="981b6-145">For more information, see [Specifying Other Search Options](specifying-other-search-options.md).</span></span>
-   <span data-ttu-id="981b6-146">Manipule nenhuma condição pai normalmente.</span><span class="sxs-lookup"><span data-stu-id="981b6-146">Handle no parent conditions gracefully.</span></span> <span data-ttu-id="981b6-147">O aplicativo pode reconhecer um objeto antes de ter reconhecido seu pai.</span><span class="sxs-lookup"><span data-stu-id="981b6-147">The application may recognize an object before it has recognized its parent.</span></span> <span data-ttu-id="981b6-148">Dependendo do aplicativo, isso pode ou não ser um problema.</span><span class="sxs-lookup"><span data-stu-id="981b6-148">Depending upon the application, this may or may not be a problem.</span></span> <span data-ttu-id="981b6-149">O aplicativo sempre pode ler o estado atual do pai a partir do diretório.</span><span class="sxs-lookup"><span data-stu-id="981b6-149">The application can always read the current state of the parent from the directory.</span></span>
-   <span data-ttu-id="981b6-150">Para lidar com objetos movidos ou excluídos, armazene o atributo [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) de cada objeto rastreado.</span><span class="sxs-lookup"><span data-stu-id="981b6-150">To handle moved or deleted objects, store the [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) attribute of each tracked object.</span></span> <span data-ttu-id="981b6-151">O atributo **objectGUID** de um objeto permanece inalterado, independentemente de onde ele é movido por toda a floresta.</span><span class="sxs-lookup"><span data-stu-id="981b6-151">An object's **objectGUID** attribute remains unchanged regardless of where it is moved throughout the forest.</span></span>
-   <span data-ttu-id="981b6-152">Para lidar com objetos movidos, execute Sincronizações completas periódicas ou aumente o escopo da pesquisa e filtre alterações não interessantes na extremidade do cliente.</span><span class="sxs-lookup"><span data-stu-id="981b6-152">To handle moved objects, either perform periodic full synchronizations or increase the search scope and filter out uninteresting changes at the client end.</span></span>
-   <span data-ttu-id="981b6-153">Para lidar com objetos excluídos, execute Sincronizações completas periódicas ou execute uma pesquisa separada para objetos excluídos ao executar uma sincronização incremental.</span><span class="sxs-lookup"><span data-stu-id="981b6-153">To handle deleted objects, either perform periodic full synchronizations or perform a separate search for deleted objects when you perform an incremental synchronization.</span></span> <span data-ttu-id="981b6-154">Quando você consulta objetos excluídos, recupere o [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) dos objetos excluídos para determinar os objetos a serem excluídos do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="981b6-154">When you query for deleted objects, retrieve the [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) of the deleted objects to determine the objects to delete from your database.</span></span> <span data-ttu-id="981b6-155">Para obter mais informações, consulte [recuperando objetos excluídos](retrieving-deleted-objects.md).</span><span class="sxs-lookup"><span data-stu-id="981b6-155">For more information, see [Retrieving Deleted Objects](retrieving-deleted-objects.md).</span></span>
-   <span data-ttu-id="981b6-156">Lembre-se de que os resultados da pesquisa incluem apenas os objetos e atributos que o chamador tem permissão para ler (com base nos descritores de segurança e nas DACLs nos vários objetos).</span><span class="sxs-lookup"><span data-stu-id="981b6-156">Be aware that the search results include only the objects and attributes that the caller has permission to read (based on the security descriptors and DACLs on the various objects).</span></span> <span data-ttu-id="981b6-157">Para obter mais informações, consulte [efeitos de segurança em consultas](effects-of-security-on-queries.md).</span><span class="sxs-lookup"><span data-stu-id="981b6-157">For more information, see [Effects of Security on Queries](effects-of-security-on-queries.md).</span></span>

<span data-ttu-id="981b6-158">Para obter mais informações e um exemplo de código que mostra os conceitos básicos de um aplicativo de sincronização USNChanged, consulte [código de exemplo para recuperar alterações usando USNChanged](example-code-to-retrieve-changes-using-usnchanged.md).</span><span class="sxs-lookup"><span data-stu-id="981b6-158">For more information, and a code example that shows the basics of a USNChanged synchronization application, see [Example Code to Retrieve Changes Using USNChanged](example-code-to-retrieve-changes-using-usnchanged.md).</span></span>

 

 