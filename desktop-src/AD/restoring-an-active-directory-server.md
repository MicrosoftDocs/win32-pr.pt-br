---
title: Restaurando um servidor de Active Directory
description: Os servidores de Active Directory devem ser restaurados offline.
ms.assetid: 91fbbdc1-0e84-4b89-8a38-4c8d0268992b
ms.tgt_platform: multiple
keywords:
- Restaurando Active Directory Active Directory
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 273d02fd50d6b3bd68a055a6a783566e4ebddcf7
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/17/2020
ms.locfileid: "103823631"
---
# <a name="restoring-an-active-directory-server"></a><span data-ttu-id="3be8b-104">Restaurando um servidor de Active Directory</span><span class="sxs-lookup"><span data-stu-id="3be8b-104">Restoring an Active Directory Server</span></span>

<span data-ttu-id="3be8b-105">Os servidores de Active Directory devem ser restaurados offline.</span><span class="sxs-lookup"><span data-stu-id="3be8b-105">Active Directory servers must be restored offline.</span></span> <span data-ttu-id="3be8b-106">O sistema deve ser reiniciado no modo de restauração dos serviços de diretório.</span><span class="sxs-lookup"><span data-stu-id="3be8b-106">The system must be restarted in Directory Services Restore mode.</span></span> <span data-ttu-id="3be8b-107">Nesse modo, o sistema operacional está sendo executado sem Active Directory Domain Services e toda a validação do usuário ocorre por meio do SAM (Gerenciador de contas de segurança) no registro.</span><span class="sxs-lookup"><span data-stu-id="3be8b-107">In this mode, the operating system is running without Active Directory Domain Services and all user validation occurs through the Security Accounts Manager (SAM) in the registry.</span></span> <span data-ttu-id="3be8b-108">Para restaurar Active Directory Domain Services, use as credenciais de um administrador local no controlador de domínio que é restaurado.</span><span class="sxs-lookup"><span data-stu-id="3be8b-108">To restore Active Directory Domain Services, use the credentials of a local administrator on the domain controller that is restored.</span></span>

<span data-ttu-id="3be8b-109">O chamador das funções de restauração deve ter o privilégio de acesso de **\_ \_ nome de restauração se** .</span><span class="sxs-lookup"><span data-stu-id="3be8b-109">The caller of the restore functions must have the **SE\_RESTORE\_NAME** access privilege.</span></span> <span data-ttu-id="3be8b-110">Use a função [**DsSetAuthIdentity**](dssetauthidentity.md) para definir o contexto de segurança no qual as funções de backup e restauração do diretório são chamadas.</span><span class="sxs-lookup"><span data-stu-id="3be8b-110">Use the [**DsSetAuthIdentity**](dssetauthidentity.md) function to set the security context under which the directory backup and restore functions are called.</span></span>

<span data-ttu-id="3be8b-111">Lembre-se de que, ao restaurar Active Directory Domain Services, você também deve restaurar os outros componentes de estado do sistema.</span><span class="sxs-lookup"><span data-stu-id="3be8b-111">Be aware that when you restore Active Directory Domain Services, you must also restore the other system state components.</span></span>

<span data-ttu-id="3be8b-112">**Para restaurar Active Directory Domain Services**</span><span class="sxs-lookup"><span data-stu-id="3be8b-112">**To restore Active Directory Domain Services**</span></span>

1.  <span data-ttu-id="3be8b-113">Chame a função [**DsIsNTDSOnline**](dsisntdsonline.md) para determinar se Active Directory Domain Services estão em execução.</span><span class="sxs-lookup"><span data-stu-id="3be8b-113">Call the [**DsIsNTDSOnline**](dsisntdsonline.md) function to determine if Active Directory Domain Services are running.</span></span>
2.  <span data-ttu-id="3be8b-114">Se Active Directory Domain Services não estiverem em execução, a função [**DsRestorePrepare**](dsrestoreprepare.md) será chamada para inicializar a operação de restauração e obter um identificador de contexto de backup.</span><span class="sxs-lookup"><span data-stu-id="3be8b-114">If Active Directory Domain Services are not running, the [**DsRestorePrepare**](dsrestoreprepare.md) function is called to initialize the restore operation and obtain a backup context handle.</span></span> <span data-ttu-id="3be8b-115">Se Active Directory Domain Services estiver em execução, ele não poderá ser restaurado e o aplicativo de restauração deverá falhar na operação de restauração.</span><span class="sxs-lookup"><span data-stu-id="3be8b-115">If Active Directory Domain Services are running, it cannot be restored and the restore application must fail the restore operation.</span></span> <span data-ttu-id="3be8b-116">A função **DsRestorePrepare** requer que o token de expiração seja obtido da função [**DsBackupPrepare**](dsbackupprepare.md) durante a operação de backup.</span><span class="sxs-lookup"><span data-stu-id="3be8b-116">The **DsRestorePrepare** function requires that the expiry token be obtained from the [**DsBackupPrepare**](dsbackupprepare.md) function during the backup operation.</span></span>
3.  <span data-ttu-id="3be8b-117">Chame a função [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) para determinar os diretórios em que os arquivos devem ser restaurados.</span><span class="sxs-lookup"><span data-stu-id="3be8b-117">Call the [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) function to determine the directories where the files are to be restored.</span></span> <span data-ttu-id="3be8b-118">Se essa função falhar, restaure os dados de volta para o diretório de origem de backup original; Esse é o diretório do qual foi feito o backup dos dados.</span><span class="sxs-lookup"><span data-stu-id="3be8b-118">If this function fails, restore the data back to the original backup source directory; that is the directory from which the data was backed up.</span></span>
4.  <span data-ttu-id="3be8b-119">Chame a função [**DsRestoreRegister**](dsrestoreregister.md) para preparar o servidor de Active Directory para a operação de restauração e bloquear os diretórios de restauração.</span><span class="sxs-lookup"><span data-stu-id="3be8b-119">Call the [**DsRestoreRegister**](dsrestoreregister.md) function to prepare the Active Directory server for the restore operation and lock the restore directories.</span></span>
5.  <span data-ttu-id="3be8b-120">Use as funções padrão do Win32 para restaurar os arquivos.</span><span class="sxs-lookup"><span data-stu-id="3be8b-120">Use standard Win32 functions to restore the files.</span></span> <span data-ttu-id="3be8b-121">Primeiro, exclua todos os arquivos no diretório de destino; em seguida, copie os arquivos de backup para o diretório de destino.</span><span class="sxs-lookup"><span data-stu-id="3be8b-121">First, delete all files in the destination directory; then copy the backup files to the destination directory.</span></span>
6.  <span data-ttu-id="3be8b-122">Chame a função [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) para indicar que a restauração foi concluída.</span><span class="sxs-lookup"><span data-stu-id="3be8b-122">Call the [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) function to indicate that the restore has completed.</span></span>
7.  <span data-ttu-id="3be8b-123">Chame a função [**DsRestoreEnd**](dsrestoreend.md) para liberar todos os recursos associados ao contexto.</span><span class="sxs-lookup"><span data-stu-id="3be8b-123">Call the [**DsRestoreEnd**](dsrestoreend.md) function to release any resources associated with the context.</span></span>

<span data-ttu-id="3be8b-124">Após uma restauração no modo de restauração dos serviços de diretório, o controlador de domínio deve ser reiniciado no modo normal.</span><span class="sxs-lookup"><span data-stu-id="3be8b-124">After a restore in Directory Services Restore mode, the domain controller should be restarted in normal mode.</span></span> <span data-ttu-id="3be8b-125">Quando o serviço de diretório for iniciado, o controlador de domínio executará a verificação de consistência normal e o diretório restaurado será online.</span><span class="sxs-lookup"><span data-stu-id="3be8b-125">When the directory service starts, the domain controller will perform the normal consistency check and the restored directory will then be online.</span></span>

<span data-ttu-id="3be8b-126">Lembre-se de que a restauração de um servidor de Active Directory é sempre uma operação de duas partes.</span><span class="sxs-lookup"><span data-stu-id="3be8b-126">Be aware that restoring an Active Directory server is always a two-part operation.</span></span> <span data-ttu-id="3be8b-127">Primeiro, restaure o banco de dados para uma hora em que o backup foi feito.</span><span class="sxs-lookup"><span data-stu-id="3be8b-127">First, restore the database to a time when the backup was taken.</span></span> <span data-ttu-id="3be8b-128">Em segundo lugar, replique o diretório, em que o DSA restaurado recentemente Replica atualizações de pós-backup de outros DSAs no domínio e na floresta corporativa.</span><span class="sxs-lookup"><span data-stu-id="3be8b-128">Second, replicate the directory, where the newly restored DSA replicates post-backup updates from other DSAs in the domain and enterprise forest.</span></span>

<span data-ttu-id="3be8b-129">Um computador que executa o Windows 2000 ou o Windows Server 2003, que contém uma réplica do serviço de diretório, é um controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="3be8b-129">A computer running on Windows 2000 or Windows Server 2003, that contains a replica of the directory service, is a domain controller.</span></span>

<span data-ttu-id="3be8b-130">A função [**DsRestoreRegister**](dsrestoreregister.md) adiciona dados ao registro que devem sobreviver ao processo de restauração do registro para que a restauração funcione corretamente.</span><span class="sxs-lookup"><span data-stu-id="3be8b-130">The [**DsRestoreRegister**](dsrestoreregister.md) function adds data to the registry that must survive the registry restoration process for the restoration to work correctly.</span></span> <span data-ttu-id="3be8b-131">Para garantir que esses dados do registro sejam preservados, restaure Active Directory Domain Services com as funções **DsRestore \*** antes de reiniciar o computador depois que a função [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) for chamada.</span><span class="sxs-lookup"><span data-stu-id="3be8b-131">To ensure this registry data is preserved, restore Active Directory Domain Services with the **DsRestore\*** functions prior to restarting the computer after the [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) function is called.</span></span> <span data-ttu-id="3be8b-132">Esse processo funciona porque o **RegReplaceKey** , na verdade, não substitui o hive do registro até que o computador seja reiniciado e os dados do registro adicionados pela função **DsRestoreRegister** sejam especificamente excluídos de serem substituídos durante uma operação de restauração do registro.</span><span class="sxs-lookup"><span data-stu-id="3be8b-132">This process works because **RegReplaceKey** does not actually replace the registry hive until the computer is restarted and the registry data added by the **DsRestoreRegister** function is specifically excluded from being replaced during a registry restore operation.</span></span>

 

 