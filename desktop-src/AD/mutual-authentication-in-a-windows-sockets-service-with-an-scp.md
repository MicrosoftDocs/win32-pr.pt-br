---
title: Autenticação mútua em um serviço de soquetes do Windows com o SCP
description: Os tópicos nesta seção incluem exemplos de código que mostram como executar a autenticação mútua com um serviço que se publica usando um SCP (ponto de conexão de serviço).
ms.assetid: f730464c-95ac-4285-960c-18862f6f7852
ms.tgt_platform: multiple
keywords:
- Autenticação mútua em um serviço de soquetes do Windows com um SCP AD
- Active Directory, usando a autenticação mútua, o Windows Sockets Service com um SCP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 527715c4a35dc15cd67f5820e6fa891b56452399
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/17/2020
ms.locfileid: "103823648"
---
# <a name="mutual-authentication-in-a-windows-sockets-service-with-scp"></a><span data-ttu-id="029d3-105">Autenticação mútua em um serviço de soquetes do Windows com o SCP</span><span class="sxs-lookup"><span data-stu-id="029d3-105">Mutual Authentication in a Windows Sockets Service with SCP</span></span>

<span data-ttu-id="029d3-106">Os tópicos nesta seção incluem exemplos de código que mostram como executar a autenticação mútua com um serviço que se publica usando um SCP (ponto de conexão de serviço).</span><span class="sxs-lookup"><span data-stu-id="029d3-106">The topics in this section include code examples that show how to perform mutual authentication with a service that publishes itself using a service connection point (SCP).</span></span> <span data-ttu-id="029d3-107">Os exemplos são baseados em um Microsoft Windows Sockets Service que usa um pacote SSPI para lidar com a negociação de autenticação mútua entre um cliente e o serviço.</span><span class="sxs-lookup"><span data-stu-id="029d3-107">The examples are based on a Microsoft Windows Sockets service that uses an SSPI package to handle the mutual authentication negotiation between a client and the service.</span></span> <span data-ttu-id="029d3-108">Use os procedimentos a seguir para implementar a autenticação mútua nesse cenário.</span><span class="sxs-lookup"><span data-stu-id="029d3-108">Use the following procedures to implement mutual authentication within this scenario.</span></span>

<span data-ttu-id="029d3-109">**Para registrar SPNs em um diretório quando um serviço é instalado**</span><span class="sxs-lookup"><span data-stu-id="029d3-109">**To register SPNs in a directory when a service is installed**</span></span>

1.  <span data-ttu-id="029d3-110">Chame a função [**DsGetSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) para compor SPNs (nomes da entidade de serviço) para o serviço.</span><span class="sxs-lookup"><span data-stu-id="029d3-110">Call the [**DsGetSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) function to compose service principal names (SPNs) for the service.</span></span>
2.  <span data-ttu-id="029d3-111">Chame a função [**DsWriteAccountSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) para registrar os SPNs na conta de serviço ou conta de computador em cujo contexto o serviço será executado.</span><span class="sxs-lookup"><span data-stu-id="029d3-111">Call the [**DsWriteAccountSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) function to register the SPNs on the service account or computer account in whose context the service will run.</span></span> <span data-ttu-id="029d3-112">Esta etapa deve ser executada por um administrador de domínio; uma exceção é que um serviço em execução na conta LocalSystem pode registrar seu SPN no formato " <service class> / <host> " na conta de computador do host de serviço.</span><span class="sxs-lookup"><span data-stu-id="029d3-112">This step must be performed by a domain administrator; an exception is that a service running under the LocalSystem account can register its SPN in the form "<service class>/<host>" on the computer account of the service host.</span></span>

<span data-ttu-id="029d3-113">**Para verificar a configuração na inicialização do serviço**</span><span class="sxs-lookup"><span data-stu-id="029d3-113">**To verify configuration at service startup**</span></span>

-   <span data-ttu-id="029d3-114">Verifique se os SPNs apropriados estão registrados na conta sob a qual o serviço está sendo executado.</span><span class="sxs-lookup"><span data-stu-id="029d3-114">Verify that the appropriate SPNs are registered on the account under which the service is running.</span></span> <span data-ttu-id="029d3-115">Para obter mais informações, consulte [tarefas de manutenção de conta de logon](logon-account-maintenance-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="029d3-115">For more information, see [Logon Account Maintenance Tasks](logon-account-maintenance-tasks.md).</span></span>

<span data-ttu-id="029d3-116">**Para autenticar o serviço na inicialização do cliente**</span><span class="sxs-lookup"><span data-stu-id="029d3-116">**To authenticate the service at client startup**</span></span>

1.  <span data-ttu-id="029d3-117">Recuperar dados de conexão do ponto de conexão de serviço do serviço.</span><span class="sxs-lookup"><span data-stu-id="029d3-117">Retrieve connection data from the service's service connection point.</span></span>
2.  <span data-ttu-id="029d3-118">Estabeleça uma conexão com o serviço.</span><span class="sxs-lookup"><span data-stu-id="029d3-118">Establish a connection to the service.</span></span>
3.  <span data-ttu-id="029d3-119">Chame a função [**DsMakeSpn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) para compor um SPN para o serviço.</span><span class="sxs-lookup"><span data-stu-id="029d3-119">Call the [**DsMakeSpn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) function to compose an SPN for the service.</span></span> <span data-ttu-id="029d3-120">Redija o SPN da cadeia de caracteres de classe de serviço conhecida e os dados recuperados do ponto de conexão de serviço.</span><span class="sxs-lookup"><span data-stu-id="029d3-120">Compose the SPN from the known service class string, and the data retrieved from the service connection point.</span></span> <span data-ttu-id="029d3-121">Esses dados incluem o nome do host do servidor no qual o serviço está em execução.</span><span class="sxs-lookup"><span data-stu-id="029d3-121">This data includes the host name of the server on which the service is running.</span></span> <span data-ttu-id="029d3-122">Lembre-se de que o nome do host deve ser um nome DNS.</span><span class="sxs-lookup"><span data-stu-id="029d3-122">Be aware that the host name must be a DNS name.</span></span>
4.  <span data-ttu-id="029d3-123">Use um pacote de segurança SSPI para executar a autenticação:</span><span class="sxs-lookup"><span data-stu-id="029d3-123">Use an SSPI security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="029d3-124">Chame a função [**falha AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) para adquirir as credenciais do cliente.</span><span class="sxs-lookup"><span data-stu-id="029d3-124">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the client's credentials.</span></span>
    2.  <span data-ttu-id="029d3-125">Passe as credenciais do cliente e o SPN para a função [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) para gerar um blob de segurança a ser enviado ao serviço para autenticação.</span><span class="sxs-lookup"><span data-stu-id="029d3-125">Pass the client credentials and the SPN to the [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) function to generate a security blob to send to the service for authentication.</span></span> <span data-ttu-id="029d3-126">Defina o sinalizador de **\_ \_ \_ autenticação mútua de req do ISC** para solicitar autenticação mútua.</span><span class="sxs-lookup"><span data-stu-id="029d3-126">Set the **ISC\_REQ\_MUTUAL\_AUTH** flag to request mutual authentication.</span></span>
    3.  <span data-ttu-id="029d3-127">Troque os BLOBs pelo serviço até que a autenticação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="029d3-127">Exchange blobs with the service until the authentication is complete.</span></span>
5.  <span data-ttu-id="029d3-128">Verifique a máscara de recursos retornados para o sinalizador de **\_ \_ \_ autenticação mútua de req do ISC** para verificar se a autenticação mútua foi executada.</span><span class="sxs-lookup"><span data-stu-id="029d3-128">Verify the returned capabilities mask for the **ISC\_REQ\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
6.  <span data-ttu-id="029d3-129">Se a autenticação tiver sido bem-sucedida, troque o tráfego com o serviço autenticado.</span><span class="sxs-lookup"><span data-stu-id="029d3-129">If the authentication was successful, exchange traffic with the authenticated service.</span></span> <span data-ttu-id="029d3-130">Use a assinatura digital para garantir que as mensagens entre o cliente e o serviço não tenham sido violadas.</span><span class="sxs-lookup"><span data-stu-id="029d3-130">Use digital signing to ensure that messages between client and service have not been tampered with.</span></span> <span data-ttu-id="029d3-131">A menos que os requisitos de desempenho sejam graves, use a criptografia.</span><span class="sxs-lookup"><span data-stu-id="029d3-131">Unless performance requirements are severe, use encryption.</span></span> <span data-ttu-id="029d3-132">Para obter mais informações e um exemplo de código que mostra como usar as funções [**MakeSignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**EncryptMessage**](../SecAuthN/encryptmessage--general.md)e [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) em um pacote SSPI, consulte [garantindo a integridade da comunicação durante a troca de mensagens](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span><span class="sxs-lookup"><span data-stu-id="029d3-132">For more information and a code example that shows how to use the [**MakeSignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**EncryptMessage**](../SecAuthN/encryptmessage--general.md), and [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) functions in an SSPI package, see [Ensuring Communication Integrity During Message Exchange](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span></span>

<span data-ttu-id="029d3-133">**Para autenticar o cliente pelo serviço quando um cliente se conecta**</span><span class="sxs-lookup"><span data-stu-id="029d3-133">**To authenticate the client by the service when a client connects**</span></span>

1.  <span data-ttu-id="029d3-134">Carregue um pacote de segurança SSPI que dê suporte à autenticação mútua.</span><span class="sxs-lookup"><span data-stu-id="029d3-134">Load an SSPI security package that supports mutual authentication.</span></span>
2.  <span data-ttu-id="029d3-135">Quando um cliente se conecta, use o pacote de segurança para executar a autenticação:</span><span class="sxs-lookup"><span data-stu-id="029d3-135">When a client connects, use the security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="029d3-136">Chame a função [**falha AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) para adquirir as credenciais de serviço.</span><span class="sxs-lookup"><span data-stu-id="029d3-136">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the service credentials.</span></span>
    2.  <span data-ttu-id="029d3-137">Passe as credenciais de serviço e o blob de segurança recebido do cliente para a função [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) para gerar um blob de segurança para enviar de volta para o cliente.</span><span class="sxs-lookup"><span data-stu-id="029d3-137">Pass the service credentials and the security blob received from the client to the [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) function to generate a security blob to send back to the client.</span></span>
    3.  <span data-ttu-id="029d3-138">Troque os BLOBs pelo cliente até que a autenticação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="029d3-138">Exchange blobs with the client until the authentication is complete.</span></span>
3.  <span data-ttu-id="029d3-139">Verifique a máscara de recursos retornados para o sinalizador de **\_ \_ \_ autenticação mútua de ASC RET** para verificar se a autenticação mútua foi executada.</span><span class="sxs-lookup"><span data-stu-id="029d3-139">Check the returned capabilities mask for the **ASC\_RET\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
4.  <span data-ttu-id="029d3-140">Se a autenticação tiver sido bem-sucedida, troque o tráfego com o cliente autenticado.</span><span class="sxs-lookup"><span data-stu-id="029d3-140">If the authentication was successful, exchange traffic with the authenticated client.</span></span> <span data-ttu-id="029d3-141">Use a assinatura digital e a criptografia, a menos que o desempenho seja um problema.</span><span class="sxs-lookup"><span data-stu-id="029d3-141">Use digital signing and encryption unless performance is an issue.</span></span>

<span data-ttu-id="029d3-142">Para obter mais informações e um exemplo de código para esse cenário de autenticação mútua, consulte:</span><span class="sxs-lookup"><span data-stu-id="029d3-142">For more information and a code example for this mutual authentication scenario, see:</span></span>

-   [<span data-ttu-id="029d3-143">Como um cliente autentica um serviço Windows Sockets baseado em SCP</span><span class="sxs-lookup"><span data-stu-id="029d3-143">How a Client Authenticates an SCP-based Windows Sockets Service</span></span>](how-a-client-authenticates-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="029d3-144">Compor e registrar SPNs para um serviço de soquetes do Windows baseado em SCP</span><span class="sxs-lookup"><span data-stu-id="029d3-144">Composing and Registering SPNs for an SCP-based Windows Sockets Service</span></span>](composing-and-registering-spns-for-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="029d3-145">Como um serviço do Windows Sockets autentica um cliente</span><span class="sxs-lookup"><span data-stu-id="029d3-145">How a Windows Sockets Service Authenticates a Client</span></span>](how-a-windows-sockets-service-authenticates-a-client.md)

<span data-ttu-id="029d3-146">Para obter mais informações, consulte:</span><span class="sxs-lookup"><span data-stu-id="029d3-146">For more information, see:</span></span>

-   [<span data-ttu-id="029d3-147">Publicando com pontos de conexão de serviço</span><span class="sxs-lookup"><span data-stu-id="029d3-147">Publishing with service connection points</span></span>](publishing-with-service-connection-points.md)
-   [<span data-ttu-id="029d3-148">Documentação do SSPI</span><span class="sxs-lookup"><span data-stu-id="029d3-148">SSPI documentation</span></span>](/windows/desktop/SecAuthN/sspi)
-   [<span data-ttu-id="029d3-149">Documentação do Windows Sockets</span><span class="sxs-lookup"><span data-stu-id="029d3-149">Windows Sockets documentation</span></span>](/windows/desktop/WinSock/windows-sockets-start-page-2)

 

 