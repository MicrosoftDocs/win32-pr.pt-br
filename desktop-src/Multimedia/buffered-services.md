---
title: Serviços em buffer
description: Serviços em buffer
ms.assetid: 4816ab05-42fc-4c22-b753-8fd153d88c27
keywords:
- e/s de arquivo de multimídia, serviços em buffer
- e/s de arquivo, serviços em buffer
- entrada e saída (e/s), serviços em buffer
- E/s (entrada e saída), serviços em buffer
- e/s em buffer
- função mmioOpen
- buffer de e/s interno
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d014ed765609dd43886cc7b33987f8fd5ac7e65a
ms.sourcegitcommit: 7ef31bf778e76ce4196205d4c4c632fbdc649805
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 02/05/2021
ms.locfileid: "103923028"
---
# <a name="buffered-services"></a><span data-ttu-id="e28ab-110">Serviços em buffer</span><span class="sxs-lookup"><span data-stu-id="e28ab-110">Buffered Services</span></span>

<span data-ttu-id="e28ab-111">A maior parte da sobrecarga na e/s de arquivo ocorre ao acessar o dispositivo de mídia.</span><span class="sxs-lookup"><span data-stu-id="e28ab-111">Most of the overhead in file I/O occurs when accessing the media device.</span></span> <span data-ttu-id="e28ab-112">Se você estiver lendo ou escrevendo muitos blocos de informações pequenos, o dispositivo poderá passar muito tempo migrando para o local físico na mídia para cada operação de leitura ou gravação.</span><span class="sxs-lookup"><span data-stu-id="e28ab-112">If you are reading or writing many small blocks of information, the device can spend a lot of time moving to the physical location on the media for each read or write operation.</span></span> <span data-ttu-id="e28ab-113">Nesse caso, você pode obter um melhor desempenho usando os serviços de e/s de arquivo em buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-113">In this case, you can achieve better performance by using buffered file I/O services.</span></span> <span data-ttu-id="e28ab-114">Com e/s em buffer, o Gerenciador de e/s de arquivos mantém um buffer intermediário maior do que os blocos de informações que você está lendo ou gravando.</span><span class="sxs-lookup"><span data-stu-id="e28ab-114">With buffered I/O, the file I/O manager maintains an intermediate buffer larger than the blocks of information you are reading or writing.</span></span> <span data-ttu-id="e28ab-115">Ele acessa o dispositivo somente quando o buffer deve ser preenchido ou gravado no disco.</span><span class="sxs-lookup"><span data-stu-id="e28ab-115">It accesses the device only when the buffer must be filled from or written to the disk.</span></span>

<span data-ttu-id="e28ab-116">Antes de configurar e usar a e/s de arquivo em buffer, você deve decidir se deseja que o Gerenciador de e/s de arquivo ou o aplicativo aloque o buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-116">Before you set up and use buffered file I/O, you must decide whether you want the file I/O manager or the application to allocate the buffer.</span></span> <span data-ttu-id="e28ab-117">É mais simples permitir que o Gerenciador de e/s de arquivos aloque o buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-117">It is simpler to let the file I/O manager allocate the buffer.</span></span> <span data-ttu-id="e28ab-118">No entanto, você pode permitir que o aplicativo aloque o buffer se desejar acessar diretamente o buffer ou abrir um arquivo de memória.</span><span class="sxs-lookup"><span data-stu-id="e28ab-118">However, you can let the application allocate the buffer if you want to directly access the buffer or open a memory file.</span></span> <span data-ttu-id="e28ab-119">Para obter mais informações sobre como usar arquivos de memória, consulte [executando a e/s de arquivo de memória](performing-memory-file-i-o.md).</span><span class="sxs-lookup"><span data-stu-id="e28ab-119">For more information about using memory files, see [Performing Memory File I/O](performing-memory-file-i-o.md).</span></span> <span data-ttu-id="e28ab-120">Para obter um exemplo de acesso direto a um buffer de e/s, consulte [acessando um buffer de e/s de arquivo](accessing-a-file-i-o-buffer.md)</span><span class="sxs-lookup"><span data-stu-id="e28ab-120">For an example of directly accessing an I/O buffer, see [Accessing a File I/O Buffer](accessing-a-file-i-o-buffer.md)</span></span>

<span data-ttu-id="e28ab-121">Um buffer alocado pelo Gerenciador de e/s de arquivos é chamado de buffer de e/s interno.</span><span class="sxs-lookup"><span data-stu-id="e28ab-121">A buffer allocated by the file I/O manager is called an internal I/O buffer.</span></span> <span data-ttu-id="e28ab-122">Para abrir um arquivo para e/s armazenada em buffer usando um buffer interno, especifique o \_ sinalizador MMIO ALLOCBUF ao abrir o arquivo com a função [**mmioOpen**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioopen) .</span><span class="sxs-lookup"><span data-stu-id="e28ab-122">To open a file for buffered I/O using an internal buffer, specify the MMIO\_ALLOCBUF flag when you open the file with the [**mmioOpen**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioopen) function.</span></span> <span data-ttu-id="e28ab-123">A ilustração a seguir mostra o estado inicial do buffer de e/s de arquivo depois que um arquivo é aberto para uma operação de leitura em buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-123">The following illustration shows the initial state of the file I/O buffer after a file is opened for a buffered read operation.</span></span> <span data-ttu-id="e28ab-124">O buffer é transparente — você lê e busca como se estivesse usando e/s sem buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-124">The buffering is transparent — you read and seek as if you were using unbuffered I/O.</span></span> <span data-ttu-id="e28ab-125">A função **mmioOpen** definiu PchNext e *pchEndRead* para apontar para o início do buffer de e/s de arquivo.</span><span class="sxs-lookup"><span data-stu-id="e28ab-125">The **mmioOpen** function has set pchNext and *pchEndRead* to point to the beginning of the file I/O buffer.</span></span>

![Captura de tela que mostra ' pchEndRead ' e ' pchNext ' apontando para o início do buffer de e/s de arquivo.](images/mmio7.gif)

<span data-ttu-id="e28ab-127">A ilustração a seguir mostra o estado inicial do buffer de e/s de arquivo depois que um arquivo é aberto para uma operação de gravação em buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-127">The following illustration shows the initial state of the file I/O buffer after a file is opened for a buffered write operation.</span></span> <span data-ttu-id="e28ab-128">A função **mmioOpen** definiu **pchNext** para apontar para o início do buffer de e/s de arquivo e **pchEndWrite** para apontar para o final do buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-128">The **mmioOpen** function has set **pchNext** to point to the beginning of the file I/O buffer and **pchEndWrite** to point to the end of the buffer.</span></span>

![Captura de tela que mostra ' pchNext ' no início do buffer de e/s de arquivo e ' pchEndWrite ' no final.](images/mmio11.gif)

<span data-ttu-id="e28ab-130">O tamanho padrão do buffer de e/s interno é 8K.</span><span class="sxs-lookup"><span data-stu-id="e28ab-130">The default size of the internal I/O buffer is 8K.</span></span> <span data-ttu-id="e28ab-131">Se esse tamanho não for adequado, você poderá usar a função [**mmioSetBuffer**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetbuffer) para alterar o tamanho do buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-131">If this size is not adequate, you can use the [**mmioSetBuffer**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetbuffer) function to change the buffer size.</span></span> <span data-ttu-id="e28ab-132">Você também pode usar essa função para habilitar o armazenamento em buffer em um arquivo aberto para e/s não armazenada em buffer, ou para fornecer seu próprio buffer para uso como um arquivo de memória.</span><span class="sxs-lookup"><span data-stu-id="e28ab-132">You can also use this function to enable buffering on a file opened for unbuffered I/O, or to supply your own buffer for use as a memory file.</span></span>

<span data-ttu-id="e28ab-133">Você pode forçar o conteúdo de um buffer de e/s a ser gravado no disco usando a função [**mmioFlush**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioflush) .</span><span class="sxs-lookup"><span data-stu-id="e28ab-133">You can force the contents of an I/O buffer to be written to disk by using the [**mmioFlush**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioflush) function.</span></span> <span data-ttu-id="e28ab-134">No entanto, quando você fecha um arquivo usando a função [**mmioClose**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioclose) , não é necessário chamar **mmioFlush** para liberar um buffer de e/s — a função **mmioClose** o libera automaticamente.</span><span class="sxs-lookup"><span data-stu-id="e28ab-134">However, when you close a file by using the [**mmioClose**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioclose) function, you do not have to call **mmioFlush** to flush an I/O buffer — the **mmioClose** function automatically flushes it.</span></span> <span data-ttu-id="e28ab-135">Se você ficar sem espaço em disco, o **mmioFlush** poderá falhar, mesmo se as chamadas anteriores à função [**mmioWrite**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiowrite) tiverem sido bem-sucedidas.</span><span class="sxs-lookup"><span data-stu-id="e28ab-135">If you run out of disk space, **mmioFlush** could fail, even if the preceding calls to the [**mmioWrite**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiowrite) function were successful.</span></span> <span data-ttu-id="e28ab-136">Da mesma forma, **mmioClose** poderia falhar quando estiver liberando seu buffer de e/s.</span><span class="sxs-lookup"><span data-stu-id="e28ab-136">Similarly, **mmioClose** could fail when it is flushing its I/O buffer.</span></span>

<span data-ttu-id="e28ab-137">Os aplicativos que são sensíveis ao desempenho, como aqueles que transmitem dados em tempo real de um CD-ROM, podem otimizar o desempenho de e/s de arquivo acessando diretamente o buffer de e/s.</span><span class="sxs-lookup"><span data-stu-id="e28ab-137">Applications that are performance-sensitive, such as those that stream data in real time from a CD-ROM, can optimize file I/O performance by directly accessing the I/O buffer.</span></span> <span data-ttu-id="e28ab-138">Você deve ter cuidado se optar por fazer isso, pois você ignora algumas das proteções e verificação de erros fornecidas pelo Gerenciador de e/s de arquivos.</span><span class="sxs-lookup"><span data-stu-id="e28ab-138">You should be careful if you choose to do this, because you bypass some of the safeguards and error checking provided by the file I/O manager.</span></span>

<span data-ttu-id="e28ab-139">O Gerenciador de e/s de arquivos de multimídia usa a estrutura [**MMIOINFO**](/previous-versions//dd757322(v=vs.85)) para manter informações de estado sobre um arquivo aberto.</span><span class="sxs-lookup"><span data-stu-id="e28ab-139">The multimedia file I/O manager uses the [**MMIOINFO**](/previous-versions//dd757322(v=vs.85)) structure to maintain state information about an open file.</span></span> <span data-ttu-id="e28ab-140">Você usa três membros nessa estrutura para ler e gravar o buffer de e/s: **pchNext**, **pchEndRead** e **pchEndWrite**.</span><span class="sxs-lookup"><span data-stu-id="e28ab-140">You use three members in this structure to read and write the I/O buffer: **pchNext**, **pchEndRead**, and **pchEndWrite**.</span></span> <span data-ttu-id="e28ab-141">O membro **pchNext** aponta para o próximo local no buffer para leitura ou gravação.</span><span class="sxs-lookup"><span data-stu-id="e28ab-141">The **pchNext** member points to the next location in the buffer to read or write.</span></span> <span data-ttu-id="e28ab-142">Você deve incrementar esse membro enquanto lê e grava o buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-142">You must increment this member as you read and write the buffer.</span></span> <span data-ttu-id="e28ab-143">O membro **pchEndRead** identifica o último caractere válido que você pode ler do buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-143">The **pchEndRead** member identifies the last valid character you can read from the buffer.</span></span> <span data-ttu-id="e28ab-144">Da mesma forma, esse membro identifica o último local no buffer que você pode escrever.</span><span class="sxs-lookup"><span data-stu-id="e28ab-144">Likewise, this member identifies the last location in the buffer you can write.</span></span> <span data-ttu-id="e28ab-145">Mais precisamente, **pchEndRead** e **pchEndWrite** apontam para o local da memória que segue os últimos dados válidos no buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-145">More precisely, both **pchEndRead** and **pchEndWrite** point to the memory location that follows the last valid data in the buffer.</span></span> <span data-ttu-id="e28ab-146">Use as funções [**mmioGetInfo**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiogetinfo) e [**mmioSetInfo**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetinfo) para recuperar e definir informações de estado sobre o buffer de e/s de arquivo.</span><span class="sxs-lookup"><span data-stu-id="e28ab-146">Use the [**mmioGetInfo**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiogetinfo) and [**mmioSetInfo**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetinfo) functions to retrieve and set state information about the file I/O buffer.</span></span> <span data-ttu-id="e28ab-147">A ilustração a seguir mostra o estado do buffer de e/s depois que o aplicativo chama **mmioAdvance** durante uma operação de leitura.</span><span class="sxs-lookup"><span data-stu-id="e28ab-147">The following illustration shows the state of the I/O buffer after the application calls **mmioAdvance** during a read operation.</span></span> <span data-ttu-id="e28ab-148">A função **mmioAdvance** preenche o buffer e define o ponteiro **pchEndRead** para o final do buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-148">The **mmioAdvance** function fills the buffer and sets the **pchEndRead** pointer to the end of the buffer.</span></span>

![Captura de tela que mostra ' pchNext ' no início do buffer de e/s de arquivo e ' pchEndRead ' no final.](images/mmio8.gif)

<span data-ttu-id="e28ab-150">Na ilustração a seguir, o aplicativo lê o buffer de e/s no local especificado por **pchNext** e avança o ponteiro.</span><span class="sxs-lookup"><span data-stu-id="e28ab-150">In the following illustration, the application reads from the I/O buffer at the location specified by **pchNext**, and advances the pointer.</span></span>

![Captura de tela que mostra ' pchNext ' no meio do buffer de e/s de arquivo e ' pchEndRead ' no final.](images/mmio9.gif)

<span data-ttu-id="e28ab-152">Da mesma forma, para uma operação de gravação, o aplicativo grava no buffer de e/s e avança o ponteiro **pchNext** , conforme mostrado na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="e28ab-152">Similarly, for a write operation, the application writes to the I/O buffer and advances the **pchNext** pointer, as shown in the following illustration.</span></span>

![Captura de tela que mostra ' pchNext ' no meio do buffer de e/s de arquivo e ' pchEndWrite ' no final.](images/mmio12.gif)

<span data-ttu-id="e28ab-154">Depois que o aplicativo preenche o buffer, ele chama **mmioAdvance** para liberar o buffer para o disco.</span><span class="sxs-lookup"><span data-stu-id="e28ab-154">After the application fills the buffer, it calls **mmioAdvance** to flush the buffer to disk.</span></span> <span data-ttu-id="e28ab-155">A função **mmioAdvance** redefine **pchNext** para apontar para o início do buffer, conforme mostrado na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="e28ab-155">The **mmioAdvance** function resets **pchNext** to point to the beginning of the buffer, as shown in the following illustration.</span></span>

![Captura de tela que mostra ' pchNext ' no início do buffer de e/s de arquivo, o buffer no meio do E o F e ' pchEndWrite ' no final do buffer.](images/mmio13.gif)

<span data-ttu-id="e28ab-157">Quando você chegar ao final do buffer de e/s, deverá avançar o buffer para preenchê-lo a partir do disco, se você estiver lendo, ou liberá-lo para o disco, se você estiver escrevendo.</span><span class="sxs-lookup"><span data-stu-id="e28ab-157">When you reach the end of the I/O buffer, you must advance the buffer to fill it from the disk, if you are reading, or flush it to the disk, if you are writing.</span></span> <span data-ttu-id="e28ab-158">Use a função [**mmioAdvance**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioadvance) para avançar um buffer de e/s.</span><span class="sxs-lookup"><span data-stu-id="e28ab-158">Use the [**mmioAdvance**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioadvance) function to advance an I/O buffer.</span></span> <span data-ttu-id="e28ab-159">Para preencher um buffer de e/s do disco, use **mmioAdvance** com o \_ sinalizador de leitura MMIO.</span><span class="sxs-lookup"><span data-stu-id="e28ab-159">To fill an I/O buffer from disk, use **mmioAdvance** with the MMIO\_READ flag.</span></span> <span data-ttu-id="e28ab-160">Se não houver dados suficientes restantes no arquivo para preencher o buffer, o membro **pchEndRead** da estrutura **MMIOINFO** apontará para o local após o último byte válido no buffer.</span><span class="sxs-lookup"><span data-stu-id="e28ab-160">If there is not enough data remaining in the file to fill the buffer, the **pchEndRead** member of the **MMIOINFO** structure points to the location following the last valid byte in the buffer.</span></span> <span data-ttu-id="e28ab-161">Para liberar um buffer para o disco, defina o \_ sinalizador sujo MMIO no membro **dwFlags** da estrutura **MMIOINFO** e, em seguida, chame **MMIOADVANCE** com o sinalizador de \_ gravação MMIO.</span><span class="sxs-lookup"><span data-stu-id="e28ab-161">To flush a buffer to disk, set the MMIO\_DIRTY flag in the **dwFlags** member of the **MMIOINFO** structure and then call **mmioAdvance** with the MMIO\_WRITE flag.</span></span>

<span data-ttu-id="e28ab-162">Por exemplo, durante uma operação de leitura, a função **mmioAdvance** define **pchEndRead** para apontar para o final de dados válidos no buffer, conforme mostrado na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="e28ab-162">For example, during a read operation, the **mmioAdvance** function sets **pchEndRead** to point to the end of valid data in the buffer, as shown in the following illustration.</span></span>

![Captura de tela que mostra ' pchNext ' no início do buffer de e/s de arquivo, o buffer no final do E o F e ' pchEndRead ' no final do buffer.](images/mmio10.gif)

<span data-ttu-id="e28ab-164">Da mesma forma, durante uma operação de gravação, o aplicativo chama **mmioAdvance** para liberar o buffer e avançar **pchNext** para o final dos dados válidos no buffer, conforme mostrado na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="e28ab-164">Similarly, during a write operation, the application calls **mmioAdvance** to flush the buffer and advance **pchNext** to the end of valid data in the buffer, as shown in the following illustration.</span></span>

![imagem de buffer de e/s de arquivo](images/mmio14.gif)

 

 