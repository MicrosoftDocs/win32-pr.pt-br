---
description: Este documento apresenta cenários comuns de transferência de dados do Shell e discute como implementar cada um em seu aplicativo.
ms.assetid: 7fce555c-a93d-4414-9119-7ae9acdd4d89
title: Manipulação de cenários de Transferência de Dados do Shell
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 35855b66e4108580d5bac305855837563ca59785
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104967341"
---
# <a name="handling-shell-data-transfer-scenarios"></a><span data-ttu-id="4e004-103">Manipulação de cenários de Transferência de Dados do Shell</span><span class="sxs-lookup"><span data-stu-id="4e004-103">Handling Shell Data Transfer Scenarios</span></span>

<span data-ttu-id="4e004-104">O documento de [objeto de dados do Shell](dataobject.md) abordou a abordagem geral usada para transferir dados do shell com o recurso de arrastar e soltar ou a área de transferência.</span><span class="sxs-lookup"><span data-stu-id="4e004-104">The [Shell Data Object](dataobject.md) document discussed the general approach that is used to transfer Shell data with drag-and-drop or the Clipboard.</span></span> <span data-ttu-id="4e004-105">No entanto, para implementar a transferência de dados do Shell em seu aplicativo, você também deve entender como aplicar esses princípios e técnicas gerais à variedade de maneiras que os dados do Shell podem ser transferidos.</span><span class="sxs-lookup"><span data-stu-id="4e004-105">However, to implement Shell data transfer in your application, you must also understand how to apply these general principles and techniques to the variety of ways that Shell data can be transferred.</span></span> <span data-ttu-id="4e004-106">Este documento apresenta cenários comuns de transferência de dados do Shell e discute como implementar cada um em seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="4e004-106">This document presents common Shell data transfer scenarios and discusses how to implement each one in your application.</span></span>

-   [<span data-ttu-id="4e004-107">Diretrizes gerais</span><span class="sxs-lookup"><span data-stu-id="4e004-107">General Guidelines</span></span>](#general-guidelines)
-   [<span data-ttu-id="4e004-108">Copiando nomes de arquivo da área de transferência para um aplicativo</span><span class="sxs-lookup"><span data-stu-id="4e004-108">Copying File Names from the Clipboard to an Application</span></span>](#copying-file-names-from-the-clipboard-to-an-application)
    -   [<span data-ttu-id="4e004-109">Extraindo os nomes de arquivo do objeto de dados</span><span class="sxs-lookup"><span data-stu-id="4e004-109">Extracting the File Names from the Data Object</span></span>](#extracting-the-file-names-from-the-data-object)
-   [<span data-ttu-id="4e004-110">Copiando o conteúdo de um arquivo descartado em um aplicativo</span><span class="sxs-lookup"><span data-stu-id="4e004-110">Copying the Contents of a Dropped File into an Application</span></span>](#copying-the-contents-of-a-dropped-file-into-an-application)
    -   [<span data-ttu-id="4e004-111">Usando o \_ formato FILEcontent CFSTR para extrair dados de um arquivo</span><span class="sxs-lookup"><span data-stu-id="4e004-111">Using the CFSTR\_FILECONTENTS Format to Extract Data from a File</span></span>](/windows)
-   [<span data-ttu-id="4e004-112">Lidando com operações de movimentação otimizadas</span><span class="sxs-lookup"><span data-stu-id="4e004-112">Handling Optimized Move Operations</span></span>](#handling-optimized-move-operations)
-   [<span data-ttu-id="4e004-113">Manipulando operações de exclusão em colar</span><span class="sxs-lookup"><span data-stu-id="4e004-113">Handling Delete-on-Paste Operations</span></span>](#handling-delete-on-paste-operations)
-   [<span data-ttu-id="4e004-114">Transferindo dados de e para pastas virtuais</span><span class="sxs-lookup"><span data-stu-id="4e004-114">Transfering Data to and from Virtual Folders</span></span>](#transfering-data-to-and-from-virtual-folders)
    -   [<span data-ttu-id="4e004-115">Aceitando dados de uma pasta virtual</span><span class="sxs-lookup"><span data-stu-id="4e004-115">Accepting Data from a Virtual Folder</span></span>](#accepting-data-from-a-virtual-folder)
    -   [<span data-ttu-id="4e004-116">Transferindo dados de e para uma extensão de NameSpace</span><span class="sxs-lookup"><span data-stu-id="4e004-116">Transferring Data to and from a NameSpace Extension</span></span>](#transferring-data-to-and-from-a-namespace-extension)
-   [<span data-ttu-id="4e004-117">Descartando arquivos na lixeira</span><span class="sxs-lookup"><span data-stu-id="4e004-117">Dropping Files on the Recycle Bin</span></span>](#dropping-files-on-the-recycle-bin)
-   [<span data-ttu-id="4e004-118">Criando e importando arquivos de recorte</span><span class="sxs-lookup"><span data-stu-id="4e004-118">Creating and Importing Scrap Files</span></span>](#creating-and-importing-scrap-files)
    -   [<span data-ttu-id="4e004-119">Suporte a viagens de ida e volta</span><span class="sxs-lookup"><span data-stu-id="4e004-119">Round-trip Support</span></span>](#round-trip-support)
    -   [<span data-ttu-id="4e004-120">Formatos de dados em cache</span><span class="sxs-lookup"><span data-stu-id="4e004-120">Cached Data Formats</span></span>](#cached-data-formats)
    -   [<span data-ttu-id="4e004-121">Renderização atrasada</span><span class="sxs-lookup"><span data-stu-id="4e004-121">Delayed Rendering</span></span>](#delayed-rendering)
-   [<span data-ttu-id="4e004-122">Arrastando e soltando objetos do Shell de forma assíncrona</span><span class="sxs-lookup"><span data-stu-id="4e004-122">Dragging and Dropping Shell Objects Asynchronously</span></span>](#dragging-and-dropping-shell-objects-asynchronously)
    -   [<span data-ttu-id="4e004-123">Usando IASyncOperation/IDataObjectAsyncCapability</span><span class="sxs-lookup"><span data-stu-id="4e004-123">Using IASyncOperation/IDataObjectAsyncCapability</span></span>](#using-iasyncoperationidataobjectasynccapability)

> [!Note]  
> <span data-ttu-id="4e004-124">Embora cada um desses cenários discuta uma operação de transferência de dados específica, muitos deles se aplicam a uma variedade de cenários relacionados.</span><span class="sxs-lookup"><span data-stu-id="4e004-124">Although each of these scenarios discusses a specific data transfer operation, many of them apply to a variety of related scenarios.</span></span> <span data-ttu-id="4e004-125">Por exemplo, a principal diferença entre a maioria das transferências de área de transferência e arrastar e soltar está em como o objeto de dados chega ao destino.</span><span class="sxs-lookup"><span data-stu-id="4e004-125">For instance, the primary difference between most Clipboard and drag-and-drop transfers is in how the data object arrives at the target.</span></span> <span data-ttu-id="4e004-126">Depois que o destino tiver um ponteiro para a interface [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) do objeto de dados, os procedimentos para extração de informações serão basicamente os mesmos para os dois tipos de transferência de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-126">Once the target has a pointer to the data object's [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface, the procedures for extracting information are largely the same for both types of data transfer.</span></span> <span data-ttu-id="4e004-127">No entanto, alguns dos cenários são limitados a um tipo específico de operação.</span><span class="sxs-lookup"><span data-stu-id="4e004-127">However, some of the scenarios are limited to a specific type of operation.</span></span> <span data-ttu-id="4e004-128">Consulte o cenário individual para obter detalhes.</span><span class="sxs-lookup"><span data-stu-id="4e004-128">Refer to the individual scenario for details.</span></span>

 

## <a name="general-guidelines"></a><span data-ttu-id="4e004-129">Diretrizes gerais</span><span class="sxs-lookup"><span data-stu-id="4e004-129">General Guidelines</span></span>

<span data-ttu-id="4e004-130">Cada uma das seções a seguir aborda um cenário de transferência de dados único e razoavelmente específico.</span><span class="sxs-lookup"><span data-stu-id="4e004-130">Each of the following sections discusses a single, fairly specific data transfer scenario.</span></span> <span data-ttu-id="4e004-131">No entanto, as transferências de dados geralmente são mais complexas e podem envolver aspectos de vários cenários.</span><span class="sxs-lookup"><span data-stu-id="4e004-131">However, data transfers are often more complex and might involve aspects of several scenarios.</span></span> <span data-ttu-id="4e004-132">Normalmente, você não sabe, com antecedência, qual cenário você realmente precisará manipular.</span><span class="sxs-lookup"><span data-stu-id="4e004-132">You typically do not know, in advance, which scenario you will actually need to handle.</span></span> <span data-ttu-id="4e004-133">Aqui estão algumas diretrizes gerais para ter em mente.</span><span class="sxs-lookup"><span data-stu-id="4e004-133">Here are a few general guidelines to keep in mind.</span></span>

<span data-ttu-id="4e004-134">Para fontes de dados:</span><span class="sxs-lookup"><span data-stu-id="4e004-134">For data sources:</span></span>

-   <span data-ttu-id="4e004-135">Os formatos de área de transferência do Shell, com exceção de [CF \_ HDROP](clipboard.md), não são predefinidos.</span><span class="sxs-lookup"><span data-stu-id="4e004-135">The Shell Clipboard formats, with the exception of [CF\_HDROP](clipboard.md), are not predefined.</span></span> <span data-ttu-id="4e004-136">Cada formato que você deseja usar deve ser registrado chamando [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata).</span><span class="sxs-lookup"><span data-stu-id="4e004-136">Each format you want to use must be registered by calling [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata).</span></span>
-   <span data-ttu-id="4e004-137">Os formatos nos objetos de dados são fornecidos na ordem de preferência da origem.</span><span class="sxs-lookup"><span data-stu-id="4e004-137">The formats in the data objects are provided in the order of preference from the source.</span></span> <span data-ttu-id="4e004-138">Enumere o objeto de dados e escolha o primeiro que você pode consumir.</span><span class="sxs-lookup"><span data-stu-id="4e004-138">Enumerate the data object and pick the first one you can consume.</span></span>
-   <span data-ttu-id="4e004-139">Inclua quantos formatos você puder dar suporte.</span><span class="sxs-lookup"><span data-stu-id="4e004-139">Include as many formats as you can support.</span></span> <span data-ttu-id="4e004-140">Em geral, você não sabe onde o objeto de dados será Descartado.</span><span class="sxs-lookup"><span data-stu-id="4e004-140">You generally do not know where the data object will be dropped.</span></span> <span data-ttu-id="4e004-141">Essa prática melhora as chances de que o objeto de dados contenha um formato que o destino de soltar possa aceitar.</span><span class="sxs-lookup"><span data-stu-id="4e004-141">This practice improves the odds that the data object will contain a format that the drop target can accept.</span></span>
-   <span data-ttu-id="4e004-142">Os arquivos existentes devem ser oferecidos com o formato [ \_ HDROP do CF](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="4e004-142">Existing files should be offered with the [CF\_HDROP](clipboard.md) format.</span></span>
-   <span data-ttu-id="4e004-143">Ofereça dados como arquivos com [CFSTR \_ FileContent](clipboard.md) / [CFSTR formatos de \_ FileDescriptor](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="4e004-143">Offer file-like data with [CFSTR\_FILECONTENTS](clipboard.md)/[CFSTR\_FILEDESCRIPTOR](clipboard.md) formats.</span></span> <span data-ttu-id="4e004-144">Essa abordagem permite que o destino crie um arquivo de um objeto de dados sem precisar saber nada sobre o armazenamento de dados subjacente.</span><span class="sxs-lookup"><span data-stu-id="4e004-144">This approach allows the target to create a file from a data object without needing to know anything about the underlying data storage.</span></span> <span data-ttu-id="4e004-145">Normalmente, você deve apresentar os dados como uma interface [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) .</span><span class="sxs-lookup"><span data-stu-id="4e004-145">You should normally present the data as an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface.</span></span> <span data-ttu-id="4e004-146">Esse mecanismo de transferência de dados é mais flexível do que um objeto de memória global e usa muito menos memória.</span><span class="sxs-lookup"><span data-stu-id="4e004-146">This data transfer mechanism is more flexible than a global memory object and uses much less memory.</span></span>
-   <span data-ttu-id="4e004-147">As fontes de arrastar devem oferecer o formato [CFSTR \_ SHELLIDLIST](clipboard.md) ao arrastar itens de Shell.</span><span class="sxs-lookup"><span data-stu-id="4e004-147">Drag sources should offer the [CFSTR\_SHELLIDLIST](clipboard.md) format when dragging Shell items.</span></span> <span data-ttu-id="4e004-148">Os objetos de dados para itens podem ser adquiridos por meio dos métodos [**IShellFolder:: GetUIObjectOf**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getuiobjectof) ou [**IShellItem:: BindToHandler**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellitem-bindtohandler) .</span><span class="sxs-lookup"><span data-stu-id="4e004-148">Data objects for items can be acquired through either the [**IShellFolder::GetUIObjectOf**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getuiobjectof) or [**IShellItem::BindToHandler**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellitem-bindtohandler) methods.</span></span> <span data-ttu-id="4e004-149">As fontes de dados podem criar uma implementação de objeto de dados padrão que dê suporte ao formato [CFSTR \_ SHELLIDLIST](clipboard.md) usando [**SHCreateDataObject**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shcreatedataobject).</span><span class="sxs-lookup"><span data-stu-id="4e004-149">Data sources can create a standard data object implementation that supports the [CFSTR\_SHELLIDLIST](clipboard.md) format by using [**SHCreateDataObject**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shcreatedataobject).</span></span>
-   <span data-ttu-id="4e004-150">Os destinos de destino que desejam saber sobre os itens que estão sendo arrastados usando o modelo de programação de item de shell podem converter um IDataObject em um [**IShellitemArray**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellitemarray) usando [**SHCreateShellItemArrayFromDataObject**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-shcreateshellitemarrayfromdataobject).</span><span class="sxs-lookup"><span data-stu-id="4e004-150">Drop targets that want to reason about the items being dragged using the shell item programming model can convert an IDataObject into an [**IShellItemArray**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellitemarray) using [**SHCreateShellItemArrayFromDataObject**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-shcreateshellitemarrayfromdataobject).</span></span>
-   <span data-ttu-id="4e004-151">Use cursores de comentários padrão.</span><span class="sxs-lookup"><span data-stu-id="4e004-151">Use standard feedback cursors.</span></span>
-   <span data-ttu-id="4e004-152">Suporte para arrastar para a esquerda e para a direita.</span><span class="sxs-lookup"><span data-stu-id="4e004-152">Support left and right drag.</span></span>
-   <span data-ttu-id="4e004-153">Use o objeto de dados em si por meio de um objeto inserido.</span><span class="sxs-lookup"><span data-stu-id="4e004-153">Use the data object itself from an embedded object.</span></span> <span data-ttu-id="4e004-154">Essa abordagem permite que seu aplicativo Recupere todos os formatos extras que o objeto de dados tem a oferecer e evita a criação de uma camada extra de confinamento.</span><span class="sxs-lookup"><span data-stu-id="4e004-154">This approach allows your application to retrieve any extra formats the data object has to offer and avoids creating an extra layer of containment.</span></span> <span data-ttu-id="4e004-155">Por exemplo, um objeto incorporado do servidor A é arrastado do servidor/contêiner B e descartado no contêiner C. C deve criar um objeto inserido do servidor A, não um objeto incorporado do servidor B que contém um objeto incorporado do servidor A.</span><span class="sxs-lookup"><span data-stu-id="4e004-155">For instance, an embedded object from server A is dragged from server/container B and dropped on container C. C should create an embedded object of server A, not an embedded object of server B containing an embedded object of server A.</span></span>
-   <span data-ttu-id="4e004-156">Lembre-se de que o Shell pode usar operações [otimizadas de movimentação](#handling-optimized-move-operations) ou [exclusão](#handling-delete-on-paste-operations) ao mover arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-156">Remember that the Shell might use [optimized moves](#handling-optimized-move-operations) or [delete-on-paste](#handling-delete-on-paste-operations) operations when moving files.</span></span> <span data-ttu-id="4e004-157">Seu aplicativo deve ser capaz de reconhecer essas operações e responder adequadamente.</span><span class="sxs-lookup"><span data-stu-id="4e004-157">Your application should be able to recognize these operations and respond appropriately.</span></span>

<span data-ttu-id="4e004-158">Para destinos de dados:</span><span class="sxs-lookup"><span data-stu-id="4e004-158">For data targets:</span></span>

-   <span data-ttu-id="4e004-159">Os formatos de área de transferência do Shell, com exceção de [CF \_ HDROP](clipboard.md), não são predefinidos.</span><span class="sxs-lookup"><span data-stu-id="4e004-159">The Shell Clipboard formats, with the exception of [CF\_HDROP](clipboard.md), are not predefined.</span></span> <span data-ttu-id="4e004-160">Cada formato que você deseja usar deve ser registrado chamando [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata).</span><span class="sxs-lookup"><span data-stu-id="4e004-160">Each format you want to use must be registered by calling [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata).</span></span>
-   <span data-ttu-id="4e004-161">Implemente e registre um destino OLE drop.</span><span class="sxs-lookup"><span data-stu-id="4e004-161">Implement and register an OLE drop target.</span></span> <span data-ttu-id="4e004-162">Evite usar destinos do Windows 3,1 ou a mensagem do [**WM \_ DropFiles**](wm-dropfiles.md) , se possível.</span><span class="sxs-lookup"><span data-stu-id="4e004-162">Avoid using Windows 3.1 targets or the [**WM\_DROPFILES**](wm-dropfiles.md) message, if possible.</span></span>
-   <span data-ttu-id="4e004-163">Os formatos contidos por um objeto de dados variam de acordo com a origem do objeto.</span><span class="sxs-lookup"><span data-stu-id="4e004-163">The formats contained by a data object vary, depending on where the object comes from.</span></span> <span data-ttu-id="4e004-164">Como você geralmente não sabe com antecedência de onde vem um objeto de dados, não presuma que um determinado formato estará presente.</span><span class="sxs-lookup"><span data-stu-id="4e004-164">Since you generally do not know in advance where a data object comes from, do not assume that a particular format will be present.</span></span> <span data-ttu-id="4e004-165">O objeto de dados deve enumerar os formatos em ordem de qualidade, começando com o melhor.</span><span class="sxs-lookup"><span data-stu-id="4e004-165">The data object should enumerate the formats in order of quality, starting with the best.</span></span> <span data-ttu-id="4e004-166">Portanto, para obter o melhor formato disponível, os aplicativos normalmente enumeram os formatos disponíveis e usam o primeiro formato na enumeração para o qual eles podem dar suporte.</span><span class="sxs-lookup"><span data-stu-id="4e004-166">Thus, to get the best available format, applications normally enumerate the available formats and use the first format in the enumeration that they can support.</span></span>
-   <span data-ttu-id="4e004-167">Dê suporte ao arrastar com o botão direito.</span><span class="sxs-lookup"><span data-stu-id="4e004-167">Support right-drag.</span></span> <span data-ttu-id="4e004-168">Você pode personalizar o menu de atalho arrastar criando um [manipulador de arrastar e soltar](context-menu-handlers.md).</span><span class="sxs-lookup"><span data-stu-id="4e004-168">You can customize the drag shortcut menu by creating a [drag-and-drop handler](context-menu-handlers.md).</span></span>
-   <span data-ttu-id="4e004-169">Se seu aplicativo aceitar arquivos existentes, ele deverá ser capaz de manipular o formato [ \_ HDROP do CF](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="4e004-169">If your application will accept existing files, it must be able to handle the [CF\_HDROP](clipboard.md) format.</span></span>
-   <span data-ttu-id="4e004-170">Em geral, os aplicativos que aceitam arquivos também devem lidar com os formatos de fileCFSTR do [CFSTR \_ FileContent](clipboard.md) / [ \_ ](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="4e004-170">In general, applications that accept files should also handle the [CFSTR\_FILECONTENTS](clipboard.md)/[CFSTR\_FILEDESCRIPTOR](clipboard.md) formats.</span></span> <span data-ttu-id="4e004-171">Embora os arquivos do sistema de arquivos tenham o formato de [ \_ HDROP do CF](clipboard.md) , os arquivos de provedores como extensões de namespace geralmente usam [CFSTR \_ FileContent](clipboard.md) / [CFSTR \_ FileDescriptor](clipboard.md).</span><span class="sxs-lookup"><span data-stu-id="4e004-171">While files from the file system have the [CF\_HDROP](clipboard.md) format, files from providers such as namespace extensions generally use [CFSTR\_FILECONTENTS](clipboard.md)/[CFSTR\_FILEDESCRIPTOR](clipboard.md).</span></span> <span data-ttu-id="4e004-172">Os exemplos incluem pastas Windows CE, pastas protocolo FTP (FTP), pastas da Web e pastas CAB.</span><span class="sxs-lookup"><span data-stu-id="4e004-172">Examples include Windows CE folders, File Transfer Protocol (FTP) folders, web folders, and CAB folders.</span></span> <span data-ttu-id="4e004-173">Normalmente, a origem implementa uma interface [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) para apresentar dados de seu armazenamento como um arquivo.</span><span class="sxs-lookup"><span data-stu-id="4e004-173">The source normally implements an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface to present data from its storage as a file.</span></span>
-   <span data-ttu-id="4e004-174">Lembre-se de que o Shell pode usar operações [otimizadas de movimentação](#handling-optimized-move-operations) ou [exclusão](#handling-delete-on-paste-operations) ao mover arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-174">Remember that the Shell might use [optimized moves](#handling-optimized-move-operations) or [delete-on-paste](#handling-delete-on-paste-operations) operations when moving files.</span></span> <span data-ttu-id="4e004-175">Seu aplicativo deve ser capaz de reconhecer essas operações e responder adequadamente.</span><span class="sxs-lookup"><span data-stu-id="4e004-175">Your application should be able to recognize these operations and respond appropriately.</span></span>

## <a name="copying-file-names-from-the-clipboard-to-an-application"></a><span data-ttu-id="4e004-176">Copiando nomes de arquivo da área de transferência para um aplicativo</span><span class="sxs-lookup"><span data-stu-id="4e004-176">Copying File Names from the Clipboard to an Application</span></span>

<span data-ttu-id="4e004-177">**Cenário:** Um usuário seleciona um ou mais arquivos no Windows Explorer e os copia para a área de transferência.</span><span class="sxs-lookup"><span data-stu-id="4e004-177">**Scenario:** A user selects one or more files in Windows Explorer and copies them to the Clipboard.</span></span> <span data-ttu-id="4e004-178">Seu aplicativo extrai os nomes dos arquivos e os cola no documento.</span><span class="sxs-lookup"><span data-stu-id="4e004-178">Your application extracts the file names and pastes them into the document.</span></span>

<span data-ttu-id="4e004-179">Esse cenário pode ser usado, por exemplo, para permitir que um usuário crie um link HTML Recortando e colando o arquivo em seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="4e004-179">This scenario could be used, for instance, to allow a user to create an HTML link by cutting and pasting the file to your application.</span></span> <span data-ttu-id="4e004-180">Em seguida, seu aplicativo pode extrair o nome do arquivo do objeto de dados e processá-lo para criar uma marca de âncora.</span><span class="sxs-lookup"><span data-stu-id="4e004-180">Your application can then extract the file name from the data object and process it to create an anchor tag.</span></span>

<span data-ttu-id="4e004-181">Quando um usuário seleciona um arquivo no Windows Explorer e o copia para a área de transferência, o Shell cria um objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-181">When a user selects a file in Windows Explorer and copies it to the Clipboard, the Shell creates a data object.</span></span> <span data-ttu-id="4e004-182">Em seguida, ele chama [**OleSetClipboard**](/windows/win32/api/ole2/nf-ole2-olesetclipboard) para posicionar um ponteiro para a interface [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) do objeto de dados na área de transferência.</span><span class="sxs-lookup"><span data-stu-id="4e004-182">It then calls [**OleSetClipboard**](/windows/win32/api/ole2/nf-ole2-olesetclipboard) to place a pointer to the data object's [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface on the Clipboard.</span></span>

<span data-ttu-id="4e004-183">Quando o usuário seleciona o comando **colar** no menu ou na barra de ferramentas do seu aplicativo:</span><span class="sxs-lookup"><span data-stu-id="4e004-183">When the user selects the **Paste** command from your application's menu or toolbar:</span></span>

1.  <span data-ttu-id="4e004-184">Chame [**OleGetClipboard**](/windows/win32/api/ole2/nf-ole2-olegetclipboard) para recuperar a interface [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) do objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-184">Call [**OleGetClipboard**](/windows/win32/api/ole2/nf-ole2-olegetclipboard) to retrieve the data object's [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface.</span></span>
2.  <span data-ttu-id="4e004-185">Chame [**IDataObject:: EnumFormatEtc**](/windows/win32/api/objidl/nf-objidl-idataobject-enumformatetc) para solicitar um objeto enumerador.</span><span class="sxs-lookup"><span data-stu-id="4e004-185">Call [**IDataObject::EnumFormatEtc**](/windows/win32/api/objidl/nf-objidl-idataobject-enumformatetc) to request an enumerator object.</span></span>
3.  <span data-ttu-id="4e004-186">Use a interface [**IEnumFORMATETC**](/windows/win32/api/objidl/nn-objidl-ienumformatetc) do objeto enumerador para enumerar os formatos contidos no objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-186">Use the enumerator object's [**IEnumFORMATETC**](/windows/win32/api/objidl/nn-objidl-ienumformatetc) interface to enumerate the formats contained by the data object.</span></span>

> [!Note]  
> <span data-ttu-id="4e004-187">As duas etapas finais deste procedimento estão incluídas para fins de integridade.</span><span class="sxs-lookup"><span data-stu-id="4e004-187">The final two steps in this procedure are included for completeness.</span></span> <span data-ttu-id="4e004-188">Normalmente, eles não são necessários para transferências de arquivo simples.</span><span class="sxs-lookup"><span data-stu-id="4e004-188">They are typically not necessary for simple file transfers.</span></span> <span data-ttu-id="4e004-189">Todos os objetos de dados usados para esse tipo de transferência de dados devem conter o formato de [ \_ HDROP do CF](clipboard.md) , que pode ser usado para determinar os nomes dos arquivos contidos no objeto.</span><span class="sxs-lookup"><span data-stu-id="4e004-189">All data objects used for this type of data transfer should contain the [CF\_HDROP](clipboard.md) format, which can be used to determine the names of the files contained by the object.</span></span> <span data-ttu-id="4e004-190">No entanto, para transferências de dados mais gerais, você deve enumerar os formatos e selecionar o melhor que seu aplicativo pode manipular.</span><span class="sxs-lookup"><span data-stu-id="4e004-190">However, for more general data transfers, you should enumerate the formats and select the best one that your application can handle.</span></span>

 

### <a name="extracting-the-file-names-from-the-data-object"></a><span data-ttu-id="4e004-191">Extraindo os nomes de arquivo do objeto de dados</span><span class="sxs-lookup"><span data-stu-id="4e004-191">Extracting the File Names from the Data Object</span></span>

<span data-ttu-id="4e004-192">A próxima etapa é extrair um ou mais nomes de arquivo do objeto de dados e colá-los em seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="4e004-192">The next step is to extract one or more file names from the data object and paste them into your application.</span></span> <span data-ttu-id="4e004-193">Observe que o procedimento discutido nesta seção para extrair um nome de arquivo de um objeto de dados aplica-se igualmente bem às transferências de arrastar e soltar.</span><span class="sxs-lookup"><span data-stu-id="4e004-193">Note that the procedure discussed in this section for extracting a file name from a data object applies equally well to drag-and-drop transfers.</span></span>

<span data-ttu-id="4e004-194">A maneira mais simples de recuperar nomes de arquivo de um objeto de dados é o formato de [ \_ HDROP do CF](clipboard.md) :</span><span class="sxs-lookup"><span data-stu-id="4e004-194">The simplest way to retrieve file names from a data object is the [CF\_HDROP](clipboard.md) format:</span></span>

1.  <span data-ttu-id="4e004-195">Chamar [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata).</span><span class="sxs-lookup"><span data-stu-id="4e004-195">Call [**IDataObject::GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata).</span></span> <span data-ttu-id="4e004-196">Defina o membro **cfFormat** da estrutura [**FORMATETC**](/windows/win32/api/objidl/ns-objidl-formatetc) como [CF \_ HDROP](clipboard.md) e o membro **TYMED** como [TYMED \_ HGLOBAL](dataobject.md).</span><span class="sxs-lookup"><span data-stu-id="4e004-196">Set the **cfFormat** member of the [**FORMATETC**](/windows/win32/api/objidl/ns-objidl-formatetc) structure to [CF\_HDROP](clipboard.md) and the **tymed** member to [TYMED\_HGLOBAL](dataobject.md).</span></span> <span data-ttu-id="4e004-197">O membro **dwAspect** normalmente é definido como DVASPECT \_ Content.</span><span class="sxs-lookup"><span data-stu-id="4e004-197">The **dwAspect** member is normally set to DVASPECT\_CONTENT.</span></span> <span data-ttu-id="4e004-198">No entanto, se você precisar ter o caminho do arquivo em formato curto (8,3), defina **dwAspect** como DVASPECT \_ short.</span><span class="sxs-lookup"><span data-stu-id="4e004-198">However, if you need to have the file's path in short (8.3) format, set **dwAspect** to DVASPECT\_SHORT.</span></span>

    <span data-ttu-id="4e004-199">Quando [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) retorna, o membro **HGlobal** da estrutura [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) aponta para um objeto de memória global que contém os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-199">When [**IDataObject::GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) returns, the **hGlobal** member of the [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) structure points to a global memory object that contains the data.</span></span>

2.  <span data-ttu-id="4e004-200">Crie uma variável HDROP e defina-a como o membro **HGLOBAL** da estrutura [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) .</span><span class="sxs-lookup"><span data-stu-id="4e004-200">Create an HDROP variable and set it to the **hGlobal** member of the [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) structure.</span></span> <span data-ttu-id="4e004-201">A variável HDROP agora é um identificador para uma estrutura [**DropFiles**](/windows/desktop/api/shlobj_core/ns-shlobj_core-dropfiles) seguida por uma cadeia de caracteres dupla terminada com nulo que contém os caminhos de arquivo totalmente qualificados dos arquivos copiados.</span><span class="sxs-lookup"><span data-stu-id="4e004-201">The HDROP variable is now a handle to a [**DROPFILES**](/windows/desktop/api/shlobj_core/ns-shlobj_core-dropfiles) structure followed by a double null-terminated string containing the fully qualified file paths of the copied files.</span></span>
3.  <span data-ttu-id="4e004-202">Determine Quantos caminhos de arquivo estão na lista chamando [**DragQueryFile**](/windows/desktop/api/Shellapi/nf-shellapi-dragqueryfilea) com o parâmetro *ifile* definido como 0xFFFFFFFF.</span><span class="sxs-lookup"><span data-stu-id="4e004-202">Determine how many file paths are in the list by calling [**DragQueryFile**](/windows/desktop/api/Shellapi/nf-shellapi-dragqueryfilea) with the *iFile* parameter set to 0xFFFFFFFF.</span></span> <span data-ttu-id="4e004-203">A função retorna o número de caminhos de arquivo na lista.</span><span class="sxs-lookup"><span data-stu-id="4e004-203">The function returns the number of file paths in the list.</span></span> <span data-ttu-id="4e004-204">O índice de base zero do caminho do arquivo nessa lista é usado na próxima etapa para identificar um determinado caminho.</span><span class="sxs-lookup"><span data-stu-id="4e004-204">The file path's zero-based index in this list is used in the next step to identify a particular path.</span></span>
4.  <span data-ttu-id="4e004-205">Extraia os caminhos de arquivo do objeto de memória global chamando [**DragQueryFile**](/windows/desktop/api/Shellapi/nf-shellapi-dragqueryfilea) uma vez para cada arquivo, com *ifile* definido como o índice do arquivo.</span><span class="sxs-lookup"><span data-stu-id="4e004-205">Extract the file paths from the global memory object by calling [**DragQueryFile**](/windows/desktop/api/Shellapi/nf-shellapi-dragqueryfilea) once for each file, with *iFile* set to the file's index.</span></span>
5.  <span data-ttu-id="4e004-206">Processe os caminhos de arquivo conforme necessário e cole-os em seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="4e004-206">Process the file paths as needed and paste them into your application.</span></span>
6.  <span data-ttu-id="4e004-207">Chame [**ReleaseStgMedium**](/windows/win32/api/ole2/nf-ole2-releasestgmedium) e passe o ponteiro para a estrutura [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) que você passou para [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) na etapa 1.</span><span class="sxs-lookup"><span data-stu-id="4e004-207">Call [**ReleaseStgMedium**](/windows/win32/api/ole2/nf-ole2-releasestgmedium) and pass in the pointer to the [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) structure that you passed to [**IDataObject::GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) in step 1.</span></span> <span data-ttu-id="4e004-208">Depois de lançar a estrutura, o valor de HDROP que você criou na etapa 2 não será mais válido e não deverá ser usado.</span><span class="sxs-lookup"><span data-stu-id="4e004-208">Once you have released the structure, the HDROP value that you created in step 2 is no longer valid and should not be used.</span></span>

## <a name="copying-the-contents-of-a-dropped-file-into-an-application"></a><span data-ttu-id="4e004-209">Copiando o conteúdo de um arquivo descartado em um aplicativo</span><span class="sxs-lookup"><span data-stu-id="4e004-209">Copying the Contents of a Dropped File into an Application</span></span>

<span data-ttu-id="4e004-210">**Cenário:** Um usuário arrasta um ou mais arquivos do Windows Explorer e os descarta na janela do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="4e004-210">**Scenario:** A user drags one or more files from Windows Explorer and drops them on your application's window.</span></span> <span data-ttu-id="4e004-211">Seu aplicativo extrai o conteúdo dos arquivos e cola-o em seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="4e004-211">Your application extracts the content of the file (s) and pastes it into the application.</span></span>

<span data-ttu-id="4e004-212">Esse cenário usa o recurso de arrastar e soltar para transferir os arquivos do Windows Explorer para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="4e004-212">This scenario uses drag-and-drop to transfer the files from Windows Explorer to the application.</span></span> <span data-ttu-id="4e004-213">Antes da operação, seu aplicativo deve:</span><span class="sxs-lookup"><span data-stu-id="4e004-213">Prior to the operation, your application must:</span></span>

1.  <span data-ttu-id="4e004-214">Chame [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata) para registrar todos os formatos de área de transferência do Shell necessários.</span><span class="sxs-lookup"><span data-stu-id="4e004-214">Call [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata) to register any needed Shell Clipboard formats.</span></span>
2.  <span data-ttu-id="4e004-215">Chame [**RegisterDragDrop**](/windows/win32/api/ole2/nf-ole2-registerdragdrop) para registrar uma janela de destino e a interface [**IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="4e004-215">Call [**RegisterDragDrop**](/windows/win32/api/ole2/nf-ole2-registerdragdrop) to register a target window and your application's [**IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) interface.</span></span>

<span data-ttu-id="4e004-216">Depois que o usuário iniciar a operação selecionando um ou mais arquivos e começando a arrastá-los:</span><span class="sxs-lookup"><span data-stu-id="4e004-216">After the user initiates the operation by selecting one or more files and starting to drag them:</span></span>

1.  <span data-ttu-id="4e004-217">O Windows Explorer cria um objeto de dados e carrega os formatos com suporte nele.</span><span class="sxs-lookup"><span data-stu-id="4e004-217">Windows Explorer creates a data object and loads the supported formats into it.</span></span>
2.  <span data-ttu-id="4e004-218">O Windows Explorer chama [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) para iniciar o loop de arrastar.</span><span class="sxs-lookup"><span data-stu-id="4e004-218">Windows Explorer calls [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) to initiate the drag loop.</span></span>
3.  <span data-ttu-id="4e004-219">Quando a imagem de arrastar atingir sua janela de destino, o sistema o notificará chamando [**IDropTarget::D ragenter**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-dragenter).</span><span class="sxs-lookup"><span data-stu-id="4e004-219">When the drag image reaches your target window, the system notifies you by calling [**IDropTarget::DragEnter**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-dragenter).</span></span>
4.  <span data-ttu-id="4e004-220">Para determinar o que o objeto de dados contém, chame o método [**IDataObject:: EnumFormatEtc**](/windows/win32/api/objidl/nf-objidl-idataobject-enumformatetc) do objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-220">To determine what the data object contains, call the data object's [**IDataObject::EnumFormatEtc**](/windows/win32/api/objidl/nf-objidl-idataobject-enumformatetc) method.</span></span> <span data-ttu-id="4e004-221">Use o objeto enumerador retornado pelo método para enumerar os formatos contidos no objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-221">Use the enumerator object returned by the method to enumerate the formats contained by the data object.</span></span> <span data-ttu-id="4e004-222">Se seu aplicativo não quiser aceitar nenhum desses formatos, retorne DROPEFFECT \_ nenhum.</span><span class="sxs-lookup"><span data-stu-id="4e004-222">If your application does not want to accept any of these formats, return DROPEFFECT\_NONE.</span></span> <span data-ttu-id="4e004-223">Para os fins deste cenário, seu aplicativo deve ignorar todos os objetos de dados que não contêm formatos usados para transferir arquivos, como o [CF \_ HDROP](clipboard.md).</span><span class="sxs-lookup"><span data-stu-id="4e004-223">For the purposes of this scenario, your application should ignore any data objects that do not contain formats used to transfer files, such as [CF\_HDROP](clipboard.md).</span></span>
5.  <span data-ttu-id="4e004-224">Quando o usuário remove os dados, o sistema chama [**IDropTarget::D ROP**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop).</span><span class="sxs-lookup"><span data-stu-id="4e004-224">When the user drops the data, the system calls [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop).</span></span>
6.  <span data-ttu-id="4e004-225">Use a interface [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) para extrair o conteúdo dos arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-225">Use the [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface to extract the contents of the files.</span></span>

<span data-ttu-id="4e004-226">Há várias maneiras diferentes de extrair o conteúdo de um objeto de Shell de um objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-226">There are several different ways to extract the contents of a Shell object from a data object.</span></span> <span data-ttu-id="4e004-227">Em geral, use a seguinte ordem:</span><span class="sxs-lookup"><span data-stu-id="4e004-227">In general, use the following order:</span></span>

-   <span data-ttu-id="4e004-228">Se o arquivo contiver um formato de [ \_ texto do CF](clipboard.md) , os dados serão texto ANSI.</span><span class="sxs-lookup"><span data-stu-id="4e004-228">If the file contains a [CF\_TEXT](clipboard.md) format, the data is ANSI text.</span></span> <span data-ttu-id="4e004-229">Você pode usar o formato de texto do CF \_ para extrair os dados, em vez de abrir o próprio arquivo.</span><span class="sxs-lookup"><span data-stu-id="4e004-229">You can use the CF\_TEXT format to extract the data, rather than opening the file itself.</span></span>
-   <span data-ttu-id="4e004-230">Se o arquivo contiver um objeto OLE vinculado ou incorporado, o objeto de dados conterá um \_ formato CF incorporado.</span><span class="sxs-lookup"><span data-stu-id="4e004-230">If the file contains a linked or embedded OLE object, the data object contains a CF\_EMBEDDEDOBJECT format.</span></span> <span data-ttu-id="4e004-231">Use técnicas OLE padrão para extrair os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-231">Use standard OLE techniques to extract the data.</span></span> <span data-ttu-id="4e004-232">[Os arquivos de recorte](#creating-and-importing-scrap-files) sempre contêm um \_ formato CF incorporado.</span><span class="sxs-lookup"><span data-stu-id="4e004-232">[Scrap files](#creating-and-importing-scrap-files) always contain a CF\_EMBEDDEDOBJECT format.</span></span>
-   <span data-ttu-id="4e004-233">Se o objeto Shell for do sistema de arquivos, o objeto de dados conterá um formato de [ \_ HDROP do CF](clipboard.md) com os nomes dos arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-233">If the Shell object is from the file system, the data object contains a [CF\_HDROP](clipboard.md) format with the names of the files.</span></span> <span data-ttu-id="4e004-234">Extraia o nome de arquivo do [CF \_ HDROP](clipboard.md) e chame [**OleCreateFromFile**](/windows/win32/api/ole2/nf-ole2-olecreatefromfile) para criar um novo objeto vinculado ou inserido.</span><span class="sxs-lookup"><span data-stu-id="4e004-234">Extract the file name from [CF\_HDROP](clipboard.md) and call [**OleCreateFromFile**](/windows/win32/api/ole2/nf-ole2-olecreatefromfile) to create a new linked or embedded object.</span></span> <span data-ttu-id="4e004-235">Para obter uma discussão sobre como recuperar um nome de arquivo de um formato [ \_ HDROP do CF](clipboard.md) , consulte [copiando nomes de arquivo da área de transferência para um aplicativo](#copying-file-names-from-the-clipboard-to-an-application).</span><span class="sxs-lookup"><span data-stu-id="4e004-235">For a discussion of how to retrieve a file name from a [CF\_HDROP](clipboard.md) format, see [Copying File Names from the Clipboard to an Application](#copying-file-names-from-the-clipboard-to-an-application).</span></span>
-   <span data-ttu-id="4e004-236">Se o objeto de dados contiver um formato de [ \_ FileDescriptor CFSTR](clipboard.md) , você poderá extrair o conteúdo de um arquivo do formato [CFSTR \_ filecontents](clipboard.md) do arquivo.</span><span class="sxs-lookup"><span data-stu-id="4e004-236">If the data object contains a [CFSTR\_FILEDESCRIPTOR](clipboard.md) format, you can extract a file's contents from the file's [CFSTR\_FILECONTENTS](clipboard.md) format.</span></span> <span data-ttu-id="4e004-237">Para obter uma discussão sobre esse procedimento, consulte [usando o \_ formato FileContent CFSTR para extrair dados de um arquivo](/windows).</span><span class="sxs-lookup"><span data-stu-id="4e004-237">For a discussion of this procedure, see [Using the CFSTR\_FILECONTENTS Format to Extract Data from a File](/windows).</span></span>
-   <span data-ttu-id="4e004-238">Antes da [versão](versions.md)do Shell 4,71, um aplicativo indicou que ele estava transferindo um tipo de arquivo de atalho definindo **FD \_ LINKUI** no membro **dwFlags** da estrutura [**FileDescriptor**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) .</span><span class="sxs-lookup"><span data-stu-id="4e004-238">Prior to Shell [version 4.71](versions.md), an application indicated that it was transferring a shortcut file type by setting **FD\_LINKUI** in the **dwFlags** member of the [**FILEDESCRIPTOR**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) structure.</span></span> <span data-ttu-id="4e004-239">Para versões posteriores do Shell, a maneira preferida de indicar que os atalhos estão sendo transferidos é usar o formato [CFSTR \_ PREFERREDDROPEFFECT](clipboard.md) definido como DROPEFFECT \_ link.</span><span class="sxs-lookup"><span data-stu-id="4e004-239">For later versions of the Shell, the preferred way to indicate that shortcuts are being transferred is to use the [CFSTR\_PREFERREDDROPEFFECT](clipboard.md) format set to DROPEFFECT\_LINK.</span></span> <span data-ttu-id="4e004-240">Essa abordagem é muito mais eficiente do que extrair a estrutura do **FileDescriptor** apenas para verificar um sinalizador.</span><span class="sxs-lookup"><span data-stu-id="4e004-240">This approach is much more efficient than extracting the **FILEDESCRIPTOR** structure just to check a flag.</span></span>

<span data-ttu-id="4e004-241">Se o processo de extração de dados for longo, talvez você queira fazer a operação de forma assíncrona em um thread em segundo plano.</span><span class="sxs-lookup"><span data-stu-id="4e004-241">If the data extraction process will be lengthy, you might want to do the operation asynchronously on a background thread.</span></span> <span data-ttu-id="4e004-242">O thread principal pode prosseguir sem atrasos desnecessários.</span><span class="sxs-lookup"><span data-stu-id="4e004-242">Your primary thread can then proceed without unnecessary delays.</span></span> <span data-ttu-id="4e004-243">Para obter uma discussão sobre como lidar com a extração de dados assíncronos, consulte [arrastando e soltando objetos do Shell de forma assíncrona](#dragging-and-dropping-shell-objects-asynchronously).</span><span class="sxs-lookup"><span data-stu-id="4e004-243">For a discussion of how to handle asynchronous data extraction, see [Dragging and Dropping Shell Objects Asynchronously](#dragging-and-dropping-shell-objects-asynchronously).</span></span>

### <a name="using-the-cfstr_filecontents-format-to-extract-data-from-a-file"></a><span data-ttu-id="4e004-244">Usando o \_ formato FILEcontent CFSTR para extrair dados de um arquivo</span><span class="sxs-lookup"><span data-stu-id="4e004-244">Using the CFSTR\_FILECONTENTS Format to Extract Data from a File</span></span>

<span data-ttu-id="4e004-245">O [formato \_ FileContent CFSTR](clipboard.md) fornece uma maneira muito flexível e eficiente de transferir o conteúdo de um arquivo.</span><span class="sxs-lookup"><span data-stu-id="4e004-245">The [CFSTR\_FILECONTENTS](clipboard.md) format provides a very flexible and powerful way to transfer the contents of a file.</span></span> <span data-ttu-id="4e004-246">Não é nem necessário que os dados sejam armazenados como um único arquivo.</span><span class="sxs-lookup"><span data-stu-id="4e004-246">It is not even necessary for the data to be stored as a single file.</span></span> <span data-ttu-id="4e004-247">Tudo o que é necessário para esse formato é que o objeto de dados apresente os dados ao destino como se fosse um arquivo.</span><span class="sxs-lookup"><span data-stu-id="4e004-247">All that is required for this format is that the data object present the data to the target as if it were a file.</span></span> <span data-ttu-id="4e004-248">Por exemplo, os dados reais podem ser uma seção de um documento de texto ou um bloco de dados extraídos de um banco de dado.</span><span class="sxs-lookup"><span data-stu-id="4e004-248">For instance, the actual data might be a section of a text document or a block of data extracted from a database.</span></span> <span data-ttu-id="4e004-249">O destino pode tratar os dados como um arquivo e não precisa saber nada sobre o mecanismo de armazenamento subjacente.</span><span class="sxs-lookup"><span data-stu-id="4e004-249">The target can treat the data as a file and does not need to know anything about the underlying storage mechanism.</span></span>

<span data-ttu-id="4e004-250">Extensões de namespace normalmente usam [CFSTR \_ FileContent](clipboard.md) para transferir dados porque esse formato não assume nenhum mecanismo de armazenamento específico.</span><span class="sxs-lookup"><span data-stu-id="4e004-250">Namespace extensions normally use [CFSTR\_FILECONTENTS](clipboard.md) to transfer data because this format does not assume any particular storage mechanism.</span></span> <span data-ttu-id="4e004-251">Uma extensão de namespace pode usar qualquer mecanismo de armazenamento que seja conveniente e usar esse formato para apresentar seus objetos aos aplicativos como se fossem arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-251">A namespace extension can use whatever storage mechanism is convenient, and use this format to present its objects to applications as if they were files.</span></span>

<span data-ttu-id="4e004-252">O mecanismo de transferência de dados para [CFSTR \_ FileContent](clipboard.md) é normalmente [TYMED \_ IStream](dataobject.md).</span><span class="sxs-lookup"><span data-stu-id="4e004-252">The data transfer mechanism for [CFSTR\_FILECONTENTS](clipboard.md) is normally [TYMED\_ISTREAM](dataobject.md).</span></span> <span data-ttu-id="4e004-253">A transferência de um ponteiro de interface [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) requer muito menos memória do que carregar os dados em um objeto de memória global, e **IStream** é uma maneira mais simples de representar dados do que o [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage).</span><span class="sxs-lookup"><span data-stu-id="4e004-253">Transferring an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface pointer requires much less memory than loading the data into a global memory object, and **IStream** is a simpler way to represent data than [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage).</span></span>

<span data-ttu-id="4e004-254">Um [formato \_ FileContent CFSTR](clipboard.md) é sempre acompanhado por um formato de [ \_ FileDescriptor CFSTR](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="4e004-254">A [CFSTR\_FILECONTENTS](clipboard.md) format is always accompanied by a [CFSTR\_FILEDESCRIPTOR](clipboard.md) format.</span></span> <span data-ttu-id="4e004-255">Primeiro, você deve examinar o conteúdo desse formato.</span><span class="sxs-lookup"><span data-stu-id="4e004-255">You must examine the contents of this format first.</span></span> <span data-ttu-id="4e004-256">Se mais de um arquivo estiver sendo transferido, o objeto de dados conterá, na verdade, vários formatos [ \_ FileContent CFSTR](clipboard.md) , um para cada arquivo.</span><span class="sxs-lookup"><span data-stu-id="4e004-256">If more than one file is being transferred, the data object will actually contain multiple [CFSTR\_FILECONTENTS](clipboard.md) formats, one for each file.</span></span> <span data-ttu-id="4e004-257">O formato de [ \_ FileDescriptor CFSTR](clipboard.md) contém o nome e os atributos de cada arquivo e fornece um valor de índice para cada arquivo que é necessário para extrair um formato de [CFSTR \_ filecontents](clipboard.md) de um arquivo específico.</span><span class="sxs-lookup"><span data-stu-id="4e004-257">The [CFSTR\_FILEDESCRIPTOR](clipboard.md) format contains the name and attributes of each file, and provides an index value for each file that is needed to extract a particular file's [CFSTR\_FILECONTENTS](clipboard.md) format.</span></span>

<span data-ttu-id="4e004-258">Para extrair um [formato \_ FileContent CFSTR](clipboard.md) :</span><span class="sxs-lookup"><span data-stu-id="4e004-258">To extract a [CFSTR\_FILECONTENTS](clipboard.md) format:</span></span>

1.  <span data-ttu-id="4e004-259">Extraia o formato de [ \_ FileDescriptor CFSTR](clipboard.md) como um valor de [ \_ HGLOBAL TYMED](dataobject.md) .</span><span class="sxs-lookup"><span data-stu-id="4e004-259">Extract the [CFSTR\_FILEDESCRIPTOR](clipboard.md) format as a [TYMED\_HGLOBAL](dataobject.md) value.</span></span>
2.  <span data-ttu-id="4e004-260">O membro **HGLOBAL** da estrutura [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) retornada aponta para um objeto de memória global.</span><span class="sxs-lookup"><span data-stu-id="4e004-260">The **hGlobal** member of the returned [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) structure points to a global memory object.</span></span> <span data-ttu-id="4e004-261">Bloqueie esse objeto passando o valor de **HGLOBAL** para [**GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock).</span><span class="sxs-lookup"><span data-stu-id="4e004-261">Lock that object by passing the **hGlobal** value to [**GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock).</span></span>
3.  <span data-ttu-id="4e004-262">Converta o ponteiro retornado por [**GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock) em um ponteiro [**FILEGROUPDESCRIPTOR**](/windows/win32/api/shlobj_core/ns-shlobj_core-filegroupdescriptora) .</span><span class="sxs-lookup"><span data-stu-id="4e004-262">Cast the pointer returned by [**GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock) to a [**FILEGROUPDESCRIPTOR**](/windows/win32/api/shlobj_core/ns-shlobj_core-filegroupdescriptora) pointer.</span></span> <span data-ttu-id="4e004-263">Ele apontará para uma estrutura **FILEGROUPDESCRIPTOR** seguida por uma ou mais estruturas [**FileDescriptor**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) .</span><span class="sxs-lookup"><span data-stu-id="4e004-263">It will point to a **FILEGROUPDESCRIPTOR** structure followed by one or more [**FILEDESCRIPTOR**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) structures.</span></span> <span data-ttu-id="4e004-264">Cada estrutura de **FileDescriptor** contém uma descrição de um arquivo que está contido em um dos formatos de [ \_ FileContent CFSTR](clipboard.md) que o acompanha.</span><span class="sxs-lookup"><span data-stu-id="4e004-264">Each **FILEDESCRIPTOR** structure contains a description of a file that is contained by one of the accompanying [CFSTR\_FILECONTENTS](clipboard.md) formats.</span></span>
4.  <span data-ttu-id="4e004-265">Examine as estruturas do [**descritor**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) de arquivos para determinar qual delas corresponde ao arquivo que você deseja extrair.</span><span class="sxs-lookup"><span data-stu-id="4e004-265">Examine the [**FILEDESCRIPTOR**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) structures to determine which one corresponds to the file you want to extract.</span></span> <span data-ttu-id="4e004-266">O índice de base zero dessa estrutura de **FileDescriptor** é usado para identificar o formato [ \_ FileContent](clipboard.md) do arquivo CFSTR.</span><span class="sxs-lookup"><span data-stu-id="4e004-266">The zero-based index of that **FILEDESCRIPTOR** structure is used to identify the file's [CFSTR\_FILECONTENTS](clipboard.md) format.</span></span> <span data-ttu-id="4e004-267">Como o tamanho de um bloco de memória global não é preciso de byte, use os membros **nFileSizeLow** e **nFileSizeHigh** da estrutura para determinar quantos bytes representam o arquivo no objeto de memória global.</span><span class="sxs-lookup"><span data-stu-id="4e004-267">Because the size of a global memory block is not byte-precise, use the structure's **nFileSizeLow** and **nFileSizeHigh** members to determine how many bytes represent the file in the global memory object.</span></span>
5.  <span data-ttu-id="4e004-268">Chame [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) com o membro **CfFormat** da estrutura [**FORMATETC**](/windows/win32/api/objidl/ns-objidl-formatetc) definida como o valor [ \_ fileconters CFSTR](clipboard.md) e o membro **Lindex** definido como o índice que você determinou na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="4e004-268">Call [**IDataObject::GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) with the **cfFormat** member of the [**FORMATETC**](/windows/win32/api/objidl/ns-objidl-formatetc) structure set to the [CFSTR\_FILECONTENTS](clipboard.md) value and the **lIndex** member set to the index that you determined in the previous step.</span></span> <span data-ttu-id="4e004-269">O membro **TYMED** normalmente é definido como [TYMED \_ HGLOBAL](dataobject.md) \| TYMED \_ IStream \| TYMED \_ ISTORAGE.</span><span class="sxs-lookup"><span data-stu-id="4e004-269">The **tymed** member is typically set to [TYMED\_HGLOBAL](dataobject.md) \| TYMED\_ISTREAM \| TYMED\_ISTORAGE.</span></span> <span data-ttu-id="4e004-270">O objeto de dados pode escolher seu mecanismo de transferência de dados preferencial.</span><span class="sxs-lookup"><span data-stu-id="4e004-270">The data object can then choose its preferred data transfer mechanism.</span></span>
6.  <span data-ttu-id="4e004-271">A estrutura [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) que o [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) retornará conterá um ponteiro para os dados do arquivo.</span><span class="sxs-lookup"><span data-stu-id="4e004-271">The [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) structure that [**IDataObject::GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) returns will contain a pointer to the file's data.</span></span> <span data-ttu-id="4e004-272">Examine o membro **TYMED** da estrutura para determinar o mecanismo de transferência de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-272">Examine the **tymed** member of the structure to determine the data transfer mechanism.</span></span>
7.  <span data-ttu-id="4e004-273">Se **TYMED** for definido como [TYMED \_ IStream](dataobject.md) ou TYMED \_ ISTORAGE, use a interface para extrair os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-273">If **tymed** is set to [TYMED\_ISTREAM](dataobject.md) or TYMED\_ISTORAGE, use the interface to extract the data.</span></span> <span data-ttu-id="4e004-274">Se **TYMED** for definido como TYMED \_ HGLOBAL, os dados ficarão contidos em um objeto de memória global.</span><span class="sxs-lookup"><span data-stu-id="4e004-274">If **tymed** is set to TYMED\_HGLOBAL, the data is contained in a global memory object.</span></span> <span data-ttu-id="4e004-275">Para obter uma discussão sobre como extrair dados de um objeto de memória global, consulte a seção *extraindo um objeto de memória global de um* objeto de dados do [objeto de dados do Shell](dataobject.md).</span><span class="sxs-lookup"><span data-stu-id="4e004-275">For a discussion of how to extract data from a global memory object, see the *Extracting a global memory object from a data object* section of [Shell Data Object](dataobject.md).</span></span>
8.  <span data-ttu-id="4e004-276">Chame [**GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock) para desbloquear o objeto de memória global que você bloqueou na etapa 2.</span><span class="sxs-lookup"><span data-stu-id="4e004-276">Call [**GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock) to unlock the global memory object that you locked in step 2.</span></span>

## <a name="handling-optimized-move-operations"></a><span data-ttu-id="4e004-277">Lidando com operações de movimentação otimizadas</span><span class="sxs-lookup"><span data-stu-id="4e004-277">Handling Optimized Move Operations</span></span>

<span data-ttu-id="4e004-278">**Cenário:** Um arquivo é movido do sistema de arquivos para uma extensão de namespace usando uma movimentação otimizada.</span><span class="sxs-lookup"><span data-stu-id="4e004-278">**Scenario:** A file is moved from the file system to a namespace extension using an optimized move.</span></span>

<span data-ttu-id="4e004-279">Em uma operação de movimentação convencional, o destino faz uma cópia dos dados e a origem exclui o original.</span><span class="sxs-lookup"><span data-stu-id="4e004-279">In a conventional move operation, the target makes a copy of the data and the source deletes the original.</span></span> <span data-ttu-id="4e004-280">Esse procedimento pode ser ineficiente porque requer duas cópias dos dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-280">This procedure can be inefficient because it requires two copies of the data.</span></span> <span data-ttu-id="4e004-281">Com objetos grandes, como bancos de dados, uma operação de movimentação convencional pode não ser ainda prática.</span><span class="sxs-lookup"><span data-stu-id="4e004-281">With large objects such as databases, a conventional move operation might not even be practical.</span></span>

<span data-ttu-id="4e004-282">Com uma movimentação otimizada, o destino usa sua compreensão de como os dados são armazenados para lidar com toda a operação de movimentação.</span><span class="sxs-lookup"><span data-stu-id="4e004-282">With an optimized move, the target uses its understanding of how the data is stored to handle the entire move operation.</span></span> <span data-ttu-id="4e004-283">Nunca há uma segunda cópia dos dados, e não há necessidade de que a origem exclua os dados originais.</span><span class="sxs-lookup"><span data-stu-id="4e004-283">There is never a second copy of the data, and there is no need for the source to delete the original data.</span></span> <span data-ttu-id="4e004-284">Os dados do shell são adequados para movimentações otimizadas porque o destino pode manipular toda a operação usando a API do Shell.</span><span class="sxs-lookup"><span data-stu-id="4e004-284">Shell data is well suited to optimized moves because the target can handle the entire operation using the Shell API.</span></span> <span data-ttu-id="4e004-285">Um exemplo típico é A movimentação de arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-285">A typical example is moving files.</span></span> <span data-ttu-id="4e004-286">Depois que o destino tiver o caminho de um arquivo a ser movido, ele poderá usar [**SHFileOperation**](/windows/desktop/api/Shellapi/nf-shellapi-shfileoperationa) para movê-lo.</span><span class="sxs-lookup"><span data-stu-id="4e004-286">Once the target has the path of a file to be moved, it can use [**SHFileOperation**](/windows/desktop/api/Shellapi/nf-shellapi-shfileoperationa) to move it.</span></span> <span data-ttu-id="4e004-287">Não é necessário que a origem exclua o arquivo original.</span><span class="sxs-lookup"><span data-stu-id="4e004-287">There is no need for the source to delete the original file.</span></span>

> [!Note]  
> <span data-ttu-id="4e004-288">O Shell normalmente usa uma movimentação otimizada para mover arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-288">The Shell normally uses an optimized move to move files.</span></span> <span data-ttu-id="4e004-289">Para lidar corretamente com a transferência de dados do Shell, seu aplicativo deve ser capaz de detectar e lidar com uma movimentação otimizada.</span><span class="sxs-lookup"><span data-stu-id="4e004-289">To handle Shell data transfer properly, your application must be capable of detecting and handling an optimized move.</span></span>

 

<span data-ttu-id="4e004-290">As movimentações otimizadas são tratadas da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="4e004-290">Optimized moves are handled in the following way:</span></span>

1.  <span data-ttu-id="4e004-291">A origem chama [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) com o parâmetro *DWEFFECT* definido como DROPEFFECT \_ move para indicar que os objetos de origem podem ser movidos.</span><span class="sxs-lookup"><span data-stu-id="4e004-291">The source calls [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) with the *dwEffect* parameter set to DROPEFFECT\_MOVE to indicate that the source objects can be moved.</span></span>
2.  <span data-ttu-id="4e004-292">O destino recebe o \_ valor de movimentação DROPEFFECT por meio de um de seus métodos [**IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) , indicando que uma movimentação é permitida.</span><span class="sxs-lookup"><span data-stu-id="4e004-292">The target receives the DROPEFFECT\_MOVE value through one of its [**IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) methods, indicating that a move is allowed.</span></span>
3.  <span data-ttu-id="4e004-293">O destino copia o objeto (movimentação não otimizada) ou move o objeto (movimentação otimizada).</span><span class="sxs-lookup"><span data-stu-id="4e004-293">The target either copies the object (unoptimized move) or moves the object (optimized move).</span></span>
4.  <span data-ttu-id="4e004-294">O destino, em seguida, informa à origem se precisa excluir os dados originais.</span><span class="sxs-lookup"><span data-stu-id="4e004-294">The target then tells the source whether it needs to delete the original data.</span></span>

    <span data-ttu-id="4e004-295">Uma movimentação otimizada é a operação padrão, com os dados excluídos pelo destino.</span><span class="sxs-lookup"><span data-stu-id="4e004-295">An optimized move is the default operation, with the data deleted by the target.</span></span> <span data-ttu-id="4e004-296">Para informar à fonte que uma movimentação otimizada foi executada:</span><span class="sxs-lookup"><span data-stu-id="4e004-296">To inform the source that an optimized move was performed:</span></span>

    -   -   <span data-ttu-id="4e004-297">O destino define o valor de *pdwEffect* recebido por meio de seu [**IDropTarget::D método ROP**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) para algum valor diferente de DROPEFFECT \_ move.</span><span class="sxs-lookup"><span data-stu-id="4e004-297">The target sets the *pdwEffect* value it received through its [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) method to some value other than DROPEFFECT\_MOVE.</span></span> <span data-ttu-id="4e004-298">Normalmente, ele é definido como DROPEFFECT \_ None ou DROPEFFECT \_ Copy.</span><span class="sxs-lookup"><span data-stu-id="4e004-298">It is typically set to either DROPEFFECT\_NONE or DROPEFFECT\_COPY.</span></span> <span data-ttu-id="4e004-299">O valor será retornado para a origem por [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop).</span><span class="sxs-lookup"><span data-stu-id="4e004-299">The value will be returned to the source by [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop).</span></span>
        -   <span data-ttu-id="4e004-300">O destino também chama o método [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) do objeto de dados e passa a ele um identificador de formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) definido como DROPEFFECT \_ None.</span><span class="sxs-lookup"><span data-stu-id="4e004-300">The target also calls the data object's [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method and passes it a [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format identifier set to DROPEFFECT\_NONE.</span></span> <span data-ttu-id="4e004-301">Essa chamada de método é necessária porque alguns destinos de remoção podem não definir o parâmetro *pdwEffect* de [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) corretamente.</span><span class="sxs-lookup"><span data-stu-id="4e004-301">This method call is necessary because some drop targets might not set the *pdwEffect* parameter of [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) properly.</span></span> <span data-ttu-id="4e004-302">O formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) é a maneira confiável de indicar que uma movimentação otimizada foi feita.</span><span class="sxs-lookup"><span data-stu-id="4e004-302">The [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format is the reliable way to indicate that an optimized move has taken place.</span></span>

    <span data-ttu-id="4e004-303">Se o destino tiver feito uma movimentação não otimizada, os dados deverão ser excluídos pela origem.</span><span class="sxs-lookup"><span data-stu-id="4e004-303">If the target did an unoptimized move, the data must be deleted by the source.</span></span> <span data-ttu-id="4e004-304">Para informar à fonte que uma movimentação não otimizada foi executada:</span><span class="sxs-lookup"><span data-stu-id="4e004-304">To inform the source that an unoptimized move was performed:</span></span>

    -   -   <span data-ttu-id="4e004-305">O destino define o valor de *pdwEffect* recebido por meio de seu [**IDropTarget::D método ROP**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) para DROPEFFECT \_ mover.</span><span class="sxs-lookup"><span data-stu-id="4e004-305">The target sets the *pdwEffect* value it received through its [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) method to DROPEFFECT\_MOVE.</span></span> <span data-ttu-id="4e004-306">O valor será retornado para a origem por [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop).</span><span class="sxs-lookup"><span data-stu-id="4e004-306">The value will be returned to the source by [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop).</span></span>
        -   <span data-ttu-id="4e004-307">O destino também chama o método [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) do objeto de dados e passa a ele um identificador de formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) definido como DROPEFFECT \_ move.</span><span class="sxs-lookup"><span data-stu-id="4e004-307">The target also calls the data object's [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method and passes it a [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format identifier set to DROPEFFECT\_MOVE.</span></span> <span data-ttu-id="4e004-308">Essa chamada de método é necessária porque alguns destinos de remoção podem não definir o parâmetro *pdwEffect* de [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) corretamente.</span><span class="sxs-lookup"><span data-stu-id="4e004-308">This method call is necessary because some drop targets might not set the *pdwEffect* parameter of [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) properly.</span></span> <span data-ttu-id="4e004-309">O formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) é a maneira confiável de indicar que uma movimentação não otimizada foi feita.</span><span class="sxs-lookup"><span data-stu-id="4e004-309">The [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format is the reliable way to indicate that an unoptimized move has taken place.</span></span>

5.  <span data-ttu-id="4e004-310">A origem inspeciona os dois valores que podem ser retornados pelo destino.</span><span class="sxs-lookup"><span data-stu-id="4e004-310">The source inspects the two values that can be returned by the target.</span></span> <span data-ttu-id="4e004-311">Se ambos estiverem definidos como DROPEFFECT \_ move, ele concluirá a movimentação não otimizada excluindo os dados originais.</span><span class="sxs-lookup"><span data-stu-id="4e004-311">If both are set to DROPEFFECT\_MOVE, it completes the unoptimized move by deleting the original data.</span></span> <span data-ttu-id="4e004-312">Caso contrário, o destino fez uma movimentação otimizada e os dados originais foram excluídos.</span><span class="sxs-lookup"><span data-stu-id="4e004-312">Otherwise, the target did an optimized move and the original data has been deleted.</span></span>

## <a name="handling-delete-on-paste-operations"></a><span data-ttu-id="4e004-313">Manipulando operações de exclusão em colar</span><span class="sxs-lookup"><span data-stu-id="4e004-313">Handling Delete-on-Paste Operations</span></span>

<span data-ttu-id="4e004-314">**Cenário:** Um ou mais arquivos são recortados de uma pasta no Windows Explorer e colados em uma extensão de namespace.</span><span class="sxs-lookup"><span data-stu-id="4e004-314">**Scenario:** One or more files are cut from a folder in Windows Explorer and pasted into a namespace extension.</span></span> <span data-ttu-id="4e004-315">O Windows Explorer deixa os arquivos realçados até receber comentários sobre o resultado da operação de colagem.</span><span class="sxs-lookup"><span data-stu-id="4e004-315">Windows Explorer leaves the files highlighted until it receives feedback on the outcome of the paste operation.</span></span>

<span data-ttu-id="4e004-316">Tradicionalmente, quando um usuário recorta os dados, ele desaparece imediatamente da exibição.</span><span class="sxs-lookup"><span data-stu-id="4e004-316">Traditionally, when a user cuts data it immediately disappears from view.</span></span> <span data-ttu-id="4e004-317">Isso pode não ser eficiente e pode levar a problemas de usabilidade se o usuário se preocupar com o que aconteceu com os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-317">This might not be efficient, and it can lead to usability problems if the user becomes concerned about what has happened to the data.</span></span> <span data-ttu-id="4e004-318">Uma abordagem alternativa é usar uma operação de exclusão ao colar.</span><span class="sxs-lookup"><span data-stu-id="4e004-318">An alternative approach is to use a delete-on-paste operation.</span></span>

<span data-ttu-id="4e004-319">Com uma operação de exclusão na colagem, os dados selecionados não são removidos imediatamente da exibição.</span><span class="sxs-lookup"><span data-stu-id="4e004-319">With a delete-on-paste operation, the selected data is not immediately removed from view.</span></span> <span data-ttu-id="4e004-320">Em vez disso, o aplicativo de origem marca-o como selecionado, talvez alterando a cor da fonte ou do plano de fundo.</span><span class="sxs-lookup"><span data-stu-id="4e004-320">Instead, the source application marks it as selected, perhaps by changing the font or background color.</span></span> <span data-ttu-id="4e004-321">Depois que o aplicativo de destino colar os dados, ele notificará a origem sobre o resultado da operação.</span><span class="sxs-lookup"><span data-stu-id="4e004-321">After the target application has pasted the data, it notifies the source about the outcome of the operation.</span></span> <span data-ttu-id="4e004-322">Se o destino tiver executado uma [movimentação otimizada](#handling-optimized-move-operations), a origem poderá simplesmente atualizar sua exibição.</span><span class="sxs-lookup"><span data-stu-id="4e004-322">If the target performed an [optimized move](#handling-optimized-move-operations), the source can simply update its display.</span></span> <span data-ttu-id="4e004-323">Se o destino tiver realizado uma movimentação normal, a origem também deverá excluir sua cópia dos dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-323">If the target performed a normal move, the source must also delete its copy of the data.</span></span> <span data-ttu-id="4e004-324">Se a colagem falhar, o aplicativo de origem restaurará os dados selecionados para sua aparência original.</span><span class="sxs-lookup"><span data-stu-id="4e004-324">If the paste fails, the source application restores the selected data to its original appearance.</span></span>

> [!Note]  
> <span data-ttu-id="4e004-325">O Shell normalmente usa excluir-em-colar quando uma operação de recortar/colar é usada para mover arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-325">The Shell normally uses delete-on-paste when a cut/paste operation is used to move files.</span></span> <span data-ttu-id="4e004-326">As operações de exclusão ao colar com objetos shell normalmente usam uma [movimentação otimizada](#handling-optimized-move-operations) para mover os arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-326">Delete-on-paste operations with Shell objects normally use an [optimized move](#handling-optimized-move-operations) to move the files.</span></span> <span data-ttu-id="4e004-327">Para lidar corretamente com a transferência de dados do Shell, seu aplicativo deve ser capaz de detectar e manipular operações de exclusão no colar.</span><span class="sxs-lookup"><span data-stu-id="4e004-327">To handle Shell data transfer properly, your application must be capable of detecting and handling delete-on-paste operations.</span></span>

 

<span data-ttu-id="4e004-328">O requisito essencial para excluir-em-colar é que o destino deve relatar o resultado da operação para a origem.</span><span class="sxs-lookup"><span data-stu-id="4e004-328">The essential requirement for delete-on-paste is that the target must report the outcome of the operation to the source.</span></span> <span data-ttu-id="4e004-329">No entanto, técnicas de área de transferência padrão não podem ser usadas para implementar Delete-on-Paste porque não fornecem uma maneira para o destino se comunicar com a origem.</span><span class="sxs-lookup"><span data-stu-id="4e004-329">However, standard Clipboard techniques cannot be used to implement delete-on-paste because they do not provide a way for the target to communicate with the source.</span></span> <span data-ttu-id="4e004-330">Em vez disso, o aplicativo de destino usa o método [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) do objeto de dados para relatar o resultado ao objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-330">Instead, the target application uses the data object's [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method to report the outcome to the data object.</span></span> <span data-ttu-id="4e004-331">O objeto de dados pode então se comunicar com a origem por meio de uma interface privada.</span><span class="sxs-lookup"><span data-stu-id="4e004-331">The data object can then communicate with the source through a private interface.</span></span>

<span data-ttu-id="4e004-332">O procedimento básico para uma operação de exclusão em colar é o seguinte:</span><span class="sxs-lookup"><span data-stu-id="4e004-332">The basic procedure for a delete-on-paste operation is as follows:</span></span>

1.  <span data-ttu-id="4e004-333">A fonte marca a exibição da tela dos dados selecionados.</span><span class="sxs-lookup"><span data-stu-id="4e004-333">The source marks the screen display of the selected data.</span></span>
2.  <span data-ttu-id="4e004-334">A origem cria um objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-334">The source creates a data object.</span></span> <span data-ttu-id="4e004-335">Ele indica uma operação de recorte adicionando o formato [CFSTR \_ PREFERREDDROPEFFECT](clipboard.md) com um valor de dados de DROPEFFECT \_ move.</span><span class="sxs-lookup"><span data-stu-id="4e004-335">It indicates a cut operation by adding the [CFSTR\_PREFERREDDROPEFFECT](clipboard.md) format with a data value of DROPEFFECT\_MOVE.</span></span>
3.  <span data-ttu-id="4e004-336">A origem coloca o objeto de dados na área de transferência usando [**OleSetClipboard**](/windows/win32/api/ole2/nf-ole2-olesetclipboard).</span><span class="sxs-lookup"><span data-stu-id="4e004-336">The source places the data object on the Clipboard using [**OleSetClipboard**](/windows/win32/api/ole2/nf-ole2-olesetclipboard).</span></span>
4.  <span data-ttu-id="4e004-337">O destino recupera o objeto de dados da área de transferência usando [**OleGetClipboard**](/windows/win32/api/ole2/nf-ole2-olegetclipboard).</span><span class="sxs-lookup"><span data-stu-id="4e004-337">The target retrieves the data object from the Clipboard using [**OleGetClipboard**](/windows/win32/api/ole2/nf-ole2-olegetclipboard).</span></span>
5.  <span data-ttu-id="4e004-338">O destino extrai os dados do [CFSTR \_ PREFERREDDROPEFFECT](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="4e004-338">The target extracts the [CFSTR\_PREFERREDDROPEFFECT](clipboard.md) data.</span></span> <span data-ttu-id="4e004-339">Se estiver definido como somente DROPEFFECT \_ mover, o destino poderá fazer uma movimentação otimizada ou simplesmente copiar os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-339">If it is set to only DROPEFFECT\_MOVE, the target can either do an optimized move or simply copy the data.</span></span>
6.  <span data-ttu-id="4e004-340">Se o destino não fizer uma movimentação otimizada, ele chamará o método [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) com o formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) definido como DROPEFFECT \_ move.</span><span class="sxs-lookup"><span data-stu-id="4e004-340">If the target does not do an optimized move, it calls the [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method with the [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format set to DROPEFFECT\_MOVE.</span></span>
7.  <span data-ttu-id="4e004-341">Quando a colagem é concluída, o destino chama o método [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) com o formato [CFSTR \_ PASTESUCCEEDED](clipboard.md) definido como DROPEFFECT \_ move.</span><span class="sxs-lookup"><span data-stu-id="4e004-341">When the paste is complete, the target calls the [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method with the [CFSTR\_PASTESUCCEEDED](clipboard.md) format set to DROPEFFECT\_MOVE.</span></span>
8.  <span data-ttu-id="4e004-342">Quando o método [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) da origem é chamado com o formato [CFSTR \_ PASTESUCCEEDED](clipboard.md) definido como DROPEFFECT \_ move, ele deve verificar se ele também recebeu o formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) definido como DROPEFFECT \_ mover.</span><span class="sxs-lookup"><span data-stu-id="4e004-342">When the source's [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method is called with the [CFSTR\_PASTESUCCEEDED](clipboard.md) format set to DROPEFFECT\_MOVE, it must check to see if it also received the [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format set to DROPEFFECT\_MOVE.</span></span> <span data-ttu-id="4e004-343">Se ambos os formatos forem enviados pelo destino, a fonte terá que excluir os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-343">If both formats are sent by the target, the source will have to delete the data.</span></span> <span data-ttu-id="4e004-344">Se apenas o formato [CFSTR \_ PASTESUCCEEDED](clipboard.md) for recebido, a fonte poderá simplesmente remover os dados de sua exibição.</span><span class="sxs-lookup"><span data-stu-id="4e004-344">If only the [CFSTR\_PASTESUCCEEDED](clipboard.md) format is received, the source can simply remove the data from its display.</span></span> <span data-ttu-id="4e004-345">Se a transferência falhar, a origem atualizará a exibição para sua aparência original.</span><span class="sxs-lookup"><span data-stu-id="4e004-345">If the transfer fails, the source updates the display to its original appearance.</span></span>

## <a name="transfering-data-to-and-from-virtual-folders"></a><span data-ttu-id="4e004-346">Transferindo dados de e para pastas virtuais</span><span class="sxs-lookup"><span data-stu-id="4e004-346">Transfering Data to and from Virtual Folders</span></span>

<span data-ttu-id="4e004-347">**Cenário:** Um usuário arrasta um objeto do ou o descarta em uma pasta virtual.</span><span class="sxs-lookup"><span data-stu-id="4e004-347">**Scenario:** A user drags an object from or drops it on a virtual folder.</span></span>

<span data-ttu-id="4e004-348">As pastas virtuais contêm objetos que geralmente não fazem parte do sistema de arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-348">Virtual folders contain objects that are generally not part of the file system.</span></span> <span data-ttu-id="4e004-349">Algumas pastas virtuais, como a lixeira, podem representar dados armazenados no disco rígido, mas não como objetos comuns do sistema de arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-349">Some virtual folders, such as the Recycle Bin, can represent data that is stored on the hard disk but not as ordinary file system objects.</span></span> <span data-ttu-id="4e004-350">Alguns podem representar dados armazenados que estão em um sistema remoto, como um PC portátil ou um site FTP.</span><span class="sxs-lookup"><span data-stu-id="4e004-350">Some can represent stored data that is on a remote system, such as a handheld PC, or an FTP site.</span></span> <span data-ttu-id="4e004-351">Outros, como a pasta impressoras, contêm objetos que não representam dados armazenados.</span><span class="sxs-lookup"><span data-stu-id="4e004-351">Others, such as the Printers folder, contain objects that do not represent stored data at all.</span></span> <span data-ttu-id="4e004-352">Embora algumas pastas virtuais façam parte do sistema, os desenvolvedores também podem criar e instalar pastas virtuais personalizadas implementando uma extensão de namespace.</span><span class="sxs-lookup"><span data-stu-id="4e004-352">While some virtual folders are part of the system, developers can also create and install custom virtual folders by implementing a namespace extension.</span></span>

<span data-ttu-id="4e004-353">Independentemente do tipo de dados ou de como eles são armazenados, os objetos de pasta e arquivo contidos em uma pasta virtual são apresentados pelo shell como se fossem arquivos e pastas normais.</span><span class="sxs-lookup"><span data-stu-id="4e004-353">Regardless of the type of data or how it is stored, the folder and file objects that are contained by a virtual folder are presented by the Shell as if they were normal files and folders.</span></span> <span data-ttu-id="4e004-354">É responsabilidade da pasta virtual pegar quaisquer dados que ele contenha e apresentá-los ao shell adequadamente.</span><span class="sxs-lookup"><span data-stu-id="4e004-354">It is the responsibility of the virtual folder to take whatever data it contains and present it to the Shell appropriately.</span></span> <span data-ttu-id="4e004-355">Esse requisito significa que as pastas virtuais normalmente dão suporte a transferências de dados de arrastar e soltar e de área de transferência.</span><span class="sxs-lookup"><span data-stu-id="4e004-355">This requirement means that virtual folders normally support drag-and-drop and Clipboard data transfers.</span></span>

<span data-ttu-id="4e004-356">Há, portanto, dois grupos de desenvolvedores que precisam se preocupar com a transferência de dados de e para as pastas virtuais:</span><span class="sxs-lookup"><span data-stu-id="4e004-356">There are thus two groups of developers who need to be concerned with data transfer to and from virtual folders:</span></span>

-   <span data-ttu-id="4e004-357">Os desenvolvedores cujos aplicativos precisam aceitar dados transferidos de uma pasta virtual.</span><span class="sxs-lookup"><span data-stu-id="4e004-357">Developers whose applications need to accept data that is transferred from a virtual folder.</span></span>
-   <span data-ttu-id="4e004-358">Os desenvolvedores cujas extensões de namespace precisam dar suporte adequado à transferência de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-358">Developers whose namespace extensions need to properly support data transfer.</span></span>

### <a name="accepting-data-from-a-virtual-folder"></a><span data-ttu-id="4e004-359">Aceitando dados de uma pasta virtual</span><span class="sxs-lookup"><span data-stu-id="4e004-359">Accepting Data from a Virtual Folder</span></span>

<span data-ttu-id="4e004-360">As pastas virtuais podem representar praticamente qualquer tipo de dados e podem armazenar esses dados de qualquer forma que escolherem.</span><span class="sxs-lookup"><span data-stu-id="4e004-360">Virtual folders can represent virtually any type of data and can store that data in any way they choose.</span></span> <span data-ttu-id="4e004-361">Algumas pastas virtuais podem realmente conter arquivos e pastas normais do sistema de arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-361">Some virtual folders might actually contain normal file system files and folders.</span></span> <span data-ttu-id="4e004-362">Outros podem, por exemplo, empacotar todos os seus objetos em um único documento ou banco de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-362">Others might, for instance, pack all their objects into a single document or database.</span></span>

<span data-ttu-id="4e004-363">Quando um objeto do sistema de arquivos é transferido para um aplicativo, o objeto de dados normalmente contém um formato de [ \_ HDROP do CF](clipboard.md) com o caminho totalmente qualificado do objeto.</span><span class="sxs-lookup"><span data-stu-id="4e004-363">When a file system object is transferred to an application, the data object normally contains a [CF\_HDROP](clipboard.md) format with the object's fully qualified path.</span></span> <span data-ttu-id="4e004-364">Seu aplicativo pode extrair essa cadeia de caracteres e usar as funções normais do sistema de arquivos para abrir o arquivo e extrair seus dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-364">Your application can extract this string and use the normal file system functions to open the file and extract its data.</span></span> <span data-ttu-id="4e004-365">No entanto, como as pastas virtuais normalmente não contêm objetos normais do sistema de arquivos, geralmente não usam o [ \_ HDROP do CF](clipboard.md).</span><span class="sxs-lookup"><span data-stu-id="4e004-365">However, because virtual folders typically do not contain normal file system objects, they generally do not use [CF\_HDROP](clipboard.md).</span></span>

<span data-ttu-id="4e004-366">Em vez [da \_ HDROP do CF](clipboard.md), os dados são normalmente transferidos de pastas virtuais com os formatos [CFSTR \_ FileDescriptor](clipboard.md) / [CFSTR \_ fileconters](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="4e004-366">Instead of [CF\_HDROP](clipboard.md), data is normally transferred from virtual folders with the [CFSTR\_FILEDESCRIPTOR](clipboard.md)/[CFSTR\_FILECONTENTS](clipboard.md) formats.</span></span> <span data-ttu-id="4e004-367">O [formato \_ FileContent CFSTR](clipboard.md) tem duas vantagens sobre o [CF \_ HDROP](clipboard.md):</span><span class="sxs-lookup"><span data-stu-id="4e004-367">The [CFSTR\_FILECONTENTS](clipboard.md) format has two advantages over [CF\_HDROP](clipboard.md):</span></span>

-   <span data-ttu-id="4e004-368">Nenhum método específico de armazenamento de dados é assumido.</span><span class="sxs-lookup"><span data-stu-id="4e004-368">No particular method of data storage is assumed.</span></span>
-   <span data-ttu-id="4e004-369">O formato é mais flexível.</span><span class="sxs-lookup"><span data-stu-id="4e004-369">The format is more flexible.</span></span> <span data-ttu-id="4e004-370">Ele dá suporte a três mecanismos de transferência de dados: um objeto de memória global, uma interface [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) ou uma interface [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage) .</span><span class="sxs-lookup"><span data-stu-id="4e004-370">It supports three data transfer mechanisms: a global memory object, an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface, or an [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage) interface.</span></span>

<span data-ttu-id="4e004-371">Os objetos de memória global raramente são usados para transferir dados de ou para objetos virtuais, pois os dados devem ser copiados na memória em sua totalidade.</span><span class="sxs-lookup"><span data-stu-id="4e004-371">Global memory objects are rarely used to transfer data to or from virtual objects because the data must be copied into memory in its entirety.</span></span> <span data-ttu-id="4e004-372">A transferência de um ponteiro de interface requer quase nenhuma memória e é muito mais eficiente.</span><span class="sxs-lookup"><span data-stu-id="4e004-372">Transferring an interface pointer requires almost no memory and is much more efficient.</span></span> <span data-ttu-id="4e004-373">Com arquivos muito grandes, um ponteiro de interface pode ser o único mecanismo de transferência de dados prático.</span><span class="sxs-lookup"><span data-stu-id="4e004-373">With very large files, an interface pointer might be the only practical data transfer mechanism.</span></span> <span data-ttu-id="4e004-374">Normalmente, os dados são representados por um ponteiro de [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) , pois essa interface é um pouco mais flexível do que [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage).</span><span class="sxs-lookup"><span data-stu-id="4e004-374">Typically, data is represented by an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) pointer, because that interface is somewhat more flexible than [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage).</span></span> <span data-ttu-id="4e004-375">O destino extrai o ponteiro do objeto de dados e usa os métodos de interface para extrair os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-375">The target extracts the pointer from the data object and uses the interface methods to extract the data.</span></span>

<span data-ttu-id="4e004-376">Para obter mais informações sobre como lidar com os formatos de [fileCFSTR do CFSTR \_ FileDescriptor](clipboard.md) / , consulte [usando o \_ formato CFSTR FileContent para extrair dados de um arquivo](/windows).[ \_ ](clipboard.md)</span><span class="sxs-lookup"><span data-stu-id="4e004-376">For further discussion of how to handle the [CFSTR\_FILEDESCRIPTOR](clipboard.md)/[CFSTR\_FILECONTENTS](clipboard.md) formats, see [Using the CFSTR\_FILECONTENTS Format to Extract Data from a File](/windows).</span></span>

### <a name="transferring-data-to-and-from-a-namespace-extension"></a><span data-ttu-id="4e004-377">Transferindo dados de e para uma extensão de NameSpace</span><span class="sxs-lookup"><span data-stu-id="4e004-377">Transferring Data to and from a NameSpace Extension</span></span>

<span data-ttu-id="4e004-378">Ao implementar uma extensão de namespace, normalmente você desejará dar suporte a recursos de arrastar e soltar.</span><span class="sxs-lookup"><span data-stu-id="4e004-378">When you implement a namespace extension, you will normally want to support drag-and-drop capabilities.</span></span> <span data-ttu-id="4e004-379">Siga as recomendações para remover origens e destinos discutidos em [diretrizes gerais](#general-guidelines).</span><span class="sxs-lookup"><span data-stu-id="4e004-379">Follow the recommendations for drop sources and targets discussed in [General Guidelines](#general-guidelines).</span></span> <span data-ttu-id="4e004-380">Em particular, uma extensão de namespace deve:</span><span class="sxs-lookup"><span data-stu-id="4e004-380">In particular, a namespace extension must:</span></span>

-   <span data-ttu-id="4e004-381">Ser capaz de lidar com os formatos de [ \_ filedescriptores CFSTR fileCFSTR](clipboard.md) / [ \_ ](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="4e004-381">Be able to handle the [CFSTR\_FILEDESCRIPTOR](clipboard.md)/[CFSTR\_FILECONTENTS](clipboard.md) formats.</span></span> <span data-ttu-id="4e004-382">Esses dois formatos normalmente são usados para transferir objetos de e para extensões de namespace.</span><span class="sxs-lookup"><span data-stu-id="4e004-382">These two formats are normally used to transfer objects to and from namespace extensions.</span></span>
-   <span data-ttu-id="4e004-383">Ser capaz de lidar com as [movimentações otimizadas](#handling-optimized-move-operations).</span><span class="sxs-lookup"><span data-stu-id="4e004-383">Be able to handle [optimized moves](#handling-optimized-move-operations).</span></span> <span data-ttu-id="4e004-384">O Shell espera que os objetos do Shell serão movidos com uma movimentação otimizada.</span><span class="sxs-lookup"><span data-stu-id="4e004-384">The Shell expects that Shell objects will be moved with an optimized move.</span></span>
-   <span data-ttu-id="4e004-385">Ser capaz de lidar com uma operação de [exclusão na colagem](#handling-delete-on-paste-operations) .</span><span class="sxs-lookup"><span data-stu-id="4e004-385">Be able to handle a [delete-on-paste](#handling-delete-on-paste-operations) operation.</span></span> <span data-ttu-id="4e004-386">O Shell usa excluir-em-colar quando os objetos são movidos do shell com uma operação de recortar/colar.</span><span class="sxs-lookup"><span data-stu-id="4e004-386">The Shell uses delete-on-paste when objects are moved from the Shell with a cut/paste operation.</span></span>
-   <span data-ttu-id="4e004-387">Ser capaz de lidar com a transferência de dados por meio de uma interface [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) ou [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage) .</span><span class="sxs-lookup"><span data-stu-id="4e004-387">Be able to handle data transfer through an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) or [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage) interface.</span></span> <span data-ttu-id="4e004-388">A transferência de dados de ou para uma pasta virtual normalmente é manipulada pela transferência de um desses dois ponteiros de interface, normalmente um ponteiro de **IStream** .</span><span class="sxs-lookup"><span data-stu-id="4e004-388">Data transfer to or from a virtual folder is normally handled by transferring one of these two interface pointers, typically an **IStream** pointer.</span></span> <span data-ttu-id="4e004-389">Em seguida, o destino chama os métodos de interface para extrair os dados:</span><span class="sxs-lookup"><span data-stu-id="4e004-389">The target then calls the interface methods to extract the data:</span></span>
    -   -   <span data-ttu-id="4e004-390">Como uma fonte de soltar, a extensão do namespace deve extrair os dados do armazenamento e passá-los por meio dessa interface para o destino.</span><span class="sxs-lookup"><span data-stu-id="4e004-390">As a drop source, the namespace extension must extract the data from storage and pass it through this interface to the target.</span></span>
        -   <span data-ttu-id="4e004-391">Como destino de soltar, uma extensão de namespace deve aceitar dados de uma fonte por meio dessa interface e armazená-los corretamente.</span><span class="sxs-lookup"><span data-stu-id="4e004-391">As a drop target, a namespace extension must accept data from a source through this interface and store it properly.</span></span>

## <a name="dropping-files-on-the-recycle-bin"></a><span data-ttu-id="4e004-392">Descartando arquivos na lixeira</span><span class="sxs-lookup"><span data-stu-id="4e004-392">Dropping Files on the Recycle Bin</span></span>

<span data-ttu-id="4e004-393">**Cenário:** O usuário remove um arquivo na **Lixeira**.</span><span class="sxs-lookup"><span data-stu-id="4e004-393">**Scenario:** The user drops a file on the **Recycle Bin**.</span></span> <span data-ttu-id="4e004-394">Seu aplicativo ou extensão de namespace exclui o arquivo original.</span><span class="sxs-lookup"><span data-stu-id="4e004-394">Your application or namespace extension deletes the original file.</span></span>

<span data-ttu-id="4e004-395">A lixeira é uma pasta virtual que é usada como um repositório para arquivos que não são mais necessários.</span><span class="sxs-lookup"><span data-stu-id="4e004-395">The Recycle Bin is a virtual folder that is used as a repository for files that are no longer needed.</span></span> <span data-ttu-id="4e004-396">Desde que a lixeira não tenha sido esvaziada, o usuário poderá recuperar o arquivo posteriormente e retorná-lo ao sistema de arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-396">As long as the Recycle Bin has not been emptied, the user can later recover the file and return it to the file system.</span></span>

<span data-ttu-id="4e004-397">Para a maior parte, a transferência de objetos do Shell para a lixeira funciona de forma muito semelhante a qualquer outra pasta.</span><span class="sxs-lookup"><span data-stu-id="4e004-397">For the most part, transferring Shell objects to the Recycle Bin works much like any other folder.</span></span> <span data-ttu-id="4e004-398">No entanto, quando um usuário remove um arquivo na **Lixeira**, a origem precisa excluir o original, mesmo se os comentários da pasta indicarem uma operação de cópia.</span><span class="sxs-lookup"><span data-stu-id="4e004-398">However, when a user drops a file on the **Recycle Bin**, the source needs to delete the original, even if the feedback from the folder indicates a copy operation.</span></span> <span data-ttu-id="4e004-399">Normalmente, uma fonte de soltar não tem como saber em qual pasta seu objeto de dados foi Descartado.</span><span class="sxs-lookup"><span data-stu-id="4e004-399">Normally, a drop source has no way of knowing which folder its data object has been dropped on.</span></span> <span data-ttu-id="4e004-400">No entanto, para sistemas Windows 2000 e posteriores, quando um objeto de dados é Descartado na **Lixeira**, o Shell chamará o método [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) do objeto de dados com um formato [ \_ TARGETCLSID CFSTR](clipboard.md) definido como o CLSID (identificador de classe) da Lixeira (CLSID \_ RecycleBin).</span><span class="sxs-lookup"><span data-stu-id="4e004-400">However, for Windows 2000 and later systems, when a data object is dropped on the **Recycle Bin**, the Shell will call the data object's [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method with a [CFSTR\_TARGETCLSID](clipboard.md) format set to the Recycle Bin's class identifier (CLSID) (CLSID\_RecycleBin).</span></span> <span data-ttu-id="4e004-401">Para manipular o caso da lixeira corretamente, o objeto de dados deve ser capaz de reconhecer esse formato e comunicar as informações à fonte por meio de uma interface privada.</span><span class="sxs-lookup"><span data-stu-id="4e004-401">To handle the Recycle Bin case properly, your data object should be able to recognize this format and communicate the information to the source through a private interface.</span></span>

> [!Note]  
> <span data-ttu-id="4e004-402">Quando [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) é chamado com um [formato \_ TARGETCLSID CFSTR](clipboard.md) definido como CLSID \_ RecycleBin, a fonte de dados deve fechar qualquer identificador aberto para os objetos que estão sendo transferidos antes de retornar do método.</span><span class="sxs-lookup"><span data-stu-id="4e004-402">When [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) is called with a [CFSTR\_TARGETCLSID](clipboard.md) format set to CLSID\_RecycleBin, the data source should close any open handles to the objects that are being transferred before returning from the method.</span></span> <span data-ttu-id="4e004-403">Caso contrário, você pode criar violações de compartilhamento.</span><span class="sxs-lookup"><span data-stu-id="4e004-403">Otherwise, you might create sharing violations.</span></span>

 

## <a name="creating-and-importing-scrap-files"></a><span data-ttu-id="4e004-404">Criando e importando arquivos de recorte</span><span class="sxs-lookup"><span data-stu-id="4e004-404">Creating and Importing Scrap Files</span></span>

<span data-ttu-id="4e004-405">**Cenário:** Um usuário arrasta alguns dados do arquivo de dados de um aplicativo OLE e o descarta no desktop ou no Windows Explorer.</span><span class="sxs-lookup"><span data-stu-id="4e004-405">**Scenario:** A user drags some data from an OLE application's data file and drops it on the desktop or Windows Explorer.</span></span>

<span data-ttu-id="4e004-406">O Windows permite que os usuários arrastem um objeto do arquivo de dados de um aplicativo OLE e o Soltem na área de trabalho ou em uma pasta do sistema de arquivos.</span><span class="sxs-lookup"><span data-stu-id="4e004-406">Windows allows users to drag an object from an OLE application's data file and drop it on the desktop or a file system folder.</span></span> <span data-ttu-id="4e004-407">Esta operação cria um *arquivo de recorte*, que contém os dados ou um link para os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-407">This operation creates a *scrap file*, which contains the data or a link to the data.</span></span> <span data-ttu-id="4e004-408">O nome do arquivo é obtido do nome curto registrado para o CLSID do objeto e os dados [de \_ texto do CF](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="4e004-408">The file name is taken from the short name registered for the CLSID of the object and the [CF\_TEXT](clipboard.md) data.</span></span> <span data-ttu-id="4e004-409">Para que o Shell crie um arquivo de recorte contendo dados, a interface [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) do aplicativo deve oferecer suporte ao formato de área de transferência do CF \_ .</span><span class="sxs-lookup"><span data-stu-id="4e004-409">For the Shell to create a scrap file containing data, the application's [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface must support the CF\_EMBEDSOURCE Clipboard format.</span></span> <span data-ttu-id="4e004-410">Para criar um arquivo que contém um link, **IDataObject** deve dar suporte ao formato de link do CF \_ .</span><span class="sxs-lookup"><span data-stu-id="4e004-410">To create a file containing a link, **IDataObject** must support the CF\_LINKSOURCE format.</span></span>

<span data-ttu-id="4e004-411">Também há três recursos opcionais que um aplicativo pode implementar para dar suporte a arquivos de recorte:</span><span class="sxs-lookup"><span data-stu-id="4e004-411">There are also three optional features that an application can implement to support scrap files:</span></span>

-   <span data-ttu-id="4e004-412">Suporte a viagens de ida e volta</span><span class="sxs-lookup"><span data-stu-id="4e004-412">Round-trip support</span></span>
-   <span data-ttu-id="4e004-413">Formatos de dados em cache</span><span class="sxs-lookup"><span data-stu-id="4e004-413">Cached data formats</span></span>
-   <span data-ttu-id="4e004-414">Renderização atrasada</span><span class="sxs-lookup"><span data-stu-id="4e004-414">Delayed rendering</span></span>

### <a name="round-trip-support"></a><span data-ttu-id="4e004-415">Suporte a viagens de ida e volta</span><span class="sxs-lookup"><span data-stu-id="4e004-415">Round-trip Support</span></span>

<span data-ttu-id="4e004-416">Uma *viagem* de ida e volta envolve a transferência de um objeto de dados para outro contêiner e, em seguida, para o documento original.</span><span class="sxs-lookup"><span data-stu-id="4e004-416">A *round trip* involves transferring a data object to another container and then back to the original document.</span></span> <span data-ttu-id="4e004-417">Por exemplo, um usuário pode transferir um grupo de células de uma planilha para a área de trabalho, criando um arquivo de recorte com os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-417">For instance, a user could transfer a group of cells from a spreadsheet to the desktop, creating a scrap file with the data.</span></span> <span data-ttu-id="4e004-418">Se o usuário transferir a reversão para a planilha, os dados precisarão ser integrados ao documento como era antes da transferência original.</span><span class="sxs-lookup"><span data-stu-id="4e004-418">If the user then transfers the scrap back to the spreadsheet, the data needs to be integrated into the document as it was before the original transfer.</span></span>

<span data-ttu-id="4e004-419">Quando o Shell cria o arquivo de recorte, ele representa os dados como um objeto de incorporação.</span><span class="sxs-lookup"><span data-stu-id="4e004-419">When the Shell creates the scrap file, it represents the data as an embedding object.</span></span> <span data-ttu-id="4e004-420">Quando a sucata é transferida para outro contêiner, ela é transferida como um objeto de incorporação, mesmo que esteja sendo retornada ao documento original.</span><span class="sxs-lookup"><span data-stu-id="4e004-420">When the scrap is transferred to another container, it is transferred as an embedding object, even if it is being returned to the original document.</span></span> <span data-ttu-id="4e004-421">Seu aplicativo é responsável por determinar o formato de dados contido na sucata e colocar os dados de volta em seu formato nativo, se necessário.</span><span class="sxs-lookup"><span data-stu-id="4e004-421">Your application is responsible for determining the data format contained in the scrap and putting the data back into its native format if necessary.</span></span>

<span data-ttu-id="4e004-422">Para estabelecer o formato do objeto inserido, determine seu CLSID recuperando o formato do objectdescriptor do CF do objeto \_ .</span><span class="sxs-lookup"><span data-stu-id="4e004-422">To establish the format of the embedded object, determine its CLSID by retrieving the object's CF\_OBJECTDESCRIPTOR format.</span></span> <span data-ttu-id="4e004-423">Se o CLSID indicar um formato de dados que pertence ao aplicativo, ele deverá transferir os dados nativos em vez de chamar [**OleCreateFromData**](/windows/win32/api/ole2/nf-ole2-olecreatefromdata).</span><span class="sxs-lookup"><span data-stu-id="4e004-423">If the CLSID indicates a data format that belongs to the application, it should transfer the native data instead of calling [**OleCreateFromData**](/windows/win32/api/ole2/nf-ole2-olecreatefromdata).</span></span>

### <a name="cached-data-formats"></a><span data-ttu-id="4e004-424">Formatos de dados em cache</span><span class="sxs-lookup"><span data-stu-id="4e004-424">Cached Data Formats</span></span>

<span data-ttu-id="4e004-425">Quando o Shell cria um arquivo de recorte, ele verifica o registro para obter a lista de formatos disponíveis.</span><span class="sxs-lookup"><span data-stu-id="4e004-425">When the Shell creates a scrap file, it checks the registry for the list of available formats.</span></span> <span data-ttu-id="4e004-426">Por padrão, há dois formatos disponíveis: CF \_ embed e CF \_ LinkId.</span><span class="sxs-lookup"><span data-stu-id="4e004-426">By default, there are two formats available: CF\_EMBEDSOURCE and CF\_LINKSOURCE.</span></span> <span data-ttu-id="4e004-427">No entanto, há vários cenários em que os aplicativos podem precisar ter arquivos de sucata em formatos diferentes:</span><span class="sxs-lookup"><span data-stu-id="4e004-427">However, there are a number of scenarios where applications might need to have scrap files in different formats:</span></span>

-   <span data-ttu-id="4e004-428">Para permitir que as recortes sejam transferidas para contêineres não OLE, o que não aceita formatos de objeto inseridos.</span><span class="sxs-lookup"><span data-stu-id="4e004-428">To allow scraps to be transferred to non-OLE containers, which cannot accepted embedded object formats.</span></span>
-   <span data-ttu-id="4e004-429">Para permitir que conjuntos de aplicativos se comuniquem com um formato privado.</span><span class="sxs-lookup"><span data-stu-id="4e004-429">To allow suites of applications to communicate with a private format.</span></span>
-   <span data-ttu-id="4e004-430">Para facilitar a manipulação de viagens de ida e volta.</span><span class="sxs-lookup"><span data-stu-id="4e004-430">To make round trips easier to handle.</span></span>

<span data-ttu-id="4e004-431">Os aplicativos podem adicionar formatos à sucata armazenando-os em cache no registro.</span><span class="sxs-lookup"><span data-stu-id="4e004-431">Applications can add formats to the scrap by caching them in the registry.</span></span> <span data-ttu-id="4e004-432">Há dois tipos de formatos em cache:</span><span class="sxs-lookup"><span data-stu-id="4e004-432">There are two types of cached formats:</span></span>

-   <span data-ttu-id="4e004-433">Formatos de cache de prioridade.</span><span class="sxs-lookup"><span data-stu-id="4e004-433">Priority cache formats.</span></span> <span data-ttu-id="4e004-434">Para esses formatos, os dados são copiados em sua totalidade na sucata do objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-434">For these formats, the data is copied in its entirety into the scrap from the data object.</span></span>
-   <span data-ttu-id="4e004-435">Formatos renderizados com atraso.</span><span class="sxs-lookup"><span data-stu-id="4e004-435">Delay-rendered formats.</span></span> <span data-ttu-id="4e004-436">Para esses formatos, o objeto de dados não é copiado para a sucata.</span><span class="sxs-lookup"><span data-stu-id="4e004-436">For these formats, the data object is not copied to the scrap.</span></span> <span data-ttu-id="4e004-437">Em vez disso, a renderização é atrasada até que um destino solicite os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-437">Instead, rendering is delayed until a target requests the data.</span></span> <span data-ttu-id="4e004-438">A renderização de atraso é discutida mais detalhadamente na próxima seção.</span><span class="sxs-lookup"><span data-stu-id="4e004-438">Delay-rendering is discussed in more detail in the next section.</span></span>

<span data-ttu-id="4e004-439">Para adicionar um cache de prioridade ou um formato processado por atraso, crie uma subchave **DataFormat** sob a chave **CLSID** do aplicativo que é a origem dos dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-439">To add a priority cache or delay-rendered format, create a **DataFormat** subkey under the **CLSID** key of the application that is the source of the data.</span></span> <span data-ttu-id="4e004-440">Sob essa subchave, crie uma subchave **PriorityCacheFormats** ou **DelayRenderFormats** .</span><span class="sxs-lookup"><span data-stu-id="4e004-440">Under that subkey, create a **PriorityCacheFormats** or **DelayRenderFormats** subkey.</span></span> <span data-ttu-id="4e004-441">Para cada cache de prioridade ou formato processado com atraso, crie uma subchave numerada começando com zero.</span><span class="sxs-lookup"><span data-stu-id="4e004-441">For each priority cache or delay-rendered format, create a numbered subkey starting with zero.</span></span> <span data-ttu-id="4e004-442">Defina o valor dessa chave como uma cadeia de caracteres com o nome registrado do formato ou um \# valor x, em que X representa o número de formato de um formato de área de transferência padrão.</span><span class="sxs-lookup"><span data-stu-id="4e004-442">Set the value of this key to either a string with the registered name of the format or a \#X value, where X represents the format number of a standard Clipboard format.</span></span>

<span data-ttu-id="4e004-443">O exemplo a seguir mostra os formatos em cache para dois aplicativos.</span><span class="sxs-lookup"><span data-stu-id="4e004-443">The following sample shows cached formats for two applications.</span></span> <span data-ttu-id="4e004-444">O aplicativo MyProg1 tem o formato Rich-Text como um formato de cache de prioridade e um formato privado "My Format" como um formato reproduzido por atraso.</span><span class="sxs-lookup"><span data-stu-id="4e004-444">The MyProg1 application has the rich-text format as a priority cache format, and a private format "My Format" as a delay-rendered format.</span></span> <span data-ttu-id="4e004-445">O aplicativo MyProg2 tem o formato de bitmap do CF \_ ( \# 8 ") como um formato de cache de prioridade.</span><span class="sxs-lookup"><span data-stu-id="4e004-445">The MyProg2 application has the CF\_BITMAP format (\#8") as a priority cache format.</span></span>

```
HKEY_CLASSES_ROOT
   CLSID
      {GUID}
         (Default) = MyProg1
         DataFormats
            PriorityCacheFormats
               0
                  (Default) = Rich Text Format
            DelayRenderFormats
               0
                  (Default) = My Format
      {GUID}
         (Default) = MyProg2
         DataFormats
            PriorityCacheFormats
               0
                  (Default) = #8
```

<span data-ttu-id="4e004-446">Formatos adicionais podem ser adicionados criando subchaves numeradas adicionais.</span><span class="sxs-lookup"><span data-stu-id="4e004-446">Additional formats can be added by creating additional numbered subkeys.</span></span>

### <a name="delayed-rendering"></a><span data-ttu-id="4e004-447">Renderização atrasada</span><span class="sxs-lookup"><span data-stu-id="4e004-447">Delayed Rendering</span></span>

<span data-ttu-id="4e004-448">Um formato de renderização atrasado permite que um aplicativo crie um arquivo de recorte, mas adie a despesa de renderizar os dados até que ele seja solicitado por um destino.</span><span class="sxs-lookup"><span data-stu-id="4e004-448">A delayed rendering format allows an application to create a scrap file but delay the expense of rendering the data until it is requested by a target.</span></span> <span data-ttu-id="4e004-449">A interface [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) de uma sucata oferecerá os formatos de renderização atrasados para o destino, juntamente com os dados nativos e armazenados em cache.</span><span class="sxs-lookup"><span data-stu-id="4e004-449">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface of a scrap will offer the delayed rendering formats to the target along with native and cached data.</span></span> <span data-ttu-id="4e004-450">Se o destino solicitar um formato de renderização atrasado, o Shell executará o aplicativo e fornecerá os dados para o destino do objeto ativo.</span><span class="sxs-lookup"><span data-stu-id="4e004-450">If the target requests a delayed rendering format, the Shell will run the application and provide the data to the target from the active object.</span></span>

> [!Note]  
> <span data-ttu-id="4e004-451">Como a renderização atrasada é um pouco arriscada, ela deve ser usada com cautela.</span><span class="sxs-lookup"><span data-stu-id="4e004-451">Because delayed rendering is somewhat risky, it should be used with caution.</span></span> <span data-ttu-id="4e004-452">Ele não funcionará se o servidor não estiver disponível ou em aplicativos que não são habilitados para OLE.</span><span class="sxs-lookup"><span data-stu-id="4e004-452">It will not work if the server is not available, or on applications that are not OLE-enabled.</span></span>

 

## <a name="dragging-and-dropping-shell-objects-asynchronously"></a><span data-ttu-id="4e004-453">Arrastando e soltando objetos do Shell de forma assíncrona</span><span class="sxs-lookup"><span data-stu-id="4e004-453">Dragging and Dropping Shell Objects Asynchronously</span></span>

<span data-ttu-id="4e004-454">**Cenário:** Um usuário transfere um grande bloco de dados da origem para o destino.</span><span class="sxs-lookup"><span data-stu-id="4e004-454">**Scenario:** A user transfers a large block of data from source to target.</span></span> <span data-ttu-id="4e004-455">Para evitar o bloqueio de ambos os aplicativos por uma quantidade significativa de tempo, o destino extrai os dados de forma assíncrona.</span><span class="sxs-lookup"><span data-stu-id="4e004-455">To avoid blocking both applications for a significant amount of time, the target extracts the data asynchronously.</span></span>

<span data-ttu-id="4e004-456">Normalmente, o recurso de arrastar e soltar é uma operação síncrona.</span><span class="sxs-lookup"><span data-stu-id="4e004-456">Normally, drag-and-drop is a synchronous operation.</span></span> <span data-ttu-id="4e004-457">Em resumo:</span><span class="sxs-lookup"><span data-stu-id="4e004-457">In brief:</span></span>

1.  <span data-ttu-id="4e004-458">A origem de soltura chama [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) e bloqueia seu thread principal até que a função retorne.</span><span class="sxs-lookup"><span data-stu-id="4e004-458">The drop source calls [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) and blocks its primary thread until the function returns.</span></span> <span data-ttu-id="4e004-459">Bloquear o thread principal normalmente bloqueia o processamento da interface do usuário.</span><span class="sxs-lookup"><span data-stu-id="4e004-459">Blocking the primary thread normally blocks UI processing.</span></span>
2.  <span data-ttu-id="4e004-460">Depois que o método [**IDropTarget::D ROP**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) do destino é chamado, o destino extrai os dados do objeto de dados em seu thread primário.</span><span class="sxs-lookup"><span data-stu-id="4e004-460">After the target's [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) method is called, the target extracts the data from the data object on its primary thread.</span></span> <span data-ttu-id="4e004-461">Esse procedimento normalmente bloqueia o processamento da interface do usuário do destino para a duração do processo de extração.</span><span class="sxs-lookup"><span data-stu-id="4e004-461">This procedure normally blocks the target's UI processing for the duration of the extraction process.</span></span>
3.  <span data-ttu-id="4e004-462">Depois que os dados são extraídos, o destino retorna a chamada [**IDropTarget::D ROP**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) , o sistema retorna [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop)e ambos os threads podem continuar.</span><span class="sxs-lookup"><span data-stu-id="4e004-462">Once the data has been extracted, the target returns the [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) call, the system returns [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop), and both threads can proceed.</span></span>

<span data-ttu-id="4e004-463">Em suma, a transferência de dados síncrona pode bloquear os principais threads de ambos os aplicativos por um período significativo.</span><span class="sxs-lookup"><span data-stu-id="4e004-463">In short, synchronous data transfer can block the primary threads of both applications for a significant amount of time.</span></span> <span data-ttu-id="4e004-464">Em particular, os dois threads devem aguardar enquanto o destino extrai os dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-464">In particular, both threads must wait while the target extracts the data.</span></span> <span data-ttu-id="4e004-465">Para pequenas quantidades de dados, o tempo necessário para extrair dados é pequeno e a transferência de dados síncrona funciona muito bem.</span><span class="sxs-lookup"><span data-stu-id="4e004-465">For small amounts of data, the time required to extract data is small and synchronous data transfer works quite well.</span></span> <span data-ttu-id="4e004-466">No entanto, a extração síncrona de grandes quantidades de dados pode causar atrasos longos e interferir na interface do usuário de destino e de origem.</span><span class="sxs-lookup"><span data-stu-id="4e004-466">However, synchronously extracting large amounts of data can cause lengthy delays and interfere with the UI of both target and source.</span></span>

<span data-ttu-id="4e004-467">A interface [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)) / [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) é uma interface opcional que pode ser implementada por um objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-467">The [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85))/[**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) interface is an optional interface that can be implemented by a data object.</span></span> <span data-ttu-id="4e004-468">Ele dá ao destino de soltura a capacidade de extrair dados do objeto de dados de forma assíncrona em um thread em segundo plano.</span><span class="sxs-lookup"><span data-stu-id="4e004-468">It gives the drop target the ability to extract data from the data object asynchronously on a background thread.</span></span> <span data-ttu-id="4e004-469">Depois que a extração de dados é transferida para o thread em segundo plano, os principais threads de ambos os aplicativos são gratuitos para continuar.</span><span class="sxs-lookup"><span data-stu-id="4e004-469">Once data extraction is handed off to the background thread, the primary threads of both applications are free to proceed.</span></span>

### <a name="using-iasyncoperationidataobjectasynccapability"></a><span data-ttu-id="4e004-470">Usando IASyncOperation/IDataObjectAsyncCapability</span><span class="sxs-lookup"><span data-stu-id="4e004-470">Using IASyncOperation/IDataObjectAsyncCapability</span></span>

> [!Note]  
> <span data-ttu-id="4e004-471">A interface foi originalmente denominada [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)), mas ela foi alterada posteriormente para [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability).</span><span class="sxs-lookup"><span data-stu-id="4e004-471">The interface was originally named [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)), but this was later changed to [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability).</span></span> <span data-ttu-id="4e004-472">Caso contrário, as duas interfaces são idênticas.</span><span class="sxs-lookup"><span data-stu-id="4e004-472">Otherwise, the two interfaces are identical.</span></span>

 

<span data-ttu-id="4e004-473">A finalidade do [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)) / [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) é permitir que a origem do descarte e o destino de soltura negociem se os dados podem ser extraídos de forma assíncrona.</span><span class="sxs-lookup"><span data-stu-id="4e004-473">The purpose of [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85))/[**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) is to allow the drop source and drop target to negotiate whether data can be extracted asynchronously.</span></span> <span data-ttu-id="4e004-474">O procedimento a seguir descreve como a origem de soltura usa a interface:</span><span class="sxs-lookup"><span data-stu-id="4e004-474">The following procedure outlines how the drop source uses the interface:</span></span>

1.  <span data-ttu-id="4e004-475">Crie um objeto de dados que expõe [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)) / [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability).</span><span class="sxs-lookup"><span data-stu-id="4e004-475">Create a data object that exposes [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85))/[**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability).</span></span>
2.  <span data-ttu-id="4e004-476">Chame [**Setasyncmode**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-setasyncmode) com *FDoOpAsync* definido como **Variant \_ true** para indicar que há suporte para uma operação assíncrona.</span><span class="sxs-lookup"><span data-stu-id="4e004-476">Call [**SetAsyncMode**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-setasyncmode) with *fDoOpAsync* set to **VARIANT\_TRUE** to indicate that an asynchronous operation is supported.</span></span>
3.  <span data-ttu-id="4e004-477">Após o retorno de [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) , chame [**inoperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation):</span><span class="sxs-lookup"><span data-stu-id="4e004-477">After [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) returns, call [**InOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation):</span></span>
    -   <span data-ttu-id="4e004-478">Se a [**inoperação**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation) falhar ou retornar a **variante \_ false**, ocorrerá uma transferência de dados síncrona normal e o processo de extração de dados será concluído.</span><span class="sxs-lookup"><span data-stu-id="4e004-478">If [**InOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation) fails or returns **VARIANT\_FALSE**, a normal synchronous data transfer has taken place and the data extraction process is finished.</span></span> <span data-ttu-id="4e004-479">A origem deve fazer qualquer limpeza necessária e continuar.</span><span class="sxs-lookup"><span data-stu-id="4e004-479">The source should do any cleanup that is required, and proceed.</span></span>
    -   <span data-ttu-id="4e004-480">Se [**inoperação**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation) retornar **Variant \_ true**, os dados serão extraídos de forma assíncrona.</span><span class="sxs-lookup"><span data-stu-id="4e004-480">If [**InOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation) returns **VARIANT\_TRUE**, the data is being extracted asynchronously.</span></span> <span data-ttu-id="4e004-481">As operações de limpeza devem ser manipuladas pela [**Endoperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-endoperation).</span><span class="sxs-lookup"><span data-stu-id="4e004-481">Cleanup operations should be handled by [**EndOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-endoperation).</span></span>
4.  <span data-ttu-id="4e004-482">Libere o objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-482">Release the data object.</span></span>
5.  <span data-ttu-id="4e004-483">Quando a transferência de dados assíncrona é concluída, o objeto de dados normalmente notifica a origem por meio de uma interface privada.</span><span class="sxs-lookup"><span data-stu-id="4e004-483">When the asynchronous data transfer is complete, the data object normally notifies the source through a private interface.</span></span>

<span data-ttu-id="4e004-484">O procedimento a seguir descreve como o destino de soltura usa a interface [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)) / [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) para extrair dados de forma assíncrona:</span><span class="sxs-lookup"><span data-stu-id="4e004-484">The following procedure outlines how the drop target uses the [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85))/[**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) interface to extract data asynchronously:</span></span>

1.  <span data-ttu-id="4e004-485">Quando o sistema chama [**IDropTarget::D ROP**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop), chame [**IDataObject:: QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) e solicite [](/previous-versions//bb776309(v=vs.85))uma / interface [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) IAsyncOperation (IID \_ IAsyncOperation/IID \_ IDataObjectAsyncCapability) do objeto de dados.</span><span class="sxs-lookup"><span data-stu-id="4e004-485">When the system calls [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop), call [**IDataObject::QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) and request an [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85))/[**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) interface (IID\_IAsyncOperation/IID\_IDataObjectAsyncCapability) from the data object.</span></span>
2.  <span data-ttu-id="4e004-486">Chame [**Getasyncmode**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-getasyncmode).</span><span class="sxs-lookup"><span data-stu-id="4e004-486">Call [**GetAsyncMode**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-getasyncmode).</span></span> <span data-ttu-id="4e004-487">Se o método retornar **Variant \_ true**, o objeto de dados dará suporte à extração de dados assíncronos.</span><span class="sxs-lookup"><span data-stu-id="4e004-487">If the method returns **VARIANT\_TRUE**, the data object supports asynchronous data extraction.</span></span>
3.  <span data-ttu-id="4e004-488">Crie um thread separado para manipular a extração de dados e chamar [**StartOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-startoperation).</span><span class="sxs-lookup"><span data-stu-id="4e004-488">Create a separate thread to handle data extraction and call [**StartOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-startoperation).</span></span>
4.  <span data-ttu-id="4e004-489">Retorne a chamada [**IDropTarget::D ROP**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) , como você faria para uma operação de transferência de dados normal.</span><span class="sxs-lookup"><span data-stu-id="4e004-489">Return the [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) call, as you would for a normal data transfer operation.</span></span> <span data-ttu-id="4e004-490">[**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) retornará e desbloqueará a origem do descarte.</span><span class="sxs-lookup"><span data-stu-id="4e004-490">[**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) will return and unblock the drop source.</span></span> <span data-ttu-id="4e004-491">Não chame [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) para indicar o resultado de uma operação otimizada para mover ou excluir ao colar.</span><span class="sxs-lookup"><span data-stu-id="4e004-491">Do not call [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) to indicate the outcome of an optimized move or delete-on-paste operation.</span></span> <span data-ttu-id="4e004-492">Aguarde até que a operação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="4e004-492">Wait until the operation is finished.</span></span>
5.  <span data-ttu-id="4e004-493">Extraia os dados no thread em segundo plano.</span><span class="sxs-lookup"><span data-stu-id="4e004-493">Extract the data on the background thread.</span></span> <span data-ttu-id="4e004-494">O thread principal do destino é desbloqueado e gratuito para continuar.</span><span class="sxs-lookup"><span data-stu-id="4e004-494">The target's primary thread is unblocked and free to proceed.</span></span>
6.  <span data-ttu-id="4e004-495">Se a transferência de dados foi uma operação de movimentação ou [exclusão](#handling-delete-on-paste-operations) [otimizada](#handling-optimized-move-operations) , chame [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) para indicar o resultado.</span><span class="sxs-lookup"><span data-stu-id="4e004-495">If the data transfer was an [optimized move](#handling-optimized-move-operations) or [delete-on-paste](#handling-delete-on-paste-operations) operation, call [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) to indicate the outcome.</span></span>
7.  <span data-ttu-id="4e004-496">Notifique o objeto de dados que a extração é concluída chamando [**Endoperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-endoperation).</span><span class="sxs-lookup"><span data-stu-id="4e004-496">Notify the data object that extraction is finished by calling [**EndOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-endoperation).</span></span>

 

 
