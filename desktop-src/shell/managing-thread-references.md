---
description: Este artigo contém informações sobre o gerenciamento de referências de thread usando funções das funções de utilitário leve do Shell.
ms.assetid: d8d479fd-c45a-4dfa-b496-76abc7c09a42
title: Gerenciando referências de thread
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b629cd97c99e3b30e66810b5f54720d0dbb1c87d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104968010"
---
# <a name="managing-thread-references"></a><span data-ttu-id="12463-103">Gerenciando referências de thread</span><span class="sxs-lookup"><span data-stu-id="12463-103">Managing Thread References</span></span>

<span data-ttu-id="12463-104">Este artigo contém informações sobre o gerenciamento de referências de thread usando funções das funções de utilitário leve do Shell.</span><span class="sxs-lookup"><span data-stu-id="12463-104">This article contains information about the management of thread references using functions from the Shell lightweight utility functions.</span></span>


<span data-ttu-id="12463-105">Situações surgem quando um thread pai deve ser mantido ativo durante o tempo de vida de um thread filho.</span><span class="sxs-lookup"><span data-stu-id="12463-105">Situations arise when a parent thread must be kept active for the lifetime of a child thread.</span></span> <span data-ttu-id="12463-106">Por exemplo, se um objeto de Component Object Model (COM) for criado no thread pai e for empacotado para o thread filho, esse thread pai não poderá ser encerrado antes do thread filho.</span><span class="sxs-lookup"><span data-stu-id="12463-106">For instance, if a Component Object Model (COM) object is created on the parent thread and marshaled to the child thread, that parent thread cannot terminate before the child thread.</span></span> <span data-ttu-id="12463-107">Para fazer isso, o Shell fornece essas funções.</span><span class="sxs-lookup"><span data-stu-id="12463-107">To accomplish this, the Shell provides these functions.</span></span>

-   [<span data-ttu-id="12463-108">**SHCreateThreadRef**</span><span class="sxs-lookup"><span data-stu-id="12463-108">**SHCreateThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref)
-   [<span data-ttu-id="12463-109">**SHSetThreadRef**</span><span class="sxs-lookup"><span data-stu-id="12463-109">**SHSetThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref)
-   [<span data-ttu-id="12463-110">**SHGetThreadRef**</span><span class="sxs-lookup"><span data-stu-id="12463-110">**SHGetThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref)

<span data-ttu-id="12463-111">Use essas funções em seu thread pai, conforme descrito aqui.</span><span class="sxs-lookup"><span data-stu-id="12463-111">Use these functions in your parent thread as outlined here.</span></span>

1.  <span data-ttu-id="12463-112">Declare um procedimento de thread definido pelo aplicativo seguindo a forma da função [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) .</span><span class="sxs-lookup"><span data-stu-id="12463-112">Declare an application-defined thread procedure following the form of the [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) function.</span></span>

    ``` syntax
    DWORD WINAPI ThreadProc(LPVOID lpParameter);
    ```

2.  <span data-ttu-id="12463-113">Em seu [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)), chame [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) para criar uma referência ao thread.</span><span class="sxs-lookup"><span data-stu-id="12463-113">In your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)), call [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) to create a reference to the thread.</span></span> <span data-ttu-id="12463-114">Isso fornece um ponteiro para uma instância de [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown).</span><span class="sxs-lookup"><span data-stu-id="12463-114">This provides a pointer to an instance of [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown).</span></span> <span data-ttu-id="12463-115">Esse **IUnknown** usa o valor apontado por *pcRef* para manter uma contagem de referência.</span><span class="sxs-lookup"><span data-stu-id="12463-115">This **IUnknown** uses the value pointed to by *pcRef* to maintain a reference count.</span></span> <span data-ttu-id="12463-116">Desde que essa contagem seja maior que 0, o thread permanece ativo.</span><span class="sxs-lookup"><span data-stu-id="12463-116">As long as this count is greater than 0, the thread remains active.</span></span>
3.  <span data-ttu-id="12463-117">Usando esse ponteiro para [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), chame [**SHSetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref) em seu [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="12463-117">Using that pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), call [**SHSetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref) in your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)).</span></span> <span data-ttu-id="12463-118">Isso define a referência para que as chamadas subsequentes para [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) tenham algo a ser recuperado.</span><span class="sxs-lookup"><span data-stu-id="12463-118">This sets the reference so that subsequent calls to [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) have something to retrieve.</span></span>
4.  <span data-ttu-id="12463-119">Se o seu [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) criar outro thread, o *ThreadProc* do thread poderá chamar [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) com o ponteiro para [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtido pelo [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref).</span><span class="sxs-lookup"><span data-stu-id="12463-119">If your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) creates another thread, that thread's *ThreadProc* can call [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) with the pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtained by [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref).</span></span> <span data-ttu-id="12463-120">Isso incrementa a contagem de referência apontada pelo parâmetro *pcRef* em **SHCreateThreadRef**.</span><span class="sxs-lookup"><span data-stu-id="12463-120">This increments the reference count pointed to by the *pcRef* parameter in **SHCreateThreadRef**.</span></span>
5.  <span data-ttu-id="12463-121">Crie o thread.</span><span class="sxs-lookup"><span data-stu-id="12463-121">Create the thread.</span></span> <span data-ttu-id="12463-122">Isso geralmente é feito chamando [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread), passando um ponteiro para o [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) no parâmetro *pfnThreadProc* .</span><span class="sxs-lookup"><span data-stu-id="12463-122">This is usually done by calling [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread), passing a pointer to your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) in the *pfnThreadProc* parameter.</span></span> <span data-ttu-id="12463-123">Além disso, passe o \_ sinalizador de referência de thread CTF \_ no parâmetro *dwFlags* .</span><span class="sxs-lookup"><span data-stu-id="12463-123">Also pass the CTF\_THREAD\_REF flag in the *dwFlags* parameter.</span></span> <span data-ttu-id="12463-124">O thread estará ativo contanto que *ThreadProc* esteja em execução.</span><span class="sxs-lookup"><span data-stu-id="12463-124">The thread is active as long as *ThreadProc* is executing.</span></span>
6.  <span data-ttu-id="12463-125">Quando um thread filho é criado, passe o sinalizador **CTF \_ ref \_ contado** no parâmetro *dwFlags* na chamada para seu [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread).</span><span class="sxs-lookup"><span data-stu-id="12463-125">When a child thread is created, pass the **CTF\_REF\_COUNTED** flag in the *dwFlags* parameter in the call to its [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread).</span></span>
7.  <span data-ttu-id="12463-126">À medida que os threads filho são concluídos e liberados, o valor apontado pelo *pcRef* do thread pai diminui.</span><span class="sxs-lookup"><span data-stu-id="12463-126">As child threads complete and are released, the value pointed to by the parent thread's *pcRef* decreases.</span></span> <span data-ttu-id="12463-127">Depois que todos os threads filho forem concluídos, o [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) original poderá concluir e liberar a referência de thread final, descartando a contagem de referência para 0.</span><span class="sxs-lookup"><span data-stu-id="12463-127">Once all child threads are complete, the original [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) can complete and release the final thread reference, dropping the reference count to 0.</span></span> <span data-ttu-id="12463-128">Nesse ponto, a referência ao thread original aberto pelo [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) é liberada e o thread é concluído.</span><span class="sxs-lookup"><span data-stu-id="12463-128">At that point, the reference to the original thread opened by [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) is released and the thread completed.</span></span>

<span data-ttu-id="12463-129">Outra função relacionada é [**SHReleaseThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shreleasethreadref).</span><span class="sxs-lookup"><span data-stu-id="12463-129">Another related function is [**SHReleaseThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shreleasethreadref).</span></span> <span data-ttu-id="12463-130">Essa função é chamada pelo [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) se o thread tiver sido criado usando [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) com o sinalizador **de \_ \_ referência de thread CTF** .</span><span class="sxs-lookup"><span data-stu-id="12463-130">This function is called by the [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) if the thread has been created using [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) with the **CTF\_THREAD\_REF** flag.</span></span> <span data-ttu-id="12463-131">No entanto, o *ThreadProc* não é necessário para fazer isso implicitamente.</span><span class="sxs-lookup"><span data-stu-id="12463-131">However, the *ThreadProc* is not required to do so implicitly.</span></span> <span data-ttu-id="12463-132">Chamar [**IUnknown:: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) no ponteiro para [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtido por meio de [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) é tudo o que precisa ser feito.</span><span class="sxs-lookup"><span data-stu-id="12463-132">Calling [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) on the pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtained through [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) is all that needs to be done.</span></span>

 

 
