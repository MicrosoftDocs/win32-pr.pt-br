---
description: Criação de cópia de sombra para provedores
ms.assetid: d5042945-ba81-40d0-b204-1f08d153a788
title: Criação de cópia de sombra para provedores
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91cc7306e7a13ef8e96ab032016a922411a70f95
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104010848"
---
# <a name="shadow-copy-creation-for-providers"></a><span data-ttu-id="0e503-103">Criação de cópia de sombra para provedores</span><span class="sxs-lookup"><span data-stu-id="0e503-103">Shadow Copy Creation for Providers</span></span>

## <a name="the-shadow-copy-creation-process"></a><span data-ttu-id="0e503-104">O processo de criação de cópia de sombra</span><span class="sxs-lookup"><span data-stu-id="0e503-104">The Shadow Copy Creation Process</span></span>

<span data-ttu-id="0e503-105">Um solicitante é o aplicativo que inicia a solicitação para criar uma cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-105">A requester is the application that initiates the request to create a shadow copy.</span></span> <span data-ttu-id="0e503-106">Normalmente, o solicitante é um aplicativo de backup.</span><span class="sxs-lookup"><span data-stu-id="0e503-106">Typically the requester is a backup application.</span></span> <span data-ttu-id="0e503-107">Se necessário, o VSS chamará os provedores envolvidos.</span><span class="sxs-lookup"><span data-stu-id="0e503-107">As necessary, VSS will call the providers involved.</span></span> <span data-ttu-id="0e503-108">A maioria dos provedores está interessada em três solicitações específicas do solicitante.</span><span class="sxs-lookup"><span data-stu-id="0e503-108">Most providers are interested in three specific requests from the requester.</span></span>

1.  <span data-ttu-id="0e503-109">O solicitante inicia a atividade de criação de cópia de sombra com uma chamada para [**IVssBackupComponents:: StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span><span class="sxs-lookup"><span data-stu-id="0e503-109">The requester begins the shadow copy creation activity with a call to [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span></span> <span data-ttu-id="0e503-110">Isso gera um **GUID** do tipo **\_ ID do VSS** que identifica exclusivamente esse conjunto de cópias de sombra específico – o SnapshotSetId.</span><span class="sxs-lookup"><span data-stu-id="0e503-110">This generates a **GUID** of type **VSS\_ID** that uniquely identifies this specific shadow copy set - the SnapshotSetId.</span></span> <span data-ttu-id="0e503-111">O provedor não está envolvido nesta etapa, mas o SnapshotSetId é usado extensivamente em todas as etapas subsequentes.</span><span class="sxs-lookup"><span data-stu-id="0e503-111">The provider is not involved in this step, but the SnapshotSetId is used extensively in all subsequent steps.</span></span>
2.  <span data-ttu-id="0e503-112">Para cada volume que deseja incluir nesse conjunto de cópia de sombra, o solicitante chama [**IVssBackupComponents:: AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="0e503-112">For each volume it wishes to include in this shadow copy set, the requester calls [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span></span> <span data-ttu-id="0e503-113">O VSS determina qual provedor será usado para copiar a sombra do volume.</span><span class="sxs-lookup"><span data-stu-id="0e503-113">VSS determines which provider will be used to shadow copy the volume.</span></span>
    -   <span data-ttu-id="0e503-114">Vários provedores podem participar de um conjunto de cópias de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-114">Multiple providers may participate in a shadow copy set.</span></span> <span data-ttu-id="0e503-115">Por exemplo, se o volume do sistema e um volume de dados fizerem parte do mesmo conjunto de cópias de sombra, o provedor do sistema poderá servir como o provedor de cópia de sombra para o volume do sistema, enquanto um provedor de hardware pode servir como o provedor de cópia de sombra para o volume de dados.</span><span class="sxs-lookup"><span data-stu-id="0e503-115">For example, if the system volume and a data volume are part of the same shadow copy set, the system provider may serve as the shadow copy provider for the system volume while a hardware provider may serve as the shadow copy provider for the data volume.</span></span> <span data-ttu-id="0e503-116">Ambos os provedores fazem parte do mesmo conjunto de cópias de sombra e o usuário esperaria a mesma consistência pontual em ambos os volumes.</span><span class="sxs-lookup"><span data-stu-id="0e503-116">Both providers would be part of the same shadow copy set and the user would expect the same point-in-time consistency across both volumes.</span></span>
    -   <span data-ttu-id="0e503-117">Para que um provedor de hardware seja selecionado, o provedor de hardware deve ser capaz de dar suporte a todos os LUNs que contribuem para o volume especificado.</span><span class="sxs-lookup"><span data-stu-id="0e503-117">For a hardware provider to be selected, the hardware provider must be able to support all LUNs contributing to the specified volume.</span></span>
    -   <span data-ttu-id="0e503-118">Todos os provedores registrados têm a oportunidade de indicar o suporte para um determinado volume durante a criação da cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-118">All registered providers are given the opportunity to indicate support for a given volume during shadow copy creation.</span></span> <span data-ttu-id="0e503-119">Se mais de um provedor indicar suporte, o VSS primeiro usará como padrão os provedores de hardware, os provedores de software e, por fim, o provedor do sistema (se nenhum outro provedor indicar suporte para esse volume).</span><span class="sxs-lookup"><span data-stu-id="0e503-119">If more than one provider indicates support, VSS will first default to hardware providers, then software providers, and finally the system provider (if no other provider indicates support for that volume).</span></span>
    -   <span data-ttu-id="0e503-120">Um solicitante pode substituir essa ordem padrão indicando explicitamente o provedor necessário para criar a cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-120">A requester may override this default order by explicitly indicating the provider it requires to create the shadow copy.</span></span>
    -   <span data-ttu-id="0e503-121">Se houver vários provedores de hardware que dão suporte a um determinado volume, não haverá garantia para a ordem em que os provedores de hardware serão chamados.</span><span class="sxs-lookup"><span data-stu-id="0e503-121">If there are multiple hardware providers that support a given volume, there is no guarantee to the order in which the hardware providers will be called.</span></span>
3.  <span data-ttu-id="0e503-122">Após uma ou mais chamadas para [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset), o solicitante pode solicitar que a cópia de sombra seja criada usando o método [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .</span><span class="sxs-lookup"><span data-stu-id="0e503-122">After one or more calls to [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset), the requester can ask for the shadow copy to be created by using the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method.</span></span> <span data-ttu-id="0e503-123">Em seguida, o VSS funciona com o sistema para criar a cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-123">VSS then works with the system to create the shadow copy.</span></span> <span data-ttu-id="0e503-124">O método **DoSnapshotSet** executa esse trabalho de forma assíncrona e o solicitante pode sondar ou aguardar a conclusão do processo de criação de cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-124">The **DoSnapshotSet** method performs this work asynchronously, and the requester can either poll or wait for the shadow copy creation process to complete.</span></span>

<span data-ttu-id="0e503-125">Este diagrama mostra as interações entre o solicitante, o serviço VSS, o suporte ao kernel do VSS, quaisquer gravadores VSS envolvidos e quaisquer provedores de hardware VSS.</span><span class="sxs-lookup"><span data-stu-id="0e503-125">This diagram shows the interactions between the requester, the VSS service, the VSS kernel support, any VSS writers involved, and any VSS hardware providers.</span></span> <span data-ttu-id="0e503-126">Consulte [o processo de criação de cópia de sombra](the-shadow-copy-creation-process.md) para obter uma descrição detalhada dessas interações.</span><span class="sxs-lookup"><span data-stu-id="0e503-126">See [The Shadow Copy Creation Process](the-shadow-copy-creation-process.md) for a detailed description of these interactions.</span></span>

![interações entre o solicitante, os componentes de backup, os gravadores e os provedores](images/vssimpl.png)

<span data-ttu-id="0e503-128">Quando o processo de criação de cópia de sombra é concluído, o solicitante pode determinar se a criação da cópia de sombra foi bem-sucedida e, se não, determinar a origem da falha.</span><span class="sxs-lookup"><span data-stu-id="0e503-128">When the shadow copy creation process is complete, the requester can determine if the shadow copy creation was successful, and if not, determine the source of the failure.</span></span>

<span data-ttu-id="0e503-129">O intervalo de tempo entre o congelamento e descongelamento dos aplicativos do gravador deve ser minimizado.</span><span class="sxs-lookup"><span data-stu-id="0e503-129">The time interval between the freeze and thaw of the writer applications must be minimized.</span></span> <span data-ttu-id="0e503-130">O provedor deve iniciar de forma assíncrona todo o trabalho de preparação relacionado à cópia de sombra (como um provedor de hardware que usa plexes que iniciam a sincronização) no método [**IVssHardwareSnapshotProvider:: BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) e aguardar as conclusões no método [**IVssProviderCreateSnapshotSet:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) .</span><span class="sxs-lookup"><span data-stu-id="0e503-130">Provider must asynchronously start all preparation work related to the shadow copy (such as a hardware provider that uses plexes starting the synchronization) in the [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) method, and then wait for the completions in the [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) method.</span></span>

<span data-ttu-id="0e503-131">Há várias janelas de limite de tempo que os provedores devem seguir.</span><span class="sxs-lookup"><span data-stu-id="0e503-131">There are multiple timing limit windows that providers must follow.</span></span> <span data-ttu-id="0e503-132">Como resultado, os provedores bem comprovados executarão todo o processamento desnecessário antes de [**IVssProviderCreateSnapshotSet::P recommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) e depois de [**IVssProviderCreateSnapshotSet::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span><span class="sxs-lookup"><span data-stu-id="0e503-132">As a result, well-behaved providers will perform all unnecessary processing before [**IVssProviderCreateSnapshotSet::PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) and after [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span></span>

<span data-ttu-id="0e503-133">O conjunto de cópias de sombra é fixo quando [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) é chamado.</span><span class="sxs-lookup"><span data-stu-id="0e503-133">The shadow copy set is fixed when [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) is called.</span></span> <span data-ttu-id="0e503-134">Volumes adicionais não podem ser adicionados mais tarde porque os volumes adicionais não compartilham o mesmo ponto no tempo.</span><span class="sxs-lookup"><span data-stu-id="0e503-134">Additional volumes cannot be added later because the additional volumes would not share the same point-in-time.</span></span>

<span data-ttu-id="0e503-135">Há um limite de 64 volumes no conjunto de cópias de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-135">There is a limit of 64 volumes in the shadow copy set.</span></span> <span data-ttu-id="0e503-136">Um volume específico pode ser mapeado para um LUN inteiro, uma parte de um LUN ou partes de vários LUNs.</span><span class="sxs-lookup"><span data-stu-id="0e503-136">A specific volume may map to an entire LUN, a portion of a LUN, or portions of multiple LUNs.</span></span> <span data-ttu-id="0e503-137">A maioria das configurações terá um volume por LUN, embora sejam possíveis mapeamentos arbitrários.</span><span class="sxs-lookup"><span data-stu-id="0e503-137">Most configurations will have one volume per LUN, although arbitrary mappings are possible.</span></span>

<span data-ttu-id="0e503-138">Não há limite para o número de conjuntos de cópias de sombra ou o número de conjuntos de cópias de sombra de um volume original.</span><span class="sxs-lookup"><span data-stu-id="0e503-138">There is no limit on the number of shadow copy sets or the number of shadow copy sets of an original volume.</span></span> <span data-ttu-id="0e503-139">Um provedor pode definir limites específicos ou limitar dinamicamente com base nos recursos de hardware disponíveis.</span><span class="sxs-lookup"><span data-stu-id="0e503-139">A provider may define specific limits, or dynamically limit based on hardware resources available.</span></span>

### <a name="point-in-time-for-writerless-applications"></a><span data-ttu-id="0e503-140">Ponto no tempo para aplicativos não gravados</span><span class="sxs-lookup"><span data-stu-id="0e503-140">Point-in-time for Writerless Applications</span></span>

<span data-ttu-id="0e503-141">O VSS inclui suporte especial que define o ponto no tempo que é comum para todos os volumes em um conjunto de cópias de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-141">VSS includes special support that defines the point-in-time that is common for all volumes in a shadow copy set.</span></span> <span data-ttu-id="0e503-142">Os provedores de hardware não precisam interagir diretamente com essas tecnologias de kernel, pois são invocados como parte do processamento normal de confirmação de cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-142">Hardware providers do not need to directly interface with these kernel technologies, since they are invoked as part of the normal shadow copy commit processing.</span></span> <span data-ttu-id="0e503-143">No entanto, é útil entender os mecanismos usados porque explica a definição de "pontual" para aplicativos sem gravação (aplicativos que não apresentaram uma interface de gravador VSS e, portanto, não participam do processo de criação de cópias de sombra de volume.)</span><span class="sxs-lookup"><span data-stu-id="0e503-143">However, it is useful to understand the mechanisms used because it explains the definition of 'point-in-time' for writerless applications (applications that have not exposed a VSS Writer interface and therefore do not participate in the volume shadow copy creation process.)</span></span>

<span data-ttu-id="0e503-144">Esse suporte ao kernel do VSS para um ponto no tempo comum é distribuído entre o driver VolSnap.sys, os sistemas de arquivos e o VSS.</span><span class="sxs-lookup"><span data-stu-id="0e503-144">This VSS kernel support for common point-in-time is distributed between the VolSnap.sys driver, the file systems, and VSS.</span></span>

1.  <span data-ttu-id="0e503-145">Antes que o suporte ao kernel do VSS seja invocado, o VSS já tem:</span><span class="sxs-lookup"><span data-stu-id="0e503-145">Before the VSS kernel support is invoked, VSS has already:</span></span>
    1.  <span data-ttu-id="0e503-146">Determinado quais volumes devem ser envolvidos na cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-146">Determined which volumes are to be involved in the shadow copy.</span></span>
    2.  <span data-ttu-id="0e503-147">Determinado qual provedor deve ser usado em cada volume.</span><span class="sxs-lookup"><span data-stu-id="0e503-147">Determined which provider is to be used on each volume.</span></span>
    3.  <span data-ttu-id="0e503-148">Aplicativos congelado que estão aceitando congelar/descongelar mensagens.</span><span class="sxs-lookup"><span data-stu-id="0e503-148">Frozen applications that are accepting freeze/thaw messages.</span></span>
    4.  <span data-ttu-id="0e503-149">Preparados os provedores para a cópia de sombra chamando os métodos [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="0e503-149">Prepared the providers for the shadow copy by calling the [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) methods.</span></span> <span data-ttu-id="0e503-150">Todos os provedores estão agora aguardando para fazer a criação da cópia de sombra real.</span><span class="sxs-lookup"><span data-stu-id="0e503-150">All providers are now waiting to do the actual shadow copy creation.</span></span>
2.  <span data-ttu-id="0e503-151">Em seguida, o ponto no tempo é criado.</span><span class="sxs-lookup"><span data-stu-id="0e503-151">The point-in-time is then created.</span></span> <span data-ttu-id="0e503-152">O VSS libera simultaneamente os sistemas de arquivos em todos os volumes que devem ser copiados em sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-152">VSS concurrently flushes the file systems on all of the volumes that are to be shadow copied.</span></span>
    1.  <span data-ttu-id="0e503-153">O VSS emite um \_ \_ comando de \_ controle flush e Hold de gravação do IOCTL \_ \_ em cada volume que libera os sistemas de arquivos.</span><span class="sxs-lookup"><span data-stu-id="0e503-153">VSS issues an IOCTL\_VOLSNAP\_FLUSH\_AND\_HOLD\_WRITES control command on each volume that flushes the file systems.</span></span> <span data-ttu-id="0e503-154">Esse IOCTL é passado para baixo na pilha de armazenamento para VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="0e503-154">That IOCTL is passed down the storage stack to VolSnap.sys.</span></span> <span data-ttu-id="0e503-155">Em seguida, VolSnap.sys mantém todas as gravações IRPs até a etapa 4 abaixo.</span><span class="sxs-lookup"><span data-stu-id="0e503-155">VolSnap.sys then holds all write IRPs until step 4 below.</span></span> <span data-ttu-id="0e503-156">Qualquer sistema de arquivos (como RAW) sem suporte para esse novo IOCTL passa o IOCTL desconhecido para baixo, onde ele é mantido novamente por VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="0e503-156">Any file system (such as RAW) without support for this new IOCTL passes the unknown IOCTL down—where it is again held by VolSnap.sys.</span></span> <span data-ttu-id="0e503-157">Em volumes NTFS, a liberação também confirma o log NTFS.</span><span class="sxs-lookup"><span data-stu-id="0e503-157">On NTFS volumes, the flush also commits the NTFS log.</span></span>
    2.  <span data-ttu-id="0e503-158">Isso suspende toda a atividade de metadados NTFS/FAT; os metadados do sistema de arquivos são confirmados corretamente.</span><span class="sxs-lookup"><span data-stu-id="0e503-158">This suspends all NTFS/FAT metadata activity; the file system metadata is cleanly committed.</span></span>
    3.  <span data-ttu-id="0e503-159">A cópia de sombra instantânea: VolSnap.sys faz com que todas as gravações subsequentes IRPs sejam enfileiradas em todos os volumes que devem ser copiados em sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-159">The shadow copy instant: VolSnap.sys causes all subsequent write IRPs to be queued on all of the volumes that are to be shadow copied.</span></span>
    4.  <span data-ttu-id="0e503-160">VolSnap.sys aguarda que todas as gravações pendentes nos volumes de sombra copiados sejam concluídas.</span><span class="sxs-lookup"><span data-stu-id="0e503-160">VolSnap.sys waits for all pending writes on the shadow copied volumes to complete.</span></span> <span data-ttu-id="0e503-161">Os volumes agora estão inativos em relação às gravações e estavam inativos exatamente no mesmo momento em cada volume.</span><span class="sxs-lookup"><span data-stu-id="0e503-161">The volumes are now quiescent with respect to writes, and were quiescent at exactly the same moment on each volume.</span></span> <span data-ttu-id="0e503-162">Não há garantias sobre gravações em seções mapeadas do usuário ou gravações emitidas entre (a) e (b) em sistemas de arquivos que não implementam o IOCTL de liberação (por exemplo, RAW).</span><span class="sxs-lookup"><span data-stu-id="0e503-162">There are no guarantees about writes to user mapped sections or writes issued between (a) and (b) on file systems that do not implement the flush IOCTL (e.g. RAW).</span></span>
3.  <span data-ttu-id="0e503-163">O VSS instrui cada provedor a executar a cópia de sombra chamando os métodos [**IVssProviderCreateSnapshotSet:: CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="0e503-163">VSS instructs each provider to take in the shadow copy by calling the [**IVssProviderCreateSnapshotSet::CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods.</span></span> <span data-ttu-id="0e503-164">Os provedores devem ter toda a preparação feita para que essa seja uma operação rápida.</span><span class="sxs-lookup"><span data-stu-id="0e503-164">The providers should have all preparation done so that this is a quick operation.</span></span>

    <span data-ttu-id="0e503-165">Observe que o sistema de e/s só é inativo enquanto esses métodos [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) estão em execução.</span><span class="sxs-lookup"><span data-stu-id="0e503-165">Note that the I/O system is quiescent only while these [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods are executing.</span></span> <span data-ttu-id="0e503-166">Se um provedor executar qualquer sincronização dos LUNs de cópia de sombra e de origem, essa sincronização deverá ser concluída antes que o método **CommitSnapshots** do provedor seja retornado.</span><span class="sxs-lookup"><span data-stu-id="0e503-166">If a provider performs any synchronization of the source and shadow copy LUNs, this synchronization must be completed before the provider's **CommitSnapshots** method returns.</span></span> <span data-ttu-id="0e503-167">Ele não pode ser executado de forma assíncrona.</span><span class="sxs-lookup"><span data-stu-id="0e503-167">It cannot be performed asynchronously.</span></span>

4.  <span data-ttu-id="0e503-168">Imediatamente após o método [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) do último provedor retornar, o VSS libera Todas as gravações pendentes IRPs (incluindo a IRPs que estava bloqueando os sistemas de arquivos na conclusão de seus caminhos de confirmação) invocando outro IRP passado para VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="0e503-168">Immediately after the last provider's [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) method returns, VSS releases all pending write IRPs (including the IRPs that were blocking the file systems at the conclusion of their commit paths) by invoking another IRP passed to VolSnap.sys.</span></span>
5.  <span data-ttu-id="0e503-169">Se o processo de cópia de sombra tiver sido bem-sucedido, o VSS agora:</span><span class="sxs-lookup"><span data-stu-id="0e503-169">If the shadow copy process was successful, then VSS now:</span></span>
    1.  <span data-ttu-id="0e503-170">Chama [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) para os provedores envolvidos.</span><span class="sxs-lookup"><span data-stu-id="0e503-170">Calls [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) for the providers involved.</span></span>
    2.  <span data-ttu-id="0e503-171">Chama [**CVssWriter:: descongelar**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) para os gravadores envolvidos.</span><span class="sxs-lookup"><span data-stu-id="0e503-171">Calls [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) for the writers involved.</span></span>
    3.  <span data-ttu-id="0e503-172">Informa ao solicitante que o processo de cópia de sombra foi concluído.</span><span class="sxs-lookup"><span data-stu-id="0e503-172">Informs the requester that the shadow copy process has completed.</span></span>

<span data-ttu-id="0e503-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), para [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) são críticos o tempo todo.</span><span class="sxs-lookup"><span data-stu-id="0e503-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), to [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) are all time critical.</span></span> <span data-ttu-id="0e503-174">Todas as e/s de aplicativos com gravadores são congeladas de **PreCommitSnapshots** para **PostCommitSnapshots**; os atrasos afetam a disponibilidade do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0e503-174">All I/O from applications with writers is frozen from **PreCommitSnapshots** to **PostCommitSnapshots**; any delays affect application availability.</span></span> <span data-ttu-id="0e503-175">Todas as e/s de arquivo, incluindo e/s de aplicativo não gravado, são suspensas durante a **CommitSnapshots**.</span><span class="sxs-lookup"><span data-stu-id="0e503-175">All file I/O, including writerless application I/O, is suspended during **CommitSnapshots**.</span></span>

<span data-ttu-id="0e503-176">Os provedores devem concluir todo o trabalho de tempo crítico antes de retornar de [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span><span class="sxs-lookup"><span data-stu-id="0e503-176">Providers should complete all time-critical work prior to returning from [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span></span>

-   <span data-ttu-id="0e503-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) deve ser retornado em segundos.</span><span class="sxs-lookup"><span data-stu-id="0e503-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) should be returned within seconds.</span></span> <span data-ttu-id="0e503-178">A fase **CommitSnapshots** está localizada na janela liberar e manter.</span><span class="sxs-lookup"><span data-stu-id="0e503-178">The **CommitSnapshots** phase is located within the Flush and Hold window.</span></span> <span data-ttu-id="0e503-179">O suporte ao kernel do VSS cancelará a liberação e a suspensão que está mantendo a e/s se a versão subsequente não for recebida em até 10 segundos e o VSS falhará no processo de criação da cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="0e503-179">VSS kernel support will cancel the Flush and Hold that is holding the I/O if the subsequent release is not received within 10 seconds, and VSS will fail the shadow copy creation process.</span></span> <span data-ttu-id="0e503-180">Outras atividades ocorrerão no sistema, portanto, um provedor não deve contar com 10 segundos inteiros.</span><span class="sxs-lookup"><span data-stu-id="0e503-180">Other activities will be happening on the system, so a provider should not rely on having the full 10 seconds.</span></span> <span data-ttu-id="0e503-181">O provedor não deve chamar as APIs do Win32 durante a confirmação, pois muitas resultarão em gravações e bloqueios inesperados.</span><span class="sxs-lookup"><span data-stu-id="0e503-181">The provider should not call Win32 APIs during commit as many will result in unexpected writes and block.</span></span> <span data-ttu-id="0e503-182">Se o provedor levar mais de alguns segundos para concluir a chamada, haverá uma alta probabilidade de que isso falhará.</span><span class="sxs-lookup"><span data-stu-id="0e503-182">If the provider takes more than a few seconds to complete the call, there is a high probability that this will fail.</span></span>
-   <span data-ttu-id="0e503-183">A sequência completa de [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) para o retorno de [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) mapeia para a janela entre os gravadores que recebem os eventos Freeze e descongelar.</span><span class="sxs-lookup"><span data-stu-id="0e503-183">The full sequence from [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) to the return of [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) maps to the window between writers receiving the Freeze and Thaw events.</span></span> <span data-ttu-id="0e503-184">O padrão do gravador para esta janela é de 60 segundos, mas um gravador pode substituir esse valor por um tempo limite menor.</span><span class="sxs-lookup"><span data-stu-id="0e503-184">The writer default for this window is 60 seconds, but a writer may override this value with a smaller timeout.</span></span> <span data-ttu-id="0e503-185">Por exemplo, o gravador do Microsoft Exchange Server altera o tempo limite para 20 segundos.</span><span class="sxs-lookup"><span data-stu-id="0e503-185">For example, the Microsoft Exchange Server writer changes the timeout to 20 seconds.</span></span> <span data-ttu-id="0e503-186">Os provedores não devem passar mais de um segundo ou dois nesse método.</span><span class="sxs-lookup"><span data-stu-id="0e503-186">Providers should not spend more than a second or two in this method.</span></span>

<span data-ttu-id="0e503-187">Durante a [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) , o provedor deve evitar qualquer e/s de arquivo que não seja de paginação; Essa e/s tem uma probabilidade muito alta de deadlocks.</span><span class="sxs-lookup"><span data-stu-id="0e503-187">During [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) the provider must avoid any non-paging file I/O; such I/O has a very high probability of deadlocking.</span></span> <span data-ttu-id="0e503-188">Em particular, o provedor não deve gravar de forma síncrona nenhum log de depuração ou de rastreamento.</span><span class="sxs-lookup"><span data-stu-id="0e503-188">In particular, the provider should not synchronously write any debug or trace logs.</span></span>

 

 



