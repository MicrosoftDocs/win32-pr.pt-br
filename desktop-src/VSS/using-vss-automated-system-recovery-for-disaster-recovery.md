---
description: Um aplicativo de backup e recuperação VSS que executa a recuperação de desastre (também chamada de recuperação bare-metal) pode usar o gravador ASR (recuperação automatizada do sistema) junto com o Ambiente de Pré-Instalação do Windows (Windows PE) para fazer backup e restaurar volumes críticos e outros componentes do estado do sistema inicializável. O aplicativo de backup é implementado como um solicitante do VSS.
ms.assetid: 13adfd79-f26a-4385-9b59-129d06fa72eb
title: Usando a recuperação automatizada do sistema do VSS para recuperação de desastre
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1e31ef8ba223f40928e2422fa92240656f94592d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "105813214"
---
# <a name="using-vss-automated-system-recovery-for-disaster-recovery"></a><span data-ttu-id="64664-104">Usando a recuperação automatizada do sistema do VSS para recuperação de desastre</span><span class="sxs-lookup"><span data-stu-id="64664-104">Using VSS Automated System Recovery for Disaster Recovery</span></span>

<span data-ttu-id="64664-105">Um aplicativo de backup e recuperação VSS que executa a recuperação de desastre (também chamada de recuperação bare-metal) pode usar o gravador ASR (recuperação automatizada do sistema) junto com o Ambiente de Pré-Instalação do Windows (Windows PE) para fazer backup e restaurar volumes críticos e outros componentes do estado do sistema inicializável.</span><span class="sxs-lookup"><span data-stu-id="64664-105">A VSS backup-and-recovery application that performs disaster recovery (also called bare-metal recovery) can use the Automated System Recovery (ASR) writer together with Windows Preinstallation Environment (Windows PE) to back up and restore critical volumes and other components of the bootable system state.</span></span> <span data-ttu-id="64664-106">O aplicativo de backup é implementado como um solicitante do VSS.</span><span class="sxs-lookup"><span data-stu-id="64664-106">The backup application is implemented as a VSS requester.</span></span>

<span data-ttu-id="64664-107">**Observação**  Os aplicativos que usam a ASR devem licenciar o Windows PE.</span><span class="sxs-lookup"><span data-stu-id="64664-107">**Note**  Applications that use ASR must license Windows PE.</span></span>

<span data-ttu-id="64664-108">**Windows Server 2003 e Windows XP:** A ASR não é implementada como um gravador VSS.</span><span class="sxs-lookup"><span data-stu-id="64664-108">**Windows Server 2003 and Windows XP:** ASR is not implemented as a VSS writer.</span></span>

<span data-ttu-id="64664-109">Para obter informações sobre as ferramentas de rastreamento que você pode usar com o ASR, consulte [usando ferramentas de rastreamento com aplicativos ASR do VSS](using-tracing-tools-with-vss-asr-applications.md).</span><span class="sxs-lookup"><span data-stu-id="64664-109">For information about tracing tools that you can use with ASR, see [Using Tracing Tools with VSS ASR Applications](using-tracing-tools-with-vss-asr-applications.md).</span></span>

<span data-ttu-id="64664-110">**Neste artigo:**</span><span class="sxs-lookup"><span data-stu-id="64664-110">**In this article:**</span></span>

-   [<span data-ttu-id="64664-111">Visão geral das tarefas da fase de backup</span><span class="sxs-lookup"><span data-stu-id="64664-111">Overview of Backup Phase Tasks</span></span>](#overview-of-backup-phase-tasks)
-   [<span data-ttu-id="64664-112">Escolhendo quais componentes críticos fazer backup</span><span class="sxs-lookup"><span data-stu-id="64664-112">Choosing Which Critical Components to Back Up</span></span>](#choosing-which-critical-components-to-back-up)
-   [<span data-ttu-id="64664-113">Visão geral das tarefas da fase de restauração</span><span class="sxs-lookup"><span data-stu-id="64664-113">Overview of Restore Phase Tasks</span></span>](#overview-of-restore-phase-tasks)
-   [<span data-ttu-id="64664-114">Excluindo todos os discos de um volume</span><span class="sxs-lookup"><span data-stu-id="64664-114">Excluding All Disks for a Volume</span></span>](#excluding-all-disks-for-a-volume)

## <a name="overview-of-backup-phase-tasks"></a><span data-ttu-id="64664-115">Visão geral das tarefas da fase de backup</span><span class="sxs-lookup"><span data-stu-id="64664-115">Overview of Backup Phase Tasks</span></span>

<span data-ttu-id="64664-116">No momento do backup, o solicitante executa as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="64664-116">At backup time, the requester performs the following steps.</span></span>

> [!Note]  
> <span data-ttu-id="64664-117">Todas as etapas são necessárias, a menos que indicado de outra forma.</span><span class="sxs-lookup"><span data-stu-id="64664-117">All steps are required unless otherwise indicated.</span></span>

 

1.  <span data-ttu-id="64664-118">Chame a função [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) para criar uma instância da interface [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) e chame o método [**IVssBackupComponents:: InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) para inicializar a instância para gerenciar um backup.</span><span class="sxs-lookup"><span data-stu-id="64664-118">Call the [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) function to create an instance of the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface and call the [**IVssBackupComponents::InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) method to initialize the instance to manage a backup.</span></span>
2.  <span data-ttu-id="64664-119">Chame [**IVssBackupComponents:: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) para definir o contexto para a operação de cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="64664-119">Call [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) to set the context for the shadow copy operation.</span></span>
3.  <span data-ttu-id="64664-120">Chame [**IVssBackupComponents:: Setbackupstate**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) para configurar o backup.</span><span class="sxs-lookup"><span data-stu-id="64664-120">Call [**IVssBackupComponents::SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) to configure the backup.</span></span> <span data-ttu-id="64664-121">Defina o parâmetro *bBackupBootableSystemState* como **true** para indicar que o backup incluirá um estado do sistema inicializável.</span><span class="sxs-lookup"><span data-stu-id="64664-121">Set the *bBackupBootableSystemState* parameter to **true** to indicate that the backup will include a bootable system state.</span></span>
4.  <span data-ttu-id="64664-122">Escolha os componentes críticos no documento de metadados do gravador do gravador de ASR para fazer backup e chamar o [**componente IVssBackupComponents::**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) Addpara cada um deles.</span><span class="sxs-lookup"><span data-stu-id="64664-122">Choose which critical components in the ASR writer's Writer Metadata Document to back up and call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) for each of them.</span></span>
5.  <span data-ttu-id="64664-123">Chame [**IVssBackupComponents:: StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) para criar um conjunto de cópias de sombra novo e vazio.</span><span class="sxs-lookup"><span data-stu-id="64664-123">Call [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) to create a new, empty shadow copy set.</span></span>
6.  <span data-ttu-id="64664-124">Chame [**IVssBackupComponents:: GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) para iniciar o contato assíncrono com gravadores.</span><span class="sxs-lookup"><span data-stu-id="64664-124">Call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) to initiate asynchronous contact with writers.</span></span>
7.  <span data-ttu-id="64664-125">Chame [**IVssBackupComponents:: GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) para recuperar o documento de metadados do gravador do gravador de ASR.</span><span class="sxs-lookup"><span data-stu-id="64664-125">Call [**IVssBackupComponents::GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) to retrieve the ASR writer's Writer Metadata Document.</span></span> <span data-ttu-id="64664-126">A ID do gravador para o gravador de ASR é BE000CBE-11FE-4426-9C58-531AA6355FC4 e a cadeia de caracteres do nome do gravador é "gravador ASR".</span><span class="sxs-lookup"><span data-stu-id="64664-126">The writer ID for the ASR writer is BE000CBE-11FE-4426-9C58-531AA6355FC4, and the writer name string is "ASR Writer".</span></span>
8.  <span data-ttu-id="64664-127">Chame [**IVssExamineWriterMetadata:: SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) para salvar uma cópia do documento de metadados do gravador do gravador de ASR.</span><span class="sxs-lookup"><span data-stu-id="64664-127">Call [**IVssExamineWriterMetadata::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) to save a copy of the ASR writer's Writer Metadata Document.</span></span>
9.  <span data-ttu-id="64664-128">Chame [**IVssBackupComponents:: AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) para cada volume que possa participar de cópias de sombra para adicionar o volume ao conjunto de cópias de sombra.</span><span class="sxs-lookup"><span data-stu-id="64664-128">Call [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) for each volume that can participate in shadow copies to add the volume to the shadow copy set.</span></span>
10. <span data-ttu-id="64664-129">Chame [**IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) para notificar os gravadores para se preparar para uma operação de backup.</span><span class="sxs-lookup"><span data-stu-id="64664-129">Call [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) to notify writers to prepare for a backup operation.</span></span>
11. <span data-ttu-id="64664-130">Chame [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) e [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (ou [**IVssBackupComponentsEx3:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)) para verificar o status do gravador de ASR.</span><span class="sxs-lookup"><span data-stu-id="64664-130">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (or [**IVssBackupComponentsEx3::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)) to verify the status of the ASR writer.</span></span>
12. <span data-ttu-id="64664-131">Neste ponto, você pode consultar as mensagens de falha que foram definidas pelo gravador em seu método [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) .</span><span class="sxs-lookup"><span data-stu-id="64664-131">At this point, you can query for failure messages that were set by the writer in its [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method.</span></span> <span data-ttu-id="64664-132">Por exemplo, código que mostra como exibir essas mensagens, consulte [**IVssComponentEx:: GetPrepareForBackupFailureMsg**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).</span><span class="sxs-lookup"><span data-stu-id="64664-132">For example code that shows how to view these messages, see [**IVssComponentEx::GetPrepareForBackupFailureMsg**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).</span></span>
13. <span data-ttu-id="64664-133">Chame [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) para criar uma cópia de sombra de volume.</span><span class="sxs-lookup"><span data-stu-id="64664-133">Call [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) to create a volume shadow copy.</span></span>
14. <span data-ttu-id="64664-134">Chame [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) e [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) para verificar o status do gravador de ASR.</span><span class="sxs-lookup"><span data-stu-id="64664-134">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) to verify the status of the ASR writer.</span></span>
15. <span data-ttu-id="64664-135">Faça backup dos dados.</span><span class="sxs-lookup"><span data-stu-id="64664-135">Back up the data.</span></span>
16. <span data-ttu-id="64664-136">Indique se a operação de backup foi bem-sucedida chamando [**IVssBackupComponents:: SetBackupSucceeded**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).</span><span class="sxs-lookup"><span data-stu-id="64664-136">Indicate whether the backup operation succeeded by calling [**IVssBackupComponents::SetBackupSucceeded**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).</span></span>
17. <span data-ttu-id="64664-137">Chame [**IVssBackupComponents:: BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) para indicar que a operação de backup foi concluída.</span><span class="sxs-lookup"><span data-stu-id="64664-137">Call [**IVssBackupComponents::BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) to indicate that the backup operation has completed.</span></span>
18. <span data-ttu-id="64664-138">Chame [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) e [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).</span><span class="sxs-lookup"><span data-stu-id="64664-138">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).</span></span> <span data-ttu-id="64664-139">A memória de estado da sessão do gravador é um recurso limitado e os gravadores devem eventualmente reutilizar Estados de sessão.</span><span class="sxs-lookup"><span data-stu-id="64664-139">The writer session state memory is a limited resource, and writers must eventually reuse session states.</span></span> <span data-ttu-id="64664-140">Esta etapa marca o estado da sessão de backup do gravador como concluída e notifica o VSS de que esse slot de sessão de backup pode ser reutilizado por uma operação de backup subsequente.</span><span class="sxs-lookup"><span data-stu-id="64664-140">This step marks the writer’s backup session state as completed and notifies VSS that this backup session slot can be reused by a subsequent backup operation.</span></span>
    > [!Note]  
    > <span data-ttu-id="64664-141">Isso só é necessário no Windows Server 2008 com Service Pack 2 (SP2) e versões anteriores.</span><span class="sxs-lookup"><span data-stu-id="64664-141">This is only necessary on Windows Server 2008 with Service Pack 2 (SP2) and earlier.</span></span>

     

19. <span data-ttu-id="64664-142">Chame [**IVssBackupComponents:: SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) para salvar uma cópia do documento de componentes de backup do solicitante.</span><span class="sxs-lookup"><span data-stu-id="64664-142">Call [**IVssBackupComponents::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) to save a copy of the requester's Backup Components Document.</span></span> <span data-ttu-id="64664-143">As informações no documento componentes de backup são usadas no momento da restauração quando o solicitante chama o método [**IVssBackupComponents:: InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) .</span><span class="sxs-lookup"><span data-stu-id="64664-143">The information in the Backup Components Document is used at restore time when the requester calls the [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) method.</span></span>

## <a name="choosing-which-critical-components-to-back-up"></a><span data-ttu-id="64664-144">Escolhendo quais componentes críticos fazer backup</span><span class="sxs-lookup"><span data-stu-id="64664-144">Choosing Which Critical Components to Back Up</span></span>

<span data-ttu-id="64664-145">Na fase de inicialização de backup, o gravador de ASR relata os seguintes tipos de componentes em seu documento de metadados do gravador:</span><span class="sxs-lookup"><span data-stu-id="64664-145">In the backup initialization phase, the ASR writer reports the following types of components in its Writer Metadata Document:</span></span>

-   <span data-ttu-id="64664-146">Volumes críticos, como os volumes de inicialização, sistema e ambiente de recuperação do Windows (Windows RE) e a partição do Windows RE que está associada à instância do Windows Vista ou Windows Server 2008 que está sendo executada no momento.</span><span class="sxs-lookup"><span data-stu-id="64664-146">Critical volumes, such as the boot, system, and Windows Recovery Environment (Windows RE) volumes and the Windows RE partition that is associated with the instance of Windows Vista or Windows Server 2008 that is currently running.</span></span> <span data-ttu-id="64664-147">Um volume é um *volume crítico* se ele contiver informações de estado do sistema.</span><span class="sxs-lookup"><span data-stu-id="64664-147">A volume is a *critical volume* if it contains system state information.</span></span> <span data-ttu-id="64664-148">Os volumes de inicialização e de sistema são incluídos automaticamente.</span><span class="sxs-lookup"><span data-stu-id="64664-148">The boot and system volumes are included automatically.</span></span> <span data-ttu-id="64664-149">O solicitante deve incluir todos os volumes que contêm componentes críticos do sistema relatados por gravadores, como os volumes que contêm o Active Directory.</span><span class="sxs-lookup"><span data-stu-id="64664-149">The requester must include all volumes that contain system-critical components reported by writers, such as the volumes that contain the Active Directory.</span></span> <span data-ttu-id="64664-150">Os componentes críticos do sistema são marcados como "não selecionável para backup".</span><span class="sxs-lookup"><span data-stu-id="64664-150">System-critical components are marked as "not selectable for backup."</span></span> <span data-ttu-id="64664-151">No VSS, "não selecionável" significa "não opcional".</span><span class="sxs-lookup"><span data-stu-id="64664-151">In VSS, "not selectable" means "not optional."</span></span> <span data-ttu-id="64664-152">Assim, o solicitante precisa fazer o backup como parte do estado do sistema.</span><span class="sxs-lookup"><span data-stu-id="64664-152">Thus, the requester is required to back them up as part of system state.</span></span> <span data-ttu-id="64664-153">Para obter mais informações, consulte [fazendo backup e restaurando o estado do sistema](locating-additional-system-files.md).</span><span class="sxs-lookup"><span data-stu-id="64664-153">For more information, see [Backing Up and Restoring System State](locating-additional-system-files.md).</span></span> <span data-ttu-id="64664-154">Os componentes para os quais o sinalizador de estado do sistema do VSS \_ CF \_ não \_ \_ são definidos não são críticos para o sistema.</span><span class="sxs-lookup"><span data-stu-id="64664-154">Components for which the VSS\_CF\_NOT\_SYSTEM\_STATE flag is set are not system-critical.</span></span>
    > [!Note]  
    > <span data-ttu-id="64664-155">O componente ASR é um componente crítico do sistema que é relatado pelo gravador ASR.</span><span class="sxs-lookup"><span data-stu-id="64664-155">The ASR component is a system-critical component that is reported by the ASR writer.</span></span>

     

-   <span data-ttu-id="64664-156">Discos.</span><span class="sxs-lookup"><span data-stu-id="64664-156">Disks.</span></span> <span data-ttu-id="64664-157">Cada disco fixo no computador é exposto como um componente no ASR.</span><span class="sxs-lookup"><span data-stu-id="64664-157">Every fixed disk on the computer is exposed as a component in ASR.</span></span> <span data-ttu-id="64664-158">Se um disco não tiver sido excluído durante o backup, ele será atribuído durante a restauração e poderá ser recriado e reformatado.</span><span class="sxs-lookup"><span data-stu-id="64664-158">If a disk was not excluded during backup, it will be assigned during restore and can be re-created and reformatted.</span></span> <span data-ttu-id="64664-159">Observe que durante a restauração, o solicitante ainda pode recriar um disco que foi excluído durante o backup chamando o método [**IVssBackupComponents:: setrestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) .</span><span class="sxs-lookup"><span data-stu-id="64664-159">Note that during restore, the requester can still re-create a disk that was excluded during backup by calling the [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) method.</span></span> <span data-ttu-id="64664-160">Se um disco em um pacote de disco dinâmico for selecionado, todos os outros discos nesse pacote também deverão ser selecionados.</span><span class="sxs-lookup"><span data-stu-id="64664-160">If one disk in a dynamic disk pack is selected, all other disks in that pack must also be selected.</span></span> <span data-ttu-id="64664-161">Se um volume for selecionado porque é um volume crítico (ou seja, um volume que contém informações de estado do sistema), todos os discos que contêm uma extensão para esse volume também devem ser selecionados.</span><span class="sxs-lookup"><span data-stu-id="64664-161">If a volume is selected because it is a critical volume (that is, a volume that contains system state information), every disk that contains an extent for that volume must also be selected.</span></span> <span data-ttu-id="64664-162">Para localizar as extensões de um volume, use o código de controle [**\_ \_ obter \_ \_ \_ extensões de disco de volume do IOCTL**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) .</span><span class="sxs-lookup"><span data-stu-id="64664-162">To find the extents for a volume, use the [**IOCTL\_VOLUME\_GET\_VOLUME\_DISK\_EXTENTS**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) control code.</span></span>

    > [!Note]  
    > <span data-ttu-id="64664-163">Durante o backup, o solicitante deve incluir todos os discos fixos.</span><span class="sxs-lookup"><span data-stu-id="64664-163">During backup, the requester should include all fixed disks.</span></span> <span data-ttu-id="64664-164">Se o disco que contém o conjunto de backup do solicitante for um disco local, esse disco deverá ser incluído.</span><span class="sxs-lookup"><span data-stu-id="64664-164">If the disk that contains the requester's backup set is a local disk, this disk should be included.</span></span> <span data-ttu-id="64664-165">Durante a restauração, o solicitante deve excluir o disco que contém o conjunto de backup do solicitante para impedir que ele seja substituído.</span><span class="sxs-lookup"><span data-stu-id="64664-165">During restore, the requester must exclude the disk that contains the requester's backup set to prevent it from being overwritten.</span></span>

     

    <span data-ttu-id="64664-166">Em um ambiente de clustering, o ASR não recria o layout dos discos compartilhados do cluster.</span><span class="sxs-lookup"><span data-stu-id="64664-166">In a clustering environment, ASR does not re-create the layout of the cluster's shared disks.</span></span> <span data-ttu-id="64664-167">Esses discos devem ser restaurados online depois que o sistema operacional é restaurado no Windows RE.</span><span class="sxs-lookup"><span data-stu-id="64664-167">Those disks should be restored online after the operating system is restored in the Windows RE.</span></span>

-   <span data-ttu-id="64664-168">Repositório de Dados de Configuração da Inicialização (BCD).</span><span class="sxs-lookup"><span data-stu-id="64664-168">Boot Configuration Data (BCD) store.</span></span> <span data-ttu-id="64664-169">Esse componente especifica o caminho do diretório que contém o repositório BCD.</span><span class="sxs-lookup"><span data-stu-id="64664-169">This component specifies the path of the directory that contains the BCD store.</span></span> <span data-ttu-id="64664-170">O solicitante deve especificar esse componente e fazer backup de todos os arquivos no diretório de repositório BCD.</span><span class="sxs-lookup"><span data-stu-id="64664-170">The requester must specify this component and back up all of the files in the BCD store directory.</span></span> <span data-ttu-id="64664-171">Para obter mais informações sobre o repositório BCD, consulte [sobre o BCD](/previous-versions/windows/desktop/bcd/about-bcd).</span><span class="sxs-lookup"><span data-stu-id="64664-171">For more information about the BCD store, see [About BCD](/previous-versions/windows/desktop/bcd/about-bcd).</span></span>
    > [!Note]  
    > <span data-ttu-id="64664-172">Em computadores que usam a interface de firmware estendido (EFI), a partição do sistema EFI (ESP) é sempre oculta e não pode ser incluída em uma cópia de sombra de volume.</span><span class="sxs-lookup"><span data-stu-id="64664-172">On computers that use the Extended Firmware Interface (EFI), the EFI System Partition (ESP) is always hidden and cannot be included in a volume shadow copy.</span></span> <span data-ttu-id="64664-173">O solicitante deve fazer backup do conteúdo desta partição.</span><span class="sxs-lookup"><span data-stu-id="64664-173">The requester must back up the contents of this partition.</span></span> <span data-ttu-id="64664-174">Como essa partição não pode ser incluída em uma cópia de sombra de volume, o backup só pode ser executado a partir do volume ativo, não da cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="64664-174">Because this partition cannot be included in a volume shadow copy, the backup can only be performed from the live volume, not from the shadow copy.</span></span> <span data-ttu-id="64664-175">Para obter mais informações sobre EFI e ESP, consulte [Guia de acompanhamento](/windows-hardware/drivers/bringup/).</span><span class="sxs-lookup"><span data-stu-id="64664-175">For more information about EFI and ESP, see [Bring up guide](/windows-hardware/drivers/bringup/).</span></span>

<span data-ttu-id="64664-176">Os nomes dos componentes usam os seguintes formatos:</span><span class="sxs-lookup"><span data-stu-id="64664-176">The component names use the following formats:</span></span>

-   <span data-ttu-id="64664-177">Para componentes de disco, o formato é</span><span class="sxs-lookup"><span data-stu-id="64664-177">For disk components, the format is</span></span>

    <COMPONENT logicalPath="Disks" componentName="harddisk*n*" componentType="filegroup" />

    <span data-ttu-id="64664-178">em que *n* é o número do disco.</span><span class="sxs-lookup"><span data-stu-id="64664-178">where *n* is the disk number.</span></span> <span data-ttu-id="64664-179">Somente o número do disco é registrado.</span><span class="sxs-lookup"><span data-stu-id="64664-179">Only the disk number is recorded.</span></span> <span data-ttu-id="64664-180">Para obter o número do disco, use o código de controle do [**número de dispositivo de obtenção de armazenamento do IOCTL \_ \_ \_ \_**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) .</span><span class="sxs-lookup"><span data-stu-id="64664-180">To get the disk number, use the [**IOCTL\_STORAGE\_GET\_DEVICE\_NUMBER**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) control code.</span></span>

-   <span data-ttu-id="64664-181">Para componentes de volume, o formato é</span><span class="sxs-lookup"><span data-stu-id="64664-181">For volume components, the format is</span></span>

    <COMPONENT logicalPath="Volumes" componentName="Volume{*GUID*}" componentType="filegroup" />

    <span data-ttu-id="64664-182">em que *GUID* é o GUID do volume.</span><span class="sxs-lookup"><span data-stu-id="64664-182">where *GUID* is the volume GUID.</span></span>

-   <span data-ttu-id="64664-183">Para o componente de repositório BCD, o formato é</span><span class="sxs-lookup"><span data-stu-id="64664-183">For the BCD store component, the format is</span></span>

    <COMPONENT logicalPath="BCD" componentName="BCD" componentType="filegroup" componentCaption = "This is the path to the boot BCD store and the boot managers...All the files in this directory need to be backed up...">

    <span data-ttu-id="64664-184">Se a partição do sistema tiver um nome de GUID de volume, esse componente será selecionável.</span><span class="sxs-lookup"><span data-stu-id="64664-184">If the system partition has a volume GUID name, this component is selectable.</span></span> <span data-ttu-id="64664-185">Caso contrário, ele não será selecionável.</span><span class="sxs-lookup"><span data-stu-id="64664-185">Otherwise, it is not selectable.</span></span>

    > [!Note]  
    > <span data-ttu-id="64664-186">O ASR adiciona os arquivos ao grupo de arquivos do componente de repositório BCD da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="64664-186">ASR adds the files to the BCD store component's file group as follows:</span></span>
    >
    > -   <span data-ttu-id="64664-187">Para discos EFI, o ASR adiciona</span><span class="sxs-lookup"><span data-stu-id="64664-187">For EFI disks, ASR adds</span></span>
    >
    >     <span data-ttu-id="64664-188">*SystemPartitionPath* \\ Inicialização da EFI da \\ Microsoft \\ \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="64664-188">*SystemPartitionPath*\\EFI\\Microsoft\\Boot\\\*.\*</span></span>
    >
    >     <span data-ttu-id="64664-189">em que *SystemPartitionPath* é o caminho para a partição do sistema.</span><span class="sxs-lookup"><span data-stu-id="64664-189">where *SystemPartitionPath* is the path to the system partition.</span></span>
    >
    > -   <span data-ttu-id="64664-190">Para discos GPT, o ASR adiciona</span><span class="sxs-lookup"><span data-stu-id="64664-190">For GPT disks, ASR adds</span></span>
    >
    >     <span data-ttu-id="64664-191">*SystemPartitionPath* \\ Inicialização \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="64664-191">*SystemPartitionPath*\\Boot\\\*.\*</span></span>
    >
    >     <span data-ttu-id="64664-192">em que *SystemPartitionPath* é o caminho para a partição do sistema.</span><span class="sxs-lookup"><span data-stu-id="64664-192">where *SystemPartitionPath* is the path to the system partition.</span></span>
    >
    > -   <span data-ttu-id="64664-193">O caminho da partição do sistema pode ser encontrado na seguinte chave do registro: **HKEY \_ local \_ Machine** \\ **System** \\ **Setup** \\ **SystemPartition**</span><span class="sxs-lookup"><span data-stu-id="64664-193">The system partition path can be found under the following registry key: **HKEY\_LOCAL\_MACHINE**\\**System**\\**Setup**\\**SystemPartition**</span></span>

     

<span data-ttu-id="64664-194">Na restauração, todos os componentes marcados como volumes críticos devem ser restaurados.</span><span class="sxs-lookup"><span data-stu-id="64664-194">On restore, all components that are marked as critical volumes must be restored.</span></span> <span data-ttu-id="64664-195">Se um ou mais volumes críticos não puderem ser restaurados, a operação de restauração falhará.</span><span class="sxs-lookup"><span data-stu-id="64664-195">If one or more critical volumes cannot be restored, the restore operation fails.</span></span>

<span data-ttu-id="64664-196">Na fase de [**Prerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) da sequência de restauração, os discos que não foram excluídos durante o backup são recriados e reformatados por padrão.</span><span class="sxs-lookup"><span data-stu-id="64664-196">In the [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) phase of the restore sequence, disks that were not excluded during backup are re-created and reformatted by default.</span></span> <span data-ttu-id="64664-197">No entanto, eles não serão recriados ou reformatados se atenderem às seguintes condições:</span><span class="sxs-lookup"><span data-stu-id="64664-197">However, they are not re-created or reformatted if they meet the following conditions:</span></span>

-   <span data-ttu-id="64664-198">Um disco básico não será recriado se o layout do disco estiver intacto ou se apenas alterações aditivas forem feitas a ele.</span><span class="sxs-lookup"><span data-stu-id="64664-198">A basic disk is not re-created if its disk layout is intact or only additive changes have been made to it.</span></span> <span data-ttu-id="64664-199">O layout do disco estará intacto se as seguintes condições forem verdadeiras:</span><span class="sxs-lookup"><span data-stu-id="64664-199">The disk layout is intact if the following conditions are true:</span></span>
    -   <span data-ttu-id="64664-200">A assinatura de disco, o estilo de disco (GPT ou MBR), o tamanho do setor lógico e o deslocamento de início do volume não são alterados.</span><span class="sxs-lookup"><span data-stu-id="64664-200">The disk signature, disk style (GPT or MBR), logical sector size, and volume start offset are not changed.</span></span>
    -   <span data-ttu-id="64664-201">O tamanho do volume não é reduzido.</span><span class="sxs-lookup"><span data-stu-id="64664-201">The volume size is not decreased.</span></span>
    -   <span data-ttu-id="64664-202">Para discos GPT, o identificador de partição não é alterado.</span><span class="sxs-lookup"><span data-stu-id="64664-202">For GPT disks, the partition identifier is not changed.</span></span>
-   <span data-ttu-id="64664-203">Um disco dinâmico não será recriado se o layout do disco estiver intacto ou se apenas alterações aditivas forem feitas a ele.</span><span class="sxs-lookup"><span data-stu-id="64664-203">A dynamic disk is not re-created if its disk layout is intact or only additive changes have been made to it.</span></span> <span data-ttu-id="64664-204">Para que um disco dinâmico fique intacto, todas as condições para um disco básico devem ser atendidas.</span><span class="sxs-lookup"><span data-stu-id="64664-204">For a dynamic disk to be intact, all of the conditions for a basic disk must be met.</span></span> <span data-ttu-id="64664-205">Além disso, a estrutura de volume do pacote de disco inteiro deve estar intacta.</span><span class="sxs-lookup"><span data-stu-id="64664-205">In addition, the entire disk pack's volume structure must be intact.</span></span> <span data-ttu-id="64664-206">A estrutura de volume do pacote de disco estará intacta se atender às seguintes condições, que se aplicam aos discos MBR e GPT:</span><span class="sxs-lookup"><span data-stu-id="64664-206">The disk pack's volume structure is intact if it meets the following conditions, which apply to both MBR and GPT disks:</span></span>
    -   <span data-ttu-id="64664-207">O número de volumes que estão disponíveis no pacote físico durante a restauração deve ser maior ou igual ao número de volumes que foram especificados nos metadados do gravador ASR durante o backup.</span><span class="sxs-lookup"><span data-stu-id="64664-207">The number of volumes that are available in the physical pack during restore must be greater than or equal to the number of volumes that were specified in the ASR writer metadata during backup.</span></span>
    -   <span data-ttu-id="64664-208">O número de [*plexes*](../vds/virtual-disk-service-glossary-all.md) por volume deve ser inalterado.</span><span class="sxs-lookup"><span data-stu-id="64664-208">The number of [*plexes*](../vds/virtual-disk-service-glossary-all.md) per volume must be unchanged.</span></span>
    -   <span data-ttu-id="64664-209">O número de [*Membros*](../vds/virtual-disk-service-glossary-all.md) deve ser inalterado.</span><span class="sxs-lookup"><span data-stu-id="64664-209">The number of [*members*](../vds/virtual-disk-service-glossary-all.md) must be unchanged.</span></span>
    -   <span data-ttu-id="64664-210">O número de extensões de disco físico deve ser maior que o número de extensões de disco especificado nos metadados do gravador ASR.</span><span class="sxs-lookup"><span data-stu-id="64664-210">The number of physical disk extents must be greater than the number of disk extents specified in the ASR writer metadata.</span></span>
    -   <span data-ttu-id="64664-211">Um pacote intacto permanece intacto quando volumes adicionais são adicionados ou se um volume no pacote é estendido (por exemplo, de um volume simples para um volume estendido).</span><span class="sxs-lookup"><span data-stu-id="64664-211">An intact pack remains intact when additional volumes are added, or if a volume in the pack is extended (for example, from a simple volume to a spanned volume).</span></span>
        > [!Note]  
        > <span data-ttu-id="64664-212">Se um volume simples for espelhado, o pacote não estará intacto e será recriado para garantir que o estado do volume BCD e de inicialização permaneça consistente após a restauração.</span><span class="sxs-lookup"><span data-stu-id="64664-212">If a simple volume is mirrored, the pack is not intact and will be re-created to ensure that the BCD and boot volume state remain consistent after restore.</span></span> <span data-ttu-id="64664-213">Se os volumes forem excluídos, o pacote será recriado.</span><span class="sxs-lookup"><span data-stu-id="64664-213">If volumes are deleted, the pack is re-created.</span></span>

         
-   <span data-ttu-id="64664-214">Se a estrutura de volume do pacote de disco dinâmico estiver intacta e apenas alterações aditivas tiverem sido feitas, os discos no pacote não serão recriados.</span><span class="sxs-lookup"><span data-stu-id="64664-214">If the dynamic disk pack's volume structure is intact and only additive changes have been made to it, the disks in the pack are not re-created.</span></span>

    <span data-ttu-id="64664-215">**Windows Vista:** Discos dinâmicos são sempre recriados.</span><span class="sxs-lookup"><span data-stu-id="64664-215">**Windows Vista:** Dynamic disks are always re-created.</span></span> <span data-ttu-id="64664-216">Observe que esse comportamento foi alterado com o Windows Server 2008 e o Windows Vista com Service Pack 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="64664-216">Note that this behavior has changed with Windows Server 2008 and Windows Vista with Service Pack 1 (SP1).</span></span>

<span data-ttu-id="64664-217">A qualquer momento antes do início da fase de restauração, o solicitante pode especificar que os discos devem ser formatados rapidamente definindo a chave do registro **HKEY \_ local \_ Machine** \\ **software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession** .</span><span class="sxs-lookup"><span data-stu-id="64664-217">At any time before the beginning of the restore phase, the requester can specify that the disks should be quick-formatted by setting the **HKEY\_LOCAL\_MACHINE**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession** registry key.</span></span> <span data-ttu-id="64664-218">Nessa chave, há um valor chamado **QuickFormat** com o tipo de dados reg \_ DWORD.</span><span class="sxs-lookup"><span data-stu-id="64664-218">Under this key, there is a value named **QuickFormat** with the data type REG\_DWORD.</span></span> <span data-ttu-id="64664-219">Se esse valor não existir, você deverá criá-lo.</span><span class="sxs-lookup"><span data-stu-id="64664-219">If this value does not exist, you should create it.</span></span> <span data-ttu-id="64664-220">Defina os dados do valor **QuickFormat** como 1 para formatação rápida ou 0 para formatação lenta.</span><span class="sxs-lookup"><span data-stu-id="64664-220">Set the data of the **QuickFormat** value to 1 for quick formatting or 0 for slow formatting.</span></span>

<span data-ttu-id="64664-221">Se o valor de **QuickFormat** não existir, os discos serão formatados com lentidão.</span><span class="sxs-lookup"><span data-stu-id="64664-221">If the **QuickFormat** value does not exist, the disks will be slow-formatted.</span></span>

<span data-ttu-id="64664-222">A formatação rápida é significativamente mais rápida do que a formatação lenta (também chamada de formatação completa).</span><span class="sxs-lookup"><span data-stu-id="64664-222">Quick formatting is significantly faster than slow formatting (also called full formatting).</span></span> <span data-ttu-id="64664-223">No entanto, a formatação rápida não verifica cada setor no volume.</span><span class="sxs-lookup"><span data-stu-id="64664-223">However, quick formatting does not verify each sector on the volume.</span></span>

## <a name="overview-of-restore-phase-tasks"></a><span data-ttu-id="64664-224">Visão geral das tarefas da fase de restauração</span><span class="sxs-lookup"><span data-stu-id="64664-224">Overview of Restore Phase Tasks</span></span>

<span data-ttu-id="64664-225">No momento da restauração, o solicitante executa as seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="64664-225">At restore time, the requester performs the following steps:</span></span>

> [!Note]  
> <span data-ttu-id="64664-226">Todas as etapas são necessárias, a menos que indicado de outra forma.</span><span class="sxs-lookup"><span data-stu-id="64664-226">All steps are required unless otherwise indicated.</span></span>

 

1.  <span data-ttu-id="64664-227">Chame a função [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) para criar uma instância da interface [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) e chame o método [**IVssBackupComponents:: InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) para inicializar a instância para restauração carregando o documento de componentes de backup do solicitante na instância.</span><span class="sxs-lookup"><span data-stu-id="64664-227">Call the [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) function to create an instance of the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface and call the [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) method to initialize the instance for restore by loading the requester's Backup Components Document into the instance.</span></span>
2.  <span data-ttu-id="64664-228">\[Esta etapa será necessária somente se o solicitante precisar alterar se "IncludeDisk" ou "ExcludeDisk" está especificado para um ou mais discos. \] Chame [**IVssBackupComponents:: setrestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) para definir as opções de restauração para os componentes do gravador ASR.</span><span class="sxs-lookup"><span data-stu-id="64664-228">\[This step is required only if the requester needs to change whether "IncludeDisk" or "ExcludeDisk" is specified for one or more disks.\] Call [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) to set the restore options for the ASR writer components.</span></span> <span data-ttu-id="64664-229">O gravador ASR oferece suporte às seguintes opções: "IncludeDisk" permite que o solicitante inclua um disco no sistema de destino para ser considerado para restauração, mesmo que ele não tenha sido selecionado durante a fase de backup.</span><span class="sxs-lookup"><span data-stu-id="64664-229">The ASR writer supports the following options: "IncludeDisk" allows the requester to include a disk on the target system to be considered for restore, even if it was not selected during the backup phase.</span></span> <span data-ttu-id="64664-230">"ExcludeDisk" permite que o solicitante impeça que um disco no sistema de destino seja recriado.</span><span class="sxs-lookup"><span data-stu-id="64664-230">"ExcludeDisk" allows the requester to prevent a disk on the target system from being re-created.</span></span> <span data-ttu-id="64664-231">Observe que, se "ExcludeDisk" for especificado para um disco que contém um volume crítico, a chamada subsequente para [**IVssBackupComponents::P Rerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) falhará.</span><span class="sxs-lookup"><span data-stu-id="64664-231">Note that if "ExcludeDisk" is specified for a disk that contains a critical volume, the subsequent call to [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) will fail.</span></span>

    <span data-ttu-id="64664-232">O exemplo a seguir mostra como usar [**setrestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) para impedir que disco 0 e disco 1 sejam recriados e injetam drivers de terceiros no volume de inicialização restaurado.</span><span class="sxs-lookup"><span data-stu-id="64664-232">The following example shows how to use [**SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) to prevent disk 0 and disk 1 from being re-created and inject third-party drivers into the restored boot volume.</span></span>

    <span data-ttu-id="64664-233">**Windows server 2008, Windows Vista, Windows server 2003 e Windows XP:** Não há suporte para a injeção de drivers de terceiros.</span><span class="sxs-lookup"><span data-stu-id="64664-233">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Injection of third-party drivers is not supported.</span></span>

    <span data-ttu-id="64664-234">O exemplo supõe que o ponteiro [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) , m \_ pBackupComponents, é válido.</span><span class="sxs-lookup"><span data-stu-id="64664-234">The example assumes that the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) pointer, m\_pBackupComponents, is valid.</span></span>

    ```C++
        m_pBackupComponents->SetRestoreOptions(
            AsrWriterId,
            VSS_CT_FILEGROUP,
            NULL,
            TEXT("ASR"),
            TEXT("\"ExcludeDisk\"=\"0\", \"ExcludeDisk\"=\"1\" "),
            TEXT("\"InjectDrivers\"=\"1\" ")
            );
    ```

    

    <span data-ttu-id="64664-235">Para excluir todos os discos de um volume especificado, consulte o seguinte "excluindo todos os discos de um volume".</span><span class="sxs-lookup"><span data-stu-id="64664-235">To exclude all disks for a specified volume, see the following "Excluding All Disks for a Volume."</span></span>

3.  <span data-ttu-id="64664-236">Chame [**IVssBackupComponents::P Rerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) para notificar o gravador de ASR para se preparar para uma operação de restauração.</span><span class="sxs-lookup"><span data-stu-id="64664-236">Call [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) to notify the ASR writer to prepare for a restore operation.</span></span> <span data-ttu-id="64664-237">Chame [**IVssAsync:: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) quantas vezes forem necessárias até que o valor de status retornado no parâmetro *PHRRESULT* não seja VSS \_ S \_ Async \_ Pending.</span><span class="sxs-lookup"><span data-stu-id="64664-237">Call [**IVssAsync::QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) as many times as necessary until the status value returned in the *pHrResult* parameter is not VSS\_S\_ASYNC\_PENDING.</span></span>
4.  <span data-ttu-id="64664-238">Restaurar os dados.</span><span class="sxs-lookup"><span data-stu-id="64664-238">Restore the data.</span></span> <span data-ttu-id="64664-239">Na fase de restauração, o ASR reconfigura o caminho do GUID do volume ( \\ \\ ? \\ Volume {GUID}) para cada volume para corresponder ao caminho do GUID do volume que foi usado durante a fase de backup.</span><span class="sxs-lookup"><span data-stu-id="64664-239">In the restore phase, ASR reconfigures the volume GUID path (\\\\?\\Volume{GUID}) for each volume to match the volume GUID path that was used during the backup phase.</span></span> <span data-ttu-id="64664-240">No entanto, as letras das unidades não são preservadas, pois isso causaria colisões com as letras da unidade que são atribuídas automaticamente no ambiente de recuperação.</span><span class="sxs-lookup"><span data-stu-id="64664-240">However, drive letters are not preserved, because this would cause collisions with the drive letters that are automatically assigned in the recovery environment.</span></span> <span data-ttu-id="64664-241">Portanto, ao restaurar dados, o solicitante deve usar caminhos de GUID de volume, não letras de unidade, para acessar os volumes.</span><span class="sxs-lookup"><span data-stu-id="64664-241">Thus, when restoring data, the requester must use volume GUID paths, not drive letters, to access the volumes.</span></span>
5.  <span data-ttu-id="64664-242">Defina a  \\  \\ chave do Registro HKLM Software **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession** para indicar o conjunto de volumes que foram restaurados ou reformatados.</span><span class="sxs-lookup"><span data-stu-id="64664-242">Set the **HKLM**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession** registry key to indicate the set of volumes that have been restored or reformatted.</span></span>

    <span data-ttu-id="64664-243">Nessa chave, há um valor chamado **RestoredVolumes** com o tipo de dados reg \_ multi \_ sz.</span><span class="sxs-lookup"><span data-stu-id="64664-243">Under this key, there is a value named **RestoredVolumes** with the data type REG\_MULTI\_SZ.</span></span> <span data-ttu-id="64664-244">Se esse valor não existir, você deverá criá-lo.</span><span class="sxs-lookup"><span data-stu-id="64664-244">If this value does not exist, you should create it.</span></span> <span data-ttu-id="64664-245">Sob esse valor, seu solicitante deve criar uma entrada de GUID de volume para cada volume que foi restaurado.</span><span class="sxs-lookup"><span data-stu-id="64664-245">Under this value, your requester should create a volume GUID entry for each volume that has been restored.</span></span> <span data-ttu-id="64664-246">Essa entrada deve estar no seguinte formato: \\ \\ ? \\ Volume {78618c8f-aefd-11da-a898-806e6f6e6963}.</span><span class="sxs-lookup"><span data-stu-id="64664-246">This entry should be in the following format: \\\\?\\Volume{78618c8f-aefd-11da-a898-806e6f6e6963}.</span></span> <span data-ttu-id="64664-247">Cada vez que uma recuperação bare-metal é executada, o ASR define o valor **RestoredVolumes** para o conjunto de volumes que o ASR restaurou.</span><span class="sxs-lookup"><span data-stu-id="64664-247">Each time a bare-metal recovery is performed, ASR sets the **RestoredVolumes** value to the set of volumes that ASR restored.</span></span> <span data-ttu-id="64664-248">Se o solicitante tiver restaurado volumes adicionais, ele deverá definir esse valor como a União do conjunto de volumes que o solicitante restaurou e o conjunto de volumes que o ASR restaurou.</span><span class="sxs-lookup"><span data-stu-id="64664-248">If the requester restored additional volumes, it should set this value to the union of the set of volumes that the requester restored and the set of volumes that ASR restored.</span></span> <span data-ttu-id="64664-249">Se o solicitante não usou a ASR, ele deve substituir a lista de volumes.</span><span class="sxs-lookup"><span data-stu-id="64664-249">If the requester did not use ASR, it should replace the list of volumes.</span></span>

    <span data-ttu-id="64664-250">Você também deve criar um valor chamado **LastInstance** com o tipo de dados reg \_ sz.</span><span class="sxs-lookup"><span data-stu-id="64664-250">You should also create a value named **LastInstance** with the data type REG\_SZ.</span></span> <span data-ttu-id="64664-251">Essa chave deve conter um cookie aleatório que identifica exclusivamente a operação de restauração atual.</span><span class="sxs-lookup"><span data-stu-id="64664-251">This key should contain a random cookie that uniquely identifies the current restore operation.</span></span> <span data-ttu-id="64664-252">Esse cookie pode ser criado usando as funções [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) e [**UuidToString**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) .</span><span class="sxs-lookup"><span data-stu-id="64664-252">Such a cookie can be created by using the [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) and [**UuidToString**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) functions.</span></span> <span data-ttu-id="64664-253">Cada vez que uma recuperação bare-metal é executada, o ASR redefine esse valor de registro para notificar os solicitantes e os aplicativos de backup não VSS que a recuperação ocorreu.</span><span class="sxs-lookup"><span data-stu-id="64664-253">Each time a bare-metal recovery is performed, ASR resets this registry value to notify requesters and non-VSS backup applications that the recovery has occurred.</span></span>

6.  <span data-ttu-id="64664-254">Chame [**IVssBackupComponents::P ostrestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) para indicar o fim da operação de restauração.</span><span class="sxs-lookup"><span data-stu-id="64664-254">Call [**IVssBackupComponents::PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) to indicate the end of the restore operation.</span></span> <span data-ttu-id="64664-255">Chame [**IVssAsync:: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) quantas vezes forem necessárias até que o valor de status retornado no parâmetro *PHRRESULT* não seja VSS \_ S \_ Async \_ Pending.</span><span class="sxs-lookup"><span data-stu-id="64664-255">Call [**IVssAsync::QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) as many times as necessary until the status value returned in the *pHrResult* parameter is not VSS\_S\_ASYNC\_PENDING.</span></span>

<span data-ttu-id="64664-256">Na fase de restauração, o ASR pode criar ou remover partições para restaurar o computador ao estado anterior.</span><span class="sxs-lookup"><span data-stu-id="64664-256">In the restore phase, ASR may create or remove partitions to restore the computer to its previous state.</span></span> <span data-ttu-id="64664-257">Os solicitantes não devem tentar mapear os números de disco da fase de backup para a fase de restauração.</span><span class="sxs-lookup"><span data-stu-id="64664-257">Requesters must not attempt to map disk numbers from the backup phase to the restore phase.</span></span>

<span data-ttu-id="64664-258">Na restauração, o solicitante deve excluir o disco que contém o conjunto de backup do solicitante.</span><span class="sxs-lookup"><span data-stu-id="64664-258">On restore, the requester must exclude the disk that contains the requester's backup set.</span></span> <span data-ttu-id="64664-259">Caso contrário, o conjunto de backup pode ser substituído pela operação de restauração.</span><span class="sxs-lookup"><span data-stu-id="64664-259">Otherwise, the backup set can be overwritten by the restore operation.</span></span>

<span data-ttu-id="64664-260">Na restauração, um disco será excluído se não tiver sido selecionado como um componente durante o backup ou se ele for explicitamente excluído chamando [**IVssBackupComponents:: setrestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) com a opção "ExcludeDisk" durante a restauração.</span><span class="sxs-lookup"><span data-stu-id="64664-260">On restore, a disk is excluded if it was not selected as a component during backup, or if it is explicitly excluded by calling [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) with the "ExcludeDisk" option during restore.</span></span>

<span data-ttu-id="64664-261">É importante observar que durante a recuperação de desastres do WinPE, a funcionalidade do gravador ASR está presente, mas nenhum outro gravador está disponível e o serviço VSS não está em execução.</span><span class="sxs-lookup"><span data-stu-id="64664-261">It is important to note that during WinPE disaster recovery, ASR writer functionality is present, but no other writers are available, and the VSS service is not running.</span></span> <span data-ttu-id="64664-262">Após a recuperação de desastres do WinPE ser concluída, o computador foi reiniciado e o sistema operacional Windows está em execução normalmente, o serviço VSS pode ser iniciado e o solicitante pode executar qualquer operação de restauração adicional que exija a participação de gravadores diferentes do gravador de ASR.</span><span class="sxs-lookup"><span data-stu-id="64664-262">After WinPE disaster recovery has completed, the computer has restarted, and the Windows operating system is running normally, the VSS service can be started, and the requester can perform any additional restore operations that require participation of writers other than the ASR writer.</span></span>

<span data-ttu-id="64664-263">Se, durante a sessão de restauração, o aplicativo de backup detectar que as IDs exclusivas de volume estão inalteradas e, portanto, todos os volumes da hora do backup estarão presentes e intactos no WinPE, o aplicativo de backup poderá continuar restaurando apenas o conteúdo dos volumes, sem envolver o ASR.</span><span class="sxs-lookup"><span data-stu-id="64664-263">If during the restore session the backup application detects that the volume unique IDs are unchanged, and therefore all volumes from the time of the backup are present and intact in WinPE, the backup application can proceed to restore only the contents of the volumes, without involving ASR.</span></span> <span data-ttu-id="64664-264">Nesse caso, o aplicativo de backup deve indicar que o computador foi restaurado definindo a seguinte chave do registro no sistema operacional restaurado: **HKEY \_ local \_ Machine** \\ **software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession**</span><span class="sxs-lookup"><span data-stu-id="64664-264">In this case, the backup application should indicate that the computer was restored by setting the following registry key in the restored operating system: **HKEY\_LOCAL\_MACHINE**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession**</span></span>

<span data-ttu-id="64664-265">Sob essa chave, especifique **LastInstance** para o nome do valor, Reg \_ sz para o tipo de valor e um cookie aleatório (como um GUID criado pela função [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) ) para os dados do valor.</span><span class="sxs-lookup"><span data-stu-id="64664-265">Under this key, specify **LastInstance** for the value name, REG\_SZ for the value type, and a random cookie (such as a GUID created by the [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) function) for the value data.</span></span>

<span data-ttu-id="64664-266">Se, durante a sessão de restauração, o aplicativo de backup detectar que um ou mais volumes foram alterados ou ausentes, o aplicativo de backup deverá usar a ASR para executar a restauração.</span><span class="sxs-lookup"><span data-stu-id="64664-266">If during the restore session the backup application detects that one or more volumes are changed or missing, the backup application should use ASR to perform the restore.</span></span> <span data-ttu-id="64664-267">O ASR recriará os volumes exatamente como estavam no momento do backup e definiu a chave do registro **RestoreSession** .</span><span class="sxs-lookup"><span data-stu-id="64664-267">ASR will re-create the volumes exactly the way they were at the time of the backup and set the **RestoreSession** registry key.</span></span>

## <a name="excluding-all-disks-for-a-volume"></a><span data-ttu-id="64664-268">Excluindo todos os discos de um volume</span><span class="sxs-lookup"><span data-stu-id="64664-268">Excluding All Disks for a Volume</span></span>

<span data-ttu-id="64664-269">O exemplo a seguir mostra como excluir todos os discos de um volume especificado.</span><span class="sxs-lookup"><span data-stu-id="64664-269">The following example shows how to exclude all disks for a specified volume.</span></span>


```C++
HRESULT BuildRestoreOptionString
(
    const WCHAR             *pwszVolumeNamePath,
    CMyString               *pstrExclusionList
)
{
    HANDLE                  hVolume           = INVALID_HANDLE_VALUE;
    DWORD                   cbSize            = 0;
    VOLUME_DISK_EXTENTS     * pExtents        = NULL;
    DISK_EXTENT             * pExtent         = NULL;
    ULONG                   i                 = 0;
    BOOL                    fIoRet            = FALSE;
    WCHAR                   wszDest[MAX_PATH] = L"";
    CMyString               strVolumeName;
    CMyString               strRestoreOption;

    // Open a handle to the volume device.
    strVolumeName.Set( pwszVolumeNamePath );
    // If the volume name contains a trailing backslash, remove it.
    strVolumeName.UnTrailing( L'\\' );
    hVolume = ::CreateFile(strVolumeName, 0, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, NULL, 0);
    // Check whether the call to CreateFile succeeded.

    // Get the list of disks used by this volume.
    cbSize = sizeof(VOLUME_DISK_EXTENTS);
    pExtents = (VOLUME_DISK_EXTENTS *)::CoTaskMemAlloc(cbSize);

    ::ZeroMemory(pExtents, cbSize);

    fIoRet = ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
    if ( !fIoRet && GetLastError() == ERROR_MORE_DATA )
    {
        // Allocate more memory.
        cbSize = FIELD_OFFSET(VOLUME_DISK_EXTENTS, Extents) + pExtents->NumberOfDiskExtents * sizeof(DISK_EXTENT);
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;

        pExtents = (VOLUME_DISK_EXTENTS *) ::CoTaskMemAlloc(cbSize);
        // Check whether CoTaskMemAlloc returned an out-of-memory error.
        ::ZeroMemory(pExtents, cbSize);

        // Now the buffer should be big enough.
        ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
        // Check whether the IOCTL succeeded.
    }
    // Check for errors; note that the IOCTL can fail for a reason other than insufficient memory.

    // For each disk, mark it to be excluded in the Restore Option string.
    for (i = 0; i < pExtents->NumberOfDiskExtents; i++)
    {
        pExtent = &pExtents->Extents[i];

        *wszDest = L'\0';
        StringCchPrintf(wszDest, MAX_PATH, L"\"ExcludeDisk\"=\"%d\", ", pExtent->DiskNumber); // check errors

        strRestoreOption.Append(wszDest);
        // Check for an out-of-memory error.
    }

    // Remove the trailing comma.
    strRestoreOption.TrimRight();
    strRestoreOption.UnTrailing(',');

    // Set the output parameter.
    strRestoreOption.Transfer( pstrExclusionList );

Exit:
    if( pExtents )
    {
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;
    }

    if( hVolume != INVALID_HANDLE_VALUE )
    {
        ::CloseHandle(hVolume);
        hVolume = INVALID_HANDLE_VALUE;
    }

    return ( hr );
}

```



 

 
