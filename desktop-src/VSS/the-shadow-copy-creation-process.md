---
description: O processo de criação de cópia de sombra
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: O processo de criação de cópia de sombra
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dae0d0cff8e4afdbecb5c61a934be1a9c9b731cbdbee8778afd714f6802ca2ae
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/11/2021
ms.locfileid: "119056354"
---
# <a name="the-shadow-copy-creation-process"></a>O processo de criação de cópia de sombra

A seguir está uma descrição detalhada da função do provedor de hardware na criação de um conjunto de cópias de sombra. Para ver um diagrama desse processo, consulte [Criação de cópia de sombra para provedores.](shadow-copy-creation-for-providers.md)

1.  À medida que o solicitante adiciona cada volume ao conjunto de cópias de sombra, o VSS determina os LUNs associados. Por exemplo, um volume ampliado pode ser composto por vários LUNs. O VSS cria uma informação [**inicial de LUN do VDS \_ \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) usando informações de dispositivo físico para cada LUN.
2.  O VSS [**chama AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) para determinar se o provedor dá suporte a uma cópia de sombra para esse LUN. O provedor de hardware usa as [**INFORMAÇÕES de LUN do VDS \_ \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) para determinar se há suporte para os LUNs. Essa determinação deve ser tudo ou nada – o mesmo provedor de hardware deve dar suporte a todos os LUNs que contribuem para um volume específico. No exemplo de volume ampliado, o provedor não pode indicar que dá suporte a apenas um dos LUNs que compõem o volume.
3.  Para cada volume no conjunto de cópias de sombra, o VSS chama [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) com a mesma matriz de estruturas de INFORMAÇÕES [**de \_ LUN \_ do VDS.**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) Em uma única chamada, todos os LUNs na matriz são exclusivos, mas o mesmo LUN pode aparecer em uma chamada subsequente sempre que o mesmo LUN contribuir com vários volumes. O provedor deve tratar esse caso corretamente.
4.  Imediatamente após [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots,**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)o VSS definirá os sinalizadores somente leitura, oculto, sem letra da unidade e cópia de sombra em todos os LUNs afetados. Os sinalizadores são implementados usando setores ocultos em discos MBR ou bits específicos do sistema operacional na entrada de título de partição em discos GPT. Os sinalizadores causarão a superfície de todos os volumes nos discos afetados nos computador receptores como somente leitura e ocultos. Observe que os LUNs copiados em sombra não foram confirmados neste estágio, de modo que, em caso de falha do sistema, os sinalizadores serão limpos e o LUN original não será afetado. Ou seja, todos os volumes no LUN original serão tratados normalmente e manterão suas atribuições originais de letra da unidade, pastas montadas e status de leitura/gravação.
    > [!Note]  
    > Os provedores não devem tentar modificar nenhum dos sinalizadores de LUN.

     

5.  Em [**CommitSnapshots,**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)os LUNs de cópia de sombra são confirmados. **CommitSnapshots devem** ser retornados em alguns segundos ou todo o processo de criação de cópia de sombra provavelmente falhará.
6.  Após [**CommitSnapshots,**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)o VSS limpa os sinalizadores em todos os LUNs originais envolvidos na cópia de sombra. Como os LUNs de cópia de sombra foram confirmados neste ponto, os LUNs de cópia de sombra retêm esses sinalizadores.
7.  Depois [**que IVssProviderCreateSnapshotSet::P ostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots), o VSS limpa os sinalizadores lun (definidos após [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots)**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)e notifica os autores para descongelar. O VSS chama os métodos [**IVssProviderCreateSnapshotSet::P reFinalCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) e [**IVssProviderCreateSnapshotSet::P ostFinalCommitSnapshots.**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots)
8.  O VSS recupera uma matriz de estruturas DE INFORMAÇÕES de [**\_ LUN \_ do VDS,**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) uma para cada LUN de cópia de sombra recém-criada, chamando [**IVssHardwareSnapshotProvider::GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns). O provedor deve fornecer informações suficientes para permitir que o VSS e o provedor identifiquem as cópias de sombra a qualquer momento posterior e em qualquer sistema conectado ao subsistema. Neste momento, os LUNs de cópia de sombra devem estar inacessíveis para esse computador– o provedor deve usar algum mecanismo diferente de simplesmente ler as informações do LUN.
9.  Para cópias de sombra transportáveis, o VSS anexa o seguinte ao Documento de Componentes de Backup que descreve o conjunto de cópias de sombra:
    1.  A matriz de informações de [**LUN VDS \_ \_ lun**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) original.
    2.  A nova matriz de INFORMAÇÕES DE LUN [**VDS de cópia \_ \_ de**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) sombra.
    3.  As extensão de disco para cada volume no conjunto de cópias de sombra.
10. Para cópias de sombra de importação automática, o processo de importação começa. Em [**IVssHardwareSnapshotProvider::LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), o provedor receberá as INFORMAÇÕES de LUN do [**VDS \_ \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) geradas em [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) no momento da criação. Durante **o LocateLuns**, o provedor deve tornar esses LUNs de cópia de sombra visíveis para o sistema. O provedor não deve causar uma nova verificação de barramento. O VSS fará com que a análise e a enumeração permitam que os LUNs sejam descobertos pelo PNP e que os volumes sejam online.
11. O VSS [**chama IVssHardwareSnapshotProvider::FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) para os discos recém-lançados no sistema. O VSS usa a matriz de INFORMAÇÕES DE [**\_ LUN \_ VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de cópia de sombra de **FillInLunInfo**, comparando-a com as INFORMAÇÕES de LUN do **VDS \_ \_** geradas durante a criação em [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) e as extensão de disco para cada volume no conjunto de cópias de sombra para identificar os LUNs de cópia de sombra recém-chegadas.
12. Neste ponto, todos os volumes contidos nos LUNs de cópia de sombra são montados ocultos e somente leitura, e o VSS tem um mapeamento do volume original para o volume de cópia de sombra.

Como um único LUN pode conter partes de vários volumes, o conjunto de LUNs de cópia de sombra pode incluir volumes "extras". Esses volumes não fazem parte do conjunto de cópias de sombra e não devem ser usados, pois não há garantia de que eles sejam consistentes.

Após a importação, a cópia de sombra pode ser acessada por [**meio do método IVssBackupComponents::Query.**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) Uma cópia de sombra também pode ser exposta como uma letra da unidade, pasta montada ou compartilhamento usando [**IVssBackupComponents::ExposeSnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot). Um conjunto de cópias de sombra também pode ser convertido em um LUN normal usando o [**método IVssBackupComponents::BreakSnapshotSet.**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) A partir daí, os aplicativos de gerenciamento podem usar APIs de gerenciamento de disco apropriadas para gerenciar ainda mais o LUN (como alterar os atributos de leitura/gravação).

### <a name="transportable-shadow-copies-on-a-san"></a>Cópias de sombra transportáveis em uma SAN

A partir do Windows Server 2003, Datacenter Edition e Windows Server 2003, Edição Enterprise, o VSS permite conjuntos de cópias de sombra transportáveis em uma SAN. Do ponto de vista de um provedor capaz de transportar LUNs entre hosts, há pouca ou nenhuma diferença entre um conjunto de cópias de sombra não transportável e não transportável.

**Windows Server 2003, Edição Standard, Windows Server 2003, Web Edition e Windows XP:** Não há suporte para conjuntos de cópias de sombra transportáveis. Todas as edições do Windows Server 2003 com Service Pack 1 (SP1) são suportadas por conjuntos de cópias de sombra transportáveis.

Conjuntos de cópias de sombra transportáveis devem ser criados com o atributo **\_ \_ \_ TRANSPORTABLE DO VSS VOLSNAP ATTR** adicionado ao contexto de cópia de sombra descrito pela enumeração ATRIBUTOS DE INSTANTÂNEO DE VOLUME DO [**\_ VSS. \_ \_ \_**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) Todos os volumes no conjunto devem ser transportáveis. Ao retornar o sucesso de [**IVssHardwareSnapshotProvider::AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported), o provedor está indicando que ele não só dá suporte ao LUN, mas também que ele pode transportar o LUN. A criação de um conjunto de cópias de sombra transportável é concluída quando o VSS registra as informações de LUN no Documento de Componentes de Backup. Um conjunto de cópias de sombra só pode ser importado uma vez após a criação inicial.

No computador receptor, o solicitante importa o conjunto de cópias de sombra. O [**método IVssBackupComponents::ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) usa o Documento de Componentes de Backup que descreve o conjunto de cópias de sombra como entrada. A importação continua por:

1.  O VSS constrói uma matriz de estruturas de INFORMAÇÕES [**de LUN de VDS de cópia \_ \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de sombra do Documento de Componentes de Backup.
2.  Quando o VSS chama [**IVssHardwareSnapshotProvider::LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), a matriz de estruturas de INFORMAÇÕES de LUN do [**VDS \_ \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) geradas [**em IVssHardwareSnapshotProvider::GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) será passada para o provedor. Durante o processamento desse método, o provedor deve tornar esses LUNs de cópia de sombra visíveis para o sistema. O provedor não deve causar uma nova verificação de barramento. O VSS disparará a análise e a enumeração para permitir que os LUNs sejam descobertos pelo PNP e os volumes sejam online.
3.  O VSS [**chama IVssHardwareSnapshotProvider::FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) para os discos recém-lançados no sistema. O VSS usa a matriz de LUN de cópia de sombra de estruturas DE INFORMAÇÕES de [**\_ LUN \_ do VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de **FillInLunInfo**, comparando-a com as INFORMAÇÕES de LUN do **VDS \_ \_** geradas durante a criação do conjunto de cópias de sombra em [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) e as extensão de disco para cada volume no conjunto de cópias de sombra para identificar os LUNs de cópia de sombra recém-chegadas.
4.  Neste ponto, todos os volumes contidos nos LUNs transportados são montados ocultos e somente leitura e o VSS tem um mapeamento do volume original para o volume de cópia de sombra.

Para o computador único e o caso transportável, a sequência é semelhante a partir do ponto em que [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) é chamado. Para importação automática, as etapas ocorrem diretamente após a criação.

 

 
