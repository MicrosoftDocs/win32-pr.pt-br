---
description: O processo de criação de cópia de sombra
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: O processo de criação de cópia de sombra
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4239e2b671edcaeb35b404d9b9411b43316c0212
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103647174"
---
# <a name="the-shadow-copy-creation-process"></a>O processo de criação de cópia de sombra

Veja a seguir uma descrição detalhada da função do provedor de hardware na criação de um conjunto de cópias de sombra. Para obter um diagrama desse processo, consulte [criação de cópia de sombra para provedores](shadow-copy-creation-for-providers.md).

1.  Como o solicitante adiciona cada volume ao conjunto de cópias de sombra, o VSS determina os LUNs associados. Por exemplo, um volume estendido pode ser composto por vários LUNs. O VSS cria uma [**\_ \_ informação de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) inicial usando informações de dispositivo físico para cada LUN.
2.  O VSS chama [**AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) para determinar se o provedor oferece suporte a uma cópia de sombra para esse LUN. O provedor de hardware usa [**as \_ \_ informações de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) para determinar se há suporte para os LUNs. Essa determinação deve ser tudo ou nada — o mesmo provedor de hardware deve dar suporte a todos os LUNs que contribuem para um volume específico. No exemplo de volume estendido, o provedor não pode indicar que ele dá suporte a apenas um dos LUNs que compõem o volume.
3.  Para cada volume no conjunto de cópias de sombra, o VSS chama [**IVssHardwareSnapshotProvider:: BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) com a mesma matriz de estruturas de [**\_ \_ informações de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) . Em uma única chamada, todos os LUNs na matriz são exclusivos, mas o mesmo LUN pode aparecer em uma chamada subsequente sempre que o mesmo LUN contribuir para vários volumes. O provedor deve lidar com esse caso corretamente.
4.  Imediatamente após [**IVssProviderCreateSnapshotSet:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots), o VSS definirá os sinalizadores somente leitura, oculto, sem letra da unidade e cópia de sombra em todos os LUNs afetados. Os sinalizadores são implementados usando setores ocultos em discos MBR ou bits específicos do sistema operacional na entrada de cabeçalho da partição em discos GPT. Os sinalizadores farão com que todos os volumes nos discos afetados sejam exibidos nos computadores de recebimento como somente leitura e ocultos. Observe que os LUNs copiados por sombra não foram confirmados nesse estágio, para que, no caso de uma falha do sistema, os sinalizadores sejam limpos e o LUN original não seja afetado. Ou seja, todos os volumes no LUN original serão tratados como normais — e manterão suas atribuições de letra de unidade original, pastas montadas e status de leitura/gravação.
    > [!Note]  
    > Os provedores não devem tentar modificar nenhum dos sinalizadores de LUN.

     

5.  Em [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), os LUNs de cópia de sombra são confirmados. **CommitSnapshots** deve ser retornado dentro de alguns segundos ou o processo de criação de cópia de sombra inteiro provavelmente falhará.
6.  Após [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), o VSS limpa os sinalizadores em todos os LUNs originais envolvidos na cópia de sombra. Como os LUNs de cópia de sombra foram confirmados neste ponto, os LUNs de cópia de sombra retêm esses sinalizadores.
7.  Após [**IVssProviderCreateSnapshotSet::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots), o VSS limpa os sinalizadores de LUN (que ele definiu após [**IVssProviderCreateSnapshotSet:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)) e notifica os gravadores para descongelar. Em seguida, o VSS chama os métodos [**IVssProviderCreateSnapshotSet::P refinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) e [**IVssProviderCreateSnapshotSet::P ostfinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots) do provedor.
8.  O VSS recupera uma matriz de estruturas de [**\_ \_ informações de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , uma para cada LUN de cópia de sombra criado recentemente, chamando [**IVssHardwareSnapshotProvider:: GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns). O provedor deve fornecer informações suficientes para permitir que o VSS e o provedor identifiquem as cópias de sombra em qualquer momento posterior e em qualquer sistema conectado ao subsistema. Neste momento, os LUNs de cópia de sombra devem estar inacessíveis a esse computador — o provedor deve usar algum mecanismo além de simplesmente ler as informações do LUN.
9.  Para cópias de sombra transportáveis, o VSS acrescenta o seguinte ao documento de componentes de backup que descreve o conjunto de cópias de sombra:
    1.  A matriz de [**\_ \_ informações do LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) do LUN original.
    2.  A nova matriz de [**informações de \_ LUN \_ VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de LUN de cópia de sombra.
    3.  As extensões de disco para cada volume no conjunto de cópias de sombra.
10. Para a importação automática de cópias de sombra, o processo de importação é iniciado. Em [**IVssHardwareSnapshotProvider:: LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), o provedor receberá as [**informações de \_ LUN \_ VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) geradas em [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) no momento da criação. Durante a **LocateLuns**, o provedor deve tornar esses LUNs de cópia de sombra visíveis para o sistema. O provedor não deve fazer um novo exame do barramento. O VSS causará a nova verificação e a enumeração para permitir que os LUNs sejam descobertos por PNP e os volumes sejam online.
11. O VSS chama [**IVssHardwareSnapshotProvider:: FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) para os discos recentemente recebidos no sistema. O VSS usa a matriz de [**\_ \_ informações de LUN**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de cópia de sombra LUN VDS do **FillInLunInfo**, comparando-a com as **\_ \_ informações de LUN VDS** geradas durante a criação em [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) e as extensões de disco para cada volume na cópia de sombra definida para identificar os LUNs de cópia de sombra recentemente recebidos.
12. Neste ponto, todos os volumes contidos nos LUNs de cópia de sombra são montados como somente leitura e ocultos, e o VSS tem um mapeamento do volume original para o volume da cópia de sombra.

Como um único LUN pode conter partes de vários volumes, o conjunto de LUNs de cópia de sombra pode incluir volumes "extras". Esses volumes não fazem parte do conjunto de cópias de sombra e não devem ser usados, pois não há garantia de que eles sejam consistentes.

Após a importação, a cópia de sombra pode ser acessada por meio do método [**IVssBackupComponents:: Query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) . Uma cópia de sombra também pode ser exposta como uma letra da unidade, pasta montada ou compartilhamento usando [**IVssBackupComponents:: ExposeSnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot). Um conjunto de cópias de sombra também pode ser convertido em um LUN regular usando o método [**IVssBackupComponents:: BreakSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) . A partir daí, os aplicativos de gerenciamento podem usar APIs de gerenciamento de disco apropriadas para gerenciar ainda mais o LUN (como alterar os atributos de leitura/gravação).

### <a name="transportable-shadow-copies-on-a-san"></a>Cópias de sombra transportáveis em uma SAN

A partir do Windows Server 2003, Datacenter Edition e Windows Server 2003, Enterprise Edition, o VSS habilita conjuntos de cópia de sombra transportáveis em uma SAN. Do ponto de vista de um provedor capaz de transportar LUNs entre hosts, há pouca ou nenhuma diferença entre um conjunto de cópia de sombra não transportável e transportável.

**Windows server 2003, Standard Edition, Windows server 2003, Web Edition e Windows XP:** Não há suporte para conjuntos de cópia de sombra transportáveis. Todas as edições do Windows Server 2003 com Service Pack 1 (SP1) oferecem suporte a conjuntos de cópia de sombra transportáveis.

Os conjuntos de cópia de sombra transportáveis devem ser criados com o atributo **\_ \_ \_ transportável do VSS VOLSNAP attr** adicionado ao contexto de cópia de sombra descrito pela enumeração [**\_ \_ atributos de \_ instantâneo \_ de volume do VSS**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) . Todos os volumes no conjunto devem ser transportáveis. Ao retornar o sucesso de [**IVssHardwareSnapshotProvider:: AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported), o provedor indica que ele não apenas oferece suporte ao LUN, mas também que ele pode transportar o LUN. A criação de um conjunto de cópia de sombra transportável é concluída quando o VSS registra as informações de LUN no documento de componentes de backup. Um conjunto de cópias de sombra só pode ser importado uma vez após a criação inicial.

No computador receptor, o solicitante importa o conjunto de cópias de sombra. O método [**IVssBackupComponents:: ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) usa o documento componentes de backup que descreve o conjunto de cópias de sombra como entrada. A importação prossegue por:

1.  O VSS constrói uma matriz de estruturas de [**\_ \_ informações de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de cópia de sombra do documento de componentes de backup.
2.  Quando o VSS chama [**IVssHardwareSnapshotProvider:: LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), a matriz de estruturas de [**\_ \_ informações de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) gerada em [**IVssHardwareSnapshotProvider:: GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) será passada para o provedor. Durante o processamento desse método, o provedor deve tornar esses LUNs de cópia de sombra visíveis para o sistema. O provedor não deve fazer um novo exame do barramento. O VSS disparará a nova verificação e a enumeração para permitir que os LUNs sejam descobertos pelo PNP e pelos volumes para ficarem online.
3.  O VSS chama [**IVssHardwareSnapshotProvider:: FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) para os discos recentemente recebidos no sistema. O VSS usa a matriz de LUN de cópia de sombra das estruturas de [**\_ \_ informações de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) do **FillInLunInfo**, comparando-a com as **informações de \_ LUN \_ do VDS** geradas durante a criação do conjunto de cópias de sombra em [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) e as extensões de disco para cada volume na cópia de sombra definida para identificar os LUNs de cópia de sombra recentemente recebidos.
4.  Neste ponto, todos os volumes contidos nos LUNs transportados são apenas ocultos e somente leitura, e o VSS tem um mapeamento do volume original para o volume da cópia de sombra.

Para o caso de computador único e transportável, a sequência é semelhante a partir do ponto em que [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) é chamado. Para a importação automática, as etapas acontecem diretamente após a criação.

 

 
