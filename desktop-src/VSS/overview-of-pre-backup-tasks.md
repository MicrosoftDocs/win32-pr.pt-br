---
description: As tarefas de pré-backup no VSS concentram-se na criação de uma cópia de sombra dos volumes que contêm dados para backup.
ms.assetid: e6b082af-719b-4426-8217-0fc940f5884d
title: Visão geral das tarefas de pré-backup
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: af8dd6ea99215d486b8be7d07d30bcbdb5258548078fd642028dd6a93ca42796
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/11/2021
ms.locfileid: "119511736"
---
# <a name="overview-of-pre-backup-tasks"></a>Visão geral das tarefas de pré-backup

As tarefas de pré-backup no VSS concentram-se na criação de uma cópia de sombra dos volumes que contêm dados para backup. O aplicativo de backup salvará os dados da cópia de sombra, não do volume real. Para obter mais informações, consulte [visão geral do processamento de um backup em VSS](overview-of-processing-a-backup-under-vss.md).

Os solicitantes normalmente esperam que os gravadores se preparem para o backup e criem a cópia de sombra. O gravador deve determinar se é para participar do backup e, se estiver, configurar seus arquivos e para estar pronto para backup e cópia de sombra. A tabela a seguir mostra a sequência de ações e eventos que são necessários para se preparar para uma operação de backup.



| Ação do solicitante                                                                                                                                                                                                                                                                                                            | Evento                                                                      | Ação do gravador                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| O solicitante pode definir opções de backup (consulte [**IVssBackupComponents:: Setbackupoptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions))                                                                                                                                                                                          | Nenhum                                                                       | Nenhum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Suporte a operações de backup incrementais e diferenciais examinando quaisquer carimbos de backup armazenados (consulte [**IVssComponent:: GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**IVssBackupComponents:: SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp))                                               | Nenhum                                                                       | Nenhum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Notifique os gravadores para se preparar para uma operação de backup usando [ **IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)                                                                                                                                                                              | [*PrepareForBackup*](vssgloss-p.md)  | As preparações do gravador incluem determinar se os arquivos devem ser copiados em backup, se o gravador participará do congelamento da cópia de sombra, bem como da criação de metadados específicos do gravador (consulte [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**CVssWriter:: IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent:: getbackupoptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter:: AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent:: SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata)e [**IVssComponent:: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp). |
| O solicitante aguarda que os gravadores sejam configurados para backup usando [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync). Ele também deve verificar o status do gravador (consulte [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus))     | Nenhum                                                                       | Nenhum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| O solicitante solicita uma cópia de sombra usando [ **IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)                                                                                                                                                                                                    | Nenhum                                                                       | Nenhum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Nenhum                                                                                                                                                                                                                                                                                                                        | [*PrepareForSnapshot*](vssgloss-p.md) | [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot): colocar o gravador em um estado pronto de cópia de sombra.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Nenhum                                                                                                                                                                                                                                                                                                                        | [*Congelamento*](vssgloss-f.md)                      | [**CVssWriter:: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze): configuração final antes da cópia de sombra.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Nenhum                                                                                                                                                                                                                                                                                                                        | [*Congelar*](vssgloss-t.md)                          | [**CVssWriter:: descongelar**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw): o funcionamento normal (incluindo e/s) pode ser retomado.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Nenhum                                                                                                                                                                                                                                                                                                                        | [*Pós-instantâneo*](vssgloss-p.md)          | [**CVssWriter:: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot): a limpeza final dos preparações de cópia de sombra. Consulte [**IVssComponent:: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) e [**IVssComponent:: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| O solicitante aguarda a conclusão da cópia de sombra usando: [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync), ele também deve verificar o status do gravador (consulte [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)<br/> | Nenhum                                                                       | Nenhum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |



 

## <a name="requester-pre-backup-tasks"></a>Tarefas de pré-backup do solicitante

Além disso, antes de criar um evento [**IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , um solicitante também pode definir opções de backup para gravadores individuais usando [**IVssBackupComponents:: setbackupoptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) dependendo das especificidades de cada gravador e se um solicitante está ciente deles.

Para dar suporte a operações incrementais e diferenciais, os solicitantes podem, neste ponto, optar por examinar os componentes de carimbos de data/hora da operação de backup anterior (usando [**IVssComponent:: GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) e usar essas informações para definir um carimbo de data/hora anterior para um gravador processar (usando [**IVssBackupComponents:: SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)). Consulte [backups incrementais e diferenciais](incremental-and-differential-backups.md) para obter mais informações.

Um solicitante agora pode direcionar os gravadores do sistema para concluir preparações de pré-backup e para lidar com a criação de uma cópia de sombra.

Primeiro, o solicitante gera um evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) chamando [**IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).

Depois que todos os criadores de participação retornam do tratamento do evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) (que um solicitante determina usando a instância da interface [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync) retornada pelo **PrepareForBackup**), o solicitante pode iniciar a cópia de sombra chamando [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), que, conforme progride, gerará eventos [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*descongelar*](vssgloss-t.md)e [*upsnapshot*](vssgloss-p.md) para que os gravadores manipulem.

Há alguns casos em que um solicitante pode não precisar criar uma cópia de sombra. Especificamente, cada [*conjunto de arquivos*](vssgloss-f.md) gerenciado por um dos componentes de um determinado gravador tem uma máscara de backup de especificação de arquivo (indicada por um ou bit ou de valores de tipo de backup de especificação de [**\_ arquivo \_ \_ \_ VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) ) definido durante o evento de [*identificação*](vssgloss-i.md) . Essa máscara especifica, entre outras coisas, se um conjunto de arquivos exige que o sistema seja copiado em sombra antes de seu backup ser executado.

Se nenhum conjunto de arquivos a ser submetido a backup em qualquer volume exigir uma cópia de sombra, [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) não precisa ser chamado.

## <a name="writer-pre-backup-tasks"></a>Tarefas de pré-backup do gravador

Ao manipular o evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , o VSS chamará o método [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) de cada gravador, um método virtual que, por padrão, simplesmente retorna true.

Os gravadores podem substituir essa implementação padrão e usar a manipulação para encontrar informações sobre o próximo backup e executar a ação.

Um gravador pode determinar informações sobre o tipo de operação de backup contempladas usando os seguintes métodos:

1.  [**CVssWriter:: getbackuptype**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)
2.  [**CVssWriter::IsBootableStateBackedUp**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-isbootablesystemstatebackedup)
3.  [**CVssWriter::AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)

Um gravador determina se os arquivos que ele gerencia estarão envolvidos na cópia de sombra usando [**CVssWriter:: IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).

Mais importante: quando o VSS chama o método [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) , ele passa uma instância da interface [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) , que permite o acesso direto por meio da interface [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) para aqueles de seus componentes [*explicitamente incluídos*](vssgloss-e.md) no documento de componentes de backup do solicitante. O gravador usou as instâncias da interface **IVssComponent** que definem conjuntos de componentes para obter acesso ao componente *incluído implicitamente* (consulte a [seleção e trabalhando com propriedades de componente](selectability-and-working-with-component-properties.md)).

Durante a manipulação do evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , os gravadores usam a interface [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) para executar operações componente a componente (ou conjunto de componentes por conjunto de componentes), incluindo:

1.  Adicionando [*arquivos parciais*](vssgloss-p.md) (se houver suporte) chamando [**IVssComponent:: addparcialfile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).
2.  Definir quaisquer metadados privados que o gravador precisará para lidar com a restauração.
3.  Se o gravador oferecer suporte a backups incrementais e diferenciais (consulte [backups incrementais e diferenciais](incremental-and-differential-backups.md)), faça o seguinte:
    -   Verificando carimbos de data/hora de backup anteriores chamando [**IVssComponent:: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).
    -   Adicionar quaisquer [*arquivos diferenciados*](vssgloss-d.md) necessários chamando [**IVssComponent:: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).
    -   Se o gravador for compatível com o esquema de **\_ \_ carimbo** de data/hora do VSS, adicionar cadeias de caracteres de carimbo de data/horário de backup no formato próprio do gravador usando [**IVssComponent:: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).
4.  Iniciar operações assíncronas muito demoradas, como sincronização de dados em vários discos. Isso permitirá que o gravador continue trabalhando enquanto a operação é processada, incluindo o tratamento de outros eventos do VSS. Essas operações devem terminar antes do evento [*Freeze*](vssgloss-f.md) .

A chamada do solicitante para [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) inicia a cópia de sombra e gera os seguintes eventos para que os gravadores manipulem:

-   [*PrepareForSnapshot*](vssgloss-p.md)
-   [*Congelamento*](vssgloss-f.md)
-   [*Congelar*](vssgloss-t.md)
-   [*Pós-instantâneo*](vssgloss-p.md)

Três dos manipuladores do escritor —[**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot), [**CVssWriter:: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)e [**CVssWriter:: descongelar**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)— são métodos virtuais puros, e cada gravador deve implementá-los em vez de confiar nos padrões. Dependendo das necessidades de um gravador, eles podem ser codificados como métodos fictícios, simplesmente retornando **true**.

Como normalmente há uma janela de tempo estreita entre a emissão de um evento [*Freeze*](vssgloss-f.md) e a emissão de um evento de [*descongelamento*](vssgloss-t.md) , a maior parte do trabalho principal na preparação para a cópia de sombra — como desligar processos, criar arquivos temporários ou descarregar filas de e/s — seria manipulada em [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).

Como um gravador pode usar [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) para lidar com sua e/s antes que a criação de uma cópia de sombra seja altamente dependente da própria arquitetura do gravador.

Gravadores que podem conter todas as gravações e manter os dados em um estado consistente absoluto antes de [*congelar*](vssgloss-f.md), devem fazer isso.

Se o escritor não puder congelar sua e/s, deverá executar ações para criar uma fonte estável para backup e para reduzir o tempo de recuperação para uma cópia de sombra. Exemplos disso podem incluir o enfileiramento de solicitações de e/s de entrada ou a geração de um conjunto duplicado de arquivos em um [*caminho alternativo*](vssgloss-a.md) a ser usado como a origem de um backup.

O método [**CVssWriter:: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) executa tarefas simples e curtas, como verificar se a e/s esquerda [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) saiu no estado correto e que todas as tarefas assíncronas iniciadas por [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) concluídas. Esse método é a última chance do escritor de vetar uma cópia de sombra se houver problemas (consulte [erros do gravador e vetas](writer-errors-and-vetoes.md)).

Geralmente, é possível que um gravador retome a operação normal após um evento de [*descongelamento*](vssgloss-t.md) : uma cópia de sombra pode não estar imediatamente pronta para backup após descongelar, mas um gravador deve ser capaz de retomar a operação normal. Portanto, normalmente [**CVssWriter:: descongelar**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) é usado por gravadores para retornar a um estado anterior ao congelamento. No entanto, todos os arquivos temporários criados para dar suporte à cópia de sombra devem ser deixados em vigor até o evento de [*pós-instantâneo*](vssgloss-p.md) . Normalmente, você usaria [**CVssWriter:: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) para esse tipo de limpeza. Como muitos aplicativos não exigem esse tipo de limpeza, **CVssWriter:: OnPostSnapshot** é um método virtual com uma implementação padrão que simplesmente retorna **true**. Se um backup incremental ou diferencial estiver sendo executado, o gravador poderá chamar [**IVssComponent:: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) e [**IVssComponent:: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp). Para obter mais informações, consulte [gravador função no backup de repositórios complexos](writer-role-in-backing-up-complex-stores.md). Outro método que pode ser chamado neste momento é [**IVssComponent:: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).

 

 




