---
description: Um provedor de cópia de sombra deve estar em conformidade com as diretrizes para garantir a compatibilidade do solicitante.
ms.assetid: 49baeb89-1dc9-45c2-a532-071085a8e52f
title: Comportamentos necessários para provedores de cópia de sombra
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f451dea7154a313cd64a3a46fbcc3b5fe663ec12
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "105763962"
---
# <a name="required-behaviors-for-shadow-copy-providers"></a><span data-ttu-id="7aa2f-103">Comportamentos necessários para provedores de cópia de sombra</span><span class="sxs-lookup"><span data-stu-id="7aa2f-103">Required Behaviors for Shadow Copy Providers</span></span>

<span data-ttu-id="7aa2f-104">Um provedor de cópia de sombra deve estar em conformidade com as diretrizes para garantir a compatibilidade do solicitante.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-104">A shadow copy provider must conform to guidelines to ensure requester compatibility.</span></span> <span data-ttu-id="7aa2f-105">Em tempo de execução, um aplicativo de backup ou qualquer outro solicitante que use cópias de sombra deve funcionar corretamente sem qualquer conhecimento de detalhes específicos de implementação do provedor.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-105">At runtime, a backup application or any other requester that uses shadow copies must function correctly without any knowledge of specific provider implementation details.</span></span>

## <a name="automagic-resource-management"></a><span data-ttu-id="7aa2f-106">Gerenciamento de recursos automagic</span><span class="sxs-lookup"><span data-stu-id="7aa2f-106">Automagic Resource Management</span></span>

<span data-ttu-id="7aa2f-107">Deve ser possível que o solicitante simplesmente adicione um volume a um conjunto de cópias de sombra.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-107">It must be possible for the requester to simply add a volume to a shadow copy set.</span></span> <span data-ttu-id="7aa2f-108">O solicitante pode especificar atributos de cópia de sombra, como o **VSS \_ VolSnap \_ attr \_ transportável**, **VSS \_ VolSnap \_ attr \_ diferencial** e/ou o **Plex de atributo de VolSnap do VSS \_ \_ \_** no [**\_ \_ \_ contexto de instantâneo do VSS**](/windows/desktop/api/Vss/ne-vss-vss_snapshot_context).</span><span class="sxs-lookup"><span data-stu-id="7aa2f-108">The requester can specify shadow copy attributes such as **VSS\_VOLSNAP\_ATTR\_TRANSPORTABLE**, **VSS\_VOLSNAP\_ATTR\_DIFFERENTIAL**, and/or **VSS\_VOLSNAP\_ATTR\_PLEX** in the [**\_VSS\_SNAPSHOT\_CONTEXT**](/windows/desktop/api/Vss/ne-vss-vss_snapshot_context).</span></span> <span data-ttu-id="7aa2f-109">O provedor deve respeitar esses atributos.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-109">The provider must honor those attributes.</span></span> <span data-ttu-id="7aa2f-110">Se ele não puder honrar esses atributos, ele deverá indicar que o conjunto de cópias de sombra não tem suporte definindo \* *PbIsSupported* em [**IVssHardwareSnapshotProvider:: AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) como **false**.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-110">If it cannot honor those attributes, then it should indicate that the shadow copy set is unsupported by setting the \**pbIsSupported* in [**IVssHardwareSnapshotProvider::AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) to **FALSE**.</span></span>

<span data-ttu-id="7aa2f-111">O provedor nunca deve concordar em dar suporte a uma cópia de sombra que não pode ser criada.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-111">The provider must never agree to support a shadow copy that it cannot create.</span></span> <span data-ttu-id="7aa2f-112">Se o solicitante não especificar um atributo de plex ou diferencial, o provedor deverá incluir a lógica de automagic para alocar o espaço do subsistema para a cópia de sombra e criar a cópia de sombra usando o método mais apropriado.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-112">If the requester does not specify a plex or differential attribute, the provider must include automagic logic for allocating subsystem space for the shadow copy and create the shadow copy using the most appropriate method.</span></span> <span data-ttu-id="7aa2f-113">O provedor de hardware não deve incluir uma API específica do provedor para gerenciar as propriedades de cópia de sombra necessárias.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-113">The hardware provider must not include a provider-specific API for managing required shadow copy properties.</span></span>

## <a name="created-shadow-copy-volumes-are-read-only-and-hidden"></a><span data-ttu-id="7aa2f-114">Os volumes de cópia de sombra criados são Read-Only e ocultos</span><span class="sxs-lookup"><span data-stu-id="7aa2f-114">Created Shadow Copy Volumes Are Read-Only and Hidden</span></span>

<span data-ttu-id="7aa2f-115">O VSS define os sinalizadores em cada LUN afetado, de modo que os volumes de cópia de sombra resultantes serão ocultos e somente leitura quando detectados por um computador que executa o Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-115">VSS sets flags on each affected LUN such that the resulting shadow copy volumes will be hidden and read-only when detected by a computer running Windows Server 2003.</span></span> <span data-ttu-id="7aa2f-116">Letras de unidade e pastas montadas não são atribuídas automaticamente.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-116">Drive letters and mounted folders are not automatically assigned.</span></span> <span data-ttu-id="7aa2f-117">O VSS mantém esses sinalizadores durante todo o ciclo de vida de uma cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-117">VSS maintains these flags throughout the life cycle of a shadow copy.</span></span>

## <a name="hardware-shadow-copy-luns-must-be-readwrite"></a><span data-ttu-id="7aa2f-118">LUNs de cópia de sombra de hardware devem ser de leitura/gravação</span><span class="sxs-lookup"><span data-stu-id="7aa2f-118">Hardware Shadow Copy LUNs Must Be Read/Write</span></span>

<span data-ttu-id="7aa2f-119">O VSS dá suporte a cópias de sombra de hardware somente quando o LUN subjacente é mapeado como leitura/gravação.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-119">VSS supports hardware shadow copies only where the underlying LUN is mapped as read/write.</span></span> <span data-ttu-id="7aa2f-120">Isso deve ser feito antes que a cópia de sombra seja criada; Isso não pode ser feito após o fato.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-120">This must be done before the shadow copy is created; it cannot be done after the fact.</span></span> <span data-ttu-id="7aa2f-121">Os provedores de hardware não devem modificar esses sinalizadores.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-121">Hardware providers should not modify these flags.</span></span> <span data-ttu-id="7aa2f-122">Para obter mais informações sobre como o VSS usa esses sinalizadores, consulte [o processo de criação de cópia de sombra](the-shadow-copy-creation-process.md).</span><span class="sxs-lookup"><span data-stu-id="7aa2f-122">For more information about how VSS uses these flags, see [The Shadow Copy Creation Process](the-shadow-copy-creation-process.md).</span></span>

## <a name="auto-import-hardware-shadow-copies-are-not-supported-on-windows-cluster-service"></a><span data-ttu-id="7aa2f-123">Não há suporte para a importação automática de cópias de sombra de hardware no serviço de cluster do Windows</span><span class="sxs-lookup"><span data-stu-id="7aa2f-123">Auto-Import Hardware Shadow Copies Are Not Supported on Windows Cluster Service</span></span>

<span data-ttu-id="7aa2f-124">O Windows Serviço de cluster não pode acomodar LUNs com assinaturas duplicadas e layout de partição.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-124">Windows Cluster service cannot accommodate LUNs with duplicate signatures and partition layout.</span></span> <span data-ttu-id="7aa2f-125">Os LUNs de cópia de sombra devem ser transportados para um host fora do cluster.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-125">The shadow copy LUNs must be transported to a host outside the cluster.</span></span> <span data-ttu-id="7aa2f-126">Para obter mais informações, consulte [recuperação rápida usando volumes copiados de sombra transportável](fast-recovery-using-transportable-shadow-copied-volumes.md).</span><span class="sxs-lookup"><span data-stu-id="7aa2f-126">For more information, see [Fast Recovery Using Transportable Shadow Copied Volumes](fast-recovery-using-transportable-shadow-copied-volumes.md).</span></span>

## <a name="shadow-copies-that-contain-dynamic-disks-must-be-transported-to-a-different-host"></a><span data-ttu-id="7aa2f-127">As cópias de sombra que contêm discos dinâmicos devem ser transportadas para um host diferente</span><span class="sxs-lookup"><span data-stu-id="7aa2f-127">Shadow Copies That Contain Dynamic Disks Must Be Transported to a Different Host</span></span>

<span data-ttu-id="7aa2f-128">**Antes do Windows Server 2008:** O suporte nativo para discos dinâmicos não pode acomodar LUNs com assinaturas duplicadas e conteúdo de banco de dados de configuração.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-128">**Prior to Windows Server 2008:** The native support for dynamic disks cannot accommodate LUNs with duplicate signatures and configuration database contents.</span></span> <span data-ttu-id="7aa2f-129">Os LUNs de cópia de sombra devem ser transportados para um host diferente.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-129">The shadow copy LUNs must be transported to a different host.</span></span> <span data-ttu-id="7aa2f-130">O VSS impõe isso por não permitir cópias de sombra de discos dinâmicos de importação automática.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-130">VSS enforces this by not allowing auto-import shadow copies of dynamic disks.</span></span> <span data-ttu-id="7aa2f-131">Um solicitante não deve importar uma cópia de sombra transportável de volta para o mesmo host.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-131">A requester should not import a transportable shadow copy back to the same host.</span></span>

<span data-ttu-id="7aa2f-132">**A partir do Windows Server 2008:** Essa limitação é removida.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-132">**Beginning with Windows Server 2008:** This limitation is removed.</span></span>

## <a name="providers-are-out-of-process"></a><span data-ttu-id="7aa2f-133">Os provedores estão fora do processo</span><span class="sxs-lookup"><span data-stu-id="7aa2f-133">Providers Are Out-of-Process</span></span>

<span data-ttu-id="7aa2f-134">Todos os provedores devem ser implementados como componentes COM fora do processo.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-134">All providers must be implemented as out-of-process COM components.</span></span>

## <a name="time-critical-operations"></a><span data-ttu-id="7aa2f-135">Operações de Time-Critical</span><span class="sxs-lookup"><span data-stu-id="7aa2f-135">Time-Critical Operations</span></span>

<span data-ttu-id="7aa2f-136">Operações longas, como a sincronização de plexes, devem ser iniciadas em [**IVssHardwareSnapshotProvider:: BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot).</span><span class="sxs-lookup"><span data-stu-id="7aa2f-136">Long operations, such as syncing plexes, should be initiated in [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot).</span></span> <span data-ttu-id="7aa2f-137">Essa função deve iniciar o trabalho de preparação assíncrona e retornar rapidamente.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-137">This function should start the asynchronous preparation work and return quickly.</span></span> <span data-ttu-id="7aa2f-138">[**IVssProviderCreateSnapshotSet:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) serve como uma função de "reunião" — o provedor pode esperar de forma síncrona nesse método para a conclusão do trabalho de preparação que foi iniciado pelo **BeginPrepareSnapshot**.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-138">[**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) serves as a "rendezvous" function—the provider can wait synchronously in this method for the completion of the preparation work that was started by **BeginPrepareSnapshot**.</span></span>

<span data-ttu-id="7aa2f-139">Os provedores não devem adicionar atrasos em [**IVssProviderCreateSnapshotSet::P recommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**IVssProviderCreateSnapshotSet:: CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)ou [**IVssProviderCreateSnapshotSet::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) , pois os aplicativos são congelado durante essas chamadas.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-139">Providers must not add delays in [**IVssProviderCreateSnapshotSet::PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**IVssProviderCreateSnapshotSet::CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), or [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) as applications are frozen during these calls.</span></span> <span data-ttu-id="7aa2f-140">**CommitSnapshots** deve retornar em segundos, porque isso é chamado durante a janela de liberação e espera, e o suporte ao kernel do VSS cancelará a liberação e a espera se a versão não for recebida em 10 segundos, o que faria com que o VSS falhasse no processo de criação da cópia de sombra.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-140">**CommitSnapshots** should return within seconds, because this is called during the Flush and Hold window, and VSS Kernel Support will cancel the Flush and Hold if the release is not received within 10 seconds, which would cause VSS to fail the shadow copy creation process.</span></span> <span data-ttu-id="7aa2f-141">Se o provedor levar mais de alguns segundos para concluir essa chamada, haverá uma alta probabilidade de que a criação da cópia de sombra falhe.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-141">If the provider takes more than a few seconds to complete this call, there is a high probability that the shadow copy creation will fail.</span></span>

## <a name="careful-io-during-commitsnapshots"></a><span data-ttu-id="7aa2f-142">E/s cuidadosa durante CommitSnapshots</span><span class="sxs-lookup"><span data-stu-id="7aa2f-142">Careful I/O During CommitSnapshots</span></span>

<span data-ttu-id="7aa2f-143">Os provedores de hardware não devem precisar fazer nenhuma e/s para os volumes envolvidos na cópia de sombra durante o [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots).</span><span class="sxs-lookup"><span data-stu-id="7aa2f-143">Hardware providers should not need to do any I/O to the volumes involved in the shadow copy during [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots).</span></span> <span data-ttu-id="7aa2f-144">Se qualquer e/s for necessária, os provedores não deverão iniciar nenhuma e/s para um volume original ao manipular o método **CommitSnapshots** .</span><span class="sxs-lookup"><span data-stu-id="7aa2f-144">If any I/O is required, providers must not initiate any I/O to an original volume while handling the **CommitSnapshots** method.</span></span>

<span data-ttu-id="7aa2f-145">Durante a [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), os drivers de suporte do kernel do VSS bloqueiam a e/s para os volumes originais que estão sendo copiados em sombra.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-145">During [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), VSS Kernel Support drivers block I/O to the original volumes that are being shadow copied.</span></span> <span data-ttu-id="7aa2f-146">Se o provedor usar e/s síncrona para um volume que está no conjunto de cópias de sombra, essa e/s será bloqueada e o processo de confirmação da cópia de sombra será travado.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-146">If the provider uses synchronous I/O to a volume which is in the shadow copy set, then that I/O will be blocked and the shadow copy commit process will be deadlocked.</span></span> <span data-ttu-id="7aa2f-147">O provedor não deve chamar nenhuma API do Win32 durante o **CommitSnapshots** , pois terá uma alta probabilidade de causar e/s e um deadlock.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-147">The provider should not call any Win32 APIs during **CommitSnapshots** as they will have a high probability of causing I/O and a deadlock.</span></span> <span data-ttu-id="7aa2f-148">O tempo limite de suporte do kernel do VSS interromperá esse deadlock após 10 segundos, mas isso fará com que a criação da cópia de sombra falhe.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-148">The VSS Kernel Support timeout will break this deadlock after 10 seconds, but this will cause the shadow copy creation to fail.</span></span>

<span data-ttu-id="7aa2f-149">Se a e/s precisar ser tentada, ela deve ser executada de forma assíncrona.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-149">If I/O must be attempted, it must be performed asynchronously.</span></span> <span data-ttu-id="7aa2f-150">A e/s não será concluída até que todos os provedores tenham retornado dos seus métodos [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="7aa2f-150">The I/O will not complete until after all providers have returned from their [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods.</span></span> <span data-ttu-id="7aa2f-151">Em geral, é melhor executar essas operações na chamada [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="7aa2f-151">In general, it is better to perform such operations in the [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) call.</span></span>

## <a name="readwrite-shadow-copy-luns"></a><span data-ttu-id="7aa2f-152">Leitura/gravação de LUNs de cópia de sombra</span><span class="sxs-lookup"><span data-stu-id="7aa2f-152">Read/Write Shadow Copy LUNs</span></span>

<span data-ttu-id="7aa2f-153">Nesta versão, o VSS dá suporte apenas a LUNs de cópia de sombra de leitura/gravação, mesmo que os volumes sejam expostos como somente leitura.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-153">In this version, VSS supports only read/write shadow copy LUNs even if the volumes are exposed as read-only.</span></span> <span data-ttu-id="7aa2f-154">O motivo é que o sistema precisa alterar estruturas de dados em disco, como:</span><span class="sxs-lookup"><span data-stu-id="7aa2f-154">The reason is that the system needs to change on-disk data structures such as:</span></span>

-   <span data-ttu-id="7aa2f-155">Assinatura de disco, que muda durante o processo de cópia de sombra</span><span class="sxs-lookup"><span data-stu-id="7aa2f-155">Disk signature, which changes during the shadow copy process</span></span>
-   <span data-ttu-id="7aa2f-156">Estruturas de dados relacionadas à partição, incluindo aquelas indicando que a partição é somente leitura, oculta, uma cópia de sombra e não deve ser atribuída a uma letra de unidade.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-156">Partition-related data structures, including those indicating the partition is read-only, hidden, a shadow copy, and should not be assigned a drive letter.</span></span>

## <a name="unique-page-83-information"></a><span data-ttu-id="7aa2f-157">Informações da página exclusiva 83</span><span class="sxs-lookup"><span data-stu-id="7aa2f-157">Unique Page 83 Information</span></span>

<span data-ttu-id="7aa2f-158">O LUN original e o LUN de cópia de sombra criado recentemente devem ter pelo menos um identificador de armazenamento exclusivo na página dados do 83.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-158">Both the original LUN and the newly created shadow copy LUN must have at least one unique storage identifier in the page 83 data.</span></span> <span data-ttu-id="7aa2f-159">Pelo menos um identificador de armazenamento \_ com um tipo de 1, 2, 3 ou 8 e uma associação de 0 deve ser exclusivo no LUN original e no LUN de cópia de sombra criado recentemente.</span><span class="sxs-lookup"><span data-stu-id="7aa2f-159">At least one STORAGE\_IDENTIFIER with a type of 1, 2, 3, or 8, and an association of 0 must be unique on the original LUN and the newly created shadow copy LUN.</span></span>

 

 



