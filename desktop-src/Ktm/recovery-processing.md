---
description: Após qualquer tipo de falha que interrompa o processamento normal de transações, o KTM e cada Gerenciador de recursos devem executar operações de recuperação. A recuperação é o processo pelo qual os participantes da transação chegam em uma exibição consistente de cada Estado de transações.
ms.assetid: 5bc9a155-6ba4-41f8-8e12-e87f48d83940
title: Processamento de recuperação
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a8e74d4f8bff3e56af03b017522212e7a02e232
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "105796342"
---
# <a name="recovery-processing"></a><span data-ttu-id="446e3-104">Processamento de recuperação</span><span class="sxs-lookup"><span data-stu-id="446e3-104">Recovery Processing</span></span>

<span data-ttu-id="446e3-105">Após qualquer tipo de falha que interrompa o processamento normal de transações, o KTM e cada Gerenciador de recursos devem executar operações de *recuperação* .</span><span class="sxs-lookup"><span data-stu-id="446e3-105">After any type of failure that disrupts normal transaction processing, KTM and each resource manager must perform *recovery* operations.</span></span> <span data-ttu-id="446e3-106">A recuperação é o processo pelo qual os participantes da transação chegam em uma exibição consistente do estado de cada transação.</span><span class="sxs-lookup"><span data-stu-id="446e3-106">Recovery is the process by which transaction participants arrive at a consistent view of each transaction's state.</span></span>

<span data-ttu-id="446e3-107">Os gerenciadores de *recursos podem ser* inoportunos sobre o resultado de uma transação, ou seja, no momento da falha, receberam uma notificação de preparação de notificação de transação \_ , se \_ preparou com o armazenamento durável, mas não havia recebido (ou recebido, mas não registrado) um resultado final para a transação.</span><span class="sxs-lookup"><span data-stu-id="446e3-107">Resource managers may be *in-doubt* about a transaction's outcome, meaning that at the time of failure, they had received a TRANSACTION\_NOTIFY\_PREPARE notification, had prepared to durable storage, but had not received (or received but not logged) a final outcome for the transaction.</span></span> <span data-ttu-id="446e3-108">Da mesma forma, o KTM pode ser incerto sobre uma transação, caso tenha sido preparada, mas não tenha recebido (ou recebido, mas não registrado) um resultado.</span><span class="sxs-lookup"><span data-stu-id="446e3-108">Similarly, KTM can be in-doubt about a transaction if it had been prepared but had not received (or received but not logged) an outcome.</span></span> <span data-ttu-id="446e3-109">No momento da recuperação, todos os resultados enviados, mas não confirmados, devem ser enviados novamente.</span><span class="sxs-lookup"><span data-stu-id="446e3-109">At recovery time, all outcomes that have been sent but not acknowledged must be re-sent.</span></span> <span data-ttu-id="446e3-110">Por exemplo, se um Gerenciador de recursos tiver recebido uma notificação de confirmação de notificação de transação \_ \_ e tiver chamado a função [**COMMITCOMPLETE**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) , o RM ainda poderá receber uma notificação de confirmação de transação duplicada \_ \_ no momento da recuperação.</span><span class="sxs-lookup"><span data-stu-id="446e3-110">For example, if a resource manager received a TRANSACTION\_NOTIFY\_COMMIT notification and called the [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) function, the RM may still receive a duplicate TRANSACTION\_NOTIFY\_COMMIT notification at recovery time.</span></span>

<span data-ttu-id="446e3-111">Para que uma transação seja recuperada corretamente após uma falha do sistema ou do Gerenciador de recursos, cada Gerenciador de recursos deve fazer o seguinte sempre que for iniciado:</span><span class="sxs-lookup"><span data-stu-id="446e3-111">For a transaction to properly recover after a resource manager or system failure, each resource manager must do the following each time it is started:</span></span>

1.  <span data-ttu-id="446e3-112">Chame a função [**OpenResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) para reabrir seu identificador do Gerenciador de recursos usando seu nome exclusivo e persistente.</span><span class="sxs-lookup"><span data-stu-id="446e3-112">Call the [**OpenResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) function to re-open its resource manager handle using its unique, persistent name.</span></span> <span data-ttu-id="446e3-113">Isso informa ao KTM que o Gerenciador de recursos está em execução novamente e está disponível para executar a recuperação.</span><span class="sxs-lookup"><span data-stu-id="446e3-113">This informs KTM that the resource manager is running again and is available to perform recovery.</span></span> <span data-ttu-id="446e3-114">Se não existirem inlistagens a serem recuperadas, a chamada para **OpenResourceManager** poderá falhar.</span><span class="sxs-lookup"><span data-stu-id="446e3-114">If no enlistments exist to be recovered, the call to **OpenResourceManager** can fail.</span></span> <span data-ttu-id="446e3-115">Chame [**CreateResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) para recriar o objeto RM.</span><span class="sxs-lookup"><span data-stu-id="446e3-115">Call [**CreateResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) to re-create the RM object.</span></span>
2.  <span data-ttu-id="446e3-116">Chame [**RecoverResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager).</span><span class="sxs-lookup"><span data-stu-id="446e3-116">Call [**RecoverResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager).</span></span> <span data-ttu-id="446e3-117">O Gerenciador de recursos receberá um evento Notification [**\_ Notification \_**](notification-mask.md) de notificação de recuperação para cada inscrição para a qual precisa realizar operações de recuperação, seguida de uma transação \_ notificar a \_ última \_ recuperação.</span><span class="sxs-lookup"><span data-stu-id="446e3-117">The resource manager will receive a [**TRANSACTION\_NOTIFY\_RECOVER**](notification-mask.md) notification event for each enlistment for which it needs to perform recovery operations, followed by a TRANSACTION\_NOTIFY\_LAST\_RECOVER.</span></span> <span data-ttu-id="446e3-118">O evento de notificação inclui um identificador global exclusivo para a transação e a inscrição.</span><span class="sxs-lookup"><span data-stu-id="446e3-118">The notification event includes a globally unique identifier for both the transaction and the enlistment.</span></span>
3.  <span data-ttu-id="446e3-119">Chame a função [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) para abrir novamente cada identificador de inscrição para o qual o Gerenciador de recursos recebeu uma notificação de recuperação de notificação de transação \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="446e3-119">Call the [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) function to re-open each enlistment handle for which the resource manager received a TRANSACTION\_NOTIFY\_RECOVER notification.</span></span>
4.  <span data-ttu-id="446e3-120">Para cada Inscrição aberta pelo [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), chame [**RecoverEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment).</span><span class="sxs-lookup"><span data-stu-id="446e3-120">For each enlistment opened by [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), call [**RecoverEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment).</span></span> <span data-ttu-id="446e3-121">Isso faz com que a notificação de notificação de confirmação de transação \_ \_ ou de incerteza de transação \_ \_ seja entregue novamente.</span><span class="sxs-lookup"><span data-stu-id="446e3-121">This causes the TRANSACTION\_NOTIFY\_COMMIT or TRANSACTION\_NOTIFY\_INDOUBT notification to be redelivered.</span></span>
5.  <span data-ttu-id="446e3-122">Se o RM recebeu a \_ confirmação de notificação de transação \_ , o RM poderá concluir a transação chamando [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).</span><span class="sxs-lookup"><span data-stu-id="446e3-122">If the RM received TRANSACTION\_NOTIFY\_COMMIT, the RM can complete the transaction by calling [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).</span></span>

    <span data-ttu-id="446e3-123">Se o RM recebeu uma \_ notificação de \_ incerteza de transação, o RM deve aguardar a chegada da notificação de resultado.</span><span class="sxs-lookup"><span data-stu-id="446e3-123">If the RM received TRANSACTION\_NOTIFY\_INDOUBT, the RM should wait for the outcome notification to arrive.</span></span>

6.  <span data-ttu-id="446e3-124">Para todas as transações que o RM não recebe uma notificação de recuperação de notificação de transação \_ \_ , mas anteriormente recebeu uma \_ \_ notificação de preparação de notificação de transação para, o RM deve processar a transação como se fosse revertida.</span><span class="sxs-lookup"><span data-stu-id="446e3-124">For any transactions that the RM does not receive a TRANSACTION\_NOTIFY\_RECOVER notification, but previously received a TRANSACTION\_NOTIFY\_PREPARE notification for, the RM should process the transaction as if it were rolled back.</span></span>

> [!Note]
>
> <span data-ttu-id="446e3-125">Os gerenciadores de recursos têm permissão para inscrever-se ou criar novas transações durante o processo de execução da recuperação.</span><span class="sxs-lookup"><span data-stu-id="446e3-125">Resource managers are allowed to enlist in or create new transactions while in the process of performing recovery.</span></span>

 

<span data-ttu-id="446e3-126">O KTM usa um modelo de transação de *anulação presumido* .</span><span class="sxs-lookup"><span data-stu-id="446e3-126">KTM uses a *presumed abort* transaction model.</span></span> <span data-ttu-id="446e3-127">O cenário a seguir ilustra esse comportamento.</span><span class="sxs-lookup"><span data-stu-id="446e3-127">The following scenario illustrates this behavior.</span></span> <span data-ttu-id="446e3-128">Suponha que o KTM e um Gerenciador de recursos existam no mesmo computador.</span><span class="sxs-lookup"><span data-stu-id="446e3-128">Assume that KTM and an resource manager exist on the same computer.</span></span> <span data-ttu-id="446e3-129">Suponha que o KTM emita uma notificação de preparação para uma transação, mas o sistema falha antes de o KTM registrar a notificação de preparação.</span><span class="sxs-lookup"><span data-stu-id="446e3-129">Suppose KTM issues a prepare notification for a transaction, but the system crashes before KTM logs the prepare notification.</span></span> <span data-ttu-id="446e3-130">Suponha ainda que o Gerenciador de recursos receba e registre a notificação de preparação imediatamente antes do sistema falhar.</span><span class="sxs-lookup"><span data-stu-id="446e3-130">Further suppose that the resource manager receives and logs the prepare notification just before the system crashes.</span></span> <span data-ttu-id="446e3-131">Depois que o sistema é restaurado, o KTM não tem conhecimento da transação, porque ele nunca registrou a fase de preparação.</span><span class="sxs-lookup"><span data-stu-id="446e3-131">After the system is restored, KTM has no knowledge of the transaction, because it never logged the prepare phase.</span></span> <span data-ttu-id="446e3-132">O Gerenciador de recursos tem conhecimento da transação, pois recebeu, processou e registrou a notificação de preparação.</span><span class="sxs-lookup"><span data-stu-id="446e3-132">The resource manager has knowledge of the transaction, because it received, processed, and logged the prepare notification.</span></span> <span data-ttu-id="446e3-133">Quando o KTM emite suas notificações de recuperação, o Gerenciador de recursos não inclui uma notificação de recuperação para a transação em questão.</span><span class="sxs-lookup"><span data-stu-id="446e3-133">When KTM issues its recovery notifications, the resource manager does not include a recovery notification for the transaction in question.</span></span> <span data-ttu-id="446e3-134">Com o modelo de anulação presumido, o Gerenciador de recursos, nesse caso, tratará a transação preparada como anulada quando não receber notificações para executar a recuperação nessa transação.</span><span class="sxs-lookup"><span data-stu-id="446e3-134">With the presumed abort model, the resource manager in this case will treat the prepared transaction as aborted when it does not receive notifications to perform recovery on that transaction.</span></span>

 

 



