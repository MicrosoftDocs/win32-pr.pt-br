---
description: Quando você tem um aplicativo Microsoft Direct3D funcional e deseja melhorar seu desempenho, geralmente usa uma ferramenta de criação de perfil de prateleira ou alguma técnica de medida personalizada para medir o tempo necessário para executar uma ou mais chamadas de API (interface de programação de aplicativo). Se você tiver feito isso, mas estiver obtendo resultados de tempo que variam de uma sequência de renderização para a próxima, ou se estiver fazendo alterações que não contenham resultados reais de experimento, as informações a seguir poderão ajudá-lo a entender o porquê.
ms.assetid: f969be42-d541-4e8d-aec4-eb9508bcc7cf
title: Criação de perfil de chamadas à API do Direct3D com precisão (Direct3D 9)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: cdb6d60fcc1b3ace4112dbf7028d91e2c9c8b345
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103646459"
---
# <a name="accurately-profiling-direct3d-api-calls-direct3d-9"></a><span data-ttu-id="5d96c-104">Criação de perfil de chamadas à API do Direct3D com precisão (Direct3D 9)</span><span class="sxs-lookup"><span data-stu-id="5d96c-104">Accurately Profiling Direct3D API Calls (Direct3D 9)</span></span>

-   [<span data-ttu-id="5d96c-105">A criação de perfil de Direct3D com precisão é difícil</span><span class="sxs-lookup"><span data-stu-id="5d96c-105">Accurately Profiling Direct3D Is Difficult</span></span>](#accurately-profiling-direct3d-is-difficult)
-   [<span data-ttu-id="5d96c-106">Como criar um perfil com precisão de uma sequência de renderização do Direct3D</span><span class="sxs-lookup"><span data-stu-id="5d96c-106">How to Accurately Profile a Direct3D Render Sequence</span></span>](#how-to-accurately-profile-a-direct3d-render-sequence)
-   [<span data-ttu-id="5d96c-107">Criando perfil de alterações de estado do Direct3D</span><span class="sxs-lookup"><span data-stu-id="5d96c-107">Profiling Direct3D State Changes</span></span>](#profiling-direct3d-state-changes)
-   [<span data-ttu-id="5d96c-108">Resumo</span><span class="sxs-lookup"><span data-stu-id="5d96c-108">Summary</span></span>](#summary)
-   [<span data-ttu-id="5d96c-109">Anexo</span><span class="sxs-lookup"><span data-stu-id="5d96c-109">Appendix</span></span>](#appendix)

<span data-ttu-id="5d96c-110">Quando você tem um aplicativo Microsoft Direct3D funcional e deseja melhorar seu desempenho, geralmente usa uma ferramenta de criação de perfil de prateleira ou alguma técnica de medida personalizada para medir o tempo necessário para executar uma ou mais chamadas de API (interface de programação de aplicativo).</span><span class="sxs-lookup"><span data-stu-id="5d96c-110">Once you have a functional Microsoft Direct3D application and you want to improve its performance, you generally use an off-the-shelf profiling tool or some custom measurement technique to measure the time it takes to execute one or more application programming interface (API) calls.</span></span> <span data-ttu-id="5d96c-111">Se você tiver feito isso, mas estiver obtendo resultados de tempo que variam de uma sequência de renderização para a próxima, ou se estiver fazendo alterações que não contenham resultados reais de experimento, as informações a seguir poderão ajudá-lo a entender o porquê.</span><span class="sxs-lookup"><span data-stu-id="5d96c-111">If you have done this but are getting timing results that vary from one render sequence to the next, or you are making hypotheses that do not hold up to actual experiment results, the following information may help you to understand why.</span></span>

<span data-ttu-id="5d96c-112">As informações fornecidas aqui se baseiam na suposição de que você tem conhecimento e experiência com o seguinte:</span><span class="sxs-lookup"><span data-stu-id="5d96c-112">The information provided here is based upon the assumption that you have knowledge of and experience with the following:</span></span>

-   <span data-ttu-id="5d96c-113">Programação C/C++</span><span class="sxs-lookup"><span data-stu-id="5d96c-113">C/C++ programming</span></span>
-   <span data-ttu-id="5d96c-114">Programação de API do Direct3D</span><span class="sxs-lookup"><span data-stu-id="5d96c-114">Direct3D API programming</span></span>
-   <span data-ttu-id="5d96c-115">Medindo o tempo da API</span><span class="sxs-lookup"><span data-stu-id="5d96c-115">Measuring API timing</span></span>
-   <span data-ttu-id="5d96c-116">A placa de vídeo e seu driver de software</span><span class="sxs-lookup"><span data-stu-id="5d96c-116">The video card and its software driver</span></span>
-   <span data-ttu-id="5d96c-117">Possíveis resultados não explicativos da experiência de criação de perfil anterior</span><span class="sxs-lookup"><span data-stu-id="5d96c-117">Possible unexplainable results from previous profiling experience</span></span>

## <a name="accurately-profiling-direct3d-is-difficult"></a><span data-ttu-id="5d96c-118">A criação de perfil de Direct3D com precisão é difícil</span><span class="sxs-lookup"><span data-stu-id="5d96c-118">Accurately Profiling Direct3D Is Difficult</span></span>

<span data-ttu-id="5d96c-119">Um criador de perfil relata a quantidade de tempo gasto em cada chamada à API.</span><span class="sxs-lookup"><span data-stu-id="5d96c-119">A profiler reports on the amount of time spent in each API call.</span></span> <span data-ttu-id="5d96c-120">Isso é feito para melhorar o desempenho, encontrando e ajustando pontos de acesso distantes.</span><span class="sxs-lookup"><span data-stu-id="5d96c-120">This is done to improve performance by finding and tuning away hot spots.</span></span> <span data-ttu-id="5d96c-121">Há diferentes tipos de perfis e técnicas de criação de perfil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-121">There are different kinds of profilers and profiling techniques.</span></span>

-   <span data-ttu-id="5d96c-122">Um criador de perfil de amostragem fica ocioso muito do tempo, despertando em intervalos específicos para exemplo (ou para registrar) as funções que estão sendo executadas.</span><span class="sxs-lookup"><span data-stu-id="5d96c-122">A sampling profiler sits idle much of the time, awakening at specific intervals to sample (or to record) the functions being executed.</span></span> <span data-ttu-id="5d96c-123">Ele retorna a porcentagem de tempo gasto em cada chamada.</span><span class="sxs-lookup"><span data-stu-id="5d96c-123">It returns the percentage of time spent in each call.</span></span> <span data-ttu-id="5d96c-124">Geralmente, um gerador de perfil de amostragem não é muito invasivo para o aplicativo e tem um impacto mínimo sobre a sobrecarga do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-124">Generally, a sampling profiler is not very invasive to the application and has minimal impact on the overhead for the application.</span></span>
-   <span data-ttu-id="5d96c-125">Um criador de perfil de instrumentação mede o tempo real que leva para uma chamada para retornar.</span><span class="sxs-lookup"><span data-stu-id="5d96c-125">An instrumenting profiler measures the actual time it takes for a call to return.</span></span> <span data-ttu-id="5d96c-126">Ele requer a compilação de delimitadores de início e parada em um aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-126">It requires compiling start and stop delimiters into an application.</span></span> <span data-ttu-id="5d96c-127">Um criador de perfil de instrumentação é comparativamente mais invasivo para um aplicativo do que um criador de perfil de amostragem.</span><span class="sxs-lookup"><span data-stu-id="5d96c-127">An instrumenting profiler is comparatively more invasive to an application than a sampling profiler.</span></span>
-   <span data-ttu-id="5d96c-128">Também é possível usar uma técnica de criação de perfil Personalizada com um timer de alto desempenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-128">It is also possible to use a custom profiling technique with a high-performance timer.</span></span> <span data-ttu-id="5d96c-129">Isso produz resultados muito parecidos com um criador de perfil de instrumentação.</span><span class="sxs-lookup"><span data-stu-id="5d96c-129">This produces results very much like an instrumenting profiler.</span></span>

<span data-ttu-id="5d96c-130">O tipo de criador de perfil ou a técnica de criação de perfil usada é apenas parte do desafio de gerar medidas precisas.</span><span class="sxs-lookup"><span data-stu-id="5d96c-130">The type of profiler or profiling technique used is only part of the challenge of generating accurate measurements.</span></span>

<span data-ttu-id="5d96c-131">A criação de perfil fornece respostas que ajudam você a orçar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-131">Profiling gives you answers that help you budget performance.</span></span> <span data-ttu-id="5d96c-132">Por exemplo, suponha que você saiba que uma chamada à API calcula a média de 1000 ciclos de relógio a serem executados.</span><span class="sxs-lookup"><span data-stu-id="5d96c-132">For instance, suppose you know that an API call averages one thousand clock cycles to execute.</span></span> <span data-ttu-id="5d96c-133">Você pode declarar algumas conclusões sobre o desempenho, como o seguinte:</span><span class="sxs-lookup"><span data-stu-id="5d96c-133">You can assert some conclusions about performance such as the following:</span></span>

-   <span data-ttu-id="5d96c-134">Uma CPU de 2 GHz (que passa 50% de seu tempo de renderização) é limitada a chamar essa API 1 milhão vezes por segundo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-134">A 2 GHz CPU (which spends 50 percent of its time rendering) is limited to calling this API 1 million times a second.</span></span>
-   <span data-ttu-id="5d96c-135">Para obter 30 quadros por segundo, você não pode chamar essa API mais de 33.000 vezes por quadro.</span><span class="sxs-lookup"><span data-stu-id="5d96c-135">To achieve 30 frames per second, you cannot call this API more than 33,000 times per frame.</span></span>
-   <span data-ttu-id="5d96c-136">Você só pode renderizar 3,3 K Objects por quadro (supondo que 10 dessas chamadas de API para a sequência de renderização de cada objeto).</span><span class="sxs-lookup"><span data-stu-id="5d96c-136">You can only render 3.3K objects per frame (assuming 10 of these API calls for each object's render sequence).</span></span>

<span data-ttu-id="5d96c-137">Em outras palavras, se você tiver tempo suficiente por chamada à API, poderá responder a uma pergunta de orçamento, como o número de primitivos que podem ser renderizados interativamente.</span><span class="sxs-lookup"><span data-stu-id="5d96c-137">In other words, if you had sufficient time per API call, you could answer a budgeting question such as the number of primitives that can be rendered interactively.</span></span> <span data-ttu-id="5d96c-138">Mas os números brutos retornados por um criador de perfil de instrumentação não responderão com precisão às perguntas de orçamento.</span><span class="sxs-lookup"><span data-stu-id="5d96c-138">But the raw numbers returned by an instrumenting profiler will not accurately answer the budgeting questions.</span></span> <span data-ttu-id="5d96c-139">Isso ocorre porque o pipeline de gráficos tem problemas de design complexos, como o número de componentes que precisam de trabalho, o número de processadores que controlam como o trabalho flui entre componentes e estratégias de otimização implementados no tempo de execução e em um driver que são projetados para tornar o pipeline mais eficiente.</span><span class="sxs-lookup"><span data-stu-id="5d96c-139">This is because the graphics pipeline has complex design issues such as the number of components that need to do work, the number of processors that control how the work flows between components, and optimization strategies implemented in the runtime and in a driver that are designed to make the pipeline more efficient.</span></span>

### <a name="each-api-call-goes-through-several-components"></a><span data-ttu-id="5d96c-140">Cada chamada à API passa por vários componentes</span><span class="sxs-lookup"><span data-stu-id="5d96c-140">Each API Call Goes through Several Components</span></span>

<span data-ttu-id="5d96c-141">Cada chamada é processada por vários componentes do seu caminho a partir do aplicativo até a placa de vídeo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-141">Each call is processed by several components on its way from the application to the video card.</span></span> <span data-ttu-id="5d96c-142">Por exemplo, considere a seguinte sequência de renderização que contém duas chamadas para desenhar um único triângulo:</span><span class="sxs-lookup"><span data-stu-id="5d96c-142">For instance, consider the following render sequence containing two calls for drawing a single triangle:</span></span>


```
SetTexture(...);
DrawPrimitive(D3DPT_TRIANGLELIST, 0, 1);
```



<span data-ttu-id="5d96c-143">O diagrama conceitual a seguir mostra os diferentes componentes por meio dos quais as chamadas devem ser aprovadas.</span><span class="sxs-lookup"><span data-stu-id="5d96c-143">The following conceptual diagram shows the different components through which the calls must pass.</span></span>

![diagrama de componentes gráficos que as chamadas de API passam](images/microbenchmarkinstructionflow2.png)

<span data-ttu-id="5d96c-145">O aplicativo invoca o Direct3D, que controla a cena, manipula as interações do usuário e determina como a renderização é feita.</span><span class="sxs-lookup"><span data-stu-id="5d96c-145">The application invokes Direct3D which controls the scene, handles user interactions, and determines how rendering is done.</span></span> <span data-ttu-id="5d96c-146">Todo esse trabalho é especificado na sequência de renderização, que é enviada para o tempo de execução usando chamadas de API do Direct3D.</span><span class="sxs-lookup"><span data-stu-id="5d96c-146">All of this work is specified in the render sequence, which is sent to the runtime using Direct3D API calls.</span></span> <span data-ttu-id="5d96c-147">A sequência de renderização é praticamente independente de hardware (ou seja, as chamadas à API são independentes de hardware, mas um aplicativo tem conhecimento de quais recursos uma placa de vídeo suporta).</span><span class="sxs-lookup"><span data-stu-id="5d96c-147">The render sequence is virtually hardware independent (that is, the API calls are hardware independent but an application has knowledge of what features a video card supports).</span></span>

<span data-ttu-id="5d96c-148">O tempo de execução converte essas chamadas em um formato independente de dispositivo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-148">The runtime converts these calls into a device-independent format.</span></span> <span data-ttu-id="5d96c-149">O tempo de execução manipula toda a comunicação entre o aplicativo e o driver, para que um aplicativo seja executado em mais de uma parte de hardware compatível (dependendo dos recursos necessários).</span><span class="sxs-lookup"><span data-stu-id="5d96c-149">The runtime handles all the communication between the application and the driver, so that an application will run on more than one compatible piece of hardware (depending on the features required).</span></span> <span data-ttu-id="5d96c-150">Ao medir uma chamada de função, um criador de perfil de instrumentação mede o tempo gasto em uma função, bem como o tempo de retorno da função.</span><span class="sxs-lookup"><span data-stu-id="5d96c-150">When measuring a function call, an instrumenting profiler measures the time it spent in a function as well as the time for the function to return.</span></span> <span data-ttu-id="5d96c-151">Uma limitação de um criador de perfil de instrumentação é que ele pode não incluir o tempo que leva um driver para enviar o trabalho resultante para a placa de vídeo nem a hora de o cartão de vídeo processar o trabalho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-151">One limitation of an instrumenting profiler is that it may not include the time it takes a driver to send the resulting work to the video card nor the time for the video card to process the work.</span></span> <span data-ttu-id="5d96c-152">Em outras palavras, um criador de perfil de instrumentação fora do mercado falha ao atribuir todo o trabalho associado a cada chamada de função.</span><span class="sxs-lookup"><span data-stu-id="5d96c-152">In other words, an off-the-shelf instrumenting profiler fails to attribute all of the work associated with each function call.</span></span>

<span data-ttu-id="5d96c-153">O driver de software usa conhecimento específico de hardware sobre a placa de vídeo para converter os comandos independentes de dispositivo em uma sequência de comandos de placa de vídeo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-153">The software driver uses hardware specific knowledge about the video card to convert the device-independent commands into a sequence of video card commands.</span></span> <span data-ttu-id="5d96c-154">Os drivers também podem otimizar a sequência de comandos que são enviados para a placa de vídeo, de modo que a renderização na placa de vídeo seja feita com eficiência.</span><span class="sxs-lookup"><span data-stu-id="5d96c-154">Drivers may also optimize the sequence of commands that are sent to the video card, so that rendering on the video card is done efficiently.</span></span> <span data-ttu-id="5d96c-155">Essas otimizações podem causar problemas de criação de perfil porque a quantidade de trabalho realizado não é o que parece ser (talvez você precise entender as otimizações para se considerar).</span><span class="sxs-lookup"><span data-stu-id="5d96c-155">These optimizations can cause profiling problems because the amount of work done is not what it appears to be (you may need to understand the optimizations to account for them).</span></span> <span data-ttu-id="5d96c-156">O driver normalmente retorna o controle ao tempo de execução antes que a placa de vídeo termine de processar todos os comandos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-156">The driver typically returns control to the runtime before the video card has finished processing all the commands.</span></span>

<span data-ttu-id="5d96c-157">A placa de vídeo executa a maioria da renderização combinando dados do vértice e buffers de índice, texturas, informações de estado de renderização e comandos gráficos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-157">The video card performs the majority of the rendering by combining data from the vertex and index buffers, textures, render state information, and the graphics commands.</span></span> <span data-ttu-id="5d96c-158">Quando a placa de vídeo termina a renderização, o trabalho criado a partir da sequência de renderização é concluído.</span><span class="sxs-lookup"><span data-stu-id="5d96c-158">When the video card finishes rendering, the work created from the render sequence is complete.</span></span>

<span data-ttu-id="5d96c-159">Cada chamada à API do Direct3D deve ser processada por cada componente (tempo de execução, Driver e placa de vídeo) para renderizar qualquer coisa.</span><span class="sxs-lookup"><span data-stu-id="5d96c-159">Each Direct3D API call must be processed by each component (the runtime, the driver, and the video card) to render anything.</span></span>

### <a name="there-is-more-than-one-processor-controlling-the-components"></a><span data-ttu-id="5d96c-160">Há mais de um processador controlando os componentes</span><span class="sxs-lookup"><span data-stu-id="5d96c-160">There Is More than One Processor Controlling the Components</span></span>

<span data-ttu-id="5d96c-161">A relação entre esses componentes é ainda mais complexa, pois o aplicativo, o tempo de execução e o driver são controlados por um processador e a placa de vídeo é controlada por um processador separado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-161">The relationship between these components is even more complex, because the application, runtime, and the driver are controlled by one processor and the video card is controlled by a separate processor.</span></span> <span data-ttu-id="5d96c-162">O diagrama a seguir mostra dois tipos de processadores: uma CPU (unidade de processamento central) e uma GPU (unidade de processamento gráfico).</span><span class="sxs-lookup"><span data-stu-id="5d96c-162">The following diagram shows two kinds of processors: a central processing unit (CPU) and a graphics processing unit (GPU).</span></span>

![diagrama de CPU e de uma GPU e seus componentes](images/microbenchmarkprocessors.png)

<span data-ttu-id="5d96c-164">Os sistemas de PC têm pelo menos uma CPU e uma GPU, mas podem ter mais de um ou ambos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-164">PC systems have at least one CPU and one GPU, but can have more than one of either or both.</span></span> <span data-ttu-id="5d96c-165">As CPUs estão localizadas na placa-mãe e as GPUs estão localizadas na placa-mãe ou na placa de vídeo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-165">The CPUs are located on the motherboard, and the GPUs are located either on the motherboard or on the video card.</span></span> <span data-ttu-id="5d96c-166">A velocidade da CPU é determinada por um chip de relógio na placa-mãe, e a velocidade da GPU é determinada por um chip de relógio separado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-166">The speed of the CPU is determined by a clock chip on the motherboard, and the speed of the GPU is determined by a separate clock chip.</span></span> <span data-ttu-id="5d96c-167">O relógio da CPU controla a velocidade do trabalho feito pelo aplicativo, o tempo de execução e o driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-167">The CPU clock controls the speed of the work done by the application, the runtime, and the driver.</span></span> <span data-ttu-id="5d96c-168">O aplicativo envia o trabalho para a GPU por meio do tempo de execução e do driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-168">The application sends work to the GPU via the runtime and the driver.</span></span>

<span data-ttu-id="5d96c-169">A CPU e a GPU geralmente são executadas em diferentes velocidades, independentes umas das outras.</span><span class="sxs-lookup"><span data-stu-id="5d96c-169">The CPU and the GPU generally run at different speeds, independent of one another.</span></span> <span data-ttu-id="5d96c-170">A GPU pode responder ao trabalho assim que o trabalho estiver disponível (supondo que a GPU concluiu o processamento do trabalho anterior).</span><span class="sxs-lookup"><span data-stu-id="5d96c-170">The GPU may respond to the work as soon as the work is available (assuming the GPU has finished processing previous work).</span></span> <span data-ttu-id="5d96c-171">O trabalho de GPU é feito em paralelo com o trabalho de CPU como realçado pela linha curva na figura acima.</span><span class="sxs-lookup"><span data-stu-id="5d96c-171">The GPU work is done in parallel with the CPU work as highlighted by the curved line in the figure above.</span></span> <span data-ttu-id="5d96c-172">Um criador de perfil geralmente mede o desempenho da CPU, não da GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-172">A profiler generally measures the performance of the CPU, not the GPU.</span></span> <span data-ttu-id="5d96c-173">Isso torna o perfil desafiador, pois as medições feitas por um criador de perfil de instrumentação incluem o tempo de CPU, mas podem não incluir a hora da GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-173">This makes profiling challenging, because the measurements made by an instrumenting profiler include the CPU time but may not include the GPU time.</span></span>

<span data-ttu-id="5d96c-174">A finalidade da GPU é o processamento off-load da CPU para um processador especificamente projetado para o trabalho de gráficos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-174">The purpose of the GPU is to off-load processing from the CPU to a processor specifically designed for graphics work.</span></span> <span data-ttu-id="5d96c-175">Em placas de vídeo modernas, a GPU substitui grande parte do trabalho de transformação e iluminação no pipeline da CPU para a GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-175">On modern video cards, the GPU replaces much of the transform and lighting work in the pipeline from the CPU to the GPU.</span></span> <span data-ttu-id="5d96c-176">Isso reduz significativamente a carga de trabalho da CPU, deixando mais ciclos de CPU disponíveis para outro processamento.</span><span class="sxs-lookup"><span data-stu-id="5d96c-176">This greatly reduces the CPU workload, leaving more CPU cycles available for other processing.</span></span> <span data-ttu-id="5d96c-177">Para ajustar um aplicativo gráfico para o máximo de desempenho, você precisa medir o desempenho da CPU e da GPU e equilibrar o trabalho entre os dois tipos de processadores.</span><span class="sxs-lookup"><span data-stu-id="5d96c-177">To tune a graphical application for peak performance, you need to measure the performance of both the CPU and the GPU, and balance the work between the two types of processors.</span></span>

<span data-ttu-id="5d96c-178">Este documento não aborda os tópicos relacionados à medição do desempenho da GPU ou ao balanceamento do trabalho entre a CPU e a GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-178">This document does not cover topics related to measuring the performance of the GPU or balancing the work between the CPU and the GPU.</span></span> <span data-ttu-id="5d96c-179">Se você quiser entender melhor o desempenho de uma GPU (ou uma placa de vídeo específica), visite o site do fornecedor para procurar mais informações sobre o desempenho da GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-179">If you want to better understand the performance of a GPU (or a particular video card), visit the vendor's web site to look for more information about GPU performance.</span></span> <span data-ttu-id="5d96c-180">Em vez disso, este documento se concentra no trabalho feito pelo tempo de execução e pelo driver, reduzindo o trabalho da GPU a um valor insignificante.</span><span class="sxs-lookup"><span data-stu-id="5d96c-180">Instead, this document focuses on the work done by the runtime and the driver by reducing the GPU work to a negligible amount.</span></span> <span data-ttu-id="5d96c-181">Isso é, em parte, baseado na experiência que os aplicativos que apresentam problemas de desempenho geralmente são limitados por CPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-181">This is, in part, based on experience that applications experiencing performance problems are generally CPU-limited.</span></span>

### <a name="runtime-and-driver-optimizations-can-mask-api-measurements"></a><span data-ttu-id="5d96c-182">Otimizações de driver e tempo de execução podem mascarar medidas de API</span><span class="sxs-lookup"><span data-stu-id="5d96c-182">Runtime and Driver Optimizations Can Mask API Measurements</span></span>

<span data-ttu-id="5d96c-183">O tempo de execução tem uma otimização de desempenho interna que pode sobrecarregar a medida de uma chamada individual.</span><span class="sxs-lookup"><span data-stu-id="5d96c-183">The runtime has a performance optimization built into it that can overwhelm the measurement of an individual call.</span></span> <span data-ttu-id="5d96c-184">Aqui está um cenário de exemplo que demonstra esse problema.</span><span class="sxs-lookup"><span data-stu-id="5d96c-184">Here's an example scenario that demonstrates this problem.</span></span> <span data-ttu-id="5d96c-185">Considere a seguinte sequência de renderização:</span><span class="sxs-lookup"><span data-stu-id="5d96c-185">Consider the following render sequence:</span></span>


```
  BeginScene();
    ...
    SetTexture(...);
    DrawPrimitive(D3DPT_TRIANGLELIST, 0, 1);
    ...
  EndScene();
  Present();
```



<span data-ttu-id="5d96c-186">Exemplo 1: sequência de renderização simples</span><span class="sxs-lookup"><span data-stu-id="5d96c-186">Example 1: Simple Render Sequence</span></span>

<span data-ttu-id="5d96c-187">Observando os resultados das duas chamadas na sequência de renderização, um criador de perfil de instrumentação poderia retornar resultados semelhantes a estes:</span><span class="sxs-lookup"><span data-stu-id="5d96c-187">Looking at the results for the two calls in the render sequence, an instrumenting profiler could return results similar to these:</span></span>


```
Number of cycles for SetTexture       : 100
Number of cycles for DrawPrimitive    : 950,500
```



<span data-ttu-id="5d96c-188">O criador de perfil retorna o número de ciclos de CPU necessários para processar o trabalho associado a cada chamada (Lembre-se de que a GPU não está incluída nesses números porque a GPU ainda não começou a trabalhar nesses comandos).</span><span class="sxs-lookup"><span data-stu-id="5d96c-188">The profiler returns the number of CPU cycles required to process the work associated with each call (remember that the GPU isn't included in these numbers because the GPU hasn't started working on these commands yet).</span></span> <span data-ttu-id="5d96c-189">Como [**IDirect3DDevice9::D rawprimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) exigiu quase um milhão de ciclos para processar, você poderia concluir que não é muito eficiente.</span><span class="sxs-lookup"><span data-stu-id="5d96c-189">Because [**IDirect3DDevice9::DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) required almost a million cycles to process, you could conclude that it is not very efficient.</span></span> <span data-ttu-id="5d96c-190">No entanto, em breve você verá por que essa conclusão está incorreta e como você pode gerar resultados que podem ser usados para orçamento.</span><span class="sxs-lookup"><span data-stu-id="5d96c-190">However, you'll soon see why this conclusion is incorrect and how you can generate results that can be used for budgeting.</span></span>

### <a name="measuring-state-changes-requires-careful-render-sequences"></a><span data-ttu-id="5d96c-191">A medição de alterações de Estado requer sequências de renderização cuidadosa</span><span class="sxs-lookup"><span data-stu-id="5d96c-191">Measuring State Changes Requires Careful Render Sequences</span></span>

<span data-ttu-id="5d96c-192">Todas as chamadas que não sejam [**IDirect3DDevice9::D rawprimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), [**DrawIndexedPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive)ou [**Clear**](/windows/desktop/api) (como [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture), [**SetVertexDeclaration**](/windows/desktop/api)e [**setrenderingstate**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate)) produzem uma alteração de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-192">All calls other than [**IDirect3DDevice9::DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), [**DrawIndexedPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive), or [**Clear**](/windows/desktop/api) (such as [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture), [**SetVertexDeclaration**](/windows/desktop/api), and [**SetRenderState**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate)) produce a state change.</span></span> <span data-ttu-id="5d96c-193">Cada alteração de estado define o estado do pipeline que controla como a renderização será feita.</span><span class="sxs-lookup"><span data-stu-id="5d96c-193">Each state change sets pipeline state that controls how rendering will be done.</span></span>

<span data-ttu-id="5d96c-194">Otimizações no tempo de execução e/ou o driver são projetados para acelerar o processamento reduzindo a quantidade de trabalho necessária.</span><span class="sxs-lookup"><span data-stu-id="5d96c-194">Optimizations in the runtime and/or the driver are designed to speed up rendering by reducing the amount of work required.</span></span> <span data-ttu-id="5d96c-195">A seguir estão algumas otimizações de alteração de estado que podem poluir as médias do perfil:</span><span class="sxs-lookup"><span data-stu-id="5d96c-195">The following are a couple of state change optimizations that may pollute profile averages:</span></span>

-   <span data-ttu-id="5d96c-196">Um driver (ou o tempo de execução) pode salvar uma alteração de estado como um estado local.</span><span class="sxs-lookup"><span data-stu-id="5d96c-196">A driver (or the runtime) could save a state change as a local state.</span></span> <span data-ttu-id="5d96c-197">Como o driver pode operar em um algoritmo "lento" (adiar o trabalho até ser absolutamente necessário), o trabalho associado a algumas alterações de estado pode ser atrasado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-197">Because the driver could operate in a "lazy" algorithm (postponing work until it is absolutely necessary), work associated with some state changes could get delayed.</span></span>
-   <span data-ttu-id="5d96c-198">O tempo de execução (ou um driver) pode remover alterações de estado otimizando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-198">The runtime (or a driver) may remove state changes by optimizing.</span></span> <span data-ttu-id="5d96c-199">Um exemplo disso pode ser remover uma alteração de estado redundante que desabilite a iluminação porque a iluminação foi desabilitada anteriormente.</span><span class="sxs-lookup"><span data-stu-id="5d96c-199">An example of this might be to remove a redundant state change that disables lighting because lighting has previously been disabled.</span></span>

<span data-ttu-id="5d96c-200">Não há uma maneira à prova de examinar uma sequência de renderização e concluir quais alterações de estado definirão um bit sujo e adiar o trabalho ou serão simplesmente removidas pela otimização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-200">There is no foolproof way to look at a render sequence and conclude which state changes will set a dirty bit and defer work, or will simply be removed by optimization.</span></span> <span data-ttu-id="5d96c-201">Mesmo que você possa identificar alterações de estado otimizadas no tempo de execução ou no driver de hoje, o tempo de execução do amanhã ou o driver provavelmente será atualizado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-201">Even if you could identify optimized state changes in today's runtime or driver, tomorrow's runtime or driver is likely to be updated.</span></span> <span data-ttu-id="5d96c-202">Você também não sabe rapidamente qual é o estado anterior, portanto, é difícil identificar alterações de estado redundantes.</span><span class="sxs-lookup"><span data-stu-id="5d96c-202">You also don't readily know what the previous state was so it is difficult to identify redundant state changes.</span></span> <span data-ttu-id="5d96c-203">A única maneira de verificar o custo de uma alteração de estado é medir a sequência de renderização que inclui as alterações de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-203">The only way to verify the cost of a state change is to measure the render sequence that includes the state changes.</span></span>

<span data-ttu-id="5d96c-204">Como você pode ver, as complicações causadas por ter vários processadores, comandos sendo processados por mais de um componente e otimizações incorporadas aos componentes dificultam a previsão da criação de perfil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-204">As you can see, the complications caused by having multiple processors, commands being processed by more than one component, and optimizations built into the components make profiling difficult to predict.</span></span> <span data-ttu-id="5d96c-205">Na próxima seção, cada um desses desafios de criação de perfil será resolvido.</span><span class="sxs-lookup"><span data-stu-id="5d96c-205">In the next section, each of these profiling challenges will be addressed.</span></span> <span data-ttu-id="5d96c-206">As sequências de renderização de Direct3D de exemplo serão mostradas, com as técnicas de medição que o acompanham.</span><span class="sxs-lookup"><span data-stu-id="5d96c-206">Sample Direct3D render sequences will be shown, with the accompanying measurement techniques.</span></span> <span data-ttu-id="5d96c-207">Com esse conhecimento, você poderá gerar medidas precisas e reproduzíveis em chamadas individuais.</span><span class="sxs-lookup"><span data-stu-id="5d96c-207">With this knowledge, you will be able to generate accurate, repeatable measurements on individual calls.</span></span>

## <a name="how-to-accurately-profile-a-direct3d-render-sequence"></a><span data-ttu-id="5d96c-208">Como criar um perfil com precisão de uma sequência de renderização do Direct3D</span><span class="sxs-lookup"><span data-stu-id="5d96c-208">How to Accurately Profile a Direct3D Render Sequence</span></span>

<span data-ttu-id="5d96c-209">Agora que alguns dos desafios de criação de perfil foram realçados, esta seção mostrará as técnicas que o ajudarão a gerar medidas de perfil que podem ser usadas para orçamento.</span><span class="sxs-lookup"><span data-stu-id="5d96c-209">Now that some of the profiling challenges have been highlighted, this section will show you techniques that will help you generate profile measurements that can be used for budgeting.</span></span> <span data-ttu-id="5d96c-210">Medidas precisas e reproduzíveis de criação de perfil são possíveis se você entender a relação entre os componentes controlados pela CPU e como evitar otimizações de desempenho implementadas pelo tempo de execução e o driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-210">Accurate, repeatable profiling measurements are possible if you understand the relationship between the components controlled by the CPU, and how to avoid performance optimizations implemented by the runtime and the driver.</span></span>

<span data-ttu-id="5d96c-211">Para começar, você precisa ser capaz de medir com precisão o tempo de execução de uma única chamada à API.</span><span class="sxs-lookup"><span data-stu-id="5d96c-211">To begin, you need to be able to accurately measure the execution time of a single API call.</span></span>

### <a name="pick-an-accurate-measurement-tool-like-queryperformancecounter"></a><span data-ttu-id="5d96c-212">Escolha uma ferramenta de medida precisa como QueryPerformanceCounter</span><span class="sxs-lookup"><span data-stu-id="5d96c-212">Pick an Accurate Measurement Tool Like QueryPerformanceCounter</span></span>

<span data-ttu-id="5d96c-213">O sistema operacional Microsoft Windows inclui um temporizador de alta resolução que pode ser usado para medir tempos decorridos de alta resolução.</span><span class="sxs-lookup"><span data-stu-id="5d96c-213">The Microsoft Windows operating system includes a high-resolution timer that can be used to measure high-resolution elapsed times.</span></span> <span data-ttu-id="5d96c-214">O valor atual de um desses temporizadores pode ser retornado usando [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="5d96c-214">The current value of one such timer can be returned using [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span></span> <span data-ttu-id="5d96c-215">Depois de invocar **QueryPerformanceCounter** para retornar valores de início e de parada, a diferença entre os dois valores pode ser convertida para o tempo real decorrido (em segundos) usando **QueryPerformanceCounter**.</span><span class="sxs-lookup"><span data-stu-id="5d96c-215">After invoking **QueryPerformanceCounter** to return start and stop values, the difference between the two values can be converted to the actual elapsed time (in seconds) using **QueryPerformanceCounter**.</span></span>

<span data-ttu-id="5d96c-216">As vantagens de usar o [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) são que ele está disponível no Windows e é fácil de usar.</span><span class="sxs-lookup"><span data-stu-id="5d96c-216">The advantages of using [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) are that it is available in Windows and it is easy to use.</span></span> <span data-ttu-id="5d96c-217">Basta colocar as chamadas com uma chamada **QueryPerformanceCounter** e salvar os valores de início e de parada.</span><span class="sxs-lookup"><span data-stu-id="5d96c-217">Simply surround the calls with a **QueryPerformanceCounter** call and save the start and stop values.</span></span> <span data-ttu-id="5d96c-218">Portanto, este documento demonstrará como usar o **QueryPerformanceCounter** para gerar perfis de tempo de execução, de forma semelhante à maneira como um criador de perfil de instrumentação o mediria.</span><span class="sxs-lookup"><span data-stu-id="5d96c-218">Therefore, this paper will demonstrate how to use **QueryPerformanceCounter** to profile execution times, similar to the way an instrumenting profiler would measure it.</span></span> <span data-ttu-id="5d96c-219">Aqui está um exemplo que mostra como inserir **QueryPerformanceCounter** em seu código-fonte:</span><span class="sxs-lookup"><span data-stu-id="5d96c-219">Here's an example that shows how to embed **QueryPerformanceCounter** in your source code:</span></span>


```
  BeginScene();
    ...
    // Start profiling
    LARGE_INTEGER start, stop, freq;
    QueryPerformanceCounter(&start);

    SetTexture(...);
    DrawPrimitive(D3DPT_TRIANGLELIST, 0, 1); 

    QueryPerformanceCounter(&stop);
    stop.QuadPart -= start.QuadPart;
    QueryPerformanceFrequency(&freq);
    // Stop profiling
    ...
  EndScene();
  Present();
```



<span data-ttu-id="5d96c-220">Exemplo 2: implementação de criação de perfil Personalizada com QPC</span><span class="sxs-lookup"><span data-stu-id="5d96c-220">Example 2: Custom Profiling Implementation with QPC</span></span>

<span data-ttu-id="5d96c-221">Start e Stop são dois inteiros grandes que manterão os valores de início e de parada retornados pelo timer de alto desempenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-221">start and stop are two large integers that will hold the start and stop values returned by the high-performance timer.</span></span> <span data-ttu-id="5d96c-222">Observe que QueryPerformanceCounter (&Start) é chamado logo antes de [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) e QueryPerformanceCounter (Stop &) é chamado logo após [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive).</span><span class="sxs-lookup"><span data-stu-id="5d96c-222">Notice that QueryPerformanceCounter(&start) is called just before [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) and QueryPerformanceCounter(&stop) is called just after [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive).</span></span> <span data-ttu-id="5d96c-223">Depois de obter o valor de parada, QueryPerformanceFrequency é chamado para retornar freq, que é a frequência do timer de alta resolução.</span><span class="sxs-lookup"><span data-stu-id="5d96c-223">After getting the stop value, QueryPerformanceFrequency is called to return freq, which is the frequency of the high-resolution timer.</span></span> <span data-ttu-id="5d96c-224">Neste exemplo hipotético, suponha que você obtenha os seguintes resultados para Start, stop e freq:</span><span class="sxs-lookup"><span data-stu-id="5d96c-224">In this hypothetical example, suppose you get the following results for start, stop, and freq:</span></span>



| <span data-ttu-id="5d96c-225">Variável Local</span><span class="sxs-lookup"><span data-stu-id="5d96c-225">Local Variable</span></span> | <span data-ttu-id="5d96c-226">Número de tiques</span><span class="sxs-lookup"><span data-stu-id="5d96c-226">Number of Ticks</span></span> |
|----------------|-----------------|
| <span data-ttu-id="5d96c-227">iniciar</span><span class="sxs-lookup"><span data-stu-id="5d96c-227">start</span></span>          | <span data-ttu-id="5d96c-228">1792998845094</span><span class="sxs-lookup"><span data-stu-id="5d96c-228">1792998845094</span></span>   |
| <span data-ttu-id="5d96c-229">parar</span><span class="sxs-lookup"><span data-stu-id="5d96c-229">stop</span></span>           | <span data-ttu-id="5d96c-230">1792998845102</span><span class="sxs-lookup"><span data-stu-id="5d96c-230">1792998845102</span></span>   |
| <span data-ttu-id="5d96c-231">freq</span><span class="sxs-lookup"><span data-stu-id="5d96c-231">freq</span></span>           | <span data-ttu-id="5d96c-232">3579545</span><span class="sxs-lookup"><span data-stu-id="5d96c-232">3579545</span></span>         |



 

<span data-ttu-id="5d96c-233">Você pode converter esses valores para o número de ciclos que é necessário para executar as chamadas à API como esta:</span><span class="sxs-lookup"><span data-stu-id="5d96c-233">You could convert these values to the number of cycles it takes to execute the API calls like this:</span></span>


```
# ticks = (stop - start) = 1792998845102 - 1792998845094 = 8 ticks

# cycles = CPU speed * number of ticks / QPF
# 4568   = 2 GHz      * 8              / 3,579,545
```



<span data-ttu-id="5d96c-234">Em outras palavras, leva cerca de 4568 ciclos de relógio para processar [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) e [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) neste computador de 2 GHz.</span><span class="sxs-lookup"><span data-stu-id="5d96c-234">In other words, it takes about 4568 clock cycles to process [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) and [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) on this 2 GHz machine.</span></span> <span data-ttu-id="5d96c-235">Você pode converter esses valores para o tempo real necessário para executar todas as chamadas como esta:</span><span class="sxs-lookup"><span data-stu-id="5d96c-235">You could convert these values to the actual time it took to execute all the calls like this:</span></span>


```
(stop - start)/ freq = elapsed time
8 ticks / 3,579,545 = 2.2E-6 seconds or between 2 and 3 microseconds.
```



<span data-ttu-id="5d96c-236">O uso de QueryPerformanceCounter exige que você adicione medidas de início e parada à sequência de renderização e use QueryPerformanceFrequency para converter a diferença (número de tiques) para o número de ciclos de CPU ou para o tempo real.</span><span class="sxs-lookup"><span data-stu-id="5d96c-236">Using QueryPerformanceCounter requires that you add start and stop measurements to your render sequence and use QueryPerformanceFrequency to convert the difference (number of ticks) to the number of CPU cycles or to actual time.</span></span> <span data-ttu-id="5d96c-237">Identificar a técnica de medida é um bom começo para o desenvolvimento de uma implementação de criação de perfil Personalizada.</span><span class="sxs-lookup"><span data-stu-id="5d96c-237">Identifying the measurement technique is a good start for developing a custom profiling implementation.</span></span> <span data-ttu-id="5d96c-238">Mas antes de começar a fazer medidas, você precisa saber como lidar com a placa de vídeo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-238">But before you jump in and start making measurements, you need to know how to deal with the video card.</span></span>

### <a name="focus-on-cpu-measurements"></a><span data-ttu-id="5d96c-239">Foco em medições de CPU</span><span class="sxs-lookup"><span data-stu-id="5d96c-239">Focus on CPU Measurements</span></span>

<span data-ttu-id="5d96c-240">Como mencionado anteriormente, a CPU e a GPU trabalham em paralelo para processar o trabalho gerado pelas chamadas à API.</span><span class="sxs-lookup"><span data-stu-id="5d96c-240">As stated earlier, the CPU and the GPU work in parallel to process the work generated by the API calls.</span></span> <span data-ttu-id="5d96c-241">Um aplicativo do mundo real requer a criação de perfil de ambos os tipos de processadores para descobrir se seu aplicativo é limitado à CPU ou à GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-241">A real world application requires profiling both types of processors to find out if your application is CPU-limited or GPU-limited.</span></span> <span data-ttu-id="5d96c-242">Como o desempenho da GPU é específico do fornecedor, seria muito desafiador produzir resultados neste documento que cobrem a variedade de placas de vídeo disponíveis.</span><span class="sxs-lookup"><span data-stu-id="5d96c-242">Since GPU performance is vendor specific, it would be very challenging to produce results in this paper that cover the variety of video cards available.</span></span>

<span data-ttu-id="5d96c-243">Em vez disso, este documento se concentrará apenas na criação de perfil do trabalho realizado pela CPU usando uma técnica personalizada para medir o tempo de execução e o driver funcionar.</span><span class="sxs-lookup"><span data-stu-id="5d96c-243">Instead, this paper will focus only on profiling the work performed by the CPU by using a custom technique for measuring the runtime and driver work.</span></span> <span data-ttu-id="5d96c-244">O trabalho da GPU será reduzido a um valor insignificante, para que os resultados da CPU sejam mais visíveis.</span><span class="sxs-lookup"><span data-stu-id="5d96c-244">The GPU work will be reduced to an insignificant amount, so that CPU results are more visible.</span></span> <span data-ttu-id="5d96c-245">Um benefício dessa abordagem é que essa técnica produz resultados no apêndice que você deve ser capaz de correlacionar com suas medições.</span><span class="sxs-lookup"><span data-stu-id="5d96c-245">One benefit of this approach is that this technique yields results in the Appendix that you should be able to correlate with your measurements.</span></span> <span data-ttu-id="5d96c-246">Para reduzir o trabalho exigido pela placa de vídeo para um nível insignificante, basta reduzir o trabalho de renderização para o valor mínimo possível.</span><span class="sxs-lookup"><span data-stu-id="5d96c-246">To reduce the work required by the video card to an insignificant level, simply reduce the rendering work to the least amount possible.</span></span> <span data-ttu-id="5d96c-247">Isso pode ser feito limitando as chamadas de Draw para renderizar um único triângulo e pode ser mais restrito para que cada triângulo contenha apenas um pixel.</span><span class="sxs-lookup"><span data-stu-id="5d96c-247">This can be accomplished by limiting draw calls to render a single triangle, and can be further constrained so that each triangle only contains one pixel.</span></span>

<span data-ttu-id="5d96c-248">A unidade de medida usada neste documento para medir o trabalho de CPU será o número de ciclos de relógio de CPU em vez de tempo real.</span><span class="sxs-lookup"><span data-stu-id="5d96c-248">The unit of measure used in this paper for measuring CPU work will be the number of CPU clock cycles rather than actual time.</span></span> <span data-ttu-id="5d96c-249">Os ciclos de relógio de CPU têm a vantagem de ser mais portátil (para aplicativos limitados à CPU) do que o tempo decorrido real entre computadores com velocidades de CPU diferentes.</span><span class="sxs-lookup"><span data-stu-id="5d96c-249">CPU clock cycles has the advantage that it is more portable (for CPU-limited applications) than actual elapsed time across machines with different CPU speeds.</span></span> <span data-ttu-id="5d96c-250">Isso pode ser facilmente convertido em tempo real, se desejado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-250">This can easily be converted to actual time if desired.</span></span>

<span data-ttu-id="5d96c-251">Este documento não aborda os tópicos relacionados ao balanceamento da carga de trabalho entre a CPU e a GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-251">This document does not cover topics related to balancing the work load between the CPU and the GPU.</span></span> <span data-ttu-id="5d96c-252">Lembre-se de que o objetivo deste documento é não medir o desempenho geral de um aplicativo, mas mostrar como medir com precisão o tempo que leva o Runtime e o driver para processar chamadas à API.</span><span class="sxs-lookup"><span data-stu-id="5d96c-252">Remember, the goal of this paper is not to measure the overall performance of an application, but to show you how to accurately measure the time it takes the runtime and the driver to process API calls.</span></span> <span data-ttu-id="5d96c-253">Com essas medidas precisas, você pode assumir a tarefa de orçar a CPU para entender determinados cenários de desempenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-253">With these accurate measurements, you can take on the task of budgeting the CPU to understand certain performance scenarios.</span></span>

### <a name="controlling-runtime-and-driver-optimizations"></a><span data-ttu-id="5d96c-254">Controlando o tempo de execução e otimizações de driver</span><span class="sxs-lookup"><span data-stu-id="5d96c-254">Controlling Runtime and Driver Optimizations</span></span>

<span data-ttu-id="5d96c-255">Com uma técnica de medida identificada e uma estratégia para reduzir o trabalho da GPU, a próxima etapa é entender as otimizações de tempo de execução e de driver que ficam no caminho da criação de perfil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-255">With a measurement technique identified, and a strategy for reducing GPU work, the next step is to understand the runtime and driver optimizations that get in the way when you are profiling.</span></span>

<span data-ttu-id="5d96c-256">O trabalho de CPU pode ser dividido em três buckets: o aplicativo funciona, o tempo de execução e o driver funcionam.</span><span class="sxs-lookup"><span data-stu-id="5d96c-256">The CPU work can be divided into three buckets: the application work, the runtime work, and the driver work.</span></span> <span data-ttu-id="5d96c-257">Ignorar o trabalho do aplicativo, pois está sob o controle do programador.</span><span class="sxs-lookup"><span data-stu-id="5d96c-257">Ignore the application work since this is under programmer control.</span></span> <span data-ttu-id="5d96c-258">Do ponto de vista do aplicativo, o tempo de execução e o driver são como caixas pretas, pois o aplicativo não tem controle sobre o que é implementado neles.</span><span class="sxs-lookup"><span data-stu-id="5d96c-258">From the application's standpoint, the runtime and the driver are like black boxes, as the application has no control over what is implemented in them.</span></span> <span data-ttu-id="5d96c-259">A chave é entender as técnicas de otimização que podem ser implementadas no tempo de execução e no driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-259">The key is to understand the optimization techniques that may be implemented in the runtime and the driver.</span></span> <span data-ttu-id="5d96c-260">Se você não entender essas otimizações, será muito fácil saltar para a conclusão errada sobre a quantidade de trabalho que a CPU está fazendo com base nas medições de perfil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-260">If you don't understand these optimizations, it is very easy to jump to the wrong conclusion about the amount of work the CPU is doing based on the profile measurements.</span></span> <span data-ttu-id="5d96c-261">Em particular, há dois tópicos relacionados a algo chamado de buffer de comando e o que ele pode fazer para ofuscar a criação de perfil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-261">In particular, there are two topics related to something called the command buffer and what it can do to obfuscate profiling.</span></span> <span data-ttu-id="5d96c-262">Esses tópicos são:</span><span class="sxs-lookup"><span data-stu-id="5d96c-262">These topics are:</span></span>

-   <span data-ttu-id="5d96c-263">Otimização de tempo de execução com o buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-263">Runtime optimization with the Command Buffer.</span></span> <span data-ttu-id="5d96c-264">O buffer de comando é uma otimização de tempo de execução que reduz o impacto de uma transição de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-264">The command buffer is a runtime optimization that reduces the impact of a mode transition.</span></span> <span data-ttu-id="5d96c-265">Para controlar o tempo da transição de modo, consulte [controlando o buffer de comando](#controlling-the-command-buffer).</span><span class="sxs-lookup"><span data-stu-id="5d96c-265">To control the timing of the mode transition, see [Controlling the Command Buffer](#controlling-the-command-buffer).</span></span>
-   <span data-ttu-id="5d96c-266">Negando os efeitos de tempo do buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-266">Negating the timing effects of the Command Buffer.</span></span> <span data-ttu-id="5d96c-267">O tempo decorrido de uma transição de modo pode ter um grande impacto sobre as medições de criação de perfil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-267">The elapsed time of a mode transition can have a big impact on profiling measurements.</span></span> <span data-ttu-id="5d96c-268">A estratégia para isso é [tornar a sequência de renderização grande em comparação com a transição de modo](#make-the-render-sequence-large-compared-to-the-mode-transition).</span><span class="sxs-lookup"><span data-stu-id="5d96c-268">The strategy for this is to [Make the Render Sequence Large Compared to the Mode Transition](#make-the-render-sequence-large-compared-to-the-mode-transition).</span></span>

### <a name="controlling-the-command-buffer"></a><span data-ttu-id="5d96c-269">Controlando o buffer de comando</span><span class="sxs-lookup"><span data-stu-id="5d96c-269">Controlling the Command Buffer</span></span>

<span data-ttu-id="5d96c-270">Quando um aplicativo faz uma chamada à API, o tempo de execução converte a chamada à API em um formato independente de dispositivo (que chamaremos de um comando) e a armazena no buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-270">When an application makes an API call, the runtime converts the API call to a device-independent format (which we will call a command), and stores it in the command buffer.</span></span> <span data-ttu-id="5d96c-271">O buffer de comando é adicionado ao diagrama a seguir.</span><span class="sxs-lookup"><span data-stu-id="5d96c-271">The command buffer is added to the following diagram.</span></span>

![diagrama de componentes da CPU, incluindo um buffer de comando](images/microbenchmarkcommandbuffer2.png)

<span data-ttu-id="5d96c-273">Cada vez que o aplicativo faz outra chamada à API, o tempo de execução repete essa sequência e adiciona outro comando ao buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-273">Each time the application makes another API call, the runtime repeats this sequence and adds another command to the command buffer.</span></span> <span data-ttu-id="5d96c-274">Em algum momento, o tempo de execução esvazia o buffer (enviando os comandos para o driver).</span><span class="sxs-lookup"><span data-stu-id="5d96c-274">At some point, the runtime empties the buffer (sending the commands to the driver).</span></span> <span data-ttu-id="5d96c-275">No Windows XP, esvaziar o buffer de comando causa uma transição de modo conforme o sistema operacional muda do tempo de execução (em execução no modo de usuário) para o driver (executado no modo kernel), conforme mostrado no diagrama a seguir.</span><span class="sxs-lookup"><span data-stu-id="5d96c-275">In Windows XP, emptying the command buffer causes a mode transition as the operating system switches from the runtime (running in user mode) to the driver (running in kernel mode), as shown in the following diagram.</span></span>

-   <span data-ttu-id="5d96c-276">modo de usuário – o modo de processador não privilegiado que executa o código do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-276">user mode - The non-privileged processor mode that executes application code.</span></span> <span data-ttu-id="5d96c-277">Aplicativos de modo de usuário não podem obter acesso a dados do sistema, exceto por meio de serviços do sistema.</span><span class="sxs-lookup"><span data-stu-id="5d96c-277">User-mode applications cannot gain access to system data except through system services.</span></span>
-   <span data-ttu-id="5d96c-278">modo kernel – o modo de processador privilegiado no qual o código executivo baseado no Windows é executado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-278">kernel mode - The privileged processor mode in which Windows-based executive code runs.</span></span> <span data-ttu-id="5d96c-279">Um driver ou thread em execução no modo kernel tem acesso a toda a memória do sistema, acesso direto ao hardware e as instruções da CPU para executar e/s com o hardware.</span><span class="sxs-lookup"><span data-stu-id="5d96c-279">A driver or thread running in kernel mode has access to all system memory, direct access to hardware, and the CPU instructions to perform I/O with the hardware.</span></span>

![diagrama de transições entre o modo de usuário e o modo kernel](images/microbenchmarkcommandbuffer3.png)

<span data-ttu-id="5d96c-281">A transição ocorre cada vez que a CPU alterna de usuário para modo kernel (e vice-versa) e o número de ciclos que ele requer é grande em comparação a uma chamada de API individual.</span><span class="sxs-lookup"><span data-stu-id="5d96c-281">The transition happens each time the CPU switches from user to kernel mode (and vice versa) and the number of cycles it requires is large compared to an individual API call.</span></span> <span data-ttu-id="5d96c-282">Se o tempo de execução enviou cada chamada à API para o driver quando ele foi invocado, cada chamada à API incorreria no custo de uma transição de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-282">If the runtime sent each API call to the driver when it was invoked, every API call would incur the cost of a mode transition.</span></span>

<span data-ttu-id="5d96c-283">Em vez disso, o buffer de comando é uma otimização de tempo de execução projetada para reduzir o custo efetivo da transição de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-283">Instead, the command buffer is a runtime optimization designed to reduce the effective cost of the mode transition.</span></span> <span data-ttu-id="5d96c-284">O buffer de comando enfileira muitos comandos de driver em preparação para uma transição de modo único.</span><span class="sxs-lookup"><span data-stu-id="5d96c-284">The command buffer queues many driver commands in preparation for a single mode transition.</span></span> <span data-ttu-id="5d96c-285">Quando o tempo de execução adiciona um comando ao buffer de comando, o controle é retornado para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-285">When the runtime adds a command to the command buffer, control is returned to the application.</span></span> <span data-ttu-id="5d96c-286">Um criador de perfil não tem como saber que os comandos do driver provavelmente ainda não foram enviados para o driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-286">A profiler has no way of knowing that the driver commands have probably not even been sent to the driver yet.</span></span> <span data-ttu-id="5d96c-287">Como resultado, os números retornados por um criador de perfil de instrumentação fora do mercado são enganosos, uma vez que mede o trabalho de tempo de execução, mas não o driver associado funciona.</span><span class="sxs-lookup"><span data-stu-id="5d96c-287">As a result, the numbers returned by an off-the-shelf instrumenting profiler are misleading since it measures the runtime work but not the associated driver work.</span></span>

### <a name="profile-results-without-a-mode-transition"></a><span data-ttu-id="5d96c-288">Resultados de perfil sem uma transição de modo</span><span class="sxs-lookup"><span data-stu-id="5d96c-288">Profile Results without a Mode Transition</span></span>

<span data-ttu-id="5d96c-289">Usando a sequência de renderização do exemplo 2, aqui estão algumas medidas de tempo típicas que ilustram a magnitude de uma transição de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-289">Using the render sequence from example 2, here are some typical timing measurements that illustrate the magnitude of a mode transition.</span></span> <span data-ttu-id="5d96c-290">Supondo que as chamadas [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) e [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) não causem uma transição de modo, um criador de perfil de instrumentação fora do mercado poderia retornar resultados semelhantes a estes:</span><span class="sxs-lookup"><span data-stu-id="5d96c-290">Assuming that [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) and [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) calls do not cause a mode transition, an off-the-shelf instrumenting profiler could return results similar to these:</span></span>


```
Number of cycles for SetTexture           : 100
Number of cycles for DrawPrimitive        : 900
```



<span data-ttu-id="5d96c-291">Cada um desses números é a quantidade de tempo que leva para o tempo de execução adicionar essas chamadas ao buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-291">Each of these numbers are the amount of time it takes for the runtime to add these calls to the command buffer.</span></span> <span data-ttu-id="5d96c-292">Como não há nenhuma transição de modo, o driver ainda não fez nenhum trabalho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-292">Since there is no mode transition, the driver has not done any work yet.</span></span> <span data-ttu-id="5d96c-293">Os resultados do criador de perfil são precisos, mas não medem todo o trabalho que a sequência de renderização eventualmente fará com que a CPU execute.</span><span class="sxs-lookup"><span data-stu-id="5d96c-293">The profiler results are accurate, but they do not measure all of the work that the render sequence will eventually cause the CPU to perform.</span></span>

### <a name="profile-results-with-a-mode-transition"></a><span data-ttu-id="5d96c-294">Resultados de perfil com uma transição de modo</span><span class="sxs-lookup"><span data-stu-id="5d96c-294">Profile Results with a Mode Transition</span></span>

<span data-ttu-id="5d96c-295">Agora, examine o que acontece para o mesmo exemplo quando ocorre uma transição de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-295">Now, look at what happens for the same example when a mode transition occurs.</span></span> <span data-ttu-id="5d96c-296">Desta vez, suponha que [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) e [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) cause uma transição de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-296">This time, assume [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) and [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) cause a mode transition.</span></span> <span data-ttu-id="5d96c-297">Mais uma vez, um criador de perfil de instrumentação fora do mercado poderia retornar resultados semelhantes a estes:</span><span class="sxs-lookup"><span data-stu-id="5d96c-297">Once again, an off-the-shelf instrumenting profiler could return results similar to these:</span></span>


```
Number of cycles for SetTexture           : 98 
Number of cycles for DrawPrimitive        : 946,900
```



<span data-ttu-id="5d96c-298">O tempo medido para [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) é quase o mesmo, no entanto, o aumento drástico na quantidade de tempo gasto em [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) é devido à transição de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-298">The time measured for [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) is about the same, however, the dramatic increase in the amount of time spent in [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) is due to the mode transition.</span></span> <span data-ttu-id="5d96c-299">Veja o que está acontecendo:</span><span class="sxs-lookup"><span data-stu-id="5d96c-299">Here's what is happening:</span></span>

1.  <span data-ttu-id="5d96c-300">Suponha que o buffer de comando tenha espaço para um comando antes que nossa sequência de renderização seja iniciada.</span><span class="sxs-lookup"><span data-stu-id="5d96c-300">Assume the command buffer has room for one command before our render sequence starts.</span></span>
2.  <span data-ttu-id="5d96c-301">[**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) é convertido em um formato independente de dispositivo e adicionado ao buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-301">[**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) is converted to a device-independent format and added to the command buffer.</span></span> <span data-ttu-id="5d96c-302">Nesse cenário, essa chamada preenche o buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-302">In this scenario, this call fills the command buffer.</span></span>
3.  <span data-ttu-id="5d96c-303">O tempo de execução tenta adicionar [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) ao buffer de comando, mas não pode, porque está cheio.</span><span class="sxs-lookup"><span data-stu-id="5d96c-303">The runtime tries to add [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) to the command buffer but cannot, because it is full.</span></span> <span data-ttu-id="5d96c-304">Em vez disso, o tempo de execução esvazia o buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-304">Instead, the runtime empties the command buffer.</span></span> <span data-ttu-id="5d96c-305">Isso faz com que a transição do modo kernel.</span><span class="sxs-lookup"><span data-stu-id="5d96c-305">This causes the kernel-mode transition.</span></span> <span data-ttu-id="5d96c-306">Suponha que a transição leve cerca de 5000 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-306">Assume the transition takes about 5000 cycles.</span></span> <span data-ttu-id="5d96c-307">Esse tempo contribui para o tempo gasto em **DrawPrimitive**.</span><span class="sxs-lookup"><span data-stu-id="5d96c-307">This time contributes to time spent in **DrawPrimitive**.</span></span>
4.  <span data-ttu-id="5d96c-308">Em seguida, o driver processa o trabalho associado a todos os comandos que foram esvaziados do buffer de comandos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-308">The driver then processes the work associated with all the commands that were emptied from the command buffer.</span></span> <span data-ttu-id="5d96c-309">Suponha que o tempo do driver para processar os comandos que quase preenchem o buffer de comando seja de cerca de 935.000 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-309">Assume that the driver time to process the commands that nearly filled the command buffer is about 935,000 cycles.</span></span> <span data-ttu-id="5d96c-310">Suponha que o driver de trabalho associado a [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) seja de cerca de 2750 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-310">Assume that the driver work associated with [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) is about 2750 cycles.</span></span> <span data-ttu-id="5d96c-311">Esse tempo contribui para o tempo gasto em [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive).</span><span class="sxs-lookup"><span data-stu-id="5d96c-311">This time contributes to time spent in [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive).</span></span>
5.  <span data-ttu-id="5d96c-312">Quando o driver conclui seu trabalho, a transição do modo de usuário retorna o controle para o tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="5d96c-312">When the driver finishes its work, the user-mode transition returns control to the runtime.</span></span> <span data-ttu-id="5d96c-313">O buffer de comando agora está vazio.</span><span class="sxs-lookup"><span data-stu-id="5d96c-313">The command buffer is now empty.</span></span> <span data-ttu-id="5d96c-314">Suponha que a transição leve cerca de 5000 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-314">Assume the transition takes about 5000 cycles.</span></span>
6.  <span data-ttu-id="5d96c-315">A sequência de renderização termina convertendo [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) e adicionando-o ao buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-315">The render sequence finishes by converting [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) and adding it to the command buffer.</span></span> <span data-ttu-id="5d96c-316">Suponha que isso leve cerca de 900 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-316">Assume this takes about 900 cycles.</span></span> <span data-ttu-id="5d96c-317">Esse tempo contribui para o tempo gasto em **DrawPrimitive**.</span><span class="sxs-lookup"><span data-stu-id="5d96c-317">This time contributes to time spent in **DrawPrimitive**.</span></span>

<span data-ttu-id="5d96c-318">Resumindo os resultados, você verá:</span><span class="sxs-lookup"><span data-stu-id="5d96c-318">Summarizing the results, you see:</span></span>


```
DrawPrimitive = kernel-transition + driver work    + user-transition + runtime work
DrawPrimitive = 5000              + 935,000 + 2750 + 5000            + 900
DrawPrimitive = 947,950  
```



<span data-ttu-id="5d96c-319">Assim como a medida para [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) sem a transição de modo (900 ciclos), a medida para **DrawPrimitive** com a transição de modo (947.950 ciclos) é precisa, mas inútil em termos de orçamento de trabalho de CPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-319">Just like the measurement for [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) without the mode transition (900 cycles), the measurement for **DrawPrimitive** with the mode transition (947,950 cycles) is accurate but useless in terms of budgeting CPU work.</span></span> <span data-ttu-id="5d96c-320">O resultado contém o trabalho de tempo de execução correto, o driver funciona para [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture), o driver funciona para todos os comandos que precedem **SetTexture** e duas transições de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-320">The result contains the correct runtime work, the driver work for [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture), the driver work for any commands that preceded **SetTexture**, and two mode transitions.</span></span> <span data-ttu-id="5d96c-321">No entanto, a medida não tem o funcionamento do driver **DrawPrimitive** .</span><span class="sxs-lookup"><span data-stu-id="5d96c-321">However, the measurement is missing the **DrawPrimitive** driver work.</span></span>

<span data-ttu-id="5d96c-322">Uma transição de modo pode acontecer em resposta a qualquer chamada.</span><span class="sxs-lookup"><span data-stu-id="5d96c-322">A mode transition could happen in response to any call.</span></span> <span data-ttu-id="5d96c-323">Depende do que estava anteriormente no buffer de comandos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-323">It depends on what was previously in the command buffer.</span></span> <span data-ttu-id="5d96c-324">Você precisa controlar a transição de modo para entender a quantidade de trabalho de CPU (tempo de execução e driver) associada a cada chamada.</span><span class="sxs-lookup"><span data-stu-id="5d96c-324">You need to control the mode transition to understand how much CPU work (runtime and driver) is associated with each call.</span></span> <span data-ttu-id="5d96c-325">Para fazer isso, você precisa de um mecanismo para controlar o buffer de comando e o tempo de transição de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-325">To do that, you need a mechanism for controlling the command buffer and the timing of the mode transition.</span></span>

### <a name="the-query-mechanism"></a><span data-ttu-id="5d96c-326">O mecanismo de consulta</span><span class="sxs-lookup"><span data-stu-id="5d96c-326">The Query Mechanism</span></span>

<span data-ttu-id="5d96c-327">O mecanismo de consulta no Microsoft Direct3D 9 foi projetado para permitir que o tempo de execução consulte a GPU em busca de progresso e retorne determinados dados da GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-327">The query mechanism in Microsoft Direct3D 9 was designed to allow the runtime to query the GPU for progress and return certain data from the GPU.</span></span> <span data-ttu-id="5d96c-328">Durante a criação de perfil, se o trabalho da GPU for minimizado para que ele tenha um impacto insignificante sobre o desempenho, você poderá retornar o status da GPU para ajudar a medir o trabalho do driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-328">While profiling, if the GPU work is minimized so that it has a negligible impact on performance, you can return status from the GPU to help measure the driver work.</span></span> <span data-ttu-id="5d96c-329">Afinal, o trabalho do driver é concluído quando a GPU viu os comandos do driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-329">After all, the driver work is complete when the GPU has seen the driver commands.</span></span> <span data-ttu-id="5d96c-330">Além disso, o mecanismo de consulta pode ser coaxed no controle de duas características de buffer de comando que são importantes para a criação de perfil: quando o buffer de comando esvazia e quanto trabalho está no buffer.</span><span class="sxs-lookup"><span data-stu-id="5d96c-330">Additionally, the query mechanism can be coaxed into controlling two command buffer characteristics that are important to profiling: when the command buffer empties and how much work is in the buffer.</span></span>

<span data-ttu-id="5d96c-331">Aqui está a mesma sequência de renderização usando o mecanismo de consulta:</span><span class="sxs-lookup"><span data-stu-id="5d96c-331">Here's the same render sequence using the query mechanism:</span></span>


```
// 1. Create an event query from the current device
IDirect3DQuery9* pEvent;
m_pD3DDevice->CreateQuery(D3DQUERYTYPE_EVENT, &pEvent);

// 2. Add an end marker to the command buffer queue.
pEvent->Issue(D3DISSUE_END);

// 3. Empty the command buffer and wait until the GPU is idle.
while(S_FALSE == pEvent->GetData( NULL, 0, D3DGETDATA_FLUSH ))
    ;

// 4. Start profiling
LARGE_INTEGER start, stop;
QueryPerformanceCounter(&start);

// 5. Invoke the API calls to be profiled.
SetTexture(...);
DrawPrimitive(D3DPT_TRIANGLELIST, 0, 1);

// 6. Add an end marker to the command buffer queue.
pEvent->Issue(D3DISSUE_END);

// 7. Force the driver to execute the commands from the command buffer.
// Empty the command buffer and wait until the GPU is idle.
while(S_FALSE == pEvent->GetData( NULL, 0, D3DGETDATA_FLUSH ))
    ;
    
// 8. End profiling
QueryPerformanceCounter(&stop);
```



<span data-ttu-id="5d96c-332">Exemplo 3: usando uma consulta para controlar o buffer de comando</span><span class="sxs-lookup"><span data-stu-id="5d96c-332">Example 3: Using a Query to Control the Command Buffer</span></span>

<span data-ttu-id="5d96c-333">Aqui está uma explicação mais detalhada de cada uma dessas linhas de código:</span><span class="sxs-lookup"><span data-stu-id="5d96c-333">Here is a more detailed explanation of each of these lines of code:</span></span>

1.  <span data-ttu-id="5d96c-334">Crie uma consulta de evento criando um objeto de consulta com o \_ evento D3DQUERYTYPE.</span><span class="sxs-lookup"><span data-stu-id="5d96c-334">Create an event query by creating a query object with D3DQUERYTYPE\_EVENT.</span></span>
2.  <span data-ttu-id="5d96c-335">Adicione um marcador de evento de consulta ao buffer de comando chamando [**Issue**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-issue)([**D3DISSUE \_ end**](d3dissue-end.md)).</span><span class="sxs-lookup"><span data-stu-id="5d96c-335">Add a query event marker to the command buffer by calling [**Issue**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-issue)([**D3DISSUE\_END**](d3dissue-end.md)).</span></span> <span data-ttu-id="5d96c-336">Esse marcador informa o driver para controlar quando a GPU conclui a execução de quaisquer comandos precedidos do marcador.</span><span class="sxs-lookup"><span data-stu-id="5d96c-336">This marker tells the driver to track when the GPU finishes executing whatever commands preceded the marker.</span></span>
3.  <span data-ttu-id="5d96c-337">A primeira chamada esvazia o buffer de comando porque chamar [**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) com [**D3DGETDATA \_ flush**](d3dgetdata-flush.md) força o buffer de comando a ser esvaziado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-337">The first call empties the command buffer because calling [**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) with [**D3DGETDATA\_FLUSH**](d3dgetdata-flush.md) forces the command buffer to be emptied.</span></span> <span data-ttu-id="5d96c-338">Cada chamada subsequente está verificando a GPU para ver quando ele conclui o processamento de todo o trabalho de buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-338">Each subsequent call is checking the GPU to see when it finishes processing all the command-buffer work.</span></span> <span data-ttu-id="5d96c-339">Esse loop não retorna S \_ OK até que a GPU esteja ociosa.</span><span class="sxs-lookup"><span data-stu-id="5d96c-339">This loop does not return S\_OK until the GPU is idle.</span></span>
4.  <span data-ttu-id="5d96c-340">Exemplo de hora de início.</span><span class="sxs-lookup"><span data-stu-id="5d96c-340">Sample the start time.</span></span>
5.  <span data-ttu-id="5d96c-341">Invocar as chamadas à API que estão sendo Profiles.</span><span class="sxs-lookup"><span data-stu-id="5d96c-341">Invoke the API calls being profiled.</span></span>
6.  <span data-ttu-id="5d96c-342">Adicione um segundo marcador de evento de consulta ao buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-342">Add a second query event marker to the command buffer.</span></span> <span data-ttu-id="5d96c-343">Esse marcador será usado para acompanhar a conclusão das chamadas.</span><span class="sxs-lookup"><span data-stu-id="5d96c-343">This marker will be used to track the completion of the calls.</span></span>
7.  <span data-ttu-id="5d96c-344">A primeira chamada esvazia o buffer de comando porque chamar [**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) com [**D3DGETDATA \_ flush**](d3dgetdata-flush.md) força o buffer de comando a ser esvaziado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-344">The first call empties the command buffer because calling [**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) with [**D3DGETDATA\_FLUSH**](d3dgetdata-flush.md) forces the command buffer to be emptied.</span></span> <span data-ttu-id="5d96c-345">Quando a GPU termina de processar todo o trabalho de buffer de comando, **GetData** retorna S \_ OK e o loop é encerrado porque a GPU está ociosa.</span><span class="sxs-lookup"><span data-stu-id="5d96c-345">When the GPU finishes processing all the command-buffer work, **GetData** returns S\_OK, and the loop is exited because the GPU is idle.</span></span>
8.  <span data-ttu-id="5d96c-346">Exemplo de hora de parada.</span><span class="sxs-lookup"><span data-stu-id="5d96c-346">Sample the stop time.</span></span>

<span data-ttu-id="5d96c-347">Aqui estão os resultados medidos com QueryPerformanceCounter e QueryPerformanceFrequency:</span><span class="sxs-lookup"><span data-stu-id="5d96c-347">Here are the results measured with QueryPerformanceCounter and QueryPerformanceFrequency:</span></span>



| <span data-ttu-id="5d96c-348">Variável Local</span><span class="sxs-lookup"><span data-stu-id="5d96c-348">Local Variable</span></span> | <span data-ttu-id="5d96c-349">Número de tiques</span><span class="sxs-lookup"><span data-stu-id="5d96c-349">Number of Ticks</span></span> |
|----------------|-----------------|
| <span data-ttu-id="5d96c-350">iniciar</span><span class="sxs-lookup"><span data-stu-id="5d96c-350">start</span></span>          | <span data-ttu-id="5d96c-351">1792998845060</span><span class="sxs-lookup"><span data-stu-id="5d96c-351">1792998845060</span></span>   |
| <span data-ttu-id="5d96c-352">parar</span><span class="sxs-lookup"><span data-stu-id="5d96c-352">stop</span></span>           | <span data-ttu-id="5d96c-353">1792998845090</span><span class="sxs-lookup"><span data-stu-id="5d96c-353">1792998845090</span></span>   |
| <span data-ttu-id="5d96c-354">freq</span><span class="sxs-lookup"><span data-stu-id="5d96c-354">freq</span></span>           | <span data-ttu-id="5d96c-355">3579545</span><span class="sxs-lookup"><span data-stu-id="5d96c-355">3579545</span></span>         |



 

<span data-ttu-id="5d96c-356">Convertendo tiques em ciclos novamente (em uma máquina de 2 GHz):</span><span class="sxs-lookup"><span data-stu-id="5d96c-356">Converting ticks to cycles once again (on a 2 GHz machine):</span></span>


```
# ticks  = (stop - start) = 1792998845090 - 1792998845060 = 30 ticks
# cycles = CPU speed * number of ticks / QPF
# 16,450 = 2 GHz      * 30             / 3,579,545
```



<span data-ttu-id="5d96c-357">Aqui está a divisão do número de ciclos por chamada:</span><span class="sxs-lookup"><span data-stu-id="5d96c-357">Here is the breakdown of the number of cycles per call:</span></span>


```
Number of cycles for SetTexture           : 100
Number of cycles for DrawPrimitive        : 900
Number of cycles for Issue                : 200
Number of cycles for GetData              : 16,450
```



<span data-ttu-id="5d96c-358">O mecanismo de consulta nos permitiu controlar o tempo de execução e o funcionamento do driver que está sendo medido.</span><span class="sxs-lookup"><span data-stu-id="5d96c-358">The query mechanism has allowed us to control the runtime and the driver work that is being measured.</span></span> <span data-ttu-id="5d96c-359">Para entender cada um desses números, veja o que está acontecendo em resposta a cada uma das chamadas à API, juntamente com os tempos estimados:</span><span class="sxs-lookup"><span data-stu-id="5d96c-359">To understand each of these numbers, here's what is happening in response to each of the API calls, along with the estimated timings:</span></span>

1.  <span data-ttu-id="5d96c-360">A primeira chamada esvazia o buffer de comando chamando [**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) com [**D3DGETDATA \_ flush**](d3dgetdata-flush.md).</span><span class="sxs-lookup"><span data-stu-id="5d96c-360">The first call empties the command buffer by calling [**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) with [**D3DGETDATA\_FLUSH**](d3dgetdata-flush.md).</span></span> <span data-ttu-id="5d96c-361">Quando a GPU termina de processar todo o trabalho de buffer de comando, **GetData** retorna S \_ OK e o loop é encerrado porque a GPU está ociosa.</span><span class="sxs-lookup"><span data-stu-id="5d96c-361">When the GPU finishes processing all the command-buffer work, **GetData** returns S\_OK, and the loop is exited because the GPU is idle.</span></span>
2.  <span data-ttu-id="5d96c-362">A sequência de renderização começa convertendo [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) em um formato independente de dispositivo e adicionando-o ao buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-362">The render sequence starts by converting [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) to a device-independent format and adding it to the command buffer.</span></span> <span data-ttu-id="5d96c-363">Suponha que isso leve cerca de 100 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-363">Assume this takes about 100 cycles.</span></span>
3.  <span data-ttu-id="5d96c-364">[**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) é convertido e adicionado ao buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-364">[**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) is converted and added to the command buffer.</span></span> <span data-ttu-id="5d96c-365">Suponha que isso leve cerca de 900 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-365">Assume this takes about 900 cycles.</span></span>
4.  <span data-ttu-id="5d96c-366">O [**problema**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-issue) adiciona um marcador de consulta ao buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-366">[**Issue**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-issue) adds a query marker to the command buffer.</span></span> <span data-ttu-id="5d96c-367">Suponha que isso leve cerca de 200 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-367">Assume this takes about 200 cycles.</span></span>
5.  <span data-ttu-id="5d96c-368">[**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) faz com que o buffer de comando seja esvaziado, o que força a transição do modo kernel.</span><span class="sxs-lookup"><span data-stu-id="5d96c-368">[**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) causes the command buffer to be emptied which forces the kernel-mode transition.</span></span> <span data-ttu-id="5d96c-369">Suponha que isso leve cerca de 5000 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-369">Assume this takes about 5000 cycles.</span></span>
6.  <span data-ttu-id="5d96c-370">Em seguida, o driver processa o trabalho associado a todas as quatro chamadas.</span><span class="sxs-lookup"><span data-stu-id="5d96c-370">The driver then processes the work associated with all four calls.</span></span> <span data-ttu-id="5d96c-371">Suponha que o tempo do driver para processar [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) seja de cerca de 2964 ciclos, [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) é de aproximadamente 3600 ciclos, o [**problema**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-issue) é de cerca de 200 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-371">Assume that the driver time to process [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) is about 2964 cycles, [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) is about 3600 cycles, [**Issue**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-issue) is about 200 cycles.</span></span> <span data-ttu-id="5d96c-372">Portanto, o tempo total do driver para todos os quatro comandos é de cerca de 6450 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-372">So the total driver time for all four commands is about 6450 cycles.</span></span>
    > [!Note]  
    > <span data-ttu-id="5d96c-373">O driver também leva algum tempo para ver qual é o status da GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-373">The driver also takes a little time to see what the status of the GPU is.</span></span> <span data-ttu-id="5d96c-374">Como o trabalho de GPU é trivial, a GPU já deve ser feita.</span><span class="sxs-lookup"><span data-stu-id="5d96c-374">Because the GPU work is trivial, the GPU should be done already.</span></span> <span data-ttu-id="5d96c-375">[**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) retornará S \_ OK com base na probabilidade de a GPU ser concluída.</span><span class="sxs-lookup"><span data-stu-id="5d96c-375">[**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) will return S\_OK based on the likelihood that the GPU is finished.</span></span>

     

7.  <span data-ttu-id="5d96c-376">Quando o driver conclui seu trabalho, a transição do modo de usuário retorna o controle para o tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="5d96c-376">When the driver finishes its work, the user-mode transition returns control to the runtime.</span></span> <span data-ttu-id="5d96c-377">O buffer de comando agora está vazio.</span><span class="sxs-lookup"><span data-stu-id="5d96c-377">The command buffer is now empty.</span></span> <span data-ttu-id="5d96c-378">Suponha que isso leve cerca de 5000 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-378">Assume this takes about 5000 cycles.</span></span>

<span data-ttu-id="5d96c-379">Os números para [**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) incluem:</span><span class="sxs-lookup"><span data-stu-id="5d96c-379">The numbers for [**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) include:</span></span>


```
GetData = kernel-transition + driver work + user-transition
GetData = 5000              + 6450        + 5000           
GetData = 16,450  

driver work = SetTexture + DrawPrimitive + Issue = 
driver work = 2964       + 3600          + 200   = 6450 cycles 
```



<span data-ttu-id="5d96c-380">O mecanismo de consulta usado em combinação com QueryPerformanceCounter mede todo o trabalho de CPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-380">The query mechanism used in combination with QueryPerformanceCounter measures all of the CPU work.</span></span> <span data-ttu-id="5d96c-381">Isso é feito com uma combinação de marcadores de consulta e comparações de status de consulta.</span><span class="sxs-lookup"><span data-stu-id="5d96c-381">This is done with a combination of query markers, and query status comparisons.</span></span> <span data-ttu-id="5d96c-382">Os marcadores de consulta de início e parada adicionados ao buffer de comando são usados para controlar a quantidade de trabalho no buffer.</span><span class="sxs-lookup"><span data-stu-id="5d96c-382">Start and stop query markers added to the command buffer are used to control how much work is in the buffer.</span></span> <span data-ttu-id="5d96c-383">Aguardando até que o código de retorno correto seja retornado, a medida inicial é feita logo antes de uma sequência de renderização limpa ser iniciada e a medida de parada é feita logo após o driver ter concluído o trabalho associado ao conteúdo do buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-383">By waiting until the right return code is returned, the start measurement is made just before a clean render sequence starts, and the stop measurement is made just after the driver has finished the work associated with the command buffer contents.</span></span> <span data-ttu-id="5d96c-384">Isso captura efetivamente o trabalho de CPU feito pelo tempo de execução, bem como o driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-384">This effectively captures the CPU work done by the runtime as well as the driver.</span></span>

<span data-ttu-id="5d96c-385">Agora que você conhece o buffer de comando e o efeito que ele pode ter na criação de perfil, você deve saber que existem algumas outras condições que podem fazer com que o tempo de execução esvazie o buffer de comando.</span><span class="sxs-lookup"><span data-stu-id="5d96c-385">Now that you know about the command buffer and the effect it can have on profiling, you should know that there are a few other conditions that can cause the runtime to empty the command buffer.</span></span> <span data-ttu-id="5d96c-386">Você precisa observar isso em suas sequências de processamento.</span><span class="sxs-lookup"><span data-stu-id="5d96c-386">You need to watch out for these in your render sequences.</span></span> <span data-ttu-id="5d96c-387">Algumas dessas condições estão em resposta a chamadas de API, outras estão em resposta às alterações de recurso no tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="5d96c-387">Some of these conditions are in response to API calls, others are in response to resource changes in the runtime.</span></span> <span data-ttu-id="5d96c-388">Qualquer uma das condições a seguir causará uma transição de modo:</span><span class="sxs-lookup"><span data-stu-id="5d96c-388">Any of the following conditions will cause a mode transition:</span></span>

-   <span data-ttu-id="5d96c-389">Quando um dos métodos Lock ([**Lock**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dvertexbuffer9-lock)) é chamado em um buffer de vértice, buffer de índice ou textura (sob determinadas condições com determinados sinalizadores).</span><span class="sxs-lookup"><span data-stu-id="5d96c-389">When one of the lock methods ([**Lock**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dvertexbuffer9-lock)) is called on a vertex buffer, index buffer, or texture (under certain conditions with certain flags).</span></span>
-   <span data-ttu-id="5d96c-390">Quando um dispositivo ou buffer de vértice, buffer de índice ou textura é criado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-390">When a device or vertex buffer, index buffer, or texture is created.</span></span>
-   <span data-ttu-id="5d96c-391">Quando um buffer de dispositivo ou de vértice, um buffer de índice ou uma textura é destruído pela última versão.</span><span class="sxs-lookup"><span data-stu-id="5d96c-391">When a device or vertex buffer, index buffer, or texture is destroyed by the last release.</span></span>
-   <span data-ttu-id="5d96c-392">Quando [**ValidateDevice**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-validatedevice) é chamado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-392">When [**ValidateDevice**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-validatedevice) is called.</span></span>
-   <span data-ttu-id="5d96c-393">Quando [**presente**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present) é chamado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-393">When [**Present**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present) is called.</span></span>
-   <span data-ttu-id="5d96c-394">Quando o buffer de comando é preenchido.</span><span class="sxs-lookup"><span data-stu-id="5d96c-394">When the command buffer fills up.</span></span>
-   <span data-ttu-id="5d96c-395">Quando [**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) é chamado com D3DGETDATA \_ flush.</span><span class="sxs-lookup"><span data-stu-id="5d96c-395">When [**GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) is called with D3DGETDATA\_FLUSH.</span></span>

<span data-ttu-id="5d96c-396">Tenha cuidado para observar essas condições em suas sequências de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-396">Be careful to watch for these conditions in your render sequences.</span></span> <span data-ttu-id="5d96c-397">Sempre que uma transição de modo for adicionada, 10.000 ciclos de trabalho de driver serão adicionados às suas medições de criação de perfil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-397">Every time a mode transition is added, 10,000 cycles of driver work will be added to your profiling measurements.</span></span> <span data-ttu-id="5d96c-398">Além disso, o buffer de comando não é dimensionado estaticamente.</span><span class="sxs-lookup"><span data-stu-id="5d96c-398">In addition, the command buffer is not statically sized.</span></span> <span data-ttu-id="5d96c-399">O tempo de execução pode alterar o tamanho do buffer em resposta à quantidade de trabalho que está sendo gerada pelo aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-399">The runtime may change the buffer's size in response to the amount of work that is being generated by the application.</span></span> <span data-ttu-id="5d96c-400">Essa ainda é outra otimização que depende de uma sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-400">This is yet another optimization that is dependent on a render sequence.</span></span>

<span data-ttu-id="5d96c-401">Portanto, tenha cuidado para controlar as transições do modo durante a criação de perfil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-401">So be careful to control mode transitions during profiling.</span></span> <span data-ttu-id="5d96c-402">O mecanismo de consulta oferece um método robusto para esvaziar o buffer de comando para que você possa controlar o tempo da transição de modo, bem como a quantidade de trabalho que o buffer contém.</span><span class="sxs-lookup"><span data-stu-id="5d96c-402">The query mechanism offers a robust method for emptying the command buffer so that you can control the timing of the mode transition as well as the amount of work the buffer contains.</span></span> <span data-ttu-id="5d96c-403">No entanto, até mesmo essa técnica pode ser aprimorada reduzindo o tempo de transição do modo para torná-lo insignificante em relação ao resultado medido.</span><span class="sxs-lookup"><span data-stu-id="5d96c-403">However, even this technique can be improved by reducing the mode transition time to make it insignificant with respect to the measured result.</span></span>

### <a name="make-the-render-sequence-large-compared-to-the-mode-transition"></a><span data-ttu-id="5d96c-404">Tornar a sequência de renderização grande em comparação com a transição de modo</span><span class="sxs-lookup"><span data-stu-id="5d96c-404">Make the Render Sequence Large Compared to the Mode Transition</span></span>

<span data-ttu-id="5d96c-405">No exemplo anterior, a opção de modo kernel e a opção de modo de usuário consomem cerca de 10.000 ciclos que não têm nada a ver com o tempo de execução e o driver funcionam.</span><span class="sxs-lookup"><span data-stu-id="5d96c-405">In the previous example, the kernel-mode switch and the user-mode switch consume about 10,000 cycles that have nothing to do with runtime and driver work.</span></span> <span data-ttu-id="5d96c-406">Como a transição de modo é incorporada ao sistema operacional, ela não pode ser reduzida para zero.</span><span class="sxs-lookup"><span data-stu-id="5d96c-406">Since the mode transition is built into the operating system, it cannot be reduced to zero.</span></span> <span data-ttu-id="5d96c-407">Para tornar a transição de modo insignificante, a sequência de renderização precisa ser ajustada para que o driver e o funcionamento do tempo de execução sejam uma ordem de magnitude maior do que as opções de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-407">To make the mode transition insignificant, the render sequence needs to adjusted so that the driver and runtime work are an order of magnitude larger than the mode switches.</span></span> <span data-ttu-id="5d96c-408">Você pode tentar fazer uma subtração para remover as transições, mas amortizar o custo em um custo muito maior de sequência de renderização é mais confiável.</span><span class="sxs-lookup"><span data-stu-id="5d96c-408">You could try to do a subtraction to remove the transitions, but amortizing the cost over a much larger render sequence cost is more reliable.</span></span>

<span data-ttu-id="5d96c-409">A estratégia para reduzir a transição de modo até que se torne insignificante é adicionar um loop à sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-409">The strategy for reducing the mode transition until it becomes insignificant is to add a loop to the render sequence.</span></span> <span data-ttu-id="5d96c-410">Por exemplo, vamos examinar os resultados da criação de perfil se um loop for adicionado, que repetirá a sequência de renderização 1500 vezes:</span><span class="sxs-lookup"><span data-stu-id="5d96c-410">For example, let look at the profiling results if a loop is added that will repeat the render sequence 1500 times:</span></span>


```
// Initialize the array with two textures, same size, same format
IDirect3DTexture* texArray[2];

CreateQuery(D3DQUERYTYPE_EVENT, pEvent);
pEvent->Issue(D3DISSUE_END);
while(S_FALSE == pEvent->GetData( NULL, 0, D3DGETDATA_FLUSH ))
    ;

LARGE_INTEGER start, stop;
// Now start counting because the video card is ready
QueryPerformanceCounter(&start);

// Add a loop to the render sequence 
for(int i = 0; i < 1500; i++)
{
  SetTexture(taxArray[i%2]);
  DrawPrimitive(D3DPT_TRIANGLELIST, i*3, 1);
}

pEvent->Issue(D3DISSUE_END);

while(S_FALSE == pEvent->GetData( NULL, 0, D3DGETDATA_FLUSH ))
    ;
QueryPerformanceCounter(&stop);
```



<span data-ttu-id="5d96c-411">Exemplo 4: adicionar um loop à sequência de renderização</span><span class="sxs-lookup"><span data-stu-id="5d96c-411">Example 4: Add a Loop to the Render Sequence</span></span>

<span data-ttu-id="5d96c-412">Aqui estão os resultados medidos com QueryPerformanceCounter e QueryPerformanceFrequency:</span><span class="sxs-lookup"><span data-stu-id="5d96c-412">Here are the results measured with QueryPerformanceCounter and QueryPerformanceFrequency:</span></span>



| <span data-ttu-id="5d96c-413">Variável Local</span><span class="sxs-lookup"><span data-stu-id="5d96c-413">Local Variable</span></span> | <span data-ttu-id="5d96c-414">Número de TICs</span><span class="sxs-lookup"><span data-stu-id="5d96c-414">Number of Tics</span></span> |
|----------------|----------------|
| <span data-ttu-id="5d96c-415">iniciar</span><span class="sxs-lookup"><span data-stu-id="5d96c-415">start</span></span>          | <span data-ttu-id="5d96c-416">1792998845000</span><span class="sxs-lookup"><span data-stu-id="5d96c-416">1792998845000</span></span>  |
| <span data-ttu-id="5d96c-417">parar</span><span class="sxs-lookup"><span data-stu-id="5d96c-417">stop</span></span>           | <span data-ttu-id="5d96c-418">1792998847084</span><span class="sxs-lookup"><span data-stu-id="5d96c-418">1792998847084</span></span>  |
| <span data-ttu-id="5d96c-419">freq</span><span class="sxs-lookup"><span data-stu-id="5d96c-419">freq</span></span>           | <span data-ttu-id="5d96c-420">3579545</span><span class="sxs-lookup"><span data-stu-id="5d96c-420">3579545</span></span>        |



 

<span data-ttu-id="5d96c-421">Usar QueryPerformanceCounter mede os tiques 2.840 agora.</span><span class="sxs-lookup"><span data-stu-id="5d96c-421">Using QueryPerformanceCounter measures 2,840 ticks now.</span></span> <span data-ttu-id="5d96c-422">Converter tiques em ciclos é o mesmo que já mostramos:</span><span class="sxs-lookup"><span data-stu-id="5d96c-422">Converting ticks to cycles is the same as we have already shown:</span></span>


```
# ticks  = (stop - start) = 1792998847084 - 1792998845000 = 2840 ticks
# cycles    = machine speed * number of ticks / QPF
# 6,900,000 = 2 GHz          * 2840           / 3,579,545
```



<span data-ttu-id="5d96c-423">Em outras palavras, leva cerca de 6,9 milhões ciclos neste computador de 2 GHz processar as chamadas de 1500 no loop de processamento.</span><span class="sxs-lookup"><span data-stu-id="5d96c-423">In other words, it takes about 6.9 million cycles on this 2 GHz machine to process the 1500 calls in the render loop.</span></span> <span data-ttu-id="5d96c-424">Dos ciclos de 6,9 milhões, a quantidade de tempo nas transições de modo é de aproximadamente 10K, então agora os resultados do perfil estão quase totalmente medindo o trabalho associado ao [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) e ao [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive).</span><span class="sxs-lookup"><span data-stu-id="5d96c-424">Of the 6.9 million cycles, the amount of time in the mode transitions is approximately 10k, so now the profile results are almost entirely measuring work associated with [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) and [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive).</span></span>

<span data-ttu-id="5d96c-425">Observe que o exemplo de código requer uma matriz de duas texturas.</span><span class="sxs-lookup"><span data-stu-id="5d96c-425">Notice that the code sample requires an array of two textures.</span></span> <span data-ttu-id="5d96c-426">Para evitar uma otimização de tempo de execução que removeria [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) se ele definir o mesmo ponteiro de textura sempre que for chamado, basta usar uma matriz de duas texturas.</span><span class="sxs-lookup"><span data-stu-id="5d96c-426">To avoid a runtime optimization that would remove [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) if it sets the same texture pointer every time it is called, simply use an array of two textures.</span></span> <span data-ttu-id="5d96c-427">Dessa forma, cada vez que passar pelo loop, o ponteiro de textura é alterado e o trabalho completo associado a **SetTexture** é executado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-427">That way, each time through the loop, the texture pointer changes, and the full work associated with **SetTexture** is performed.</span></span> <span data-ttu-id="5d96c-428">Certifique-se de que ambas as texturas sejam do mesmo tamanho e formato, para que nenhum outro Estado seja alterado quando a textura tiver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-428">Be sure that both textures are the same size and format, so that no other state will change when the texture does.</span></span>

<span data-ttu-id="5d96c-429">E agora você tem uma técnica para a criação de perfil do Direct3D.</span><span class="sxs-lookup"><span data-stu-id="5d96c-429">And now you have a technique for profiling Direct3D.</span></span> <span data-ttu-id="5d96c-430">Ele se baseia no contador de alto desempenho (QueryPerformanceCounter) para registrar o número de tiques que leva a CPU para processar o trabalho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-430">It relies on the high performance counter (QueryPerformanceCounter) to record the number of ticks it takes the CPU to process work.</span></span> <span data-ttu-id="5d96c-431">O trabalho é cuidadosamente controlado para ser o tempo de execução e o funcionamento do driver associados a chamadas de API usando o mecanismo de consulta.</span><span class="sxs-lookup"><span data-stu-id="5d96c-431">The work is carefully controlled to be the runtime and driver work associated with API calls using the query mechanism.</span></span> <span data-ttu-id="5d96c-432">Uma consulta fornece dois meios de controle: primeiro para esvaziar o buffer de comando antes do início da sequência de renderização e depois para retornar quando o trabalho da GPU for concluído.</span><span class="sxs-lookup"><span data-stu-id="5d96c-432">A query provides two means of control: first to empty the command buffer before the render sequence starts, and secondly to return when the GPU work is finished.</span></span>

<span data-ttu-id="5d96c-433">Até agora, este documento mostrou como criar um perfil de uma sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-433">So far, this paper has shown how to profile a render sequence.</span></span> <span data-ttu-id="5d96c-434">Cada sequência de renderização foi bem simples, contendo uma única chamada [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) e uma chamada [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) .</span><span class="sxs-lookup"><span data-stu-id="5d96c-434">Each render sequence has been fairly simple, containing a single [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) call and a [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) call.</span></span> <span data-ttu-id="5d96c-435">Isso foi feito para se concentrar no buffer de comandos e no uso do mecanismo de consulta para controlá-lo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-435">This was done to focus on the command buffer and the use of the query mechanism to control it.</span></span> <span data-ttu-id="5d96c-436">Aqui está um breve resumo de como criar um perfil de uma sequência de renderização arbitrária:</span><span class="sxs-lookup"><span data-stu-id="5d96c-436">Here is a brief summary of how to profile an arbitrary render sequence:</span></span>

-   <span data-ttu-id="5d96c-437">Use um contador de alto desempenho como o QueryPerformanceCounter para medir o tempo necessário para processar cada chamada à API.</span><span class="sxs-lookup"><span data-stu-id="5d96c-437">Use a high performance counter like QueryPerformanceCounter to measure the time it takes to process each API call.</span></span> <span data-ttu-id="5d96c-438">Use QueryPerformanceFrequency e a taxa de relógio da CPU para converter isso para o número de ciclos de CPU por chamada à API.</span><span class="sxs-lookup"><span data-stu-id="5d96c-438">Use QueryPerformanceFrequency and the CPU clock rate to convert this to the number of CPU cycles per API call.</span></span>
-   <span data-ttu-id="5d96c-439">Minimize a quantidade de trabalho de GPU renderizando listas de triângulo, onde cada triângulo contém um pixel.</span><span class="sxs-lookup"><span data-stu-id="5d96c-439">Minimize the amount of GPU work by rendering triangle lists, where each triangle contains one pixel.</span></span>
-   <span data-ttu-id="5d96c-440">Use o mecanismo de consulta para esvaziar o buffer de comando antes da sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-440">Use the query mechanism to empty the command buffer before the render sequence.</span></span> <span data-ttu-id="5d96c-441">Isso garante que a criação de perfil irá capturar a quantidade correta de tempo de execução e o trabalho de driver associados à sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-441">This guarantees that profiling will capturing the correct amount of runtime and driver work associated with the render sequence.</span></span>
-   <span data-ttu-id="5d96c-442">Controle a quantidade de trabalho adicionada ao buffer de comando com marcadores de eventos de consulta.</span><span class="sxs-lookup"><span data-stu-id="5d96c-442">Control the amount of work added to the command buffer with query event markers.</span></span> <span data-ttu-id="5d96c-443">Essa mesma consulta detecta quando a GPU conclui seu trabalho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-443">This same query detects when the GPU finishes its work.</span></span> <span data-ttu-id="5d96c-444">Como o trabalho de GPU é trivial, é praticamente equivalente a medir quando o trabalho do driver é concluído.</span><span class="sxs-lookup"><span data-stu-id="5d96c-444">Since the GPU work is trivial, this is virtually equivalent to measuring when the driver work is completed.</span></span>

<span data-ttu-id="5d96c-445">Todas essas técnicas são usadas para perfilar alterações de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-445">All of these techniques are used to profile state changes.</span></span> <span data-ttu-id="5d96c-446">Supondo que você leu e entendeu como controlar o buffer de comando e tenha concluído com êxito as medidas de linha de base em [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), você está pronto para adicionar alterações de estado às sequências de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-446">Assuming that you have read and understood how to control the command buffer, and have successfully completed baseline measurements on [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), you are ready to add state changes to your render sequences.</span></span> <span data-ttu-id="5d96c-447">Há alguns desafios de criação de perfil adicionais ao adicionar alterações de estado a uma sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-447">There are a few additional profiling challenges when adding state changes to a render sequence.</span></span> <span data-ttu-id="5d96c-448">Se você pretende adicionar alterações de estado às sequências de renderização, certifique-se de continuar na próxima seção.</span><span class="sxs-lookup"><span data-stu-id="5d96c-448">If you intend to add state changes to your render sequences, be sure to continue into the next section.</span></span>

## <a name="profiling-direct3d-state-changes"></a><span data-ttu-id="5d96c-449">Criando perfil de alterações de estado do Direct3D</span><span class="sxs-lookup"><span data-stu-id="5d96c-449">Profiling Direct3D State Changes</span></span>

<span data-ttu-id="5d96c-450">O Direct3D usa muitos Estados de renderização para controlar quase todos os aspectos do pipeline.</span><span class="sxs-lookup"><span data-stu-id="5d96c-450">Direct3D uses many render states to control almost every aspect of the pipeline.</span></span> <span data-ttu-id="5d96c-451">As APIs que causam alterações de estado incluem qualquer função ou método diferente das \* chamadas primitivas de desenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-451">The APIs that cause state changes include any function or method other than the Draw\*Primitive calls.</span></span>

<span data-ttu-id="5d96c-452">As alterações de estado são complicadas porque talvez você não consiga ver o custo de uma alteração de estado sem renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-452">State changes are tricky because you may not be able to see the cost of a state change without rendering.</span></span> <span data-ttu-id="5d96c-453">Isso é resultado do algoritmo lento que o driver e a GPU usam para adiar o trabalho até que absolutamente precise ser feito.</span><span class="sxs-lookup"><span data-stu-id="5d96c-453">This is a result of the lazy algorithm that the driver and the GPU use to defer work until it absolutely has to be done.</span></span> <span data-ttu-id="5d96c-454">Em geral, você deve seguir estas etapas para medir uma alteração de estado único:</span><span class="sxs-lookup"><span data-stu-id="5d96c-454">In general, you should follow these steps to measure a single state change:</span></span>

1.  <span data-ttu-id="5d96c-455">Perfil [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) primeiro.</span><span class="sxs-lookup"><span data-stu-id="5d96c-455">Profile [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) first.</span></span>
2.  <span data-ttu-id="5d96c-456">Adicione uma alteração de estado à sequência de renderização e o perfil da nova sequência.</span><span class="sxs-lookup"><span data-stu-id="5d96c-456">Add one state change to the render sequence and profile the new sequence.</span></span>
3.  <span data-ttu-id="5d96c-457">Subtraia a diferença entre as duas sequências para obter o custo da alteração de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-457">Subtract the difference between the two sequences to get the cost of the state change.</span></span>

<span data-ttu-id="5d96c-458">Naturalmente, tudo o que você aprendeu sobre o uso do mecanismo de consulta e a colocação da sequência de renderização em um loop para negar o custo da transição de modo ainda se aplica.</span><span class="sxs-lookup"><span data-stu-id="5d96c-458">Naturally, everything you have learned about using the query mechanism and putting the render sequence in a loop to negate the cost of the mode transition still applies.</span></span>

### <a name="profiling-a-simple-state-change"></a><span data-ttu-id="5d96c-459">Criação de perfil de uma alteração de estado simples</span><span class="sxs-lookup"><span data-stu-id="5d96c-459">Profiling a Simple State Change</span></span>

<span data-ttu-id="5d96c-460">Começando com uma sequência de renderização que contém [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), aqui está a sequência de código para medir o custo de adição de [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture):</span><span class="sxs-lookup"><span data-stu-id="5d96c-460">Starting with a render sequence that contains [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), here is the code sequence for measuring the cost of adding [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture):</span></span>


```
// Get the start counter value as shown in Example 4 

// Initialize a texture array as shown in Example 4
IDirect3DTexture* texArray[2];

// Render sequence loop 
for(int i = 0; i < 1500; i++)
{
  SetTexture(0, texArray[i%2];
  
  // Force the state change to propagate to the GPU
  DrawPrimitive(D3DPT_TRIANGLELIST, i*3, 1);
}

// Get the stop counter value as shown in Example 4 
```



<span data-ttu-id="5d96c-461">Exemplo 5: medindo uma chamada à API de alteração de estado</span><span class="sxs-lookup"><span data-stu-id="5d96c-461">Example 5: Measuring One State Change API Call</span></span>

<span data-ttu-id="5d96c-462">Observe que o loop contém duas chamadas, [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) e [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive).</span><span class="sxs-lookup"><span data-stu-id="5d96c-462">Notice that the loop contains two calls, [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) and [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive).</span></span> <span data-ttu-id="5d96c-463">Os loops de sequência de renderização 1500 vezes e geram resultados semelhantes a estes:</span><span class="sxs-lookup"><span data-stu-id="5d96c-463">The render sequence loops 1500 times and generates results similar to these:</span></span>



| <span data-ttu-id="5d96c-464">Variável Local</span><span class="sxs-lookup"><span data-stu-id="5d96c-464">Local Variable</span></span> | <span data-ttu-id="5d96c-465">Número de TICs</span><span class="sxs-lookup"><span data-stu-id="5d96c-465">Number of Tics</span></span> |
|----------------|----------------|
| <span data-ttu-id="5d96c-466">iniciar</span><span class="sxs-lookup"><span data-stu-id="5d96c-466">start</span></span>          | <span data-ttu-id="5d96c-467">1792998860000</span><span class="sxs-lookup"><span data-stu-id="5d96c-467">1792998860000</span></span>  |
| <span data-ttu-id="5d96c-468">parar</span><span class="sxs-lookup"><span data-stu-id="5d96c-468">stop</span></span>           | <span data-ttu-id="5d96c-469">1792998870260</span><span class="sxs-lookup"><span data-stu-id="5d96c-469">1792998870260</span></span>  |
| <span data-ttu-id="5d96c-470">freq</span><span class="sxs-lookup"><span data-stu-id="5d96c-470">freq</span></span>           | <span data-ttu-id="5d96c-471">3579545</span><span class="sxs-lookup"><span data-stu-id="5d96c-471">3579545</span></span>        |



 

<span data-ttu-id="5d96c-472">A conversão de tiques em ciclos novamente resulta em:</span><span class="sxs-lookup"><span data-stu-id="5d96c-472">Converting ticks to cycles once again yields:</span></span>


```
# ticks  = (stop - start) = 1792998870260 - 1792998860000 = 10,260 ticks
# cycles    = machine speed * number of ticks / QPF
5,775,000   = 2 GHz          * 10,260         / 3,579,545
```



<span data-ttu-id="5d96c-473">A divisão pelo número de iterações no loop produz:</span><span class="sxs-lookup"><span data-stu-id="5d96c-473">Dividing by the number of iterations in the loop yields:</span></span>


```
5,775,000 cycles / 1500 iterations = 3850 cycles for one iteration
```



<span data-ttu-id="5d96c-474">Cada iteração do loop contém uma alteração de estado e uma chamada de desenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-474">Each iteration of the loop contains a state change and a draw call.</span></span> <span data-ttu-id="5d96c-475">Subtrair o resultado da sequência de renderização [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) deixa:</span><span class="sxs-lookup"><span data-stu-id="5d96c-475">Subtracting out the result of the [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) render sequence leaves:</span></span>


```
3850 - 1100 = 2750 cycles for SetTexture
```



<span data-ttu-id="5d96c-476">Este é o número médio de ciclos para adicionar [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) a essa sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-476">This is the average number of cycles to add [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) to this render sequence.</span></span> <span data-ttu-id="5d96c-477">Essa mesma técnica pode ser aplicada a outras alterações de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-477">This same technique can be applied to other state changes.</span></span>

<span data-ttu-id="5d96c-478">Por que [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) é chamada de alteração de estado simples?</span><span class="sxs-lookup"><span data-stu-id="5d96c-478">Why is [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) called a simple state change?</span></span> <span data-ttu-id="5d96c-479">Como o estado que está sendo definido é restrito para que o pipeline faça a mesma quantidade de trabalho sempre que o estado for alterado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-479">Because the state that is being set is constrained so that the pipeline does the same amount of work each time the state is changed.</span></span> <span data-ttu-id="5d96c-480">Restringir ambas as texturas ao mesmo tamanho e formato garante a mesma quantidade de trabalho para cada chamada **SetTexture** .</span><span class="sxs-lookup"><span data-stu-id="5d96c-480">Constraining both textures to the same size and format assures the same amount of work for each **SetTexture** call.</span></span>

### <a name="profiling-a-state-change-that-needs-to-be-toggled"></a><span data-ttu-id="5d96c-481">Criação de perfil de uma alteração de estado que precisa ser alternada</span><span class="sxs-lookup"><span data-stu-id="5d96c-481">Profiling a State Change that Needs to Be Toggled</span></span>

<span data-ttu-id="5d96c-482">Há outras alterações de estado que fazem com que a quantidade de trabalho executada pelo pipeline de gráficos seja alterada para cada iteração do loop de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-482">There are other state changes that cause the amount of work performed by the graphics pipeline to change for every iteration of the render loop.</span></span> <span data-ttu-id="5d96c-483">Por exemplo, se o teste z estiver habilitado, cada cor de pixel atualizará um destino de renderização somente depois que o valor z do novo pixel for testado em relação ao valor z do pixel existente.</span><span class="sxs-lookup"><span data-stu-id="5d96c-483">For example, if z-testing is enabled, each pixel color updates a render target only after the new pixel's z value is tested against the z-value for the existing pixel.</span></span> <span data-ttu-id="5d96c-484">Se o teste z estiver desabilitado, esse teste por pixel não será feito e a saída será gravada muito mais rapidamente.</span><span class="sxs-lookup"><span data-stu-id="5d96c-484">If z-testing is disabled, this per-pixel test is not done and the output is written much faster.</span></span> <span data-ttu-id="5d96c-485">Habilitar ou desabilitar o estado de teste z altera drasticamente a quantidade de trabalho realizado (pela CPU, bem como a GPU) durante a renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-485">Enabling or disabling the z-test state dramatically changes the amount of work done (by the CPU as well as the GPU) during rendering.</span></span>

<span data-ttu-id="5d96c-486">[**Setrenderingstate**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate) requer um estado de renderização específico e um valor de estado para habilitar ou desabilitar o teste de z.</span><span class="sxs-lookup"><span data-stu-id="5d96c-486">[**SetRenderState**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate) requires a particular render state and a state value to enable or disable z-testing.</span></span> <span data-ttu-id="5d96c-487">O valor de estado específico é avaliado em tempo de execução para determinar a quantidade de trabalho necessária.</span><span class="sxs-lookup"><span data-stu-id="5d96c-487">The particular state value is evaluated at runtime to determine how much work is necessary.</span></span> <span data-ttu-id="5d96c-488">É difícil medir essa alteração de estado em um loop de renderização e ainda precondicionar o estado do pipeline para que ele alterne.</span><span class="sxs-lookup"><span data-stu-id="5d96c-488">It is difficult to measure this state change in a render loop and still precondition the pipeline state so that it switches.</span></span> <span data-ttu-id="5d96c-489">A única solução é alternar a alteração de estado durante a sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-489">The only solution is to toggle the state change during the render sequence.</span></span>

<span data-ttu-id="5d96c-490">Por exemplo, a técnica de criação de perfil precisa ser repetida duas vezes, da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="5d96c-490">For example, the profiling technique needs to be repeated twice as follows:</span></span>

1.  <span data-ttu-id="5d96c-491">Comece pela criação de perfil da sequência de renderização [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) .</span><span class="sxs-lookup"><span data-stu-id="5d96c-491">Start by profiling the [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) render sequence.</span></span> <span data-ttu-id="5d96c-492">Chame essa linha de base.</span><span class="sxs-lookup"><span data-stu-id="5d96c-492">Call this the baseline.</span></span>
2.  <span data-ttu-id="5d96c-493">Perfil uma segunda sequência de renderização que alterna a alteração de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-493">Profile a second render sequence that toggles the state change.</span></span> <span data-ttu-id="5d96c-494">O loop de sequência de renderização contém:</span><span class="sxs-lookup"><span data-stu-id="5d96c-494">The render sequence loop contains:</span></span>
    -   <span data-ttu-id="5d96c-495">Uma alteração de estado para definir o estado em uma condição "false".</span><span class="sxs-lookup"><span data-stu-id="5d96c-495">A state change to set the state into a "false" condition.</span></span>
    -   <span data-ttu-id="5d96c-496">[**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) assim como a sequência original.</span><span class="sxs-lookup"><span data-stu-id="5d96c-496">[**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) just like the original sequence.</span></span>
    -   <span data-ttu-id="5d96c-497">Uma alteração de estado para definir o estado em uma condição "true".</span><span class="sxs-lookup"><span data-stu-id="5d96c-497">A state change to set the state into a "true" condition.</span></span>
    -   <span data-ttu-id="5d96c-498">Um segundo [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) para forçar que a segunda alteração de estado seja realizada.</span><span class="sxs-lookup"><span data-stu-id="5d96c-498">A second [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) to force the second state change to be realized.</span></span>
3.  <span data-ttu-id="5d96c-499">Localize a diferença entre as duas sequências de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-499">Find the difference between the two render sequences.</span></span> <span data-ttu-id="5d96c-500">Isso é feito por:</span><span class="sxs-lookup"><span data-stu-id="5d96c-500">This is done by:</span></span>
    -   <span data-ttu-id="5d96c-501">Multiplique a sequência [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) de linha de base por 2 porque há duas chamadas **DrawPrimitive** na nova sequência.</span><span class="sxs-lookup"><span data-stu-id="5d96c-501">Multiply the baseline [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) sequence by 2 because there are two **DrawPrimitive** calls in the new sequence.</span></span>
    -   <span data-ttu-id="5d96c-502">Subtraia o resultado da nova sequência da sequência original.</span><span class="sxs-lookup"><span data-stu-id="5d96c-502">Subtract the result of the new sequence from the original sequence.</span></span>
    -   <span data-ttu-id="5d96c-503">Divida o resultado por 2 para obter o custo médio das alterações de estado "false" e "true".</span><span class="sxs-lookup"><span data-stu-id="5d96c-503">Divide the result by 2 to get the average cost of both the "false" and the "true" state change.</span></span>

<span data-ttu-id="5d96c-504">Com a técnica de loop usada na sequência de renderização, o custo da alteração do estado do pipeline precisa ser medido alternando o estado de um "verdadeiro" para uma condição "false" e vice-versa, para cada iteração na sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-504">With the looping technique used in the render sequence, the cost of changing pipeline state needs to be measured by toggling the state from a "true" to a "false" condition and vice versa, for each iteration in the render sequence.</span></span> <span data-ttu-id="5d96c-505">O significado de "true" e "false" aqui não são literais, isso simplesmente significa que o estado precisa ser definido em condições opostas.</span><span class="sxs-lookup"><span data-stu-id="5d96c-505">The meaning of "true" and "false" here are not literal, this simply means that the state needs to be set into opposing conditions.</span></span> <span data-ttu-id="5d96c-506">Isso faz com que ambas as alterações de estado sejam medidas durante a criação de perfil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-506">This causes both state changes to be measured during profiling.</span></span> <span data-ttu-id="5d96c-507">É claro que tudo o que você aprendeu a usar o mecanismo de consulta e colocar a sequência de renderização em um loop para negar o custo da transição de modo ainda se aplica.</span><span class="sxs-lookup"><span data-stu-id="5d96c-507">Of course everything you have learned about using the query mechanism and putting the render sequence in a loop to negate the cost of the mode transition still applies.</span></span>

<span data-ttu-id="5d96c-508">Por exemplo, aqui está a sequência de código para medir o custo de ativação ou desativação do teste de z:</span><span class="sxs-lookup"><span data-stu-id="5d96c-508">For example, here is the code sequence for measuring the cost of toggling z-testing on or off:</span></span>


```
// Get the start counter value as shown in Example 4 

// Add a loop to the render sequence 
for(int i = 0; i < 1500; i++)
{
  // Precondition the pipeline state to the "false" condition
  SetRenderState(D3DRS_ZENABLE, FALSE);
  
  // Force the state change to propagate to the GPU
  DrawPrimitive(D3DPT_TRIANGLELIST, (2*i + 0)*3, 1);

  // Set the pipeline state to the "true" condition
  SetRenderState(D3DRS_ZENABLE, TRUE);

  // Force the state change to propagate to the GPU
  DrawPrimitive(D3DPT_TRIANGLELIST, (2*i + 1)*3, 1); 
}

// Get the stop counter value as shown in Example 4 
```



<span data-ttu-id="5d96c-509">Exemplo 5: medindo uma alteração de estado de alternância</span><span class="sxs-lookup"><span data-stu-id="5d96c-509">Example 5: Measuring a Toggling State Change</span></span>

<span data-ttu-id="5d96c-510">O loop alterna o estado executando duas chamadas [**Setrenderingstate**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate) .</span><span class="sxs-lookup"><span data-stu-id="5d96c-510">The loop toggles the state by executing two [**SetRenderState**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate) calls.</span></span> <span data-ttu-id="5d96c-511">A primeira chamada **Setrenderingstate** desabilita o teste z e o segundo **setrenderingstate** habilita o teste de z.</span><span class="sxs-lookup"><span data-stu-id="5d96c-511">The first **SetRenderState** call disables z-testing and the second **SetRenderState** enables z-testing.</span></span> <span data-ttu-id="5d96c-512">Cada **Setrenderingstate** é seguido por [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) para que o trabalho associado à alteração de estado seja processado pelo driver em vez de definir apenas um bit sujo no driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-512">Each **SetRenderState** is followed by [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) so that the work associated with the state change is processed by the driver instead of only setting a dirty bit in the driver.</span></span>

<span data-ttu-id="5d96c-513">Esses números são razoáveis para essa sequência de renderização:</span><span class="sxs-lookup"><span data-stu-id="5d96c-513">These numbers are reasonable for this render sequence:</span></span>



| <span data-ttu-id="5d96c-514">Variável Local</span><span class="sxs-lookup"><span data-stu-id="5d96c-514">Local Variable</span></span> | <span data-ttu-id="5d96c-515">Número de tiques</span><span class="sxs-lookup"><span data-stu-id="5d96c-515">Number of Ticks</span></span> |
|----------------|-----------------|
| <span data-ttu-id="5d96c-516">iniciar</span><span class="sxs-lookup"><span data-stu-id="5d96c-516">start</span></span>          | <span data-ttu-id="5d96c-517">1792998845000</span><span class="sxs-lookup"><span data-stu-id="5d96c-517">1792998845000</span></span>   |
| <span data-ttu-id="5d96c-518">parar</span><span class="sxs-lookup"><span data-stu-id="5d96c-518">stop</span></span>           | <span data-ttu-id="5d96c-519">1792998861740</span><span class="sxs-lookup"><span data-stu-id="5d96c-519">1792998861740</span></span>   |
| <span data-ttu-id="5d96c-520">freq</span><span class="sxs-lookup"><span data-stu-id="5d96c-520">freq</span></span>           | <span data-ttu-id="5d96c-521">3579545</span><span class="sxs-lookup"><span data-stu-id="5d96c-521">3579545</span></span>         |



 

<span data-ttu-id="5d96c-522">A conversão de tiques em ciclos novamente resulta em:</span><span class="sxs-lookup"><span data-stu-id="5d96c-522">Converting ticks to cycles once again yields:</span></span>


```
# ticks  = (stop - start) = 1792998861740 - 1792998845000 = 15,120 ticks
# cycles    = machine speed * number of ticks / QPF
 9,300,000  = 2 GHz          * 16,740         / 3,579,545
```



<span data-ttu-id="5d96c-523">A divisão pelo número de iterações no loop produz:</span><span class="sxs-lookup"><span data-stu-id="5d96c-523">Dividing by the number of iterations in the loop yields:</span></span>


```
9,300,000 cycles / 1500 iterations = 6200 cycles for one iteration
```



<span data-ttu-id="5d96c-524">Cada iteração do loop contém duas alterações de estado e duas chamadas de desenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-524">Each iteration of the loop contains two state changes and two draw calls.</span></span> <span data-ttu-id="5d96c-525">Subtrair as chamadas Draw (supondo 1100 ciclos) deixa:</span><span class="sxs-lookup"><span data-stu-id="5d96c-525">Subtracting out the draw calls (assuming 1100 cycles) leaves:</span></span>


```
6200 - 1100 - 1100 = 4000 cycles for both state changes
```



<span data-ttu-id="5d96c-526">Este é o número médio de ciclos para ambas as alterações de estado, portanto, o tempo médio para cada alteração de estado é:</span><span class="sxs-lookup"><span data-stu-id="5d96c-526">This is the average number of cycles for both state changes so the average time for each state change is:</span></span>


```
4000 / 2  = 2000 cycles for each state change
```



<span data-ttu-id="5d96c-527">Portanto, o número médio de ciclos para habilitar ou desabilitar o teste de z é de 2000 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-527">Therefore, the average number of cycles to enable or disable z-testing is 2000 cycles.</span></span> <span data-ttu-id="5d96c-528">Vale a pena observar que o QueryPerformanceCounter está medindo o z-Enable time e z-Disable na metade do tempo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-528">It is worth noting that QueryPerformanceCounter is measuring z-enable half the time and z-disable half of the time.</span></span> <span data-ttu-id="5d96c-529">Na verdade, essa técnica mede a média de ambas as alterações de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-529">This technique actually measures the average of both state changes.</span></span> <span data-ttu-id="5d96c-530">Em outras palavras, você está medindo o tempo de alternância de um estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-530">In other words, you are measuring the time to toggle a state.</span></span> <span data-ttu-id="5d96c-531">Usando essa técnica, você não tem como saber se os tempos de habilitação e desabilitação são equivalentes, já que você mediu a média de ambos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-531">Using this technique, you have no way of knowing if the enable and disable times are equivalent since you have measured the average of both of them.</span></span> <span data-ttu-id="5d96c-532">No entanto, esse é um número razoável para usar ao orçar um estado de alternância, pois um aplicativo que causa essa alteração de estado só pode fazer isso alternando esse estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-532">Nevertheless, this is a reasonable number to use when budgeting a toggling state as an application that causes this state change can only do so by toggling this state.</span></span>

<span data-ttu-id="5d96c-533">Agora, você pode aplicar essas técnicas e criar o perfil de todas as alterações de estado desejadas, certo?</span><span class="sxs-lookup"><span data-stu-id="5d96c-533">So now you can apply these techniques and profile all the state changes you want, right?</span></span> <span data-ttu-id="5d96c-534">Não exatamente.</span><span class="sxs-lookup"><span data-stu-id="5d96c-534">Not quite.</span></span> <span data-ttu-id="5d96c-535">Você ainda precisa ter cuidado com as otimizações projetadas para reduzir a quantidade de trabalho que precisa ser feito.</span><span class="sxs-lookup"><span data-stu-id="5d96c-535">You still need to be careful about optimizations that are designed to reduce the amount of work that needs to be done.</span></span> <span data-ttu-id="5d96c-536">Há dois tipos de otimizações que você deve estar atento ao projetar suas sequências de processamento.</span><span class="sxs-lookup"><span data-stu-id="5d96c-536">There are two types of optimizations that you should be aware of when designing your render sequences.</span></span>

### <a name="watch-out-for-state-change-optimizations"></a><span data-ttu-id="5d96c-537">Tome cuidado com as otimizações de alteração de estado</span><span class="sxs-lookup"><span data-stu-id="5d96c-537">Watch Out for State Change Optimizations</span></span>

<span data-ttu-id="5d96c-538">A seção anterior mostra como criar o perfil dos dois tipos de alterações de Estado: uma alteração de estado simples que é restrita para gerar a mesma quantidade de trabalho para cada iteração e uma alteração de estado de alternância que altera drasticamente a quantidade de trabalho realizado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-538">The previous section show how to profile both kinds of state changes: a simple state change that is constrained to generate the same amount of work for each iteration, and a toggling state change that dramatically changes the amount of work done.</span></span> <span data-ttu-id="5d96c-539">O que acontece se você usar a sequência de renderização anterior e adicionar outra alteração de estado a ela?</span><span class="sxs-lookup"><span data-stu-id="5d96c-539">What happens if you take the previous render sequence and add another state change to it?</span></span> <span data-ttu-id="5d96c-540">Por exemplo, ele usa a sequência de renderização z>-Enable e adiciona uma comparação z-Func a ela:</span><span class="sxs-lookup"><span data-stu-id="5d96c-540">For instance, this example takes the z>-enable render sequence and adds a z-func comparison to it:</span></span>


```
// Add a loop to the render sequence 
for(int i = 0; i < 1500; i++)
{
  // Precondition the pipeline state to the opposite condition
  SetRenderState(D3DRS_ZFUNC, D3DCMP_NEVER);

  // Precondition the pipeline state to the opposite condition
  SetRenderState(D3DRS_ZENABLE, FALSE);
  
  // Force the state change to propagate to the GPU
  DrawPrimitive(D3DPT_TRIANGLELIST, (2*i + 0)*3, 1);

  // Now set the state change you want to measure
  SetRenderState(D3DRS_ZFUNC, D3DCMP_ALWAYS);

  // Now set the state change you want to measure
  SetRenderState(D3DRS_ZENABLE, TRUE);

  // Force the state change to propagate to the GPU
  DrawPrimitive(D3DPT_TRIANGLELIST, (2*i + 1)*3, 1); 
}
```



<span data-ttu-id="5d96c-541">O estado z-Func define o nível de comparação ao gravar no buffer z (entre o valor z de um pixel atual com o valor z de um pixel no buffer de profundidade).</span><span class="sxs-lookup"><span data-stu-id="5d96c-541">The z-func state sets the comparison level when writing to the z-buffer (between the z-value of a current pixel with the z-value of a pixel in the depth buffer).</span></span> <span data-ttu-id="5d96c-542">D3DCMP \_ nunca desativa a comparação de testes de z enquanto \_ o D3DCMP sempre define a comparação para acontecer sempre que o teste z for concluído.</span><span class="sxs-lookup"><span data-stu-id="5d96c-542">D3DCMP\_NEVER turns off the z-testing comparison while D3DCMP\_ALWAYS sets the comparison to happen every time z-testing is done.</span></span>

<span data-ttu-id="5d96c-543">A criação de perfil de uma dessas alterações de estado em uma sequência de renderização com [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) gera resultados semelhantes a estes:</span><span class="sxs-lookup"><span data-stu-id="5d96c-543">Profiling either one of these state changes in a render sequence with [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) generates results similar to these:</span></span>



| <span data-ttu-id="5d96c-544">Alteração de estado único</span><span class="sxs-lookup"><span data-stu-id="5d96c-544">Single State Change</span></span> | <span data-ttu-id="5d96c-545">Número médio de ciclos</span><span class="sxs-lookup"><span data-stu-id="5d96c-545">Average Number of Cycles</span></span> |
|---------------------|--------------------------|
| <span data-ttu-id="5d96c-546">\_Somente D3DRS ZENABLE</span><span class="sxs-lookup"><span data-stu-id="5d96c-546">D3DRS\_ZENABLE only</span></span> | <span data-ttu-id="5d96c-547">2000</span><span class="sxs-lookup"><span data-stu-id="5d96c-547">2000</span></span>                     |



 

<span data-ttu-id="5d96c-548">ou</span><span class="sxs-lookup"><span data-stu-id="5d96c-548">or</span></span>



| <span data-ttu-id="5d96c-549">Alteração de estado único</span><span class="sxs-lookup"><span data-stu-id="5d96c-549">Single State Change</span></span> | <span data-ttu-id="5d96c-550">Número médio de ciclos</span><span class="sxs-lookup"><span data-stu-id="5d96c-550">Average Number of Cycles</span></span> |
|---------------------|--------------------------|
| <span data-ttu-id="5d96c-551">\_Somente D3DRS ZFUNC</span><span class="sxs-lookup"><span data-stu-id="5d96c-551">D3DRS\_ZFUNC only</span></span>   | <span data-ttu-id="5d96c-552">600</span><span class="sxs-lookup"><span data-stu-id="5d96c-552">600</span></span>                      |



 

<span data-ttu-id="5d96c-553">Mas, se você criar o perfil de D3DRS \_ ZENABLE e D3DRS \_ ZFUNC na mesma sequência de renderização, poderá ver resultados como estes:</span><span class="sxs-lookup"><span data-stu-id="5d96c-553">But, if you profile both D3DRS\_ZENABLE and D3DRS\_ZFUNC in the same render sequence you could see results like these:</span></span>



| <span data-ttu-id="5d96c-554">Ambas as alterações de estado</span><span class="sxs-lookup"><span data-stu-id="5d96c-554">Both State Changes</span></span>            | <span data-ttu-id="5d96c-555">Número médio de ciclos</span><span class="sxs-lookup"><span data-stu-id="5d96c-555">Average Number of Cycles</span></span> |
|-------------------------------|--------------------------|
| <span data-ttu-id="5d96c-556">D3DRS \_ ZENABLE + D3DRS \_ ZFUNC</span><span class="sxs-lookup"><span data-stu-id="5d96c-556">D3DRS\_ZENABLE + D3DRS\_ZFUNC</span></span> | <span data-ttu-id="5d96c-557">2000</span><span class="sxs-lookup"><span data-stu-id="5d96c-557">2000</span></span>                     |



 

<span data-ttu-id="5d96c-558">Você pode esperar que o resultado seja a soma dos ciclos 2000 e 600 (ou 2600), pois o driver está fazendo todo o trabalho associado à configuração de ambos os Estados de processamento.</span><span class="sxs-lookup"><span data-stu-id="5d96c-558">You could expect the result to be to be the sum of 2000 and 600 (or 2600) cycles because the driver is doing all the work associated with setting both render states.</span></span> <span data-ttu-id="5d96c-559">Em vez disso, a média é de 2000 ciclos.</span><span class="sxs-lookup"><span data-stu-id="5d96c-559">Instead, the average is 2000 cycles.</span></span>

<span data-ttu-id="5d96c-560">Esse resultado reflete uma otimização de alteração de estado implementada no tempo de execução, o driver ou a GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-560">This result reflects a state change optimization implemented in the runtime, the driver, or the GPU.</span></span> <span data-ttu-id="5d96c-561">Nesse caso, o driver poderia ver o primeiro [**Setprocessstate**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate) e definir um estado sujo que adiaria o trabalho até mais tarde.</span><span class="sxs-lookup"><span data-stu-id="5d96c-561">In this case, the driver could see the first [**SetRenderState**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate) and set a dirty state which would postpone the work until later.</span></span> <span data-ttu-id="5d96c-562">Quando o driver vê o segundo **Setrenderingstate**, o mesmo estado sujo pode ser definido com redundância e o mesmo trabalho seria adiado mais uma vez.</span><span class="sxs-lookup"><span data-stu-id="5d96c-562">When the driver sees the second **SetRenderState**, the same dirty state could be redundantly set and the same work would be postponed once again.</span></span> <span data-ttu-id="5d96c-563">Quando [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) é chamado, o trabalho associado ao estado sujo é finalmente processado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-563">When [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) is called, the work associated with the dirty state is finally processed.</span></span> <span data-ttu-id="5d96c-564">O driver executa o trabalho uma vez, o que significa que as duas primeiras alterações de estado são efetivamente consolidadas pelo driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-564">The driver executes the work one time, which means that the first two state changes are effectively consolidated by the driver.</span></span> <span data-ttu-id="5d96c-565">Da mesma forma, as terceira e quarta alterações de estado são efetivamente consolidadas pelo driver em uma única alteração de estado quando o segundo **DrawPrimitive** é chamado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-565">Similarly, the third and fourth state changes are effectively consolidated by the driver into a single state change when the second **DrawPrimitive** is called.</span></span> <span data-ttu-id="5d96c-566">O resultado líquido é que o driver e a GPU processam uma única alteração de estado para cada chamada de desenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-566">The net result is that the driver and the GPU process a single state change for each draw call.</span></span>

<span data-ttu-id="5d96c-567">Esse é um bom exemplo de otimização de driver dependente de sequência.</span><span class="sxs-lookup"><span data-stu-id="5d96c-567">This is a good example of a sequence-dependent driver optimization.</span></span> <span data-ttu-id="5d96c-568">O driver adie o trabalho duas vezes definindo um estado sujo e, em seguida, executou o trabalho uma vez para limpar o estado sujo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-568">The driver postponed work twice by setting a dirty state, and then performed the work once to clear the dirty state.</span></span> <span data-ttu-id="5d96c-569">Esse é um bom exemplo do tipo de aperfeiçoamento de eficiência que pode ocorrer quando o trabalho é adiado até que seja absolutamente necessário.</span><span class="sxs-lookup"><span data-stu-id="5d96c-569">This is a good example of the kind of efficiency improvement that can take place when work is deferred until absolutely necessary.</span></span>

<span data-ttu-id="5d96c-570">Como você sabe quais alterações de Estado definem um estado sujo internamente e, portanto, adiam o trabalho até mais tarde?</span><span class="sxs-lookup"><span data-stu-id="5d96c-570">How do you know which state changes set a dirty state internally and therefore postpone work until later?</span></span> <span data-ttu-id="5d96c-571">Apenas testando sequências de renderização (ou conversando com os gravadores de driver).</span><span class="sxs-lookup"><span data-stu-id="5d96c-571">Only by testing render sequences (or talking to driver writers).</span></span> <span data-ttu-id="5d96c-572">Os drivers são atualizados e aprimorados periodicamente para que a lista de otimizações não seja estática.</span><span class="sxs-lookup"><span data-stu-id="5d96c-572">Drivers are updated and improved periodically so the list of optimizations is not static.</span></span> <span data-ttu-id="5d96c-573">Há apenas uma maneira de saber absolutamente o que os custos de alteração de estado em uma determinada sequência de renderização, em um determinado conjunto de hardwares; e isso é para medir.</span><span class="sxs-lookup"><span data-stu-id="5d96c-573">There is only one way to absolutely know what a state change costs in a given render sequence, on a particular set of hardware; and that is to measure it.</span></span>

### <a name="watch-out-for-drawprimitive-optimizations"></a><span data-ttu-id="5d96c-574">Tome cuidado com otimizações de DrawPrimitive</span><span class="sxs-lookup"><span data-stu-id="5d96c-574">Watch Out for DrawPrimitive Optimizations</span></span>

<span data-ttu-id="5d96c-575">Além das otimizações de alteração de estado, o tempo de execução tentará otimizar o número de chamadas de desenho que o driver precisa processar.</span><span class="sxs-lookup"><span data-stu-id="5d96c-575">In addition to state change optimizations, the runtime will attempt to optimize the number of draw calls that the driver has to process.</span></span> <span data-ttu-id="5d96c-576">Por exemplo, considere isso voltar para retornar chamadas de desenho:</span><span class="sxs-lookup"><span data-stu-id="5d96c-576">For example, consider these back to back draw calls:</span></span>


```
DrawPrimitive(D3DPT_TRIANGLELIST, 0, 3); // Draw 3 primitives, vertices 0 - 8
DrawPrimitive(D3DPT_TRIANGLELIST, 9, 4); // Draw 4 primitives, vertices 9 - 20
```



<span data-ttu-id="5d96c-577">Exemplo 5a: duas chamadas de desenho</span><span class="sxs-lookup"><span data-stu-id="5d96c-577">Example 5a: Two Draw Calls</span></span>

<span data-ttu-id="5d96c-578">Essa sequência contém duas chamadas Draw, que o tempo de execução consolidará em uma única chamada equivalente a:</span><span class="sxs-lookup"><span data-stu-id="5d96c-578">This sequence contains two draw calls, which the runtime will consolidate into a single call equivalent to:</span></span>


```
DrawPrimitive(D3DPT_TRIANGLELIST, 0, 7); // Draw 7 primitives, vertices 0 - 20
```



<span data-ttu-id="5d96c-579">Exemplo 5b: uma única chamada de desenho concatenada</span><span class="sxs-lookup"><span data-stu-id="5d96c-579">Example 5b: A Single Concatenated Draw Call</span></span>

<span data-ttu-id="5d96c-580">O tempo de execução concatenará essas chamadas de desenho específicas em uma única chamada, o que reduz o funcionamento do driver em 50% porque o driver agora precisará processar apenas uma chamada de desenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-580">The runtime will concatenate both of these particular draw calls into a single call, which reduces the driver work by 50 percent because the driver will now only need to process one draw call.</span></span>

<span data-ttu-id="5d96c-581">Em geral, o tempo de execução concatena duas ou mais chamadas [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) de back-to-back quando:</span><span class="sxs-lookup"><span data-stu-id="5d96c-581">In general, the runtime will concatenate two or more back-to-back [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) calls when:</span></span>

1.  <span data-ttu-id="5d96c-582">O tipo primitivo é uma lista de triângulo (D3DPT \_ TRIângulolist).</span><span class="sxs-lookup"><span data-stu-id="5d96c-582">The primitive type is a triangle list (D3DPT\_TRIANGLELIST).</span></span>
2.  <span data-ttu-id="5d96c-583">Cada chamada de [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) sucessiva deve referenciar vértices consecutivos dentro do buffer de vértice.</span><span class="sxs-lookup"><span data-stu-id="5d96c-583">Each successive [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) call must reference consecutive vertices within the vertex buffer.</span></span>

<span data-ttu-id="5d96c-584">Da mesma forma, as condições certas para concatenar duas ou mais chamadas [**DrawIndexedPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive) de back-to-back são:</span><span class="sxs-lookup"><span data-stu-id="5d96c-584">Similarly, the right conditions for concatenating two or more back-to-back [**DrawIndexedPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive) calls are:</span></span>

1.  <span data-ttu-id="5d96c-585">O tipo primitivo é uma lista de triângulo (D3DPT \_ TRIângulolist).</span><span class="sxs-lookup"><span data-stu-id="5d96c-585">The primitive type is a triangle list (D3DPT\_TRIANGLELIST).</span></span>
2.  <span data-ttu-id="5d96c-586">Cada chamada de [**DrawIndexedPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive) sucessiva deve fazer referência sequencial de índices consecutivos dentro do buffer de índice.</span><span class="sxs-lookup"><span data-stu-id="5d96c-586">Each successive [**DrawIndexedPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive) call must sequential reference consecutive indices within the index buffer.</span></span>
3.  <span data-ttu-id="5d96c-587">Cada chamada de [**DrawIndexedPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive) sucessiva deve usar o mesmo valor para BaseVertexIndex.</span><span class="sxs-lookup"><span data-stu-id="5d96c-587">Each successive [**DrawIndexedPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive) call must use the same value for BaseVertexIndex.</span></span>

<span data-ttu-id="5d96c-588">Para evitar a concatenação durante a criação de perfil, modifique a sequência de renderização para que o tipo primitivo não seja uma lista de triângulos ou modifique a sequência de renderização para que não haja chamadas de desenho de back-to-back que usem vértices consecutivos (ou índices).</span><span class="sxs-lookup"><span data-stu-id="5d96c-588">To prevent concatenation during profiling, modify the render sequence so that the primitive type is not a triangle list, or modify the render sequence so that there are no back-to-back draw calls that use consecutive vertices (or indices).</span></span> <span data-ttu-id="5d96c-589">Mais especificamente, o tempo de execução também concatena as chamadas draw que atendem às duas condições a seguir:</span><span class="sxs-lookup"><span data-stu-id="5d96c-589">More specifically, the runtime will also concatenate draw calls that meet both of the following conditions:</span></span>

-   <span data-ttu-id="5d96c-590">Quando a chamada anterior for [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), se a próxima chamada de desenho:</span><span class="sxs-lookup"><span data-stu-id="5d96c-590">When the previous call is [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), if the next draw call:</span></span>
    -   <span data-ttu-id="5d96c-591">usa uma lista de triângulos e</span><span class="sxs-lookup"><span data-stu-id="5d96c-591">uses a triangle list, AND</span></span>
    -   <span data-ttu-id="5d96c-592">Especifica o StartVertex = Previous StartVertex + anterior PrimitiveCount \* 3</span><span class="sxs-lookup"><span data-stu-id="5d96c-592">specifies the StartVertex = previous StartVertex + previous PrimitiveCount \* 3</span></span>
-   <span data-ttu-id="5d96c-593">Ao usar [**DrawIndexedPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive), se a próxima chamada de desenho:</span><span class="sxs-lookup"><span data-stu-id="5d96c-593">When using [**DrawIndexedPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawindexedprimitive), if the next draw call:</span></span>
    -   <span data-ttu-id="5d96c-594">usa uma lista de triângulos e</span><span class="sxs-lookup"><span data-stu-id="5d96c-594">uses a triangle list, AND</span></span>
    -   <span data-ttu-id="5d96c-595">Especifica o StartIndex = antigo StartIndex + anterior PrimitiveCount \* 3 e</span><span class="sxs-lookup"><span data-stu-id="5d96c-595">specifies the StartIndex = previous StartIndex + previous PrimitiveCount \* 3, AND</span></span>
    -   <span data-ttu-id="5d96c-596">Especifica o BaseVertexIndex = BaseVertexIndex anterior</span><span class="sxs-lookup"><span data-stu-id="5d96c-596">specifies the BaseVertexIndex = previous BaseVertexIndex</span></span>

<span data-ttu-id="5d96c-597">Aqui está um exemplo mais sutil da concatenação de chamada de desenho que é fácil de ignorar quando você está criando perfis.</span><span class="sxs-lookup"><span data-stu-id="5d96c-597">Here is a more subtle example of draw call concatenation that is easy to overlook when you are profiling.</span></span> <span data-ttu-id="5d96c-598">Suponha que a sequência de renderização tenha esta aparência:</span><span class="sxs-lookup"><span data-stu-id="5d96c-598">Assume the render sequence looks like this:</span></span>


```
  for(int i = 0; i < 1500; i++)
  {
    SetTexture(...);
    DrawPrimitive(D3DPT_TRIANGLELIST, i*3, 1);
  }
```



<span data-ttu-id="5d96c-599">Exemplo 5C: uma alteração de estado e uma chamada de desenho</span><span class="sxs-lookup"><span data-stu-id="5d96c-599">Example 5c: One State Change and One Draw Call</span></span>

<span data-ttu-id="5d96c-600">O loop itera até 1500 triângulos, definindo uma textura e desenhando cada triângulo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-600">The loop iterates through 1500 triangles, setting a texture and drawing each triangle.</span></span> <span data-ttu-id="5d96c-601">Esse loop de renderização leva aproximadamente 2750 ciclos para os ciclos [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) e 1100 para [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) , conforme mostrado nas seções anteriores.</span><span class="sxs-lookup"><span data-stu-id="5d96c-601">This render loop takes approximately 2750 cycles for [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) and 1100 cycles for [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) as shown in previous sections.</span></span> <span data-ttu-id="5d96c-602">Você pode, de modo intuitivo, esperar que a movimentação de **SetTexture** fora do loop de processamento deva reduzir a quantidade de trabalho feita pelo driver em 1500 \* 2750 ciclos, que é a quantidade de trabalho associada à chamada de $ **Texture** 1500 vezes.</span><span class="sxs-lookup"><span data-stu-id="5d96c-602">You might intuitively expect that moving **SetTexture** outside the render loop should reduce the amount of work done by the driver by 1500 \* 2750 cycles, which is the amount of work associated with calling **SetTexture** 1500 times.</span></span> <span data-ttu-id="5d96c-603">O trecho de código ficaria assim:</span><span class="sxs-lookup"><span data-stu-id="5d96c-603">The code snippet would look like this:</span></span>


```
  SetTexture(...); // Set the state outside the loop
  for(int i = 0; i < 1500; i++)
  {
//    SetTexture(...);
    DrawPrimitive(D3DPT_TRIANGLELIST, i*3, 1);
  }
```



<span data-ttu-id="5d96c-604">Exemplo 5D: exemplo 5C com a alteração de estado fora do loop</span><span class="sxs-lookup"><span data-stu-id="5d96c-604">Example 5d: Example 5c with the State Change Outside the Loop</span></span>

<span data-ttu-id="5d96c-605">Mover [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) fora do loop de processamento reduz a quantidade de trabalho associada ao **SetTexture** , pois ele é chamado uma vez em vez de 1500 vezes.</span><span class="sxs-lookup"><span data-stu-id="5d96c-605">Moving [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture) outside the render loop does reduce the amount of work associated with **SetTexture** since it is called once instead of 1500 times.</span></span> <span data-ttu-id="5d96c-606">Um efeito secundário menos óbvio é que o trabalho para [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) também é reduzido de chamadas de 1500 para 1 chamada, pois todas as condições para concatenar chamadas de desenho são satisfeitas.</span><span class="sxs-lookup"><span data-stu-id="5d96c-606">A less obvious secondary effect is that the work for [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) is also reduced from 1500 calls to 1 call because all of the conditions for concatenating draw calls are satisfied.</span></span> <span data-ttu-id="5d96c-607">Quando a sequência de renderização é processada, o tempo de execução processará chamadas de 1500 em uma única chamada de driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-607">When the render sequence is processed, the runtime will process 1500 calls into a single driver call.</span></span> <span data-ttu-id="5d96c-608">Ao mover esta linha de código, a quantidade de trabalho do driver foi reduzida drasticamente:</span><span class="sxs-lookup"><span data-stu-id="5d96c-608">By moving this one line of code, the amount of driver work has been reduced dramatically:</span></span>


```
total work done = runtime + driver work

Example 5c: with SetTexture in the loop:
runtime work = 1500 SetTextures + 1500 DrawPrimitives 
driver  work = 1500 SetTextures + 1500 DrawPrimitives 

Example 5d: with SetTexture outside of the loop:
runtime work = 1 SetTexture + 1 DrawPrimitive + 1499 Concatenated DrawPrimitives 
driver  work = 1 SetTexture + 1 DrawPrimitive 
```



<span data-ttu-id="5d96c-609">Esses resultados estão totalmente corretos, mas são muito enganosos no contexto da pergunta original.</span><span class="sxs-lookup"><span data-stu-id="5d96c-609">These results are entirely correct, but are very misleading in the context of the original question.</span></span> <span data-ttu-id="5d96c-610">A otimização de chamada de desenho fez com que a quantidade de trabalho do driver fosse reduzida drasticamente.</span><span class="sxs-lookup"><span data-stu-id="5d96c-610">The draw call optimization has caused the amount of driver work to be dramatically reduced.</span></span> <span data-ttu-id="5d96c-611">Esse é um problema comum ao fazer a criação de perfil Personalizada.</span><span class="sxs-lookup"><span data-stu-id="5d96c-611">This is a common problem when doing custom profiling.</span></span> <span data-ttu-id="5d96c-612">Ao eliminar chamadas de uma sequência de renderização, tenha cuidado para evitar a concatenação de chamada de desenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-612">When eliminating calls from a render sequence, be careful to avoid draw call concatenation.</span></span> <span data-ttu-id="5d96c-613">Na verdade, esse cenário é um poderoso exemplo da quantidade de melhoria no desempenho do driver possível por essa otimização de tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="5d96c-613">In fact, this scenario is a powerful example of the amount of improvement in driver performance possible by this runtime optimization.</span></span>

<span data-ttu-id="5d96c-614">Agora você sabe como medir as alterações de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-614">So now you know how to measure state changes.</span></span> <span data-ttu-id="5d96c-615">Comece pela criação de perfil de [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive).</span><span class="sxs-lookup"><span data-stu-id="5d96c-615">Start by profiling [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive).</span></span> <span data-ttu-id="5d96c-616">Em seguida, adicione cada alteração de estado adicional à sequência (em alguns casos, adicionando uma chamada e, em outros casos, adicionando duas chamadas) e medir a diferença entre as duas sequências.</span><span class="sxs-lookup"><span data-stu-id="5d96c-616">Then add each additional state change to the sequence (in some cases adding one call and in other cases adding two calls) and measure the difference between the two sequences.</span></span> <span data-ttu-id="5d96c-617">Você pode converter os resultados em tiques ou ciclos ou tempo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-617">You can convert the results to ticks or cycles or time.</span></span> <span data-ttu-id="5d96c-618">Assim como medir as sequências de renderização com QueryPerformanceCounter, medir as alterações de estado individuais depende do mecanismo de consulta para controlar o buffer de comando e colocar as alterações de estado em um loop para minimizar o impacto das transições de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-618">Just like measuring render sequences with QueryPerformanceCounter, measuring individual state changes relies on the query mechanism to control the command buffer, and putting the state changes in a loop to minimize the impact of the mode transitions.</span></span> <span data-ttu-id="5d96c-619">Essa técnica mede o custo de alternar um estado, uma vez que o criador de perfil retorna a média de habilitar e desabilitar o estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-619">This technique measures the cost of toggling a state, since the profiler returns the average of enabling and disabling the state.</span></span>

<span data-ttu-id="5d96c-620">Com esse recurso, você pode começar a gerar sequências de renderização arbitrárias e medir com precisão o tempo de execução e o funcionamento do driver associados.</span><span class="sxs-lookup"><span data-stu-id="5d96c-620">With this capability, you can start generating arbitrary rendering sequences and accurately measuring the associated runtime and driver work.</span></span> <span data-ttu-id="5d96c-621">Os números podem ser usados para responder a perguntas de orçamento como "Quantos mais dessas chamadas" podem ser feitas na sequência de renderização, mantendo uma taxa de quadros razoável, supondo cenários limitados à CPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-621">The numbers can then be used to answer budgeting questions like "how many more of these calls" can be made in the render sequence while still maintaining a reasonable frame rate, assuming CPU-limited scenarios.</span></span>

## <a name="summary"></a><span data-ttu-id="5d96c-622">Resumo</span><span class="sxs-lookup"><span data-stu-id="5d96c-622">Summary</span></span>

<span data-ttu-id="5d96c-623">Este documento demonstra como controlar o buffer de comando para que as chamadas individuais possam ser com o perfil correto.</span><span class="sxs-lookup"><span data-stu-id="5d96c-623">This paper demonstrates how to control the command buffer so that individual calls can be accurately profiled.</span></span> <span data-ttu-id="5d96c-624">Os números de criação de perfil podem ser gerados em tiques, ciclos ou tempo absoluto.</span><span class="sxs-lookup"><span data-stu-id="5d96c-624">The profiling numbers can be generated in ticks, cycles, or absolute time.</span></span> <span data-ttu-id="5d96c-625">Elas representam a quantidade de tempo de execução e o trabalho de driver associados a cada chamada à API.</span><span class="sxs-lookup"><span data-stu-id="5d96c-625">They represent the amount of runtime and driver work associated with each API call.</span></span>

<span data-ttu-id="5d96c-626">Comece com a criação de perfil de uma \* chamada primitiva de desenho em uma sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-626">Start by profiling a Draw\*Primitive call in a render sequence.</span></span> <span data-ttu-id="5d96c-627">Lembre-se de:</span><span class="sxs-lookup"><span data-stu-id="5d96c-627">Remember to:</span></span>

1.  <span data-ttu-id="5d96c-628">Use QueryPerformanceCounter para medir o número de tiques por chamada à API.</span><span class="sxs-lookup"><span data-stu-id="5d96c-628">Use QueryPerformanceCounter to measure the number of ticks per API call.</span></span> <span data-ttu-id="5d96c-629">Use QueryPerformanceFrequency para converter os resultados em ciclos ou tempo, se desejar.</span><span class="sxs-lookup"><span data-stu-id="5d96c-629">Use QueryPerformanceFrequency to convert the results to cycles or time if you like.</span></span>
2.  <span data-ttu-id="5d96c-630">Use o mecanismo de consulta para esvaziar o buffer de comando antes de iniciar.</span><span class="sxs-lookup"><span data-stu-id="5d96c-630">Use the query mechanism to empty the command buffer before starting.</span></span>
3.  <span data-ttu-id="5d96c-631">Inclua a sequência de renderização em um loop para minimizar o impacto da transição de modo.</span><span class="sxs-lookup"><span data-stu-id="5d96c-631">Include the render sequence in a loop to minimize the impact of the mode transition.</span></span>
4.  <span data-ttu-id="5d96c-632">Use o mecanismo de consulta para medir quando a GPU concluiu seu trabalho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-632">Use the query mechanism to measure when the GPU has completed its work.</span></span>
5.  <span data-ttu-id="5d96c-633">Tome cuidado com a concatenação de tempo de execução que terá um grande impacto na quantidade de trabalho realizado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-633">Watch out for runtime concatenation that will have a major impact on the amount of work done.</span></span>

<span data-ttu-id="5d96c-634">Isso fornece um desempenho de linha de base para [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) que podem ser usados para a criação do.</span><span class="sxs-lookup"><span data-stu-id="5d96c-634">This gives you a baseline performance for [**DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive) that can be used to build from.</span></span> <span data-ttu-id="5d96c-635">Para criar o perfil de uma alteração de estado, siga estas dicas adicionais:</span><span class="sxs-lookup"><span data-stu-id="5d96c-635">To profile one state change, follow these additional tips:</span></span>

1.  <span data-ttu-id="5d96c-636">Adicione a alteração de estado a um perfil de sequência de renderização conhecido na nova sequência.</span><span class="sxs-lookup"><span data-stu-id="5d96c-636">Add the state change to a known render sequence profile the new sequence.</span></span> <span data-ttu-id="5d96c-637">Como o teste é feito em um loop, isso requer a definição do estado duas vezes em valores opostos (como habilitar e desabilitar por exemplo).</span><span class="sxs-lookup"><span data-stu-id="5d96c-637">Since the testing is done in a loop, this requires setting the state twice into opposite values (like enable and disable for instance).</span></span>
2.  <span data-ttu-id="5d96c-638">Compare a diferença em tempos de ciclo entre as duas sequências.</span><span class="sxs-lookup"><span data-stu-id="5d96c-638">Compare the difference in cycle times between the two sequences.</span></span>
3.  <span data-ttu-id="5d96c-639">Para alterações de estado que alteram significativamente o pipeline (como [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture)), subtraia a diferença entre as duas sequências para obter o tempo de alteração de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-639">For state changes that significantly change the pipeline (like [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture)), subtract the difference between the two sequences to get the time for state change.</span></span>
4.  <span data-ttu-id="5d96c-640">Para alterações de estado que alteram significativamente o pipeline (e, portanto, exigem alternância de Estados como [**Setrenderingstate**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate)), subtraia a diferença entre as sequências de renderização e a divisão por 2.</span><span class="sxs-lookup"><span data-stu-id="5d96c-640">For state changes that significantly change the pipeline (and therefore require toggling states like [**SetRenderState**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate)), subtract the difference between the render sequences and divide by 2.</span></span> <span data-ttu-id="5d96c-641">Isso irá gerar o número médio de ciclos para cada alteração de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-641">This will generate the average number of cycles for each state change.</span></span>

<span data-ttu-id="5d96c-642">Mas tenha cuidado com otimizações que causam resultados inesperados durante a criação de perfil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-642">But be careful of optimizations that cause unexpected results when profiling.</span></span> <span data-ttu-id="5d96c-643">As otimizações de alteração de estado podem definir Estados sujos que causam o trabalho a ser adiado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-643">State change optimizations may set dirty states which causes work to be deferred.</span></span> <span data-ttu-id="5d96c-644">Isso pode causar resultados de perfil que não são tão intuitivos quanto o esperado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-644">This can cause profile results which are not as intuitive as expected.</span></span> <span data-ttu-id="5d96c-645">As chamadas de desenho concatenadas reduzirão drasticamente o trabalho do driver, o que pode levar a conclusões enganosas.</span><span class="sxs-lookup"><span data-stu-id="5d96c-645">Draw calls that are concatenated will dramatically reduce driver work which can lead to misleading conclusions.</span></span> <span data-ttu-id="5d96c-646">As sequências de renderização cuidadosamente planejadas são usadas para impedir a alteração de estado e a ocorrência de concatenações de chamada de desenho.</span><span class="sxs-lookup"><span data-stu-id="5d96c-646">Carefully planned render sequences are used to prevent state change and draw call concatenations from occurring.</span></span> <span data-ttu-id="5d96c-647">O truque é evitar que as otimizações ocorram durante a criação de perfil para que os números gerados sejam números de orçamento razoáveis.</span><span class="sxs-lookup"><span data-stu-id="5d96c-647">The trick is to prevent the optimizations from happening during profiling so that the numbers you generate are reasonable budgeting numbers.</span></span>

> [!Note]  
> <span data-ttu-id="5d96c-648">A duplicação dessa estratégia de criação de perfil em um aplicativo sem o mecanismo de consulta é mais difícil.</span><span class="sxs-lookup"><span data-stu-id="5d96c-648">Duplicating this profiling strategy in an application without the query mechanism is more difficult.</span></span> <span data-ttu-id="5d96c-649">Antes do Direct3D 9, a única maneira previsível de esvaziar o buffer de comando é bloquear uma superfície ativa (como um destino de renderização) para aguardar até que a GPU fique ociosa.</span><span class="sxs-lookup"><span data-stu-id="5d96c-649">Prior to Direct3D 9 the only predictable way to empty the command buffer is to lock an active surface (such as a render target) to wait until the GPU is idle.</span></span> <span data-ttu-id="5d96c-650">Isso ocorre porque o bloqueio de uma superfície força o tempo de execução a esvaziar o buffer de comandos, caso haja algum comando de renderização no buffer que deve atualizar a superfície antes de ser bloqueado, além de aguardar a conclusão da GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-650">This is because locking a surface forces the runtime to empty the command buffer in case there are any rendering commands in the buffer that should update the surface before it gets locked, in addition to waiting for the GPU to finish.</span></span> <span data-ttu-id="5d96c-651">Essa técnica é funcional, embora seja mais invasiva que usar o mecanismo de consulta introduzido no Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="5d96c-651">This technique is functional, although it is more obtrusive that using the query mechanism introduced in Direct3D 9.</span></span>

 

## <a name="appendix"></a><span data-ttu-id="5d96c-652">Apêndice</span><span class="sxs-lookup"><span data-stu-id="5d96c-652">Appendix</span></span>

<span data-ttu-id="5d96c-653">Os números nessa tabela são um intervalo de aproximações para a quantidade de tempo de execução e o trabalho de driver associados a cada uma dessas alterações de estado.</span><span class="sxs-lookup"><span data-stu-id="5d96c-653">The numbers in this table are a range of approximations for the amount of runtime and driver work associated with each of these state changes.</span></span> <span data-ttu-id="5d96c-654">As aproximaçãos se baseiam em medidas reais feitas nos drivers usando as técnicas mostradas no documento.</span><span class="sxs-lookup"><span data-stu-id="5d96c-654">The approximations are based on actual measurements made on drivers using the techniques shown in the paper.</span></span> <span data-ttu-id="5d96c-655">Esses números foram gerados usando o tempo de execução do Direct3D 9 e dependem do driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-655">These numbers were generated using the Direct3D 9 runtime and are driver-dependent.</span></span>

<span data-ttu-id="5d96c-656">As técnicas neste documento foram projetadas para medir o tempo de execução e o funcionamento do driver.</span><span class="sxs-lookup"><span data-stu-id="5d96c-656">The techniques in this paper are designed to measure runtime and driver work.</span></span> <span data-ttu-id="5d96c-657">Em geral, é impraticável fornecer resultados que correspondam ao desempenho da CPU e da GPU em todos os aplicativos, pois isso exigiria uma matriz exaustiva de sequências de processamento.</span><span class="sxs-lookup"><span data-stu-id="5d96c-657">In general, it is impractical to provide results that match the performance of the CPU and the GPU in every application as this would require an exhaustive array of render sequences.</span></span> <span data-ttu-id="5d96c-658">Além disso, é particularmente difícil para o desempenho de benchmark da GPU porque ela é altamente dependente da configuração de estado no pipeline antes da sequência de renderização.</span><span class="sxs-lookup"><span data-stu-id="5d96c-658">In addition, it is particularly difficult to benchmark performance of the GPU because it is highly dependent on the state setup in the pipeline before the render sequence.</span></span> <span data-ttu-id="5d96c-659">Por exemplo, a habilitação da combinação alfa não afeta a quantidade de trabalho de CPU necessária, mas pode ter um grande impacto na quantidade de trabalho realizado pela GPU.</span><span class="sxs-lookup"><span data-stu-id="5d96c-659">For instance, enabling alpha blending does little to affect the amount of CPU work necessary, but can have a big impact on the amount of work done by the GPU.</span></span> <span data-ttu-id="5d96c-660">Portanto, as técnicas neste documento restringem o trabalho de GPU ao valor mínimo possível limitando a quantidade de dados que precisam ser renderizados.</span><span class="sxs-lookup"><span data-stu-id="5d96c-660">Therefore, the techniques in this paper constrain the GPU work to the minimum amount possible by limiting the amount of data that needs to be rendered.</span></span> <span data-ttu-id="5d96c-661">Isso significa que os números na tabela corresponderão melhor aos resultados obtidos de aplicativos que são limitados por CPU (em oposição a um aplicativo limitado pela GPU).</span><span class="sxs-lookup"><span data-stu-id="5d96c-661">This means that the numbers in the table will most closely match the results attained from applications that are CPU limited (as opposed to an application that is limited by the GPU).</span></span>

<span data-ttu-id="5d96c-662">Você é incentivado a usar as técnicas apresentadas para abordar os cenários e as configurações mais importantes para você.</span><span class="sxs-lookup"><span data-stu-id="5d96c-662">You are encouraged to use the techniques presented to cover the scenarios and configurations most important to you.</span></span> <span data-ttu-id="5d96c-663">Os valores na tabela podem ser usados para comparar com os números que você gerar.</span><span class="sxs-lookup"><span data-stu-id="5d96c-663">The values in the table can be used to compare with the numbers you generate.</span></span> <span data-ttu-id="5d96c-664">Como cada driver varia, a única maneira de gerar os números reais que você verá é gerar resultados de criação de perfil usando seus cenários.</span><span class="sxs-lookup"><span data-stu-id="5d96c-664">Since each driver varies, the only way to generate the actual numbers you will see is to generate profiling results using your scenarios.</span></span>



| <span data-ttu-id="5d96c-665">Chamada à API</span><span class="sxs-lookup"><span data-stu-id="5d96c-665">API Call</span></span>                             | <span data-ttu-id="5d96c-666">Número médio de ciclos</span><span class="sxs-lookup"><span data-stu-id="5d96c-666">Average number of Cycles</span></span> |
|--------------------------------------|--------------------------|
| <span data-ttu-id="5d96c-667">SetVertexDeclaration</span><span class="sxs-lookup"><span data-stu-id="5d96c-667">SetVertexDeclaration</span></span>                 | <span data-ttu-id="5d96c-668">6500-11250</span><span class="sxs-lookup"><span data-stu-id="5d96c-668">6500 - 11250</span></span>             |
| <span data-ttu-id="5d96c-669">SetFVF</span><span class="sxs-lookup"><span data-stu-id="5d96c-669">SetFVF</span></span>                               | <span data-ttu-id="5d96c-670">6400-11200</span><span class="sxs-lookup"><span data-stu-id="5d96c-670">6400 - 11200</span></span>             |
| <span data-ttu-id="5d96c-671">SetVertexShader</span><span class="sxs-lookup"><span data-stu-id="5d96c-671">SetVertexShader</span></span>                      | <span data-ttu-id="5d96c-672">3000-12100</span><span class="sxs-lookup"><span data-stu-id="5d96c-672">3000 - 12100</span></span>             |
| <span data-ttu-id="5d96c-673">SetPixelShader</span><span class="sxs-lookup"><span data-stu-id="5d96c-673">SetPixelShader</span></span>                       | <span data-ttu-id="5d96c-674">6300-7000</span><span class="sxs-lookup"><span data-stu-id="5d96c-674">6300 - 7000</span></span>              |
| <span data-ttu-id="5d96c-675">SPECULARENABLE</span><span class="sxs-lookup"><span data-stu-id="5d96c-675">SPECULARENABLE</span></span>                       | <span data-ttu-id="5d96c-676">1900-11200</span><span class="sxs-lookup"><span data-stu-id="5d96c-676">1900 - 11200</span></span>             |
| <span data-ttu-id="5d96c-677">SetRenderTarget</span><span class="sxs-lookup"><span data-stu-id="5d96c-677">SetRenderTarget</span></span>                      | <span data-ttu-id="5d96c-678">6000-6250</span><span class="sxs-lookup"><span data-stu-id="5d96c-678">6000 - 6250</span></span>              |
| <span data-ttu-id="5d96c-679">SetPixelShaderConstant (1 constante)</span><span class="sxs-lookup"><span data-stu-id="5d96c-679">SetPixelShaderConstant (1 Constant)</span></span>  | <span data-ttu-id="5d96c-680">1500-9000</span><span class="sxs-lookup"><span data-stu-id="5d96c-680">1500 - 9000</span></span>              |
| <span data-ttu-id="5d96c-681">NORMALIZENORMALS</span><span class="sxs-lookup"><span data-stu-id="5d96c-681">NORMALIZENORMALS</span></span>                     | <span data-ttu-id="5d96c-682">2200-8100</span><span class="sxs-lookup"><span data-stu-id="5d96c-682">2200 - 8100</span></span>              |
| <span data-ttu-id="5d96c-683">Clarear</span><span class="sxs-lookup"><span data-stu-id="5d96c-683">LightEnable</span></span>                          | <span data-ttu-id="5d96c-684">1300-9000</span><span class="sxs-lookup"><span data-stu-id="5d96c-684">1300 - 9000</span></span>              |
| <span data-ttu-id="5d96c-685">Setstreaming</span><span class="sxs-lookup"><span data-stu-id="5d96c-685">SetStreamSource</span></span>                      | <span data-ttu-id="5d96c-686">3700-5800</span><span class="sxs-lookup"><span data-stu-id="5d96c-686">3700 - 5800</span></span>              |
| <span data-ttu-id="5d96c-687">ILUMINA</span><span class="sxs-lookup"><span data-stu-id="5d96c-687">LIGHTING</span></span>                             | <span data-ttu-id="5d96c-688">1700-7500</span><span class="sxs-lookup"><span data-stu-id="5d96c-688">1700 - 7500</span></span>              |
| <span data-ttu-id="5d96c-689">DIFFUSEMATERIALSOURCE</span><span class="sxs-lookup"><span data-stu-id="5d96c-689">DIFFUSEMATERIALSOURCE</span></span>                | <span data-ttu-id="5d96c-690">900-8300</span><span class="sxs-lookup"><span data-stu-id="5d96c-690">900 - 8300</span></span>               |
| <span data-ttu-id="5d96c-691">AMBIENTMATERIALSOURCE</span><span class="sxs-lookup"><span data-stu-id="5d96c-691">AMBIENTMATERIALSOURCE</span></span>                | <span data-ttu-id="5d96c-692">900-8200</span><span class="sxs-lookup"><span data-stu-id="5d96c-692">900 - 8200</span></span>               |
| <span data-ttu-id="5d96c-693">COLORVERTEX</span><span class="sxs-lookup"><span data-stu-id="5d96c-693">COLORVERTEX</span></span>                          | <span data-ttu-id="5d96c-694">800-7800</span><span class="sxs-lookup"><span data-stu-id="5d96c-694">800 - 7800</span></span>               |
| <span data-ttu-id="5d96c-695">SetLight</span><span class="sxs-lookup"><span data-stu-id="5d96c-695">SetLight</span></span>                             | <span data-ttu-id="5d96c-696">2200-5100</span><span class="sxs-lookup"><span data-stu-id="5d96c-696">2200 - 5100</span></span>              |
| <span data-ttu-id="5d96c-697">SetTransform</span><span class="sxs-lookup"><span data-stu-id="5d96c-697">SetTransform</span></span>                         | <span data-ttu-id="5d96c-698">3200-3750</span><span class="sxs-lookup"><span data-stu-id="5d96c-698">3200 - 3750</span></span>              |
| <span data-ttu-id="5d96c-699">SetIndices</span><span class="sxs-lookup"><span data-stu-id="5d96c-699">SetIndices</span></span>                           | <span data-ttu-id="5d96c-700">900-5600</span><span class="sxs-lookup"><span data-stu-id="5d96c-700">900 - 5600</span></span>               |
| <span data-ttu-id="5d96c-701">TEMPERATURA</span><span class="sxs-lookup"><span data-stu-id="5d96c-701">AMBIENT</span></span>                              | <span data-ttu-id="5d96c-702">1150-4800</span><span class="sxs-lookup"><span data-stu-id="5d96c-702">1150 - 4800</span></span>              |
| <span data-ttu-id="5d96c-703">SetTexture</span><span class="sxs-lookup"><span data-stu-id="5d96c-703">SetTexture</span></span>                           | <span data-ttu-id="5d96c-704">2500-3100</span><span class="sxs-lookup"><span data-stu-id="5d96c-704">2500 - 3100</span></span>              |
| <span data-ttu-id="5d96c-705">SPECULARMATERIALSOURCE</span><span class="sxs-lookup"><span data-stu-id="5d96c-705">SPECULARMATERIALSOURCE</span></span>               | <span data-ttu-id="5d96c-706">900-4600</span><span class="sxs-lookup"><span data-stu-id="5d96c-706">900 - 4600</span></span>               |
| <span data-ttu-id="5d96c-707">EMISSIVEMATERIALSOURCE</span><span class="sxs-lookup"><span data-stu-id="5d96c-707">EMISSIVEMATERIALSOURCE</span></span>               | <span data-ttu-id="5d96c-708">900-4500</span><span class="sxs-lookup"><span data-stu-id="5d96c-708">900 - 4500</span></span>               |
| <span data-ttu-id="5d96c-709">SetMaterial</span><span class="sxs-lookup"><span data-stu-id="5d96c-709">SetMaterial</span></span>                          | <span data-ttu-id="5d96c-710">1000-3700</span><span class="sxs-lookup"><span data-stu-id="5d96c-710">1000 - 3700</span></span>              |
| <span data-ttu-id="5d96c-711">ZENABLE</span><span class="sxs-lookup"><span data-stu-id="5d96c-711">ZENABLE</span></span>                              | <span data-ttu-id="5d96c-712">700-3900</span><span class="sxs-lookup"><span data-stu-id="5d96c-712">700 - 3900</span></span>               |
| <span data-ttu-id="5d96c-713">WRAP0</span><span class="sxs-lookup"><span data-stu-id="5d96c-713">WRAP0</span></span>                                | <span data-ttu-id="5d96c-714">1600-2700</span><span class="sxs-lookup"><span data-stu-id="5d96c-714">1600 - 2700</span></span>              |
| <span data-ttu-id="5d96c-715">MINFILTER</span><span class="sxs-lookup"><span data-stu-id="5d96c-715">MINFILTER</span></span>                            | <span data-ttu-id="5d96c-716">1700-2500</span><span class="sxs-lookup"><span data-stu-id="5d96c-716">1700 - 2500</span></span>              |
| <span data-ttu-id="5d96c-717">MAGFILTER</span><span class="sxs-lookup"><span data-stu-id="5d96c-717">MAGFILTER</span></span>                            | <span data-ttu-id="5d96c-718">1700-2400</span><span class="sxs-lookup"><span data-stu-id="5d96c-718">1700 - 2400</span></span>              |
| <span data-ttu-id="5d96c-719">SetVertexShaderConstant (1 constante)</span><span class="sxs-lookup"><span data-stu-id="5d96c-719">SetVertexShaderConstant (1 Constant)</span></span> | <span data-ttu-id="5d96c-720">1000-2700</span><span class="sxs-lookup"><span data-stu-id="5d96c-720">1000 - 2700</span></span>              |
| <span data-ttu-id="5d96c-721">COLOROP</span><span class="sxs-lookup"><span data-stu-id="5d96c-721">COLOROP</span></span>                              | <span data-ttu-id="5d96c-722">1500-2100</span><span class="sxs-lookup"><span data-stu-id="5d96c-722">1500 - 2100</span></span>              |
| <span data-ttu-id="5d96c-723">COLORARG2</span><span class="sxs-lookup"><span data-stu-id="5d96c-723">COLORARG2</span></span>                            | <span data-ttu-id="5d96c-724">1300-2000</span><span class="sxs-lookup"><span data-stu-id="5d96c-724">1300 - 2000</span></span>              |
| <span data-ttu-id="5d96c-725">COLORARG1</span><span class="sxs-lookup"><span data-stu-id="5d96c-725">COLORARG1</span></span>                            | <span data-ttu-id="5d96c-726">1300-1980</span><span class="sxs-lookup"><span data-stu-id="5d96c-726">1300 - 1980</span></span>              |
| <span data-ttu-id="5d96c-727">De seleção</span><span class="sxs-lookup"><span data-stu-id="5d96c-727">CULLMODE</span></span>                             | <span data-ttu-id="5d96c-728">500-2570</span><span class="sxs-lookup"><span data-stu-id="5d96c-728">500 - 2570</span></span>               |
| <span data-ttu-id="5d96c-729">RECORTE</span><span class="sxs-lookup"><span data-stu-id="5d96c-729">CLIPPING</span></span>                             | <span data-ttu-id="5d96c-730">500-2550</span><span class="sxs-lookup"><span data-stu-id="5d96c-730">500 - 2550</span></span>               |
| <span data-ttu-id="5d96c-731">DrawIndexedPrimitive</span><span class="sxs-lookup"><span data-stu-id="5d96c-731">DrawIndexedPrimitive</span></span>                 | <span data-ttu-id="5d96c-732">1200-1400</span><span class="sxs-lookup"><span data-stu-id="5d96c-732">1200 - 1400</span></span>              |
| <span data-ttu-id="5d96c-733">ADDRESSV</span><span class="sxs-lookup"><span data-stu-id="5d96c-733">ADDRESSV</span></span>                             | <span data-ttu-id="5d96c-734">1090-1500</span><span class="sxs-lookup"><span data-stu-id="5d96c-734">1090 - 1500</span></span>              |
| <span data-ttu-id="5d96c-735">Endereço de</span><span class="sxs-lookup"><span data-stu-id="5d96c-735">ADDRESSU</span></span>                             | <span data-ttu-id="5d96c-736">1070-1500</span><span class="sxs-lookup"><span data-stu-id="5d96c-736">1070 - 1500</span></span>              |
| <span data-ttu-id="5d96c-737">DrawPrimitive</span><span class="sxs-lookup"><span data-stu-id="5d96c-737">DrawPrimitive</span></span>                        | <span data-ttu-id="5d96c-738">1050-1150</span><span class="sxs-lookup"><span data-stu-id="5d96c-738">1050 - 1150</span></span>              |
| <span data-ttu-id="5d96c-739">SRGBTEXTURE</span><span class="sxs-lookup"><span data-stu-id="5d96c-739">SRGBTEXTURE</span></span>                          | <span data-ttu-id="5d96c-740">150-1500</span><span class="sxs-lookup"><span data-stu-id="5d96c-740">150 - 1500</span></span>               |
| <span data-ttu-id="5d96c-741">STENCILMASK</span><span class="sxs-lookup"><span data-stu-id="5d96c-741">STENCILMASK</span></span>                          | <span data-ttu-id="5d96c-742">570-700</span><span class="sxs-lookup"><span data-stu-id="5d96c-742">570 - 700</span></span>                |
| <span data-ttu-id="5d96c-743">STENCILZFAIL</span><span class="sxs-lookup"><span data-stu-id="5d96c-743">STENCILZFAIL</span></span>                         | <span data-ttu-id="5d96c-744">500-800</span><span class="sxs-lookup"><span data-stu-id="5d96c-744">500 - 800</span></span>                |
| <span data-ttu-id="5d96c-745">STENCILREF</span><span class="sxs-lookup"><span data-stu-id="5d96c-745">STENCILREF</span></span>                           | <span data-ttu-id="5d96c-746">550-700</span><span class="sxs-lookup"><span data-stu-id="5d96c-746">550 - 700</span></span>                |
| <span data-ttu-id="5d96c-747">ALPHABLENDENABLE</span><span class="sxs-lookup"><span data-stu-id="5d96c-747">ALPHABLENDENABLE</span></span>                     | <span data-ttu-id="5d96c-748">550-700</span><span class="sxs-lookup"><span data-stu-id="5d96c-748">550 - 700</span></span>                |
| <span data-ttu-id="5d96c-749">STENCILFUNC</span><span class="sxs-lookup"><span data-stu-id="5d96c-749">STENCILFUNC</span></span>                          | <span data-ttu-id="5d96c-750">560-680</span><span class="sxs-lookup"><span data-stu-id="5d96c-750">560 - 680</span></span>                |
| <span data-ttu-id="5d96c-751">STENCILWRITEMASK</span><span class="sxs-lookup"><span data-stu-id="5d96c-751">STENCILWRITEMASK</span></span>                     | <span data-ttu-id="5d96c-752">520-700</span><span class="sxs-lookup"><span data-stu-id="5d96c-752">520 - 700</span></span>                |
| <span data-ttu-id="5d96c-753">STENCILFAIL</span><span class="sxs-lookup"><span data-stu-id="5d96c-753">STENCILFAIL</span></span>                          | <span data-ttu-id="5d96c-754">500-750</span><span class="sxs-lookup"><span data-stu-id="5d96c-754">500 - 750</span></span>                |
| <span data-ttu-id="5d96c-755">ZFUNC</span><span class="sxs-lookup"><span data-stu-id="5d96c-755">ZFUNC</span></span>                                | <span data-ttu-id="5d96c-756">510-700</span><span class="sxs-lookup"><span data-stu-id="5d96c-756">510 - 700</span></span>                |
| <span data-ttu-id="5d96c-757">ZWRITEENABLE</span><span class="sxs-lookup"><span data-stu-id="5d96c-757">ZWRITEENABLE</span></span>                         | <span data-ttu-id="5d96c-758">520-680</span><span class="sxs-lookup"><span data-stu-id="5d96c-758">520 - 680</span></span>                |
| <span data-ttu-id="5d96c-759">STENCILENABLE</span><span class="sxs-lookup"><span data-stu-id="5d96c-759">STENCILENABLE</span></span>                        | <span data-ttu-id="5d96c-760">540-650</span><span class="sxs-lookup"><span data-stu-id="5d96c-760">540 - 650</span></span>                |
| <span data-ttu-id="5d96c-761">STENCILPASS</span><span class="sxs-lookup"><span data-stu-id="5d96c-761">STENCILPASS</span></span>                          | <span data-ttu-id="5d96c-762">560-630</span><span class="sxs-lookup"><span data-stu-id="5d96c-762">560 - 630</span></span>                |
| <span data-ttu-id="5d96c-763">SRCBLEND</span><span class="sxs-lookup"><span data-stu-id="5d96c-763">SRCBLEND</span></span>                             | <span data-ttu-id="5d96c-764">500-685</span><span class="sxs-lookup"><span data-stu-id="5d96c-764">500 - 685</span></span>                |
| <span data-ttu-id="5d96c-765">\_Estêncil dois lados \_</span><span class="sxs-lookup"><span data-stu-id="5d96c-765">Two\_Sided\_StencilMODE</span></span>              | <span data-ttu-id="5d96c-766">450-590</span><span class="sxs-lookup"><span data-stu-id="5d96c-766">450 - 590</span></span>                |
| <span data-ttu-id="5d96c-767">ALPHATESTENABLE</span><span class="sxs-lookup"><span data-stu-id="5d96c-767">ALPHATESTENABLE</span></span>                      | <span data-ttu-id="5d96c-768">470-525</span><span class="sxs-lookup"><span data-stu-id="5d96c-768">470 - 525</span></span>                |
| <span data-ttu-id="5d96c-769">ALPHAREF</span><span class="sxs-lookup"><span data-stu-id="5d96c-769">ALPHAREF</span></span>                             | <span data-ttu-id="5d96c-770">460-530</span><span class="sxs-lookup"><span data-stu-id="5d96c-770">460 - 530</span></span>                |
| <span data-ttu-id="5d96c-771">ALPHAFUNC</span><span class="sxs-lookup"><span data-stu-id="5d96c-771">ALPHAFUNC</span></span>                            | <span data-ttu-id="5d96c-772">450-540</span><span class="sxs-lookup"><span data-stu-id="5d96c-772">450 - 540</span></span>                |
| <span data-ttu-id="5d96c-773">DESTBLEND</span><span class="sxs-lookup"><span data-stu-id="5d96c-773">DESTBLEND</span></span>                            | <span data-ttu-id="5d96c-774">475-510</span><span class="sxs-lookup"><span data-stu-id="5d96c-774">475 - 510</span></span>                |
| <span data-ttu-id="5d96c-775">COLORWRITEENABLE</span><span class="sxs-lookup"><span data-stu-id="5d96c-775">COLORWRITEENABLE</span></span>                     | <span data-ttu-id="5d96c-776">465-515</span><span class="sxs-lookup"><span data-stu-id="5d96c-776">465 - 515</span></span>                |
| <span data-ttu-id="5d96c-777">\_STENCILFAIL CCW</span><span class="sxs-lookup"><span data-stu-id="5d96c-777">CCW\_STENCILFAIL</span></span>                     | <span data-ttu-id="5d96c-778">340-560</span><span class="sxs-lookup"><span data-stu-id="5d96c-778">340 - 560</span></span>                |
| <span data-ttu-id="5d96c-779">\_STENCILPASS CCW</span><span class="sxs-lookup"><span data-stu-id="5d96c-779">CCW\_STENCILPASS</span></span>                     | <span data-ttu-id="5d96c-780">340-545</span><span class="sxs-lookup"><span data-stu-id="5d96c-780">340 - 545</span></span>                |
| <span data-ttu-id="5d96c-781">\_STENCILZFAIL CCW</span><span class="sxs-lookup"><span data-stu-id="5d96c-781">CCW\_STENCILZFAIL</span></span>                    | <span data-ttu-id="5d96c-782">330-495</span><span class="sxs-lookup"><span data-stu-id="5d96c-782">330 - 495</span></span>                |
| <span data-ttu-id="5d96c-783">SCISSORTESTENABLE</span><span class="sxs-lookup"><span data-stu-id="5d96c-783">SCISSORTESTENABLE</span></span>                    | <span data-ttu-id="5d96c-784">375-440</span><span class="sxs-lookup"><span data-stu-id="5d96c-784">375 - 440</span></span>                |
| <span data-ttu-id="5d96c-785">\_STENCILFUNC CCW</span><span class="sxs-lookup"><span data-stu-id="5d96c-785">CCW\_STENCILFUNC</span></span>                     | <span data-ttu-id="5d96c-786">250-480</span><span class="sxs-lookup"><span data-stu-id="5d96c-786">250 - 480</span></span>                |
| <span data-ttu-id="5d96c-787">SetScissorRect</span><span class="sxs-lookup"><span data-stu-id="5d96c-787">SetScissorRect</span></span>                       | <span data-ttu-id="5d96c-788">150-340</span><span class="sxs-lookup"><span data-stu-id="5d96c-788">150 - 340</span></span>                |



 

## <a name="related-topics"></a><span data-ttu-id="5d96c-789">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="5d96c-789">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5d96c-790">Tópicos avançados</span><span class="sxs-lookup"><span data-stu-id="5d96c-790">Advanced Topics</span></span>](advanced-topics.md)
</dt> </dl>

 

 
