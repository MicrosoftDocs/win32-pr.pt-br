---
title: Tempo de vida e sincronização de recursos
description: Para evitar um comportamento indefinido, seu aplicativo DirectML deve gerenciar corretamente os tempos de vida de objeto e a sincronização entre a CPU e a GPU.
ms.custom: Windows 10 May 2019 Update
ms.localizationpriority: high
ms.topic: article
ms.date: 04/19/2019
ms.openlocfilehash: 6e8ab30c5c87c135ef3bdac0c1bc2a3d64040787
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/16/2019
ms.locfileid: "74103771"
---
# <a name="resource-lifetime-and-synchronization"></a><span data-ttu-id="ad709-103">Tempo de vida e sincronização de recursos</span><span class="sxs-lookup"><span data-stu-id="ad709-103">Resource lifetime and synchronization</span></span>

<span data-ttu-id="ad709-104">Assim como ocorre com o Direct3D 12, seu aplicativo DirectML deve (para evitar o comportamento indefinido) gerenciar corretamente os tempos de vida de objetos e a sincronização entre a CPU e a GPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-104">Just as with Direct3D 12, your DirectML application must (in order to avoid undefined behavior) correctly manage object lifetimes and synchronization between the CPU and the GPU.</span></span> <span data-ttu-id="ad709-105">DirectML segue um modelo de tempo de vida de recurso idêntico ao do Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="ad709-105">DirectML follows an identical resource lifetime model to that of Direct3D 12.</span></span>

- <span data-ttu-id="ad709-106">As dependências de tempo de vida entre dois objetos de CPU são mantidas pelo DirectML usando contagens de referência forte.</span><span class="sxs-lookup"><span data-stu-id="ad709-106">Lifetime dependencies between two CPU objects are maintained by DirectML using strong reference counts.</span></span> <span data-ttu-id="ad709-107">Seu aplicativo não é possível gerenciar manualmente dependências de tempo de vida da CPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-107">Your application needn't manually manage CPU lifetime dependencies.</span></span> <span data-ttu-id="ad709-108">Por exemplo, cada dispositivo filho mantém uma referência forte ao seu dispositivo pai.</span><span class="sxs-lookup"><span data-stu-id="ad709-108">For example, every device child holds a strong reference to its parent device.</span></span>
- <span data-ttu-id="ad709-109">As dependências de tempo de vida entre objetos GPU &mdash; ou dependências que abrangem entre CPU e GPU &mdash; não são gerenciadas automaticamente.</span><span class="sxs-lookup"><span data-stu-id="ad709-109">Lifetime dependencies between GPU objects&mdash;or dependencies that span across CPU and GPU&mdash;aren't automatically managed.</span></span> <span data-ttu-id="ad709-110">É responsabilidade do seu aplicativo garantir que os recursos de GPU estejam ao menos até que todo o trabalho usando esse recurso tenha concluído a execução na GPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-110">It's your application's responsibility to ensure that GPU resources live at least until all work using that resource has completed execution on the GPU.</span></span>

## <a name="directml-devices"></a><span data-ttu-id="ad709-111">Dispositivos DirectML</span><span class="sxs-lookup"><span data-stu-id="ad709-111">DirectML devices</span></span>

<span data-ttu-id="ad709-112">O dispositivo DirectML é um objeto de fábrica sem monitoração de estado thread-safe.</span><span class="sxs-lookup"><span data-stu-id="ad709-112">The DirectML device is a thread-safe stateless factory object.</span></span> <span data-ttu-id="ad709-113">Cada dispositivo filho (consulte [**IDMLDeviceChild**](/windows/desktop/api/directml/nn-directml-idmldevicechild)) mantém uma referência forte ao seu dispositivo DirectML pai (consulte [**IDMLDevice**](/windows/desktop/api/directml/nn-directml-idmldevice)).</span><span class="sxs-lookup"><span data-stu-id="ad709-113">Every device child (see [**IDMLDeviceChild**](/windows/desktop/api/directml/nn-directml-idmldevicechild)) holds a strong reference to its parent DirectML device (see [**IDMLDevice**](/windows/desktop/api/directml/nn-directml-idmldevice)).</span></span> <span data-ttu-id="ad709-114">Isso significa que você sempre pode recuperar a interface do dispositivo pai de qualquer interface filho do dispositivo.</span><span class="sxs-lookup"><span data-stu-id="ad709-114">That means that you can always retrieve the parent device interface from any device child interface.</span></span>

<span data-ttu-id="ad709-115">Um dispositivo DirectML, por sua vez, mantém uma referência forte ao dispositivo Direct3D 12 que foi usado para criá-lo (consulte [**ID3D12Device**](/windows/desktop/api/d3d12/nn-d3d12-id3d12device)e interfaces derivadas).</span><span class="sxs-lookup"><span data-stu-id="ad709-115">A DirectML device in turn holds a strong reference to the Direct3D 12 device that was used to create it (see [**ID3D12Device**](/windows/desktop/api/d3d12/nn-d3d12-id3d12device), and derived interfaces).</span></span>

<span data-ttu-id="ad709-116">Como o dispositivo DirectML é sem monitoração de estado, ele é implicitamente seguro para thread.</span><span class="sxs-lookup"><span data-stu-id="ad709-116">Because the DirectML device is stateless, it's implicitly thread-safe.</span></span> <span data-ttu-id="ad709-117">Você pode chamar métodos no dispositivo DirectML de vários threads simultaneamente sem a necessidade de sincronização externa.</span><span class="sxs-lookup"><span data-stu-id="ad709-117">You may call methods on the DirectML device from multiple threads simultaneously without the need for external synchronization.</span></span>

<span data-ttu-id="ad709-118">No entanto, ao contrário do dispositivo Direct3D 12, o dispositivo DirectML não é um objeto singleton.</span><span class="sxs-lookup"><span data-stu-id="ad709-118">However, unlike the Direct3D 12 device, the DirectML device is not a singleton object.</span></span> <span data-ttu-id="ad709-119">Você tem a liberdade de criar quantos dispositivos DirectML desejar.</span><span class="sxs-lookup"><span data-stu-id="ad709-119">You're free to create as many DirectML devices as you wish.</span></span> <span data-ttu-id="ad709-120">No entanto, você não pode misturar e corresponder a filhos do dispositivo que pertencem a dispositivos diferentes.</span><span class="sxs-lookup"><span data-stu-id="ad709-120">However, you may not mix and match device children that belong to different devices.</span></span> <span data-ttu-id="ad709-121">Por exemplo, [**IDMLBindingTable**](/windows/desktop/api/directml/nn-directml-idmlbindingtable) e [**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) são dois tipos de filhos de dispositivo (ambas as interfaces derivam direta ou indiretamente do **IDMLDeviceChild**).</span><span class="sxs-lookup"><span data-stu-id="ad709-121">For example, [**IDMLBindingTable**](/windows/desktop/api/directml/nn-directml-idmlbindingtable) and [**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) are two kinds of device children (both interfaces derive directly or indirectly from **IDMLDeviceChild**).</span></span> <span data-ttu-id="ad709-122">E você não poderá usar uma tabela de associação (**IDMLBindingTable**) para associar um operador (**IDMLCompiledOperator**) se o operador e a tabela de associação pertencerem a diferentes instâncias de dispositivo DirectML.</span><span class="sxs-lookup"><span data-stu-id="ad709-122">And you may not use a binding table (**IDMLBindingTable**) to bind for an operator (**IDMLCompiledOperator**) if the operator and the binding table belong to different DirectML device instances.</span></span>

<span data-ttu-id="ad709-123">Como o dispositivo DirectML não é um singleton, a remoção do dispositivo ocorre em uma base por dispositivo, em vez de ser um evento de todo o processo como é para um dispositivo Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="ad709-123">Because the DirectML device is not a singleton, device removal occurs on a per-device basis, rather than being a process-wide event as it is for a Direct3D 12 device.</span></span> <span data-ttu-id="ad709-124">Para obter mais informações, consulte [tratamento de erros e remoção de dispositivo no DirectML](dml-errors.md).</span><span class="sxs-lookup"><span data-stu-id="ad709-124">For more information, see [Handling errors and device removal in DirectML](dml-errors.md).</span></span>

## <a name="lifetime-requirements-of-gpu-resources"></a><span data-ttu-id="ad709-125">Requisitos de tempo de vida de recursos de GPU</span><span class="sxs-lookup"><span data-stu-id="ad709-125">Lifetime requirements of GPU resources</span></span>

<span data-ttu-id="ad709-126">Como o Direct3D 12, o DirectML não sincroniza automaticamente entre a CPU e a GPU; nem mantém os recursos ativos automaticamente enquanto eles estão em uso pela GPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-126">Like Direct3D 12, DirectML doesn't automatically synchronize between the CPU and GPU; nor does it automatically keep resources alive while they're in use by the GPU.</span></span> <span data-ttu-id="ad709-127">Em vez disso, essas são as responsabilidades de seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="ad709-127">Instead, these are responsibilities of your application.</span></span>

<span data-ttu-id="ad709-128">Ao executar uma lista de comandos que contém expedições de DirectML, seu aplicativo deve garantir que os recursos de GPU sejam mantidos ativos até que todo o trabalho que usa esses recursos tenha concluído a execução na GPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-128">When executing a command list that contains DirectML dispatches, your application must ensure that GPU resources are kept alive until all work using those resources has completed execution on the GPU.</span></span>

<span data-ttu-id="ad709-129">No caso de [**IDMLCommandRecorder:: RecordDispatch**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) para um operador DirectML, que inclui os objetos a seguir.</span><span class="sxs-lookup"><span data-stu-id="ad709-129">In the case of [**IDMLCommandRecorder::RecordDispatch**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) for a DirectML operator, that includes the following objects.</span></span>

- <span data-ttu-id="ad709-130">O [**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) que está sendo executado (ou [**IDMLOperatorInitializer**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer) em vez disso, se estiver executando a inicialização do operador).</span><span class="sxs-lookup"><span data-stu-id="ad709-130">The [**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) being executed (or [**IDMLOperatorInitializer**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer) instead, if performing operator initialization).</span></span>
- <span data-ttu-id="ad709-131">O **IDMLCompiledOperator** fazendo backup da tabela de associação que está sendo usada para associar o operador.</span><span class="sxs-lookup"><span data-stu-id="ad709-131">The **IDMLCompiledOperator** backing the binding table being used to bind the operator.</span></span>
- <span data-ttu-id="ad709-132">Os objetos [**ID3D12Resource**](/windows/desktop/api/d3d12/nn-d3d12-id3d12resource) associados como entradas/saídas do operador.</span><span class="sxs-lookup"><span data-stu-id="ad709-132">The [**ID3D12Resource**](/windows/desktop/api/d3d12/nn-d3d12-id3d12resource) objects bound as the inputs/outputs of the operator.</span></span>
- <span data-ttu-id="ad709-133">Os objetos **ID3D12Resource** associados como recursos persistentes e temporários, se aplicável.</span><span class="sxs-lookup"><span data-stu-id="ad709-133">The **ID3D12Resource** objects bound as persistent and temporary resources, if applicable.</span></span>
- <span data-ttu-id="ad709-134">O [**ID3D12CommandAllocator**](/windows/desktop/api/d3d12/nn-d3d12-id3d12commandallocator) fazendo o backup da lista de comandos em si.</span><span class="sxs-lookup"><span data-stu-id="ad709-134">The [**ID3D12CommandAllocator**](/windows/desktop/api/d3d12/nn-d3d12-id3d12commandallocator) backing the command list itself.</span></span>

<span data-ttu-id="ad709-135">Nem todas as interfaces DirectML representam recursos de GPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-135">Not all DirectML interfaces represent GPU resources.</span></span> <span data-ttu-id="ad709-136">Por exemplo, uma tabela de associação *não* precisa ser mantida ativa até que todos os expedimentos que o utilizam tenham concluído a execução na GPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-136">For example, a binding table does *not* need to be kept alive until all dispatches using it have completed execution on the GPU.</span></span> <span data-ttu-id="ad709-137">Isso ocorre porque a própria tabela de associação não possui nenhum recurso de GPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-137">That's because the binding table itself doesn't own any GPU resources.</span></span> <span data-ttu-id="ad709-138">Em vez disso, o heap de descritor faz.</span><span class="sxs-lookup"><span data-stu-id="ad709-138">Rather, the descriptor heap does.</span></span> <span data-ttu-id="ad709-139">Portanto, o *heap de descritor* subjacente é o objeto que deve ser mantido ativo até que a execução seja concluída e não a própria tabela de associação.</span><span class="sxs-lookup"><span data-stu-id="ad709-139">Therefore, the underlying *descriptor heap* is the object that must be kept alive until execution completes, and not the binding table itself.</span></span>

<span data-ttu-id="ad709-140">Existe um conceito semelhante no Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="ad709-140">A similar concept exists in Direct3D 12.</span></span> <span data-ttu-id="ad709-141">Um *alocador* de comando deve ser mantido ativo até que todas as execuções que o utilizam tenham sido concluídas na GPU; Pois ela possui memória de GPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-141">A command *allocator* must be kept alive until all executions using it have completed on the GPU; since it owns GPU memory.</span></span> <span data-ttu-id="ad709-142">Mas, uma *lista* de comandos não possui memória de GPU, portanto, ela pode ser redefinida ou liberada assim que foi enviada para execução.</span><span class="sxs-lookup"><span data-stu-id="ad709-142">But, a command *list* doesn't own GPU memory, so it can therefore be reset or released as soon as it's been submitted for execution.</span></span>

<span data-ttu-id="ad709-143">No DirectML, os operadores compilados ([**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator)) e os inicializadores de operador ([**IDMLOperatorInitializer**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer)) têm os próprios recursos de GPU diretamente, portanto, eles devem ser mantidos ativos até que todos os despachos que o utilizam tenham concluído a execução na GPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-143">In DirectML, compiled operators ([**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator)) and operator initializers ([**IDMLOperatorInitializer**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer)) both own GPU resources directly, so they must be kept alive until all dispatches using them have completed execution on the GPU.</span></span> <span data-ttu-id="ad709-144">Além disso, qualquer recurso do Direct3D 12 que está sendo usado (alocadores de comando, heaps de descritores, buffers, como exemplos) deve ser mantido de forma semelhante ao seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="ad709-144">In addition, any Direct3D 12 resource being used (command allocators, descriptor heaps, buffers, as examples) must similarly be kept alive by your application.</span></span>

<span data-ttu-id="ad709-145">Se você lançar prematuramente um objeto enquanto ele ainda estiver em uso pela GPU, o resultado será um comportamento indefinido, que tem o potencial de causar a remoção do dispositivo ou outros erros.</span><span class="sxs-lookup"><span data-stu-id="ad709-145">If you prematurely release an object while it's still in use by the GPU, the result is undefined behavior, which has the potential to cause device removal or other errors.</span></span>

## <a name="cpu-and-gpu-synchronization"></a><span data-ttu-id="ad709-146">Sincronização de CPU e GPU</span><span class="sxs-lookup"><span data-stu-id="ad709-146">CPU and GPU synchronization</span></span>

<span data-ttu-id="ad709-147">O DirectML não envia nenhum trabalho para execução na GPU.</span><span class="sxs-lookup"><span data-stu-id="ad709-147">DirectML doesn't itself submit any work for execution on the GPU.</span></span> <span data-ttu-id="ad709-148">Em vez disso, o [método **IDMLCommandRecorder:: RecordDispatch**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) *registra* a expedição desse trabalho em uma lista de comandos para execução posterior.</span><span class="sxs-lookup"><span data-stu-id="ad709-148">Instead, the [**IDMLCommandRecorder::RecordDispatch** method](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) *records* the dispatch of that work into a command list for later execution.</span></span> <span data-ttu-id="ad709-149">Seu aplicativo deve fechar e enviar sua lista de comandos para execução chamando [**ID3D12CommandQueue:: ExecuteCommandLists**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-executecommandlists), como com qualquer lista de comandos do Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="ad709-149">Your application must then close and submit its command list for execution by calling [**ID3D12CommandQueue::ExecuteCommandLists**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-executecommandlists), as with any Direct3D 12 command list.</span></span>

<span data-ttu-id="ad709-150">Como o DirectML não envia nenhum trabalho para execução na GPU, ele também não cria nenhum limite nem executa qualquer forma de sincronização de CPU/GPU em seu nome.</span><span class="sxs-lookup"><span data-stu-id="ad709-150">Because DirectML doesn't itself submit any work for execution on the GPU, it also doesn't create any fences, nor perform any form of CPU/GPU synchronization on your behalf.</span></span> <span data-ttu-id="ad709-151">É responsabilidade do seu aplicativo usar os primitivos do Direct3D 12 apropriados para aguardar o trabalho enviado para concluir a execução na GPU, se necessário.</span><span class="sxs-lookup"><span data-stu-id="ad709-151">It is the responsibility of your application to use the appropriate Direct3D 12 primitives to wait for submitted work to complete execution on the GPU, if necessary.</span></span> <span data-ttu-id="ad709-152">Para obter mais informações, consulte [**ID3D12Fence**](/windows/desktop/api/d3d12/nn-d3d12-id3d12fence) e [**ID3D12CommandQueue:: Signal**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-signal).</span><span class="sxs-lookup"><span data-stu-id="ad709-152">For more info, see [**ID3D12Fence**](/windows/desktop/api/d3d12/nn-d3d12-id3d12fence) and [**ID3D12CommandQueue::Signal**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-signal).</span></span>

## <a name="see-also"></a><span data-ttu-id="ad709-153">Confira também</span><span class="sxs-lookup"><span data-stu-id="ad709-153">See also</span></span>

* [<span data-ttu-id="ad709-154">Executando e sincronizando listas de comandos</span><span class="sxs-lookup"><span data-stu-id="ad709-154">Executing and synchronizing command lists</span></span>](/windows/desktop/direct3d12/executing-and-synchronizing-command-lists)
* [<span data-ttu-id="ad709-155">Tratamento de erros e remoção de dispositivo no DirectML</span><span class="sxs-lookup"><span data-stu-id="ad709-155">Handling errors and device removal in DirectML</span></span>](dml-errors.md)