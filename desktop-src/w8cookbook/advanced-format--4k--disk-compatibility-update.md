---
title: Atualização de compatibilidade de disco de formato avançado (4K)
description: Atualização de compatibilidade de disco de formato avançado (4K)
ms.assetid: 2C9EB0CF-D27B-457A-8FE6-24824BCC084C
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0321570e5ed1cc09ef213e97bf4681b8ea0caec0
ms.sourcegitcommit: 773fa6257ead6c74154ad3cf46d21e49adc900aa
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/09/2020
ms.locfileid: "103824043"
---
# <a name="advanced-format-4k-disk-compatibility-update"></a><span data-ttu-id="523d5-103">Atualização de compatibilidade de disco de formato avançado (4K)</span><span class="sxs-lookup"><span data-stu-id="523d5-103">Advanced format (4K) disk compatibility update</span></span>

## <a name="platforms"></a><span data-ttu-id="523d5-104">Plataformas</span><span class="sxs-lookup"><span data-stu-id="523d5-104">Platforms</span></span>

<span data-ttu-id="523d5-105">**Clientes**   do   Windows XP Windows Vista Windows 7 Windows 7 \| \| SP1 Windows \| \| 8</span><span class="sxs-lookup"><span data-stu-id="523d5-105">**Clients**   Windows XP \| Windows Vista \| Windows 7 \| Windows 7 SP1 \| Windows 8</span></span>  
<span data-ttu-id="523d5-106">**Servidores**   do   Windows Server 2003 \| Windows server 2008 \| windows Server 2008 R2 \| Windows Server 2008 R2 SP1 \| Windows server 2012 \| Windows server 2012 R2 \| Windows Server 2016</span><span class="sxs-lookup"><span data-stu-id="523d5-106">**Servers**   Windows Server 2003 \| Windows Server 2008 \| Windows Server 2008 R2 \| Windows Server 2008 R2 SP1 \| Windows Server 2012 \| Windows Server 2012 R2 \| Windows Server 2016</span></span>  


## <a name="description"></a><span data-ttu-id="523d5-107">Descrição</span><span class="sxs-lookup"><span data-stu-id="523d5-107">Description</span></span>

<span data-ttu-id="523d5-108">Este artigo é uma versão atualizada do artigo intitulada atualização de compatibilidade de disco do 512e (emulação de 512 bytes), que foi lançada para o Windows 7 SP1 e o Windows Server 2008 R2 SP1.</span><span class="sxs-lookup"><span data-stu-id="523d5-108">This article is an updated version of the article titled  512-byte Emulation (512e) Disk Compatibility Update  which was released for Windows 7 SP1 and Windows Server 2008 R2 SP1.</span></span> <span data-ttu-id="523d5-109">Esta atualização contém muitas informações novas, algumas das quais são aplicáveis somente ao Windows 8 e ao Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="523d5-109">This update contains much new info, some of which is applicable only to Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="523d5-110">As densidades areais estão cada vez mais anuais e com o advento recente de 3 TB de discos, os mecanismos de correção de erros usados para lidar com a proporção de sinal-para-ruído (SNR) de redução estão ficando ineficientes; ou seja, uma maior quantidade de sobrecarga é necessária para garantir que a mídia seja utilizável.</span><span class="sxs-lookup"><span data-stu-id="523d5-110">Areal densities are increasing yearly, and with the recent advent of 3 TB disks, the error correction mechanisms used to deal with the decreasing signal-to-noise-ratio (SNR) are becoming space inefficient; that is, an increased amount of overhead is required to ensure the media is usable.</span></span> <span data-ttu-id="523d5-111">Uma das soluções do setor de armazenamento para melhorar esse mecanismo de correção de erros é introduzir um formato de mídia físico diferente que inclua um tamanho de setor físico maior.</span><span class="sxs-lookup"><span data-stu-id="523d5-111">One of the storage industry solutions for improving this error correction mechanism is to introduce a different physical media format that includes a larger physical sector size.</span></span> <span data-ttu-id="523d5-112">Esse novo formato de mídia física é chamado de formato avançado.</span><span class="sxs-lookup"><span data-stu-id="523d5-112">This new physical media format is called Advanced Format.</span></span> <span data-ttu-id="523d5-113">Portanto, não é mais seguro fazer suposições sobre o tamanho do setor de dispositivos de armazenamento modernos, e os desenvolvedores precisarão estudar as suposições subjacentes a seu código para determinar se há um impacto.</span><span class="sxs-lookup"><span data-stu-id="523d5-113">Therefore, it is no longer safe to make any assumptions regarding the sector size of modern storage devices, and developers will need to study the assumptions underlying their code to determine if there is an impact.</span></span>

<span data-ttu-id="523d5-114">Este tópico apresenta o efeito de dispositivos de armazenamento de formato avançado em software, discute o que os aplicativos podem fazer para ajudar a dar suporte a esse tipo de mídia e discute a infraestrutura que a Microsoft apresentou com o Windows Vista, o Windows 7 e o Windows 8 para permitir que os desenvolvedores ofereçam suporte a esses tipos de dispositivos.</span><span class="sxs-lookup"><span data-stu-id="523d5-114">This topic introduces the effect of Advanced Format storage devices on software, discusses what apps can do to help support this type of media, and discusses the infrastructure that Microsoft introduced with Windows Vista, Windows 7, and Windows 8 to enable developers to support these types of devices.</span></span> <span data-ttu-id="523d5-115">Embora o material apresentado neste tópico forneça diretrizes para melhorar a compatibilidade com discos de formato avançado, as informações se aplicam em geral a todos os sistemas com discos de formato avançado que executam o Windows Vista, o Windows 7 e o Windows 8.</span><span class="sxs-lookup"><span data-stu-id="523d5-115">While the material presented in this topic provides guidelines for improving compatibility with Advanced Format disks, the info applies generally to all systems with Advanced Format disks running Windows Vista, Windows 7, and Windows 8.</span></span>

<span data-ttu-id="523d5-116">**Resumo dos novos recursos relacionados ao setor de grande porte**</span><span class="sxs-lookup"><span data-stu-id="523d5-116">**Summary of new large sector related features**</span></span>

<span data-ttu-id="523d5-117">A lista abaixo resume os novos recursos fornecidos como parte do Windows 8 e do Windows Server 2012 para ajudar a melhorar a experiência do cliente e do desenvolvedor com discos de setor grande.</span><span class="sxs-lookup"><span data-stu-id="523d5-117">The below list summarizes the new features delivered as part of Windows 8 and Windows Server 2012 to help improve customer and developer experience with large sector disks.</span></span> <span data-ttu-id="523d5-118">Uma descrição mais detalhada para cada item é seguida.</span><span class="sxs-lookup"><span data-stu-id="523d5-118">More detailed description for each item follow.</span></span>

-   <span data-ttu-id="523d5-119">Baseia-se no suporte do Windows 7 SP1 para 4K disks with emulation (512e) e fornece suporte de caixa de entrada completo para discos com tamanho de setor de 4K sem emulação (nativo de 4K).</span><span class="sxs-lookup"><span data-stu-id="523d5-119">Builds upon the Windows 7 SP1 support for 4K disks with emulation (512e), and provides full inbox support for disks with 4K sector size without emulation (4K Native).</span></span> <span data-ttu-id="523d5-120">Alguns aplicativos e cenários com suporte incluem:</span><span class="sxs-lookup"><span data-stu-id="523d5-120">Some supported apps and scenarios include:</span></span>
    -   <span data-ttu-id="523d5-121">Capacidade de instalar o Windows e inicializar de um disco de setor de 4K sem emulação (disco nativo de 4K)</span><span class="sxs-lookup"><span data-stu-id="523d5-121">Ability to install Windows to and boot from a 4K sector disk without emulation (4K Native Disk)</span></span>
    -   <span data-ttu-id="523d5-122">VHD e novo formato de arquivo VHDX</span><span class="sxs-lookup"><span data-stu-id="523d5-122">VHD and new VHDX file format</span></span>
    -   <span data-ttu-id="523d5-123">Suporte completo para HyperV</span><span class="sxs-lookup"><span data-stu-id="523d5-123">Full HyperV support</span></span>
    -   <span data-ttu-id="523d5-124">Backup do Windows</span><span class="sxs-lookup"><span data-stu-id="523d5-124">Windows backup</span></span>
    -   <span data-ttu-id="523d5-125">Suporte completo no sistema de arquivos NT (NTFS)</span><span class="sxs-lookup"><span data-stu-id="523d5-125">Full support in the NT file system (NTFS)</span></span>
    -   <span data-ttu-id="523d5-126">Suporte completo com novos espaços de armazenamento e pools (SSP)</span><span class="sxs-lookup"><span data-stu-id="523d5-126">Full support with new Storage Spaces and Pools (SSP)</span></span>
    -   <span data-ttu-id="523d5-127">Suporte completo com o Windows Defender</span><span class="sxs-lookup"><span data-stu-id="523d5-127">Full support with Windows Defender</span></span>
-   <span data-ttu-id="523d5-128">Fornece uma nova API para consultar o tamanho do setor físico (FileFsSectorSizeInformation):</span><span class="sxs-lookup"><span data-stu-id="523d5-128">Provides a new API to query for physical sector size (FileFsSectorSizeInformation):</span></span>
    -   <span data-ttu-id="523d5-129">Disponível para volumes de rede</span><span class="sxs-lookup"><span data-stu-id="523d5-129">Available for network volumes</span></span>
    -   <span data-ttu-id="523d5-130">Pode ser emitido para qualquer identificador de arquivo</span><span class="sxs-lookup"><span data-stu-id="523d5-130">Can be issued to any file handle</span></span>
    -   <span data-ttu-id="523d5-131">Disponível para aplicativos sem privilégios</span><span class="sxs-lookup"><span data-stu-id="523d5-131">Available for unprivileged apps</span></span>
    -   <span data-ttu-id="523d5-132">Modelo de uso mais amigável</span><span class="sxs-lookup"><span data-stu-id="523d5-132">Friendlier usage model</span></span>
-   <span data-ttu-id="523d5-133">Inclui o utilitário de linha de comando fsutil aprimorado para consultar o tamanho do setor lógico e físico do volume com informações de alinhamento (a versão básica do utilitário sem informações de alinhamento está disponível para o Windows 7 com Microsoft KB 982018 e Windows Server 2008 R2 com Microsoft KB 982018)</span><span class="sxs-lookup"><span data-stu-id="523d5-133">Includes enhanced  fsutil  command line utility to query for logical and physical sector size of volume with alignment info (basic version of utility without alignment info is available for Windows 7 with Microsoft KB 982018 and Windows Server 2008 R2 with Microsoft KB 982018)</span></span>

<span data-ttu-id="523d5-134">**Introdução aos discos de formato avançado (4K)**</span><span class="sxs-lookup"><span data-stu-id="523d5-134">**Introduction to advanced format (4K) disks**</span></span>

<span data-ttu-id="523d5-135">Um dos problemas de introduzir essa alteração no formato de mídia é o potencial para introduzir problemas de compatibilidade com software e hardware existentes.</span><span class="sxs-lookup"><span data-stu-id="523d5-135">One of the problems of introducing this change in the media format is the potential for introducing compatibility issues with existing software and hardware.</span></span> <span data-ttu-id="523d5-136">Como solução de compatibilidade temporária, o setor de armazenamento está inicialmente introduzindo discos que emulam um disco de setor de 512 bytes comum, mas disponibilizam informações sobre o tamanho real do setor por meio de comandos ATA e SCSI padrão.</span><span class="sxs-lookup"><span data-stu-id="523d5-136">As a temporary compatibility solution, the storage industry is initially introducing disks that emulate a regular 512-byte sector disk, but make available info about the true sector size through standard ATA and SCSI commands.</span></span> <span data-ttu-id="523d5-137">Como resultado dessa emulação, há, em essência, dois tamanhos de setor:</span><span class="sxs-lookup"><span data-stu-id="523d5-137">As a result of this emulation, there are, in essence, two sector sizes:</span></span>

<span data-ttu-id="523d5-138">**Setor lógico:** A unidade usada para endereçamento de bloco lógico para a mídia.</span><span class="sxs-lookup"><span data-stu-id="523d5-138">**Logical sector:** The unit that is used for logical block addressing for the media.</span></span> <span data-ttu-id="523d5-139">Também podemos considerar isso como a menor unidade de gravação que o armazenamento pode aceitar.</span><span class="sxs-lookup"><span data-stu-id="523d5-139">We can also think of it as the smallest unit of write that the storage can accept.</span></span> <span data-ttu-id="523d5-140">Esta é a emulação.</span><span class="sxs-lookup"><span data-stu-id="523d5-140">This is the  emulation.</span></span>   
<span data-ttu-id="523d5-141">**Setor físico:** A unidade para a qual as operações de leitura e gravação para o dispositivo são concluídas em uma única operação.</span><span class="sxs-lookup"><span data-stu-id="523d5-141">**Physical sector:** The unit for which read and write operations to the device are completed in a single operation.</span></span> <span data-ttu-id="523d5-142">Esta é a unidade de gravação atômica.</span><span class="sxs-lookup"><span data-stu-id="523d5-142">This is the unit of atomic write.</span></span>  
 <span data-ttu-id="523d5-143">A maioria das APIs do Windows atuais, como o disco do IOCTL, a \_ \_ \_ \_ geometria da unidade retornará o tamanho do setor lógico, mas o tamanho do setor físico pode ser recuperado por meio do código de controle da propriedade de consulta de armazenamento do IOCTL, com as informações relevantes contidas no campo BytesPerPhysicalSector na estrutura do <a href="/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor"> \_ \_ \_ descritor de alinhamento de acesso de armazenamento</a> . <a href="/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property"> \_ \_ \_ </a></span><span class="sxs-lookup"><span data-stu-id="523d5-143">Most current Windows APIs, such as IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY will return the logical sector size, but the physical sector size can be retrieved through the <a href="/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property">IOCTL\_STORAGE\_QUERY\_PROPERTY</a> control code, with the relevant info contained in the BytesPerPhysicalSector field in the <a href="/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor">STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR</a> structure.</span></span> <span data-ttu-id="523d5-144">Isso é discutido em mais detalhes posteriormente neste artigo.</span><span class="sxs-lookup"><span data-stu-id="523d5-144">This is discussed in more detail later in the article.</span></span>

<span data-ttu-id="523d5-145">**Tipos iniciais de mídia de setor grande**</span><span class="sxs-lookup"><span data-stu-id="523d5-145">**Initial types of large sector media**</span></span>

<span data-ttu-id="523d5-146">O setor de armazenamento está aumentando rapidamente os esforços para fazer a transição para esse novo tipo de formato avançado de armazenamento para mídia com um tamanho de setor físico de 4 KB.</span><span class="sxs-lookup"><span data-stu-id="523d5-146">The storage industry is quickly ramping up efforts to transition to this new Advanced Format type of storage for media having a 4 KB physical sector size.</span></span> <span data-ttu-id="523d5-147">Dois tipos de mídia serão liberados para o mercado:</span><span class="sxs-lookup"><span data-stu-id="523d5-147">Two types of media will be released to the market:</span></span>

<span data-ttu-id="523d5-148">**4 KB nativos:** Esta mídia não tem camada de emulação e expõe diretamente 4 KB como seu tamanho de setor lógico e físico.</span><span class="sxs-lookup"><span data-stu-id="523d5-148">**4 KB native:** This media has no emulation layer and directly exposes 4 KB as its logical and physical sector size.</span></span> <span data-ttu-id="523d5-149">O problema geral com esse novo tipo de mídia é que a maioria dos aplicativos e sistemas operacionais não consultam e alinham e/SS ao tamanho do setor físico, o que pode resultar em e/SS com falha inesperada.</span><span class="sxs-lookup"><span data-stu-id="523d5-149">The overall issue with this new type of media is that the majority of apps and operating systems do not query for and align I/Os to the physical sector size, which can result in unexpected failed I/Os.</span></span>  
<span data-ttu-id="523d5-150">**emulação de 512 bytes (512e):** Esta mídia tem uma camada de emulação, conforme discutido na seção anterior, e expõe 512-bytes como seu tamanho de setor lógico (semelhante a um disco normal hoje), mas torna suas informações de tamanho de setor físico (4 KB) disponíveis.</span><span class="sxs-lookup"><span data-stu-id="523d5-150">**512-byte emulation (512e):** This media has an emulation layer as discussed in the previous section and exposes 512-bytes as its logical sector size (similar to a regular disk today), but makes its physical sector size info (4 KB) available.</span></span> <span data-ttu-id="523d5-151">O problema geral com esse novo tipo de mídia é que a maioria dos aplicativos e sistemas operacionais não compreendem a existência do tamanho do setor físico, o que pode resultar em vários problemas, conforme será discutido abaixo.</span><span class="sxs-lookup"><span data-stu-id="523d5-151">The overall issue with this new type of media is that the majority of app and operating systems do not understand the existence of the physical sector size, which can result in a number of issues as will be discussed below.</span></span>  
<span data-ttu-id="523d5-152">**Suporte geral do Windows para mídia de setor grande**</span><span class="sxs-lookup"><span data-stu-id="523d5-152">**Overall Windows support for large sector media**</span></span>

<span data-ttu-id="523d5-153">Esta tabela documenta a política oficial de suporte da Microsoft para várias mídias e seus tamanhos de setor relatados resultantes.</span><span class="sxs-lookup"><span data-stu-id="523d5-153">This table documents the official Microsoft support policy for various media and their resulting reported sector sizes.</span></span> <span data-ttu-id="523d5-154">Consulte este [artigo da base de conhecimento](https://support.microsoft.com/kb/2510009) para obter detalhes.</span><span class="sxs-lookup"><span data-stu-id="523d5-154">See this [KB article](https://support.microsoft.com/kb/2510009) for details.</span></span>



| <span data-ttu-id="523d5-155">Nomes comuns</span><span class="sxs-lookup"><span data-stu-id="523d5-155">Common Names</span></span>                                  | <span data-ttu-id="523d5-156">Tamanho do setor lógico relatado</span><span class="sxs-lookup"><span data-stu-id="523d5-156">Reported Logical Sector Size</span></span> | <span data-ttu-id="523d5-157">Tamanho do setor físico relatado</span><span class="sxs-lookup"><span data-stu-id="523d5-157">Reported Physical Sector Size</span></span> | <span data-ttu-id="523d5-158">Versão do Windows com suporte</span><span class="sxs-lookup"><span data-stu-id="523d5-158">Windows Version with Support</span></span>                                                                                                                                                                                                                                                                             |
|-----------------------------------------------|------------------------------|-------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="523d5-159">512-byte nativo, 512n</span><span class="sxs-lookup"><span data-stu-id="523d5-159">512-byte Native, 512n</span></span>                         | <span data-ttu-id="523d5-160">512 bytes</span><span class="sxs-lookup"><span data-stu-id="523d5-160">512 bytes</span></span>                    | <span data-ttu-id="523d5-161">512 bytes</span><span class="sxs-lookup"><span data-stu-id="523d5-161">512 bytes</span></span>                     | <span data-ttu-id="523d5-162">Todas as versões do Windows</span><span class="sxs-lookup"><span data-stu-id="523d5-162">All Windows versions</span></span>                                                                                                                                                                                                                                                                                     |
| <span data-ttu-id="523d5-163">Formato avançado, 512e, AF, 512-emulação de byte</span><span class="sxs-lookup"><span data-stu-id="523d5-163">Advanced Format, 512e, AF, 512-byte Emulation</span></span> | <span data-ttu-id="523d5-164">512 bytes</span><span class="sxs-lookup"><span data-stu-id="523d5-164">512 bytes</span></span>                    | <span data-ttu-id="523d5-165">4 KB</span><span class="sxs-lookup"><span data-stu-id="523d5-165">4 KB</span></span>                          | <span data-ttu-id="523d5-166">Windows Vista w/MS KB 2553708</span><span class="sxs-lookup"><span data-stu-id="523d5-166">Windows Vista w/ MS KB 2553708</span></span> <br/> <span data-ttu-id="523d5-167">Windows Server 2008 \* w/MS KB 2553708</span><span class="sxs-lookup"><span data-stu-id="523d5-167">Windows Server 2008\* w/ MS KB 2553708</span></span> <br/> <span data-ttu-id="523d5-168">Windows 7 w/MS KB 982018</span><span class="sxs-lookup"><span data-stu-id="523d5-168">Windows 7 w/ MS KB 982018</span></span> <br/> <span data-ttu-id="523d5-169">Windows Server 2008 R2 \* w/MS KB 982018</span><span class="sxs-lookup"><span data-stu-id="523d5-169">Windows Server 2008 R2\* w/ MS KB 982018</span></span> <br/> <span data-ttu-id="523d5-170">Todas as versões do Windows do Windows 7 SP1 e posteriores.</span><span class="sxs-lookup"><span data-stu-id="523d5-170">All Windows versions from Windows 7 SP1 and beyond.</span></span> <br/> <span data-ttu-id="523d5-171">Todas as versões do servidor do Server 2008 R2 SP1 e posteriores.</span><span class="sxs-lookup"><span data-stu-id="523d5-171">All Server versions from Server 2008 R2 SP1 and beyond.</span></span> <br/> <br/> <span data-ttu-id="523d5-172">\*Exceto para o Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="523d5-172">\*Except for Hyper-V.</span></span> <span data-ttu-id="523d5-173">Consulte a seção ["requisitos de suporte de aplicativo para unidades de setor grande"](https://support.microsoft.com/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows) .</span><span class="sxs-lookup"><span data-stu-id="523d5-173">See the ["Application support requirements for large-sector drives"](https://support.microsoft.com/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows) section.</span></span> |
| <span data-ttu-id="523d5-174">Formato avançado, AF, 4K nativo, 4Kn</span><span class="sxs-lookup"><span data-stu-id="523d5-174">Advance Format, AF, 4K Native, 4Kn</span></span>            | <span data-ttu-id="523d5-175">4 KB</span><span class="sxs-lookup"><span data-stu-id="523d5-175">4 KB</span></span>                         | <span data-ttu-id="523d5-176">4 KB</span><span class="sxs-lookup"><span data-stu-id="523d5-176">4 KB</span></span>                          | <span data-ttu-id="523d5-177">Todas as versões do Windows do Windows 8 e posteriores</span><span class="sxs-lookup"><span data-stu-id="523d5-177">All Windows versions from Windows 8 and beyond</span></span> <br/> <span data-ttu-id="523d5-178">Todas as versões do servidor do Windows Server 2012 e posteriores</span><span class="sxs-lookup"><span data-stu-id="523d5-178">All Server versions from Windows Server 2012 and beyond</span></span> <br/>                                                                                                                                                                                                                                                      |
| <span data-ttu-id="523d5-179">Outro</span><span class="sxs-lookup"><span data-stu-id="523d5-179">Other</span></span>                                         | <span data-ttu-id="523d5-180">Não 4 KB ou 512 bytes</span><span class="sxs-lookup"><span data-stu-id="523d5-180">Not 4 KB or 512 bytes</span></span>        | <span data-ttu-id="523d5-181">Não 4 KB ou 512 bytes</span><span class="sxs-lookup"><span data-stu-id="523d5-181">Not 4 KB or 512 bytes</span></span>         | <span data-ttu-id="523d5-182">Sem suporte</span><span class="sxs-lookup"><span data-stu-id="523d5-182">Not supported</span></span>                                                                                                                                                                                                                                                                                            |



 

> [!Note]  
> <span data-ttu-id="523d5-183">Embora não esteja sob pressão na tabela anterior, o Windows XP, o Windows Server 2003 e o Windows Server 2003 R2 não dão suporte à mídia 512e ou 4Kn.</span><span class="sxs-lookup"><span data-stu-id="523d5-183">While not stressed in the preceding table, Windows XP, Windows Server 2003, and Windows Server 2003 R2 do not support 512e or 4Kn media.</span></span> <span data-ttu-id="523d5-184">Embora o sistema possa ser inicializado e possa operar minimamente, pode haver cenários desconhecidos de problemas de funcionalidade, perda de dados ou desempenho abaixo do ideal.</span><span class="sxs-lookup"><span data-stu-id="523d5-184">While the system may boot up and be able to operate minimally, there may be unknown scenarios of functionality issues, data loss, or sub-optimal performance.</span></span> <span data-ttu-id="523d5-185">Portanto, a Microsoft tem bastante cuidado com o uso de mídia 512e com o Windows XP ou outros produtos baseados na base de código do Windows XP (como o Windows Home Server 1,0, Windows Server 2003, Windows Server 2003 R2, Windows XP 64-bit Edition, Windows XP Embedded, Windows Small Business Server 2003 e Windows Small Business Server 2003 R2).</span><span class="sxs-lookup"><span data-stu-id="523d5-185">Thus, Microsoft strongly cautions against using 512e media with Windows XP or other products based on the Windows XP codebase (such as Windows Home Server 1.0, Windows Server 2003, Windows Server 2003 R2, Windows XP 64-bit Edition, Windows XP Embedded, Windows Small Business Server 2003, and Windows Small Business Server 2003 R2).</span></span>

 

## <a name="how-emulation-works-read-modify-write-rmw"></a><span data-ttu-id="523d5-186">Como a emulação funciona: Read-Modify-Write (RMW)</span><span class="sxs-lookup"><span data-stu-id="523d5-186">How emulation works: read-modify-write (RMW)</span></span>

<span data-ttu-id="523d5-187">Uma mídia de armazenamento tem uma determinada unidade dentro da qual a mídia física pode ser modificada.</span><span class="sxs-lookup"><span data-stu-id="523d5-187">A storage medium has a certain unit within which the physical medium can be modified.</span></span> <span data-ttu-id="523d5-188">Ou seja, a mídia só pode ser gravada ou reescrita, em unidades do tamanho do setor físico.</span><span class="sxs-lookup"><span data-stu-id="523d5-188">That is, the media can only be written, or rewritten, in units of the physical sector size.</span></span> <span data-ttu-id="523d5-189">Assim, as gravações não executadas nesse nível de unidade exigirão etapas adicionais, que veremos o exemplo abaixo.</span><span class="sxs-lookup"><span data-stu-id="523d5-189">Thus, writes that are not performed at this unit level would require additional steps, which we will walk through the example below.</span></span>

<span data-ttu-id="523d5-190">Nesse cenário, um aplicativo precisa atualizar o conteúdo de um registro Datastor localizado em um setor lógico de 512 bytes.</span><span class="sxs-lookup"><span data-stu-id="523d5-190">In this scenario, an app needs to update the contents of a Datastor record located within a 512-byte logical sector.</span></span> <span data-ttu-id="523d5-191">Este diagrama ilustra as etapas necessárias para que o dispositivo de armazenamento conclua a gravação:</span><span class="sxs-lookup"><span data-stu-id="523d5-191">This diagram illustrates the steps necessary for the storage device to complete the write:</span></span>

![etapas para um dispositivo de armazenamento concluir uma gravação](images/512ermwsteps.png)

<span data-ttu-id="523d5-193">Conforme ilustrado acima, esse processo envolve algum trabalho pelo dispositivo de armazenamento que pode resultar em uma perda de desempenho.</span><span class="sxs-lookup"><span data-stu-id="523d5-193">As illustrated above, this process involves some work by the storage device that can result in a performance loss.</span></span> <span data-ttu-id="523d5-194">Para evitar esse trabalho adicional, os aplicativos devem ser atualizados para:</span><span class="sxs-lookup"><span data-stu-id="523d5-194">To avoid this additional work, apps must be updated to:</span></span>

-   <span data-ttu-id="523d5-195">Consultar o tamanho do setor físico</span><span class="sxs-lookup"><span data-stu-id="523d5-195">Query for the physical sector size</span></span>
-   <span data-ttu-id="523d5-196">Verifique se as gravações estão alinhadas ao tamanho do setor físico relatado</span><span class="sxs-lookup"><span data-stu-id="523d5-196">Ensure writes are aligned to that reported physical sector size</span></span>

<span data-ttu-id="523d5-197">Embora isso inicialmente pareça ser apenas um problema de desempenho, pode haver um problema mais sério.</span><span class="sxs-lookup"><span data-stu-id="523d5-197">While this may initially appear to be only a performance issue, there can be more serious issue.</span></span> <span data-ttu-id="523d5-198">Vamos discutir isso na próxima seção.</span><span class="sxs-lookup"><span data-stu-id="523d5-198">Let s discuss this in the next section.</span></span>

<span data-ttu-id="523d5-199">**Resiliência: o custo oculto de Read-Modify-Write**</span><span class="sxs-lookup"><span data-stu-id="523d5-199">**Resiliency: the hidden cost of read-modify-write**</span></span>

<span data-ttu-id="523d5-200">A resiliência fala sobre a capacidade de um aplicativo de recuperar o estado entre as sessões.</span><span class="sxs-lookup"><span data-stu-id="523d5-200">Resiliency speaks of the ability of an app to recover state between sessions.</span></span> <span data-ttu-id="523d5-201">Vimos o que é necessário para um dispositivo de armazenamento 512e executar um setor de 512 bytes gravar o ciclo de leitura-modificação-gravação.</span><span class="sxs-lookup"><span data-stu-id="523d5-201">We have seen what is necessary for a 512e storage device to perform a 512-byte sector write   the Read-Modify-Write cycle.</span></span> <span data-ttu-id="523d5-202">Vamos examinar o que aconteceria se o processo de substituição do setor físico anterior na mídia fosse interrompido.</span><span class="sxs-lookup"><span data-stu-id="523d5-202">Let s look at what would happen if the process of overwriting the previous physical sector on the media was interrupted.</span></span> <span data-ttu-id="523d5-203">Quais seriam as consequências?</span><span class="sxs-lookup"><span data-stu-id="523d5-203">What would be the consequences?</span></span>

-   <span data-ttu-id="523d5-204">Como a maioria das unidades de disco rígido é atualizada no local, o setor físico, que é, a parte da mídia em que o setor físico foi localizado pode ter sido corrompido com informações incompletas devido a uma substituição parcial.</span><span class="sxs-lookup"><span data-stu-id="523d5-204">Because most hard disk drives update in place, the physical sector   that is, the portion of the media where the physical sector was located   could have been corrupted with incomplete info due to a partial overwrite.</span></span> <span data-ttu-id="523d5-205">Em outras palavras, você pode imaginar como potencialmente ter perdido todos os 8 setores lógicos (que o setor físico contém logicamente).</span><span class="sxs-lookup"><span data-stu-id="523d5-205">Put another way, you can think of it as potentially having lost all 8 logical sectors (which the physical sector logically contains).</span></span>
-   <span data-ttu-id="523d5-206">Embora a maioria dos aplicativos com um armazenamento de dados seja projetada com a capacidade de se recuperar de erros de mídia, a perda de oito setores ou colocar outra maneira, a perda de oito registros de confirmação, pode potencialmente tornar impossível para o armazenamento de dados se recuperar normalmente.</span><span class="sxs-lookup"><span data-stu-id="523d5-206">While most apps with a data store are designed with the capability to recover from media errors, the loss of eight sectors, or put another way, the loss of eight commit records, can potentially make it impossible for the data store to recover gracefully.</span></span> <span data-ttu-id="523d5-207">Um administrador pode precisar restaurar manualmente o banco de dados de um backup ou pode até mesmo precisar executar uma recompilação demorada.</span><span class="sxs-lookup"><span data-stu-id="523d5-207">An administrator may need to manually restore the database from a backup or may even need to perform a lengthy rebuild.</span></span>
-   <span data-ttu-id="523d5-208">Um impacto mais importante é que o ato de outro aplicativo causando um ciclo de leitura-modificação-gravação pode potencialmente causar a perda dos dados, mesmo que seu aplicativo não esteja em execução!</span><span class="sxs-lookup"><span data-stu-id="523d5-208">One more important impact is that the act of another app causing a Read-Modify-Write cycle can potentially cause your data to be lost   even if your app is not running!</span></span> <span data-ttu-id="523d5-209">Isso é simplesmente porque seus dados e os outros dados de aplicativos podem estar localizados no mesmo setor físico.</span><span class="sxs-lookup"><span data-stu-id="523d5-209">This is simply because your data and the other app s data could be located within the same physical sector.</span></span>

<span data-ttu-id="523d5-210">Com isso em mente, é importante que o software de aplicativo reavalie as suposições tomadas no código e esteja atento à distinção de tamanho de setor físico lógico, juntamente com alguns cenários de clientes interessantes discutidos posteriormente neste artigo.</span><span class="sxs-lookup"><span data-stu-id="523d5-210">With this in mind, it is important that app software reevaluate any assumptions taken in the code, and be aware of the logical-physical sector size distinction, along with some interesting customer scenarios discussed later in this article.</span></span>

<span data-ttu-id="523d5-211">**Fazendo a coisa certa (evitando Read-Modify-Write)**</span><span class="sxs-lookup"><span data-stu-id="523d5-211">**Doing the right thing (avoiding read-modify-write)**</span></span>

<span data-ttu-id="523d5-212">Embora alguns fornecedores de armazenamento possam estar introduzindo alguns níveis de mitigação em determinados dispositivos de armazenamento 512e para tentar facilitar os problemas de desempenho e resiliência do ciclo de leitura-modificação-gravação, há apenas que qualquer mitigação pode lidar em termos de carga de trabalho.</span><span class="sxs-lookup"><span data-stu-id="523d5-212">While some storage vendors may be introducing some levels of mitigation within certain 512e storage devices to try to ease the performance and resiliency issues of the Read-Modify-Write cycle, there is only so much any mitigation can handle in terms of workload.</span></span> <span data-ttu-id="523d5-213">Dessa forma, os aplicativos não devem contar com essa mitigação como uma solução de longo prazo.</span><span class="sxs-lookup"><span data-stu-id="523d5-213">As such, apps should not rely on this mitigation as a long-term solution.</span></span> <span data-ttu-id="523d5-214">Além disso, não há nenhuma garantia de que todas as classes de discos terão essa mitigação em vigor, nem há uma garantia de que a mitigação é bem projetada.</span><span class="sxs-lookup"><span data-stu-id="523d5-214">Moreover, there is no guarantee that all classes of disks will have this mitigation in place, nor is there a guarantee that the mitigation is well-designed.</span></span>

<span data-ttu-id="523d5-215">A solução para isso não é mitigação na unidade, mas para criar aplicativos para fazer o conjunto certo de coisas para ajudar a dar suporte a esse tipo de mídia.</span><span class="sxs-lookup"><span data-stu-id="523d5-215">The solution to this is not in-drive mitigation, but to design apps to do the right set of things to help support this type of media.</span></span> <span data-ttu-id="523d5-216">Esta seção aborda cenários comuns em que os aplicativos podem ter problemas com discos de setor grande e sugere uma avenida de investigação para tentar resolver cada problema.</span><span class="sxs-lookup"><span data-stu-id="523d5-216">This section discusses common scenarios where apps may have issues with large sector disks, and suggests an avenue of investigation to try and resolve each issue.</span></span>

<span data-ttu-id="523d5-217">**Problema 1: a partição não está alinhada a um limite de setor físico**</span><span class="sxs-lookup"><span data-stu-id="523d5-217">**Issue 1: the partition is not aligned to a physical sector boundary**</span></span>

<span data-ttu-id="523d5-218">Quando o administrador/usuário particiona o disco, a primeira partição pode não ter sido criada em um limite alinhado.</span><span class="sxs-lookup"><span data-stu-id="523d5-218">When the administrator/user partitions the disk, the first partition may not have been created on an aligned boundary.</span></span> <span data-ttu-id="523d5-219">Isso pode fazer com que todas as gravações subsequentes fiquem desalinhadas aos limites do setor físico.</span><span class="sxs-lookup"><span data-stu-id="523d5-219">This may cause all subsequent writes to become unaligned to physical sector boundaries.</span></span> <span data-ttu-id="523d5-220">A partir do Windows Vista SP1 e do Windows Server 2008, a primeira partição é colocada no primeiro 1024 KB do disco (para discos de 4 GB ou maiores, caso contrário, o alinhamento é 64 KB) que está alinhado a um limite de setor físico de 4 KB.</span><span class="sxs-lookup"><span data-stu-id="523d5-220">As of Windows Vista SP1 and Windows Server 2008, the first partition is placed at the first 1024 KB of the disk (for disks 4GB or larger, otherwise the alignment is 64 KB) that is aligned to a 4 KB physical sector boundary.</span></span> <span data-ttu-id="523d5-221">No entanto, considerando o particionamento padrão no Windows XP, um utilitário de particionamento de terceiros ou um uso incorreto de APIs do Windows, as partições criadas não podem ser alinhadas a um limite de setor físico.</span><span class="sxs-lookup"><span data-stu-id="523d5-221">However, given the default partitioning in Windows XP, a 3rd party partitioning utility or incorrect usage of Windows APIs, created partitions may not be aligned to a physical sector boundary.</span></span> <span data-ttu-id="523d5-222">Os desenvolvedores precisarão garantir que as APIs corretas sejam usadas para ajudar a garantir o alinhamento.</span><span class="sxs-lookup"><span data-stu-id="523d5-222">Developers will need to ensure that the correct APIs are used to help ensure alignment.</span></span> <span data-ttu-id="523d5-223">As APIs recomendadas para ajudar a garantir que o alinhamento da partição seja descrito abaixo.</span><span class="sxs-lookup"><span data-stu-id="523d5-223">The recommended APIs to help ensure partition alignment are outlined below.</span></span>

<span data-ttu-id="523d5-224">As APIs IVdsPack:: createvolume e IVdsPack2:: CreateVolume2 não usam o parâmetro de alinhamento especificado quando um novo volume é criado, mas usa o valor de alinhamento padrão para o sistema operacional (pré-Windows Vista SP1 usará 63 bytes, e o post Windows Vista SP1 usará os padrões declarados acima).</span><span class="sxs-lookup"><span data-stu-id="523d5-224">The IVdsPack::CreateVolume and IVdsPack2::CreateVolume2 APIs do not use the specified alignment parameter when a new volume is created, but rather use the alignment value default for the operating system (Pre-Windows Vista SP1 will use 63 bytes, and post Windows Vista SP1 will use the defaults stated above).</span></span> <span data-ttu-id="523d5-225">Em vez disso, use as APIs IVdsCreatePartitionEx:: CreatePartitionEx ou IVdsAdvancedDisk:: CreatePartition que usam o parâmetro de alinhamento especificado para os aplicativos que precisam criar partições.</span><span class="sxs-lookup"><span data-stu-id="523d5-225">Instead, use the IVdsCreatePartitionEx::CreatePartitionEx or IVdsAdvancedDisk::CreatePartition APIs that use the specified alignment parameter for those apps that need to create partitions.</span></span>

<span data-ttu-id="523d5-226">A melhor maneira de ajudar a garantir que o alinhamento esteja correto é fazer isso corretamente ao criar inicialmente a partição.</span><span class="sxs-lookup"><span data-stu-id="523d5-226">The best way to help ensure that alignment is correct is to do it right when initially creating the partition.</span></span> <span data-ttu-id="523d5-227">Caso contrário, seu aplicativo precisará colocar o alinhamento em conta ao executar gravações ou na inicialização, o que pode ser um processo muito complexo.</span><span class="sxs-lookup"><span data-stu-id="523d5-227">Otherwise your app will need to take alignment into account when performing writes or at initialization   which can be a very complex process.</span></span>

<span data-ttu-id="523d5-228">**Problema 2: gravações sem buffer não alinhadas ao tamanho do setor físico**</span><span class="sxs-lookup"><span data-stu-id="523d5-228">**Issue 2: unbuffered writes not aligned to physical sector size**</span></span>

<span data-ttu-id="523d5-229">A questão mais simples é que as gravações sem buffer não estão alinhadas ao tamanho do setor físico relatado da mídia de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="523d5-229">The simplest issue is that unbuffered writes are not aligned to the reported physical sector size of the storage media.</span></span> <span data-ttu-id="523d5-230">Gravações em buffer, por outro lado, são alinhadas ao tamanho da página 4 KB, que coincidente é o tamanho do setor físico da primeira geração de mídia de setor grande.</span><span class="sxs-lookup"><span data-stu-id="523d5-230">Buffered writes, on the other hand, are aligned to the page size   4 KB   which coincidently is the physical sector size of the first generation of large sector media.</span></span> <span data-ttu-id="523d5-231">No entanto, a maioria dos aplicativos com um armazenamento de dados executa gravações sem buffer e, portanto, precisará garantir que essas gravações sejam executadas em unidades do tamanho do setor físico.</span><span class="sxs-lookup"><span data-stu-id="523d5-231">However, most apps with a data store perform unbuffered writes, and thus will need to ensure these writes are performed in units of the physical sector size.</span></span>

<span data-ttu-id="523d5-232">Alguns exemplos de cenários em que a e/s de aplicativo resultante não está alinhada:</span><span class="sxs-lookup"><span data-stu-id="523d5-232">Some examples of scenarios where the resulting app I/O is unaligned:</span></span>

<span data-ttu-id="523d5-233">Os **registros de confirmação são preenchidos em setores de 512 bytes:** Aplicativos com um armazenamento de dados normalmente têm alguma forma de registro de confirmação que mantém informações sobre alterações de metadados ou mantém a estrutura do armazenamento de dados.</span><span class="sxs-lookup"><span data-stu-id="523d5-233">**Commit records are padded to 512-byte sectors:** Apps with a data store typically have some form of commit record that either maintains info about metadata changes or maintains the structure of the data store.</span></span> <span data-ttu-id="523d5-234">Para garantir que a perda de um setor não afete vários registros, esse registro de confirmação normalmente é preenchido para um tamanho de setor.</span><span class="sxs-lookup"><span data-stu-id="523d5-234">In order to ensure that the loss of a sector does not affect multiple records, this commit record is typically padded out to a sector size.</span></span> <span data-ttu-id="523d5-235">Com um disco com um tamanho de setor físico maior, o aplicativo precisará consultar o tamanho do setor físico, conforme mostrado na seção anterior, e garantir que cada registro de confirmação seja preenchido para esse tamanho.</span><span class="sxs-lookup"><span data-stu-id="523d5-235">With a disk with a larger physical sector size, the app will need to query for the physical sector size as shown in the prior section, and ensure each commit record is padded to that size.</span></span> <span data-ttu-id="523d5-236">Com um disco de 4K, isso garante que a e/s não falhe.</span><span class="sxs-lookup"><span data-stu-id="523d5-236">With a 4K disk, this ensures I/Os do not fail.</span></span> <span data-ttu-id="523d5-237">Com um disco 512e, isso não apenas evita o ciclo de leitura-modificação-gravação, ajuda a garantir que, se um setor físico fosse perdido, apenas um registro de confirmação seria perdido.</span><span class="sxs-lookup"><span data-stu-id="523d5-237">With a 512e disk, not only does this avoid the Read-Modify-Write cycle, it helps ensure that if a physical sector was lost, only one Commit Record would be lost.</span></span>  
<span data-ttu-id="523d5-238">**Os arquivos de log são gravados em partes não alinhadas:** A e/s não armazenada em buffer normalmente é usada ao atualizar ou anexar a um arquivo de log.</span><span class="sxs-lookup"><span data-stu-id="523d5-238">**Log files are written to in unaligned chunks:** Unbuffered I/O is typically used when updating or appending to a log file.</span></span> <span data-ttu-id="523d5-239">Os aplicativos podem alternar para e/s armazenada em buffer, ou armazenar internamente em buffer as atualizações de log em unidades do tamanho do setor físico para evitar e/SS com falha ou disparar uma leitura-modificação-gravação.</span><span class="sxs-lookup"><span data-stu-id="523d5-239">Apps can either switch to buffered I/O, or internally buffer the log updates to units of the physical sector size to avoid failed I/Os or triggering a Read-Modify-Write.</span></span>  
 <span data-ttu-id="523d5-240">Para ajudar a determinar se seu aplicativo emite e/s sem buffer, certifique-se de incluir o \_ sinalizador File Flag no \_ \_ buffer no parâmetro *dwFlagsAndAttributes* quando você chama a função CreateFile.</span><span class="sxs-lookup"><span data-stu-id="523d5-240">To help determine if your app issues unbuffered I/O, make sure to include the FILE\_FLAG\_NO\_BUFFERING flag in the *dwFlagsAndAttributes* parameter when you are call the CreateFile function.</span></span>

<span data-ttu-id="523d5-241">Além disso, se você estiver alinhando as gravações no tamanho do setor, esse tamanho de setor provavelmente será apenas o tamanho do setor lógico, já que a maioria das APIs existentes que consultam o tamanho do setor da mídia apenas consultam a unidade de endereçamento, o tamanho do setor lógico.</span><span class="sxs-lookup"><span data-stu-id="523d5-241">Moreover, if you are currently aligning the writes to the sector size, this sector size is most likely just the logical sector size, as most existing APIs that query for the sector size of the media just query the unit of addressing   that is, the logical sector size.</span></span> <span data-ttu-id="523d5-242">O tamanho do setor de interesse aqui é o tamanho do setor físico, que é a unidade real de atomicidade.</span><span class="sxs-lookup"><span data-stu-id="523d5-242">The sector size of interest here is the physical sector size, which is the real unit of atomicity.</span></span> <span data-ttu-id="523d5-243">Alguns exemplos de APIs que recuperam o tamanho do setor lógico são:</span><span class="sxs-lookup"><span data-stu-id="523d5-243">Some examples of APIs that retrieve the logical sector size are:</span></span>

-   <span data-ttu-id="523d5-244">GetDiskFreeSpace, GetDiskFreeSpaceEx</span><span class="sxs-lookup"><span data-stu-id="523d5-244">GetDiskFreeSpace, GetDiskFreeSpaceEx</span></span>
-   <span data-ttu-id="523d5-245">FileFsVolumeInformation</span><span class="sxs-lookup"><span data-stu-id="523d5-245">FileFsVolumeInformation</span></span>
-   <span data-ttu-id="523d5-246">disco do IOCTL \_ \_ obter \_ geometria da unidade \_ , disco do IOCTL \_ \_ obter \_ geometria da unidade \_ \_ ex.</span><span class="sxs-lookup"><span data-stu-id="523d5-246">IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY, IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY\_EX</span></span>
-   <span data-ttu-id="523d5-247">IVdsDisk:: GetProperties, IVdsDisk3:: GetProperties2</span><span class="sxs-lookup"><span data-stu-id="523d5-247">IVdsDisk::GetProperties, IVdsDisk3::GetProperties2</span></span>

<span data-ttu-id="523d5-248">Veja aqui como você pode consultar o tamanho do setor físico:</span><span class="sxs-lookup"><span data-stu-id="523d5-248">Here s how you can query for the physical sector size:</span></span>

<span data-ttu-id="523d5-249">**Método preferencial para o Windows 8**</span><span class="sxs-lookup"><span data-stu-id="523d5-249">**Preferred method for Windows 8**</span></span>

<span data-ttu-id="523d5-250">Com o Windows 8, a Microsoft introduziu uma nova API que permite aos desenvolvedores integrar facilmente o suporte a 4K em seus aplicativos.</span><span class="sxs-lookup"><span data-stu-id="523d5-250">With Windows 8, Microsoft has introduced a new API that enables developers to easily integrate 4K support within their apps.</span></span> <span data-ttu-id="523d5-251">Essa nova API dá suporte a um número ainda maior de cenários do que o método herdado para o Windows Vista e o Windows 7 discutidos abaixo.</span><span class="sxs-lookup"><span data-stu-id="523d5-251">This new API supports even greater numbers of scenarios than the legacy method for Windows Vista and Windows 7 discussed below.</span></span> <span data-ttu-id="523d5-252">Essa API habilita estes cenários de chamada:</span><span class="sxs-lookup"><span data-stu-id="523d5-252">This API enables these calling scenarios:</span></span>

-   <span data-ttu-id="523d5-253">Chamando de um aplicativo sem privilégios</span><span class="sxs-lookup"><span data-stu-id="523d5-253">Calling from an unprivileged app</span></span>
-   <span data-ttu-id="523d5-254">Chamando para qualquer identificador de arquivo válido</span><span class="sxs-lookup"><span data-stu-id="523d5-254">Calling to any valid file handle</span></span>
-   <span data-ttu-id="523d5-255">Chamando para um identificador de arquivo em um volume remoto em SMB2</span><span class="sxs-lookup"><span data-stu-id="523d5-255">Calling to a file handle on a remote volume over SMB2</span></span>
-   <span data-ttu-id="523d5-256">Modelo de programação simplificado</span><span class="sxs-lookup"><span data-stu-id="523d5-256">Simplified programming model</span></span>

<span data-ttu-id="523d5-257">A API está na forma de uma nova classe info, FileFsSectorSizeInformation, com informações de tamanho de setor do arquivo de estrutura associado \_ \_ \_ \_ , definidas da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="523d5-257">The API is in the form of a new info class, FileFsSectorSizeInformation, with associated structure FILE\_FS\_SECTOR\_SIZE\_INFORMATION, defined as follows:</span></span>


```
typedef struct _FILE_FS_SECTOR_SIZE_INFORMATION {  
    ULONG LogicalBytesPerSector;  
    ULONG PhysicalBytesPerSectorForAtomicity;  
    ULONG PhysicalBytesPerSectorForPerformance;  
    ULONG FileSystemEffectivePhysicalBytesPerSectorForAtomicity;  
    ULONG Flags;  
    ULONG ByteOffsetForSectorAlignment;  
    ULONG ByteOffsetForPartitionAlignment;  
} FILE_FS_SECTOR_SIZE_INFORMATION, *PFILE_FS_SECTOR_SIZE_INFORMATION;
```



<span data-ttu-id="523d5-258">**Método herdado para Windows 7 e Windows Vista**</span><span class="sxs-lookup"><span data-stu-id="523d5-258">**Legacy method for Windows 7 and Windows Vista**</span></span>

<span data-ttu-id="523d5-259">O Windows Vista e o Windows Server 2008 introduziram APIs para consultar o tamanho do setor físico do dispositivo de armazenamento anexado para controladores de armazenamento baseados em AHCI.</span><span class="sxs-lookup"><span data-stu-id="523d5-259">Windows Vista and Windows Server 2008 introduced APIs to query for the physical sector size of the attached storage device for AHCI-based storage controllers.</span></span> <span data-ttu-id="523d5-260">Com o Windows 7 e o Windows Server 2008 R2, a partir do SP1 (ou da base de dados de conhecimento Microsoft 982018), esse suporte é estendido para controladores de armazenamento baseados em Storport.</span><span class="sxs-lookup"><span data-stu-id="523d5-260">With Windows 7 and Windows Server 2008 R2, as of SP1 (or Microsoft Knowledge Base 982018), this support is extended to Storport-based storage controllers.</span></span> <span data-ttu-id="523d5-261">A Microsoft forneceu um [exemplo de código](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) no MSDN detalhando como um aplicativo pode consultar o tamanho do setor físico do volume.</span><span class="sxs-lookup"><span data-stu-id="523d5-261">Microsoft has provided a [code sample](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) on MSDN detailing how an app can query for the physical sector size of the volume.</span></span>

<span data-ttu-id="523d5-262">Embora o exemplo de código acima permita que você obtenha o tamanho do setor físico do volume, você deve fazer alguma verificação básica de sanidade do tamanho do setor físico relatado antes de usá-lo, já que alguns drivers podem não retornar dados formatados corretamente:</span><span class="sxs-lookup"><span data-stu-id="523d5-262">While the code sample above allows you to get the physical sector size of the volume, you should do some basic sanity checking of the reported physical sector size before using it, as it has been observed that some drivers may not return correctly formatted data:</span></span>

-   <span data-ttu-id="523d5-263">Verifique se o tamanho do setor físico relatado é >= o tamanho do setor lógico relatado; Se não for, seu aplicativo deverá usar um tamanho de setor físico igual ao tamanho do setor lógico relatado</span><span class="sxs-lookup"><span data-stu-id="523d5-263">Make sure that the reported physical sector size is >= the reported logical sector size; if it is not, your app should use a physical sector size equal to the reported logical sector size</span></span>
-   <span data-ttu-id="523d5-264">Verifique se o tamanho do setor físico relatado é uma potência de dois; Se não for, seu aplicativo deverá usar um tamanho de setor físico igual ao tamanho do setor lógico relatado</span><span class="sxs-lookup"><span data-stu-id="523d5-264">Make sure that the reported physical sector size is a power of two; if it is not, your app should use a physical sector size equal to the reported logical sector size</span></span>
-   <span data-ttu-id="523d5-265">Se o tamanho do setor físico for um valor de potência de dois entre 512 bytes e 4 KB, você deverá considerar o uso de um tamanho de setor físico arredondado para baixo até o tamanho de setor lógico relatado</span><span class="sxs-lookup"><span data-stu-id="523d5-265">If the physical sector size is a power-of-two value between 512-bytes and 4 KB, you should consider using a physical sector size rounded down to the reported logical sector size</span></span>
-   <span data-ttu-id="523d5-266">Se o tamanho do setor físico for um valor de mais de 4 KB, você deverá avaliar a capacidade do seu aplicativo de lidar com esse cenário antes de usar esse valor; caso contrário, você deve considerar o uso de um tamanho de setor físico arredondado para 4 KB</span><span class="sxs-lookup"><span data-stu-id="523d5-266">If the physical sector size is a power-of-two value greater than 4 KB, you should evaluate your app s ability to handle this scenario before using that value; otherwise, you should consider using a physical sector size rounded down to 4 KB</span></span>

<span data-ttu-id="523d5-267">O uso deste IOCTL para obter o tamanho do setor físico tem várias limitações.</span><span class="sxs-lookup"><span data-stu-id="523d5-267">Using this IOCTL to get the physical sector size does have several limitations.</span></span> <span data-ttu-id="523d5-268">Fosse</span><span class="sxs-lookup"><span data-stu-id="523d5-268">It:</span></span>

-   <span data-ttu-id="523d5-269">Requer privilégio elevado; Se seu aplicativo não estiver em execução com privilégios, talvez seja necessário escrever um aplicativo de serviço do Windows, conforme mencionado acima</span><span class="sxs-lookup"><span data-stu-id="523d5-269">Requires elevated privilege; if your app is not running with privilege, you may need to write a Windows Service Application as noted above</span></span>
-   <span data-ttu-id="523d5-270">Não oferece suporte a volumes SMB; Talvez você também precise escrever um aplicativo de serviço do Windows para dar suporte à consulta de tamanho de setor físico nesses volumes</span><span class="sxs-lookup"><span data-stu-id="523d5-270">Does not support SMB volumes; you may also need to write a Windows Service Application to support physical sector size querying on these volumes</span></span>
-   <span data-ttu-id="523d5-271">Não pode ser emitido para nenhum identificador de arquivo (o IOCTL deve ser emitido para um identificador de volume)</span><span class="sxs-lookup"><span data-stu-id="523d5-271">Cannot be issued to any file handle (the IOCTL must be issued to a Volume Handle)</span></span>

<span data-ttu-id="523d5-272">**Problema 3: os formatos de arquivo dependem de setores de 512 bytes**</span><span class="sxs-lookup"><span data-stu-id="523d5-272">**Issue 3: file formats relying on 512-byte sectors**</span></span>

<span data-ttu-id="523d5-273">Alguns aplicativos com formatos de arquivo padrão (como VHD 1,0) podem ter esses arquivos embutidos em código para assumir um tamanho de setor de 512 bytes.</span><span class="sxs-lookup"><span data-stu-id="523d5-273">Some apps with standard file formats (such as VHD 1.0) may have these files hard-coded to assume a 512-byte sector size.</span></span> <span data-ttu-id="523d5-274">Assim, as atualizações e gravações nesse arquivo resultarão em um ciclo de leitura-modificação/gravação no dispositivo, o que resultará em problemas de desempenho e resiliência para seus clientes.</span><span class="sxs-lookup"><span data-stu-id="523d5-274">Thus, updates and writes to this file would result in a Read-Modify-Write cycle on the device  which will potentially result in performance and resiliency issues for your customers.</span></span> <span data-ttu-id="523d5-275">No entanto, há maneiras de um aplicativo fornecer suporte para operar nesse tipo de mídia, por exemplo:</span><span class="sxs-lookup"><span data-stu-id="523d5-275">However, there are ways for an app to provide support for operating on this type of media, for example:</span></span>

-   <span data-ttu-id="523d5-276">Usar o buffer para garantir que as gravações sejam executadas em unidades do tamanho do setor físico</span><span class="sxs-lookup"><span data-stu-id="523d5-276">Use buffering to ensure that writes are performed in units of the physical sector size</span></span>
-   <span data-ttu-id="523d5-277">Implemente uma leitura-modificação-gravação interna que possa ajudar a garantir que as atualizações sejam executadas em unidades do tamanho do setor físico relatado</span><span class="sxs-lookup"><span data-stu-id="523d5-277">Implement an internal Read-Modify-Write that can help ensure that updates are performed in units of the reported physical sector size</span></span>
-   <span data-ttu-id="523d5-278">Se possível, preencha os registros para um setor físico, de forma que o preenchimento seja interpretado como espaço vazio</span><span class="sxs-lookup"><span data-stu-id="523d5-278">If possible, pad records out to a physical sector, in such a way that the padding would be interpreted as empty space</span></span>
-   <span data-ttu-id="523d5-279">Considere reprojetar uma versão da estrutura de dados de aplicativo com suporte para setores maiores</span><span class="sxs-lookup"><span data-stu-id="523d5-279">Consider redesigning a version of the app data structure with support for larger sectors</span></span>

<span data-ttu-id="523d5-280">**Problema 4: o tamanho do setor físico relatado pode mudar entre sessões**</span><span class="sxs-lookup"><span data-stu-id="523d5-280">**Issue 4: the reported physical sector size can change between sessions**</span></span>

<span data-ttu-id="523d5-281">Há muitos cenários em que o tamanho do setor físico relatado do armazenamento subjacente que hospeda o Datastor pode ser alterado.</span><span class="sxs-lookup"><span data-stu-id="523d5-281">There are many scenarios where the reported physical sector size of the underlying storage that hosts the Datastor may change.</span></span> <span data-ttu-id="523d5-282">O mais comum deles é quando você migra o Datastor para outro volume, ou até mesmo pela rede.</span><span class="sxs-lookup"><span data-stu-id="523d5-282">The most common of these is when you migrate the Datastor to another volume, or even across the network.</span></span> <span data-ttu-id="523d5-283">Uma alteração no tamanho do setor físico relatado pode ser um evento inesperado para muitos aplicativos e potencialmente pode resultar em falha na reinicialização de alguns aplicativos.</span><span class="sxs-lookup"><span data-stu-id="523d5-283">A change in the reported physical sector size may be an unexpected event for many apps and potentially can result in some apps failing to re-initialize.</span></span>

<span data-ttu-id="523d5-284">Esse não é o cenário mais fácil para oferecer suporte e é mencionado aqui como um comunicado.</span><span class="sxs-lookup"><span data-stu-id="523d5-284">This is not the easiest scenario to support, and is mentioned here as an advisory.</span></span> <span data-ttu-id="523d5-285">Você deve considerar os requisitos de mobilidade de seus clientes e ajustar seu suporte de forma adequada para ajudar a garantir que os clientes não sejam afetados negativamente usando a mídia de 4K nativa ou 512e.</span><span class="sxs-lookup"><span data-stu-id="523d5-285">You should consider the mobility requirements of your customers and adjust your support accordingly to help ensure customers are not negatively impacted by using 4K native or 512e media.</span></span>

<span data-ttu-id="523d5-286">**Como um usuário pode recuperar o tamanho de setor lógico e físico para um volume**</span><span class="sxs-lookup"><span data-stu-id="523d5-286">**How a user can retrieve the logical and physical sector size for a volume**</span></span>

<span data-ttu-id="523d5-287">O in-box com o Windows é um utilitário para exibir as informações de tamanho do setor de um volume.</span><span class="sxs-lookup"><span data-stu-id="523d5-287">In-box with Windows is a utility to display the sector size info for a volume.</span></span> <span data-ttu-id="523d5-288">As versões do Windows com o fsutil com suporte são:</span><span class="sxs-lookup"><span data-stu-id="523d5-288">Versions of Windows with supported  fsutil  are:</span></span>

-   <span data-ttu-id="523d5-289">Windows 8</span><span class="sxs-lookup"><span data-stu-id="523d5-289">Windows 8</span></span>
-   <span data-ttu-id="523d5-290">Windows Server 2012</span><span class="sxs-lookup"><span data-stu-id="523d5-290">Windows Server 2012</span></span>
-   <span data-ttu-id="523d5-291">Windows 7 SP1 com Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="523d5-291">Windows 7 SP1 with Microsoft KB 982018</span></span>
-   <span data-ttu-id="523d5-292">Windows 7 com Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="523d5-292">Windows 7 with Microsoft KB 982018</span></span>
-   <span data-ttu-id="523d5-293">Windows Server 2008 R2 SP1 com Microsoft KB 982018 (v3)</span><span class="sxs-lookup"><span data-stu-id="523d5-293">Windows Server 2008 R2 SP1 with Microsoft KB 982018 (v3)</span></span>
-   <span data-ttu-id="523d5-294">Windows Server 2008 R2 com Microsoft KB 982018 (v3)</span><span class="sxs-lookup"><span data-stu-id="523d5-294">Windows Server 2008 R2 with Microsoft KB 982018 (v3)</span></span>
-   <span data-ttu-id="523d5-295">Windows Vista com Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="523d5-295">Windows Vista with Microsoft KB 2553708</span></span>
-   <span data-ttu-id="523d5-296">Windows Server 2008 com Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="523d5-296">Windows Server 2008 with Microsoft KB 2553708</span></span>

<span data-ttu-id="523d5-297">Para obter as informações de tamanho do setor, chame o utilitário da seguinte maneira em um prompt de comando elevado:</span><span class="sxs-lookup"><span data-stu-id="523d5-297">To get the sector size info, call the utility as follows from an elevated command prompt:</span></span>


```
fsutil fsinfo ntfsinfo <drive letter>
```



<span data-ttu-id="523d5-298">Um disco de setor de 4K com emulação de 512 bytes tem o campo bytes por setor definido como 512 e o campo bytes por setor físico definido como 4096 da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="523d5-298">A 4K Sector Disk with 512-byte Emulation has the  Bytes Per Sector  field set to 512 and the  Bytes Per Physical Sector  field set to 4096 as follows:</span></span>

![bytes por setor e por setor físico de um disco de setor de 4K com emulação de 512 bytes](images/4ksectordiskwith512emulation.png)

<span data-ttu-id="523d5-300">Um disco nativo de 4K tem os bytes por setor e bytes por campos de setor físico definidos como 4096 da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="523d5-300">A 4K Native Disk has the  Bytes Per Sector  and  Bytes Per Physical Sector  fields both set to 4096 as follows:</span></span>

![bytes por setor e por setor físico de um disco nativo de 4K](images/4knativedisk.png)

> [!Note]  
> <span data-ttu-id="523d5-302">Se o campo byte por setor físico exibir não for suportado, o driver de armazenamento não oferece suporte \_ à \_ propriedade de consulta de armazenamento de IOCTL \_ ou houve um erro ao recuperar as informações.</span><span class="sxs-lookup"><span data-stu-id="523d5-302">If the  Byte Per Physical Sector  field displays  Not Supported  then either the storage driver does not support IOCTL\_STORAGE\_QUERY\_PROPERTY, or there was an error in retrieving the info.</span></span>

 

## <a name="resources"></a><span data-ttu-id="523d5-303">Recursos</span><span class="sxs-lookup"><span data-stu-id="523d5-303">Resources</span></span>

-   [<span data-ttu-id="523d5-304">Instrução de suporte geral do Windows</span><span class="sxs-lookup"><span data-stu-id="523d5-304">Windows General Support Statement</span></span>](https://support.microsoft.com/kb/2510009)
-   [<span data-ttu-id="523d5-305">Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="523d5-305">Microsoft KB 982018</span></span>](https://support.microsoft.com/kb/982018)
-   [<span data-ttu-id="523d5-306">Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="523d5-306">Microsoft KB 2553708</span></span>](https://support.microsoft.com/kb/2553708)
-   [<span data-ttu-id="523d5-307">Hotfix para Windows 7 e Windows Server 2008 R2</span><span class="sxs-lookup"><span data-stu-id="523d5-307">Hotfix for Windows 7 and Windows Server 2008 R2</span></span>](https://support.microsoft.com/kb/982018)
-   [<span data-ttu-id="523d5-308">Hotfix para Windows Vista e Windows Server 2008</span><span class="sxs-lookup"><span data-stu-id="523d5-308">Hotfix for Windows Vista and Windows Server 2008</span></span>](https://support.microsoft.com/kb/2553708)
-   [<span data-ttu-id="523d5-309">Instrução de suporte do HyperV</span><span class="sxs-lookup"><span data-stu-id="523d5-309">HyperV Support Statement</span></span>](https://support.microsoft.com/kb/2515143)
-   [<span data-ttu-id="523d5-310">Informações gerais sobre o \_ código de \_ controle da propriedade de consulta de armazenamento do IOCTL \_</span><span class="sxs-lookup"><span data-stu-id="523d5-310">General information about the IOCTL\_STORAGE\_QUERY\_PROPERTY control code</span></span>](/windows-hardware/drivers/ddi/ntddstor/ni-ntddstor-ioctl_storage_query_property)
-   [<span data-ttu-id="523d5-311">\_Código de \_ controle de propriedade de consulta de armazenamento de IOCTL \_</span><span class="sxs-lookup"><span data-stu-id="523d5-311">IOCTL\_STORAGE\_QUERY\_PROPERTY Control Code</span></span>](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_query_property)
-   [<span data-ttu-id="523d5-312">Informações gerais sobre a \_ estrutura do \_ descritor de alinhamento de acesso de armazenamento \_</span><span class="sxs-lookup"><span data-stu-id="523d5-312">General information about the STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR structure</span></span>](/windows-hardware/drivers/ddi/ntddstor/ns-ntddstor-_storage_access_alignment_descriptor)
-   [<span data-ttu-id="523d5-313">Descrição da terminologia padrão usada para descrever as atualizações de software da Microsoft</span><span class="sxs-lookup"><span data-stu-id="523d5-313">Description of the standard terminology used to describe Microsoft software updates</span></span>](https://support.microsoft.com/kb/824684/)
-   [<span data-ttu-id="523d5-314">Código de exemplo do WDK com detalhes sobre como extrair as informações de alinhamento de acesso de armazenamento relatado da \_ estrutura do descritor de alinhamento de acesso de armazenamento \_ \_ ao fazer uma chamada para o código de controle da propriedade de consulta de armazenamento do IOCTL \_ \_ \_</span><span class="sxs-lookup"><span data-stu-id="523d5-314">WDK sample code with details for how to extract the reported storage access alignment info from the STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR structure when making a call to the IOCTL\_STORAGE\_QUERY\_PROPERTY control code</span></span>](/windows/win32/api/winioctl/ns-winioctl-storage_access_alignment_descriptor)
-   <span data-ttu-id="523d5-315">[Informações gerais sobre as opções do ImageX Command-Line](/previous-versions/windows/it-pro/windows-7/dd799302(v=ws.10))</span><span class="sxs-lookup"><span data-stu-id="523d5-315">[General information about ImageX Command-Line Options](/previous-versions/windows/it-pro/windows-7/dd799302(v=ws.10))</span></span>
-   [<span data-ttu-id="523d5-316">Requisitos de driver de chipset Intel para dar suporte a unidades de setor de 4 KB</span><span class="sxs-lookup"><span data-stu-id="523d5-316">Intel Chipset driver requirements to support 4 KB Sector Drives</span></span>](https://www.intel.com/support/chipsets/imsm/sb/CS-031502.htm)

 

