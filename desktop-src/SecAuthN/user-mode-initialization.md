---
description: Os aplicativos distribuídos (cliente/servidor) usam pacotes de segurança para obter conexões autenticadas e mensagens do Exchange.
ms.assetid: 8f28177f-335a-4fa2-bf66-2ec1698bebec
title: Inicialização do modo de usuário
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 473b06daf2e1c3612b02583d203ce4cd9afebabd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103922313"
---
# <a name="user-mode-initialization"></a><span data-ttu-id="65eb8-103">Inicialização do modo de usuário</span><span class="sxs-lookup"><span data-stu-id="65eb8-103">User Mode Initialization</span></span>

<span data-ttu-id="65eb8-104">Os aplicativos distribuídos (cliente/servidor) usam [*pacotes de segurança*](../secgloss/s-gly.md) para obter conexões autenticadas e mensagens do Exchange.</span><span class="sxs-lookup"><span data-stu-id="65eb8-104">Distributed (client/server) applications use [*security packages*](../secgloss/s-gly.md) to obtain authenticated connections and to exchange messages.</span></span> <span data-ttu-id="65eb8-105">O aplicativo chama funções de SSPI (interface do provedor de suporte de segurança) que são mapeadas para [funções implementadas pelo SSP/APS](authentication-functions.md)e [funções implementadas pelo SSP/APS do modo de usuário](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="65eb8-105">The application calls security support provider interface (SSPI) functions which are mapped to [functions implemented by SSP/APs](authentication-functions.md), and [functions implemented by User-mode SSP/APs](authentication-functions.md).</span></span> <span data-ttu-id="65eb8-106">Esse mapeamento é executado pela DLL do provedor de segurança (Secur32.dll ou Security.dll), que pode ser carregada nos processos do cliente e do servidor dinamicamente.</span><span class="sxs-lookup"><span data-stu-id="65eb8-106">This mapping is performed by the security provider DLL (Secur32.dll or Security.dll), which can be loaded into the client and server processes dynamically.</span></span> <span data-ttu-id="65eb8-107">A DLL também pode ser vinculada estaticamente usando Secur32. lib.</span><span class="sxs-lookup"><span data-stu-id="65eb8-107">The DLL can also be statically linked using Secur32.lib.</span></span> <span data-ttu-id="65eb8-108">A DLL e a LIB são fornecidas com o SDK (Software Development Kit) do Microsoft Windows.</span><span class="sxs-lookup"><span data-stu-id="65eb8-108">Both the DLL and LIB ship with the Microsoft Windows Software Development Kit (SDK).</span></span>

<span data-ttu-id="65eb8-109">Carregar o pacote de segurança no processo do cliente ou do servidor é tratado pelo sistema, se a DLL do SSP/AP que contém o pacote de segurança estiver corretamente registrada.</span><span class="sxs-lookup"><span data-stu-id="65eb8-109">Loading the security package into the client or server's process is handled by the system, if the SSP/AP DLL that contains the security package is properly registered.</span></span>

<span data-ttu-id="65eb8-110">O servidor inicia o processo de obtenção de uma conexão segura com um cliente monitorando uma porta, aguardando um cliente enviar uma mensagem.</span><span class="sxs-lookup"><span data-stu-id="65eb8-110">The server begins the process of obtaining a secure connection with a client by monitoring a port, waiting for a client to send a message.</span></span> <span data-ttu-id="65eb8-111">O cliente inicia o processo de obtenção de uma conexão segura com o servidor chamando a função SSPI [**InitializeSecurityContext (geral)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span><span class="sxs-lookup"><span data-stu-id="65eb8-111">The client begins the process of obtaining a secure connection to the server by calling the SSPI function [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span></span> <span data-ttu-id="65eb8-112">Essa função é mapeada para a função [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) do pacote de segurança personalizado.</span><span class="sxs-lookup"><span data-stu-id="65eb8-112">This function is mapped to the custom security package's [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function.</span></span> <span data-ttu-id="65eb8-113">**SpInitLsaModeContext** retorna um token para o cliente, que o encaminha para o servidor.</span><span class="sxs-lookup"><span data-stu-id="65eb8-113">**SpInitLsaModeContext** returns a token to the client, who forwards it to the server.</span></span>

<span data-ttu-id="65eb8-114">Após receber o token do cliente, o servidor chama a função SSPI [**AcceptSecurityContext (geral)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), que é expedida para a função [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) do pacote de segurança.</span><span class="sxs-lookup"><span data-stu-id="65eb8-114">Upon receiving the token from the client, the server calls the SSPI function [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), which is dispatched to the security package's [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) function.</span></span> <span data-ttu-id="65eb8-115">Se a função **SpAcceptLsaModeContext** for bem-sucedida e nenhum processamento for necessário para estabelecer o contexto de segurança, a função deverá retornar o status \_ Success ao chamador.</span><span class="sxs-lookup"><span data-stu-id="65eb8-115">If the **SpAcceptLsaModeContext** function succeeds and no more processing is required to establish the security context, the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="65eb8-116">Se o processamento adicional for necessário, a função deverá retornar s \_ I \_ continue \_ necessário e retorna um token para o servidor.</span><span class="sxs-lookup"><span data-stu-id="65eb8-116">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the server.</span></span> <span data-ttu-id="65eb8-117">O servidor encaminha o token para o cliente, que chama [**InitializeSecurityContext (geral)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) novamente.</span><span class="sxs-lookup"><span data-stu-id="65eb8-117">The server forwards the token to the client, who calls [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) again.</span></span>

<span data-ttu-id="65eb8-118">Esse ciclo de chamada pode ser repetido sempre que necessário até que uma conexão autenticada seja estabelecida ou falhe.</span><span class="sxs-lookup"><span data-stu-id="65eb8-118">This calling cycle may be repeated as often as necessary until an authenticated connection is established or fails.</span></span> <span data-ttu-id="65eb8-119">Durante esse processo, se a função [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) ou [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) for bem-sucedida e nenhum processamento for necessário para estabelecer o [*contexto de segurança*](../secgloss/s-gly.md), a função deverá retornar o status \_ Success ao chamador.</span><span class="sxs-lookup"><span data-stu-id="65eb8-119">During this process, if the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) or [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function succeeds and no more processing is required to establish the [*security context*](../secgloss/s-gly.md), the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="65eb8-120">Se o processamento adicional for necessário, a função deverá retornar \_ s \_ \_ e continuar necessário e retornar um token para o chamador, que é responsável por encaminhá-lo.</span><span class="sxs-lookup"><span data-stu-id="65eb8-120">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the caller, who is responsible for forwarding it.</span></span>

<span data-ttu-id="65eb8-121">O protocolo implementado pelo pacote de segurança determina o número de vezes que esse ciclo é repetido.</span><span class="sxs-lookup"><span data-stu-id="65eb8-121">The protocol implemented by the security package determines the number of times this cycle is repeated.</span></span> <span data-ttu-id="65eb8-122">Por exemplo, em pacotes de segurança que dão suporte à autenticação mútua de três trechos, a sequência de chamada é a seguinte:</span><span class="sxs-lookup"><span data-stu-id="65eb8-122">For example, in security packages that supports three-leg mutual authentication, the calling sequence is as follows:</span></span>

1.  <span data-ttu-id="65eb8-123">O cliente obtém um token chamando [**InitializeSecurityContext (geral)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)e o envia para o servidor.</span><span class="sxs-lookup"><span data-stu-id="65eb8-123">Client obtains a token by calling [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and sends it to the server.</span></span> <span data-ttu-id="65eb8-124">O servidor chama [**AcceptSecurityContext (geral)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) pela primeira vez e Obtém um token de resposta que ele envia para o cliente.</span><span class="sxs-lookup"><span data-stu-id="65eb8-124">The server calls [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) the first time, and gets back a reply token which it sends to the client.</span></span>
2.  <span data-ttu-id="65eb8-125">O cliente usa o token recebido do servidor em uma segunda chamada para [**InitializeSecurityContext (geral)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)e retorna um token final.</span><span class="sxs-lookup"><span data-stu-id="65eb8-125">The client uses the token received from the server in a second call to [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and gets back a final token.</span></span> <span data-ttu-id="65eb8-126">O cliente envia esse token para o servidor.</span><span class="sxs-lookup"><span data-stu-id="65eb8-126">The client sends this token to the server.</span></span>
3.  <span data-ttu-id="65eb8-127">O servidor recebe o token gerado no segmento 2 que ele usa na chamada final para [**AcceptSecurityContext (geral)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span><span class="sxs-lookup"><span data-stu-id="65eb8-127">The server receives the token generated in leg 2 which it uses in the final call to [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span></span>

<span data-ttu-id="65eb8-128">Quando as funções [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) e [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) são bem-sucedidas e nenhum processamento é necessário para estabelecer o contexto de segurança, as funções devem retornar o status \_ êxito ao chamador.</span><span class="sxs-lookup"><span data-stu-id="65eb8-128">When the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) and [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) functions succeed and no more processing is required to establish the security context, the functions should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="65eb8-129">Além disso, se o pacote de segurança personalizado oferecer suporte às [funções implementadas pelo SSP/APS do modo de usuário](authentication-functions.md), **SpAcceptLsaModeContext** e **SpInitLsaModeContext** deverão retornar **true** por meio do parâmetro *MappedContext* .</span><span class="sxs-lookup"><span data-stu-id="65eb8-129">Additionally, if the custom security package supports the [functions implemented by user-mode SSP/APs](authentication-functions.md), **SpAcceptLsaModeContext** and **SpInitLsaModeContext** must return **TRUE** by way of the *MappedContext* parameter.</span></span> <span data-ttu-id="65eb8-130">O valor de *MappedContext* não é passado de volta para o aplicativo; Ele é interceptado pela LSA.</span><span class="sxs-lookup"><span data-stu-id="65eb8-130">The *MappedContext* value is not passed back to the application; it is intercepted by the LSA.</span></span>

<span data-ttu-id="65eb8-131">Quando *MappedContext* é **true**, a LSA chama a função [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) da dll do SSP/AP.</span><span class="sxs-lookup"><span data-stu-id="65eb8-131">When *MappedContext* is **true**, the LSA calls the SSP/AP DLL's [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) function.</span></span> <span data-ttu-id="65eb8-132">Essa função fornece tabelas de ponteiros para as funções de modo de usuário implementadas por cada pacote de segurança.</span><span class="sxs-lookup"><span data-stu-id="65eb8-132">This function provides tables of pointers to the user-mode functions implemented by each security package.</span></span> <span data-ttu-id="65eb8-133">A função [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) de cada pacote é chamada, usando as tabelas de função retornadas por **SpUsermodeInitialize**.</span><span class="sxs-lookup"><span data-stu-id="65eb8-133">Each package's [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) function is called, using the function tables returned by **SpUsermodeInitialize**.</span></span> <span data-ttu-id="65eb8-134">**SpInstanceInit** recebe uma tabela de ponteiros para [funções LSA chamadas por SSP/APS do modo de usuário](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="65eb8-134">**SpInstanceInit** receives a table of pointers to [LSA functions called by user-mode SSP/APs](authentication-functions.md).</span></span>

 

 
