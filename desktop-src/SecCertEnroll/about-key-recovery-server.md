---
description: Uma autoridade de certificação (CA) da Microsoft pode ser configurada para arquivar e recuperar a chave privada associada à chave pública enviada na solicitação de certificado.
ms.assetid: c6535dbf-c3fe-4f70-9a70-02805253a651
title: Servidor de recuperação de chave
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b4e9fd60b7ee6596b98953d382978be64695c035
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103828344"
---
# <a name="key-recovery-server"></a><span data-ttu-id="a1166-103">Servidor de recuperação de chave</span><span class="sxs-lookup"><span data-stu-id="a1166-103">Key Recovery Server</span></span>

<span data-ttu-id="a1166-104">Uma autoridade de certificação (CA) da Microsoft pode ser configurada para arquivar e recuperar a chave privada associada à chave pública enviada na solicitação de certificado.</span><span class="sxs-lookup"><span data-stu-id="a1166-104">A Microsoft certification authority (CA) can be configured to archive and recover the private key associated with the public key submitted in the certificate request.</span></span> <span data-ttu-id="a1166-105">A recuperação será útil se uma chave for perdida.</span><span class="sxs-lookup"><span data-stu-id="a1166-105">Recovery is useful if a key is lost.</span></span> <span data-ttu-id="a1166-106">Por padrão, somente as chaves de criptografia podem ser arquivadas.</span><span class="sxs-lookup"><span data-stu-id="a1166-106">By default, only encryption keys can be archived.</span></span> <span data-ttu-id="a1166-107">Não é necessário arquivar chaves destinadas apenas à assinatura, pois apenas a chave pública é necessária para verificar uma assinatura se a chave de assinatura privada for perdida.</span><span class="sxs-lookup"><span data-stu-id="a1166-107">It is not necessary to archive keys intended only for signing because only the public key is needed to verify a signature if the private signing key is lost.</span></span>

<span data-ttu-id="a1166-108">Para arquivar uma chave, a autoridade de certificação deve ser configurada para emitir certificados KRA (agente de recuperação de chave) e para já ter emitido pelo menos um.</span><span class="sxs-lookup"><span data-stu-id="a1166-108">To archive a key, the CA must be configured to issue key recovery agent (KRA) certificates and to have already issued at least one.</span></span> <span data-ttu-id="a1166-109">Um agente de recuperação de chave é um administrador autorizado por uma organização para descriptografar chaves privadas.</span><span class="sxs-lookup"><span data-stu-id="a1166-109">A key recovery agent is an administrator authorized by an organization to decrypt private keys.</span></span> <span data-ttu-id="a1166-110">Para aumentar a segurança, recomendamos que o agente de recuperação de chave e as funções do Gerenciador de certificados sejam atribuídos a indivíduos diferentes, que o Gerenciador de certificados tenha permissão para recuperar, mas não descriptografar chaves arquivadas, e que o agente de recuperação de chave tenha permissão para descriptografar chaves, mas não recuperá-las.</span><span class="sxs-lookup"><span data-stu-id="a1166-110">To enhance security, we recommend that the key recovery agent and the certificate manager roles be assigned to different individuals, that the certificate manager be permitted to retrieve but not decrypt archived keys, and that the key recovery agent be permitted to decrypt keys but not retrieve them.</span></span>

## <a name="key-archival"></a><span data-ttu-id="a1166-111">Arquivamento de chave</span><span class="sxs-lookup"><span data-stu-id="a1166-111">Key Archival</span></span>

<span data-ttu-id="a1166-112">Um cliente normalmente solicita um certificado usando um modelo.</span><span class="sxs-lookup"><span data-stu-id="a1166-112">A client typically requests a certificate by using a template.</span></span> <span data-ttu-id="a1166-113">Se o modelo exigir que a chave privada seja arquivada, as etapas a seguir serão executadas pelo cliente e pela autoridade de certificação:</span><span class="sxs-lookup"><span data-stu-id="a1166-113">If the template requires that the private key be archived, the following steps are performed by the client and the CA:</span></span>

1.  <span data-ttu-id="a1166-114">O cliente recupera e valida o certificado de troca de AC para determinar se ele foi assinado pela mesma chave que foi usada para assinar o certificado de assinatura de autoridade de certificação.</span><span class="sxs-lookup"><span data-stu-id="a1166-114">The client retrieves and validates the CA exchange certificate to determine whether it has been signed by the same key that was used to sign the CA signing certificate.</span></span> <span data-ttu-id="a1166-115">Isso garante que a única AC que pode descriptografar a chave privada é a AC da qual um certificado está sendo solicitado.</span><span class="sxs-lookup"><span data-stu-id="a1166-115">This ensures that the only CA that can decrypt the private key is the CA from which a certificate is being requested.</span></span>
2.  <span data-ttu-id="a1166-116">A chave pública no certificado de troca de AC é usada para criptografar a chave privada associada à solicitação de certificado e a solicitação é enviada para a autoridade de certificação.</span><span class="sxs-lookup"><span data-stu-id="a1166-116">The public key in the CA exchange certificate is used to encrypt the private key associated with the certificate request, and the request is sent to the CA.</span></span>
3.  <span data-ttu-id="a1166-117">A AC usa a chave privada associada ao seu certificado do Exchange para descriptografar a chave privada enviada pelo cliente e verifica se as chaves pública e privada na solicitação estão relacionadas.</span><span class="sxs-lookup"><span data-stu-id="a1166-117">The CA uses the private key associated with its exchange certificate to decrypt the private key sent by the client and verifies that the public and private keys in the request are related.</span></span>
4.  <span data-ttu-id="a1166-118">A autoridade de certificação criptografa a chave privada usando a chave pública no certificado KRA.</span><span class="sxs-lookup"><span data-stu-id="a1166-118">The CA encrypts the private key by using the public key in the KRA certificate.</span></span> <span data-ttu-id="a1166-119">Se a AC tiver emitido vários certificados de KRA, ele criptografará a chave privada uma vez com cada chave pública disponível para que qualquer agente de recuperação de chave autorizado possa recuperar uma chave.</span><span class="sxs-lookup"><span data-stu-id="a1166-119">If the CA has issued multiple KRA certificates, it encrypts the private key once with each available public key so that any authorized key recovery agent can recover a key.</span></span> <span data-ttu-id="a1166-120">As chaves privadas criptografadas são armazenadas no banco de dados de certificado.</span><span class="sxs-lookup"><span data-stu-id="a1166-120">The encrypted private keys are stored in the certificate database.</span></span>
5.  <span data-ttu-id="a1166-121">A CA libera Todas as referências à chave privada e libera com segurança e zera toda a memória que continha a chave.</span><span class="sxs-lookup"><span data-stu-id="a1166-121">The CA releases all references to the private key and securely frees and zeros all memory that contained the key.</span></span> <span data-ttu-id="a1166-122">Isso garante que a autoridade de certificação não tenha mais acesso à chave no formato de texto não criptografado.</span><span class="sxs-lookup"><span data-stu-id="a1166-122">This ensures that the CA has no further access to the key in clear text format.</span></span>

> [!Note]  
> <span data-ttu-id="a1166-123">Somente uma solicitação CMC pode ser usada para arquivamento de chave.</span><span class="sxs-lookup"><span data-stu-id="a1166-123">Only a CMC request can be used for key archival.</span></span> <span data-ttu-id="a1166-124">As solicitações CMC são representadas pela interface [**IX509CertificateRequestCmc**](/windows/desktop/api/CertEnroll/nn-certenroll-ix509certificaterequestcmc) .</span><span class="sxs-lookup"><span data-stu-id="a1166-124">CMC requests are represented by the [**IX509CertificateRequestCmc**](/windows/desktop/api/CertEnroll/nn-certenroll-ix509certificaterequestcmc) interface.</span></span>

 

## <a name="key-recovery"></a><span data-ttu-id="a1166-125">Recuperação de Chave</span><span class="sxs-lookup"><span data-stu-id="a1166-125">Key Recovery</span></span>

<span data-ttu-id="a1166-126">Não há suporte direto para a recuperação de chave por Active Directory serviços de certificados ou a API de registro de certificado.</span><span class="sxs-lookup"><span data-stu-id="a1166-126">Key recovery is not directly supported by Active Directory Certificate Services or the Certificate Enrollment API.</span></span> <span data-ttu-id="a1166-127">No entanto, a Microsoft fornece os seguintes aplicativos para ajudar com o processo:</span><span class="sxs-lookup"><span data-stu-id="a1166-127">Microsoft does, however, provide the following applications to help with the process:</span></span>

-   <span data-ttu-id="a1166-128">Certutil.exe é um programa de linha de comando que pode ser usado para recuperar informações de configuração de autoridade de certificação, verificar certificados, pares de chaves e cadeias de certificados e fazer backup e restaurar chaves.</span><span class="sxs-lookup"><span data-stu-id="a1166-128">Certutil.exe is a command line program that can be used to retrieve CA configuration information, verify certificates, key pairs, and certificate chains, and back up and restore keys.</span></span> <span data-ttu-id="a1166-129">Ele está incluído em sistemas operacionais de servidor que começam com o Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="a1166-129">It is included in server operating systems beginning with Windows Server 2003.</span></span>
-   <span data-ttu-id="a1166-130">Krecover.exe é um programa baseado na caixa de diálogo que permite a recuperação de chave.</span><span class="sxs-lookup"><span data-stu-id="a1166-130">Krecover.exe is a dialog box–based program that enables key recovery.</span></span> <span data-ttu-id="a1166-131">Ele está incluído no kit de recursos a partir do Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="a1166-131">It is included with the Resource Kit beginning with Windows Server 2003.</span></span>

<span data-ttu-id="a1166-132">As etapas a seguir são executadas para recuperar uma chave privada:</span><span class="sxs-lookup"><span data-stu-id="a1166-132">The following steps are performed to recover a private key:</span></span>

1.  <span data-ttu-id="a1166-133">O Gerenciador de certificados localiza possíveis candidatos à recuperação de chave no banco de dados de certificados usando o nome do certificado, solicitante ou usuário.</span><span class="sxs-lookup"><span data-stu-id="a1166-133">The certificate manager locates potential candidates for key recovery in the certificate database by using the name of the certificate, requester, or user.</span></span> <span data-ttu-id="a1166-134">O comando **certutil** **-GetKey** pode ser usado para essa finalidade.</span><span class="sxs-lookup"><span data-stu-id="a1166-134">The **Certutil** **-getkey** command can be used for this purpose.</span></span>
2.  <span data-ttu-id="a1166-135">Depois que o Gerenciador de certificados tiver uma lista de certificados, o comando **-GetKey** será chamado novamente com um número de série de certificado específico ou impressão em miniatura para recuperar um \# arquivo PKCS 7 que contém o certificado kra, a cadeia de certificados do usuário e a chave privada que foi criptografada durante o arquivamento usando a chave pública kra.</span><span class="sxs-lookup"><span data-stu-id="a1166-135">Once the certificate manager has a list of certificates, the **-getkey** command is called again with a specific certificate serial number or thumb print to retrieve a PKCS \#7 file that contains the KRA certificate, user certificate chain, and the private key that was encrypted during archival by using the KRA public key.</span></span>
3.  <span data-ttu-id="a1166-136">O Gerenciador de certificados passa o controle do processo para o agente de recuperação de chave cuja chave privada corresponde à chave pública contida no certificado KRA.</span><span class="sxs-lookup"><span data-stu-id="a1166-136">The certificate manager passes control of the process to the key recovery agent whose private key matches the public key contained in the KRA certificate.</span></span>
4.  <span data-ttu-id="a1166-137">O agente de recuperação de chave descriptografa a chave privada arquivada retornada no \# arquivo PKCS 7 usando a chave privada de Kra.</span><span class="sxs-lookup"><span data-stu-id="a1166-137">The key recovery agent decrypts the archived private key returned in the PKCS \#7 file by using the KRA private key.</span></span> <span data-ttu-id="a1166-138">Isso pode ser feito usando o comando **certutil** **-recoverkey** que coloca a chave em um arquivo PKCS 12 protegido por senha \# .</span><span class="sxs-lookup"><span data-stu-id="a1166-138">This can be done by using the **Certutil** **-recoverkey** command which places the key in a password-protected PKCS \#12 file.</span></span> <span data-ttu-id="a1166-139">O cliente deve receber a senha por meio de um mecanismo fora de banda seguro.</span><span class="sxs-lookup"><span data-stu-id="a1166-139">The client must be given the password through a secure out-of-band mechanism.</span></span>
5.  <span data-ttu-id="a1166-140">O cliente importa o \# arquivo PKCS 12 e usa a senha para recuperar a chave.</span><span class="sxs-lookup"><span data-stu-id="a1166-140">The client imports the PKCS \#12 file and uses the password to retrieve the key.</span></span>

## <a name="related-topics"></a><span data-ttu-id="a1166-141">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="a1166-141">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="a1166-142">Elementos PKI</span><span class="sxs-lookup"><span data-stu-id="a1166-142">PKI Elements</span></span>](about-pki-components.md)
</dt> </dl>

 

 



