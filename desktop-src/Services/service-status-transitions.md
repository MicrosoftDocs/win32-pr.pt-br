---
description: Um serviço é responsável por relatar alterações em seu estado para o SCM (Gerenciador de controle de serviço).
ms.assetid: 74a85730-6667-46fe-ae12-26561ccedb73
title: Transições de estado do serviço
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8df7684b1ebc04aa1116b09a3ae4321f2552d7b6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104556108"
---
# <a name="service-state-transitions"></a><span data-ttu-id="cd040-103">Transições de estado do serviço</span><span class="sxs-lookup"><span data-stu-id="cd040-103">Service State Transitions</span></span>

<span data-ttu-id="cd040-104">Um serviço é responsável por relatar alterações em seu estado para o SCM (Gerenciador de controle de serviço).</span><span class="sxs-lookup"><span data-stu-id="cd040-104">A service is responsible for reporting changes in its state to the service control manager (SCM).</span></span> <span data-ttu-id="cd040-105">Os programas de controle de serviço e o sistema podem descobrir o estado de um serviço somente do SCM, portanto, é importante que um serviço relate seu estado corretamente.</span><span class="sxs-lookup"><span data-stu-id="cd040-105">Service control programs and the system can find out the state of a service only from the SCM, so it is important that a service report its state correctly.</span></span> <span data-ttu-id="cd040-106">Um serviço relata seu estado chamando a função [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) com um ponteiro para uma estrutura de [**\_ status de serviço**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) totalmente inicializada.</span><span class="sxs-lookup"><span data-stu-id="cd040-106">A service reports its state by calling the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function with a pointer to a fully initialized [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="cd040-107">O membro **dwCurrentState** da estrutura contém o estado do serviço a ser relatado.</span><span class="sxs-lookup"><span data-stu-id="cd040-107">The **dwCurrentState** member of the structure contains the service state to be reported.</span></span>

<span data-ttu-id="cd040-108">O estado inicial de um serviço é serviço \_ interrompido.</span><span class="sxs-lookup"><span data-stu-id="cd040-108">The initial state of a service is SERVICE\_STOPPED.</span></span> <span data-ttu-id="cd040-109">Quando o SCM inicia o serviço, ele define o estado do serviço como serviço de \_ início \_ pendente e chama a [](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) função de serviço de funções.</span><span class="sxs-lookup"><span data-stu-id="cd040-109">When the SCM starts the service, it sets the service state to SERVICE\_START\_PENDING and calls the service's [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function.</span></span> <span data-ttu-id="cd040-110">Em seguida, o serviço conclui sua inicialização usando uma das técnicas descritas na [função Service-Main](service-servicemain-function.md).</span><span class="sxs-lookup"><span data-stu-id="cd040-110">The service then completes its initialization using one of the techniques described in [Service ServiceMain Function](service-servicemain-function.md).</span></span> <span data-ttu-id="cd040-111">Depois que o serviço concluir sua inicialização e estiver pronto para começar a receber solicitações de controle, o serviço chamará [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para o serviço de relatório \_ em execução e especificará as solicitações de controle que o serviço está preparado para aceitar.</span><span class="sxs-lookup"><span data-stu-id="cd040-111">After the service completes its initialization and is ready to start receiving control requests, the service calls [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report SERVICE\_RUNNING and specify the control requests the service is prepared to accept.</span></span> <span data-ttu-id="cd040-112">A transição do início do serviço \_ \_ pendente para \_ o serviço em execução indica as ferramentas de monitoramento de serviço e SCM que o serviço iniciou com êxito.</span><span class="sxs-lookup"><span data-stu-id="cd040-112">The transition from SERVICE\_START\_PENDING to SERVICE\_RUNNING indicates to the SCM and service-monitoring tools that the service has started successfully.</span></span> <span data-ttu-id="cd040-113">Se o serviço relatar um estado diferente do serviço \_ em execução, as ferramentas SCM ou monitoramento de serviço poderão marcar o serviço como tendo falhado ao iniciar.</span><span class="sxs-lookup"><span data-stu-id="cd040-113">If the service reports a state other than SERVICE\_RUNNING, the SCM or service-monitoring tools might mark the service as having failed to start.</span></span>

<span data-ttu-id="cd040-114">O SCM envia apenas as solicitações de controle especificadas para o serviço (exceto para a \_ solicitação de interrogação de controle de serviço \_ , que é sempre enviada).</span><span class="sxs-lookup"><span data-stu-id="cd040-114">The SCM sends only the specified control requests to the service (except for the SERVICE\_CONTROL\_INTERROGATE request, which is always sent).</span></span> <span data-ttu-id="cd040-115">Para obter uma lista das solicitações de controle que um serviço pode aceitar, consulte o membro **dwControlsAccepted** da estrutura de [**\_ status do serviço**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="cd040-115">For a list of the control requests that a service can accept, see the **dwControlsAccepted** member of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="cd040-116">Para obter informações sobre como registrar-se para receber eventos de dispositivo, consulte a função [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) .</span><span class="sxs-lookup"><span data-stu-id="cd040-116">For information about registering to receive device events, see the [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) function.</span></span>

<span data-ttu-id="cd040-117">O estado do serviço normalmente muda como resultado do tratamento de uma solicitação de controle.</span><span class="sxs-lookup"><span data-stu-id="cd040-117">The service state typically changes as a result of handling a control request.</span></span> <span data-ttu-id="cd040-118">As solicitações de controle que fazem com que o estado do serviço mudem incluem \_ interrupção do controle \_ de serviço, pausa de controle de serviço \_ \_ e continuação do \_ controle \_ de serviço.</span><span class="sxs-lookup"><span data-stu-id="cd040-118">Control requests that cause the service state to change include SERVICE\_CONTROL\_STOP, SERVICE\_CONTROL\_PAUSE, and SERVICE\_CONTROL\_CONTINUE.</span></span> <span data-ttu-id="cd040-119">Se o serviço precisar fazer processamento longo para lidar com qualquer uma dessas solicitações, ele deverá criar um thread secundário para executar o processamento longo e relatar o estado pendente correspondente ao SCM.</span><span class="sxs-lookup"><span data-stu-id="cd040-119">If the service must do lengthy processing to handle any of these requests, it should create a secondary thread to perform the lengthy processing and report the corresponding pending state to the SCM.</span></span> <span data-ttu-id="cd040-120">(Para obter um melhor desempenho no Windows Vista e em versões posteriores do Windows, o serviço deve usar um thread de trabalho de um [pool de threads](/windows/desktop/ProcThread/thread-pools) para essa finalidade.) O serviço deve reportar a transição de estado concluído quando o processamento longo for concluído.</span><span class="sxs-lookup"><span data-stu-id="cd040-120">(For best performance on Windows Vista and later versions of Windows, the service should use a worker thread from a [thread pool](/windows/desktop/ProcThread/thread-pools) for this purpose.) The service should then report the completed state transition when the lengthy processing is finished.</span></span> <span data-ttu-id="cd040-121">Para obter mais informações sobre como lidar com solicitações de controle, consulte [função do manipulador de controle de serviço](service-control-handler-function.md).</span><span class="sxs-lookup"><span data-stu-id="cd040-121">For more information about handling control requests, see [Service Control Handler Function](service-control-handler-function.md).</span></span>

<span data-ttu-id="cd040-122">Somente determinadas transições de estado de serviço são válidas.</span><span class="sxs-lookup"><span data-stu-id="cd040-122">Only certain service state transitions are valid.</span></span> <span data-ttu-id="cd040-123">O diagrama a seguir mostra as transições válidas.</span><span class="sxs-lookup"><span data-stu-id="cd040-123">The following diagram shows the valid transitions.</span></span>

![transições de status de serviço válidas](images/service-status-transitions.png)

<span data-ttu-id="cd040-125">O estado do serviço relatado para o SCM determina como o SCM interage com o serviço.</span><span class="sxs-lookup"><span data-stu-id="cd040-125">The service state reported to the SCM determines how the SCM interacts with the service.</span></span> <span data-ttu-id="cd040-126">Por exemplo, se um serviço de relatórios de serviço \_ parar \_ pendente, o SCM não transmitirá mais solicitações de controle para o serviço, pois esse estado indica que o serviço está sendo desligado.</span><span class="sxs-lookup"><span data-stu-id="cd040-126">For example, if a service reports SERVICE\_STOP\_PENDING, the SCM does not transmit further control requests to the service because this state indicates that the service is shutting down.</span></span> <span data-ttu-id="cd040-127">O próximo estado relatado pelo serviço deve ser serviço \_ interrompido porque esse é o único estado válido após a interrupção do serviço ser \_ \_ pendente.</span><span class="sxs-lookup"><span data-stu-id="cd040-127">The next state reported by the service should be SERVICE\_STOPPED because that is the only valid state after SERVICE\_STOP\_PENDING.</span></span> <span data-ttu-id="cd040-128">No entanto, se um serviço reportar uma transição que não seja válida, o SCM não falhará na chamada.</span><span class="sxs-lookup"><span data-stu-id="cd040-128">However, if a service reports a transition that is not valid, the SCM does not fail the call.</span></span>

<span data-ttu-id="cd040-129">O diagrama a seguir mostra as transições de estado de serviço em mais detalhes, incluindo as solicitações de controle iniciadas por um programa de controle de serviço (o cliente de serviço) e as chamadas [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) que um serviço faz para relatar alterações de estado para o SCM.</span><span class="sxs-lookup"><span data-stu-id="cd040-129">The following diagram shows service state transitions in more detail, including the control requests initiated by a service control program (the service client) and the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) calls that a service makes to report state changes to the SCM.</span></span> <span data-ttu-id="cd040-130">Como mencionado anteriormente, o SCM envia apenas as solicitações de controle que o serviço especificou que ele aceitará, de modo que um serviço pode não receber todas as solicitações mostradas no diagrama.</span><span class="sxs-lookup"><span data-stu-id="cd040-130">As mentioned earlier, the SCM sends only control requests that the service has specified it will accept, so a service might not receive all of the requests shown in the diagram.</span></span>

![<span data-ttu-id="cd040-131">transições de status de serviço em detalhes</span><span class="sxs-lookup"><span data-stu-id="cd040-131">service status transitions in detail</span></span> ](images/service-status-flow-diagram.png)

## <a name="related-topics"></a><span data-ttu-id="cd040-132">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="cd040-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="cd040-133">**ControlService**</span><span class="sxs-lookup"><span data-stu-id="cd040-133">**ControlService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-controlservice)
</dt> <dt>

[<span data-ttu-id="cd040-134">**ControlServiceEx**</span><span class="sxs-lookup"><span data-stu-id="cd040-134">**ControlServiceEx**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-controlserviceexa)
</dt> <dt>

[<span data-ttu-id="cd040-135">**Falha em SetServiceStatus**</span><span class="sxs-lookup"><span data-stu-id="cd040-135">**SetServiceStatus**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus)
</dt> </dl>

 

 
