---
description: Cada serviço tem um manipulador de controle, a função de manipulador, que é invocado pelo Dispatcher de controle quando o processo de serviço recebe uma solicitação de controle de um programa de controle de serviço.
ms.assetid: 437334ed-05fa-4ab6-aab3-dc2739113e19
title: Função do manipulador do controle de serviço
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1303bff45421ee7206d02be9ee30066324648823
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/07/2021
ms.locfileid: "105754113"
---
# <a name="service-control-handler-function"></a><span data-ttu-id="97f1f-103">Função do manipulador do controle de serviço</span><span class="sxs-lookup"><span data-stu-id="97f1f-103">Service Control Handler Function</span></span>

<span data-ttu-id="97f1f-104">Cada serviço tem um manipulador de controle, a função de [**manipulador**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) , que é invocado pelo Dispatcher de controle quando o processo de serviço recebe uma solicitação de controle de um programa de controle de serviço.</span><span class="sxs-lookup"><span data-stu-id="97f1f-104">Each service has a control handler, the [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function, that is invoked by the control dispatcher when the service process receives a control request from a service control program.</span></span> <span data-ttu-id="97f1f-105">Portanto, essa função é executada no contexto do Dispatcher de controle.</span><span class="sxs-lookup"><span data-stu-id="97f1f-105">Therefore, this function executes in the context of the control dispatcher.</span></span> <span data-ttu-id="97f1f-106">Para obter um exemplo, consulte [escrevendo uma função de manipulador de controle](writing-a-control-handler-function.md).</span><span class="sxs-lookup"><span data-stu-id="97f1f-106">For an example, see [Writing a Control Handler Function](writing-a-control-handler-function.md).</span></span>

<span data-ttu-id="97f1f-107">Um serviço chama a função [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) ou [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) para registrar sua função de manipulador de controle de serviço.</span><span class="sxs-lookup"><span data-stu-id="97f1f-107">A service calls the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) or [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) function to register its service control handler function.</span></span>

<span data-ttu-id="97f1f-108">Quando o manipulador de controle de serviço é invocado, o serviço deve chamar a função [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para relatar seu status para o SCM somente se manipular o código de controle faz com que o status do serviço seja alterado.</span><span class="sxs-lookup"><span data-stu-id="97f1f-108">When the service control handler is invoked, the service must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report its status to the SCM only if handling the control code causes the service status to change.</span></span> <span data-ttu-id="97f1f-109">Se a manipulação do código de controle não fizer com que o status do serviço seja alterado, não será necessário chamar **falha em SetServiceStatus**.</span><span class="sxs-lookup"><span data-stu-id="97f1f-109">If handling the control code does not cause the service status to change, it is not necessary to call **SetServiceStatus**.</span></span>

<span data-ttu-id="97f1f-110">Um programa de controle de serviço pode enviar solicitações de controle usando a função [**chamada ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) .</span><span class="sxs-lookup"><span data-stu-id="97f1f-110">A service control program can send control requests using the [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) function.</span></span> <span data-ttu-id="97f1f-111">Todos os serviços devem aceitar e processar o código de controle **\_ \_ Interrogate de controle de serviço** .</span><span class="sxs-lookup"><span data-stu-id="97f1f-111">All services must accept and process the **SERVICE\_CONTROL\_INTERROGATE** control code.</span></span> <span data-ttu-id="97f1f-112">Você pode habilitar ou desabilitar a aceitação dos outros códigos de controle chamando [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span><span class="sxs-lookup"><span data-stu-id="97f1f-112">You can enable or disable acceptance of the other control codes by calling [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span></span> <span data-ttu-id="97f1f-113">Para receber o código de controle **\_ \_ DEVICEEVENT de controle de serviço** , você deve chamar a função [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) .</span><span class="sxs-lookup"><span data-stu-id="97f1f-113">To receive the **SERVICE\_CONTROL\_DEVICEEVENT** control code, you must call the [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) function.</span></span> <span data-ttu-id="97f1f-114">Os serviços também podem manipular códigos de controle adicionais definidos pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="97f1f-114">Services can also handle additional user-defined control codes.</span></span>

<span data-ttu-id="97f1f-115">Se um serviço aceitar o código de controle de **\_ \_ parada de controle de serviço** , ele deverá parar após o recebimento, indo para o estado de interrupção de **serviço \_ \_ pendente** ou **serviço \_ parado** .</span><span class="sxs-lookup"><span data-stu-id="97f1f-115">If a service accepts the **SERVICE\_CONTROL\_STOP** control code, it must stop upon receipt, going to either the **SERVICE\_STOP\_PENDING** or **SERVICE\_STOPPED** state.</span></span> <span data-ttu-id="97f1f-116">Depois que o SCM enviar esse código de controle, ele não enviará outros códigos de controle.</span><span class="sxs-lookup"><span data-stu-id="97f1f-116">After the SCM sends this control code, it will not send other control codes.</span></span>

<span data-ttu-id="97f1f-117">**Windows XP:** Se o serviço **não retornar nenhum \_ erro** e continuar a ser executado, ele continuará a receber códigos de controle.</span><span class="sxs-lookup"><span data-stu-id="97f1f-117">**Windows XP:** If the service returns **NO\_ERROR** and continues to run, it continues to receive control codes.</span></span> <span data-ttu-id="97f1f-118">Esse comportamento mudou a partir do Windows Server 2003 e do Windows XP com Service Pack 2 (SP2).</span><span class="sxs-lookup"><span data-stu-id="97f1f-118">This behavior changed starting with Windows Server 2003 and Windows XP with Service Pack 2 (SP2).</span></span>

<span data-ttu-id="97f1f-119">O manipulador de controle deve retornar dentro de 30 segundos ou o SCM retorna um erro.</span><span class="sxs-lookup"><span data-stu-id="97f1f-119">The control handler must return within 30 seconds, or the SCM returns an error.</span></span> <span data-ttu-id="97f1f-120">Se um serviço precisar fazer processamento longo quando o serviço estiver executando o manipulador de controle, ele deverá criar um thread secundário para executar o processamento longo e, em seguida, retornar do manipulador de controle.</span><span class="sxs-lookup"><span data-stu-id="97f1f-120">If a service must do lengthy processing when the service is executing the control handler, it should create a secondary thread to perform the lengthy processing, and then return from the control handler.</span></span> <span data-ttu-id="97f1f-121">Isso impede que o serviço se vinculasse ao dispatcher de controle.</span><span class="sxs-lookup"><span data-stu-id="97f1f-121">This prevents the service from tying up the control dispatcher.</span></span> <span data-ttu-id="97f1f-122">Por exemplo, ao tratar a solicitação de parada de um serviço que leva muito tempo, crie outro thread para manipular o processo de parada.</span><span class="sxs-lookup"><span data-stu-id="97f1f-122">For example, when handling the stop request for a service that takes a long time, create another thread to handle the stop process.</span></span> <span data-ttu-id="97f1f-123">O manipulador de controle deve simplesmente chamar [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) com a mensagem de interrupção de serviço e retorno **\_ \_ pendentes** .</span><span class="sxs-lookup"><span data-stu-id="97f1f-123">The control handler should simply call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_STOP\_PENDING** message and return.</span></span>

<span data-ttu-id="97f1f-124">Quando o usuário desliga o sistema, todos os manipuladores de controle que chamaram [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) com o código de controle de **\_ \_ desligamento de aceitação do serviço** recebem o código de controle de **\_ \_ pré-desligamento do controle de serviço** .</span><span class="sxs-lookup"><span data-stu-id="97f1f-124">When the user shuts down the system, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_PRESHUTDOWN** control code receive the **SERVICE\_CONTROL\_PRESHUTDOWN** control code.</span></span> <span data-ttu-id="97f1f-125">O Gerenciador de controle de serviço aguarda até que o serviço seja interrompido ou o valor de tempo limite de pré-desligamento especificado expire (esse valor pode ser definido com a função [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) ).</span><span class="sxs-lookup"><span data-stu-id="97f1f-125">The service control manager waits until the service stops or the specified preshutdown time-out value expires (this value can be set with the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) function).</span></span> <span data-ttu-id="97f1f-126">Esse código de controle deve ser usado apenas em circunstâncias especiais, porque um serviço que manipula essa notificação bloqueia o desligamento do sistema até que o serviço seja interrompido ou o intervalo de tempo limite de pré-desligamento expire.</span><span class="sxs-lookup"><span data-stu-id="97f1f-126">This control code should be used only in special circumstances, because a service that handles this notification blocks system shutdown until the service stops or the preshutdown time-out interval expires.</span></span>

<span data-ttu-id="97f1f-127">Após a conclusão das notificações de pré-desligamento, todos os manipuladores de controle que chamaram [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) com o código de controle de desligamento de **\_ aceitação \_ do serviço** receberão o código de controle de **\_ \_ desligamento do controle de serviço** .</span><span class="sxs-lookup"><span data-stu-id="97f1f-127">After the preshutdown notifications have been completed, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_SHUTDOWN** control code receive the **SERVICE\_CONTROL\_SHUTDOWN** control code.</span></span> <span data-ttu-id="97f1f-128">Eles são notificados na ordem em que aparecem no banco de dados dos serviços instalados.</span><span class="sxs-lookup"><span data-stu-id="97f1f-128">They are notified in the order that they appear in the database of installed services.</span></span> <span data-ttu-id="97f1f-129">Por padrão, um serviço tem aproximadamente 20 segundos para executar tarefas de limpeza antes de o sistema ser desligado.</span><span class="sxs-lookup"><span data-stu-id="97f1f-129">By default, a service has approximately 20 seconds to perform cleanup tasks before the system shuts down.</span></span> <span data-ttu-id="97f1f-130">Depois que esse tempo expirar, o desligamento do sistema continuará independentemente de o desligamento do serviço ser concluído.</span><span class="sxs-lookup"><span data-stu-id="97f1f-130">After this time expires, system shutdown proceeds regardless of whether service shutdown is complete.</span></span> <span data-ttu-id="97f1f-131">Observe que, se o sistema for deixado no estado de desligamento (não reiniciado ou desligado), o serviço continuará a ser executado.</span><span class="sxs-lookup"><span data-stu-id="97f1f-131">Note that if the system is left in the shutdown state (not restarted or powered down), the service continues to run.</span></span>

<span data-ttu-id="97f1f-132">Se o serviço exigir mais tempo para a limpeza, ele enviará mensagens de status de **parada \_ pendentes** , juntamente com uma dica de espera, para que o controlador de serviço saiba por quanto tempo esperar antes de relatar ao sistema que o desligamento do serviço foi concluído.</span><span class="sxs-lookup"><span data-stu-id="97f1f-132">If the service requires more time to cleanup, it sends **STOP\_PENDING** status messages, along with a wait hint, so the service controller knows how long to wait before reporting to the system that service shutdown is complete.</span></span> <span data-ttu-id="97f1f-133">No entanto, para impedir que um serviço pare o desligamento, há um limite de quanto tempo o controlador de serviço espera.</span><span class="sxs-lookup"><span data-stu-id="97f1f-133">However, to prevent a service from stopping shutdown, there is a limit to how long the service controller waits.</span></span> <span data-ttu-id="97f1f-134">Se o serviço estiver sendo desligado por meio do snap-in serviços, o limite será de 125 segundos ou 125.000 milissegundos.</span><span class="sxs-lookup"><span data-stu-id="97f1f-134">If the service is being shut down through the Services snap-in, the limit is 125 seconds, or 125,000 milliseconds.</span></span> <span data-ttu-id="97f1f-135">Se o sistema operacional estiver sendo reinicializado, o limite de tempo será especificado no valor de **WaitToKillServiceTimeout** (em milissegundos) da seguinte chave do registro:</span><span class="sxs-lookup"><span data-stu-id="97f1f-135">If the operating system is rebooting, the time limit is specified in the **WaitToKillServiceTimeout** value (in milliseconds) of the following registry key:</span></span>

<span data-ttu-id="97f1f-136">**HKEY \_ \_ computador local \\ sistema \\ CurrentControlSet \\ Control**</span><span class="sxs-lookup"><span data-stu-id="97f1f-136">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control**</span></span>

> [!IMPORTANT]
> <span data-ttu-id="97f1f-137">Um serviço não deve tentar aumentar o limite de tempo modificando esse valor.</span><span class="sxs-lookup"><span data-stu-id="97f1f-137">A service should not attempt to increase the time limit by modifying this value.</span></span> <span data-ttu-id="97f1f-138">Se você precisar definir **WaitToKillServiceTimeout** manualmente, o valor deverá ser em milissegundos.</span><span class="sxs-lookup"><span data-stu-id="97f1f-138">If you do need to set **WaitToKillServiceTimeout** by hand, the value should be in milliseconds.</span></span>

<span data-ttu-id="97f1f-139">Os clientes precisam de um desligamento rápido do sistema operacional.</span><span class="sxs-lookup"><span data-stu-id="97f1f-139">Customers require fast shutdown of the operating system.</span></span> <span data-ttu-id="97f1f-140">Por exemplo, se um computador que executa o no-break não puder concluir o desligamento antes de o UPS ficar sem energia, os dados poderão ser perdidos.</span><span class="sxs-lookup"><span data-stu-id="97f1f-140">For example, if a computer running on UPS power cannot complete shutdown before the UPS runs out of power, data can be lost.</span></span> <span data-ttu-id="97f1f-141">Portanto, os serviços devem concluir suas tarefas de limpeza o mais rápido possível.</span><span class="sxs-lookup"><span data-stu-id="97f1f-141">Therefore, services should complete their cleanup tasks as quickly as possible.</span></span> <span data-ttu-id="97f1f-142">É uma boa prática minimizar dados não salvos salvando dados regularmente, controlando os dados que são salvos em disco e salvando apenas os dados não salvos no desligamento.</span><span class="sxs-lookup"><span data-stu-id="97f1f-142">It is a good practice to minimize unsaved data by saving data on a regular basis, keeping track of the data that is saved to disk, and only saving your unsaved data on shutdown.</span></span> <span data-ttu-id="97f1f-143">Como o computador está sendo desligado, não perca tempo liberando memória alocada ou outros recursos do sistema.</span><span class="sxs-lookup"><span data-stu-id="97f1f-143">Because the computer is being shut down, do not spend time releasing allocated memory or other system resources.</span></span> <span data-ttu-id="97f1f-144">Se você precisar notificar um servidor que está sendo encerrado, minimize o tempo gasto aguardando uma resposta, pois problemas de rede podem atrasar o desligamento do serviço.</span><span class="sxs-lookup"><span data-stu-id="97f1f-144">If you need to notify a server that you are exiting, minimize the time spent waiting for a reply, because network problems could delay the shutdown of your service.</span></span>

<span data-ttu-id="97f1f-145">Observe que durante o desligamento do serviço, por padrão, o SCM não leva em consideração as dependências.</span><span class="sxs-lookup"><span data-stu-id="97f1f-145">Note that during service shutdown, by default, the SCM does not take dependencies into consideration.</span></span> <span data-ttu-id="97f1f-146">O SCM enumera a lista de serviços em execução e envia o comando de **\_ \_ desligamento do controle de serviço** .</span><span class="sxs-lookup"><span data-stu-id="97f1f-146">The SCM enumerates the list of running services and sends the **SERVICE\_CONTROL\_SHUTDOWN** command.</span></span> <span data-ttu-id="97f1f-147">Portanto, um serviço pode falhar porque outro serviço do qual ele depende já parou.</span><span class="sxs-lookup"><span data-stu-id="97f1f-147">Therefore, a service may fail because another service it depends on has already stopped.</span></span>

<span data-ttu-id="97f1f-148">Para definir a ordem de desligamento dos serviços manualmente, crie um valor de registro multistring que contenha os nomes de serviço na ordem em que eles devem ser desligados e atribua-os ao valor **PreshutdownOrder** da chave de controle, da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="97f1f-148">To set the shutdown order of services manually, create a multistring registry value that contains the service names in the order in which they should be shut down and assign it to the Control key's **PreshutdownOrder** value, as follows:</span></span>

<span data-ttu-id="97f1f-149">**HKEY \_ local \_ Machine \\ System \\ CurrentControlSet \\ Control \\ PreshutdownOrder = "desligar ordem"**</span><span class="sxs-lookup"><span data-stu-id="97f1f-149">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\PreshutdownOrder="Shutdown Order"**</span></span>

<span data-ttu-id="97f1f-150">Para definir a ordem de desligamento dos serviços dependentes do seu aplicativo, use a função [**SetProcessShutdownParameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) .</span><span class="sxs-lookup"><span data-stu-id="97f1f-150">To set the shutdown order of dependent services from your application, use the [**SetProcessShutdownParameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) function.</span></span> <span data-ttu-id="97f1f-151">O SCM usa essa função para dar seu manipulador 0x1E0 prioridade.</span><span class="sxs-lookup"><span data-stu-id="97f1f-151">The SCM uses this function to give its handler 0x1E0 priority.</span></span> <span data-ttu-id="97f1f-152">O SCM envia notificações de **\_ \_ desligamento de controle de serviço** quando seu manipulador de controle é chamado e aguarda a saída dos serviços antes de retornar de seu manipulador de controle.</span><span class="sxs-lookup"><span data-stu-id="97f1f-152">The SCM sends **SERVICE\_CONTROL\_SHUTDOWN** notifications when its control handler is called and waits for the services to exit before returning from its control handler.</span></span>

## <a name="related-topics"></a><span data-ttu-id="97f1f-153">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="97f1f-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="97f1f-154">Escrevendo uma função de manipulador de controle</span><span class="sxs-lookup"><span data-stu-id="97f1f-154">Writing a Control Handler Function</span></span>](writing-a-control-handler-function.md)
</dt> </dl>

 

 
