---
description: Saiba mais sobre como proteger os serviços de modo de usuário do anti-malware (AM) e como você pode optar por incluir esse recurso em seu serviço de anti-malware.
ms.assetid: 88875a0d-9027-43f2-8411-34f9ff428fe5
title: Protegendo serviços Antimalware
ms.topic: article
ms.date: 08/02/2018
ms.openlocfilehash: 5e7783eb307381d368900332b5e761ad62785913
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104011711"
---
# <a name="protecting-anti-malware-services"></a><span data-ttu-id="5aa23-103">Protegendo serviços Antimalware</span><span class="sxs-lookup"><span data-stu-id="5aa23-103">Protecting Anti-Malware Services</span></span>

<span data-ttu-id="5aa23-104">Windows 8.1 introduziu um novo conceito de serviços protegidos para proteger os serviços Antimalware, que são um alvo frequente de ataque por malware.</span><span class="sxs-lookup"><span data-stu-id="5aa23-104">Windows 8.1 introduced a new concept of protected services to protect anti-malware services, which are a frequent target of attack by malware.</span></span>

<span data-ttu-id="5aa23-105">Saiba mais sobre como proteger os serviços de modo de usuário do anti-malware (AM) e como você pode optar por incluir esse recurso em seu serviço de anti-malware.</span><span class="sxs-lookup"><span data-stu-id="5aa23-105">Learn about protecting anti-malware (AM) user mode services and how you can opt to include this feature in your anti-malware service.</span></span>

<span data-ttu-id="5aa23-106">Essas informações se aplicam aos seguintes sistemas operacionais e aos seus sucessores:</span><span class="sxs-lookup"><span data-stu-id="5aa23-106">This information applies to the following operating systems and their successors:</span></span>

-   <span data-ttu-id="5aa23-107">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="5aa23-107">Windows 8.1</span></span>
-   <span data-ttu-id="5aa23-108">Windows Server 2012 R2</span><span class="sxs-lookup"><span data-stu-id="5aa23-108">Windows Server 2012 R2</span></span>

<span data-ttu-id="5aa23-109">As referências e os recursos discutidos aqui são listados no final deste tópico.</span><span class="sxs-lookup"><span data-stu-id="5aa23-109">References and resources discussed here are listed at the end of this topic.</span></span>

## <a name="introduction"></a><span data-ttu-id="5aa23-110">Introdução</span><span class="sxs-lookup"><span data-stu-id="5aa23-110">Introduction</span></span>

<span data-ttu-id="5aa23-111">A maioria das soluções Antimalware inclui um serviço de modo de usuário que executa operações especializadas para detectar e remover malware do sistema.</span><span class="sxs-lookup"><span data-stu-id="5aa23-111">Most anti-malware solutions include a user-mode service that performs specialized operations to detect and remove malware from the system.</span></span> <span data-ttu-id="5aa23-112">Esse serviço de modo de usuário também é freqüentemente responsável por baixar as definições de vírus e assinaturas mais recentes.</span><span class="sxs-lookup"><span data-stu-id="5aa23-112">This user-mode service is also frequently responsible for downloading the latest virus definitions and signatures.</span></span> <span data-ttu-id="5aa23-113">Esse serviço de modo de usuário se torna um destino frequente de malware porque é o ponto único de falha ao desabilitar a proteção em um sistema.</span><span class="sxs-lookup"><span data-stu-id="5aa23-113">This user-mode service becomes a frequent target of malware because it’s the single point of failure to disable protection on a system.</span></span> <span data-ttu-id="5aa23-114">Para se defender contra ataques no serviço de modo de usuário, os fornecedores de anti-malware precisam adicionar muita funcionalidade e heurística ao software.</span><span class="sxs-lookup"><span data-stu-id="5aa23-114">To defend against attacks on the user-mode service, anti-malware vendors have to add a lot of functionality and heuristics to their software.</span></span> <span data-ttu-id="5aa23-115">No entanto, essas técnicas não são totalmente infalívels e tendem a ser propensas a erros, pois precisam identificar a funcionalidade que o Windows realiza em seu serviço e habilitar seletivamente essa funcionalidade.</span><span class="sxs-lookup"><span data-stu-id="5aa23-115">However, such techniques are not completely foolproof and tend to be error prone because they have to identify functionality that Windows performs on their service and selectively enable that functionality.</span></span>

<span data-ttu-id="5aa23-116">No Windows 8.1, um novo conceito de serviço protegido foi introduzido para permitir que os serviços de modo de usuário Antimalware sejam iniciados como um serviço protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-116">In Windows 8.1, a new concept of protected service has been introduced to allow anti-malware user-mode services to be launched as a protected service.</span></span> <span data-ttu-id="5aa23-117">Depois que o serviço é iniciado como protegido, o Windows usa a integridade do código para permitir que apenas o código confiável seja carregado no serviço protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-117">After the service is launched as protected, Windows uses code integrity to only allow trusted code to load into the protected service.</span></span> <span data-ttu-id="5aa23-118">O Windows também protege esses processos contra injeção de código e outros ataques de processos administrativos.</span><span class="sxs-lookup"><span data-stu-id="5aa23-118">Windows also protects these processes from code injection and other attacks from admin processes.</span></span>

<span data-ttu-id="5aa23-119">Este documento descreve como um fornecedor anti-malware com um driver ELAM (AntiMalware de início antecipado) pode aceitar esse recurso e iniciar seu serviço Antimalware como um serviço protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-119">This document describes how an anti-malware vendor with an Early Launch Anti-Malware (ELAM) driver can opt-in to this feature and launch their anti-malware service as a protected service.</span></span>

## <a name="system-protected-process"></a><span data-ttu-id="5aa23-120">Processo protegido pelo sistema</span><span class="sxs-lookup"><span data-stu-id="5aa23-120">System protected process</span></span>

<span data-ttu-id="5aa23-121">A partir do Windows 8.1, um novo modelo de segurança foi implementado no kernel para se defender melhor contra ataques mal-intencionados em componentes críticos do sistema.</span><span class="sxs-lookup"><span data-stu-id="5aa23-121">Starting with Windows 8.1, a new security model has been put in place in the kernel to better defend against malicious attacks on system-critical components.</span></span> <span data-ttu-id="5aa23-122">Esse novo modelo de segurança estende as versões anteriores da infraestrutura de processo protegida do Windows usadas para cenários específicos, como a execução de conteúdo DRM, em um modelo de finalidade geral que pode ser usado por fornecedores antimalware de terceiros.</span><span class="sxs-lookup"><span data-stu-id="5aa23-122">This new security model extends the protected process infrastructure previous versions of Windows used for specific scenarios, such as playing DRM content, into a general-purpose model that can be used by 3rd party anti-malware vendors.</span></span> <span data-ttu-id="5aa23-123">A infraestrutura de processo protegida só permite que código confiável e assinado carregue e tenha defesa interna contra ataques de injeção de código.</span><span class="sxs-lookup"><span data-stu-id="5aa23-123">The protected process infrastructure only allows trusted, signed code to load and has built-in defense against code injection attacks.</span></span>

<span data-ttu-id="5aa23-124">Consulte [processos protegidos no Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) para obter mais informações sobre processos protegidos.</span><span class="sxs-lookup"><span data-stu-id="5aa23-124">See [Protected Processes in Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) for more information on protected processes.</span></span>

<span data-ttu-id="5aa23-125">O novo modelo de segurança usa uma variante ligeiramente diferente da infraestrutura do processo de proteção chamada processo protegido pelo sistema, que é mais adequada para esse recurso, pois isso mantém o conteúdo do DRM separado.</span><span class="sxs-lookup"><span data-stu-id="5aa23-125">The new security model uses a slightly different variant of the protection process infrastructure called system protected process, which is more suitable for this feature as this keeps the DRM content separate.</span></span> <span data-ttu-id="5aa23-126">Cada processo protegido pelo sistema tem um nível ou atributo associado, que indica a diretiva de assinatura do código assinado com permissão para carregar dentro do processo.</span><span class="sxs-lookup"><span data-stu-id="5aa23-126">Each system protected process has an associated level or attribute, which indicates the signature policy of the signed code allowed to load within the process.</span></span> <span data-ttu-id="5aa23-127">Depois que os serviços Antimalware tiverem optado no modo de serviço protegido, somente código assinado do Windows ou código assinado com os certificados do fornecedor Antimalware poderão ser carregados nesse processo.</span><span class="sxs-lookup"><span data-stu-id="5aa23-127">After the anti-malware services have opted into the protected service mode, only Windows signed code or code signed with the anti-malware vendor’s certificates are allowed to load in that process.</span></span> <span data-ttu-id="5aa23-128">Da mesma forma, outros níveis de processo protegidos têm políticas de código diferentes impostas pelo Windows.</span><span class="sxs-lookup"><span data-stu-id="5aa23-128">Similarly, other protected process levels have different code policies enforced by Windows.</span></span>

## <a name="requirements"></a><span data-ttu-id="5aa23-129">Requisitos</span><span class="sxs-lookup"><span data-stu-id="5aa23-129">Requirements</span></span>

<span data-ttu-id="5aa23-130">Para que um serviço de modo de usuário Antimalware seja executado como um serviço protegido, o fornecedor de anti-malware deve ter um driver ELAM instalado no computador com Windows.</span><span class="sxs-lookup"><span data-stu-id="5aa23-130">For an anti-malware user-mode service to run as a protected service, the anti-malware vendor must have an ELAM driver installed on the Windows machine.</span></span> <span data-ttu-id="5aa23-131">Além dos requisitos de certificação do driver ELAM existentes, o driver deve ter uma seção de recurso inserido que contém as informações dos certificados usados para assinar os binários do serviço de modo de usuário.</span><span class="sxs-lookup"><span data-stu-id="5aa23-131">In addition to the existing ELAM driver certification requirements, the driver must have an embedded resource section containing the information of the certificates used to sign the user mode service binaries.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="5aa23-132">Em Windows 8.1, a cadeia de certificação deve ser uma raiz conhecida, conforme determinado pela verificação do driver, ou o certificado raiz deve ser incluído.</span><span class="sxs-lookup"><span data-stu-id="5aa23-132">In Windows 8.1, the certification chain either has to be a known root as determined by driver verification, or the root certificate must be included.</span></span>

 

<span data-ttu-id="5aa23-133">Durante o processo de inicialização, esta seção de recurso será extraída do driver ELAM para validar as informações do certificado e registrar o serviço antimalware.</span><span class="sxs-lookup"><span data-stu-id="5aa23-133">During the boot process, this resource section will be extracted from the ELAM driver to validate the certificate information and register the anti-malware service.</span></span> <span data-ttu-id="5aa23-134">O serviço Antimalware também pode ser registrado durante o processo de instalação do software antimalware chamando uma API especial, conforme descrito posteriormente neste documento.</span><span class="sxs-lookup"><span data-stu-id="5aa23-134">The anti-malware service can also be registered during the anti-malware software installation process by calling a special API, as described later in this document.</span></span>

<span data-ttu-id="5aa23-135">Depois que a seção de recursos for extraída com êxito do driver ELAM e o serviço de modo de usuário estiver registrado, o serviço poderá ser iniciado como um serviço protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-135">After the resource section is successfully extracted from the ELAM driver and the user-mode service is registered, the service is allowed to launch as protected service.</span></span> <span data-ttu-id="5aa23-136">Depois que o serviço for iniciado como protegido, outros processos não protegidos no sistema não poderão injetar threads e eles não poderão gravar na memória virtual do processo protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-136">After the service is launched as protected, other non-protected processes on the system won't be able to inject threads, and they wont' be allowed to write into the virtual memory of the protected process.</span></span>

<span data-ttu-id="5aa23-137">Além disso, todas as DLLs não Windows que são carregadas no processo protegido devem ser assinadas com um certificado apropriado.</span><span class="sxs-lookup"><span data-stu-id="5aa23-137">In addition, any non-Windows DLLs that get loaded into the protected process must be signed with an appropriate certificate.</span></span>

<span data-ttu-id="5aa23-138">Consulte [antimalware de início antecipado](/windows/desktop/w8cookbook/secured-boot) para obter mais informações sobre drivers Elam.</span><span class="sxs-lookup"><span data-stu-id="5aa23-138">See [Early launch antimalware](/windows/desktop/w8cookbook/secured-boot) for more information on ELAM drivers.</span></span>

### <a name="anti-malware-service-signing-requirements"></a><span data-ttu-id="5aa23-139">Requisitos de assinatura de serviço anti-malware</span><span class="sxs-lookup"><span data-stu-id="5aa23-139">Anti-malware service signing requirements</span></span>

<span data-ttu-id="5aa23-140">O serviço de modo de usuário que precisa ser iniciado como protegido deve ser assinado com certificados válidos.</span><span class="sxs-lookup"><span data-stu-id="5aa23-140">The user-mode service that needs to be launched as protected must be signed with valid certificates.</span></span> <span data-ttu-id="5aa23-141">O serviço EXE deve ser assinado por hash de página e todas as DLLs não Windows que são carregadas no serviço também devem ser assinadas com os mesmos certificados.</span><span class="sxs-lookup"><span data-stu-id="5aa23-141">The service EXE must be page hash signed, and any non-Windows DLLs that get loaded into the service must be also signed with the same certificates.</span></span> <span data-ttu-id="5aa23-142">O hash desses certificados deve ser adicionado ao arquivo de recurso, que será vinculado ao driver ELAM.</span><span class="sxs-lookup"><span data-stu-id="5aa23-142">The hash of these certificates must be added into the resource file, which will be linked into the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="5aa23-143">Os hashes de arquivo/página SHA256 devem ser usados, embora os certificados possam continuar a ser SHA1.</span><span class="sxs-lookup"><span data-stu-id="5aa23-143">SHA256 file/page hashes must be used, though certificates may continue to be SHA1.</span></span>

 

### <a name="primary-signature-recommended"></a><span data-ttu-id="5aa23-144">Assinatura principal (recomendada)</span><span class="sxs-lookup"><span data-stu-id="5aa23-144">Primary signature (recommended)</span></span>

<span data-ttu-id="5aa23-145">Recomendamos que os fornecedores Antimalware usem seu certificado Authenticode existente para assinar seus binários de serviço anti-malware e que o hash desse certificado Authenticode seja incluído na seção de recursos para indicar o certificado usado para assinar os binários de serviço.</span><span class="sxs-lookup"><span data-stu-id="5aa23-145">We recommend that anti-malware vendors use their existing Authenticode certificate to sign their anti-malware service binaries, and that the hash of this Authenticode certificate be included in the resource section to indicate the certificate that's used to sign the service binaries.</span></span> <span data-ttu-id="5aa23-146">Se você atualizar esse certificado, uma versão mais recente do driver ELAM deverá ser lançada com os hashes de certificado atualizados.</span><span class="sxs-lookup"><span data-stu-id="5aa23-146">If you update this certificate, a newer version of the ELAM driver must be released with the updated certificate hashes.</span></span>

### <a name="secondary-signature-optional"></a><span data-ttu-id="5aa23-147">Assinatura secundária (opcional)</span><span class="sxs-lookup"><span data-stu-id="5aa23-147">Secondary signature (optional)</span></span>

<span data-ttu-id="5aa23-148">Os fornecedores Antimalware têm a opção de configurar uma AC privada e usar certificados dessa autoridade de certificação para assinar códigos binários de serviço anti-malware como uma assinatura secundária.</span><span class="sxs-lookup"><span data-stu-id="5aa23-148">Anti-malware vendors have the option to set up a private CA and use certificates from this CA to code sign the anti-malware service binaries as a secondary signature.</span></span> <span data-ttu-id="5aa23-149">A principal vantagem de usar a autoridade de certificação privada é que ela permite que os fornecedores criem certificados com uma propriedade EKU especializada, que pode ser usada para diferenciar entre vários produtos do mesmo fornecedor.</span><span class="sxs-lookup"><span data-stu-id="5aa23-149">The main advantage of using the private CA is that it enables vendors to create certificates with a specialized EKU property, which can be used to differentiate between multiple products from the same vendor.</span></span> <span data-ttu-id="5aa23-150">Ele também reduz a necessidade de atualizar o driver ELAM devido à expiração do certificado, pois os certificados da autoridade de certificação privada normalmente têm datas de expiração mais longas.</span><span class="sxs-lookup"><span data-stu-id="5aa23-150">It also reduces the need to update your ELAM driver due to certificate expiry, as the private CA certs typically have longer expiry dates.</span></span>

<span data-ttu-id="5aa23-151">Observe que, se os binários de serviço forem assinados com os certificados de autoridade de certificação privada, os binários também deverão ser assinados duplos com o certificado Authenticode existente.</span><span class="sxs-lookup"><span data-stu-id="5aa23-151">Note that if the service binaries are signed with the private CA certs, the binaries must also be dual signed with the existing Authenticode certificates.</span></span> <span data-ttu-id="5aa23-152">Se os binários não forem assinados por uma autoridade de certificação confiável conhecida (por exemplo, VeriSign), o usuário do computador não terá confiança nos binários porque eles não podem confiar na autoridade de certificação privada.</span><span class="sxs-lookup"><span data-stu-id="5aa23-152">If the binaries are not signed by a well-known trusted CA (for example VeriSign), the user of the machine has no confidence in the binaries because they cannot trust the private CA.</span></span> <span data-ttu-id="5aa23-153">A assinatura dupla dos binários com o certificado Authenticode existente também permite que os binários sejam executados em sistemas operacionais de nível inferior.</span><span class="sxs-lookup"><span data-stu-id="5aa23-153">Dual signing the binaries with the existing Authenticode certificate also allows the binaries to run on down-level operating systems.</span></span>

<span data-ttu-id="5aa23-154">Para obter mais informações sobre como configurar e instalar a autoridade de certificação, consulte [Configurando uma autoridade](/previous-versions/windows/desktop/ms755466(v=vs.85)) de certificação e [instalar a autoridade](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11)).</span><span class="sxs-lookup"><span data-stu-id="5aa23-154">For more info about how to set up and install the Certificate Authority, see [Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85)) and [Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11)).</span></span>

> [!Note]  
> <span data-ttu-id="5aa23-155">Para compatibilidade com o Windows Vista ou o Windows XP (ou o Windows 7 sem o patch SHA2), você pode usar a opção "/as" ao assinar seus binários com [SignTool.exe](/windows/desktop/SecCrypto/signtool) com os hashes de arquivo/página SHA256.</span><span class="sxs-lookup"><span data-stu-id="5aa23-155">For compatibility with Windows Vista or Windows XP (or Windows 7 without the SHA2 patch), you can use the "/as" switch when signing your binaries with [SignTool.exe](/windows/desktop/SecCrypto/signtool) with the SHA256 file/page hashes.</span></span> <span data-ttu-id="5aa23-156">Isso adicionará a assinatura como uma assinatura secundária ao arquivo.</span><span class="sxs-lookup"><span data-stu-id="5aa23-156">This will add the signature as a secondary signature to the file.</span></span> <span data-ttu-id="5aa23-157">O SHA1 assinar o arquivo primeiro, pois o Windows XP, o Windows Vista e o Windows 7 verão apenas a primeira assinatura.</span><span class="sxs-lookup"><span data-stu-id="5aa23-157">SHA1 sign the file first, since Windows XP, Windows Vista, and Windows 7 will only see the first signature.</span></span>

 

### <a name="dll-signing-requirements"></a><span data-ttu-id="5aa23-158">Requisitos de assinatura de DLL</span><span class="sxs-lookup"><span data-stu-id="5aa23-158">DLL signing requirements</span></span>

<span data-ttu-id="5aa23-159">Como mencionado anteriormente, todas as DLLs não Windows que são carregadas no serviço protegido devem ser assinadas com o mesmo certificado usado para assinar o serviço antimalware.</span><span class="sxs-lookup"><span data-stu-id="5aa23-159">As mentioned earlier, any non-Windows DLLs that get loaded into the protected service must be signed with the same certificate that was used to sign the anti-malware service.</span></span>

### <a name="catalog-signing"></a><span data-ttu-id="5aa23-160">Assinatura de catálogo</span><span class="sxs-lookup"><span data-stu-id="5aa23-160">Catalog Signing</span></span>

<span data-ttu-id="5aa23-161">Os fornecedores de anti-malware podem incluir pacotes desenvolvidos por outras empresas sem Atualizar as assinaturas binárias.</span><span class="sxs-lookup"><span data-stu-id="5aa23-161">Anti-malware vendors can include packages developed by other companies without updating the binary signatures.</span></span> <span data-ttu-id="5aa23-162">Isso pode ser obtido com a inclusão de binários em um catálogo que é assinado com seu certificado Authenticode, realizado seguindo estas etapas:</span><span class="sxs-lookup"><span data-stu-id="5aa23-162">This can be achieved by including the binaries in a catalog which is signed with their Authenticode certificate, accomplished by following these steps:</span></span>

1. <span data-ttu-id="5aa23-163">Gerar um catálogo usando [MakeCat](/windows/desktop/SecCrypto/makecat)</span><span class="sxs-lookup"><span data-stu-id="5aa23-163">Generate a catalog using [MakeCat](/windows/desktop/SecCrypto/makecat)</span></span>
2. <span data-ttu-id="5aa23-164">Adicionar todos os binários sem uma assinatura apropriada ao catálogo</span><span class="sxs-lookup"><span data-stu-id="5aa23-164">Add all of the binaries without an appropriate signature to the catalog</span></span>
3. <span data-ttu-id="5aa23-165">Assinar o catálogo com o certificado Authenticode, como você faria com qualquer outro binário</span><span class="sxs-lookup"><span data-stu-id="5aa23-165">Sign the catalog with the Authenticode certificate, as you would any other binary</span></span>
4. <span data-ttu-id="5aa23-166">Use a função [Adicionar Catálogo](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) para incluir o catálogo com o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5aa23-166">Use the [add catalog](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) function to include the catalog with the application.</span></span>

<span data-ttu-id="5aa23-167">Quando a integridade de código entra nos pacotes sem uma assinatura apropriada, ela pesquisará um catálogo com uma assinatura aprovada.</span><span class="sxs-lookup"><span data-stu-id="5aa23-167">When code integrity comes across the packages without an appropriate signature, it will search for a catalog with an approved signature.</span></span> <span data-ttu-id="5aa23-168">Ele encontrará esse catálogo, contanto que essas etapas sejam seguidas e instaladas com o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5aa23-168">It will find this catalog as long as these steps are followed and it is installed with the application.</span></span>


## <a name="resource-file-info"></a><span data-ttu-id="5aa23-169">Informações do arquivo de recurso</span><span class="sxs-lookup"><span data-stu-id="5aa23-169">Resource file info</span></span>

<span data-ttu-id="5aa23-170">Um arquivo de recurso deve ser criado e vinculado ao driver ELAM.</span><span class="sxs-lookup"><span data-stu-id="5aa23-170">A resource file must be created and linked into the ELAM driver.</span></span> <span data-ttu-id="5aa23-171">O hash do certificado, juntamente com outras informações de certificado, deve ser adicionado no arquivo de recurso.</span><span class="sxs-lookup"><span data-stu-id="5aa23-171">The hash of the certificate, along with other certificate information, must be added in the resource file.</span></span>

<span data-ttu-id="5aa23-172">A seção de recursos deve estar no layout a seguir para o sistema para extrair com êxito os recursos da imagem binária e validar as informações do certificado inserido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-172">The resource section must be in the following layout for the system to successfully extract the resources from the binary image and validate the embedded certificate information.</span></span>

``` syntax
MicrosoftElamCertificateInfo  MSElamCertInfoID
{
      3, // count of entries
      L”CertHash1\0”,
      Algorithm,
      L”EKU1\0”,
      L”CertHash2\0”,
      Algorithm,
      L”\0”, //No EKU for cert hash 2
      L”CertHash3\0”,
      Algorithm,
      L”EKU3a;EKU3b;EKU3c\0”,  //multiple EKU entries supported (max: 3)
}
```

<span data-ttu-id="5aa23-173">Para obter mais informações sobre o arquivo de recursos definido pelo usuário, consulte [recurso definido pelo usuário](/windows/desktop/menurc/user-defined-resource).</span><span class="sxs-lookup"><span data-stu-id="5aa23-173">For more info about user-defined resource file, see [User-Defined Resource](/windows/desktop/menurc/user-defined-resource).</span></span>

### <a name="certhash"></a><span data-ttu-id="5aa23-174">CertHash</span><span class="sxs-lookup"><span data-stu-id="5aa23-174">CertHash</span></span>

<span data-ttu-id="5aa23-175">O hash do certificado que é usado para assinar o serviço anti-malware.</span><span class="sxs-lookup"><span data-stu-id="5aa23-175">The hash of the certificate that's used to sign the anti-malware service.</span></span> <span data-ttu-id="5aa23-176">A ferramenta de CertMgr.exe, que é fornecida na SDK do Windows, pode ser usada para obter o hash.</span><span class="sxs-lookup"><span data-stu-id="5aa23-176">The CertMgr.exe tool, which ships in the Windows SDK, can be used to obtain the hash.</span></span>

``` syntax
certmgr.exe –v <path to the signed file>
```

<span data-ttu-id="5aa23-177">Por exemplo:</span><span class="sxs-lookup"><span data-stu-id="5aa23-177">For example:</span></span>

![hash de certificado de serviço protegido por anti-malware (certhash)](images/cert-hash-example.png)

### <a name="algorithm"></a><span data-ttu-id="5aa23-179">Algoritmo</span><span class="sxs-lookup"><span data-stu-id="5aa23-179">Algorithm</span></span>

<span data-ttu-id="5aa23-180">O valor do algoritmo representa o algoritmo do certificado.</span><span class="sxs-lookup"><span data-stu-id="5aa23-180">The algorithm value represents the algorithm of the certificate.</span></span> <span data-ttu-id="5aa23-181">Esses valores de algoritmo têm suporte:</span><span class="sxs-lookup"><span data-stu-id="5aa23-181">These algorithm values are supported:</span></span>

<dl> <span data-ttu-id="5aa23-182">0x8004 – SHA1</span><span class="sxs-lookup"><span data-stu-id="5aa23-182">0x8004 – SHA1</span></span>  
<span data-ttu-id="5aa23-183">0x800C – SHA256</span><span class="sxs-lookup"><span data-stu-id="5aa23-183">0x800c – SHA256</span></span>  
<span data-ttu-id="5aa23-184">0X800d – SHA384</span><span class="sxs-lookup"><span data-stu-id="5aa23-184">0X800d – SHA384</span></span>  
<span data-ttu-id="5aa23-185">0x800e – SHA512</span><span class="sxs-lookup"><span data-stu-id="5aa23-185">0x800e – SHA512</span></span>  
</dl>

<span data-ttu-id="5aa23-186">Lembre-se de incluir o valor do algoritmo (como mostrado acima) e não o nome real do algoritmo.</span><span class="sxs-lookup"><span data-stu-id="5aa23-186">Remember to include the value of the algorithm (as shown above) and not the actual name of the algorithm.</span></span> <span data-ttu-id="5aa23-187">Por exemplo, se o certificado for baseado no algoritmo SHA256, inclua 0x800C na seção de recursos.</span><span class="sxs-lookup"><span data-stu-id="5aa23-187">For example, if the cert is based on the SHA256 algorithm, include 0x800c in the resource section.</span></span>

### <a name="eku"></a><span data-ttu-id="5aa23-188">EKU</span><span class="sxs-lookup"><span data-stu-id="5aa23-188">EKU</span></span>

<span data-ttu-id="5aa23-189">O objeto EKU representa uma única propriedade EKU (uso estendido de chave) de um certificado.</span><span class="sxs-lookup"><span data-stu-id="5aa23-189">The EKU object represents a single extended key usage (EKU) property of a certificate.</span></span> <span data-ttu-id="5aa23-190">Isso é opcional e " \\ 0" deve ser especificado se nenhum EKUs estiver associado ao certificado. Em um caso em que há vários produtos e serviços de um único fornecedor de antimalware em execução no mesmo sistema, o fornecedor de anti-malware pode usar a propriedade EKU do certificado de autoridade de certificação privada para diferenciar um serviço de outro.</span><span class="sxs-lookup"><span data-stu-id="5aa23-190">This is optional and “\\0” should be specified if no EKUs are associated with the cert. In a case where there are multiple products and services from a single anti-malware vendor running on the same system, the anti-malware vendor can use the EKU property of the private CA certificate to differentiate one service from another.</span></span> <span data-ttu-id="5aa23-191">Por exemplo, se houver dois serviços em execução no sistema do mesmo fornecedor antimalware e assinados pela mesma AC, o serviço que precisa ser iniciado como protegido pode ser assinado com um certificado emitido pela AC que contém um EKU especial.</span><span class="sxs-lookup"><span data-stu-id="5aa23-191">For example, if there are two services running on the system from the same anti-malware vendor and signed by the same CA, the service that needs to be launched as protected can be signed with a cert issued by CA that contains a special EKU.</span></span> <span data-ttu-id="5aa23-192">Esse EKU deve ser adicionado à seção de recursos.</span><span class="sxs-lookup"><span data-stu-id="5aa23-192">This EKU must be added to the resource section.</span></span> <span data-ttu-id="5aa23-193">O EKU é então registrado pelo sistema e emparelhado com o hash de certificado para validar e iniciar o serviço como protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-193">The EKU is then registered by the system and paired with the certificate hash for validating and launching the service as protected.</span></span>

<span data-ttu-id="5aa23-194">Observe que a cadeia de certificados deve incluir o 1.3.6.1.5.5.7.3.3 (EKU de assinatura de código), mas esse EKU não deve ser incluído na seção de recursos do driver ELAM.</span><span class="sxs-lookup"><span data-stu-id="5aa23-194">Note that the certificate chain must include the Code Signing EKU (1.3.6.1.5.5.7.3.3), but this EKU must not be included in the resource section of the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="5aa23-195">Se as informações EKU estiverem incluídas nas informações de certificado para o driver ELAM, o mesmo EKU deverá ser usado ao assinar seus binários.</span><span class="sxs-lookup"><span data-stu-id="5aa23-195">If EKU information is included in certificate information for the ELAM driver, then the same EKU must be used when signing your binaries.</span></span>

 

### <a name="count"></a><span data-ttu-id="5aa23-196">Contagem</span><span class="sxs-lookup"><span data-stu-id="5aa23-196">Count</span></span>

<span data-ttu-id="5aa23-197">Se o binário do serviço anti-malware for assinado com o certificado Authenticode, bem como o certificado de autoridade de certificação privada, somente as informações de certificado da autoridade de certificação privada deverão ser adicionadas na seção recurso.</span><span class="sxs-lookup"><span data-stu-id="5aa23-197">If the anti-malware service binary is signed with the Authenticode certificate as well as the private CA certificate, only the private CA certificate information must be added in the resource section.</span></span>

## <a name="launching-anti-malware-services-as-protected"></a><span data-ttu-id="5aa23-198">Iniciando serviços Antimalware como protegidos</span><span class="sxs-lookup"><span data-stu-id="5aa23-198">Launching anti-malware services as protected</span></span>

### <a name="registering-the-service"></a><span data-ttu-id="5aa23-199">Registrando o serviço</span><span class="sxs-lookup"><span data-stu-id="5aa23-199">Registering the service</span></span>

<span data-ttu-id="5aa23-200">O serviço anti-malware deve ser registrado no sistema antes que possa ser iniciado como protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-200">The anti-malware service must be registered with the system before it can be started as protected.</span></span> <span data-ttu-id="5aa23-201">Durante a instalação do software antimalware, o instalador pode instalar o driver ELAM e reinicializar o sistema para registrar o serviço automaticamente.</span><span class="sxs-lookup"><span data-stu-id="5aa23-201">During the installation of the anti-malware software, the installer can install the ELAM driver and reboot the system to automatically register the service.</span></span> <span data-ttu-id="5aa23-202">O sistema registrará o serviço no momento da inicialização, extraindo as informações do certificado do arquivo de recursos mencionado anteriormente que está vinculado ao driver ELAM.</span><span class="sxs-lookup"><span data-stu-id="5aa23-202">The system will register the service at boot time by extracting the certificate information from the aforementioned resource file that is linked into the ELAM driver.</span></span>

<span data-ttu-id="5aa23-203">Durante a fase de instalação, é altamente recomendável que o sistema seja reiniciado para que o driver ELAM seja carregado e valide o estado do sistema.</span><span class="sxs-lookup"><span data-stu-id="5aa23-203">During the installation phase, it is highly recommended that the system is restarted in order for the ELAM driver to get loaded and validate the state of the system.</span></span> <span data-ttu-id="5aa23-204">No entanto, para casos em que uma reinicialização deve ser evitada, o Windows também expõe um mecanismo para o instalador anti-malware registrar o serviço como protegido usando uma API.</span><span class="sxs-lookup"><span data-stu-id="5aa23-204">However, for cases where a reboot must be avoided, Windows also exposes a mechanism for the anti-malware installer to register the service as protected using an API.</span></span>

### <a name="registering-the-service-without-rebooting-the-system"></a><span data-ttu-id="5aa23-205">Registrando o serviço sem reinicializar o sistema</span><span class="sxs-lookup"><span data-stu-id="5aa23-205">Registering the service without rebooting the system</span></span>

<span data-ttu-id="5aa23-206">Durante a instalação, um instalador de software antimalware pode chamar a API [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) e fornecer um identificador para o arquivo de driver Elam.</span><span class="sxs-lookup"><span data-stu-id="5aa23-206">During the installation, an anti-malware software installer can call the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API and provide a handle to the ELAM driver file.</span></span> <span data-ttu-id="5aa23-207">O sistema abre o driver ELAM, chama rotinas internas para verificar se o driver ELAM está assinado corretamente e extrai as informações do certificado da seção de recursos associada ao driver ELAM.</span><span class="sxs-lookup"><span data-stu-id="5aa23-207">The system opens the ELAM driver, calls internal routines to make sure the ELAM driver is signed properly, and extracts the certificate information from the resource section associated with the ELAM driver.</span></span> <span data-ttu-id="5aa23-208">Para obter a sintaxe de função, consulte [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span><span class="sxs-lookup"><span data-stu-id="5aa23-208">For function syntax see [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span></span>

<span data-ttu-id="5aa23-209">Exemplo de código:</span><span class="sxs-lookup"><span data-stu-id="5aa23-209">Code example:</span></span>


```C++
HANDLE FileHandle = NULL;

FileHandle = CreateFile(<Insert Elam driver file name>,
                        FILE_READ_DATA,
                        FILE_SHARE_READ,
                        NULL,
                        OPEN_EXISTING,
                        FILE_ATTRIBUTE_NORMAL,
                        NULL
                        );

if (InstallElamCertificateInfo(FileHandle) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



### <a name="starting-the-service-as-protected"></a><span data-ttu-id="5aa23-210">Iniciando o serviço como protegido</span><span class="sxs-lookup"><span data-stu-id="5aa23-210">Starting the service as protected</span></span>

<span data-ttu-id="5aa23-211">O instalador pode seguir estas etapas para criar, configurar e iniciar o serviço como protegido:</span><span class="sxs-lookup"><span data-stu-id="5aa23-211">The installer can follow these steps to create, configure, and start the service as protected:</span></span>

1.  <span data-ttu-id="5aa23-212">Chame a API [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) para criar um objeto de serviço e adicioná-lo ao banco de dados SCM (Gerenciador de controle de serviço).</span><span class="sxs-lookup"><span data-stu-id="5aa23-212">Call the [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) API to create a service object and add it to the service control manager (SCM) database.</span></span>
2.  <span data-ttu-id="5aa23-213">Chame a API [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) para definir o descritor de segurança do objeto de serviço criado na etapa 1.</span><span class="sxs-lookup"><span data-stu-id="5aa23-213">Call the [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) API to set the security descriptor of the service object created in step 1.</span></span>
3.  <span data-ttu-id="5aa23-214">Chame a API [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) para marcar o serviço como protegido, especificando o novo valor de enumeração protegida de inicialização de configuração de **serviço \_ \_ \_** , que foi adicionado em Winsvc. h (a partir de Windows 8.1).</span><span class="sxs-lookup"><span data-stu-id="5aa23-214">Call the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API to mark the service as protected, specifying the new **SERVICE\_CONFIG\_LAUNCH\_PROTECTED** enumeration value, which has been added in Winsvc.h (as of Windows 8.1).</span></span>

    <span data-ttu-id="5aa23-215">Exemplo de código:</span><span class="sxs-lookup"><span data-stu-id="5aa23-215">Code example:</span></span>

    ```C++
    SERVICE_LAUNCH_PROTECTED_INFO Info;
    SC_HANDLE hService;

    Info.dwLaunchProtected = SERVICE_LAUNCH_PROTECTED_ANTIMALWARE_LIGHT;

    hService = CreateService (/* ... */);

    if (ChangeServiceConfig2(hService,
                             SERVICE_CONFIG_LAUNCH_PROTECTED,
                             &Info) == FALSE)
    {
        Result = GetLastError();
    }
    ```

    

4.  <span data-ttu-id="5aa23-216">Chame a API [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) para iniciar o serviço.</span><span class="sxs-lookup"><span data-stu-id="5aa23-216">Call the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) API to start the service.</span></span> <span data-ttu-id="5aa23-217">Ao iniciar o serviço como protegido, o SCM verifica o subsistema de integridade de código (CI) para validar as informações do certificado.</span><span class="sxs-lookup"><span data-stu-id="5aa23-217">When starting the service as protected, SCM checks with Code Integrity (CI) subsystem to validate the certificate information.</span></span> <span data-ttu-id="5aa23-218">Depois que as informações do certificado forem validadas pelo CI, o SCM iniciará o serviço como protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-218">After the certificate information is validated by CI, SCM launches the service as protected.</span></span>
    1.  <span data-ttu-id="5aa23-219">Observe que essa etapa falhará se você não tiver registrado o serviço chamando a API [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) .</span><span class="sxs-lookup"><span data-stu-id="5aa23-219">Note that this step fails if you haven’t registered the service by calling the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API.</span></span>
    2.  <span data-ttu-id="5aa23-220">Se o serviço tiver sido configurado para iniciar automaticamente durante a fase de inicialização do sistema, você poderá evitar essa etapa e simplesmente reinicializar o sistema.</span><span class="sxs-lookup"><span data-stu-id="5aa23-220">If the service has been configured to start automatically during the system startup phase, you can avoid this step and simply reboot the system.</span></span> <span data-ttu-id="5aa23-221">Durante uma reinicialização, o sistema registrará automaticamente o serviço (se o driver ELAM for iniciado com êxito) e iniciará o serviço no modo protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-221">During a reboot, the system automatically registers the service (if the ELAM driver starts successfully) and starts the service in protected mode.</span></span>

### <a name="launching-a-child-process-as-protected"></a><span data-ttu-id="5aa23-222">Iniciando um processo filho como protegido</span><span class="sxs-lookup"><span data-stu-id="5aa23-222">Launching a child process as protected</span></span>

<span data-ttu-id="5aa23-223">O novo modelo de segurança também permite que os serviços protegidos por anti-malware iniciem processos filhos como protegidos.</span><span class="sxs-lookup"><span data-stu-id="5aa23-223">The new security model also allows the anti-malware protected services to launch child processes as protected.</span></span> <span data-ttu-id="5aa23-224">Esses processos filho serão executados no mesmo nível de proteção que o serviço pai e seus binários devem ser assinados com o mesmo certificado registrado por meio da seção de recursos ELAM.</span><span class="sxs-lookup"><span data-stu-id="5aa23-224">These child processes will run at the same protection level as the parent service and their binaries must be signed with the same certificate that has been registered via ELAM resource section.</span></span>

<span data-ttu-id="5aa23-225">Para permitir que o serviço protegido por anti-malware inicie o processo filho como protegido, uma nova chave de atributo estendida **, \_ \_ nível de \_ proteção \_ de atributo de thread proc**, foi exposta e deve ser usada com a API [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) .</span><span class="sxs-lookup"><span data-stu-id="5aa23-225">In order to allow anti-malware protected service to launch child process as protected, a new extended attribute key, **PROC\_THREAD\_ATTRIBUTE\_PROTECTION\_LEVEL**, has been exposed and must be used with the [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) API.</span></span> <span data-ttu-id="5aa23-226">Um ponteiro para o valor de atributo **do \_ nível \_ de proteção igual** deve ser passado para a API **UpdateProcThreadAttribute** .</span><span class="sxs-lookup"><span data-stu-id="5aa23-226">A pointer to the attribute value of **PROTECTION\_LEVEL\_SAME** must be passed into the **UpdateProcThreadAttribute** API.</span></span>

<span data-ttu-id="5aa23-227">Observações:</span><span class="sxs-lookup"><span data-stu-id="5aa23-227">Notes:</span></span>

-   <span data-ttu-id="5aa23-228">Para usar esse novo atributo, o serviço também deve especificar **criar \_ \_ processo protegido** no parâmetro de sinalizadores de criação de processo da chamada [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) .</span><span class="sxs-lookup"><span data-stu-id="5aa23-228">In order to use this new attribute, the service must also specify **CREATE\_PROTECTED\_PROCESS** in the process creation flags parameter of the [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) call.</span></span>
-   <span data-ttu-id="5aa23-229">Você precisa ter seus binários de serviço assinados usando a opção/AC para incluir o certificado cruzado para enchainá-lo para uma autoridade de certificação conhecida.</span><span class="sxs-lookup"><span data-stu-id="5aa23-229">You need to have your service binaries signed using the /ac switch to include the cross-certificate to chain it up to a known CA.</span></span> <span data-ttu-id="5aa23-230">O certificado autoassinado sem o encadeamento adequado para uma autoridade de certificação raiz conhecida não funcionará.</span><span class="sxs-lookup"><span data-stu-id="5aa23-230">Self-signed cert without proper chaining to a known root CA will not work.</span></span>

<span data-ttu-id="5aa23-231">Exemplo de código:</span><span class="sxs-lookup"><span data-stu-id="5aa23-231">Code example:</span></span>


```C++
DWORD ProtectionLevel = PROTECTION_LEVEL_SAME;
SIZE_T AttributeListSize;

STARTUPINFOEXW StartupInfoEx = { 0 };

StartupInfoEx.StartupInfo.cb = sizeof(StartupInfoEx);

if (InitializeProcThreadAttributeList(NULL,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

StartupInfoEx.lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST) HeapAlloc(
    GetProcessHeap(),
    0,
    AttributeListSize
    );

if (InitializeProcThreadAttributeList(StartupInfoEx.lpAttributeList,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

if (UpdateProcThreadAttribute(StartupInfoEx.lpAttributeList,
                              0,
                              PROC_THREAD_ATTRIBUTE_PROTECTION_LEVEL,
                              &ProtectionLevel,
                              sizeof(ProtectionLevel),
                              NULL,
                              NULL) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

PROCESS_INFORMATION ProcessInformation = { 0 };

if (CreateProcessW(ApplicationName,
                   CommandLine,
                   ProcessAttributes,
                   ThreadAttributes,
                   InheritHandles,
                   EXTENDED_STARTUPINFO_PRESENT | CREATE_PROTECTED_PROCESS,
                   Environment,
                   CurrentDirectory,
                   (LPSTARTUPINFOW)&StartupInfoEx,
                   &ProcessInformation) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



## <a name="updates-and-servicing"></a><span data-ttu-id="5aa23-232">Atualizações e serviços</span><span class="sxs-lookup"><span data-stu-id="5aa23-232">Updates and servicing</span></span>

<span data-ttu-id="5aa23-233">Depois que o serviço Antimalware for iniciado como protegido, outros processos não protegidos (e até mesmo administradores) não poderão interromper o serviço.</span><span class="sxs-lookup"><span data-stu-id="5aa23-233">After the anti-malware service is launched as protected, other non-protected processes (and even admins) aren't able to stop the service.</span></span> <span data-ttu-id="5aa23-234">No caso de atualizações para os binários de serviço, o serviço Antimalware precisa receber um retorno de chamada do instalador para parar a si mesmo para que possa ser atendido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-234">In the case of updates to the service binaries, the anti-malware service needs to receive a callback from the installer to stop itself so that it can be serviced.</span></span> <span data-ttu-id="5aa23-235">Depois que o serviço for interrompido, o instalador Antimalware poderá executar atualizações e, em seguida, seguir as etapas descritas acima no [registro do](https://www.bing.com/search?q=Registering+the+service) serviço e no [início do serviço como seções protegidas](#starting-the-service-as-protected) para registrar o certificado e iniciar o serviço como protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-235">After the service is stopped, the anti-malware installer can perform upgrades and then follow the steps described above in the [Registering the service](https://www.bing.com/search?q=Registering+the+service) and [Starting the service as protected](#starting-the-service-as-protected) sections to register the certificate and start the service as protected.</span></span>

<span data-ttu-id="5aa23-236">Observe que o serviço deve garantir que somente chamadores confiáveis possam parar o serviço.</span><span class="sxs-lookup"><span data-stu-id="5aa23-236">Note that the service should ensure that only trusted callers can stop the service.</span></span> <span data-ttu-id="5aa23-237">Permitir que chamadores não confiáveis façam isso anula a finalidade de proteger o serviço.</span><span class="sxs-lookup"><span data-stu-id="5aa23-237">Allowing untrusted callers to do so defeats the purpose of protecting the service.</span></span>

### <a name="unregistering-the-service"></a><span data-ttu-id="5aa23-238">Cancelando o registro do serviço</span><span class="sxs-lookup"><span data-stu-id="5aa23-238">Unregistering the service</span></span>

<span data-ttu-id="5aa23-239">Quando você desinstala um serviço protegido, o serviço deve se marcar como desprotegido chamando a API [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) .</span><span class="sxs-lookup"><span data-stu-id="5aa23-239">When you uninstall a protected service, the service must mark itself as unprotected by calling the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API.</span></span> <span data-ttu-id="5aa23-240">Observe que, como o sistema não permite que nenhum processo não protegido altere a configuração de um serviço protegido, a chamada para [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) deve ser feita pelo próprio serviço protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-240">Note that because the system doesn't allow any non-protected process to alter the configuration of a protected service, the call to [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) must be made by the protected service itself.</span></span> <span data-ttu-id="5aa23-241">Depois que o serviço foi reconfigurado para ser executado como desprotegido, o desinstalador pode simplesmente tomar as medidas apropriadas para remover o software antimalware do sistema.</span><span class="sxs-lookup"><span data-stu-id="5aa23-241">After the service has been reconfigured to run as unprotected, the uninstaller can simply take appropriate steps to remove the anti-malware software from the system.</span></span>

## <a name="debugging-an-anti-malware-protected-service"></a><span data-ttu-id="5aa23-242">Depurando um serviço protegido por anti-malware</span><span class="sxs-lookup"><span data-stu-id="5aa23-242">Debugging an anti-malware protected service</span></span>

<span data-ttu-id="5aa23-243">Como parte do modelo de segurança do processo protegido, outros processos não protegidos não são capazes de injetar threads ou gravar na memória virtual do processo protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-243">As part of the protected process security model, other non-protected processes aren't able to inject threads or write into the virtual memory of the protected process.</span></span> <span data-ttu-id="5aa23-244">No entanto, um KD (depurador de kernel) é permitido para depuração de qualquer processo protegido por anti-malware.</span><span class="sxs-lookup"><span data-stu-id="5aa23-244">However a kernel debugger (KD) is allowed for debugging any anti-malware protected processes.</span></span> <span data-ttu-id="5aa23-245">O KD também pode ser usado para verificar se o serviço Antimalware está sendo executado como protegido ou não:</span><span class="sxs-lookup"><span data-stu-id="5aa23-245">The KD can also be used to check if the anti-malware service is running as protected or not:</span></span>

``` syntax
dt –r1 nt!_EPROCESS <Process Address>
+0x67a Protection       : _PS_PROTECTION
      +0x000 Level            : 0x31 '1'
      +0x000 Type             : 0y0001
      +0x000 Signer           : 0y0011
```

<span data-ttu-id="5aa23-246">Se o valor do membro do *tipo* for 0y0001, o serviço será executado como protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-246">If the value of the *Type* member is 0y0001, the service is running as protected.</span></span>

<span data-ttu-id="5aa23-247">Além disso, somente os comandos SC a seguir são permitidos no serviço protegido por anti-malware:</span><span class="sxs-lookup"><span data-stu-id="5aa23-247">In addition, only the following SC commands are allowed on anti-malware protected service:</span></span>

-   `sc config start=Auto`
-   `sc qc`
-   `sc start`
-   `sc interrogate`
-   `sc sdshow`

<span data-ttu-id="5aa23-248">Se o depurador estiver anexado, use o seguinte sinalizador no registro para interromper o depurador quando os binários não assinados (ou assinados de forma inadequada) forem carregados no serviço protegido antimalware.</span><span class="sxs-lookup"><span data-stu-id="5aa23-248">If the debugger is attached, use the following flag in the registry to break in the debugger when unsigned (or inappropriately signed) binaries are loaded into the anti-malware protected service.</span></span>

``` syntax
Key:   HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CI
Value: DebugFlags      REG_DWORD
```

<span data-ttu-id="5aa23-249">Defina o valor como **00000400** para interromper no depurador quando a validação da assinatura falhar.</span><span class="sxs-lookup"><span data-stu-id="5aa23-249">Set the value to **00000400** to break in the debugger when the signature validation fails.</span></span>

> [!Note]  
> <span data-ttu-id="5aa23-250">Limitações de processos protegidos:</span><span class="sxs-lookup"><span data-stu-id="5aa23-250">Protected Process limitations:</span></span>
>
> 1.  <span data-ttu-id="5aa23-251">Processos que têm interface do usuário ou uma GUI não podem ser protegidos devido à maneira como o kernel bloqueia um processo na memória e não permite gravações nele.</span><span class="sxs-lookup"><span data-stu-id="5aa23-251">Processes that have UI or a GUI cannot be protected because of the way the kernel locks a process in memory and does not allow writes to it.</span></span>
> 2.  <span data-ttu-id="5aa23-252">Antes do Windows 10, versão 1703 (a atualização para criadores), processos protegidos não podem usar os protocolos de comunicação TLS ou SSL devido a limitações de compartilhamento de certificado entre a LSA (autoridade de segurança local) e um processo protegido.</span><span class="sxs-lookup"><span data-stu-id="5aa23-252">Prior to Windows 10, version 1703 (the Creators update), protected processes cannot use the TLS or SSL communication protocols due to limitations of certificate sharing between the Local Security Authority (LSA) and a protected process.</span></span>

 

## <a name="resources"></a><span data-ttu-id="5aa23-253">Recursos</span><span class="sxs-lookup"><span data-stu-id="5aa23-253">Resources</span></span>

<span data-ttu-id="5aa23-254">Para saber mais, veja:</span><span class="sxs-lookup"><span data-stu-id="5aa23-254">For more info, see:</span></span>

-   [<span data-ttu-id="5aa23-255">Antimalware de início antecipado</span><span class="sxs-lookup"><span data-stu-id="5aa23-255">Early launch antimalware</span></span>](/windows/desktop/w8cookbook/secured-boot)
-   <span data-ttu-id="5aa23-256">[Processos protegidos no Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="5aa23-256">[Protected Processes in Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span></span>
-   <span data-ttu-id="5aa23-257">[Configurando uma autoridade de certificação](/previous-versions/windows/desktop/ms755466(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="5aa23-257">[Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85))</span></span>
-   <span data-ttu-id="5aa23-258">[Instalar a autoridade de certificação](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span><span class="sxs-lookup"><span data-stu-id="5aa23-258">[Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span></span>
-   [<span data-ttu-id="5aa23-259">Recurso definido pelo usuário</span><span class="sxs-lookup"><span data-stu-id="5aa23-259">User-Defined Resource</span></span>](/windows/desktop/menurc/user-defined-resource)

<span data-ttu-id="5aa23-260">Essas funções da API do Windows são referenciadas neste artigo:</span><span class="sxs-lookup"><span data-stu-id="5aa23-260">These Windows API functions are referenced in this article:</span></span>

-   [<span data-ttu-id="5aa23-261">**ChangeServiceConfig2**</span><span class="sxs-lookup"><span data-stu-id="5aa23-261">**ChangeServiceConfig2**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a)
-   [<span data-ttu-id="5aa23-262">**CreateProcess**</span><span class="sxs-lookup"><span data-stu-id="5aa23-262">**CreateProcess**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa)
-   [<span data-ttu-id="5aa23-263">**CreateService**</span><span class="sxs-lookup"><span data-stu-id="5aa23-263">**CreateService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-createservicea)
-   [<span data-ttu-id="5aa23-264">**InitializeProcThreadAttributeList**</span><span class="sxs-lookup"><span data-stu-id="5aa23-264">**InitializeProcThreadAttributeList**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-initializeprocthreadattributelist)
-   [<span data-ttu-id="5aa23-265">**InstallELAMCertificateInfo**</span><span class="sxs-lookup"><span data-stu-id="5aa23-265">**InstallELAMCertificateInfo**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo)
-   [<span data-ttu-id="5aa23-266">**SetServiceObjectSecurity**</span><span class="sxs-lookup"><span data-stu-id="5aa23-266">**SetServiceObjectSecurity**</span></span>](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity)
-   [<span data-ttu-id="5aa23-267">**StartService**</span><span class="sxs-lookup"><span data-stu-id="5aa23-267">**StartService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-startservicea)
-   [<span data-ttu-id="5aa23-268">**UpdateProcThreadAttribute**</span><span class="sxs-lookup"><span data-stu-id="5aa23-268">**UpdateProcThreadAttribute**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute)

 

 
