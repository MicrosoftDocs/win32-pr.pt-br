---
description: Quando um programa de controle de serviço solicita que um novo serviço seja executado, o SCM (Gerenciador de controle de serviço) inicia o serviço e envia uma solicitação de início para o Dispatcher de controle.
ms.assetid: e55e056f-7628-4e3d-9aea-b55c371b4287
title: Função Service-Main
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ed50f0f378f348415e56827a09fcf17eea7fc330
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103922612"
---
# <a name="service-servicemain-function"></a><span data-ttu-id="c1c60-103">Função Service-Main</span><span class="sxs-lookup"><span data-stu-id="c1c60-103">Service ServiceMain Function</span></span>

<span data-ttu-id="c1c60-104">Quando um programa de controle de serviço solicita que um novo serviço seja executado, o SCM (Gerenciador de controle de serviço) inicia o serviço e envia uma solicitação de início para o Dispatcher de controle.</span><span class="sxs-lookup"><span data-stu-id="c1c60-104">When a service control program requests that a new service run, the Service Control Manager (SCM) starts the service and sends a start request to the control dispatcher.</span></span> <span data-ttu-id="c1c60-105">O Dispatcher de controle cria um novo thread para executar a função de serviço de [**immain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) .</span><span class="sxs-lookup"><span data-stu-id="c1c60-105">The control dispatcher creates a new thread to execute the [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function for the service.</span></span> <span data-ttu-id="c1c60-106">Para obter um exemplo, consulte [escrevendo uma função de immain](writing-a-servicemain-function.md).</span><span class="sxs-lookup"><span data-stu-id="c1c60-106">For an example, see [Writing a ServiceMain Function](writing-a-servicemain-function.md).</span></span>

<span data-ttu-id="c1c60-107">A função de [**immain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) deve executar as seguintes tarefas:</span><span class="sxs-lookup"><span data-stu-id="c1c60-107">The [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function should perform the following tasks:</span></span>

1.  <span data-ttu-id="c1c60-108">Inicializar todas as variáveis globais.</span><span class="sxs-lookup"><span data-stu-id="c1c60-108">Initialize all global variables.</span></span>
2.  <span data-ttu-id="c1c60-109">Chame a função [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) imediatamente para registrar uma função de [**manipulador**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) para manipular solicitações de controle para o serviço.</span><span class="sxs-lookup"><span data-stu-id="c1c60-109">Call the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) function immediately to register a [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function to handle control requests for the service.</span></span> <span data-ttu-id="c1c60-110">O valor de retorno de **RegisterServiceCtrlHandler** é um *identificador de status de serviço* que será usado em chamadas para notificar o SCM do status do serviço.</span><span class="sxs-lookup"><span data-stu-id="c1c60-110">The return value of **RegisterServiceCtrlHandler** is a *service status handle* that will be used in calls to notify the SCM of the service status.</span></span>
3.  <span data-ttu-id="c1c60-111">Execute a inicialização.</span><span class="sxs-lookup"><span data-stu-id="c1c60-111">Perform initialization.</span></span> <span data-ttu-id="c1c60-112">Se espera-se que o tempo de execução do código de inicialização seja muito curto (menos de um segundo), a inicialização pode ser executada diretamente no [**usermain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span><span class="sxs-lookup"><span data-stu-id="c1c60-112">If the execution time of the initialization code is expected to be very short (less than one second), initialization can be performed directly in [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span></span>

    <span data-ttu-id="c1c60-113">Se espera-se que o tempo de inicialização seja maior que um segundo, o serviço deve usar uma das seguintes técnicas de inicialização:</span><span class="sxs-lookup"><span data-stu-id="c1c60-113">If the initialization time is expected to be longer than one second, the service should use one of the following initialization techniques:</span></span>

    -   <span data-ttu-id="c1c60-114">Chame a função [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para relatar o serviço \_ , mas não aceite controles até que a inicialização seja concluída.</span><span class="sxs-lookup"><span data-stu-id="c1c60-114">Call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report SERVICE\_RUNNING but accept no controls until initialization is finished.</span></span> <span data-ttu-id="c1c60-115">O serviço faz isso chamando **falha em SetServiceStatus** com **DWCURRENTSTATE** definido como serviço \_ em execução e **dwControlsAccepted** definido como 0 na estrutura de [**\_ status do serviço**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="c1c60-115">The service does this by calling **SetServiceStatus** with **dwCurrentState** set to SERVICE\_RUNNING and **dwControlsAccepted** set to 0 in the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="c1c60-116">Isso garante que o SCM não enviará nenhuma solicitação de controle ao serviço antes de estar pronto e liberará o SCM para gerenciar outros serviços.</span><span class="sxs-lookup"><span data-stu-id="c1c60-116">This ensures that the SCM will not send any control requests to the service before it is ready and frees the SCM to manage other services.</span></span> <span data-ttu-id="c1c60-117">Essa abordagem de inicialização é recomendada para o desempenho, especialmente para serviços de inicialização automática.</span><span class="sxs-lookup"><span data-stu-id="c1c60-117">This approach to initialization is recommended for performance, especially for autostart services.</span></span>
    -   <span data-ttu-id="c1c60-118">Início do \_ serviço \_ de relatório pendente, não aceite controles e especifique uma dica de espera.</span><span class="sxs-lookup"><span data-stu-id="c1c60-118">Report SERVICE\_START\_PENDING, accept no controls, and specify a wait hint.</span></span> <span data-ttu-id="c1c60-119">Se o código de inicialização do serviço executar tarefas que devem levar mais tempo do que o valor da dica de espera inicial, seu código deverá chamar a função [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) periodicamente (possivelmente com uma dica de espera revisada) para indicar que o progresso está sendo feito.</span><span class="sxs-lookup"><span data-stu-id="c1c60-119">If your service's initialization code performs tasks that are expected to take longer than the initial wait hint value, your code must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function periodically (possibly with a revised wait hint) to indicate that progress is being made.</span></span> <span data-ttu-id="c1c60-120">Certifique-se de chamar **falha em SetServiceStatus** somente se a inicialização estiver progredindo.</span><span class="sxs-lookup"><span data-stu-id="c1c60-120">Be sure to call **SetServiceStatus** only if the initialization is making progress.</span></span> <span data-ttu-id="c1c60-121">Caso contrário, o SCM pode aguardar o serviço entrar no \_ estado de execução do serviço, supondo que o serviço esteja progredindo e impeça a inicialização de outros serviços.</span><span class="sxs-lookup"><span data-stu-id="c1c60-121">Otherwise the SCM can wait for your service to enter the SERVICE\_RUNNING state assuming that your service is making progress and block other services from starting.</span></span> <span data-ttu-id="c1c60-122">Não chame **falha em SetServiceStatus** de um thread separado, a menos que você tenha certeza de que o thread que está executando a inicialização está realmente progredindo.</span><span class="sxs-lookup"><span data-stu-id="c1c60-122">Do not call **SetServiceStatus** from a separate thread unless you are sure the thread performing the initialization is truly making progress.</span></span>

        <span data-ttu-id="c1c60-123">Um serviço que usa essa abordagem também pode especificar um valor de ponto de verificação e incrementar o valor periodicamente durante uma inicialização demorada.</span><span class="sxs-lookup"><span data-stu-id="c1c60-123">A service that uses this approach can also specify a check-point value and increment the value periodically during a lengthy initialization.</span></span> <span data-ttu-id="c1c60-124">O programa que iniciou o serviço pode chamar [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) ou [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) para obter o valor de ponto de verificação mais recente do SCM e usar o valor para relatar o progresso incremental ao usuário.</span><span class="sxs-lookup"><span data-stu-id="c1c60-124">The program that started the service can call [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) or [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) to obtain the latest check-point value from the SCM and use the value to report incremental progress to the user.</span></span>

4.  <span data-ttu-id="c1c60-125">Quando a inicialização for concluída, chame [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para definir o estado do serviço como serviço \_ em execução e especifique os controles que o serviço está preparado para aceitar.</span><span class="sxs-lookup"><span data-stu-id="c1c60-125">When initialization is complete, call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_RUNNING and specify the controls that the service is prepared to accept.</span></span> <span data-ttu-id="c1c60-126">Para obter uma lista de controles, consulte a estrutura de [**\_ status do serviço**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="c1c60-126">For a list of controls, see the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span>
5.  <span data-ttu-id="c1c60-127">Execute as tarefas de serviço ou, se não houver nenhuma tarefa pendente, retorne o controle ao chamador.</span><span class="sxs-lookup"><span data-stu-id="c1c60-127">Perform the service tasks, or, if there are no pending tasks, return control to the caller.</span></span> <span data-ttu-id="c1c60-128">Qualquer alteração no estado do serviço garante uma chamada para [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para relatar novas informações de status.</span><span class="sxs-lookup"><span data-stu-id="c1c60-128">Any change in the service state warrants a call to [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report new status information.</span></span>
6.  <span data-ttu-id="c1c60-129">Se ocorrer um erro enquanto o serviço estiver inicializando ou em execução, o serviço deverá chamar [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) para definir o estado do serviço como serviço de \_ parada \_ pendente se a limpeza for longa.</span><span class="sxs-lookup"><span data-stu-id="c1c60-129">If an error occurs while the service is initializing or running, the service should call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_STOP\_PENDING if cleanup will be lengthy.</span></span> <span data-ttu-id="c1c60-130">Após a conclusão da limpeza, chame **falha em SetServiceStatus** para definir o estado do serviço como serviço \_ parado do último thread a ser encerrado.</span><span class="sxs-lookup"><span data-stu-id="c1c60-130">After cleanup is complete, call **SetServiceStatus** to set the service state to SERVICE\_STOPPED from the last thread to terminate.</span></span> <span data-ttu-id="c1c60-131">Certifique-se de definir os membros **dwServiceSpecificExitCode** e **dwWin32ExitCode** da estrutura de [**\_ status do serviço**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) para identificar o erro.</span><span class="sxs-lookup"><span data-stu-id="c1c60-131">Be sure to set the **dwServiceSpecificExitCode** and **dwWin32ExitCode** members of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure to identify the error.</span></span>

## <a name="related-topics"></a><span data-ttu-id="c1c60-132">Tópicos relacionados</span><span class="sxs-lookup"><span data-stu-id="c1c60-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="c1c60-133">Escrevendo uma função de immain</span><span class="sxs-lookup"><span data-stu-id="c1c60-133">Writing a ServiceMain Function</span></span>](writing-a-servicemain-function.md)
</dt> </dl>

 

 
