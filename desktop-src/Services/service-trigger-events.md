---
description: Um serviço pode se registrar para ser iniciado ou interrompido quando ocorrer um evento de gatilho.
ms.assetid: ca02a3ae-b16a-4427-b6db-b935c9cf23b3
title: Eventos de gatilho de serviço
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fdefd94b7896936f7ab4fc014647b08470611573
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2021
ms.locfileid: "105754112"
---
# <a name="service-trigger-events"></a><span data-ttu-id="9e486-103">Eventos de gatilho de serviço</span><span class="sxs-lookup"><span data-stu-id="9e486-103">Service Trigger Events</span></span>

<span data-ttu-id="9e486-104">Um serviço pode se registrar para ser iniciado ou interrompido quando ocorrer um evento de gatilho.</span><span class="sxs-lookup"><span data-stu-id="9e486-104">A service can register to be started or stopped when a trigger event occurs.</span></span> <span data-ttu-id="9e486-105">Isso elimina a necessidade de que os serviços sejam iniciados quando o sistema é iniciado, ou para que os serviços sejam sondados ou aguardam ativamente um evento; um serviço pode ser iniciado quando necessário, em vez de iniciar automaticamente se o trabalho deve ou não ser feito.</span><span class="sxs-lookup"><span data-stu-id="9e486-105">This eliminates the need for services to start when the system starts, or for services to poll or actively wait for an event; a service can start when it is needed, instead of starting automatically whether or not there is work to do.</span></span> <span data-ttu-id="9e486-106">Exemplos de eventos de gatilho predefinidos incluem a chegada de um dispositivo de uma classe de interface de dispositivo especificada ou a disponibilidade de uma porta de firewall específica.</span><span class="sxs-lookup"><span data-stu-id="9e486-106">Examples of predefined trigger events include arrival of a device of a specified device interface class or availability of a particular firewall port.</span></span> <span data-ttu-id="9e486-107">Um serviço também pode se registrar para um evento de gatilho personalizado gerado por um provedor de ETW ( [rastreamento de eventos para Windows](../etw/event-tracing-portal.md) ).</span><span class="sxs-lookup"><span data-stu-id="9e486-107">A service can also register for a custom trigger event generated by an [Event Tracing for Windows](../etw/event-tracing-portal.md) (ETW) provider.</span></span>

<span data-ttu-id="9e486-108">**Windows server 2008, Windows Vista, Windows server 2003 e Windows XP:** Não há suporte para eventos de gatilho de serviço até o Windows Server 2008 R2 e o Windows 7.</span><span class="sxs-lookup"><span data-stu-id="9e486-108">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Service trigger events are not supported until Windows Server 2008 R2 and Windows 7.</span></span>

<span data-ttu-id="9e486-109">Um gatilho consiste em um tipo de evento de gatilho, um subtipo de evento de gatilho, a ação a ser executada em resposta ao evento de gatilho e (para determinados tipos de evento de gatilho) um ou mais itens de dados específicos do gatilho.</span><span class="sxs-lookup"><span data-stu-id="9e486-109">A trigger consists of a trigger event type, a trigger event subtype, the action to be taken in response to the trigger event, and (for certain trigger event types) one or more trigger-specific data items.</span></span> <span data-ttu-id="9e486-110">O subtipo e os itens de dados específicos do gatilho juntos especificam as condições para notificar o serviço do evento.</span><span class="sxs-lookup"><span data-stu-id="9e486-110">The subtype and the trigger-specific data items together specify the conditions for notifying the service of the event.</span></span> <span data-ttu-id="9e486-111">O formato de um item de dados depende do tipo de evento Trigger; um item de dados pode ser dados binários, uma cadeia de caracteres ou uma cadeia de caracteres.</span><span class="sxs-lookup"><span data-stu-id="9e486-111">The format of a data item depends on the trigger event type; a data item can be binary data, a string, or a multistring.</span></span> <span data-ttu-id="9e486-112">Cadeias de caracteres devem ser Unicode; Não há suporte para cadeias de caracteres ANSI.</span><span class="sxs-lookup"><span data-stu-id="9e486-112">Strings must be Unicode; ANSI strings are not supported.</span></span>

<span data-ttu-id="9e486-113">Para se registrar para eventos de gatilho, o serviço chama [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) com **informações de gatilho de configuração de serviço \_ \_ \_** e fornece uma estrutura de [**\_ \_ informações de gatilho de serviço**](/windows/desktop/api/winsvc/ns-winsvc-service_trigger_info) .</span><span class="sxs-lookup"><span data-stu-id="9e486-113">To register for trigger events, the service calls [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) with **SERVICE\_CONFIG\_TRIGGER\_INFO** and supplies a [**SERVICE\_TRIGGER\_INFO**](/windows/desktop/api/winsvc/ns-winsvc-service_trigger_info) structure.</span></span> <span data-ttu-id="9e486-114">A estrutura de **\_ \_ informações do gatilho de serviço** aponta para uma matriz de estruturas de [**\_ gatilho de serviço**](/windows/desktop/api/winsvc/ns-winsvc-service_trigger) , cada uma especificando um gatilho.</span><span class="sxs-lookup"><span data-stu-id="9e486-114">The **SERVICE\_TRIGGER\_INFO** structure points to an array of [**SERVICE\_TRIGGER**](/windows/desktop/api/winsvc/ns-winsvc-service_trigger) structures, each specifying one trigger.</span></span>

<span data-ttu-id="9e486-115">A ação de gatilho especificada será executada se a condição do gatilho for verdadeira quando o sistema for iniciado, ou se a condição do gatilho se tornar verdadeira enquanto o sistema estiver em execução.</span><span class="sxs-lookup"><span data-stu-id="9e486-115">The specified trigger action is taken if the trigger condition is true when the system starts, or if the trigger condition becomes true while the system is running.</span></span> <span data-ttu-id="9e486-116">Por exemplo, se um serviço se registrar para ser iniciado quando um dispositivo específico estiver disponível, o serviço será iniciado quando o sistema for iniciado se o dispositivo já estiver conectado ao computador; o serviço é iniciado quando o dispositivo chega se o usuário se conecta ao dispositivo enquanto o sistema está em execução.</span><span class="sxs-lookup"><span data-stu-id="9e486-116">For example, if a service registers to be started when a particular device is available, the service is started when the system starts if the device is already plugged in to the computer; the service is started when the device arrives if the user plugs in the device while the system is running.</span></span>

<span data-ttu-id="9e486-117">Se um gatilho tiver itens de dados específicos do gatilho, a ação do gatilho será executada somente se o item de dados que acompanha o evento de gatilho corresponder a um dos itens de dados que o serviço especificou com o gatilho.</span><span class="sxs-lookup"><span data-stu-id="9e486-117">If a trigger has trigger-specific data items, the trigger action is taken only if the data item that accompanies the trigger event matches one of the data items that the service specified with the trigger.</span></span> <span data-ttu-id="9e486-118">A correspondência de dados binários é feita pela comparação de bits.</span><span class="sxs-lookup"><span data-stu-id="9e486-118">Binary data matching is done by bitwise comparison.</span></span> <span data-ttu-id="9e486-119">Correspondência de cadeia de caracteres não diferencia maiúsculas de minúsculas.</span><span class="sxs-lookup"><span data-stu-id="9e486-119">String matching is case-insensitive.</span></span> <span data-ttu-id="9e486-120">Se o item de dados for uma cadeia de caracteres multistring, todas as cadeias de caracteres em multistring deverão corresponder.</span><span class="sxs-lookup"><span data-stu-id="9e486-120">If the data item is a multistring, all strings in the multistring must match.</span></span>

<span data-ttu-id="9e486-121">Quando um serviço é iniciado em resposta a um evento de gatilho, o serviço recebe o **argumento do gatilho de serviço \_ \_ \_ iniciado** como *argv* \[ 1 \] em sua função de retorno de chamada de [*immain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) .</span><span class="sxs-lookup"><span data-stu-id="9e486-121">When a service is started in response to a trigger event, the service receives **SERVICE\_TRIGGER\_STARTED\_ARGUMENT** as *argv*\[1\] in its [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) callback function.</span></span> <span data-ttu-id="9e486-122">*Argv* \[ 0 \] é sempre o nome curto do serviço.</span><span class="sxs-lookup"><span data-stu-id="9e486-122">*Argv*\[0\] is always the short name of the service.</span></span>

<span data-ttu-id="9e486-123">Um serviço que se registra para ser iniciado em resposta a um evento de gatilho pode ser interrompido após um tempo limite ocioso quando o serviço não tem nenhum trabalho a fazer.</span><span class="sxs-lookup"><span data-stu-id="9e486-123">A service that registers to be started in response to a trigger event might stop itself after an idle time-out when the service has no work to do.</span></span> <span data-ttu-id="9e486-124">Um serviço que se interrompe deve ser preparado para manipular solicitações de controle de **\_ \_ TRIGGEREVENT de controle de serviço** que chegam enquanto o serviço está se interrompendo.</span><span class="sxs-lookup"><span data-stu-id="9e486-124">A service that stops itself must be prepared to handle **SERVICE\_CONTROL\_TRIGGEREVENT** control requests that arrive while the service is stopping itself.</span></span> <span data-ttu-id="9e486-125">O SCM envia uma solicitação de controle **\_ \_ TRIGGEREVENT de controle de serviço** sempre que um novo evento de gatilho ocorre enquanto o serviço está em estado de execução.</span><span class="sxs-lookup"><span data-stu-id="9e486-125">The SCM sends a **SERVICE\_CONTROL\_TRIGGEREVENT** control request whenever a new trigger event occurs while the service is in the running state.</span></span> <span data-ttu-id="9e486-126">Para evitar a perda de eventos de gatilho, o serviço deve retornar o **\_ desligamento \_ de erro em \_ andamento** para qualquer solicitação de controle **TRIGGEREVENT de \_ controle \_ de serviço** que chega enquanto o serviço está em transição de em execução para parado.</span><span class="sxs-lookup"><span data-stu-id="9e486-126">To avoid losing trigger events, the service should return **ERROR\_SHUTDOWN\_IN\_PROGRESS** for any **SERVICE\_CONTROL\_TRIGGEREVENT** control request that arrives while the service is transitioning from running to stopped.</span></span> <span data-ttu-id="9e486-127">Isso instrui o SCM a enfileirar eventos de gatilho e aguardar o serviço entrar no estado parado.</span><span class="sxs-lookup"><span data-stu-id="9e486-127">This instructs the SCM to queue trigger events and wait for the service to enter the stopped state.</span></span> <span data-ttu-id="9e486-128">Em seguida, o SCM executa a ação associada ao evento de gatilho enfileirado, como iniciar o serviço.</span><span class="sxs-lookup"><span data-stu-id="9e486-128">The SCM then takes the action associated with the queued trigger event, such as starting the service.</span></span>

<span data-ttu-id="9e486-129">Quando o serviço estiver pronto para lidar com eventos de gatilho novamente, ele definirá o **serviço de \_ aceitação de \_ TRIGGEREVENT** em sua máscara de controles aceita em uma chamada para [**falha em SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span><span class="sxs-lookup"><span data-stu-id="9e486-129">When the service is ready to handle trigger events again, it sets **SERVICE\_ACCEPT\_TRIGGEREVENT** in its controls-accepted mask in a call to [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span></span> <span data-ttu-id="9e486-130">Isso geralmente é feito quando o serviço chama **falha em SetServiceStatus** com o **serviço \_ em execução**.</span><span class="sxs-lookup"><span data-stu-id="9e486-130">This is usually done when the service calls **SetServiceStatus** with **SERVICE\_RUNNING**.</span></span> <span data-ttu-id="9e486-131">Em seguida, o SCM emite uma solicitação de **\_ \_ TRIGGEREVENT de controle de serviço** para cada evento de gatilho Enfileirado até que a fila esteja vazia.</span><span class="sxs-lookup"><span data-stu-id="9e486-131">The SCM then issues a **SERVICE\_CONTROL\_TRIGGEREVENT** request for each queued trigger event until the queue is empty.</span></span>

<span data-ttu-id="9e486-132">Um serviço que tem serviços dependentes em execução não pode ser interrompido em resposta a um evento de gatilho.</span><span class="sxs-lookup"><span data-stu-id="9e486-132">A service that has dependent services running cannot be stopped in response to a trigger event.</span></span>

<span data-ttu-id="9e486-133">As solicitações Trigger-Start e Trigger-Stop não são garantidas em condições de memória insuficiente.</span><span class="sxs-lookup"><span data-stu-id="9e486-133">Trigger-start and trigger-stop requests are not guaranteed under low memory conditions.</span></span>

<span data-ttu-id="9e486-134">Use a função [**QueryServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-queryserviceconfig2a) para recuperar a configuração de evento de gatilho de um serviço.</span><span class="sxs-lookup"><span data-stu-id="9e486-134">Use the [**QueryServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-queryserviceconfig2a) function to retrieve a service’s trigger event configuration.</span></span>

<span data-ttu-id="9e486-135">A ferramenta SC (sc.exe) pode ser usada para configurar ou consultar os eventos de gatilho de um serviço no prompt de comando.</span><span class="sxs-lookup"><span data-stu-id="9e486-135">The SC tool (sc.exe) can be used to configure or query a service’s trigger events at the command prompt.</span></span> <span data-ttu-id="9e486-136">Use a opção **triggerinfo** para configurar um serviço para iniciar ou parar em resposta a um evento de gatilho.</span><span class="sxs-lookup"><span data-stu-id="9e486-136">Use the **triggerinfo** option to configure a service to start or stop in response to a trigger event.</span></span> <span data-ttu-id="9e486-137">Use a opção **qtriggerinfo** para consultar a configuração do gatilho de um serviço.</span><span class="sxs-lookup"><span data-stu-id="9e486-137">Use the **qtriggerinfo** option to query the trigger configuration of a service.</span></span>

<span data-ttu-id="9e486-138">O exemplo a seguir consulta a configuração do gatilho do serviço W32time, que é configurado para iniciar quando o computador é ingressado em um domínio e parar quando o computador sair do domínio.</span><span class="sxs-lookup"><span data-stu-id="9e486-138">The following example queries the trigger configuration of the W32time service, which is configured to start when the computer is joined to a domain and stop when the computer leaves the domain.</span></span>

``` syntax
C:\>sc qtriggerinfo w32time
[SC] QueryServiceConfig2 SUCCESS

SERVICE_NAME: w32time

        START SERVICE
          DOMAIN JOINED STATUS         : 1ce20aba-9851-4421-9430-1ddeb766e809 [DOMAIN JOINED]
        STOP SERVICE
          DOMAIN JOINED STATUS         : ddaf516e-58c2-4866-9574-c3b615d42ea1 [NOT DOMAIN JOINED]
```

<span data-ttu-id="9e486-139">O exemplo a seguir consulta a configuração do gatilho do serviço de entrada do Tablet, que é configurado para iniciar quando um dispositivo HID com o **GUID** {4d1e55b2-f16f-11CF-88cb-001111000030} e qualquer uma das IDs de dispositivo HID especificadas chegar.</span><span class="sxs-lookup"><span data-stu-id="9e486-139">The following example queries the trigger configuration of the tablet input service, which is configured to start when a HID device with the **GUID** {4d1e55b2-f16f-11cf-88cb-001111000030} and any of the specified HID device IDs arrives.</span></span>

``` syntax
C:\>sc qtriggerinfo tabletinputservice
[SC] QueryServiceConfig2 SUCCESS

SERVICE_NAME: tabletinputservice

        START SERVICE
          DEVICE INTERFACE ARRIVAL     : 4d1e55b2-f16f-11cf-88cb-001111000030 [INTERFACE CLASS GUID]
            DATA                       : HID_DEVICE_UP:000D_U:0001
            DATA                       : HID_DEVICE_UP:000D_U:0002
            DATA                       : HID_DEVICE_UP:000D_U:0003
            DATA                       : HID_DEVICE_UP:000D_U:0004
```

 

 
